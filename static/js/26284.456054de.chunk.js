"use strict";(self.webpackChunkever_wading_birds=self.webpackChunkever_wading_birds||[]).push([[26284],{4542:(e,t,i)=>{i.d(t,{NE:()=>l,TU:()=>d,ac:()=>h,fn:()=>c,oe:()=>u});var r=i(62631),s=i(42198),n=i(45622),a=i(51232),o=i(21935);const l={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},c={toggle:"Control"},h={enterInputMode:"Tab",commit:"Enter",discard:"Escape",next:"Tab"},d={moveUp:{key:"ArrowUp",modifier:"Shift",repeats:!0},moveDown:{key:"ArrowDown",modifier:"Shift",repeats:!0},moveLeft:{key:"ArrowLeft",modifier:"Shift",repeats:!0},moveRight:{key:"ArrowRight",modifier:"Shift",repeats:!0},scaleUp:{key:"+",modifier:"Shift"},scaleDown:{key:"-",modifier:"Shift"},factorModifier:{key:o.i,continuePropagation:!0},toggleOpacity:"t",preserveAspectRatio:{key:"Shift",continuePropagation:!0},rotateIncrements:{key:"Shift",continuePropagation:!0},editSourcePoints:{key:"Alt",continuePropagation:!0},undo:"z",redo:"r"};class u{constructor(){this._bindings=new Map}add(e,t){return this.addToggle(e,(e=>{"key-down"===e.type&&t(e)}))}addToggle(e,t){const i=p.fromDefinition(e,t),a=(0,n.tE)(this._bindings,i.key,(()=>[]));return a.push(i),(0,s.hA)((()=>(0,r.TF)(a,i)))}register(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.o.WIDGET;return(0,s.vE)([e.on("key-down",(t=>this.dispatch(e.inputManager,t)),t),e.on("key-up",(t=>this.dispatch(e.inputManager,t)),t)])}dispatch(e,t){const i=t.key,r=this._bindings.get(i);if(r)for(const s of r)s.process(e,t)}}class p{constructor(e,t,i,r,s){this.key=e,this.modifiers=t,this.repeats=i,this.continuePropagation=r,this.callback=s}process(e,t){if(!(t.key!==this.key||"repeat"in t&&t.repeat&&!this.repeats)){for(const t of this.modifiers)if(!e.isModifierKeyDown(t))return;this.continuePropagation||t.stopPropagation(),this.callback(t)}}static fromDefinition(e,t){if("string"==typeof e)return new p(e,[],!1,!1,t);const{key:i,modifier:r,repeats:s,continuePropagation:n}=e;return new p(i,r?Array.isArray(r)?r:[r]:[],!!s,!!n,t)}}},18693:(e,t,i)=>{i.d(t,{l:()=>g});var r=i(64682),s=i(89227),n=i(28473),a=i(60548),o=i(24646),l=i(18162),c=i(4309),h=i(1696),d=i(51064),u=i(75075),p=i(50190),v=i(72249),f=i(18287),m=i(86580),w=i(22131),_=i(99254);class g extends u.X{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=(0,o.fA)(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=(0,o.fA)(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){(0,a.a)(e,this._color)||((0,a.c)(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,a.a)(e,this._outlineColor)||((0,a.c)(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){this._material?.setParameters(this._materialParameters)}_updateSizeAttribute(){const e=this.object;if(null==e)return;const t=e.geometries[0];if(null==t)return;const i=t.getMutableAttribute(w.r.SIZE).data,r=this._geometrySize;i[0]=r,i[1]=r,e.geometryVertexAttributeUpdated(e.geometries[0],w.r.SIZE)}get _materialParameters(){return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:(0,f.ny)(this._primitive),distanceFieldBoundingBox:f.PY,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:this._texture?.id,polygonOffset:!1,shaderPolygonOffset:0,drawAsLabel:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/f.CN}createExternalResources(){this._texture=(0,f.sZ)(this._primitive,this._preferredTextureSize),this._material=new _.R(this._materialParameters,this.view.state.viewingMode===d.RT.Global);const e=this.view._stage;this._texture.load(e.renderView.renderingContext),e.add(this._texture)}destroyExternalResources(){this._texture&&(this.view._stage.remove(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(e){const t=this._createRenderGeometry();null!=t&&e.addGeometry(t)}forEachExternalMaterial(e){this._material&&e(this._material)}get _preferredTextureSize(){return(0,r.qE)(2*this._geometrySize,16,128)}calculateMapBounds(e){const t=this.object?.geometries[0];if(!t)return!1;const i=t.attributes.get(w.r.POSITION).data;return(0,l.F)(i,this.view.renderCoordsHelper.spatialReference,b,this.view.spatialReference),(0,c.Hq)(e,b),!0}_createRenderGeometry(){const{geometry:e,_material:t}=this;if(null==e||null==t)return null;const{renderCoordsHelper:i,elevationProvider:r}=this.view,n=(0,p.nG)(e,r,v.F.fromElevationInfo(this.elevationInfo),i),a=(0,s.i)(h.rq.get(),e.x,e.y,n),o=h.rq.get();(0,l.F)(a,e.spatialReference,o,i.spatialReference);const c=this._geometrySize;return(0,m.DJ)(t,{position:o,size:[c,c],centerOffsetAndDistance:[0,0,0,1]})}}const b=(0,n.vt)()},20561:(e,t,i)=>{i.d(t,{t:()=>u});var r=i(87752),s=i(10382),n=i(89227),a=i(28473),o=i(24646),l=i(75075),c=i(72530),h=i(60984),d=i(23664);class u extends l.X{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._hasExternalMaterial=null!=t,this._material=null!=t?t:new d.W({width:1,color:(0,o.fA)(1,0,1,1),stipplePreferContinuous:!0,isClosed:!1,falloff:0,innerWidth:1,hasPolygonOffset:!1,renderOccluded:h.m$.OccludeAndTransparent,isDecoration:!!e.isDecoration,writeDepth:!0}),this.applyProperties(e)}setGeometryFromPoint(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;const i=(0,a.vt)();this.view.renderCoordsHelper.toRenderCoords(e,i)&&this.setGeometryFromRenderSpacePoint(i,t)}setGeometryFromRenderSpacePoint(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;this.geometry=[[[e[0]-t,e[1],e[2]],[e[0]+t,e[1],e[2]]],[[e[0],e[1]-t,e[2]],[e[0],e[1]+t,e[2]]],[[e[0],e[1],e[2]-t],[e[0],e[1],e[2]+t]]]}setGeometryFromExtent(e){const t=this.view.spatialReference,i=(0,a.vt)(),r=(0,a.vt)(),s=100,o=[];(0,n.i)(i,e[0],e[1],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),o.push([r[0],r[1],r[2]]),(0,n.i)(i,e[2],e[1],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),o.push([r[0],r[1],r[2]]),(0,n.i)(i,e[2],e[3],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),o.push([r[0],r[1],r[2]]),(0,n.i)(i,e[0],e[3],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),o.push([r[0],r[1],r[2]]),(0,n.i)(i,e[0],e[1],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),o.push([r[0],r[1],r[2]]),(0,n.i)(i,e[0],e[1],s),this.view.renderCoordsHelper.toRenderCoords(i,t,r),o.push([r[0],r[1],r[2]]),this.geometry=[o]}setGeometryFromFrustum(e){const t=[];e.lines.forEach((e=>{t.push([e.origin[0],e.origin[1],e.origin[2]]),t.push([e.endpoint[0],e.endpoint[1],e.endpoint[2]])})),this.geometry=[t]}setGeometryFromBoundedPlane(e){const t=[],i=e.origin,r=e.basis1,s=e.basis2,n=.5,o=(0,a.vt)(),l=(0,a.vt)(),c=(0,a.vt)(),h=(0,a.vt)();o[0]=i[0]-r[0]*n-s[0]*n,o[1]=i[1]-r[1]*n-s[1]*n,o[2]=i[2]-r[2]*n-s[2]*n,l[0]=i[0]-r[0]*n+s[0]*n,l[1]=i[1]-r[1]*n+s[1]*n,l[2]=i[2]-r[2]*n+s[2]*n,c[0]=i[0]+r[0]*n+s[0]*n,c[1]=i[1]+r[1]*n+s[1]*n,c[2]=i[2]+r[2]*n+s[2]*n,h[0]=i[0]+r[0]*n-s[0]*n,h[1]=i[1]+r[1]*n-s[1]*n,h[2]=i[2]+r[2]*n-s[2]*n,t.push([o[0],o[1],o[2]]),t.push([l[0],l[1],l[2]]),t.push([c[0],c[1],c[2]]),t.push([h[0],h[1],h[2]]),t.push([o[0],o[1],o[2]]),this.geometry=[t]}setGeometryFromSegment(e){const t=e.endRenderSpace;this.transform=(0,r.kN)(p,t);const{points:i}=e.createRenderGeometry(t,this.view.renderCoordsHelper);this.geometry=[i]}setGeometryFromSegments(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.uY;this.transform=(0,r.kN)(p,t),this.geometry=e.map((e=>e.createRenderGeometry(t,this.view.renderCoordsHelper).points))}getTransformedGeometry(){return null==this._geometry?null:this._geometry.map((e=>e.map((e=>(0,n.t)((0,a.vt)(),e,this.transform)))))}get renderOccluded(){return this._material.parameters.renderOccluded}set renderOccluded(e){this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._material.parameters.width}set width(e){this._material.setParameters({width:e})}get color(){return this._material.parameters.color}set color(e){const t=1===e[3];this._material.setParameters({color:e,writeDepth:t})}get innerWidth(){return this._material.parameters.innerWidth}set innerWidth(e){this._material.setParameters({innerWidth:e})}get innerColor(){return this._material.parameters.innerColor}set innerColor(e){this._material.setParameters({innerColor:e})}get stipplePattern(){return this._material.parameters.stipplePattern}set stipplePattern(e){null!=this._material&&this._material.setParameters({stipplePattern:e})}get stippleOffColor(){return this._material.parameters.stippleOffColor}set stippleOffColor(e){this._material.setParameters({stippleOffColor:e})}get stipplePreferContinuous(){return this._material.parameters.stipplePreferContinuous}set stipplePreferContinuous(e){this._material.setParameters({stipplePreferContinuous:e})}get falloff(){return this._material.parameters.falloff}set falloff(e){this._material.setParameters({falloff:e})}get polygonOffset(){return this._material.parameters.hasPolygonOffset}set polygonOffset(e){this._material.setParameters({hasPolygonOffset:e})}createExternalResources(){}destroyExternalResources(){}createGeometries(e){for(const t of(0,c.z)(this.geometry)){const i=(0,c.t)(this._material,t);e.addGeometry(i)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const p=(0,s.vt)()},26905:(e,t,i)=>{i.d(t,{P:()=>l});var r=i(93800),s=i(42198),n=i(20620),a=i(48602),o=(i(21265),i(50925),i(14746),i(75269));const l=e=>{let t=class extends(n.A.EsriPromiseMixin(e)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){return null==this.parent||this.parent.visible&&!this.parent.suspended}set visible(e){this._overrideIfSome("visible",e)}forceInteractiveForViewModel(){return this._interactiveViewModelCount++,(0,s.hA)((()=>this._interactiveViewModelCount--))}};return(0,r._)([(0,a.MZ)({constructOnly:!0})],t.prototype,"parent",void 0),(0,r._)([(0,a.MZ)({constructOnly:!0})],t.prototype,"view",void 0),(0,r._)([(0,a.MZ)({type:Boolean})],t.prototype,"interactive",null),(0,r._)([(0,a.MZ)()],t.prototype,"_userInteractive",void 0),(0,r._)([(0,a.MZ)({readOnly:!0})],t.prototype,"updating",null),(0,r._)([(0,a.MZ)()],t.prototype,"visible",null),(0,r._)([(0,a.MZ)()],t.prototype,"_interactiveViewModelCount",void 0),t=(0,r._)([(0,o.$)("esri.views.3d.analysis.AnalysisView3D")],t),t}},29331:(e,t,i)=>{i.d(t,{EX:()=>M,RS:()=>D,Tp:()=>S,VG:()=>g,Wp:()=>v,Xt:()=>u,an:()=>p,bl:()=>_,dp:()=>b,mc:()=>y,pg:()=>R,rh:()=>T,sO:()=>V,y$:()=>w});var r=i(62631),s=(i(21265),i(82301)),n=i(64682),a=i(16804),o=i(96913),l=i(20444),c=i(34156),h=i(41317),d=i(30124);function u(e,t){return e.events.on("drag",function(e,t){let i=null,r=null;return s=>{if("cancel"===s.action)return void(null!=r&&(r.execute({action:"cancel"}),i=null,r=null));const n={action:s.action,screenStart:s.start,screenEnd:s.screenPoint};"start"===s.action&&null==i&&(i=new T,r=new T,t(e,i,r,s.pointerType,n)),null!=i&&i.execute(n),"end"===s.action&&null!=i&&(i=null,r=null)}}(e,t))}function p(e,t){const i=[e.x,e.y,e.z??0],r=t,s=[Math.cos(r),Math.sin(r)],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(0===n)return null;s[0]/=n,s[1]/=n;const a=e=>{const t=(e.x-i[0])*s[0]+(e.y-i[1])*s[1];e.x=i[0]+t*s[0],e.y=i[1]+t*s[1]};return e=>(a(e.mapStart),a(e.mapEnd),{...e,axis:s})}function v(e){let t=null;return i=>{if("start"===i.action&&(t=function(e,t){const i=e.operations;if(!i)return null;const r=i.data.geometry,s=(0,c.RS)(t);if(r.spatialReference.equals(s))return m(e,i,(()=>{}));if("mesh"!==r.type){const t=f(r,s);if(null==t)return null;const n=r.spatialReference;return m(e,d.p.fromGeometry(t,i.viewingMode),(()=>{const e=(0,o.project)(r,n);i.trySetGeometry(e)}))}if((0,l.CK)(r)){const t=f(r.origin,s);if(!t)return null;const n=r.spatialReference,a=d.p.fromGeometry(t,i.viewingMode);return m(e,i,(()=>{const e=(0,o.project)(a.data.geometry,n),t=e.x-r.origin.x,s=e.y-r.origin.y,l=(e.z??0)-(r.origin.z??0);i.move(t,s,l)}))}return null}(e,i.mapStart.spatialReference)),null==t)return null;const r=i.mapEnd.x-i.mapStart.x,s=i.mapEnd.y-i.mapStart.y,n=(i.mapEnd.z??0)-(i.mapStart.z??0);return t.move(r,s,n,i.action),{...i,translationX:r,translationY:s,translationZ:n}}}function f(e,t){return null==e?null:e.spatialReference.equals(t)?e.clone():(0,o.project)(e,t)}function m(e,t,i){let r=0,s=0,n=0;return{move:(a,o,l,c)=>{"start"===c&&(r=0,s=0,n=0);const h=a-r,d=o-s,u=l-n;t.move(h,d,u),r+=h,s+=d,n+=u,i(),"end"===c&&e.endInteraction?.()}}}function w(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2?arguments[2]:void 0,r=null;const s=null==t||e.spatialReference?.equals(t)?e=>e:e=>null!=e?(0,o.project)(e,t):e,n={exclude:[],...i};return t=>{if("start"===t.action&&(r=s(e.toMap(t.screenStart,n))),null==r)return null;const i=s(e.toMap(t.screenEnd,n));return null!=i?{...t,mapStart:r,mapEnd:i}:null}}function _(e){const t=e.map((e=>v(e))).filter(r.Ru);return e=>{const i=e.mapEnd.x-e.mapStart.x,r=e.mapEnd.y-e.mapStart.y,s=e.mapEnd.z-e.mapStart.z;return t.forEach((t=>t(e))),{...e,translationX:i,translationY:r,translationZ:s}}}function g(e,t){const i=new Map;for(const r of t)i.set(r,(0,s.clone)(e[r]));return t=>(i.forEach(((t,i)=>{e[i]=t})),t)}function b(e){const t=e.operations?.createResetState();return e=>(t?.remove(),e)}function y(e){const t=e.map((e=>b(e))).filter((e=>null!=e));return e=>(t.forEach((t=>t(e))),e)}function M(){let e=0,t=0,i=0;return r=>{"start"===r.action&&(e=r.mapStart.x,t=r.mapStart.y,i=r.mapStart.z);const s=r.mapEnd.x-e,n=r.mapEnd.y-t,a=r.mapEnd.z-i;return e=r.mapEnd.x,t=r.mapEnd.y,i=r.mapEnd.z,{...r,mapDeltaX:s,mapDeltaY:n,mapDeltaZ:a,mapDeltaSpatialReference:r.mapStart.spatialReference}}}function V(){let e=0,t=0;return i=>{"start"===i.action&&(e=i.screenStart.x,t=i.screenStart.y);const r=i.screenEnd.x-e,s=i.screenEnd.y-t;return e=i.screenEnd.x,t=i.screenEnd.y,{...i,screenDeltaX:r,screenDeltaY:s}}}function S(e,t){let i=null,r=0,s=0;return o=>{if("start"===o.action&&(i=e.toScreen?.(t),null!=i&&(i.x<0||i.x>e.width||i.y<0||i.y>e.height?i=null:(r=o.screenStart.x-i.x,s=o.screenStart.y-i.y))),null==i)return null;const l=(0,n.qE)(o.screenEnd.x-r,0,e.width),c=(0,n.qE)(o.screenEnd.y-s,0,e.height),h=(0,a.tc)(l,c);return o.screenStart=i,o.screenEnd=h,o}}const E=()=>{};class T{constructor(){this.execute=E}next(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new T;return null!=e&&(this.execute=i=>{const r=e(i);null!=r&&t.execute(r)}),t}}function R(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if("2d"===e.type)return e=>e;let r=null;return s=>{"start"===s.action&&(r=e.toMap(s.screenStart,{exclude:i}),null!=r&&(r.z=(0,h.id)(r,e,t)));const n=e.toMap(s.screenEnd,{exclude:i});null!=n&&(n.z=(0,h.id)(n,e,t));const a=null!=r&&null!=n?{sceneStart:r,sceneEnd:n}:null;return{...s,scenePoints:a}}}function O(e,t,i){const r=t.elevationProvider.getElevation(e.x,e.y,e.z??0,e.spatialReference,"scene")??0,s=(0,c.EL)(e);return s.z=r,s.hasZ=!0,s.z=(0,h.id)(s,t,i),s}function D(e,t){if("2d"===e.type)return e=>e;let i=null;return r=>{"start"===r.action&&(i=O(r.mapStart,e,t));const s=O(r.mapEnd,e,t),n=null!=i&&null!=s?{sceneStart:i,sceneEnd:s}:null;return{...r,scenePoints:n}}}},29383:(e,t,i)=>{i.d(t,{Dh:()=>l,IB:()=>h,Vv:()=>r,fg:()=>o,jI:()=>c});i(64682);var r,s=i(32006),n=i(98080);function a(e,t){return e[0]*t[1]-e[1]*t[0]}function o(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i;return(0,s.Re)(u,r,i),(0,s.Re)(v,t,n),function(e,t,i){const r=(0,s.Om)(i,t)/(0,s.m3)(i);(0,s.hs)(e,i,r)}(f,v,u),(0,s.WQ)(e,n,f)}function l(e,t,i,r){(0,s.Re)(u,t,i);const n=r/(0,s.Bw)(u);return(0,s.Ln)(e,i,u,n)}function c(e,t){const i=e.start,n=e.end,o=t.start,l=t.end,c=(0,s.Re)(u,n,i),h=(0,s.Re)(p,l,o),m=a(c,h);if(Math.abs(m)<=d)return[];const w=(0,s.Re)(v,i,o),_=a(h,w)/m,g=a(c,w)/m;if(_>=0){if(g>=0||t.type===r.LINE)return[(0,s.Ln)(f,i,c,_)]}else if(e.type===r.LINE&&(g>=0||t.type===r.LINE))return[(0,s.Ln)(f,i,c,_)];return[]}function h(e,t,i){const n=[],a=(0,s.Re)(u,e.end,e.start),o=(0,s.Re)(p,e.start,t),l=(0,s.m3)(a),c=2*(0,s.Om)(a,o),h=c*c-4*l*((0,s.m3)(o)-i*i);if(0===h){const t=-c/(2*l);(e.type===r.LINE||t>=0)&&n.push((0,s.Ln)(f,e.start,a,t))}else if(h>0){const t=Math.sqrt(h),i=(-c+t)/(2*l);(e.type===r.LINE||i>=0)&&n.push((0,s.Ln)(f,e.start,a,i));const o=(-c-t)/(2*l);(e.type===r.LINE||o>=0)&&n.push((0,s.Ln)(v,e.start,a,o))}return n}!function(e){e[e.RAY=0]="RAY",e[e.LINE=1]="LINE"}(r||(r={}));const d=1e-6,u=(0,n.vt)(),p=(0,n.vt)(),v=(0,n.vt)(),f=(0,n.vt)()},32219:(e,t,i)=>{i.d(t,{V:()=>M,a:()=>E,b:()=>V});var r=i(87752),s=i(10382),n=i(37379),a=i(33273),o=i(11833),l=i(82124),c=i(46855),h=i(12893),d=i(61315),u=i(57554),p=i(42403),v=i(74802),f=i(16878),m=i(7683),w=i(38950),_=i(19639),g=i(73712),b=i(67058),y=i(8118);class M extends l.${constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=s.zK.flat(),this.viewMatrices=s.zK.flat(),this.volumeOffset=0}}function V(){const e=new y.N5,t=e.fragment;return e.include(n.c),e.include(l.w),e.include(h.r),t.include(a.E),t.include(c.U),e.include(o.p),t.uniforms.add(new g.x("depthTexture",(e=>e.depth?.attachment)),new w.F("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new w.F("inverseViewNormalMatrix",(e=>{let{camera:t}=e;return(0,r.Qw)(S,t.viewInverseTransposeMatrix)})),new u.t("viewshedObserverOffset",(e=>e.observerOffset)),new u.t("viewshedTargetVector",(e=>e.targetVector)),new u.t("viewshedUpVector",(e=>e.upVector)),new d.G("viewshedFOVs",(e=>e.fovs)),new d.G("viewshedHeadingAndTilt",(e=>e.headingAndTilt)),new d.G("viewshedNearFar",(e=>e.shadowMap.nearFar??[1,100])),new p.m("viewshedVolumeOffset",(e=>e.volumeOffset)),new b.N("viewshedShadowMap",(e=>e.shadowMap.depthTexture)),new _.m("viewshedProjectionMatrices",(e=>e.projectionMatrices),6),new _.m("viewshedViewMatrices",(e=>e.viewMatrices),6),new m.c("viewshedNumFaces",(e=>e.shadowMap.numActiveFaces)),new v.x("viewshedAtlasRegions",(e=>e.shadowMap.atlasRegions.flat()),24),new b.N("normalMap",(e=>e.normals))),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(f.H`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return rgba4ToFloat(textureAtlasLookup(viewshedShadowMap, uv, atlasRegion));
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = vec3(-1.0) + 2.0 * normal4.xyz;
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(f.H`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),e}const S=(0,s.vt)(),E=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:M,build:V},Symbol.toStringTag,{value:"Module"}))},32850:(e,t,i)=>{i.d(t,{AA:()=>b,L2:()=>S,Og:()=>r,PW:()=>V,U0:()=>y,iv:()=>E,mg:()=>R,ov:()=>T,xk:()=>D,z7:()=>O});var r,s=i(16804),n=i(98080),a=i(89227),o=i(28473),l=i(75400),c=i(96913),h=i(10872),d=i(91102),u=i(49943),p=i(1696),v=i(41317),f=i(9452),m=i(8609),w=i(92453),_=i(64863),g=i(29331);function b(e,t){return M(e,(()=>t))}function y(e){return M(e,(e=>e.plane))}function M(e,t){const i=(0,o.vt)(),r=(0,o.vt)();let n=!1;return a=>{const o=t(a);if("start"===a.action){const t=(0,s.WA)(a.screenStart,(0,s.PR)(p.oG.get())),r=(0,f.Z4)(e.state.camera,t,P);null!=r&&(n=(0,h.Ui)(o,r,i))}if(!n)return null;const l=(0,s.WA)(a.screenEnd,(0,s.PR)(p.oG.get())),c=(0,f.Z4)(e.state.camera,l,P);return null==c?null:(0,h.Ui)(o,c,r)?{...a,renderStart:i,renderEnd:r,plane:o,ray:c}:null}}function V(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=null;return o=>{if("start"===o.action&&(a=e.sceneIntersectionHelper.intersectElevationFromScreen((0,s.gs)(o.screenStart.x,o.screenStart.y),t,i,n),null!=a&&null!=r&&!(0,c.projectPoint)(a,a,r)))return null;if(null==a)return null;const l=e.sceneIntersectionHelper.intersectElevationFromScreen((0,s.gs)(o.screenEnd.x,o.screenEnd.y),t,i,n);return null==l||null!=r&&!(0,c.projectPoint)(l,l,r)?null:{...o,mapStart:a,mapEnd:l}}}(e,i,(0,v.id)(t,e,i),r,n)}function S(e,t,i,r){const s=i.toMap(e.screenStart);return null!=s?V(t,s,i.elevationInfo,r):null}function E(e,t,i){let r=null;const s=new g.rh;return s.next(b(e,function(e,t){const i=x,r=C,s=(0,h.vt)();e.renderCoordsHelper.worldUpAtPosition(t,i);const n=(0,a.e)((0,h.Qj)(s),i,(0,a.d)(r,t,e.state.camera.eye));return(0,a.e)(n,n,i),(0,h.O_)(t,n,s)}(e,t))).next(function(e,t){const i=(0,o.vt)(),r=(0,a.l)(t);e.renderCoordsHelper.worldUpAtPosition(t,i);const s=(0,o.vt)(),n=(0,o.vt)(),l=s=>((0,a.d)(s,s,t),(0,u._I)(i,s,s),"global"===e.viewingMode&&(0,a.l)(s)*Math.sign((0,a.f)(i,s))<.001-r&&(0,a.d)(s,(0,a.h)(s,i,.001),t),(0,a.g)(s,s,t),s);return e=>(e.renderStart=l((0,a.c)(s,e.renderStart)),e.renderEnd=l((0,a.c)(n,e.renderEnd)),e)}(e,t)).next(R(e,i)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,r=e})),e=>(r=null,s.execute(e),r)}function T(e,t){const i=i=>{const r=(0,s.WA)(i,(0,s.PR)(A)),n=(0,f.Z4)(e.state.camera,r,P);if(null==n)return null;const a=(0,d.Zb)(t,n,x,C);return a?.[0]};return e=>{const t=i(e.screenStart);if(null==t)return null;const r=i(e.screenEnd);return null==r?null:{...e,renderStart:t,renderEnd:r}}}function R(e,t){const i=e.renderCoordsHelper;return e=>{const r=i.fromRenderCoords(e.renderStart,new l.default({spatialReference:t})),s=i.fromRenderCoords(e.renderEnd,new l.default({spatialReference:t}));return null!=r&&null!=s?{...e,mapStart:r,mapEnd:s}:null}}function O(e){let t=null;return i=>{switch(i.action){case"start":t=e.disableDisplay();break;case"end":case"cancel":null!=t&&(t.remove(),t=null)}return i}}function D(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=(0,m.hz)(e.state.viewingMode);i.options.selectionMode=!0,i.options.store=w.oH.MIN,i.options.hud=!1;const n=(0,s.gs)(),a={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},c=(0,o.vt)(),h=t??e.spatialReference,d=t=>{e.map.ground&&e.map.ground.opacity<1?a.exclude.add(_.fo):a.exclude.delete(_.fo),e.sceneIntersectionHelper.intersectIntersectorScreen((0,s.WA)(t,n),i,a);const o=i.results.min;let d;if(o.getIntersectionPoint(c))d=o.intersector===w.dz.TERRAIN?r.GROUND:r.OTHER;else{if(!i.results.ground.getIntersectionPoint(c))return null;d=r.GROUND}return{location:e.renderCoordsHelper.fromRenderCoords(c,new l.default({spatialReference:h})),surfaceType:d}};let u;return e=>{if("start"===e.action){const t=d(e.screenStart);u=null!=t?t.location:null}if(null==u)return null;const t=d(e.screenEnd);return null!=t?.location?{...e,mapStart:u,mapEnd:t.location,surfaceType:t.surfaceType}:null}}!function(e){e[e.GROUND=0]="GROUND",e[e.OTHER=1]="OTHER"}(r||(r={}));const A=(0,n.vt)(),x=(0,o.vt)(),C=(0,o.vt)(),P=(0,d.vt)()},34567:(e,t,i)=>{i.d(t,{Hd:()=>l,JY:()=>o,aS:()=>c});var r=i(58828),s=i(17741),n=i(49959),a=i(79953);function o(e,t){e.interactive=!0;const{tool:i,view:o}=e;o.activeTool=i;let l=(0,n.onAbort)(t,(()=>{o.activeTool===i&&(o.activeTool=null)}));return(0,r.UT)((async e=>{await(0,a.whenOnce)((()=>null==i||!i.active),e),l=(0,s.xt)(l)}),t)}function l(e,t){return(0,a.watch)((()=>e.interactive),(()=>function(e,t){e.interactive?function(e,t){c(e);const{view:i,analysis:r}=e,s=new t({view:i,analysis:r,analysisViewData:e});e.tool=s,i.tools.add(s)}(e,t):c(e)}(e,t)),a.syncAndInitial)}function c(e){const{view:t,tool:i}=e;null!=i&&(t.tools.remove(i),e.tool=null)}},38319:(e,t,i)=>{i.d(t,{W:()=>n});var r=i(60984),s=i(30051);class n extends r.im{intersect(e,t,i,r,n,a){return(0,s.Uy)(e,i,r,n,void 0,a)}}},38930:(e,t,i)=>{i.d(t,{Bw:()=>m,D9:()=>V,DG:()=>d,E3:()=>R,FF:()=>l,Hb:()=>n,I4:()=>y,Jj:()=>T,Ll:()=>p,NT:()=>w,Sw:()=>D,UF:()=>o,YG:()=>E,ZR:()=>v,aE:()=>A,aj:()=>S,c1:()=>h,cE:()=>c,cO:()=>f,lS:()=>u,qD:()=>_,rb:()=>g,sd:()=>O,vA:()=>M,vo:()=>a,xj:()=>b});var r=i(21265),s=i(64682);const n=(0,r.A)("mac")?"Meta":"Control",a="Shift",o=2,l=1.15,c=1.15,h=2500,d=.02,u=Math.cos((0,s.kU)(45)),p=Math.cos((0,s.kU)(5)),v=.95,f=.3,m=2,w=1,_=3,g=11,b=22.5,y=40,M=48,V=2.25,S=4,E=1,T=.3,R=6,O=4,D=1600,A=.4},46316:(e,t,i)=>{i.d(t,{N1:()=>h,uY:()=>d,wY:()=>c,xH:()=>l});var r=i(89227),s=i(28473),n=i(91102),a=i(92453),o=i(54407);function l(e,t){return c(e)===c(t)}function c(e){if(null==e)return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:`o-${t}-${i}`}const h={json:{write:{writer:function(e,t){null!=e?.layer?.objectIdField&&null!=e.attributes&&(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String],isRequired:!0},"feature.objectId":{type:[Number,String],isRequired:!0}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}}};function d(e,t,i,l){const{sceneIntersectionHelper:h}=e,{observer:d,observerFeatureId:p,targetFeatureId:m,target:w}=i;if(null==p&&null==m)return;l||(l=e=>e),(0,r.a)(f,d,w);const _=(0,r.l)(f);(0,r.b)(f,d,f,1/_);const g=(0,n.Cr)(f,w,v);t.options.store=a.oH.ALL,h.intersectToolIntersectorRay(g,t);let b=null,y=null,M=null,V=null;for(const r of t.results.all){const t=(0,o.Gy)(r,e);if(null==t||null==r.distanceInRenderSpace)continue;const i=c(t);null!=i&&(null!=p&&i===p&&(b??=l(u(r,e,_)),r.distanceInRenderSpace-1<b&&(M=r)),null!=m&&i===m&&(y??=l(u(r,e,_)),null==V&&r.distanceInRenderSpace-1<_&&_-r.distanceInRenderSpace+1<y&&(V=r)))}const{observerAdjusted:S,targetAdjusted:E}=i;M?.getIntersectionPoint(S)?i.observerSurfaceNormal=M.getTransformedNormal((0,s.vt)()):i.observerSurfaceNormal=null,V?.getIntersectionPoint(E)?i.targetSurfaceNormal=V.getTransformedNormal((0,s.vt)()):i.targetSurfaceNormal=null}function u(e,t,i){if((0,o.QS)(e)){const r=(0,o.SM)(e,t);if(null!=r)return Math.min(r*p,i)}return 1e-5*i}const p=.05,v=(0,n.vt)(),f=(0,s.vt)()},54382:(e,t,i)=>{i.d(t,{k:()=>o});var r=i(93800),s=i(79953),n=(i(50925),i(21265),i(14746),i(74719),i(75269)),a=i(88204);let o=class extends a.g{constructor(e){super(e)}initialize(){this.addHandles((0,s.watch)((()=>this.analysisViewData.visible),(e=>this.visible=e),s.syncAndInitial))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};o=(0,r._)([(0,n.$)("esri.views.interactive.AnalysisToolBase")],o)},66983:(e,t,i)=>{i.d(t,{B:()=>n,V:()=>a});var r=i(96913),s=i(96504);function n(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const a=(0,r.tryProjectWithZConversion)(e,t);return null==a?null:(a.hasZ&&!n||null==i||(a.z=(0,s.R1)(i,a)??0),a)}function a(e,t,i){i.warnOnce(`Failed to project analysis geometry (id: '${e.id}'), projection from spatial reference (wkid: '${t.wkid}') to view spatial reference is not supported. Projection may be possible after calling projection.load().`)}},72530:(e,t,i)=>{i.d(t,{t:()=>m,z:()=>g});var r=i(32006),s=i(98080),n=i(24646),a=i(30142),o=i(68693),l=i(66028),c=i(46576),h=i(55239),d=i(51064),u=i(65069),p=i(69291),v=i(25735),f=i(22131);function m(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const s=[],m=t.mapPositions;!function(e,t){const{attributeData:{position:i},removeDuplicateStartEnd:r}=e,s=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(i)&&r,n=i.length/3-(s?1:0),a=new Array(2*(n-1)),o=s?i.slice(0,-3):i;let l=0;for(let c=0;c<n-1;c++)a[l++]=c,a[l++]=c+1;t.push([f.r.POSITION,new u.n(o,a,3,s)])}(t,s);const g=s[0][1].data,b=s[0][1].indices.length,y=(0,h.EH)(b);return function(e,t,i){if(null!=e.attributeData.colorFeature)return;const r=e.attributeData.color;t.push([f.r.COLOR,new u.n(r??n.Un,i,4)])}(t,s,y),function(e,t,i){null==e.attributeData.sizeFeature&&t.push([f.r.SIZE,new u.n([e.attributeData.size??1],i,1,!0)])}(t,s,y),function(e,t,i){e.attributeData.normal&&t.push([f.r.NORMAL,new u.n(e.attributeData.normal,i,3)])}(t,s,y),function(e,t,i){null!=e.attributeData.colorFeature&&t.push([f.r.COLORFEATUREATTRIBUTE,new u.n([e.attributeData.colorFeature],i,1,!0)])}(t,s,y),function(e,t,i){null!=e.attributeData.sizeFeature&&t.push([f.r.SIZEFEATUREATTRIBUTE,new u.n([e.attributeData.sizeFeature],i,1,!0)])}(t,s,y),function(e,t,i){null!=e.attributeData.opacityFeature&&t.push([f.r.OPACITYFEATUREATTRIBUTE,new u.n([e.attributeData.opacityFeature],i,1,!0)])}(t,s,y),function(e,t,i){if(null==e.overlayInfo||e.overlayInfo.renderCoordsHelper.viewingMode!==d.RT.Global||!e.overlayInfo.spatialReference.isGeographic)return;const s=(0,l.jh)(i.length),n=(0,a.tO)(e.overlayInfo.spatialReference);for(let r=0;r<s.length;r+=3)(0,o.RC)(i,r,s,r,n);const h=i.length/3,p=(0,c.oe)(h+1);let v=w,m=_,g=0,b=0;(0,r.hZ)(v,s[b++],s[b++]),b++,p[0]=0;for(let a=1;a<h+1;++a)a===h&&(b=0),(0,r.hZ)(m,s[b++],s[b++]),b++,g+=(0,r.xg)(v,m),p[a]=g,[v,m]=[m,v];t.push([f.r.DISTANCETOSTART,new u.n(p,t[0][1].indices,1,!0)])}(t,s,g),new v.V(e,s,m,p.X.Line,i)}const w=(0,s.vt)(),_=(0,s.vt)();function g(e,t){if(null==e||0===e.length)return[];const i=[];return e.forEach((e=>{const r=e.length,s=(0,l.jh)(3*r);e.forEach(((e,t)=>{s[3*t]=e[0],s[3*t+1]=e[1],s[3*t+2]=e[2]}));const n={attributeData:{position:s,normal:t},removeDuplicateStartEnd:!1};i.push(n)})),i}},77783:(e,t,i)=>{i.d(t,{t:()=>n});var r,s=i(89129);!function(e){e[e.WhenToolEditable=0]="WhenToolEditable",e[e.WhenToolNotEditable=1]="WhenToolNotEditable",e[e.Always=2]="Always"}(r||(r={}));class n{constructor(){this._isToolEditable=!0,this._manipulators=new s.default,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(e){this._isToolEditable=e}get length(){return this._manipulators.length}add(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.WhenToolEditable;this.addMany([e],t)}addMany(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.WhenToolEditable;for(const i of e){const e={manipulator:i,visibilityPredicate:t,attached:!1};this._manipulators.add(e),this._attached&&this._updateManipulatorAttachment(e)}}remove(e){for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.at(t).manipulator===e){const e=this._manipulators.splice(t,1)[0];this._detachManipulator(e);break}}removeAll(){this._manipulators.forEach((e=>{this._detachManipulator(e)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((e=>{this._updateManipulatorAttachment(e)})),this._attached=!0}detach(){this._manipulators.forEach((e=>{this._detachManipulator(e)})),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach((e=>{let{manipulator:t}=e;return t.destroy()})),this._manipulators.destroy(),this._resourceContexts=null}on(e,t){return this._manipulators.on(e,(e=>{t(e)}))}forEach(e){for(const t of this._manipulators.items)e(t)}some(e){return this._manipulators.items.some(e)}toArray(){const e=[];return this.forEach((t=>e.push(t.manipulator))),e}intersect(e,t){let i=null,r=Number.MAX_VALUE;return this._manipulators.forEach((s=>{let{manipulator:n,attached:a}=s;if(!a||!n.interactive)return;const o=n.intersectionDistance(e,t);null!=o&&o<r&&(r=o,i=n)})),i}_updateManipulatorAttachment(e){this._isManipulatorItemVisible(e)?this._attachManipulator(e):this._detachManipulator(e)}_attachManipulator(e){e.attached||(e.manipulator.attach&&e.manipulator.attach(this._resourceContexts),e.attached=!0)}_detachManipulator(e){if(!e.attached)return;const t=e.manipulator;t.grabbing=!1,t.dragging=!1,t.hovering=!1,t.selected=!1,t.detach&&t.detach(this._resourceContexts),e.attached=!1}_isManipulatorItemVisible(e){return e.visibilityPredicate===r.Always||(this._isToolEditable?e.visibilityPredicate===r.WhenToolEditable:e.visibilityPredicate===r.WhenToolNotEditable)}}},79678:(e,t,i)=>{i.d(t,{Xq:()=>o,wk:()=>a});const r={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},s={dash:r.dash,"dash-dot":[...r.dash,...r.dot],dot:r.dot,"long-dash":r["long-dash"],"long-dash-dot":[...r["long-dash"],...r.dot],"long-dash-dot-dot":[...r["long-dash"],...r.dot,...r.dot],none:null,"short-dash":r["short-dash"],"short-dash-dot":[...r["short-dash"],...r["short-dot"]],"short-dash-dot-dot":[...r["short-dash"],...r["short-dot"],...r["short-dot"]],"short-dot":r["short-dot"],solid:null},n=8;function a(e){return{pattern:[e,e],pixelRatio:2}}function o(e){return"style"===e?.type?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(s[e],n):null}(e.style):null}},82124:(e,t,i)=>{i.d(t,{$:()=>h,w:()=>d});var r=i(87752),s=i(10382),n=i(28473),a=i(49008),o=i(16878),l=i(94320),c=i(20783);class h extends c.Y{constructor(){super(...arguments),this.localOrigin=(0,n.Ul)()}}function d(e){e.include(a.Ir),e.fragment.uniforms.add(new l.X("inverseViewMatrix",((e,t)=>{const i=(0,r.Tl)((0,s.vt)(),t.camera.viewMatrix,e.localOrigin);return(0,r.Qw)(i,i)}))).code.add(o.H`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}},85522:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Xt});var r=i(93800),s=i(46316),n=i(6946),a=i(21265),o=i(50925),l=i(17741),c=i(79953),h=i(48602),d=(i(14746),i(75269)),u=i(89227),p=i(28473),v=i(96913),f=i(26905),m=i(66983),w=i(42198),_=i(88102),g=i(82301),b=i(64682),y=i(87752),M=i(10382),V=i(71723),S=i(60984);const E=(0,b.kU)(2);const T=new class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=4,this.fovFocusedArcWidth=2*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=2/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}};const R=new class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new _.default([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:_.default.toUnitRGBA(new _.default([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:S.m$.Occlude,cullFace:V.s2.Back,writeDepth:!1}}};var O=i(86925),D=i(75400),A=i(10872),x=i(62631),C=i(58828),P=i(5839),F=i(49959),z=i(51064),I=i(90834),H=i(25071),Z=i(3276),U=i(32850),k=i(64566),L=i(86767);function N(e,t){let{tiltedUpVector:i,rightVector:r,observerRenderSpace:s}=e;const n=(0,Z.wQ)(i,r,s,t);return n[12]=0,n[13]=0,n[14]=0,n}function j(e,t,i,r){const s=(0,p.vt)(),n=(0,A.Qj)(i.plane),a=function(e,t){const i=W;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const r=(0,k.ZC)(e,i,e.camera.heading,e.camera.tilt,(0,L.NP)()).direction;return(0,b.KJ)((0,u.r)(r,t))-90}(t,n);let o;if(Math.abs(a)>T.viewAngleThreshold)o=e.next((0,U.AA)(t,i.plane));else{const s=(0,A.O_)(r.targetRenderSpace,i.basis1,(0,A.vt)()),n=(0,u.n)(W,i.basis1),a=(0,u.n)(q,i.basis2);o=e.next((0,U.AA)(t,s)).next((e=>{const t=e=>{const t=(0,u.f)((0,u.a)(B,e,i.origin),a),s=Math.acos((0,b.qE)(t/r.farDistanceRenderSpace,-1,1)),o=Math.sin(s)*r.farDistanceRenderSpace;return(0,u.g)((0,p.vt)(),i.origin,(0,u.g)((0,p.vt)(),(0,u.h)(B,n,o),(0,u.h)($,a,t)))},s=t(e.renderStart),o=t(e.renderEnd);return{...e,renderStart:s,renderEnd:o}}))}return o.next((e=>{"start"===e.action&&(0,u.c)(s,e.renderStart);const t=(0,b.KJ)((0,Z.FY)(s,e.renderEnd,i.origin,n));return{...e,deltaAngle:t}}))}function G(e,t,i,r){return(0,y.$0)(K,i,r),(0,u.t)(e,t,K)}const W=(0,p.vt)(),q=(0,p.vt)(),B=(0,p.vt)(),$=(0,p.vt)(),K=(0,M.vt)();var X=i(49502),Y=i(9814),Q=i(11953),J=i(80881),ee=i(86580),te=i(89893),ie=i(23664),re=i(29331),se=i(54379);class ne extends J.A{constructor(e){super(),this._handles=new I.default,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles=(0,l.pR)(this._handles),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return(0,w.vE)(i.map((i=>{let{manipulator:r,side:s}=i;return(0,re.Xt)(r,((i,r,n,a,o)=>{const l=function(e,t){let{observerRenderSpace:i,targetRenderSpace:r,tiltedUpVector:s,rightVector:n,farDistanceRenderSpace:a}=t;const o=(0,u.a)(ce,r,i),l=ae(e)?n:s,c=(0,u.h)(he,l,a);return(0,H.f)(i,o,c)}(s,t),c=r.next((e=>({...e,manipulatorType:Q.r.SCALE,side:s}))),h=j(c,this._view,l,t);e(i,h,n)}))})))}updateManipulatorsTransform(e){e.arcCentersPoints(de),this._forEachManipulatorInfo((t=>this._updateArcManipulatorTransform(t,e,de[t.side])))}updateManipulatorVisuals(e){this._forEachManipulatorInfo((t=>this._updateArcManipulatorVisuals(t,e)))}_updateArcManipulatorVisuals(e,t){let{manipulator:i,side:r}=e;const s=[];if(null!=t){const[e,n]=function(e,t,i){const{horizontalFieldOfView:r,verticalFieldOfView:s}=t,n=ae(e),a=(0,b.kU)((0,b.qE)((n?s:r)/2,0,15)),o=function(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;(0,te.vA)(r>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const s=t-e;if(s<=0||i<=0)return[(0,p.fA)(0,0,.01),(0,p.fA)(0,0,-.01)];const n=[],a=s/r;for(let o=0;o<r;o++){let s=e+o*a;o===r-1&&(s=t);const l=Math.cos(s)*i,c=Math.sin(s)*i,h=(0,p.fA)(l-i,0,c);n.push(h)}return n}(-a/2,a/2,n?1:Math.max(Math.sin((0,b.kU)(90-s/2)),.1));return[(0,ee.Z8)(i,o),o]}(r,t,this._unfocusedArcMaterial);s.push(new Y.M(e,se.p7.Unfocused),new Y.M(e.instantiate({material:this._focusedArcMaterial}),se.p7.Focused)),i.collisionType={type:"line",paths:[n]}}i.renderObjects=s,i.radius=T.collisionRadius}_updateArcManipulatorTransform(e,t,i){let{manipulator:r,side:s}=e;const n=t.horizontalFieldOfView,a=(0,b.kU)(t.verticalFieldOfView/2),o=(0,b.kU)(n/2),l=ae(s);r.renderLocation=i;const c=(0,M.vt)(),h=e=>{(0,y.lw)(c,e,c)};h((0,y.i1)(le,(0,b.kU)(-90))),l||h((0,y.hM)(le,a));const d=t.farDistanceRenderSpace;let p,v;h((0,y.CV)(le,(0,u.i)(ce,d,d,d))),h((0,y.N9)(le,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*oe}(s))),h(N(t,le)),l?(p=o,v=t.tiltedUpVector):(v=t.rightVector,p=a),p*="right"===s||"bottom"===s?-1:1;const f=(0,y.$0)(le,p,v);null!=f&&h(f),r.modelTransform=c}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),r=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:r},[[r.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach((e=>{let[t,i]=e;t.metadata={pairedManipulator:i},i.metadata={pairedManipulator:t}}))}_createArcManipulator(e){const t=new X.q({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on("focus-changed",(e=>{const i=t.metadata?.pairedManipulator;null!=i&&(i.hovering!==t.hovering&&(i.hovering=t.hovering),i.grabbing!==t.grabbing&&(i.grabbing=t.grabbing))}))),i}_createArcMaterial(e){const t=T.getFovArcWidth(e),i=new ie.W({renderOccluded:S.m$.OccludeAndTransparent,isDecoration:!0,width:t});return this._handles.add((0,c.watch)((()=>_.default.toUnitRGBA(this._view.effectiveTheme.accentColor)),(e=>i.setParameters({color:e})),c.initial)),i}forEachManipulator(e){Object.values(this._manipulators).forEach((t=>{let{manipulator:i}=t;return e(i,Q.r.SCALE)}))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach((t=>e(t)))}get test(){return{manipulators:this._manipulators}}}function ae(e){return"left"===e||"right"===e}const oe=Math.PI/2,le=(0,M.vt)(),ce=(0,p.vt)(),he=(0,p.vt)(),de={top:(0,p.vt)(),bottom:(0,p.vt)(),left:(0,p.vt)(),right:(0,p.vt)()};var ue=i(91102),pe=i(38930),ve=i(1368);class fe extends X.q{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:T.collisionRadius}),this._handles=new I.default,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=[(0,p.fA)(0,0,0),(0,p.fA)(0,0,1)],r=(0,ee.Nb)(t,i,e,16,!1),s=(0,ee.Nb)(t,i,e*pe.UF,16,!1),n=me(!1,t,e),a=me(!0,t,e),o=(0,M.vt)();(0,y.kN)(o,i[i.length-1]),(0,y.lK)(o,o,(0,y.hM)(we,Math.PI/2)),(0,y.lK)(o,o,(0,y.i1)(we,Math.PI/2)),n.transformation=o,a.transformation=o,this.renderObjects=[new Y.M(r,se.p7.Unfocused),new Y.M(s,se.p7.Focused),new Y.M(n,se.p7.Unfocused),new Y.M(a,se.p7.Focused)];const l=(0,p.fA)(0,T.getScaleOrientArrowTipLength(!0),0),c=(0,u.t)(l,l,o),h=[...i,c];this.collisionType={type:"line",paths:[h]}}_createMaterial(){const e=new ve.v({cullFace:V.s2.Back,renderOccluded:S.m$.OccludeAndTransparent,isDecoration:!0});return this._handles.add((0,c.watch)((()=>_.default.toUnitRGBA(this.view.effectiveTheme.accentColor)),(t=>e.setParameters({color:t})),c.initial)),e}}function me(e,t,i){const r=T.getScaleOrientArrowTipLength(e);let s=2*i;e&&(s*=pe.UF);const n=r/2;return(0,ee._B)(t,r,n,n,s,0)}const we=(0,M.vt)();var _e=i(89148);class ge extends J.A{constructor(e){super(),this._handles=new I.default,this._tool=e.tool,this._view=e.view;const t=T.scaleOrientHandleRadius;this._manipulatorHeading=new fe(this._view,t),this._manipulatorTilt=new fe(this._view,t),this._manipulatorDistance=new fe(this._view,t),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return(0,re.Xt)(this._manipulatorHeading,((i,r,s,n,a)=>{const o=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:c,upVector:h,observerRenderSpace:d,targetRenderSpace:p,rightVector:v}=t,f=Math.sin((0,b.kU)(l))*c,m=(0,u.g)(Me,d,(0,u.h)(Ve,h,f)),w=(0,u.a)(Ve,p,m),_=(0,u.h)(Se,v,(0,u.H)(w)),g=j(r,o,(0,H.f)(m,w,_),t).next((e=>({...e,manipulatorType:Q.r.ROTATE})));e(i,g,s)}))}createTiltDragPipeline(e,t){return(0,re.Xt)(this._manipulatorTilt,((i,r,s,n,a)=>{const{observerRenderSpace:o,farDistanceRenderSpace:l,upVector:c,targetDirection:h}=t,d=(0,u.f)(h,c),p=(0,u.b)(Me,h,c,-d);(0,u.h)(p,(0,u.n)(p,p),l);const v=(0,u.h)(Ve,c,l),f=(0,H.f)(o,p,v),m=j(r,this._view,f,t).next((e=>({...e,manipulatorType:Q.r.ROTATE})));e(i,m,s)}))}createDistanceDragPipeline(e,t){return(0,re.Xt)(this._manipulatorDistance,((i,r,s,n,a)=>{const o=(0,ue.fA)(t.observerRenderSpace,t.targetDirection),l=r.next((0,re.Tp)(this._view,i.location)).next((0,U.ov)(this._view,o)).next((e=>({...e,manipulatorType:Q.r.SCALE})));e(i,l,s)}))}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=(0,M.vt)(),r=e=>{(0,y.lw)(i,e,i)},s=T.scaleOrientSize*(_e.HJ/_e.Gz);r((0,y.CV)(be,(0,u.i)(Me,s,s,s))),r(N(e,be));const n=T.scaleOrientHandleRadius*pe.UF*s,a=(0,u.h)(Me,e.targetDirection,n);r((0,y.kN)(be,a));const o=(0,y.N9)(be,-Ee);(0,y.lK)(o,o,(0,y.i1)(ye,-Ee)),this._manipulatorHeading.modelTransform=(0,y.lK)((0,M.vt)(),i,o);const l=(0,y.i1)(be,Ee);(0,y.lK)(l,l,(0,y.N9)(ye,Math.PI)),this._manipulatorTilt.modelTransform=(0,y.lw)((0,M.vt)(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,Q.r.ROTATE),e(this._manipulatorTilt,Q.r.ROTATE),e(this._manipulatorDistance,Q.r.SCALE)}}const be=(0,M.vt)(),ye=(0,M.vt)(),Me=(0,p.vt)(),Ve=(0,p.vt)(),Se=(0,p.vt)(),Ee=Math.PI/2;i(39466),i(77751),i(21965),i(74719);class Te extends X.q{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:T.observerSize,interactive:!1}),this._handles=new I.default;const i=(0,Z.UM)(this._color);this.renderObjects=[new Y.M((0,ee.CM)(i,T.observerSize,32,32))],t.manipulators.add(this),this._handles.add([(0,c.watch)((()=>this._color),(e=>{i.setParameters({color:e})}),c.initial)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return _.default.toUnitRGBA(this.view.effectiveTheme.accentColor)}}(0,r._)([(0,h.MZ)()],Te.prototype,"_color",null);var Re=i(81239),Oe=i(30124);const De=Symbol("dragHandles"),Ae=Symbol("hideManipulators"),xe=Symbol("hideFoVManipulators"),Ce=Symbol("hideObserverManipulator");let Pe=class extends n.default{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new ne({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new ge({view:this.view,tool:this.parentTool}),this._observerManipulator=new Te(this.view,this.parentTool),this.addHandles([(0,c.watch)((()=>this.viewshedComputedData?.observerRenderSpace),(e=>{null!=e&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)}),c.syncAndInitial),(0,c.watch)((()=>this.viewshedComputedData?.heading),(e=>{e&&(this._moveManipulation.angle=(0,b.kU)(90-e))}),c.initial),(0,c.watch)((()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}}),((e,t)=>{let{viewshedComputedData:i,observer:r}=e;this._grabbing&&r!==t?.observer||(this.removeHandles(De),i?.isValid()&&this.addHandles([this._buildObserverDragPipeline(i),this._buildFOVDragPipeline(i),this._buildScaleOrientDragPipeline(i)].filter(x.Ru),De))}),c.initial),(0,c.watch)((()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)}),c.initial),(0,c.watch)((()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)}),c.initial),(0,c.watch)((()=>{const e=this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1),t=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||t)}}),(e=>{let{fovManipulationAvailable:t,nonFOVManipulationAvailable:i}=e;this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=t}),c.initial),(0,c.watch)((()=>{const e=this.viewshedComputedData;if(!e?.isValid())return null;const{observer:t,target:i,verticalFieldOfView:r,horizontalFieldOfView:s}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:r,horizontalFieldOfView:s}}),(e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)}),c.initial)]);this._forEachManipulator((e=>{const t=this.analysisViewData;this.addHandles([e.events.on("focus-changed",(()=>{const e=this._someManipulatorHovering();e&&this.parentTool.subToolHandles.forEach((e=>{let{subTool:t}=e;t._resetHoveringTask()})),this._someManipulatorSelected()||e||(this._forceHoveringTask=(0,C.UT)((async e=>{await(this._forceHoveringTestPromise??(0,F.after)(T.hoverTimeoutMilliseconds,e)),(0,F.throwIfAborted)(e),this._forceHoveringTask=null,this._updateManipulatorVisibility()})))})),e.events.on("grab-changed",(i=>{this._grabbing="start"===i.action,"end"===i.action&&t.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach((e=>{let{subTool:t}=e;t!==this&&t._setInteractive(!this._grabbing)})),this._setInteractive((t=>t.hasManipulator(e)||!this._grabbing))})),e.events.on("drag",(e=>{"start"===e.action&&t.tool?.updateInteractionVisualsVisibility()}))])}))}destroy(){this._forceHoveringTask=(0,l.DC)(this._forceHoveringTask),this._moveManipulation=(0,l.pR)(this._moveManipulation),this._fieldOfViewManipulation=(0,l.pR)(this._fieldOfViewManipulation),this._scaleOrientManipulation=(0,l.pR)(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=(0,l.pR)(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t="boolean"==typeof e;this._forEachManipulation((i=>i.interactive=t?e:e(i)))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator((i=>{t=t||i===e})),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Re.v({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:_e.HJ})}_buildObserverDragPipeline(e){const t=e.observer;if(null==t)return null;const i=this.view.spatialReference;return this._moveManipulation.createDragPipeline(((e,r,s,n,a)=>{n=n.next((0,re.VG)(this,["observer"]));const o=(0,v.tryProjectWithZConversion)(t,i);if(null==o)return{steps:s,cancel:n};const l=Oe.p.fromGeometry(o,(0,z.yX)(this.view.viewingMode));return{steps:s.next((0,re.Wp)({operations:l})).next((e=>(this.observer=l.data.geometry,e))),cancel:n}}),{mode:"absolute-height",offset:0},i,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline(((r,s,n)=>{if(null==e)return{steps:s,cancel:n};const a=e.viewshed;let o=null;return n=n.next((0,re.VG)(a,["horizontalFieldOfView","verticalFieldOfView"])),{steps:s.next((r=>{"start"===r.action&&(o=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const s=r.deltaAngle;if(null==o&&0!==s){const e="bottom"===r.side||"left"===r.side?s>0:s<0;o=ae(r.side)?0===t&&e||360===t&&!e:0===i&&e}const n=o?function(e){return"left"===e?"right":"right"===e?"left":"top"===e?"bottom":"top"}(r.side):r.side;let l=0;switch(n){case"left":l=t/2-s;break;case"right":l=t/2+s;break;case"top":l=i+2*s;break;case"bottom":l=i-2*s}return ae(n)?(l=P.ie.normalize(l),l=l>270?0:l>180?180:l,a.horizontalFieldOfView=2*l):a.verticalFieldOfView=l,r})),cancel:n}}),e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const r=(t,i)=>(r,s,n)=>{if(null==e)return{steps:s,cancel:n};const a=e.viewshed;return n=n.next((0,re.VG)(a,[t])),{steps:s=s.next(i(a,e)),cancel:n}};return(0,w.vE)([this._scaleOrientManipulation.createHeadingDragPipeline(r("heading",((t,r)=>r=>("start"===r.action&&(i=e.heading),t.heading=P.ie.normalize(i+r.deltaAngle),r))),e),this._scaleOrientManipulation.createTiltDragPipeline(r("tilt",((i,r)=>r=>{"start"===r.action&&(t=e.tilt);let s=t+r.deltaAngle;return s<-90?s=180:s>270&&(s=0),i.tilt=ze.clamp(s),r})),e),this._scaleOrientManipulation.createDistanceDragPipeline(r("farDistance",((e,t)=>i=>{const r=(0,u.a)(Fe,i.renderEnd,t.observerRenderSpace),s=(0,u.H)(r)*t.metersPerUnit,n=(0,u.f)(r,t.targetDirection)<0?T.scaleOrientMinDistance:s;return e.farDistance=n,i})),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=null!=this._forceHoveringTask||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,r=this.parentTool.creating;let s=[];const n=e=>{s.push(e.disableDisplay())};e||!r&&t?this.removeHandles(Ae):(this._scaleOrientManipulation.forEachManipulator(n),this._moveManipulation.forEachManipulator(n),this.addHandles(s,Ae),s=[]),e||!r&&t||r&&i?this.removeHandles(xe):(this._fieldOfViewManipulation.forEachManipulator(n),this.addHandles(s,xe)),e||!r?this.removeHandles(Ce):this.addHandles(this._observerManipulator.disableDisplay(),Ce)}_resetHoveringTask(){this._forceHoveringTask=(0,l.DC)(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation((t=>{t.forEachManipulator(e)})),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};(0,r._)([(0,h.MZ)({constructOnly:!0})],Pe.prototype,"analysis",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Pe.prototype,"analysisViewData",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],Pe.prototype,"parentTool",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0,nonNullable:!0})],Pe.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],Pe.prototype,"viewshed",null),(0,r._)([(0,h.MZ)()],Pe.prototype,"_grabbing",void 0),(0,r._)([(0,h.MZ)()],Pe.prototype,"grabbing",null),(0,r._)([(0,h.MZ)()],Pe.prototype,"viewshedComputedData",void 0),(0,r._)([(0,h.MZ)()],Pe.prototype,"observer",null),Pe=(0,r._)([(0,d.$)("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],Pe);const Fe=(0,p.vt)(),ze=new P.hr(0,180);var Ie=i(68160),He=i(85090),Ze=i(48261),Ue=i(54407),ke=i(54382),Le=i(4542),Ne=i(95441),je=i(53605);const Ge=Symbol("interactionVisuals");let We=class extends ke.k{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Ie.w({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=(0,Ne.T)(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=(0,c.mapCollection)((()=>e),(e=>{let{viewshedComputedData:t}=e;const i=new Pe({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:i,remove:()=>{this.selectedViewshed===t.viewshed&&(this.selectedViewshed=null),i.destroy()}}})),this.addHandles([(0,c.watch)((()=>e?.some((e=>e.viewshedComputedData.isValid()))),(e=>{e&&this.finishToolCreation()}),c.syncAndInitial),(0,c.watch)((()=>this._stagedViewshed),(e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=t?this._findSubTool(e)?.viewshedComputedData:null}),c.syncAndInitial),(0,c.watch)((()=>this.firstGrabbedManipulator),(e=>{if(null!=e){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()}),c.sync),(0,c.watch)((()=>this.view.activeTool),(e=>{e!==this&&null!=e&&(this.selectedViewshed=null)})),(0,c.when)((()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}}),(e=>{const{subTool:t,observer:i,target:r}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(r,!1)}),c.initial),(0,c.watch)((()=>this.creating),(()=>this.updateInteractionVisualsVisibility())),(0,c.watch)((()=>this.selectedViewshed),(e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)}),c.initial)])}destroy(){this.subToolHandles=(0,l.pR)(this.subToolHandles),this.removeHandles(Ge)}onDeactivate(){this.removeStaged(),this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){const t=this._selectedManipulator;t!==e&&(this._selectedManipulator=e,null!=t&&(t.selected=!1),null!=e&&(e.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some((e=>{let{subTool:t}=e;return t.grabbing}))}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}createViewsheds(){this.selectedViewshed=null,this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach((e=>e.subTool.onManipulatorSelectionChanged()))}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":Le.NE.cancel===e.key?this._cancelKeyHandler(e):Le.NE.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,Qe);if(null!=t){if("placing-observer"===this._creationState){t.mapPoint.z=(t.mapPoint.z??0)+1.5;const e=new O.default({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,Qe);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){if(this.creating){if(this.removeStaged())return this._creationState="placing-observer",this.selectedViewshed=null,void e.stopPropagation();this._creationState=!1}else if(!this.grabbing)return this.selectedViewshed=null,void e.stopPropagation()}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:r,tilt:s,farDistance:n}=function(e,t,i){const r=t.observerRenderSpace,s=(0,u.a)(qe,i,r),n=(0,u.H)(s)*t.metersPerUnit,a=e.renderCoordsHelper.basisMatrixAtPosition(r,Xe),o=(0,u.i)(Be,a[8],a[9],a[10]),l=(0,A.O_)(r,o,Ye),c=(0,A._I)(l,i,$e),h=(0,u.a)(c,c,r),d=((0,u.H)(h)<1e-4?90:(0,b.KJ)((0,u.r)(s,h)))*((0,u.f)(o,s)<0?-1:1)+90,p=(0,u.i)(Ke,a[4],a[5],a[6]),v=(0,b.KJ)((0,u.r)(p,h)),f=(0,u.i)(Ke,a[0],a[1],a[2]);return{heading:(0,u.f)(h,f)<0?360-v:v,tilt:d,farDistance:n}}(this.view,i,e);t.farDistance=n,t.tilt=s,t.heading=r}removeStaged(){return null!=this._stagedViewshed&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}_intersectScreen(e,t){const i=(0,je.sC)(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const r=this._intersector.results.min,s=t.scenePoint;if(!r.getIntersectionPoint(s))return null;const n=t.mapPoint;return n.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(s,n),null==n?null:(t.feature=(0,Ue.Gy)(r,this.view),t)}_createInteractionVisuals(){this.removeHandles(Ge);const e=this._settings.visualElements,t=new Ze.o({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new He.U({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:S.m$.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([(0,c.watch)((()=>e.zVerticalLine),(e=>e.apply(i)),c.syncAndInitial),(0,c.watch)((()=>e.heightPlane),(e=>e.apply(t)),c.syncAndInitial),(0,w.hA)((()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null}))],Ge)}updateInteractionVisualsVisibility(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.creating,i=this.analysisViewData.visible,r=this._selectedSubTool,s=this.selectedViewshedComputedData,n=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void n(i,!1);if(null==r||null==s)return void n(!1,!1);const a=r.moveInteractionState,o=e?a.grabbing:a.dragging,l=r.scaleOrientInteractionState,c=e?l.grabbing:l.dragging,h=i&&(o||c);if(n(h,o),h){const e=o?s.observerRenderSpace:s.targetRenderSpace;this._updateInteractionVisualsLocation(e,o)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:r,verticalLine:s}=i;r.heightManifoldTarget=e,r.intersectsWorldUpAtLocation=t?e:null,null!=e&&s.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){if(null==e)return null;const t=e instanceof X.q?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return this.subToolHandles?.find(t)?.subTool}get test(){}};(0,r._)([(0,h.MZ)({constructOnly:!0})],We.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],We.prototype,"analysisViewData",void 0),(0,r._)([(0,h.MZ)()],We.prototype,"removeIncompleteOnCancel",void 0),(0,r._)([(0,h.MZ)()],We.prototype,"automaticManipulatorSelection",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],We.prototype,"analysis",void 0),(0,r._)([(0,h.MZ)()],We.prototype,"subToolHandles",void 0),(0,r._)([(0,h.MZ)()],We.prototype,"_stagedViewshed",void 0),(0,r._)([(0,h.MZ)()],We.prototype,"_stagedViewshedComputedData",void 0),(0,r._)([(0,h.MZ)()],We.prototype,"_creationState",void 0),(0,r._)([(0,h.MZ)({readOnly:!0})],We.prototype,"cursor",null),(0,r._)([(0,h.MZ)()],We.prototype,"_selectedManipulator",void 0),(0,r._)([(0,h.MZ)()],We.prototype,"_selectedSubTool",null),(0,r._)([(0,h.MZ)()],We.prototype,"selectedViewshed",null),(0,r._)([(0,h.MZ)()],We.prototype,"selectedViewshedComputedData",null),(0,r._)([(0,h.MZ)()],We.prototype,"stagedViewshed",null),(0,r._)([(0,h.MZ)()],We.prototype,"grabbing",null),(0,r._)([(0,h.MZ)()],We.prototype,"creating",null),(0,r._)([(0,h.MZ)()],We.prototype,"isPlacingTarget",null),We=(0,r._)([(0,d.$)("esri.views.3d.analysis.Viewshed.ViewshedTool")],We);const qe=(0,p.vt)(),Be=(0,p.vt)(),$e=(0,p.vt)(),Ke=(0,p.vt)(),Xe=(0,M.vt)(),Ye=(0,A.vt)(),Qe={mapPoint:new D.default,scenePoint:(0,p.vt)(),feature:null},Je=We;var et=i(20561),tt=i(18693),it=i(75075),rt=i(65069),st=i(25735),nt=i(22131);class at extends it.X{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new ve.v({...R.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=(0,M.vt)(),i=e.farDistanceRenderSpace;(0,y.CV)(t,(0,p.fA)(i,i,i)),N(e,ut),(0,y.lK)(t,ut,t),(0,y.kN)(ut,this._viewshedComputedData.observerRenderSpace),(0,y.lK)(t,ut,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachExternalMaterial(e){null!=this._material&&e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;null!=i&&null!=t&&i.isValid()&&function(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:r}=t,s=(0,u.i)(lt,0,0,1),n=(0,u.i)(ct,0,1,0),a=(0,u.i)(ht,1,0,0);G(s,s,(0,b.kU)(r/2),n),G(s,s,(0,b.kU)(i/2),a);const o=e=>Math.ceil(Math.abs(e)/E)+1,l=(0,b.kU)(i),c=(0,u.c)(dt,a),h=o(l),d=ot(-l/(h-1)),p=(0,y.$0)(ut,d,c),v=(0,b.kU)(-r),f=o(v),m=ot(v/(f-1)),w=(0,u.c)(ct,n),_=(0,y.$0)(pt,(0,b.kU)(i)/2,a);(0,u.t)(w,w,_);const g=pt,M=[],V=(0,u.c)(ht,s);for(let b=0;b<h;b++){(0,y.$0)(g,m,w);for(let e=0;e<f;e++){const t=3*(e*h+b);M[t]=V[0],M[t+1]=V[1],M[t+2]=V[2],(0,u.t)(V,V,g)}(0,u.t)(w,w,p),(0,u.t)(s,s,p),(0,u.c)(V,s)}const S=h*f;M[3*S]=0,M[3*S+1]=0,M[3*S+2]=0;const T=[];for(let u=0;u<h-1;u++)for(let e=0;e<f-1;e++){const t=6*(e*(h-1)+u);T[t]=e*h+u,T[t+1]=(e+1)*h+u,T[t+2]=e*h+u+1,T[t+3]=e*h+u+1,T[t+4]=(e+1)*h+u,T[t+5]=(e+1)*h+u+1}const R=[T];if(360!==i&&0!==r){const e=[],t=[];for(let i=0;i<f-1;i++){const r=3*i;e[r]=S,e[r+1]=(i+1)*h,e[r+2]=i*h,t[r]=S,t[r+1]=i*h+h-1,t[r+2]=(i+1)*h+h-1}R.push(e,t)}if(180!==r&&0!==i){const e=[],t=[];for(let i=0;i<h-1;i++){const r=3*i;e[r]=S,e[r+1]=i,e[r+2]=i+1,t[r]=S,t[r+1]=i+(f-1)*h+1,t[r+2]=i+(f-1)*h}R.push(e,t)}return R.map((t=>{const i=[[nt.r.POSITION,new rt.n(M,t,3,!0)]];return new st.V(e,i)}))}(t,i).forEach((t=>e.addGeometry(t)))}}function ot(e){return isNaN(e)?1:e}const lt=(0,p.vt)(),ct=(0,p.vt)(),ht=(0,p.vt)(),dt=(0,p.vt)(),ut=(0,M.vt)(),pt=(0,M.vt)();var vt=i(79678);let ft=class extends n.default{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:(0,p.vt)(),topRight:(0,p.vt)(),bottomLeft:(0,p.vt)(),bottomRight:(0,p.vt)()},this._arcCenterPoints={top:(0,p.vt)(),bottom:(0,p.vt)(),left:(0,p.vt)(),right:(0,p.vt)()},this._parallelCenters={top:(0,p.vt)(),bottom:(0,p.vt)()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:S.m$.OccludeAndTransparent},i={...t,stipplePattern:(0,vt.wk)(2)};this._observerVisualElement=new tt.l({...e,...R.observerPointConfiguration}),this._shapeVisualElement=new at(e),this._frameLinesVisualElement=new et.t(t),this._leftArcVisualElement=new et.t(t),this._rightArcVisualElement=new et.t(t),this._topArcVisualElement=new et.t(t),this._bottomArcVisualElement=new et.t(t),this._centralLongitude=new et.t(i),this._centralLatitude=new et.t(i),this.addHandles([(0,c.watch)((()=>{const e=this.viewshedComputedData;if(!e?.isValid())return null;const t=this._viewshedCorners,i=this._arcCenterPoints,r=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(r),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:r,interactive:this.analysisViewData.interactive,selected:this._selected}}),(e=>{const t=null!=e;this._forEachVisualElement((e=>e.attached=t)),t&&this._updateVisualElements(e)}),{initial:!0,equals:g.equals}),(0,c.watch)((()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=e??{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}}),(e=>{let{viewshedComputedData:t}=e;const{_shapeVisualElement:i}=this;t!==i.viewshedComputedData&&(i.viewshedComputedData=t),this._shapeVisualElement.recreateGeometry()}),c.initial),(0,c.watch)((()=>{const{interactive:e}=this.analysisViewData;return{visible:this.visible,selected:e&&this._selected,staged:e&&this._staged,horFovNot360:360!==this.viewshedComputedData?.horizontalFieldOfView}}),(e=>{let{visible:t,selected:i,staged:r,horFovNot360:s}=e;const n=i||r;this._shapeVisualElement.visible=t,this._topArcVisualElement.visible=t,this._bottomArcVisualElement.visible=t,this._frameLinesVisualElement.visible=t&&s;const a=t&&(i||s);this._leftArcVisualElement.visible=a,this._rightArcVisualElement.visible=a,this._forEachLineVisualElement((e=>{e.width=n?R.frameWidthSelected:R.frameWidthNotSelected,e.renderOccluded=i?S.m$.OccludeAndTransparent:S.m$.Occlude})),[this._centralLatitude,this._centralLongitude].forEach((e=>{e.width=2*(n?R.frameWidthSelected:R.frameWidthNotSelected),e.visible=t&&i}))}),c.initial),(0,c.watch)((()=>{const{analysisViewData:{interactive:e,tool:t},_selected:i,visible:r}=this,s=this.view.activeTool,n=!t?.active&&s instanceof Je&&s.creating;return{observerVisible:r&&!i&&(!e||(t?.creating??!1)||n),color:this._color}}),(e=>{let{observerVisible:t,color:i}=e;this._observerVisualElement.visible=t,this._forEachLineVisualElement((e=>e.color=i))}),c.initial)])}get _color(){const{viewshedComputedData:e,_selected:t,analysisViewData:i}=this;if(null==e)return _.default.toUnitRGBA(R.frameColor);const r=i.tool?.active||i.interactive,s=e.viewshed===i.tool?.stagedViewshed,n=r&&(t||s)?this.view.effectiveTheme.accentColor:R.frameColor;return _.default.toUnitRGBA(n)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===t?.viewshed}destroy(){this._observerVisualElement=(0,l.pR)(this._observerVisualElement),this._shapeVisualElement=(0,l.pR)(this._shapeVisualElement),this._frameLinesVisualElement=(0,l.pR)(this._frameLinesVisualElement),this._leftArcVisualElement=(0,l.pR)(this._leftArcVisualElement),this._rightArcVisualElement=(0,l.pR)(this._rightArcVisualElement),this._topArcVisualElement=(0,l.pR)(this._topArcVisualElement),this._bottomArcVisualElement=(0,l.pR)(this._bottomArcVisualElement),this._centralLongitude=(0,l.pR)(this._centralLongitude),this._centralLatitude=(0,l.pR)(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:r,parallelCenters:s}=e,n=(0,p.o8)(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(n,i),this._updateFrameArcs(t,i,s),this._updateCentralHelperArcs(t,r)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:r,rightVector:s,horizontalFieldOfView:n,tiltedUpVector:a}=e,o=(0,b.kU)(n),l=(0,p.vt)(),c=(0,M.vt)();(0,y.$0)(c,o/2,a),(0,u.t)(l,s,c),mt(this._leftArcVisualElement,r,t.bottomLeft,t.topLeft,"forward",l),(0,y.$0)(c,-o/2,a),(0,u.i)(l,0,0,0),(0,u.t)(l,s,c),mt(this._rightArcVisualElement,r,t.bottomRight,t.topRight,"forward",l);const h=n>180?"backward":"forward";mt(this._topArcVisualElement,i.top,t.topRight,t.topLeft,h,a),mt(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,h,a)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,r=e.horizontalFieldOfView>=180?"backward":"forward";mt(this._centralLatitude,i,t.right,t.left,r,e.tiltedUpVector),mt(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function mt(e,t,i,r,s,n){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:E;const o=(0,p.vt)();(0,u.a)(o,i,t);const l=(0,u.H)(o),c=(0,p.vt)();(0,u.a)(c,r,t),(0,u.n)(c,c),(0,u.h)(c,c,l);let h=(0,u.r)(o,c);const d=(0,p.o8)(n);"backward"===s&&((0,u.v)(d,d),h=-(2*Math.PI-h));const v=[],f=Math.ceil(Math.abs(h)/a),m=(0,M.vt)();(0,y.$0)(m,h/f,d);const w=(0,p.vt)();(0,u.c)(w,o);const _=(0,p.vt)();(0,u.c)(_,i);for(let g=0;g<f;g++){const e=(0,p.vt)();(0,u.c)(e,_),(0,u.t)(w,w,m),(0,u.g)(_,t,w);const i=(0,p.vt)();(0,u.c)(i,_),v.push([e,i])}e.geometry=v}(0,r._)([(0,h.MZ)()],ft.prototype,"view",void 0),(0,r._)([(0,h.MZ)()],ft.prototype,"analysisViewData",void 0),(0,r._)([(0,h.MZ)()],ft.prototype,"viewshedComputedData",void 0),(0,r._)([(0,h.MZ)()],ft.prototype,"visible",void 0),(0,r._)([(0,h.MZ)()],ft.prototype,"_color",null),(0,r._)([(0,h.MZ)()],ft.prototype,"_selected",null),(0,r._)([(0,h.MZ)()],ft.prototype,"_staged",null),ft=(0,r._)([(0,d.$)("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],ft);const wt=ft;let _t=class extends n.default{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=(0,c.mapCollection)((()=>this.analysisViewData.viewshedComputedDataHandles),(t=>{let{viewshedComputedData:i}=t;const r=new wt({view:this.view,viewshedComputedData:i,analysisViewData:e});return{visualization:r,remove:()=>r.destroy()}}));this._viewshedVisualizations=t,this.addHandles([(0,w.DQ)(t),(0,c.watch)((()=>this.visible),(e=>this._viewshedVisualizations.forEach((t=>{let{visualization:i}=t;return i.visible=e}))),c.initial)])}get test(){}};var gt;(0,r._)([(0,h.MZ)({constructOnly:!0})],_t.prototype,"analysisViewData",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0,nonNullable:!0})],_t.prototype,"view",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0})],_t.prototype,"isDecoration",void 0),(0,r._)([(0,h.MZ)()],_t.prototype,"visible",null),_t=(0,r._)([(0,d.$)("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],_t);let bt=gt=class extends n.default{constructor(e){super(e),this.observerRenderSpaceOverride=null}get observer(){return this.viewshed.observer??new D.default}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,(0,p.vt)())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=(0,u.a)((0,p.vt)(),this.targetRenderSpace,this.observerRenderSpace);return(0,u.n)(e,e)}get tiltedUpVector(){const e=G((0,p.vt)(),this.upVector,-(0,b.kU)(this.tiltParallelToSurface),this.leftVector);return(0,u.n)(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,(0,M.vt)())}get upVector(){const e=this._basis;return(0,p.fA)(e[8],e[9],e[10])}get northVector(){const e=this._basis;return(0,p.fA)(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=G((0,p.vt)(),this.northVector,-(0,b.kU)(this.heading),e);return(0,u.e)(t,e,t)}get rightVector(){return(0,u.v)((0,p.vt)(),this.leftVector)}clone(){return new gt({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:r,targetRenderSpace:s}=this,n=(0,u.a)(yt,s,r);return G(n,n,-(0,b.kU)(t),this.leftVector),G(n,n,-(0,b.kU)(e),this.tiltedUpVector),(0,u.g)(i,n,r)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin((0,b.kU)(this.verticalFieldOfView/2)),r=(0,u.h)(yt,this.tiltedUpVector,i);(0,u.g)(e.top,t,r),(0,u.a)(e.bottom,t,r)}renderSpaceToPoint(e,t){const i=yt;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new D.default(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=(0,p.ci)(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:r}=this,s=this.farDistanceRenderSpace,n=(0,p.vt)();return(0,u.h)(n,i,s),G(n,n,-(0,b.kU)(this.heading),r),G(n,n,-(0,b.kU)(this.tiltParallelToSurface),t),(0,u.g)(n,e,n),n}};(0,r._)([(0,h.MZ)()],bt.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,h.MZ)()],bt.prototype,"viewshed",void 0),(0,r._)([(0,h.MZ)()],bt.prototype,"observerRenderSpaceOverride",void 0),(0,r._)([(0,h.MZ)()],bt.prototype,"observer",null),(0,r._)([(0,h.MZ)()],bt.prototype,"effectiveObserverRenderSpace",null),(0,r._)([(0,h.MZ)()],bt.prototype,"effectiveObserver",null),(0,r._)([(0,h.MZ)()],bt.prototype,"effectiveTargetRenderSpace",null),(0,r._)([(0,h.MZ)()],bt.prototype,"farDistance",null),(0,r._)([(0,h.MZ)()],bt.prototype,"farDistanceRenderSpace",null),(0,r._)([(0,h.MZ)()],bt.prototype,"heading",null),(0,r._)([(0,h.MZ)()],bt.prototype,"tilt",null),(0,r._)([(0,h.MZ)()],bt.prototype,"feature",null),(0,r._)([(0,h.MZ)()],bt.prototype,"tiltParallelToSurface",null),(0,r._)([(0,h.MZ)()],bt.prototype,"horizontalFieldOfView",null),(0,r._)([(0,h.MZ)()],bt.prototype,"verticalFieldOfView",null),(0,r._)([(0,h.MZ)()],bt.prototype,"observerRenderSpace",null),(0,r._)([(0,h.MZ)()],bt.prototype,"target",null),(0,r._)([(0,h.MZ)()],bt.prototype,"targetRenderSpace",null),(0,r._)([(0,h.MZ)()],bt.prototype,"targetDirection",null),(0,r._)([(0,h.MZ)()],bt.prototype,"tiltedUpVector",null),(0,r._)([(0,h.MZ)()],bt.prototype,"_basis",null),(0,r._)([(0,h.MZ)()],bt.prototype,"upVector",null),(0,r._)([(0,h.MZ)()],bt.prototype,"northVector",null),(0,r._)([(0,h.MZ)()],bt.prototype,"leftVector",null),(0,r._)([(0,h.MZ)()],bt.prototype,"rightVector",null),(0,r._)([(0,h.MZ)()],bt.prototype,"isValid",null),(0,r._)([(0,h.MZ)()],bt.prototype,"metersPerUnit",null),bt=gt=(0,r._)([(0,d.$)("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],bt);const yt=(0,p.vt)();var Mt=i(8609),Vt=i(92453),St=i(89129),Et=i(89476),Tt=i(3115),Rt=i(62650),Ot=i(18683),Dt=i(15500),At=i(85293),xt=i(24646),Ct=i(83607);let Pt=class extends Ct.default{constructor(){super(...arguments),this.sectionAngles=(0,xt.vt)()}get sectionAnglesDeg(){return(0,xt.ci)(this.sectionAngles.map((e=>(0,b.KJ)(e))))}set sectionAnglesDeg(e){this.sectionAngles=(0,xt.ci)(e.map((e=>(0,b.kU)(e))))}get projectionMatrix(){return(0,y.lK)((0,M.vt)(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],r=this.sectionAngles[3];(0,te.vA)(e<=t),(0,te.vA)(i<=r);const s=2*Math.tan(this.fovX/2),n=2*Math.tan(this.fovY/2),a=Math.tan(e),o=Math.tan(t),l=Math.tan(i),c=o-a,h=Math.tan(r)-l,d=s/c,u=n/h,p=-(a+c/2)/s*2,v=-(l+h/2)/n*2,f=(0,M.vt)();(0,y.kN)(f,[p,v,0]);const m=(0,M.vt)();(0,y.CV)(m,[d,u,1]);const w=(0,M.vt)();return(0,y.lK)(w,m,f)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};(0,r._)([(0,h.MZ)()],Pt.prototype,"sectionAngles",void 0),(0,r._)([(0,h.MZ)()],Pt.prototype,"sectionAnglesDeg",null),(0,r._)([(0,h.MZ)()],Pt.prototype,"projectionMatrix",null),(0,r._)([(0,h.MZ)()],Pt.prototype,"sectionMatrix",null),(0,r._)([(0,h.MZ)()],Pt.prototype,"_sectionRatioX",null),Pt=(0,r._)([(0,d.$)("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Pt);var Ft=i(92156);class zt{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const It=["front","left","right","back","top","bottom"];class Ht{constructor(e){this._fbos=e,this._minTextureSize=16,this._faces={},this._width=0,this._height=0,this.settings=new zt,this._maxTextureSize=Math.min((0,a.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture()}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach((i=>{e[i]&&(t+=1)})),t}get faces(){const e=this._faces,t=[];for(const i of It){const r=e[i];r&&t.push(r)}return t}get atlasRegions(){return this.faces.map((e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height]))}get viewshedProjectionMatrices(){return this.faces.map((e=>e.projectionMatrix))}get viewshedViewMatrices(){return this.faces.map((e=>e.viewMatrix))}_setupFaceCamera(e,t,i,r){const{effectiveObserverRenderSpace:s,tiltedUpVector:n,targetRenderSpace:a,farDistanceRenderSpace:o,horizontalFieldOfView:l,verticalFieldOfView:c}=t,h=(0,p.vt)();(0,u.a)(h,a,s);const d=(0,p.vt)(),v=(0,p.vt)(),f=(e,t)=>{const i=(0,p.vt)(),r=(0,M.vt)();return(0,y.$0)(r,e,t),(0,u.t)(i,h,r),(0,u.g)(i,s,i),i};let m,w=n;const _=Math.min(90,l),g=Math.min(90,Math.max(0,(l-90)/2));let V=-45,S=45,E=-45,T=45;if(function(e){return!["top","bottom"].includes(e)}(e)){const e=e=>(0,b.qE)(e,-45,45);E=e(-c/2)-this.settings.toleranceBottomTop,T=e(+c/2)+this.settings.toleranceBottomTop}switch(e){case"front":m=a,V=-_/2,S=_/2;break;case"left":m=f(Math.PI/2,n),V=45-g;break;case"right":m=f(-Math.PI/2,n),S=-45+g;break;case"top":m=(0,u.g)(d,s,n),w=(0,u.v)(v,h);break;case"bottom":m=(0,u.a)(d,s,n),w=h;break;case"back":m=f(Math.PI,n)}const R=new Pt({center:m,eye:s,up:w,far:o});R.sectionAnglesDeg=[V-this.settings.toleranceSides,S+this.settings.toleranceSides,E,T],R.fovY=Math.PI/2;const O=R.setViewport(i,r);return this._faces[e]=R,O}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:r}=e,s=-r/2,n=r/2;return 0===i||0===r||(s<=45&&n>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),n>45-this.settings.toleranceBottomTop&&t.add("top"),s<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize(e,t,i,r){const s=t/e.pixelRatio,n=this.settings.textureSizeModifier(i),a=Math.max(e.fullWidth,e.fullHeight),o=(0,At.Mv)(Math.floor(a*s*n)),l=Math.floor(this._maxTextureSize/r),c=(0,b.qE)(o,this._minTextureSize,l);return(0,At.uT)(c)}_ensureFBO(e){const t=this._width,i=this._height;this._handle?.fbo?.width===t&&this._handle?.fbo?.height===i||(this._handle?.release(),this._handle=this._fbos.acquire(t,i,"viewshed shadow map",Dt.N.RGBA4));const r=e?Dt.z.DEPTH_STENCIL_TEXTURE:Dt.z.DEPTH16_BUFFER;this._handle.acquireDepth(r)}clearFBO(e){const t=this._fbos.rctx;this._ensureFBO(e),t.bindFramebuffer(this._handle?.fbo),t.setClearColor(1,1,1,1),t.clear(Ft.NV.COLOR|Ft.NV.DEPTH)}dispose(){this._handle=(0,l.Gz)(this._handle)}start(e,t,i,r){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._faces={};const n=this._computeActiveFaces(t),a=n.size;if(0===a)return!1;const o=this._computeBaseTextureSize(e,r,i,a);let l=0,c=0,h=0;return It.filter((e=>n.has(e))).forEach((e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,a);i>c&&(h=Math.max(h,l),l=0),c=i;const r=i*o;l+=this._setupFaceCamera(e,t,[l,r],o)})),h=Math.max(h,l),this._width=this.settings.textureResizeModulo(h),this._height=function(e){return e<4?1:2}(a)*o,this.clearFBO(s),!0}finish(){this._handle?.detachDepth()}get test(){return{faces:this._faces,faceTypes:It,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",Dt.N.RGBA4)}}}var Zt=i(32219),Ut=i(93003),kt=i(16434),Lt=i(12723);class Nt extends kt.w{constructor(e,t){super(e,t,new Ut.$(Zt.a,(()=>i.e(83803).then(i.bind(i,83803)))))}initializePipeline(){return(0,Lt.Ey)({colorWrite:Lt.kn,blending:Lt.Ky})}}let jt=class extends Rt.default{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter((e=>function(e,t){const i=(0,Et.l)(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}(this.view,e)))}constructor(e){super(e),this._passParameters=new Zt.V,this._viewsheds=new St.default,this._shadowMap=null,this.consumes={required:[Tt.InternalRenderCategory.VIEWSHED,"normals"]},this.produces=Tt.InternalRenderCategory.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new Ht(this.fboCache),this.addHandles([(0,c.watch)((()=>this.view.resolutionScale),(e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)}),c.initial),(0,c.when)((()=>!this.hasViewsheds),(()=>this._shadowMap?.dispose())),(0,c.watch)((()=>this._viewshedsInView.map((e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]))),(()=>this.requestRender(V.C7.UPDATE)),c.sync)])}destroy(){this._shadowMap=(0,l.WD)(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(Nt);for(const e of this._viewshedsInView)if(this._shadowMap?.isActive(e))return void this.view._stage.renderer.precompileViewshedShadowMap()}}render(e){const t=this.bindParameters,i=this.renderingContext,r=e.find((e=>{let{name:t}=e;return t===Tt.InternalRenderCategory.VIEWSHED}));if(!this.hasViewsheds||!t.depth)return r;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=e.find((e=>{let{name:t}=e;return"normals"===t}))?.getTexture();const s=this.techniques.get(Nt);if(!s?.compiled)return this.requestRender(V.C7.UPDATE),r;const n=this.view._stage.renderer.isFeatureEnabled(Ot.n.HighResolutionViewshed);for(const a of this._viewshedsInView){if(!this._renderShadowCubeMap(t,a,n)||!this._shadowMap?.ready)continue;const e=this._setupViewshedParameters(a,t.camera);i.bindTechnique(s,t,e),i.bindFramebuffer(r.fbo),i.screen.draw()}return this.shadowMap?.dispose(),r}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:r}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),r)if(Array.isArray(r)){const e=r.filter((e=>!t.includes(e)));t.addMany(e)}else t.includes(r)||t.add(r)}_renderShadowCubeMap(e,t,i){const r=this._shadowMap;if(!r)return!1;const s=this.view.basemapTerrain.hasStencilEnabledExtents,n=r.start(e.camera,t,i,this._contentPixelRatio,s);return n&&r.faces.forEach((e=>this.view._stage.renderer.renderViewshedShadowMap(e))),r.finish(),n}_setupViewshedParameters(e,t){const i=this._shadowMap;if(!i)return this._passParameters;const r=this._passParameters,s=e.effectiveObserverRenderSpace;r.localOrigin=s,r.observerOffset=(0,u.a)(Wt,e.observerRenderSpace,e.effectiveObserverRenderSpace),r.fovs=[(0,b.kU)(e.horizontalFieldOfView),(0,b.kU)(e.verticalFieldOfView)],r.headingAndTilt=[(0,b.kU)(e.heading),(0,b.kU)(e.tiltParallelToSurface)],r.upVector=e.tiltedUpVector;const n=function(e,t){const i=(0,p.vt)();return(0,u.a)(i,e,t)}(e.targetRenderSpace,s);r.targetVector=n;const a=new Array,o=new Array;for(let l=0;l<i.numActiveFaces;l++)(0,y.Tl)(qt,i.viewshedViewMatrices[l],s),a.push(...qt),Gt(i.viewshedProjectionMatrices[l],qt,Bt),o.push(...Bt);return r.viewMatrices=a,r.projectionMatrices=o,r.volumeOffset=this.selectedViewshed?.()===e.viewshed?function(e,t,i){if(null==e)return 0;const{observerRenderSpace:r,targetRenderSpace:s}=e,n=(0,u.j)(i,r)>(0,u.j)(i,s)?e.observer:e.target;return t.pixelSizeAt(n)}(e,this.view,t.eye):0,r}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Gt(e,t,i){const r=(0,p.fA)(.5,.5,.5);return(0,y.kN)(i,r),(0,y.hs)(i,i,r),(0,y.lK)(i,i,e),(0,y.lK)(i,i,t),i}(0,r._)([(0,h.MZ)()],jt.prototype,"selectedViewshed",void 0),(0,r._)([(0,h.MZ)()],jt.prototype,"shadowMap",null),(0,r._)([(0,h.MZ)()],jt.prototype,"hasViewsheds",null),(0,r._)([(0,h.MZ)()],jt.prototype,"_contentPixelRatio",null),(0,r._)([(0,h.MZ)()],jt.prototype,"_viewshedsInView",null),(0,r._)([(0,h.MZ)()],jt.prototype,"consumes",void 0),(0,r._)([(0,h.MZ)()],jt.prototype,"produces",void 0),jt=(0,r._)([(0,d.$)("esri.views.3d.webgl-engine.lib.Viewshed")],jt);const Wt=(0,p.vt)(),qt=(0,M.vt)(),Bt=(0,M.vt)();var $t=i(34567);let Kt=class extends((0,f.P)(n.default)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this._placementTask=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}initialize(){const e=this.view;this._viewshedRenderer=new jt({view:e,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed}),this._intersector=(0,Mt.hz)(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=Vt.oH.MIN,this.viewshedComputedDataHandles=(0,c.mapCollection)((()=>this.analysis.viewsheds),(t=>{const i=new bt({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),r=Symbol();return this.addHandles([(0,c.watch)((()=>({valid:i.isValid(),canProject:(0,v.canProjectWithoutEngine)(i.observer?.spatialReference,this.view.spatialReference)||(0,v.isLoaded)()})),((e,t)=>{let{valid:r,canProject:s}=e;this.visible&&(r&&s?this._addViewshedsToRenderer(i):t?.valid&&t?.canProject&&this._removeViewshedsFromRenderer(i),s||(0,m.V)(this.analysis,i.observer.spatialReference,o.A.getLogger(this)))}),c.initial),(0,c.watch)((()=>[e.state.camera,e.slicePlane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature]),(()=>{this._updateObserverFromFeature(e,i)}),c.initial)]),{viewshedComputedData:i,remove:()=>{this.removeHandles(r),this._removeViewshedsFromRenderer(i),i.destroy()}}})),this._analysisVisualization=new _t({view:e,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([(0,c.watch)((()=>this.visible),(e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const i=t.map((e=>e.viewshedComputedData)).filter((e=>e.isValid())).toArray();e?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)})),(0,c.watch)((()=>e.renderCoordsHelper),(e=>{this.viewshedComputedDataHandles?.forEach((t=>{let{viewshedComputedData:i}=t;return i.renderCoordsHelper=e}))})),(0,$t.Hd)(this,Je),(0,c.when)((()=>this.interactive),(()=>{this._unselectOtherViewsheds(this.selectedViewshed)}),c.syncAndInitial)])}destroy(){this._placementTask=(0,l.DC)(this._placementTask),(0,$t.aS)(this),this._analysisVisualization=(0,l.pR)(this._analysisVisualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map((e=>e.viewshedComputedData)).toArray())}async createViewsheds(e){return this._placementTask=(0,l.DC)(this._placementTask),this._placementTask=(0,$t.JY)(this,e),null!=this.tool&&this.tool.createViewsheds(),await this._placementTask.promise}_addViewshedsToRenderer(e){this._viewshedRenderer.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderer.updateViewsheds({removes:e})}_updateObserverFromFeature(e,t){const i=t.observerRenderSpace,r=t.targetRenderSpace,n=(0,u.c)((0,p.vt)(),i),a={observer:i,observerSurfaceNormal:null,observerAdjusted:n,observerFeatureId:(0,s.wY)(t.feature),target:r,targetSurfaceNormal:null,targetAdjusted:(0,u.c)((0,p.vt)(),r),targetFeatureId:null};(0,s.uY)(e,this._intersector,a,(e=>Math.min(e,.05*t.farDistanceRenderSpace))),t.observerRenderSpaceOverride=(0,u.p)(n,i)?null:n}_unselectOtherViewsheds(e){if(null!=e)for(const t of this.view.tools.items)t!==this.tool&&t instanceof Je&&(t.analysisViewData.selectedViewshed=null)}get test(){}};(0,r._)([(0,h.MZ)({readOnly:!0})],Kt.prototype,"type",void 0),(0,r._)([(0,h.MZ)({constructOnly:!0,nonNullable:!0})],Kt.prototype,"analysis",void 0),(0,r._)([(0,h.MZ)()],Kt.prototype,"tool",void 0),(0,r._)([(0,h.MZ)()],Kt.prototype,"_selectedViewshed",void 0),(0,r._)([(0,h.MZ)()],Kt.prototype,"selectedViewshed",null),(0,r._)([(0,h.MZ)()],Kt.prototype,"selectedViewshedComputedData",null),(0,r._)([(0,h.MZ)()],Kt.prototype,"viewshedComputedDataHandles",void 0),(0,r._)([(0,h.MZ)()],Kt.prototype,"_analysisVisualization",void 0),(0,r._)([(0,h.MZ)()],Kt.prototype,"_placementTask",void 0),(0,r._)([(0,h.MZ)()],Kt.prototype,"_viewshedRenderer",void 0),Kt=(0,r._)([(0,d.$)("esri.views.3d.analysis.ViewshedAnalysisView3D")],Kt);const Xt=Kt},86925:(e,t,i)=>{i.r(t),i.d(t,{default:()=>f});var r=i(93800),s=i(46316),n=i(85715),a=i(5839),o=i(19455),l=i(17741),c=i(48602),h=i(32980),d=(i(21265),i(14746),i(75269)),u=i(80556),p=i(75400);let v=class extends(o.A.JSONSupportMixin(n.A)){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45,this.feature=null}isValid(){return null!=this.observer&&this.farDistance>0}equals(e){return(0,l.CM)(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView&&(0,s.xH)(this.feature,e.feature)}};(0,r._)([(0,c.MZ)({type:p.default,json:{write:{isRequired:!0}}})],v.prototype,"observer",void 0),(0,r._)([(0,c.MZ)({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],v.prototype,"farDistance",void 0),(0,r._)([(0,c.MZ)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,h.w)((e=>a.ie.normalize((0,u.GB)(e),void 0,!0)))],v.prototype,"heading",void 0),(0,r._)([(0,c.MZ)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],v.prototype,"tilt",void 0),(0,r._)([(0,c.MZ)({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}})],v.prototype,"horizontalFieldOfView",void 0),(0,r._)([(0,c.MZ)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],v.prototype,"verticalFieldOfView",void 0),(0,r._)([(0,c.MZ)(s.N1)],v.prototype,"feature",void 0),(0,r._)([(0,c.MZ)({json:{read:!1}})],v.prototype,"isValid",null),v=(0,r._)([(0,d.$)("esri.analysis.Viewshed")],v);const f=v},88204:(e,t,i)=>{i.d(t,{g:()=>h});var r=i(93800),s=i(6946),n=(i(21265),i(50925),i(49959)),a=i(48602),o=(i(14746),i(75269)),l=i(54379),c=i(77783);let h=class extends s.default{constructor(e){super(e),this.manipulators=new c.t,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[l.PK.MANAGER,!0],[l.PK.USER,!0]]),this._creationFinishedResolver=(0,n.createResolver)()}get active(){return null!=this.view&&this.view.activeTool===this}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this._syncVisible())}get editable(){return this.getEditableFlag(l.PK.USER)}set editable(e){this.setEditableFlag(l.PK.USER,e)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){null!=this.view&&(this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(e){this.onInputEvent(e)}handleInputEventAfter(e){this.onInputEventAfter(e)}setEditableFlag(e,t){this._editableFlags.set(e,t),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),e===l.PK.USER&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(e){return this._editableFlags.get(e)??!1}endDrag(){const e=this.view.inputManager.latestPointerLocation;if(!e)return;let t=!1;this.manipulators.forEach((i=>{let{manipulator:r}=i;r.dragging&&(t=!0,r.events.emit("drag",{action:"end",start:e,screenPoint:e}))})),t&&(this.view.toolViewManager.activeTool=null)}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(e){}onInputEventAfter(e){}get internallyEditable(){return this.getEditableFlag(l.PK.USER)&&this.getEditableFlag(l.PK.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized)if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};(0,r._)([(0,a.MZ)({constructOnly:!0})],h.prototype,"view",void 0),(0,r._)([(0,a.MZ)({readOnly:!0})],h.prototype,"active",null),(0,r._)([(0,a.MZ)({value:!0})],h.prototype,"visible",null),(0,r._)([(0,a.MZ)({value:!0})],h.prototype,"editable",null),(0,r._)([(0,a.MZ)({readOnly:!0})],h.prototype,"manipulators",void 0),(0,r._)([(0,a.MZ)({readOnly:!0})],h.prototype,"updating",null),(0,r._)([(0,a.MZ)()],h.prototype,"cursor",null),(0,r._)([(0,a.MZ)({readOnly:!0})],h.prototype,"automaticManipulatorSelection",void 0),(0,r._)([(0,a.MZ)()],h.prototype,"hasFocusedManipulators",null),(0,r._)([(0,a.MZ)()],h.prototype,"hasGrabbedManipulators",void 0),(0,r._)([(0,a.MZ)()],h.prototype,"hasHoveredManipulators",void 0),(0,r._)([(0,a.MZ)()],h.prototype,"firstGrabbedManipulator",void 0),(0,r._)([(0,a.MZ)({readOnly:!0})],h.prototype,"created",void 0),(0,r._)([(0,a.MZ)({readOnly:!0})],h.prototype,"removeIncompleteOnCancel",void 0),h=(0,r._)([(0,o.$)("esri.views.interactive.InteractiveToolBase")],h)},95441:(e,t,i)=>{i.d(t,{T:()=>n});var r=i(8609),s=i(92453);function n(e){const t=(0,r.hz)(e);return t.options.store=s.oH.MIN,t.options.excludeLabels=!0,t}}}]);