"use strict";(self.webpackChunkever_wading_birds=self.webpackChunkever_wading_birds||[]).push([[65393],{65393:(e,t,i)=>{i.d(t,{default:()=>p});var a=i(79625),r=i(62631),o=i(49959),n=i(26848),s=i(75400),l=i(96913),c=i(31766),u=i(7772),d=i(57703);class p{constructor(e){this.viewModel=e,this._updateBestFeatureFootprintElevation=!1,this.createFootprints=async e=>{const{coverageFrustums:t,currentBestFeature:i,isAdditionalCoverageVisible:s,view:p}=this.viewModel,w=t.filter(r.Ru);for(const r of w){let t=r.clone();if(!p.spatialReference.equals(t.spatialReference)){const{components:i,spatialReference:a,origin:r,vertexAttributes:s,vertexSpace:d}=t;if("local"===d.type){const i=await(0,l.projectWithZConversion)(r,p.spatialReference,e);(0,o.throwIfAborted)(e),t.centerAt(i)}else{const r=s.position,l=Float64Array.from(await(0,u.PT)([...r],a.clone(),p.spatialReference.clone(),e));(0,o.throwIfAborted)(e),t=new n.default({vertexAttributes:new c.H({position:l}),components:i,spatialReference:p.spatialReference.clone()})}}r.imageID===i.attributes.objectId?(this.viewModel.bestFeatureFootprint=new a.default({attributes:{imageID:r.imageID},geometry:t,symbol:d.Xg.clone(),visible:!1}),this._updateBestFeatureFootprintElevation=!0):this.viewModel.additionalFootprints.push(new a.default({attributes:{imageID:r.imageID},geometry:t,symbol:d.Mi.clone(),visible:s}))}},this.updateFootprint=async(e,t)=>{const{bestFeatureFootprint:i,currentBestFeature:n,activeViewer:c,footprintExtent:p,view:w}=this.viewModel,f=c?.imageSize;if(!(n&&i?.geometry&&f&&p))return void this.viewModel.updateCurrentCoveragePolygon(null);const{attributes:{cameraHeight:h,location:v,cameraPitch:m,horizontalFieldOfView:g,verticalFieldOfView:b,cameraRoll:y},elevationSample:F}=n;F&&this._updateBestFeatureFootprintElevation&&(this.updateGroundElevation([i],F),this._updateBestFeatureFootprintElevation=!1);const R=v.toArray(),{vertexAttributes:{position:M},spatialReference:A}=i.geometry,C=await async function(e,t,i,a){return Float64Array.from((await Promise.all(e.reduce(((e,t,i)=>{const a=Math.floor(i/3);return e[a]=e[a]??[],e[a].push(t),e}),new Array).map((async e=>(await(0,l.projectWithZConversion)(new s.default(e,t),i,a)).toArray())))).flat())}(M,A,v.spatialReference),I=await this.viewModel.getMapPoint(e,{feature:n,mode:"default",imageSize:f});(0,o.throwIfAborted)(t);let V=I.filter(r.Ru);if(!V.length)return;V[0].spatialReference.equals(v.spatialReference)||(V=await Promise.all(V.map((async e=>{const i=await(0,l.projectWithZConversion)(e,v.spatialReference,t);return(0,o.throwIfAborted)(t),i}))));const P=await(0,u.WD)(e.map((e=>{let{x:t,y:i}=e;return[t,i]})),V.map((e=>e.toArray())),{cameraHeight:h,cameraLocation:R,cameraPitch:m,frustumVertices:C,horizontalFieldOfView:g,imageHeight:f[1],imageWidth:f[0],inSRS:{wkid:v.spatialReference.wkid},outSRS:{wkid:w.spatialReference.wkid},verticalFieldOfView:b,cameraRoll:y??0,options:t});this.viewModel.updateCurrentCoveragePolygon(new a.default({attributes:{imageID:n.attributes.objectId},geometry:P,symbol:d.Xg.clone(),visible:this.viewModel.currentCoverageVisible}))},this.updateFootprintPanorama=async(e,t)=>{await(0,o.waitTick)(t);const{horizontalFieldOfView:i,pitch:r,verticalFieldOfView:n,yaw:s}=e,l=this.viewModel.currentBestFeature?.clone();if(!l)return;const{attributes:c}=l;c.orientedImageryType=null,c.cameraHeading=(s+c.cameraHeading)%360,c.cameraPitch=r,c.horizontalFieldOfView=i,c.verticalFieldOfView=n,c.cameraRoll=0;const{frustum:p}=(0,u.ns)(c);p?this.viewModel.updateCurrentCoveragePolygon(new a.default({attributes:{imageID:c.objectId},geometry:p,symbol:d.Xg.clone(),visible:this.viewModel.currentCoverageVisible})):this.viewModel.updateCurrentCoveragePolygon(null)}}updateGroundElevation(e,t){const{geometry:i}=this.viewModel.currentBestFeature,a=t.queryElevation(i);e.forEach((e=>{const{geometry:t}=e;switch(t?.type){case"mesh":{const{vertexAttributes:{position:e}}=t,i=Math.floor(e.length/3);for(let t=0;t<i;t+=1)e[3*t+2]+=a?.z??0;break}case"point":t.z=(t.z??0)+(a?.z??0)}}))}}}}]);