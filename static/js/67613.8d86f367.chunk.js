"use strict";(self.webpackChunkever_wading_birds=self.webpackChunkever_wading_birds||[]).push([[13303,14524,23682,47381,49214,63643,67613,69762,76809,76845,92143,99590],{563:(e,t,i)=>{i.d(t,{E:()=>r});class r{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const i of this._candidateTiles)e>0?(i.reshuffle(),e--):t.push(i);this._candidateTiles=t}}},855:(e,t,i)=>{i.d(t,{o:()=>r,q:()=>a});var r,s=i(93800),n=i(21484);!function(e){e[e.Gradient=0]="Gradient",e[e.Threshold=1]="Threshold",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends n.K{constructor(){super(...arguments),this.visualization=r.Gradient,this.bandsEnabled=!1}}(0,s._)([(0,n.W)({count:r.COUNT})],a.prototype,"visualization",void 0),(0,s._)([(0,n.W)()],a.prototype,"bandsEnabled",void 0)},1021:(e,t,i)=>{function r(){return new Float32Array(4)}function s(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function n(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function a(){return r()}function o(){return n(1,1,1,1)}function l(){return n(1,0,0,0)}function h(){return n(0,1,0,0)}function c(){return n(0,0,1,0)}function d(){return n(0,0,0,1)}i.d(t,{fA:()=>n,o8:()=>s,uY:()=>u});const u=a(),p=o(),m=l(),_=h(),g=c(),f=d();Object.freeze(Object.defineProperty({__proto__:null,ONES:p,UNIT_W:f,UNIT_X:m,UNIT_Y:_,UNIT_Z:g,ZEROS:u,clone:s,create:r,createView:function(e,t){return new Float32Array(e,t,4)},fromValues:n,ones:o,unitW:d,unitX:l,unitY:h,unitZ:c,zeros:a},Symbol.toStringTag,{value:"Module"}))},1396:(e,t,i)=>{i.d(t,{H:()=>o,p:()=>r});var r,s=i(93800),n=i(92212),a=i(21484);!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(r||(r={}));class o extends a.K{constructor(){super(...arguments),this.steps=r.SIXTEEN,this.writeTextureChannels=n.c.RG}}(0,s._)([(0,a.W)({count:r.COUNT})],o.prototype,"steps",void 0),(0,s._)([(0,a.W)({count:n.c.COUNT})],o.prototype,"writeTextureChannels",void 0)},1824:(e,t,i)=>{i.d(t,{H:()=>_,b:()=>m});var r=i(95515),s=i(33273),n=i(77742),a=i(10894),o=i(42403),l=i(16878),h=i(73712),c=i(85593),d=i(29026),u=i(47998),p=i(8118);function m(e){const t=new p.N5,{fragment:i}=t;t.include(c.y),(0,a.Gc)(i),t.include(n.C),i.include(s.E),i.include(d.t),i.include(u.b),i.include(r.o,!0),i.uniforms.add(new h.x("depthTexture",(e=>e.mainDepth)),new o.m("hazeStrength",(e=>e.hazeStrength)));const{reduced:m}=e;return m&&i.code.add(l.H`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),i.main.add(l.H`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${(0,l.If)(m,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),t}const _=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},2739:(e,t,i)=>{i.d(t,{CB:()=>v,ZD:()=>S,av:()=>b,zC:()=>M});var r=i(79625),s=i(64986),n=i(16804),a=i(28473),o=i(75400),l=i(93321),h=i(18162),c=i(46808),d=i(78076),u=i(4794),p=i(96504),m=i(8609),_=i(92453),g=i(27464),f=i(54407),y=i(64863);async function v(e,t,i,r){const s=i?S(e,i):r,a=(0,n.gs)(t.x,t.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const o=(0,m.hz)(e.state.viewingMode);o.options.selectionMode=!0,o.options.store=_.oH.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(a,o,s);const l=function(e,t,i){const r=new Array;let s=null;for(let n=0;n<t.length;n++){const a=t[n],o=(0,f.FV)(a,e);if(null!=o&&(o===e.map.ground||"type"in o&&(0,d.Eq)(o.type)))break;const l=(0,f.FI)(a,e);if(null==l)continue;if("graphic"===l.type){if(null==s&&n!==t.length-1&&(s=new Set),null!=s){const e=x(l.graphic);if(s.has(e))continue;s.add(e)}if(!C(i,l.graphic))continue}const h=w(e,a),c=a.distanceInRenderSpace;if("media"===l.type){const e=l.element.toSource(h);r.push({...l,mapPoint:h,distance:c,sourcePoint:e})}else r.push({...l,mapPoint:h,distance:c})}return r}(e,o.results.all,s.graphics),h=o.results.ground,c=(0,f.FV)(h,e),p=null!=c&&"type"in c&&(0,d.Eq)(c.type)?c:null,y={screenPoint:t,results:l,ground:{mapPoint:w(e,h),distance:(0,g.i3)(h)?h.distanceInRenderSpace:0,layer:p}};return u.b.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(y.intersector=o),y}function b(e,t,i,r){const s=i?S(e,i):r,a=!(!s.graphics?.include&&!s.graphics?.exclude),o=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),l=(0,n.WA)(t);s.enableDraped=s.include&&!s.include.has(y.fo)||s.exclude?.has(y.fo);const h=e.sceneIntersectionHelper,c=(0,m.hz)(e.state.viewingMode);if(c.options.selectionMode=!0,c.options.store=a||o?_.oH.ALL:_.oH.MIN,c.options.excludeLabels=i?.excludeLabels??!1,h.intersectIntersectorScreen(l,c,s),a||o){for(const t of c.results.all){const i=(0,f.FI)(t,e);if(null==i)return w(e,t);if(a&&("graphic"!==i.type||C(s.graphics,i.graphic)))return w(e,t);if(o&&("media"!==i.type||T(s.mediaElements,i.element)))return w(e,t)}return null}return w(e,c.results.min)}function w(e,t,i){return t.getIntersectionPoint(E)?(i=M(e,E,i),t.intersector===_.dz.TERRAIN&&e.basemapTerrain&&(i.z=(0,p.R1)(e.basemapTerrain,i)??0),i):null}function x(e){const t=e.sourceLayer,i=e.layer,r=t&&"objectIdField"in t?t:i&&"objectIdField"in i?i:t;if(r){const t=r.objectIdField??c.r,i=e.attributes?.[t];if(i)return`o-${r.id}-${i}`}return`u-${e.uid}`}function C(e,t){return T(e,x(t))}function T(e,t){return null==e||(null==e.include||e.include.has(t))&&(null==e.exclude||!e.exclude.has(t))}function M(e,t,i){let r=e.spatialReference||l.default.WGS84;return(0,h.F)(t,e.renderSpatialReference,E,r)?t=E:(r=l.default.WGS84,(0,h.F)(t,e.renderSpatialReference,E,r)&&(t=E)),i?(i.x=t[0],i.y=t[1],i.z=t[2],i.spatialReference=r):i=new o.default(t,r),i}function S(e,t){const i=R(e,t.include,O.INCLUDE),r=R(e,t.exclude,O.EXCLUDE);return{include:i.layerUids,exclude:r.layerUids,graphics:{include:i.graphicUids,exclude:r.graphicUids},mediaElements:{include:i.mediaElements,exclude:r.mediaElements}}}function R(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{layerUids:void 0,graphicUids:void 0,mediaElements:void 0};if(!t)return n;if(t instanceof r.default)(function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)})(n,x(t)),i===O.INCLUDE&&(null!=e.graphicsView&&t.layer===e?A(n,e.graphicsView.processor.layer.id):t.layer&&A(n,t.layer.uid));else if("layer"in t&&"element"in t)(function(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)})(n,t.element),i===O.INCLUDE&&A(n,t.layer.uid);else if((0,s.xZ)(t))for(const r of t)r===e.graphics&&null!=e.graphicsView?A(n,e.graphicsView.processor.layer.id):r===e.map.ground?A(n,y.fo):R(e,r,i,n);else"uid"in t&&A(n,t.uid);return n}function A(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}const E=(0,a.vt)();var O;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(O||(O={}))},2799:(e,t,i)=>{var r;i.d(t,{g:()=>r}),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(r||(r={}))},3145:(e,t,i)=>{i.d(t,{CQ:()=>r,M4:()=>o,QG:()=>l,Y8:()=>s,fI:()=>h,ik:()=>n,jj:()=>a});const r=(0,i(21265).A)("esri-mobile")?64:128,s=r/128,n=Math.ceil(Math.sqrt(r)),a=(r+2)*n,o=1e5,l=128,h=a/1560},3581:(e,t,i)=>{i.d(t,{e:()=>n});var r=i(73031),s=i(826);class n extends s.n{constructor(e,t){super(e,"bool",r.c.Pass,((i,r,s)=>i.setUniform1b(e,t(r,s))))}}},4064:(e,t,i)=>{i.d(t,{Pd:()=>n,VS:()=>o,oI:()=>a});var r=i(92156),s=i(605);const n=new Map([["geometry",[new s._("a_pos",2,r.pe.BYTE,0,2)]]]),a=new Map([["geometry",[new s._("a_pos",2,r.pe.BYTE,0,4),new s._("a_tex",2,r.pe.BYTE,2,4)]]]),o=new Map([["geometry",[new s._("a_pos",2,r.pe.UNSIGNED_SHORT,0,4)]]])},4128:(e,t,i)=>{i.r(t),i.d(t,{default:()=>b});var r=i(93800),s=i(6946),n=i(89129),a=i(79953),o=i(48602),l=(i(21265),i(50925)),h=(i(14746),i(75269)),c=i(64566),d=i(58448),u=i(93321),p=i(90772),m=i(73381),_=i(36447),g=i(4742);let f=class extends d.A.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=g.sH}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})))}get extent(){const e=this.view.basemapTerrain;if(null==e?.extent||null==e.spatialReference)return null;const t=(0,p.w1)(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){return this.view.basemapTerrain?.spatialReference??u.default.WGS84}elevationAt(e,t){if(null==this.extent||!(0,m.lB)(this.extent,e,t)){const i=null!=this.extent?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return l.A.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,t,0,this.spatialReference,"ground")??this.noDataValue}queryElevation(e){return(0,_.updateGeometryElevation)(e.clone(),this)}};(0,r._)([(0,o.MZ)({readOnly:!0})],f.prototype,"demResolution",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],f.prototype,"extent",null),(0,r._)([(0,o.MZ)({readOnly:!0})],f.prototype,"noDataValue",void 0),(0,r._)([(0,o.MZ)()],f.prototype,"spatialReference",null),(0,r._)([(0,o.MZ)({constructOnly:!0})],f.prototype,"view",void 0),f=(0,r._)([(0,h.$)("esri.views.support.GroundViewElevationSampler")],f);const y=f;let v=class extends s.default{constructor(e){super(e),this.view=null,this.layerViews=new n.default}initialize(){this.addHandles((0,a.when)((()=>this.view?.map?.ground),(e=>e.load()))),this.addHandles(this.layerViews.on("after-changes",(()=>this._layerViewsAfterChangesHandler())))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new y({view:this.view}):null:null}get extent(){const e=this.view;return e&&"2d"!==e.type&&e.ready?(0,c.w1)(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return this.view?.suspended??!0}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map((e=>(0,a.watch)((()=>e.updating),(()=>this._updateUpdating()),a.sync))).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};(0,r._)([(0,o.MZ)({readOnly:!0})],v.prototype,"elevationSampler",null),(0,r._)([(0,o.MZ)({readOnly:!0})],v.prototype,"extent",null),(0,r._)([(0,o.MZ)({type:Boolean,readOnly:!0})],v.prototype,"updating",null),(0,r._)([(0,o.MZ)({constructOnly:!0})],v.prototype,"view",void 0),(0,r._)([(0,o.MZ)({type:n.default,readOnly:!0})],v.prototype,"layerViews",void 0),(0,r._)([(0,o.MZ)({readOnly:!0})],v.prototype,"suspended",null),v=(0,r._)([(0,h.$)("esri.views.GroundView")],v);const b=v},4742:(e,t,i)=>{i.d(t,{CU:()=>l,EY:()=>c,Me:()=>o,P2:()=>m,SR:()=>a,cf:()=>d,hB:()=>p,nU:()=>_,sH:()=>h,yt:()=>u});var r=i(64682),s=i(90772),n=i(49386);const a=64,o=512,l=2.5,h=(0,r.$8)(r.pq/10),c=2,d=(0,s.vt)();n.n.WebMercatorAuxiliarySphere.getExtent(0,0,0,d);const u=(0,s.vt)([-180,-90,180,90]),p="Cannot extend surface to encompass all layers because it would result in too many root tiles.",m="Surface extent is too large for tile resolution at level 0.",_=4},5655:(e,t,i)=>{i.d(t,{S:()=>p,b:()=>d});var r=i(87752),s=i(10382),n=i(34927),a=i(4241),o=i(16878),l=i(94320),h=i(22131),c=i(8118);function d(){const e=new c.N5;return e.attributes.add(h.r.POSITION,"vec3"),e.attributes.add(h.r.COLOR,"vec4"),e.attributes.add(h.r.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new l.X("transform",((e,t)=>function(e,t){const i=24e-8;return(0,r.C)(u,t.camera.projectionMatrix),u[10]=i-1,u[11]=-1,u[14]=(i-2)*t.camera.near,(0,r.lw)(u,u,t.camera.viewMatrix),(0,r.lw)(u,u,e.modelMatrix)}(e,t))),new n.I("viewport",(e=>e.camera.fullViewport)),new a.U("pixelRatio",(e=>e.camera.pixelRatio))),e.vertex.main.add(o.H`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),e.fragment.main.add(o.H`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),e}const u=(0,s.vt)(),p=Object.freeze(Object.defineProperty({__proto__:null,build:d},Symbol.toStringTag,{value:"Module"}))},6579:(e,t,i)=>{i.d(t,{Cq:()=>c,Ee:()=>p,J1:()=>y,LF:()=>b,Me:()=>T,Mm:()=>m,Sz:()=>x,W4:()=>_,e_:()=>g,nD:()=>u,t_:()=>v,tr:()=>f,v7:()=>A,zJ:()=>d,zq:()=>w});var r=i(87436),s=i(5839),n=i(64682),a=i(92143),o=i(56612),l=i(84190),h=i(23224);function c(e,t,i){return e.units[t][i]}function d(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";return`${(0,h.ZV)(t,{minimumFractionDigits:r,maximumFractionDigits:r,signDisplay:t>0?"never":"exceptZero"})} ${c(e,i,s)}`}function u(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";return`${(0,h.ZV)(t,{minimumFractionDigits:r,maximumFractionDigits:r,signDisplay:"exceptZero"})} ${c(e,i,s)}`}function p(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.x0)(t,i);return d(e,(0,l.oU)(t,i,n),n,r,s)}function m(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.x0)(t,i);return u(e,(0,l.oU)(t,i,n),n,r,s)}function _(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.x$)(t,i);return d(e,(0,l.oU)(t,i,n),n,r,s)}function g(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.x$)(t,i);return u(e,(0,l.oU)(t,i,n),n,r,s)}function f(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.OU)(t,i);return d(e,(0,l.oU)(t,i,n),n,r,s)}function y(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.OU)(t,i);return u(e,(0,l.oU)(t,i,n),n,r,s)}function v(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.y7)(t,i);return d(e,(0,l.oU)(t,i,n),n,r,s)}function b(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.y7)(t,i);return u(e,(0,l.oU)(t,i,n),n,r,s)}function w(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.wv)(t,i);return d(e,(0,l.oU)(t,i,n),n,r,s)}function x(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"abbr";const n=(0,l.TL)(t,i);return d(e,(0,l.oU)(t,i,n),n,r,s)}const C=(e,t)=>({style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:t,minimumFractionDigits:t,signDisplay:e>0?"never":"exceptZero"});function T(e,t,i,r,n){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:s.ie,c=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],d=o.normalize((0,a.g2)((0,l.oU)(e,t,"degrees"),i,r),0,c);const u=C(d,n??2);return d=S(d,u),(0,h.ZV)(d,u)}const M=new Map;function S(e,t){const i=JSON.stringify(t);let r=M.get(i);return r||(r=new Intl.NumberFormat("en-US",t),M.set(i,r)),/^[-+]?360\.?0*\xb0?$/.test(r.format(e))?0:e}const R=["B","kB","MB","GB","TB"];function A(e,t){let i=0===(t=Math.round(t))?0:Math.floor(Math.log(t)/Math.log(r.u.KILOBYTES));i=(0,n.qE)(i,0,R.length-1);const s=(0,h.ZV)(t/r.u.KILOBYTES**i,{maximumFractionDigits:2});return(0,o.HC)(e.units.bytes[R[i]],{fileSize:s})}},6893:(e,t,i)=>{i.d(t,{C:()=>d,U:()=>c});var r=i(98080),s=i(24646),n=i(23311),a=i(61315),o=i(94409),l=i(16878),h=i(20783);class c extends h.Y{constructor(){super(...arguments),this.radii=(0,r.vt)(),this.heightParameters=(0,s.vt)()}}function d(e){e.uniforms.add(new a.G("radii",(e=>e.radii)),new o.E("heightParameters",(e=>e.heightParameters))),e.constants.add("scaleHeight","float",n.$O.scaleHeight*n.$O.atmosphereHeight),e.code.add(l.H`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.code.add(l.H`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.code.add(l.H`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)}},8696:(e,t,i)=>{i.d(t,{N:()=>h});var r=i(7951),s=i(93003),n=i(16434),a=i(29072),o=i(19416),l=i(12723);class h extends n.w{constructor(e,t){super(e,t,new s.$(a.a,(()=>i.e(73648).then(i.bind(i,73648)))))}initializePipeline(e){switch(e.blitMode){case o.d.None:case o.d.Depth:return(0,l.Ey)({colorWrite:l.kn});case o.d.Alpha:return(0,l.Ey)({blending:l.Ky,colorWrite:l.kn});default:(0,r.Xb)(e.blitMode);case o.d.PremultipliedAlpha:case o.d.COUNT:return(0,l.Ey)({blending:l.Os,colorWrite:l.kn})}}}},9452:(e,t,i)=>{i.d(t,{Gc:()=>l,RI:()=>c,Z4:()=>h,dk:()=>u,vr:()=>d});var r=i(16804),s=i(32006),n=i(89227),a=i(91102),o=i(1696);function l(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,a.vt)();return h(e,(0,r.WA)(t),i),(0,n.n)(i.direction,i.direction),i}function h(e,t,i){return c(e,e.screenToRender(t,(0,r.sc)(o.rq.get())),i)}function c(e,t,i){const a=(0,r.sc)((0,s.C)(o.rq.get(),t));if(a[2]=0,!e.unprojectFromRenderScreen(a,i.origin))return null;const l=(0,r.sc)((0,s.C)(o.rq.get(),t));l[2]=1;const h=e.unprojectFromRenderScreen(l,o.rq.get());return null==h?null:((0,n.d)(i.direction,h,i.origin),i)}function d(e,t,i){return u(e,e.screenToRender(t,(0,r.sc)(o.rq.get())),i)}function u(e,t,i){(0,n.c)(i.origin,e.eye);const r=(0,n.i)(o.rq.get(),t[0],t[1],1),s=e.unprojectFromRenderScreen(r,o.rq.get());return null==s?null:((0,n.d)(i.direction,s,i.origin),i)}},10323:(e,t,i)=>{i.d(t,{Aw:()=>h,Jb:()=>l,Q5:()=>u,W3:()=>p,d:()=>a,db:()=>d,kV:()=>c,rb:()=>o});var r=i(92453),s=i(15828),n=i(27464);class a extends s.R6{constructor(e,t,i,r){super(t,i),this.point=e,this.createGraphic=r}}function o(e){return(0,n.i3)(e)&&e.intersector===r.dz.PCL&&!!e.target}class l extends s.HE{constructor(e,t,i,r,s){super(e),this.layerUid=e,this.sublayerUid=t,this.nodeIndex=i,this.componentIndex=r,this.triangleNr=s}}class h extends s.R6{constructor(e,t,i){super(t,null),this.point=e,this.createVoxelGraphic=i}}class c extends s.R6{constructor(e,t){super(e,null),this.createTiles3DGraphic=t}}function d(e){return(0,n.i3)(e)&&e.intersector===r.dz.I3S&&!!e.target}function u(e){return(0,n.i3)(e)&&e.intersector===r.dz.VOXEL&&!!e.target}function p(e){return(0,n.i3)(e)&&e.intersector===r.dz.TILES3D&&!!e.target}},11443:(e,t,i)=>{i.d(t,{S:()=>R});var r=Math.PI,s=Math.sin,n=Math.cos,a=Math.tan,o=Math.asin,l=Math.atan2,h=Math.acos,c=r/180,d=864e5,u=2440588,p=2451545,m={dec:0,ra:0};function _(e){return new Date((e+.5-u)*d)}function g(e){return function(e){return e.valueOf()/d-.5+u}(e)-p}var f=23.4397*c;function y(e,t){return l(s(e)*n(f)-a(t)*s(f),n(e))}function v(e,t){return o(s(t)*n(f)+n(t)*s(f)*s(e))}function b(e,t,i){return l(s(e),n(e)*s(t)-a(i)*n(t))}function w(e,t,i){return o(s(t)*s(i)+n(t)*n(i)*n(e))}function x(e,t){return c*(280.16+360.9856235*e)-t}function C(e){return c*(357.5291+.98560028*e)}function T(e){return c*(1.9148*s(e)+.02*s(2*e)+3e-4*s(3*e))}function M(e,t){return e+t+102.9372*c+r}function S(e,t){var i=C(e),r=M(i,T(i));return t||(t={dec:0,ra:0}),t.dec=v(r,0),t.ra=y(r,0),t}var R={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,i,r){var s=c*-i,n=c*t,a=g(e),o=S(a,m),l=x(a,s)-o.ra;return r||(r={azimuth:0,altitude:0}),r.azimuth=b(l,n,o.dec),r.altitude=w(l,n,o.dec),r}},A=[[-.83,"sunrise","sunset"]];R.addTime=function(e,t,i){A.push([e,t,i])};var E=9e-4;function O(e,t){return Math.round(e-E-t/(2*r))}function P(e,t,i){return E+(e+t)/(2*r)+i}function D(e,t,i){return p+e+.0053*s(t)-.0069*s(2*i)}function I(e,t,i){return h((s(e)-s(t)*s(i))/(n(t)*n(i)))}function L(e){var t=c*(134.963+13.064993*e),i=c*(93.272+13.22935*e),r=c*(218.316+13.176396*e)+6.289*c*s(t),a=5.128*c*s(i),o=385001-20905*n(t);return{ra:y(r,a),dec:v(r,a),dist:o}}R.getTimes=function(e,t,i){var r=c*-i,a=c*t,o=O(g(e),r),l=P(0,r,o),h=C(l),d=T(h),u=M(h,d),p=v(u,0),m=D(l,h,u);function f(e){return D(P(I(e,a,p),r,o),h,u)}var y,b,w,x,S,E={solarNoon:_(m),nadir:_(m-.5),polarException:R.PolarException.NORMAL};for(y=0,b=A.length;y<b;y+=1)S=m-((x=f((w=A[y])[0]*c))-m),E[w[1]]=_(S),E[w[2]]=_(x);return E.polarException=function(e){var t=(s(e)-s(a)*s(p))/(n(a)*n(p));return t<-1?R.PolarException.MIDNIGHT_SUN:t>1?R.PolarException.POLAR_NIGHT:R.PolarException.NORMAL}(A[0][0]*c),E},R.getMoonPosition=function(e,t,i){var r=c*-i,s=c*t,n=g(e),o=L(n),l=x(n,r)-o.ra,h=w(l,s,o.dec);return h+=.017*c/a(h+10.26*c/(h+5.1*c)),{azimuth:b(l,s,o.dec),altitude:h,distance:o.dist}},R.getMoonFraction=function(e){var t=g(e),i=S(t),r=L(t),a=149598e3,o=h(s(i.dec)*s(r.dec)+n(i.dec)*n(r.dec)*n(i.ra-r.ra)),c=l(a*s(o),r.dist-a*n(o));return(1+n(c))/2}},12151:(e,t,i)=>{i.d(t,{H:()=>l,a:()=>c,b:()=>h});var r=i(37379),s=i(16878),n=i(67058),a=i(20783),o=i(8118);class l extends a.Y{}function h(){const e=new o.N5;return e.include(r.c),e.fragment.uniforms.add(new n.N("tex",(e=>e.texture))),e.fragment.main.add(s.H`fragColor = vec4(1.0 - texture(tex, uv).a);`),e}const c=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:l,build:h},Symbol.toStringTag,{value:"Module"}))},13303:(e,t,i)=>{i.r(t),i.d(t,{default:()=>c});var r,s=i(93800),n=i(58448),a=i(48602),o=(i(21265),i(50925),i(14746),i(75269)),l=i(63643);let h=r=class extends(n.A.EventedMixin(l.default)){constructor(e){super(e),this.cameraTrackingEnabled=!0}clone(){return new r({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(e){return new r(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};(0,s._)([(0,a.MZ)({type:Boolean})],h.prototype,"cameraTrackingEnabled",void 0),h=r=(0,s._)([(0,o.$)("esri.views.3d.environment.VirtualLighting")],h);const c=h},13767:(e,t,i)=>{i.d(t,{q:()=>a});var r=i(62631),s=i(58448),n=i(50552);class a extends s.A{constructor(){super(...arguments),this._transitionables=null,this._clips=null,this._fadeTransition=null,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get computedOpacity(){return this._fadeTransition?.computedOpacity??this.opacity}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get fadeTransitionEnabled(){return null!==this._fadeTransition}set fadeTransitionEnabled(e){!this._fadeTransition&&e?(this._fadeTransition=new n.A({opacity:this.opacity,visible:this.visible}),this.addTransitionable(this._fadeTransition)):this._fadeTransition&&!e&&(this.removeTransitionable(this._fadeTransition),this._fadeTransition=null)}get inFadeTransition(){return this._fadeTransition?.transitioning??!1}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this._fadeTransition&&(this._fadeTransition.opacity=this._opacity),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t?.trashDisplayObject(this)}get transforms(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}get transitioning(){return this.isTransitioning()}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._fadeTransition&&(this._fadeTransition.visible=this._visible),this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}addTransitionable(e){this._transitionables??=[],this._transitionables.push(e),this.requestRender()}removeTransitionable(e){e.endTransition(),this._transitionables&&(0,r.TF)(this._transitionables,e),this.requestRender()}fadeIn(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeIn();return this.opacity=1,this.requestRender(),e}fadeOut(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeOut();return this.opacity=0,this.requestRender(),e}endTransitions(){if(this._transitionables){for(const e of this._transitionables)e.endTransition();this.requestRender()}}beforeRender(e){this.transitionStep(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this.transitioning&&this.requestRender()}remove(){this.parent?.removeChild(this)}setTransform(e){}processRender(e){this.stage&&(this._fadeTransition?.computedVisible??this.visible)&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.endTransitions(),this.onDetach(),this.emit("detach")}isTransitioning(){return this._transitionables?.some((e=>e.transitioning))??!1}transitionStep(e,t){if(this._transitionables)for(const i of this._transitionables)i.transitionStep(e,t)}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}},15862:(e,t,i)=>{i.d(t,{u:()=>n});var r=i(49959),s=i(72538);async function n(e){const t=i.e(32512).then(i.bind(i,32512)),n=i.e(24968).then(i.bind(i,24968)),a=(0,s.D)((await t).default,{signal:e}),o=(0,s.D)((await n).default,{signal:e}),l={mask:await a,overlay:await o};return(0,r.throwIfAborted)(e),l}},16079:(e,t,i)=>{i.d(t,{G:()=>o});var r=i(29072),s=i(8696),n=i(19416),a=i(92156);class o{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.d.None;this._techniques=e,this._parameters=new r.C,this._configuration=new n.N,this._configuration.blitMode=t,e.precompile(s.N,this._configuration)}blit(e,t,i,r){e.bindFramebuffer(i.fbo),e.setClearColor(0,0,0,1),e.clear(a.NV.COLOR),this._parameters.texture=t.getTexture();const n=this._techniques.get(s.N,this._configuration);e.bindTechnique(n,r,this._parameters),e.screen.draw()}blend(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;this._configuration.hasOpacityFactor=n<1;const a=this._techniques.get(s.N,this._configuration);return!!a.compiled&&(e.bindFramebuffer(i.fbo),this._parameters.texture=t.getTexture(),this._parameters.opacity=n,e.bindTechnique(a,r,this._parameters),e.screen.draw(),!0)}}},16665:(e,t,i)=>{i.d(t,{PE:()=>p,Q7:()=>c,TD:()=>u});var r=i(69586),s=i(34289),n=i(9369),a=i(80861),o=i(92156),l=i(64177),h=i(77936);function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:p.Pos2,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:r.D,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const h=t===p.Pos2?new Float32Array([s,s,l,s,s,l,l,l]):new Float32Array([s,s,0,0,l,s,1,0,s,l,0,1,l,l,1,1]);return new n.Z(e,i,new Map([["geometry",m.get(t)]]),new Map([["geometry",a.g.createVertex(e,o._U.STATIC_DRAW,h)]]))}const d=4;function u(e){const t=new h.R(d);return t.samplingMode=o.Cj.NEAREST,new l.g(e,t)}var p;!function(e){e[e.Pos2=0]="Pos2",e[e.Pos2Tex=1]="Pos2Tex"}(p||(p={}));const m=new Map([[p.Pos2,s.lK],[p.Pos2Tex,s.u7]])},17569:(e,t,i)=>{i.r(t),i.d(t,{default:()=>w});var r=i(93800),s=i(19455),n=i(82301),a=i(50925),o=i(48602),l=(i(21265),i(75269)),h=i(87588),c=i(39584),d=i(48277),u=i(23682),p=i(63643),m=i(76845),_=i(99590);const g={base:m.default,key:"type",typeMap:{color:_.default}};const f={types:g,json:{read:function(e){return(t,i,r)=>{if(!t)return t;for(const s in e.typeMap)if(t.type===s){const i=new e.typeMap[s];return i.read(t,r),i}}}(g),write:{overridePolicy:(e,t,i)=>({enabled:!i?.isPresentation})}}};var y;const v=(e,t,i)=>({enabled:!i?.isPresentation});let b=y=class extends s.A{constructor(e){super(e),this.lighting=new u.default,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){(0,c.TJ)(e?.type,a.A.getLogger(this))&&this._set("weather",e)}clone(){return new y(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&"virtual"===this.lighting.type?p.default.prototype.clone.call(this.lighting):u.default.prototype.clone.call(this.lighting),background:(0,n.clone)(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};(0,r._)([(0,o.MZ)({types:d.S,nonNullable:!0,json:{write:!0}})],b.prototype,"lighting",void 0),(0,r._)([(0,o.MZ)(f)],b.prototype,"background",void 0),(0,r._)([(0,o.MZ)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:v}}})],b.prototype,"atmosphereEnabled",void 0),(0,r._)([(0,o.MZ)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:v}}})],b.prototype,"starsEnabled",void 0),(0,r._)([(0,o.MZ)({types:c.eM,nonNullable:!0,json:{write:!0},value:new h.default})],b.prototype,"weather",null),b=y=(0,r._)([(0,l.$)("esri.webscene.Environment")],b);const w=b},17977:(e,t,i)=>{i.d(t,{M:()=>a});var r=i(42403),s=i(16878),n=i(67058);function a(e){e.fragment.uniforms.add(new n.N("u_colormap",(e=>e.u_colormap)),new r.m("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new r.m("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new r.m("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(s.H`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}},18477:(e,t,i)=>{i.d(t,{E:()=>r});class r{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t)}}},18484:(e,t,i)=>{i.d(t,{F:()=>a,L:()=>r});var r,s=i(93800),n=i(21484);!function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends n.K{constructor(){super(...arguments),this.mode=r.Full}}(0,s._)([(0,n.W)({count:r.COUNT})],a.prototype,"mode",void 0)},18560:(e,t,i)=>{i.d(t,{p:()=>a});var r=i(89227),s=i(90030),n=i(28473);class a{constructor(e){this._low=(0,n.vt)(),this._high=(0,n.vt)(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){(0,r.c)(this._low,(0,r.c)(o,e));const t=(0,r.a)(o,e,this._low);(0,r.c)(this._high,t)}get(e){return(0,r.g)(e,this._low,this._high)}getLowScaled(e){return(0,r.h)(e,this._low,1)}}const o=(0,s.vt)()},18683:(e,t,i)=>{i.d(t,{n:()=>r,u:()=>o});var r,s=i(21265),n=i(57942),a=i(16345);function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!(0,s.A)("disable-feature:high-quality-idle"),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=new n.O;return e?(i.set(a.M.IDLE,r.Antialiasing,"low"!==t),i.set(a.M.IDLE,r.HighResolutionAtmosphere,"low"!==t),i.set(a.M.IDLE,r.HighQualityTransparency,!0),i.set(a.M.IDLE,r.SSAO,!0),i.set(a.M.IDLE,r.WaterReflection,!0),i.set(a.M.IDLE,r.PhysicalPixelRendering,!0)):(i.set(a.M.ANIMATING,r.HighResolutionShadows,!0),i.set(a.M.ANIMATING,r.HighResolutionViewshed,!0),i.set(a.M.INTERACTING,r.HighResolutionShadows,!0),i.set(a.M.INTERACTING,r.HighResolutionViewshed,!0)),i.set(a.M.IDLE,r.HighResolutionShadows,!0),i.set(a.M.IDLE,r.HighResolutionViewshed,!0),i.set(a.M.IDLE,r.HighResolutionVoxel,!0),i}!function(e){e[e.Antialiasing=0]="Antialiasing",e[e.HighQualityTransparency=1]="HighQualityTransparency",e[e.HighResolutionVoxel=2]="HighResolutionVoxel",e[e.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",e[e.SSAO=4]="SSAO",e[e.WaterReflection=5]="WaterReflection",e[e.HighResolutionShadows=6]="HighResolutionShadows",e[e.HighResolutionViewshed=7]="HighResolutionViewshed",e[e.PhysicalPixelRendering=8]="PhysicalPixelRendering"}(r||(r={}))},19151:(e,t,i)=>{i.d(t,{A:()=>c});class r{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}}var s=i(76517),n=i(92156),a=i(64177),o=i(77936);class l{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new o.R(this.textureWidth,1);i.samplingMode=n.Cj.NEAREST,i.wrapMode=n.pF.CLAMP_TO_EDGE,this._texture=new a.g(this._rctx,i),this._data=new s.XP(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,r,s,n){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,r),this._data.set(a,2,s),this._data.set(a,3,n)}setDataElement(e,t,i,r){const s=e*this._fieldCount+t;this._dirty=!0,this._data.set(s,i,r)}getDataElement(e,t,i){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const e=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new s.XP(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}}class h{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.textureBuffer=new l(e,t),this._indexManager=new r(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}}class c{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this._buffers.forEach((e=>e.dispose())),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>65536)return null;const t=new h(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}}},19416:(e,t,i)=>{i.d(t,{N:()=>a,d:()=>r});var r,s=i(93800),n=i(21484);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.Depth=3]="Depth",e[e.COUNT=4]="COUNT"}(r||(r={}));class a extends n.K{constructor(){super(...arguments),this.blitMode=r.None,this.hasOpacityFactor=!1}}(0,s._)([(0,n.W)({count:r.COUNT})],a.prototype,"blitMode",void 0),(0,s._)([(0,n.W)()],a.prototype,"hasOpacityFactor",void 0)},19752:(e,t,i)=>{i.d(t,{C:()=>y,R:()=>x,a:()=>v,b:()=>b,c:()=>w});var r=i(28473),s=i(73795),n=i(17977),a=i(90373),o=i(36781),l=i(57197),h=i(66652),c=i(3581),d=i(61315),u=i(42403),p=i(74802),m=i(16878),_=i(7683),g=i(67058),f=i(8118);class y extends a.p{constructor(e,t,i,s,n,a){super(e,s,n),this.colormap=t,this.symbolizer=i,this.u_colormap=a,this.backgroundColor=r.uY,this.fboTexture=null,this.baseOpacity=1}}class v extends y{}class b extends y{}function w(e){const t=new f.N5;return t.include(l.W),t.include(a.y,e),t.include(n.M,e),t.include(o.P,e),t.fragment.code.add(m.H`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),e.colorizerType===s.T.Stretch?function(e,t){e.fragment.uniforms.add(new _.c("u_bandCount",(e=>e.symbolizer.u_bandCount)),new p.x("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new p.x("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new p.x("u_factor",(e=>e.symbolizer.u_factor),3),new u.m("u_minOutput",(e=>e.symbolizer.u_minOutput)),new u.m("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new c.e("u_useGamma",(e=>e.symbolizer.u_useGamma)),new p.x("u_gamma",(e=>e.symbolizer.u_gamma),3),new p.x("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new u.m("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(m.H`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?m.H`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:m.H`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.main.add(m.H`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${t.stretchType===s.M.Noop?m.H`fragColor = applyBackgroundBlend(currentPixel);`:m.H`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${i}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}(t,e):e.colorizerType===s.T.Lut?function(e){e.fragment.main.add(m.H`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}(t):e.colorizerType===s.T.Hillshade&&function(e,t){const i=e.fragment;i.uniforms.add(new g.N("u_image",(e=>e.u_image)),new _.c("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new p.x("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new p.x("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new p.x("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new p.x("u_weights",(e=>e.symbolizer.u_weights),6),new d.G("u_factor",(e=>e.symbolizer.u_factor)),new u.m("u_minValue",(e=>e.symbolizer.u_minValue)),new u.m("u_maxValue",(e=>e.symbolizer.u_maxValue)),new d.G("u_srcImageSize",(e=>e.common.u_srcImageSize))),i.include(h.a),i.code.add(m.H`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),i.code.add(m.H`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=t.applyColormap?m.H`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:m.H`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.main.add(m.H`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}`)}(t,e),t}const x=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:b,ColorizerStretchUniforms:v,ColorizerUniforms:y,build:w},Symbol.toStringTag,{value:"Module"}))},21628:(e,t,i)=>{i.d(t,{E:()=>c,b:()=>h});var r=i(37379),s=i(16878),n=i(67058),a=i(8118);const o=.05,l=2;function h(){const e=new a.N5;return e.include(r.c),e.outputs.add("fragEdges","vec2"),e.fragment.code.add(s.H`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),e.fragment.uniforms.add(new n.N("colorTexture",(e=>e.color))).main.add(s.H`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${s.H.float(o)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${s.H.float(l)}) * delta);
    }
  `),e}const c=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},22301:(e,t,i)=>{i.d(t,{B:()=>l,b:()=>o});var r=i(37379),s=i(16878),n=i(67058),a=i(8118);function o(){const e=new a.N5;return e.include(r.c),e.fragment.uniforms.add(new n.N("blendWeightsTexture",(e=>e.inputTexture)),new n.N("colorTexture",(e=>e.color))),e.fragment.main.add(s.H`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},22682:(e,t,i)=>{i.d(t,{H:()=>r,w:()=>s});class r{constructor(e,t){this.key=e,this.free=t,this.incarnation=0,this._refCount=1}retain(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._refCount+=e}release(){return 0===this._refCount?(console.log(`Releasing already released FBO attachment "${this.name}" in ${(new Error).stack}`),!0):(--this._refCount,0===this._refCount&&(this.free(),!0))}}var s;!function(e){e[e.FBO=0]="FBO",e[e.DEPTH=1]="DEPTH",e[e.COLOR=2]="COLOR"}(s||(s={}))},23193:(e,t,i)=>{var r;i.d(t,{Q:()=>r}),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(r||(r={}))},23521:(e,t,i)=>{i.d(t,{t:()=>r});class r{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}},23682:(e,t,i)=>{i.r(t),i.d(t,{default:()=>d});var r,s=i(93800),n=i(19455),a=i(48602),o=(i(21265),i(50925),i(14746),i(14800)),l=i(75269),h=i(15484);let c=r=class extends n.A{constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e)}clone(){return new r(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};(0,s._)([(0,a.MZ)({readOnly:!0,type:["sun"],json:{write:!0}})],c.prototype,"type",void 0),(0,s._)([(0,a.MZ)({type:Date,json:{type:Number,write:{target:"datetime"}}})],c.prototype,"date",void 0),(0,s._)([(0,o.w)("date",["datetime"])],c.prototype,"readDate",null),(0,s._)([(0,h.K)("date")],c.prototype,"writeDate",null),(0,s._)([(0,a.MZ)({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],c.prototype,"directShadowsEnabled",void 0),(0,s._)([(0,o.w)("directShadowsEnabled",["directShadows"])],c.prototype,"readDirectShadowsEnabled",null),(0,s._)([(0,h.K)("directShadowsEnabled")],c.prototype,"writedirectShadowsEnabled",null),(0,s._)([(0,a.MZ)({type:Number,json:{write:!0}})],c.prototype,"displayUTCOffset",void 0),(0,s._)([(0,h.K)("displayUTCOffset")],c.prototype,"writeDisplayUTCOffset",null),c=r=(0,s._)([(0,l.$)("esri.webscene.SunLighting")],c);const d=c},24132:(e,t,i)=>{function r(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i;const s=t.length/r;let n=0,a=0;for(let o=0;o<s;++o)e[n]=t[a],e[n+1]=t[a+1],e[n+2]=t[a+2],n+=i,a+=r}function s(e,t,i,r,s){const n=e.typedBuffer,a=e.typedBufferStride,o=s?.count??e.count;let l=(s?.dstIndex??0)*a;for(let h=0;h<o;++h)n[l]=t,n[l+1]=i,n[l+2]=r,l+=a}i.d(t,{c:()=>r,f:()=>s});Object.freeze(Object.defineProperty({__proto__:null,copy:r,copyView:function(e,t){r(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)},fill:s},Symbol.toStringTag,{value:"Module"}))},24344:(e,t,i)=>{i.d(t,{$:()=>o,d:()=>r});var r,s=i(93800),n=i(21484),a=i(51448);!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(r||(r={}));class o extends a.E{constructor(){super(...arguments),this.geometry=r.Cone}}(0,s._)([(0,n.W)({count:r.COUNT})],o.prototype,"geometry",void 0)},26204:(e,t,i)=>{i.d(t,{GW:()=>g,IU:()=>b,Jo:()=>a,MG:()=>n,Wh:()=>u,cP:()=>T,os:()=>c,p6:()=>_,pJ:()=>o,ru:()=>x,s3:()=>w,w4:()=>C,wV:()=>m,yM:()=>M,z0:()=>p});var r=i(53053),s=i(64855);const n=Number.POSITIVE_INFINITY,a=Math.PI,o=2*a,l=128/a,h=256/360,c=a/180,d=1/Math.LN2;function u(e,t){return(e%=t)>=0?e:e+t}function p(e){return u(e*l,256)}function m(e){return u(e*h,256)}function _(e){return Math.log(e)*d}function g(e,t,i){return e*(1-i)+t*i}const f=8,y=14,v=16;function b(e){return f+Math.max((e-y)*v,0)}function w(e,t,i){let r,s,n,a=0;for(const o of i){r=o.length;for(let i=1;i<r;++i)s=o[i-1],n=o[i],s.y>t!=n.y>t&&((n.x-s.x)*(t-s.y)-(n.y-s.y)*(e-s.x)>0?a++:a--)}return 0!==a}function x(e,t,i,s){let n,a,o,l;const h=s*s;for(const c of i){const i=c.length;if(!(i<2)){n=c[0].x,a=c[0].y;for(let s=1;s<i;++s){if(o=c[s].x,l=c[s].y,(0,r.Ng)(e,t,n,a,o,l)<h)return!0;n=o,a=l}}}return!1}function C(e,t,i,r,s,n,a){const o=Math.max(r,Math.min(t,n))-t,l=Math.max(s,Math.min(i,a))-i;return o*o+l*l<=e*e}function T(e,t){if(0===t||Number.isNaN(t))return e;const i=[],r=new s.bR(0,0),n=new s.bR(0,0),a=new s.bR(0,0);for(let o=0;o<e.length;o++){const l=e[o],h=[];for(let e=0;e<l.length;e++){const i=l[e-1],o=l[e],c=l[e+1];0===e?r.setCoords(0,0):r.assignSub(o,i).normalize().rightPerpendicular(),e===l.length-1?n.setCoords(0,0):n.assignSub(c,o).normalize().rightPerpendicular(),a.assignAdd(r,n).normalize();const d=a.x*n.x+a.y*n.y;0!==d&&a.scale(1/d),h.push(s.bR.add(o,a.scale(t)))}i.push(h)}return i}function M(e,t,i,r){const n=new s.bR(e[0],e[1]);if(n.scale(r),"viewport"===t){const e=-i*(Math.PI/180),t=Math.cos(e),r=Math.sin(e);n.rotate(t,r)}return n}},26282:(e,t,i)=>{var r;i.d(t,{N:()=>r}),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(r||(r={}))},26903:(e,t,i)=>{i.d(t,{Al:()=>h,NZ:()=>c,Vb:()=>s,af:()=>d,rK:()=>u});var r=i(32195);const s="arial-unicode-ms",n="woff2",a=new Map,o=new Set;class l{constructor(e,t){this.fontFace=e,this.promise=t}}async function h(e){const t=p(e),i=u(e),s=a.get(t);if(s)return s.promise;const h=new FontFace(e.family,`url('${r.default.fontsUrl}/woff2/${i}.${n}') format('${n}')`,{style:e.style,weight:e.weight}),c=document.fonts;if(c.has(h)&&"loading"===h.status)return h.loaded;const d=h.load().then((()=>(c.add(h),h)));return a.set(t,new l(h,d)),o.add(h),d}function c(e){return o.has(e)}function d(e){if(!e)return s;const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function u(e){const t=m(e)+_(e);return d(e.family)+(t.length>0?t:"-regular")}function p(e){const t=m(e)+_(e);return(e.family||s)+(t.length>0?t:"-regular")}function m(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function _(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}},28515:(e,t,i)=>{i.d(t,{E$:()=>T,Gs:()=>O,Jq:()=>M,PX:()=>A,Sj:()=>g,U9:()=>E,US:()=>C,Ui:()=>w,Z7:()=>m,b:()=>p,jI:()=>v,lt:()=>x,oJ:()=>y,vf:()=>b,vt:()=>u,xW:()=>S});var r=i(87752),s=i(89227),n=i(28473),a=i(30142),o=i(93321),l=i(54671),h=i(91345),c=i(25071),d=i(89476);function u(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function p(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function m(e,t){return e.operations.getExtent(e.value,t),t}function _(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return{operations:e,value:e.create()}}(e);return i.operations=e,e.copy(t,i.value),i}function g(e){return _(d.s,(0,d.f)(0,0,0,(0,a.tO)(e).radius))}const f=2**50;function y(){return _(c.b,(0,c.f)([0,0,0],[f,0,0],[0,f,0]))}function v(e,t,i){return e.operations.axisAt(e.value,t,h._.Z,i)}function b(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}function w(e,t,i){return e.operations.intersectRay(e.value,t,i)}function x(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function C(e,t){return e.operations.altitudeAt(e.value,t)}function T(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function M(e,t,i,n){return t!==n&&(0,r.C)(n,t),(0,s.i)(R,n[12],n[13],n[14]),T(e,R,i,R),n[12]=R[0],n[13]=R[1],n[14]=R[2],n}function S(e,t,i){return e.operations.elevate(e.value,t,i.value)}const R=(0,n.vt)();function A(e,t,i,r,n){return n[0]=(0,s.f)(e,t),n[1]=(0,s.f)(e,i),n[2]=(0,s.f)(e,r),n}function E(e,t,i,r,n){(0,s.c)(i,e),(0,s.c)(P,t),(0,s.n)(P,P),(0,s.e)(r,P,i),(0,s.e)(n,r,i)}function O(e,t){return e?(0,l.lO)(t):t.isGeographic?o.default.PlateCarree:t}const P=(0,n.vt)()},29026:(e,t,i)=>{i.d(t,{t:()=>s});var r=i(16878);function s(e){e.code.add(r.H`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)}},29072:(e,t,i)=>{i.d(t,{C:()=>p,a:()=>_,b:()=>m});var r=i(37379),s=i(33273),n=i(42162),a=i(15025),o=i(42403),l=i(16878),h=i(67058),c=i(19416),d=i(20783),u=i(8118);class p extends d.Y{constructor(){super(...arguments),this.opacity=1}}function m(e){const t=new u.N5;t.include(r.c),t.fragment.uniforms.add(new h.N("tex",(e=>e.texture))),e.hasOpacityFactor&&t.fragment.uniforms.add(new o.m("opacity",(e=>e.opacity)));const i=e.blitMode===c.d.Depth;return i&&(t.fragment.uniforms.add(new a.E("nearFar",(e=>e.camera.nearFar))),t.fragment.include(s.E),t.fragment.include(n.W)),t.fragment.main.add(l.H`
    ${i?l.H`
          float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
          fragColor = float2rgba(normalizedLinearDepth);`:l.H`
          fragColor = texture(tex, uv) ${e.hasOpacityFactor?"* opacity":""};`}`),t}const _=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:p,build:m},Symbol.toStringTag,{value:"Module"}))},29094:(e,t,i)=>{i.d(t,{z:()=>s});var r=i(16878);function s(e){e.code.add(r.H`
    float lineFactorAtPosition(float value) {
      float pos = value * ${r.H.float(257)};
      if(pos < 0.5 || pos > ${r.H.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}},29471:(e,t,i)=>{i.d(t,{O:()=>s});var r=i(16878);function s(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(r.H`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(r.H`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(r.H`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}},30179:(e,t,i)=>{i.d(t,{e:()=>n,q:()=>s});var r=i(44480);class s{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;this.internalFormat=e,this.width=t,this.height=i,this.multisampled=!1,this.samples=1}}function n(e){return e.width<=0||e.height<=0||null==e.internalFormat?0:e.width*e.height*(0,r.IB)(e.internalFormat)}},30466:(e,t,i)=>{i.d(t,{I:()=>a,_:()=>o});var r=i(74719),s=(i(21265),i(57942)),n=i(21484);class a{constructor(e){this.context=e,this._debug=!1,this._precompiling=this._debug?0:1,this._cache=new s.O}get precompiling(){return this._precompiling}set precompiling(e){this._precompiling=e,0===e&&this.context.rctx.gl.flush()}get viewingMode(){return this.context.viewingMode}destroy(){this._cache.forAll((e=>e.destroy())),this._cache.clear()}precompile(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o;++this.precompiling,this.get(e,t),--this.precompiling}get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o;const i=t.key.code;let s=this._cache.get(e,i);if(null==s){if(0===this._precompiling){let i=`Uncached shader compile in ${(new Error).stack}\n  for configuration\n${t.decode()}`;const s=this._cache.getInner(e);throw s?.size&&(i+="\n\n  cached configurations:\n",i+=Array.from(s.values()).map((e=>t.decode(e.key))).sort().join("\n\n")),console.log(i),new r.default(i)}s=new e(this.context,t),this._cache.set(e,i,s)}return s}async reloadAll(){const e=new Array;this._cache.forEach((t=>e.push(async function(e){let t=!0;e.forEach((async e=>{await e.reload(t),t=!1}))}(t)))),await Promise.all(e)}}const o=new n.K},31129:(e,t,i)=>{i.d(t,{_:()=>s});var r=i(17741);class s{constructor(){this._result=!1}dispose(){this._program=(0,r.WD)(this._program)}get result(){return null!=this._program&&(this._result=this._test(this._program),this.dispose()),this._result}}},31143:(e,t,i)=>{i.d(t,{S:()=>s,b:()=>r});const r={value:.5,readOnly:!0},s={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}}},32704:(e,t,i)=>{i.r(t),i.d(t,{default:()=>h});var r=i(45622),s=i(17741),n=i(3115),a=i(45192);var o=i(22682),l=i(92156);class h extends o.H{constructor(e,t,i,r,s,a){super(e,a),this.type=o.w.FBO,this._colors=new Map,this._name=n.RenderCategory.COMPOSITE,this.acquireDepth=null,this.acquireColor=null,this._name=t,this.fbo=i,this.acquireDepth=r,this.acquireColor=s}dispose(){this.fbo?.dispose()}get cachedMemory(){return this.fbo?.usedMemory||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.Nm.COLOR_ATTACHMENT0;return e===l.nI?this.fbo?.depthStencilTexture:this.fbo?.getColorTexture(e)}getAttachment(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.Nm.COLOR_ATTACHMENT0;return e===l.nI?this._depth:this._colors.get(e)}hasAttachment(e){return(0,r.Bs)(this._colors,(t=>t.name===e))}attachDepth(e){return e?.retain(),this.detachDepth(),e&&this.fbo?.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo?.detachDepthStencilTexture(),this.fbo?.detachDepthStencilBuffer(),this._depth=(0,s.Gz)(this._depth)}obtainDepthTexture(){const e=this._depth;return function(e){return e?.attachment.type===a.p.Texture}(e)?(this.fbo?.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo?.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo?.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t?.release()}detachAll(){this._colors.forEach(((e,t)=>this.detachColor(t))),this.detachDepth()}}},34360:(e,t,i)=>{i.d(t,{P:()=>n});var r=i(28473),s=i(8375);class n extends s.gy{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,r.vt)();super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}},36781:(e,t,i)=>{i.d(t,{P:()=>m});i(28473);var r=i(45979),s=i(29094),n=i(23193),a=i(65180),o=i(2799),l=i(16878);function h(e,t){const i=t.blendMode;i!==r.IU.Normal&&(i===r.IU.Reflect&&e.code.add(l.H`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),i!==r.IU.ColorDodge&&i!==r.IU.VividLight||e.code.add(l.H`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),i!==r.IU.ColorBurn&&i!==r.IU.VividLight||e.code.add(l.H`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),i===r.IU.Overlay&&e.code.add(l.H`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),i===r.IU.HardLight&&e.code.add(l.H`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),i===r.IU.SoftLight&&e.code.add(l.H`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),i===r.IU.VividLight&&e.code.add(l.H`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),i!==r.IU.Hue&&i!==r.IU.Saturation&&i!==r.IU.Color&&i!==r.IU.Luminosity||(e.code.add(l.H`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),i!==r.IU.Hue&&i!==r.IU.Saturation||e.code.add(l.H`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(l.H`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${i===r.IU.Multiply?l.H`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Average?l.H`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Lighten?l.H`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Darken?l.H`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Lighter?l.H`return vec4(cl * ol + cb * ob, ol + ob);`:i===r.IU.Plus?l.H`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:i===r.IU.Minus?l.H`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:i===r.IU.Screen?l.H`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Difference?l.H`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Invert?l.H`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:i===r.IU.DestinationOver?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:i===r.IU.DestinationAtop?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:i===r.IU.DestinationOut?l.H`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:i===r.IU.SourceAtop?l.H`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:i===r.IU.SourceOut?l.H`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:i===r.IU.Xor?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:i===r.IU.DestinationIn?l.H`return vec4(cb * ob * ol, ol * ob);`:i===r.IU.SourceIn?l.H`return vec4(cl * ol * ob, ol * ob);`:i===r.IU.Hue?l.H`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Saturation?l.H`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Color?l.H`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Luminosity?l.H`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Exclusion?l.H`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Reflect?l.H`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.ColorDodge?l.H`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.ColorBurn?l.H`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.Overlay?l.H`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.SoftLight?l.H`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.HardLight?l.H`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.IU.VividLight?l.H`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:l.H``}
    }
  `))}var c=i(57554),d=i(42403),u=i(67058),p=i(20783);p.Y;function m(e,t){const i=t.output===a.x.GridComposite,p=t.output===a.x.ColorComposite,m=t.output===a.x.GroupBackgroundComposite,_=t.output===a.x.Composite,g=t.baseOpacityMode===n.Q.Required,f=e.fragment;g&&f.uniforms.add(new d.m("baseOpacity",(e=>e.baseOpacity))),i?f.include(s.z):p?f.uniforms.add(new c.t("backgroundColor",(e=>e.backgroundColor))):_&&f.uniforms.add(new u.N("fboColor",(e=>e.fboTexture)));const y=t.blendMode!==r.IU.Normal,v=t.premultipliedSource===o.g.On,b=!y&&!v&&(_&&!g||m);f.include(h,t),f.code.add(l.H`
    vec4 getBackground(vec2 uv) {
      return ${g?l.H`baseOpacity *`:""} ${m?l.H`vec4(0.0, 0.0, 0.0, 0.0)`:p?l.H`vec4(backgroundColor, 1.0)`:i?l.H`vec4(gridColor(uv), 1.0)`:l.H`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${y?l.H`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:l.H`
          float composeAlpha = colorLayer.a * opacity;
          ${b?l.H`return colorLayer * opacity;`:l.H`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}},37858:(e,t,i)=>{i.d(t,{yL:()=>j,_y:()=>z,T7:()=>w,L8:()=>y,Tn:()=>b,aL:()=>v,EM:()=>q,Uo:()=>G,GH:()=>x,KE:()=>O,sZ:()=>J,oX:()=>A,Gk:()=>E,rI:()=>H,n9:()=>T,fe:()=>I,LC:()=>P,uK:()=>te,HF:()=>X,Ci:()=>C,mJ:()=>ee,eS:()=>D,E5:()=>N,G3:()=>S,Y4:()=>F,cU:()=>L,Ec:()=>K,hL:()=>Y,xl:()=>W,XQ:()=>re,Rz:()=>ie,jj:()=>$,JM:()=>Q,n8:()=>V,t6:()=>B,Cs:()=>U,hC:()=>Z,bA:()=>k,bk:()=>f});var r=i(89129),s=i(70576),n=i(78076),a=i(51064),o=i(26282),l=i(98697),h=i(74719),c=i(90772),d=i(61129),u=i(4742),p=i(49386);const m=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,i,r){if(null==e)return(0,p.P)();const s=e.spatialReference;if(s.isGeographic&&!(0,d.s)(s))return new h.default("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const n=p.n.checkUnsupported(e);if(null!=n)return n;if(null==i)return new h.default("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const a=function(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,s=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],a=(0,c.VY)(t),o=(0,c.vt)();p.n.computeRowColExtent(a,s,n,o);const l=(o[2]-o[0])*(o[3]-o[1]);if(l>u.SR){const t=i[0].scale*2**i[0].level;let s=Math.max((a[3]-a[1])/e.size[1],(a[2]-a[0])/e.size[0])*t/r;const n=Math.floor(Math.log(s)/Math.log(10));return s=Math.ceil(s/10**n)*10**n,new h.default("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+s.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:s,requiredNumRootTiles:l,allowedNumRootTiles:u.SR})}return null}(e,i);return a||(null==t||s.equals(t)||t.isWGS84&&s.isWebMercator?null:new h.default("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))}},Symbol.toStringTag,{value:"Module"}));const _=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,i,r){if(null==e)return(0,p.P)();const s=e?.lods.length-1,n=e.spatialReference;if(n.isWebMercator){if(!p.n.makeWebMercatorAuxiliarySphere(s).compatibleWith(e,r))return new h.default("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!(0,d.C)(n))return new h.default("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!p.n.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e,r))return e.spatialReference.isWGS84?new h.default("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new h.default("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==t||e.spatialReference.equals(t)?null:new h.default("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}},Symbol.toStringTag,{value:"Module"})),g={[a.RT.Global]:_,[a.RT.Local]:m};function f(e,t){e||console.warn("Terrain: "+t)}let y=!1,v=!1;function b(e){v=e,y=y||e}function w(e){y=e}function x(e,t){if(y&&!e){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function C(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function T(e){return"imagery-tile-3d"===e?.type}function M(e){return"tile-3d"===e?.type}function S(e){return"vector-tile-3d"===e?.type}function R(e){return"wmts-3d"===e?.type}function A(e){return"elevation-3d"===e?.type}function E(e){return"group"===e?.type}function O(e){return e&&(M(e)||R(e)||T(e)||S(e))}function P(e){return e&&(M(e)||T(e)||S(e)||R(e))}function D(e){return P(e)||A(e)}function I(e){return(0,l.k$)(e?.sourceLayerInfo?.data)}function L(e){return F(e?.sourceLayerInfo)||!!e?.isVTLBackground}function N(e){return(0,l.Cs)(e?.sourceLayerInfo?.data)}function H(e){const t=e?.sourceLayerInfo?.data;return(0,l.EM)(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData}function F(e){return(0,l.kC)(e?.data)}function V(e){return null!=e&&"release"in e&&e.release(),null}function U(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function z(e,t,i,r,s){return g[r].checkIfTileInfoSupportedForViewSR(e,i,t,s)}function G(e,t,i){let r=null,s=null;if("wmts"===e?.type){const n=q(e,t,i);r=n.tileInfo,s=n.fullExtent}else{s=C(e)?e.getCompatibleFullExtent(t):e.fullExtent;const n=i===a.RT.Local;r=C(e)?e.getCompatibleTileInfo(t,s,n):"vector-tile"===e?.type?n&&!k(t)||B.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}const n="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return null!=r&&null!=s&&null==z(r,s,t,i,n)?{tileInfo:r,fullExtent:s}:null}function q(e,t,i){const s=(0,n.r0)(e);if(null!=s){if(!r.default.isCollection(s))return{tileInfo:s.tileInfo,fullExtent:s.fullExtent};{const e=s.find((e=>null==z(e.tileInfo,e.fullExtent,t,i)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function k(e){return e.isWGS84||e.isWebMercator||(0,s.x1)(e)||!(0,s.B3)(e)}const B={force512VTL:!1};function W(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function Z(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function j(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:se;return Math.abs(e-t)<i}function $(e){return e===o.N.NORTH_EAST?o.N.SOUTH_WEST:e===o.N.NORTH_WEST?o.N.SOUTH_EAST:e===o.N.SOUTH_WEST?o.N.NORTH_EAST:o.N.NORTH_WEST}function Q(e){return e===o.N.NORTH?o.N.SOUTH:e===o.N.EAST?o.N.WEST:e===o.N.SOUTH?o.N.NORTH:o.N.EAST}function Y(e){return e===o.N.NORTH_WEST||e===o.N.SOUTH_WEST}function X(e){return e===o.N.NORTH_WEST||e===o.N.NORTH_EAST}function K(e){return e===o.N.NORTH_WEST||e===o.N.WEST||e===o.N.SOUTH_WEST}function J(e){return e===o.N.NORTH_EAST||e===o.N.EAST||e===o.N.SOUTH_EAST}function ee(e){return e===o.N.SOUTH_EAST||e===o.N.SOUTH||e===o.N.SOUTH_WEST}function te(e){return e===o.N.NORTH_EAST||e===o.N.NORTH||e===o.N.NORTH_WEST}const ie=[o.N.NORTH,o.N.EAST,o.N.SOUTH,o.N.WEST],re=[o.N.NORTH_EAST,o.N.SOUTH_EAST,o.N.SOUTH_WEST,o.N.NORTH_WEST],se=1e-5},38275:(e,t,i)=>{i.d(t,{O:()=>l,a:()=>c,b:()=>h});var r=i(37379),s=i(16878),n=i(67058),a=i(20783),o=i(8118);class l extends a.Y{}function h(e){const t=new o.N5;t.include(r.c);const i=e.hasEmission,a=t.fragment;return a.uniforms.add(new n.N("colorTexture",(e=>e.colorTexture)),new n.N("alphaTexture",(e=>e.alphaTexture)),new n.N("frontFaceTexture",(e=>e.frontFaceTexture))),t.outputs.add("fragColor","vec4",0),i&&(t.outputs.add("fragEmission","vec4",1),a.uniforms.add(new n.N("emissionTexture",(e=>e.emissionTexture))),a.uniforms.add(new n.N("emissionFrontFaceTexture",(e=>e.emissionFrontFaceTexture)))),a.main.add(s.H`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);

      vec4 transparentColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);
      fragColor = transparentColor;

      ${(0,s.If)(i,"vec4 emission = texture(emissionTexture, uv);\n         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);\n        fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), emissionFrontFace.a);")}
    `),t}const c=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:l,build:h},Symbol.toStringTag,{value:"Module"}))},39635:(e,t,i)=>{i.d(t,{P:()=>a});var r=i(64682),s=i(88664),n=i(23521);class a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=r,this.enabled=!0,this.value=new s.S(.8),this.time=new s.S(.3)}add(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,r.qE)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,i){return new n.t(e,t,i)}}},42072:(e,t,i)=>{i.d(t,{E:()=>l});var r=i(96236),s=i(99424),n=i(16878),a=i(81775),o=i(71723);function l(e,t){const i=t.hasColorTexture&&((0,r.RN)(t.output)||t.alphaDiscardMode!==o.sf.Opaque);i&&(e.include(s.r,t),e.fragment.uniforms.add(new a.o("baseColorTexture",(e=>e.texture)))),e.fragment.code.add(n.H`
    vec4 readBaseColorTexture() {
      return ${i?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)}},43444:(e,t,i)=>{i.d(t,{S:()=>S,b:()=>x});var r=i(87752),s=i(10382),n=i(89227),a=i(28473),o=i(43770),l=i(37379),h=i(53769),c=i(42162),d=i(87824),u=i(94409),p=i(42403),m=i(16878),_=i(38950),g=i(73712),f=i(67058),y=i(45917),v=i(72678),b=i(8118);const w=.025;function x(){const e=new b.N5;e.include(h.G,M),e.include(l.c),e.include(o.r);const t=e.fragment;return t.include(c.W),t.uniforms.add(new g.x("defaultDepthTex",(e=>e.shadowMap.getSnapshot(y.z.ExcludeHighlight))),new g.x("highlightDepthTex",(e=>e.shadowMap.getSnapshot(y.z.Highlight))),new g.x("depthMap",(e=>e.depth?.attachment)),new f.N("highlightTexture",(e=>e.highlight)),new u.E("uColor",(e=>e.shadowColor)),new p.m("opacity",(e=>e.shadowOpacity)),new p.m("occludedOpacity",(e=>e.occludedShadowOpacity)),new p.m("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new d.d("lightingMainDirectionView",(e=>{let{lighting:t,camera:i}=e;return(0,n.n)(T,(0,n.t)(T,t.mainLight.direction,i.viewInverseTransposeMatrix))})),new _.F("inverseViewMatrix",(e=>{let{camera:t}=e;return(0,r.B8)(C,(0,r.Tl)(C,t.viewMatrix,t.center))}))).main.add(m.H`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    vec4 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0);

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    int ored =
         (int(highlightInfo.r*255.0) << 0)
       | (int(highlightInfo.g*255.0) << 8);
    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1+4+16+64)) != 0;
    if (visiblyHighlighted) {
      return;
    }

    // 1.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
    float depth = depthFromTexture(depthMap, uv);
    if (depth >= 1.0 || depth <= 0.0) {
      return;
    }

    float currentPixelDepth = linearizeDepth(depth);
    vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
    vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;

    mat4 shadowMatrix;
    float linearDepth = -currentPixelDepth;
    int i = chooseCascade(linearDepth, shadowMatrix);
    if (i >= numCascades) {
      return;
    }

    // vertex completely outside? -> no shadow
    vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
    if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
      return;
    }

    ivec2 texSize = textureSize(highlightDepthTex, 0);
    ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));

    float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
    bool shadowHighlight = depthHighlight < lvpos.z;
    if (!shadowHighlight) {
      return;
    }

    float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
    bool shadowDefault = depthDefault < lvpos.z;

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${m.H.float(w)};

    float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),e}const C=(0,s.vt)(),T=(0,a.vt)(),M=new v.D,S=Object.freeze(Object.defineProperty({__proto__:null,build:x},Symbol.toStringTag,{value:"Module"}))},43770:(e,t,i)=>{i.d(t,{r:()=>a});var r=i(33273),s=i(49008),n=i(16878);function a(e){const t=e.fragment;e.include(s.Ir),t.include(r.E),t.code.add(n.H`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}},45666:(e,t,i)=>{i.d(t,{y:()=>a});var r=i(23521),s=i(39635);class n extends r.t{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),r=super.value(e+t)-i;return Math.exp(r)}}class a extends s.P{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,arguments.length>3&&void 0!==arguments[3]?arguments[3]:12)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new n(e,t,i)}}},45979:(e,t,i)=>{var r;i.d(t,{IU:()=>r,aO:()=>n,wy:()=>s}),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(r||(r={}));const s={normal:r.Normal,average:r.Average,lighten:r.Lighten,lighter:r.Lighter,screen:r.Screen,plus:r.Plus,"color-dodge":r.ColorDodge,darken:r.Darken,multiply:r.Multiply,"color-burn":r.ColorBurn,overlay:r.Overlay,"soft-light":r.SoftLight,"hard-light":r.HardLight,"vivid-light":r.VividLight,hue:r.Hue,saturation:r.Saturation,luminosity:r.Luminosity,color:r.Color,difference:r.Difference,exclusion:r.Exclusion,minus:r.Minus,invert:r.Invert,reflect:r.Reflect,"destination-over":r.DestinationOver,"destination-atop":r.DestinationAtop,"destination-in":r.DestinationIn,"destination-out":r.DestinationOut,"source-atop":r.SourceAtop,"source-in":r.SourceIn,"source-out":r.SourceOut,xor:r.Xor};function n(e){return e===r.DestinationOver||e===r.DestinationAtop||e===r.DestinationIn||e===r.DestinationOut||e===r.SourceAtop||e===r.SourceIn||e===r.SourceOut||e===r.Xor}},46808:(e,t,i)=>{i.d(t,{r:()=>r});const r="OBJECTID"},47886:(e,t,i)=>{i.d(t,{_R:()=>n,z0:()=>s});class r{constructor(e,t,i,r,s,n,a,o,l){this.createQuery=e,this.deleteQuery=t,this.resultAvailable=i,this.getResult=r,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=a,this.createTimestamp=o,this.timestampBits=l}}let s=!1;function n(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i?new r((()=>e.createQuery()),(t=>{e.deleteQuery(t),s=!1}),(t=>e.getQueryParameter(t,e.QUERY_RESULT_AVAILABLE)),(t=>e.getQueryParameter(t,e.QUERY_RESULT)),(()=>e.getParameter(i.GPU_DISJOINT_EXT)),(t=>{s||(s=!0,e.beginQuery(i.TIME_ELAPSED_EXT,t))}),(()=>{e.endQuery(i.TIME_ELAPSED_EXT),s=!1}),(e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT)),(()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT))):(i=e.getExtension("EXT_disjoint_timer_query"),i?new r((()=>i.createQueryEXT()),(e=>{i.deleteQueryEXT(e),s=!1}),(e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_AVAILABLE_EXT)),(e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_EXT)),(()=>e.getParameter(i.GPU_DISJOINT_EXT)),(e=>{s||(s=!0,i.beginQueryEXT(i.TIME_ELAPSED_EXT,e))}),(()=>{i.endQueryEXT(i.TIME_ELAPSED_EXT),s=!1}),(e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT)),(()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT))):null)}},48277:(e,t,i)=>{i.d(t,{S:()=>n});var r=i(23682),s=i(63643);const n={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:r.default,virtual:s.default}}},48572:(e,t,i)=>{var r;i.d(t,{X:()=>r}),function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(r||(r={}))},48672:(e,t,i)=>{i.d(t,{C:()=>v,a:()=>C,b:()=>w,c:()=>b});var r=i(21265),s=i(64682),n=i(13473),a=i(32006),o=i(98080),l=i(1396),h=i(3145),c=i(37379),d=i(61315),u=i(42403),p=i(16878),m=i(80203),_=i(67058),g=i(29026),f=i(20783),y=i(8118);class v extends f.Y{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.viewMatrix=(0,n.vt)()}}const b=(0,r.A)("esri-mobile")?1024:2048;function w(e){const t=new y.N5;t.include(c.c,!1);const i=t.fragment;return i.include(g.t),i.uniforms.add(new u.m("cloudRadius",(e=>e.cloudRadius)),new u.m("power",(e=>(0,s.Cc)(35,120,e.absorption))),new u.m("sigmaE",(e=>1+e.absorption)),new u.m("density",(e=>(0,s.Cc)(0,.3,e.density))),new u.m("cloudSize",(e=>(0,s.Cc)(0,.02,Math.max(.01,1-e.cloudSize)))),new u.m("detailSize",(e=>(0,s.Cc)(0,.2,Math.max(.01,1-e.detailSize)))),new u.m("smoothness",(e=>(0,s.Cc)(0,.5,1-e.smoothness))),new u.m("cloudHeight",(e=>(0,s.Cc)(0,1500,e.cloudHeight))),new u.m("coverage",(e=>e.coverage)),new m.k("view",(e=>e.viewMatrix)),new _.N("cloudShapeTexture",(e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null)),new d.G("cloudVariables",(e=>(0,a.hZ)(x,e.coverage,e.absorption)))),i.constants.add("halfCubeMapSize","float",.5*b),i.code.add(p.H`
    const int STEPS = ${e.steps===l.p.SIXTEEN?p.H`16`:e.steps===l.p.HUNDRED?p.H`100`:p.H`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(p.H`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${p.H.float(h.jj)};
      const float dataWidth = ${p.H.float(h.jj)};
      const float tileRows = ${p.H.float(h.ik)};
      const vec3 atlasDimensions = vec3(${p.H.float(h.CQ)}, ${p.H.float(h.CQ)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${p.H.float(h.Y8)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${p.H.float(h.fI)} * p) / ${p.H.float(h.jj)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(p.H`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(p.H`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),i.code.add(p.H`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(p.H`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.main.add(p.H`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),t}const x=(0,o.vt)(),C=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:v,build:w,cubeMapSize:b},Symbol.toStringTag,{value:"Module"}))},48782:(e,t,i)=>{i.d(t,{B:()=>c,b:()=>h});var r=i(37379),s=i(16878),n=i(67058),a=i(8118);const o=8,l=16;function h(){const e=new a.N5;e.include(r.c),e.fragment.uniforms.add(new n.N("edgesTexture",(e=>e.inputTexture)),new n.N("areaTexture",(e=>e.areaTexture)),new n.N("searchTexture",(e=>e.searchTexture))),e.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]);return e.fragment.code.add(s.H`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${s.H.int(o)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${s.H.int(o)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${s.H.int(o)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${s.H.int(o)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${s.H.int(l)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${s.H.float(1/7)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),e.fragment.main.add(s.H`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${s.H.int(o)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),e}const c=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},49214:(e,t,i)=>{i.r(t),i.d(t,{default:()=>d});var r,s=i(93800),n=i(58448),a=i(48602),o=(i(21265),i(50925),i(14746),i(75269)),l=i(23682);let h=r=class extends(n.A.EventedMixin(l.default)){constructor(e){super(e),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=(new Date).getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new r(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=r.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let s=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(s=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(s=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));const n=r.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==n&&(c.target=this,c.timezoneOffset=n,this.emit("timezone-will-change",c),c.target=null),null!=e)return isNaN(e.getTime())||s!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new r({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};(0,s._)([(0,a.MZ)({type:Boolean})],h.prototype,"cameraTrackingEnabled",void 0),(0,s._)([(0,a.MZ)({type:Date})],h.prototype,"defaultDate",null),(0,s._)([(0,a.MZ)({type:Date})],h.prototype,"date",null),h=r=(0,s._)([(0,o.$)("esri.views.3d.environment.SunLighting")],h),function(e){e.calculateTimezoneOffset=function(e){let{hours:t,minutes:i,seconds:r}=e;return Math.round(t+i/60+r/3600)}}(h||(h={}));const c={target:null,timezoneOffset:0},d=h},49386:(e,t,i)=>{i.d(t,{P:()=>_,n:()=>m});var r=i(74719),s=(i(21265),i(64682)),n=i(84190),a=i(12560),o=i(75400),l=i(93321),h=i(90772),c=i(70576),d=i(5616),u=i(29275),p=i(4126);class m{constructor(e){const t=m.checkUnsupported(e);if(null!=t)throw t;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,c.EA)(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const r=i.lods.reduce(((e,t)=>(t.level<e.minLod.level&&(e.minLod=t),e.max=Math.max(e.max,t.level),e)),{minLod:i.lods[0],max:-1/0}),s=r.minLod,n=2**s.level;let a=s.resolution*n,o=s.scale*n;this.levels=new Array(r.max+1);for(let l=0;l<this.levels.length;l++)this.levels[l]={resolution:a,scale:o,tileSize:[a*i.size[0],a*i.size[1]]},a/=2,o/=2}clone(){return new m(this.toTileInfo())}toTileInfo(){return new p.default({dpi:this.dpi,origin:new o.default({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>new u.default({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,r){const s=this.levels[e],n=s.tileSize[0],a=s.tileSize[1];r[0]=this.origin[0]+i*n,r[2]=this.origin[0]+(i+1)*n,r[3]=this.origin[1]-t*a,r[1]=this.origin[1]-(t+1)*a}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=(0,d.x2lon)(e[0]),t[1]=(0,d.y2lat)(e[1]),t[2]=(0,d.x2lon)(e[2]),t[3]=(0,d.y2lat)(e[3])):this._isGCS&&(t[0]=(0,s.kU)(e[0]),t[1]=(0,s.kU)(e[1]),t[2]=(0,s.kU)(e[2]),t[3]=(0,s.kU)(e[3]))}getExtentGeometry(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new a.default;return this.getExtent(e,t,i,g),r.spatialReference=this.spatialReference,r.xmin=g[0],r.ymin=g[1],r.xmax=g[2],r.ymax=g[3],r.zmin=void 0,r.zmax=void 0,r}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const{resolution:e,scale:i}=this.levels[this.levels.length-1],r=e/2*this.pixelSize;this.levels.push({resolution:e/2,scale:i/2,tileSize:[r,r]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0;if(m.checkUnsupported(e))return!1;const i=new m(e);if(!i.spatialReference.equals(this.spatialReference))return!1;if(i.pixelSize!==this.pixelSize)return!1;const r=Math.min(this.levels.length-1,i.levels.length-1,t),n=this.levels[r].resolution;let a=.5*n;return!(!(0,s.Sp)(i.origin[0],this.origin[0],a)||!(0,s.Sp)(i.origin[1],this.origin[1],a))&&(a=.5*n/2**r/this.pixelSize*12,(0,s.Sp)(n,i.levels[r].resolution,a))}rootTilesInExtent(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;const r=new Array,s=this.levels[0].tileSize;if(null==e||0===s[0]||0===s[1])return r;m.computeRowColExtent(e,s,this.origin,g);let n=g[1],a=g[3],o=g[0],l=g[2];const h=l-o,c=a-n;if(h*c>i){const e=Math.floor(Math.sqrt(i));c>e&&(n=n+Math.floor(.5*c)-Math.floor(.5*e),a=n+e),h>e&&(o=o+Math.floor(.5*h)-Math.floor(.5*e),l=o+e)}for(let d=n;d<a;d++)for(let e=o;e<l;e++)r.push([0,d,e]);return null!=t&&(t[0]=this.origin[0]+o*s[0],t[1]=this.origin[1]-a*s[1],t[2]=this.origin[0]+l*s[0],t[3]=this.origin[1]-n*s[1]),r}static computeRowColExtent(e,t,i,r){const s=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.max(0,Math.floor((e[0]+s-i[0])/t[0])),r[2]=Math.max(0,Math.ceil((e[2]-s-i[0])/t[0])),r[1]=Math.max(0,Math.floor((i[1]-e[3]+s)/t[1])),r[3]=Math.max(0,Math.ceil((i[1]-e[1]-s)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some((e=>!(0,s.b6)(e.resolution,i/2**e.level)))}static hasGapInLevels(e){const t=e.lods.map((e=>e.level));t.sort(((e,t)=>e-t));for(let i=1;i<t.length;i++)if(t[i]!==t[0]+i)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&!(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some((e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)))}static getMissingTileInfoError(){return new r.default("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return null==e?_():e.lods.length<1?new r.default("tilingscheme:generic","Tiling scheme must have at least one level"):m.isPowerOfTwo(e)?m.hasGapInLevels(e)?new r.default("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):m.tileSizeSupported(e)?m.hasOriginPerLODs(e)?new r.default("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new r.default("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new r.default("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const i=e[2]-e[0],r=e[3]-e[1],s=(0,n.GA)(t),a=1.2*Math.max(i,r),l=a/256,h=l*s*(96/.0254),c=new m(new p.default({size:[256,256],origin:new o.default({x:e[0]-.5*(a-i),y:e[3]+.5*(a-r)}),lods:[new u.default({level:0,resolution:l,scale:h})],spatialReference:t}));return c.ensureMaxLod(20),c}static makeWebMercatorAuxiliarySphere(e){const t=new m(m.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16;const r=256/t,s=new m(new p.default({size:[t,t],origin:new o.default({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new u.default({level:0,resolution:.703125*r,scale:295497598.570834*r})]}));return s.ensureMaxLod(i),s}get test(){}}function _(){return new r.default("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}m.WebMercatorAuxiliarySphereTileInfo=new p.default({size:[256,256],origin:new o.default({x:-20037508.342787,y:20037508.342787,spatialReference:l.default.WebMercator}),spatialReference:l.default.WebMercator,lods:[new u.default({level:0,resolution:156543.03392800014,scale:591657527.591555})]}),m.WebMercatorAuxiliarySphere=m.makeWebMercatorAuxiliarySphere(19);const g=(0,h.vt)()},50552:(e,t,i)=>{i.d(t,{A:()=>h});var r=i(93800),s=i(6946),n=i(21265),a=i(49959),o=i(48602),l=(i(50925),i(14746),i(75269));let h=class extends s.default{constructor(e){super(e),this.computedOpacity=1,this.computedVisible=!0,this.opacity=1,this.visible=!0,this._fadeOutResolver=null,this._fadeInResolver=null}get transitioning(){return(this._fadeOutResolver||!this.visible?0:this.opacity)!==this.computedOpacity}endTransition(){this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeInResolver=this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0}fadeIn(){return this._fadeInResolver||(this.opacity=1,this.computedOpacity=0,this._fadeOutResolver?.(),this._fadeOutResolver=null,this._fadeInResolver=(0,a.createResolver)()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver=(0,a.createResolver)()),this._fadeOutResolver.promise}transitionStep(e,t){const i=(0,n.A)("mapview-transitions-duration"),r=i?1/i:0;if(0===r)this.computedOpacity=this.opacity,this.computedVisible=this.visible;else{const t=this._fadeOutResolver||!this.visible?0:this.opacity,i=this.computedOpacity;if(i===t)this.computedVisible=this.visible;else{const s=e*r;this.computedOpacity=i>t?Math.max(t,i-s):Math.min(t,i+s),this.computedVisible=this.computedOpacity>0}}this.transitioning||(this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeOutResolver=this._fadeInResolver=null)}};(0,r._)([(0,o.MZ)()],h.prototype,"computedOpacity",void 0),(0,r._)([(0,o.MZ)()],h.prototype,"computedVisible",void 0),(0,r._)([(0,o.MZ)()],h.prototype,"opacity",void 0),(0,r._)([(0,o.MZ)()],h.prototype,"visible",void 0),(0,r._)([(0,o.MZ)()],h.prototype,"transitioning",null),(0,r._)([(0,o.MZ)()],h.prototype,"_fadeOutResolver",void 0),(0,r._)([(0,o.MZ)()],h.prototype,"_fadeInResolver",void 0),h=(0,r._)([(0,l.$)("esri.views.2d.engine.transitions.FadeTransition")],h)},51037:(e,t,i)=>{i.d(t,{S:()=>m,a:()=>f,b:()=>g});var r=i(24646),s=i(37379),n=i(49008),a=i(94409),o=i(42403),l=i(16878),h=i(67058),c=i(59461),d=i(855),u=i(20783),p=i(8118);class m extends u.Y{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=(0,r.o8)(_),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const _=(0,r.fA)(.01,0,.25,1);function g(e){const t=new p.N5,i=t.fragment;t.include(n.Ir),t.include(s.c);const{visualization:r,bandsEnabled:u}=e;i.constants.add("inverseSampleValue","float",c.S),i.uniforms.add(new h.N("shadowCastMap",(e=>e.shadowCastMap)),new o.m("sampleScale",(e=>e.sampleScale)),new o.m("opacityFromElevation",(e=>e.opacityFromElevation)),new a.E("uColor",(e=>e.color)));const m=r===d.o.Gradient,_=r===d.o.Threshold;return m&&u?i.uniforms.add(new o.m("bandSize",(e=>e.bandSize))):_&&i.uniforms.add(new o.m("threshold",(e=>e.threshold))),i.main.add(l.H`
    float record = texture(shadowCastMap, uv).r;
    float pixelSamples = record * inverseSampleValue;

    fragColor = vec4(0.0);
    if (pixelSamples < 1.0) {
      return;
    }

    float strength = pixelSamples * sampleScale;
    ${_?l.H`if (strength <= threshold) return;`:""}
    ${m&&u?l.H`strength = ceil(strength / bandSize) * bandSize;`:""}
    fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${m?"* strength":""});
  `),t}const f=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:m,build:g},Symbol.toStringTag,{value:"Module"}))},52086:(e,t,i)=>{var r;i.d(t,{U0:()=>s,sK:()=>r,u1:()=>n}),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(r||(r={}));const s=(()=>{const e=new Array;return e[r.ELEVATION]=10,e[r.BASEMAP]=10,e[r.I3S_INDEX]=10,e[r.I3S_DATA]=10,e[r.SYMBOLOGY]=5,e})(),n=30},52188:(e,t,i)=>{i.d(t,{t:()=>s});var r=i(88636);class s{constructor(e,t,i){this.tileCoordRange=e,this._visibleTiles=t,this._createUnique=i,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(e,t){this._uniqueSymbolLayerArray=null;let i=this._tiles.get(e.id);i||(i={symbols:new Map},this._tiles.set(e.id,i));const s=new Map;if(t)for(const r of t)i.symbols.has(r)&&(s.set(r,i.symbols.get(r)),i.symbols.delete(r));else for(const[r,o]of e.layerData)i.symbols.has(r)&&(s.set(r,i.symbols.get(r)),i.symbols.delete(r));this._removeSymbols(s);const n=e.symbols,a=new Map;for(const[o,l]of n){let e=l.length;if(e>=32){let t=this.tileCoordRange;do{t/=2,e/=4}while(e>8&&t>64);const s=new r.xT(this.tileCoordRange,this.tileCoordRange,t);a.set(o,{flat:l,index:s}),i.symbols.set(o,{flat:l,index:s});for(const e of l)s.getCell(e.xTile,e.yTile).push(e)}else a.set(o,{flat:l}),i.symbols.set(o,{flat:l})}this._addSymbols(e.key,n)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[t,i]of this._tiles){const r=new Map;for(const t of e)i.symbols.has(t)&&(r.set(t,i.symbols.get(t)),i.symbols.delete(t));this._removeSymbols(r),0===i.symbols.size&&this._tiles.delete(t)}}removeTile(e){this._uniqueSymbolLayerArray=null;const t=this._tiles.get(e.id);if(!t)return;const i=new Map;for(const[r,s]of e.symbols)t.symbols.has(r)&&(i.set(r,t.symbols.get(r)),t.symbols.delete(r));this._removeSymbols(i),0===t.symbols.size&&this._tiles.delete(e.id)}querySymbols(e,t,i,s){const n=[],a=this.uniqueSymbols;for(const o of a){const s=o.styleLayerUID,a=o.uniqueSymbols;for(const o of a){const a=o.tileSymbols.find((e=>e.selectedForRendering));a&&(0,r.OI)(a,e,t*(window.devicePixelRatio||1),i)&&n.push({vtlSymbol:a,styleLayerUID:s,tileKey:a.tile.key})}}return n}_removeSymbols(e){for(const[t,{flat:i}]of e)for(const e of i){const i=e.unique,r=i.tileSymbols,s=r.length-1;for(let t=0;t<s;t++)if(r[t]===e){r[t]=r[s];break}if(r.length=s,0===s){const e=this._uniqueSymbolsReferences.get(t);e.delete(i),0===e.size&&this._uniqueSymbolsReferences.delete(t)}e.unique=null}}_addSymbols(e,t){if(0===t.size)return;const i=this._visibleTiles;for(const r of i)r.parentTile||r.key.world!==e.world||r.key.level===e.level&&!r.key.equals(e)||this._matchSymbols(r,e,t);for(const[r,s]of t)for(const e of s)if(null==e.unique){const t=this._createUnique();e.unique=t,t.tileSymbols.push(e);let i=this._uniqueSymbolsReferences.get(r);i||(i=new Set,this._uniqueSymbolsReferences.set(r,i)),i.add(t)}}_matchSymbols(e,t,i){if(e.key.level>t.level){const i=e.key.level-t.level;if(e.key.row>>i!==t.row||e.key.col>>i!==t.col)return}if(t.level>e.key.level){const i=t.level-e.key.level;if(t.row>>i!==e.key.row||t.col>>i!==e.key.col)return}if(t.equals(e.key)){for(const r of e.childrenTiles)this._matchSymbols(r,t,i);return}const s=new Map;for(const[n,a]of i){const i=[];for(const s of a){const n=(0,r.I)(this.tileCoordRange,s.xTile,t.level,t.col,e.key.level,e.key.col),a=(0,r.I)(this.tileCoordRange,s.yTile,t.level,t.row,e.key.level,e.key.row);n>=0&&n<this.tileCoordRange&&a>=0&&a<this.tileCoordRange&&i.push({symbol:s,xTransformed:n,yTransformed:a})}const o=[],l=20+(e.key.level<t.level?1:1<<e.key.level-t.level),h=this._tiles.get(e.id).symbols.get(n);if(h){const e=h.flat;for(const t of i){let i,r=!1;const s=t.xTransformed,n=t.yTransformed;i=null!=h.index?h.index.getCell(s,n):e;const a=t.symbol,c=a.hash;for(const e of i)if(c===e.hash&&Math.abs(s-e.xTile)<=l&&Math.abs(n-e.yTile)<=l){const t=e.unique;a.unique=t,t.tileSymbols.push(a),r=!0;break}r||o.push(a)}}o.length>0&&s.set(n,o)}for(const r of e.childrenTiles)this._matchSymbols(r,t,s)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,t=new Array(e.size);let i,r=0;for(const[s,n]of e){const e=new Array(n.size);i=0;for(const t of n)e[i++]=t;t[r]={styleLayerUID:s,uniqueSymbols:e},r++}return t}}},52714:(e,t,i)=>{i.d(t,{Qq:()=>V,on:()=>N,toCameraAsync:()=>H,vt:()=>U});var r=i(29306),s=i(79625),n=i(99104),a=i(58828),o=(i(21265),i(5839)),l=i(74719),h=i(49959),c=i(67965),d=i(13473),u=i(10382),p=i(89227),m=i(28473),_=i(12560),g=i(47800),f=i(76493),y=i(75400),v=i(96913),b=i(93321),w=i(42276),x=i(31183),C=i(70075),T=i(18162),M=i(4309),S=i(90772),R=i(12096),A=i(11099),E=i(68662),O=i(64566),P=i(96504);const D=.66;function I(e){return 360-o.ie.normalize(e)}function L(e){return o.ie.normalize(360-e)}function N(e,t,i){const r=t.camera;if(null!=r)return function(e,t){const i=e.position;let r;try{r=(0,v.tryProjectWithZConversion)(i,t)}catch(n){return null}if(!r)return null;const s=e.clone();return s.position=r.clone(),s}(r,(0,O.v2)(e));const{targetGeometry:s}=t;if(null==s)return null;const{camera:n,mode:a}=F(e,t.rotation,i);if("point"===s.type)return function(e,t,i,r,s){const n=e.spatialReference;let a;try{a=(0,v.tryProjectWithZConversion)(i.clone(),n)}catch(l){return null}if(!a)return null;const o=null!=t.scale?(0,O.tv)(e,t.scale):e.state.camera.distance;return(0,O.CA)(e,a,o,r,s)}(e,t,s,n,a);const o=s.extent;return null==o?null:(0,O.wI)(e,o,n.heading,n.tilt,a)}async function H(e,t,i,r){const s=t.camera;if(null!=s)return async function(e,t,i){const r=e.position,s=await(0,v.projectWithZConversion)(r,t,{signal:i});(0,h.throwIfAborted)(i);const n=e.clone();return n.position=s.clone(),n}(s,(0,O.v2)(e),r);const{targetGeometry:n}=t;if(null==n)throw new Error("Viewpoint has no targetGeometry!");const{camera:a,mode:o}=F(e,t.rotation,i);if("point"===n.type)return async function(e,t,i,r,s,n){const a=e.spatialReference,o=await(0,v.projectWithZConversion)(i.clone(),a,{signal:n});(0,h.throwIfAborted)(n);const l=null!=t.scale?(0,O.tv)(e,t.scale):e.state.camera.distance;return(0,O.V2)(e,o,l,r,s,n)}(e,t,n,a,o,r);const l=n.extent;if(null==l)throw new Error("Target geometry has no extent!");return(0,O.F3)(e,l,a.heading,a.tilt,o,r)}function F(e,t,i){const r=(0,O.dl)(e,e.state.camera);let s=O.AO.ADJUST;return null!=t&&(r.heading=I(t),s=O.AO.LOCKED),null!=i&&(r.tilt=i),{camera:r,mode:s}}function V(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==i&&(i=new n.default),q(e,null,t.clone(),i)}async function U(e,t,i){const s=function(e,t){if(!t||!e.spatialReference)return null;const i={target:void 0};return"declaredClass"in t||Array.isArray(t)?i.target=t:(Object.assign(i,t),!i.target&&"center"in t&&t.center&&(i.target=t.center)),i}(e,t);if(!s)throw new l.default("viewpointutils-create:no-target","Missing target for creating viewpoint");const a=new r.default({fov:e.camera.fov}),o=new n.default({camera:a});if(s.target instanceof n.default)return j(await async function(e,t,i,r,s){if(t.camera)return W(e,t.camera,r,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=null!=t.targetGeometry?t.targetGeometry.clone():null,s.camera=null,null!=i.heading?s.rotation=L(i.heading):null!=i.rotation&&(s.rotation=i.rotation);const n=z(e,i);return null!=n&&(s.scale=n),s.camera=await H(e,s,i.tilt,r),s}(e,s.target,s,i,o));if(s.target instanceof r.default)return j(await W(e,s.target,i,o));const h=null!=s.scale||null!=s.zoom;if(s.target instanceof _.default){const t=s.target.xmin===s.target.xmax||s.target.ymin===s.target.ymax;return j(h||t?await Z(e,s,s.target.center,a,i,o):await async function(e,t,i,r,s,n){n.targetGeometry=i.clone();const a=(0,E.bZ)(e);(0,O.dl)(e,a,r);const o=G(r,t)?O.AO.LOCKED:O.AO.ADJUST;return n.camera=await(0,O.F3)(e,i,r.heading,r.tilt,o,s),n}(e,s,s.target,a,i,o))}const d=new $,u=h?function(e,t){const i=z(e,t);return i?(0,A.j8)(i):void 0}(e,s):void 0;if(await B(e,s.target,u,d,i),isFinite(d.boundingBox[0])){let t;if((0,M.gX)(d.boundingBox,Q),se.x=Q[0],se.y=Q[1],se.z=Q[2],se.spatialReference=e.spatialReference,isFinite(se.z)&&d.hasZ?t=(0,M.fT)(d.boundingBox):(se.z=void 0,t=(0,S.ye)((0,M.ES)(d.boundingBox,J))),h||t)return j(await Z(e,s,se,a,i,o));const r=function(e,t){const i=D;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let s=0;s<t.length;s++){const e=t[s].screenSpaceBoundingRect;r=Math.max(r,Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2]),Math.abs(e[3]))}return i-r/Math.min(e.width,e.height)*2}(e,d.screenSpaceObjects);return j(await async function(e,t,i,r,s,n,a,o){o.targetGeometry=i.clone();const l=(0,E.bZ)(e),h=function(e,t,i,r,s){let n=0;null!=i.z?n=i.z:e.basemapTerrain&&e.elevationProvider&&(n=(0,P.R1)(e.elevationProvider,i)),(0,p.i)(Q,i.x,i.y,n),(0,w.l)(e.spatialReference,Q,Y,e.renderSpatialReference),(0,c.z0)(X,Y),(0,c.mg)(X,X),(0,M.Ie)(K);const a=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let c=0;c<a.length;c++){const t=a[c];let i=r[t[2]];isFinite(i)||(i=n),(0,p.i)(Q,r[t[0]],r[t[1]],i),(0,T.F)(Q,e.spatialReference,Q,e.renderSpatialReference),(0,M.iT)(K,(0,p.q)(Q,Q,X))}const o=(0,M.VL)(K),l=(0,M.uJ)(K),h=(0,M.yr)(K),d=1/Math.tan(t.fovX/2),u=1/Math.tan(t.fovY/2),m=.5*Math.sqrt(o*o+h*h)*Math.max(u,d)+.5*l,_=.5*l*u+.5*Math.max(o,h);return Math.max(m,_)/s}(e,l,i,r,s);(0,O.dl)(e,l,n);const d=G(n,t)?O.AO.LOCKED:O.AO.ADJUST;return o.camera=await(0,O.V2)(e,o.targetGeometry,h,n,d,a),o.scale=(0,O.Fj)(e,h),o}(e,s,se,d.boundingBox,r,a,i,o))}return s.position?j(await async function(e,t,i,r,s){const n=(0,E.bZ)(e);(0,p.c)(ee,n.viewForward),(0,O.gn)(e,n.eye,ee,n.up,re);const a=e.spatialReference,{position:o}=t;if(o){const e=await(0,v.projectWithZConversion)(o,a,{signal:s});i.position=e}else i.position=new y.default;return i.heading=null!=t.heading?t.heading:re.heading,i.tilt=null!=t.tilt?t.tilt:re.tilt,q(e,null,i,r)}(e,s,a,o,i)):j(await async function(e,t,i,r,s){if(null!=t.heading||null!=t.rotation||null!=t.scale||null!=t.tilt||null!=t.zoom||null!=t.zoomFactor){const n=(0,E.bZ)(e),{spatialReference:a,renderSpatialReference:o}=e,l=new y.default({spatialReference:a});return(0,C.E)(n.center,o,l)?Z(e,t,l,i,r,s):s}return s.scale=e.scale,s.camera=e.camera.clone(),G(s.camera,t),s}(e,s,a,i,o))}function z(e,t){return null==t.scale&&null!=t.zoom?(0,O.XM)(e,t.zoom):t.scale}function G(e,t){let i=!1;return null!=t.heading?(e.heading=t.heading,i=!0):null!=t.rotation&&(e.heading=I(t.rotation),i=!0),null!=t.tilt&&(e.tilt=t.tilt,i=!0),null!=t.fov&&(e.fov=t.fov),i}function q(e,t,i,r){const s=e.spatialReference||b.default.WGS84;if(t??=(0,O.Cz)(e,i),null==t)return r;const n=new y.default({spatialReference:s});return(0,C.E)(t.center,e.renderSpatialReference,n)?(r.targetGeometry=n,r.scale=(0,O.Fj)(e,t.distance),r.rotation=L(i.heading),r.camera=i,r):r}async function k(e,t,i,r){const s=()=>new l.default("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw s();"mesh"===t.type&&(t=t.extent);const n=e.basemapTerrain.spatialReference;if(!t.hasZ&&e.basemapTerrain){let i;switch(t.type){case"point":i=t;break;case"multipoint":case"polyline":i=t.extent?.center;break;case"extent":i=t.center;break;case"polygon":i=t.centroid}null!=i&&n&&e.elevationProvider?(i=await(0,v.projectWithZConversion)(i,n,{signal:r}),Q[2]=(0,P.R1)(e.elevationProvider,i)??0):Q[2]=0}const a=ne[t.type],o=new Array;if(a(t,t.hasZ?e=>{o.push([e[0],e[1],e[2]])}:e=>{o.push([e[0],e[1]])},Q),0===o.length)throw s();const h=t.spatialReference,c=e.spatialReference,d=await(0,v.projectWithZConversion)(new f.default({spatialReference:h,hasZ:t.hasZ,hasM:!1,points:o}),c,{signal:r});if(t.hasZ&&(i.hasZ=!0),t.hasZ)for(const[l,u,p]of d.points)Q[0]=l,Q[1]=u,Q[2]=p,(0,M.iT)(i.boundingBox,Q);else for(const[l,u]of d.points)Q[0]=l,Q[1]=u,(0,M.iT)(i.boundingBox,Q)}async function B(e,t,i,r,n){if(Array.isArray(t)&&2===t.length){const i=t[0],s=t[1];if("number"==typeof i&&"number"==typeof s)return se.x=i,se.y=s,se.z=void 0,se.spatialReference=e.spatialReference?.isGeographic?e.spatialReference:b.default.WGS84,void await k(e,se,r,n)}t&&"map"in t&&"function"==typeof t.map?await Promise.allSettled(t.map((t=>B(e,t,i,r,n)))):t instanceof g.default?await k(e,t,r,n):t instanceof s.default&&await async function(e,t,i,r,s){const n=await(0,a.Ke)(e.whenViewForGraphic(t));if(!1===n.ok||null==n.value||!("whenGraphicBounds"in n.value))return void await k(e,t.geometry,r,s);const o=n.value,l=await(0,a.Ke)(o.whenGraphicBounds(t,{minDemResolution:i}));if(!1===l.ok||!l.value)return void await k(e,t.geometry,r,s);const{screenSpaceObjects:h,boundingBox:c}=l.value;(0,M.RF)(r.boundingBox,c),h&&h.forEach((e=>{r.screenSpaceObjects.push(e)})),isFinite(c[2])&&(r.hasZ=!0)}(e,t,i,r,n)}async function W(e,t,i,r){const s=e.spatialReference,n=await(0,v.projectWithZConversion)(t.position,s,{signal:i}),a=t.clone();return a.position=n,q(e,null,a,r)}async function Z(e,t,i,r,s,n){n.targetGeometry=i.clone();const a=(0,E.bZ)(e);if(t.position)return async function(e,t,i,r,s,n,a){const o=e.renderSpatialReference;return await(0,x.W)(t,ie,o,0,{signal:a}),await(0,x.W)(i,te,o,0,{signal:a}),n.targetGeometry=new y.default(t),s.position=new y.default(i),(0,p.d)(ee,ie,te),(0,O.gn)(e,te,ee,r.up,s),n.scale=(0,O.Fj)(e,(0,p.j)(te,ie)),n.rotation=L(s.heading),n.camera=s,n}(e,n.targetGeometry,t.position,a,r,n,s);if(t.zoomFactor){const i=a.distance/t.zoomFactor,r=(0,p.h)(Q,a.viewForward,-i);a.eye=(0,p.g)(Q,a.center,r),n.scale=(0,O.Fj)(e,i)}(0,O.dl)(e,a,r);const o=G(r,t)?O.AO.LOCKED:O.AO.ADJUST;if(!t.zoomFactor){const i=z(e,t);if(null==i){await(0,x.W)(n.targetGeometry,Q,e.renderSpatialReference,0,{signal:s});const t=(0,R.bU)(a.frustum,Q)?(0,p.j)(a.eye,Q):a.distance;n.camera=await(0,O.V2)(e,n.targetGeometry,t,r,o),n.scale=(0,O.Fj)(e,t)}else n.scale=i,n.camera=await(0,O.gU)(e,n.targetGeometry,n.scale,r,o,s)}return n}function j(e){return null!=e?.camera&&(e.rotation=L(e.camera.heading)),e}class ${constructor(){this.hasZ=!1,this.boundingBox=(0,M.Ie)(),this.screenSpaceObjects=new Array}}const Q=(0,m.vt)(),Y=(0,u.vt)(),X=(0,d.vt)(),K=(0,M.vt)(),J=(0,S.vt)(),ee=(0,m.vt)(),te=(0,m.vt)(),ie=(0,m.vt)(),re={heading:0,tilt:0},se=new y.default,ne={point(e,t,i){i[0]=e.x,i[1]=e.y,null!=e.z&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let e=0;e<n.length;e++)i[0]=n[e][0],i[1]=n[e][1],r&&(i[2]=n[e][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let e=0;e<n.length;e++)i[0]=n[e][0],i[1]=n[e][1],r&&(i[2]=n[e][2]),t(i)}},multipoint(e,t,i){const r=e.points,s=e.hasZ;for(let n=0;n<r.length;n++)i[0]=r[n][0],i[1]=r[n][1],s&&(i[2]=r[n][2]),t(i)},extent(e,t,i){null!=e.zmin&&null!=e.zmax?(t((0,p.i)(i,e.xmin,e.ymin,e.zmin)),t((0,p.i)(i,e.xmax,e.ymin,e.zmin)),t((0,p.i)(i,e.xmin,e.ymax,e.zmin)),t((0,p.i)(i,e.xmax,e.ymax,e.zmin)),t((0,p.i)(i,e.xmin,e.ymin,e.zmax)),t((0,p.i)(i,e.xmax,e.ymin,e.zmax)),t((0,p.i)(i,e.xmin,e.ymax,e.zmax)),t((0,p.i)(i,e.xmax,e.ymax,e.zmax))):(t((0,p.i)(i,e.xmin,e.ymin,i[2])),t((0,p.i)(i,e.xmax,e.ymin,i[2])),t((0,p.i)(i,e.xmin,e.ymax,i[2])),t((0,p.i)(i,e.xmax,e.ymax,i[2])))}}},52877:(e,t,i)=>{i.d(t,{C2:()=>a,Cn:()=>l,Ey:()=>d,Ri:()=>m,V$:()=>o,ZH:()=>b,ZZ:()=>h,jV:()=>f,kh:()=>v,lR:()=>c,vx:()=>y});var r=i(15899),s=i(48572),n=i(37858);class a{constructor(){this._queue=new r.A,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}}class o{constructor(){this._q=new r.A}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.leaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}}function l(e,t){if(null==t)return!1;const i=function(e){return(0,n.n9)(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale}:e.layer}(t);if(null==i?.fullExtent)return!1;const r=i.fullExtent,s=e.extent;if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const a=e.surface.tilingScheme.levels[e.level].scale,o=i.minScale;if(o>0&&a>1.00000001*o)return!1;const l=i.maxScale;return!(l>0&&a<.99999999*l)}function h(e){return!(0,n.n9)(e)&&e.layer&&"tilemapCache"in e.layer?e.layer.tilemapCache:null}function c(e,t){const i=e.lij,r=t.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function d(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==i||0===i.length?e===s.X.BACK_TO_FRONT?t.sort(u):t.sort(p):t.sort(((t,r)=>function(e,t,i,r){return _(e,r)===_(t,r)?m(e,t,i):e?i:-i}(t,r,e,i)))}function u(e,t){const i=t.screenDepth-e.screenDepth;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function p(e,t){const i=e.screenDepth-t.screenDepth;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function m(e,t,i){const r=e.screenDepth,s=t.screenDepth;return r<s?-i:r>s?i:c(e,t)}function _(e,t){for(const i of t)if(e.intersectsExtent(i))return!0;return!1}function g(e,t){const i=e.distanceToPOI-t.distanceToPOI;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function f(e,t){const i=e.length;for(let r=0;r<i;++r)e.at(r).updateDistanceToPOI(t);e.sort(g)}function y(e,t,i){let r=1,s=0,n=0;for(;e!==t;)if(r*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),1&e.lij[1]||(n+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,n,r)}function v(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let e=0;e<4;e++){const t=r.children[e];if(t&&t!==i)return!0}}return!1}function b(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}},54232:(e,t,i)=>{i.d(t,{DC:()=>a,MQ:()=>o,mi:()=>l});var r=i(92453),s=i(15828),n=i(27464);function a(e){return(0,n.i3)(e)&&e.intersector===r.dz.TERRAIN&&!!e.target}class o extends s.R6{constructor(e,t,i){super(e,t),this.triangleNr=i}}function l(e){return(0,n.i3)(e)&&e.intersector===r.dz.OVERLAY&&!!e.target}},54404:(e,t,i)=>{async function r(e,t){if("2d"===e.type)return e.hitTest(t);const i=await e.hitTest(t);if(0===i.results.length)return i;const r=i.results[0],n=(r.distance??0)*(1+s),a=i.results.findIndex((e=>(e.distance??0)>n));return-1!==a&&(i.results=i.results.slice(0,a)),r&&i.ground.distance>n&&(i.ground.mapPoint=null),i}i.d(t,{h$:()=>o,oZ:()=>r,zF:()=>a});const s=.05;function n(e){return"graphic"===e?.type}function a(e){return e.find(n)??null}function o(e){return e.filter(n)}},54407:(e,t,i)=>{i.d(t,{FI:()=>p,FV:()=>d,Gy:()=>u,QS:()=>f,SM:()=>g});var r=i(87752),s=i(28473),n=i(4309),a=i(89476),o=i(10323),l=i(54232),h=i(27464),c=i(99855);function d(e,t){return(0,h.$I)(e)||(0,h.hH)(e)?_(e.target?.object,t):(0,l.DC)(e)?t.map?.ground:(0,o.rb)(e)||(0,o.db)(e)||(0,l.mi)(e)||(0,o.Q5)(e)?_(e.target,t):null}function u(e,t){const i=p(e,t);return null!=i&&"graphic"===i.type?i.graphic:null}function p(e,t){if(null==e)return null;if((0,h.$I)(e)||(0,h.hH)(e))return m(e.target?.object,t);if((0,o.rb)(e)){const t=e.target.createGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if((0,o.Q5)(e)){const t=e.target.createVoxelGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if((0,o.W3)(e)){const t=e.target.createTiles3DGraphic();return{type:"graphic",graphic:t,layer:t.layer}}return(0,l.mi)(e)||(0,c.H)(e)?m(e.target,t):(0,o.db)(e)?function(e,t){const i=_(e,t);if(null==i)return null;const r=t.allLayerViews.find((e=>e.layer===i));return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?function(e){return null!=e?{type:"graphic",graphic:e,layer:e.layer}:null}(r.getGraphicFromIntersectorTarget(e)):null}(e.target,t):null}function m(e,t){if(null==e?.graphicUid)return null;const i=_(e,t);if(null==i)return null;if(i===t.graphics)return null==t.graphicsView||"number"!=typeof e.graphicUid?null:t.graphicsView.getHit(e.graphicUid);const r=t.allLayerViews.find((e=>e.layer===i));return!r||r.suspended||null==e.graphicUid?null:"getHit"in r?r.getHit(e.graphicUid):null}function _(e,t){return null==e?.layerUid?null:null!=t.graphicsView&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.allLayers.find((t=>t.uid===e.layerUid))}function g(e,t){if((0,h.$I)(e)||(0,h.hH)(e))return(0,a.g)(e.target.object.boundingVolumeWorldSpace.bounds);if((0,c.H)(e)){(0,r.IL)(y,e.transformation);const t=Math.max(y[0],y[1],y[2]);return e.target.baseBoundingSphere.radius*t}if((0,o.db)(e)){const i=function(e,t){const i=_(e,t);if(null==i)return null;const r=t.allLayerViews.find((e=>e.layer===i));return r&&!r.suspended&&"getAABBFromIntersectorTarget"in r?r.getAABBFromIntersectorTarget(e):null}(e.target,t);return i?.5*(0,n._F)(i):null}return null}function f(e){return!(0,h.$I)(e)&&!(0,h.hH)(e)&&((0,c.H)(e)?e.target.numLodLevels>1:!!(0,o.db)(e))}const y=(0,s.vt)()},55102:(e,t,i)=>{i.d(t,{BK:()=>h,Rq:()=>l});var r=i(53769),s=i(29094),n=i(75747),a=i(16878),o=i(826);class l extends r.QR{constructor(){super(...arguments),this.overlayOpacity=1}}function h(e,t){const{vertex:i,fragment:r,varyings:o}=e;o.add("vtc","vec2"),i.uniforms.add(new u("texOffsetAndScale")),r.uniforms.add(new p("tex")),r.uniforms.add(new d("textureOpacities"));const l=t.textureFadingEnabled&&!t.renderOccluded;l&&(i.uniforms.add(new u("nextTexOffsetAndScale")),o.add("nvtc","vec2"),r.uniforms.add(new p("texNext")),r.uniforms.add(new d("nextTexOpacities")),r.uniforms.add(new c("fadeFactor")));const h=t.tileBlendInput===n.k.ColorComposite,m=t.tileBlendInput===n.k.GridComposite;m&&r.include(s.z),h&&r.uniforms.add(new d("backgroundColor")),i.code.add(a.H`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${(0,a.If)(l,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),r.code.add(a.H`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${(0,a.If)(m||h,a.H`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${h?a.H`backgroundColor`:a.H`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),l?r.code.add(a.H`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):r.code.add(a.H`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}class c extends o.n{constructor(e){super(e,"float")}}class d extends o.n{constructor(e){super(e,"vec3")}}class u extends o.n{constructor(e){super(e,"vec4")}}class p extends o.n{constructor(e){super(e,"sampler2D")}}},55426:(e,t,i)=>{i.d(t,{E:()=>y,g:()=>r});var r,s=i(93800),n=i(88242),a=i(77548),o=i(96236),l=i(16213),h=i(69261),c=i(82606),d=i(86821),u=i(12796),p=i(96109),m=i(21484),_=i(71723),g=i(86836),f=i(73031);!function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(r||(r={}));class y extends m.K{constructor(e,t){super(),this.spherical=e,this.doublePrecisionRequiresObfuscation=t,this.output=o.V.Color,this.textureCoordinateType=h.I.None,this.componentData=n.Sg.Uniform,this.cullFace=_.s2.Back,this.vertexDiscardMode=a.q.None,this.doubleSidedMode=d.W.WindingOrder,this.alphaDiscardMode=_.sf.Opaque,this.integratedMeshMode=r.None,this.oitPass=g.Y.NONE,this.ellipsoidMode=p.T.Earth,this.pbrMode=u.A9.Disabled,this.normalType=l.W.Attribute,this.emissionSource=c.ZX.None,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=f.c.Draw,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.objectAndLayerIdColorInstanced=!1,this.canHaveOverlay=!0}}(0,s._)([(0,m.W)({count:o.V.COUNT})],y.prototype,"output",void 0),(0,s._)([(0,m.W)({count:h.I.COUNT})],y.prototype,"textureCoordinateType",void 0),(0,s._)([(0,m.W)({count:n.Sg.COUNT})],y.prototype,"componentData",void 0),(0,s._)([(0,m.W)({count:_.s2.COUNT})],y.prototype,"cullFace",void 0),(0,s._)([(0,m.W)({count:a.q.COUNT})],y.prototype,"vertexDiscardMode",void 0),(0,s._)([(0,m.W)({count:d.W.COUNT})],y.prototype,"doubleSidedMode",void 0),(0,s._)([(0,m.W)({count:_.sf.COUNT})],y.prototype,"alphaDiscardMode",void 0),(0,s._)([(0,m.W)({count:r.COUNT})],y.prototype,"integratedMeshMode",void 0),(0,s._)([(0,m.W)({count:g.Y.COUNT})],y.prototype,"oitPass",void 0),(0,s._)([(0,m.W)({count:p.T.COUNT})],y.prototype,"ellipsoidMode",void 0),(0,s._)([(0,m.W)({count:u.A9.COUNT})],y.prototype,"pbrMode",void 0),(0,s._)([(0,m.W)({count:l.W.COUNT})],y.prototype,"normalType",void 0),(0,s._)([(0,m.W)({count:c.ZX.COUNT})],y.prototype,"emissionSource",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasVertexColors",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasNormals",void 0),(0,s._)([(0,m.W)()],y.prototype,"shadeNormals",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasSlicePlane",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasColorTexture",void 0),(0,s._)([(0,m.W)()],y.prototype,"receiveAmbientOcclusion",void 0),(0,s._)([(0,m.W)()],y.prototype,"receiveShadows",void 0),(0,s._)([(0,m.W)()],y.prototype,"blendingEnabled",void 0),(0,s._)([(0,m.W)()],y.prototype,"screenSpaceReflections",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasPolygonOffset",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasMetallicRoughnessTexture",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasOcclusionTexture",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasNormalTexture",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasOccludees",void 0),(0,s._)([(0,m.W)()],y.prototype,"terrainDepthTest",void 0),(0,s._)([(0,m.W)()],y.prototype,"cullAboveTerrain",void 0),(0,s._)([(0,m.W)()],y.prototype,"hasNormalTextureTransform",void 0),(0,s._)([(0,m.W)()],y.prototype,"cloudReflections",void 0),(0,s._)([(0,m.W)()],y.prototype,"snowCover",void 0),(0,s._)([(0,m.W)()],y.prototype,"objectAndLayerIdColor",void 0)},55736:(e,t,i)=>{i.d(t,{s:()=>l});var r=i(27510),s=i(28826),n=i(88636),a=i(7835);function o(e,t,i,r,s,n){const{iconRotationAlignment:o,textRotationAlignment:l,iconTranslate:h,iconTranslateAnchor:c,textTranslate:d,textTranslateAnchor:u}=r;let p=0;for(const m of e.colliders){const[e,r]=0===m.partIndex?h:d,_=0===m.partIndex?c:u,g=m.minLod<=n&&n<=m.maxLod;p+=g?0:1,m.enabled=g,m.xScreen=m.xTile*s[0]+m.yTile*s[3]+s[6],m.yScreen=m.xTile*s[1]+m.yTile*s[4]+s[7],_===a.Cq.MAP?(m.xScreen+=i*e-t*r,m.yScreen+=t*e+i*r):(m.xScreen+=e,m.yScreen+=r),a.I5.VIEWPORT===(0===m.partIndex?o:l)?(m.dxScreen=m.dxPixels,m.dyScreen=m.dyPixels):(m.dxScreen=i*(m.dxPixels+m.width/2)-t*(m.dyPixels+m.height/2)-m.width/2,m.dyScreen=t*(m.dxPixels+m.width/2)+i*(m.dyPixels+m.height/2)-m.height/2)}e.colliders.length>0&&p===e.colliders.length&&(e.unique.show=!1)}class l{constructor(e,t,i,a,o,l){this._symbols=e,this._styleRepository=a,this._zoom=o,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new n.xT(t,i,s.o2),this._si=Math.sin(Math.PI*l/180),this._co=Math.cos(Math.PI*l/180);for(const s of e)for(const e of s.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,(0,r.o8)(e.tile.transforms.tileUnitsToPixels))}work(e){const t=this._gridIndex;function i(e){const i=e.xScreen+e.dxScreen,r=e.yScreen+e.dyScreen,s=i+e.width,n=r+e.height,[a,o,l,h]=t.getCellSpan(i,r,s,n);for(let c=o;c<=h;c++)for(let e=a;e<=l;e++){const a=t.cells[c][e];for(const e of a){const t=e.xScreen+e.dxScreen,a=e.yScreen+e.dyScreen,o=t+e.width,l=a+e.height;if(!(s<t||i>o||n<a||r>l))return!0}}return!1}const r=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const t=this._symbols[this._currentLayerCursor],s=this._getProperties(t.styleLayerUID);for(;this._currentSymbolCursor<t.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-r>e)return!1;const n=t.symbols[this._currentSymbolCursor];if(!n.unique.show)continue;o(n,this._si,this._co,s,this._allNeededMatrices.get(n.tile),this._zoom);const a=n.unique;if(!a.show)continue;const{iconAllowOverlap:l,iconIgnorePlacement:h,textAllowOverlap:c,textIgnorePlacement:d}=s;for(const e of n.colliders){if(!e.enabled)continue;const t=a.parts[e.partIndex];t.show&&(!(e.partIndex?c:l)&&i(e)&&(e.hard?a.show=!1:t.show=!1))}if(a.show)for(const e of n.colliders){if(!e.enabled)continue;if(e.partIndex?d:h)continue;if(!a.parts[e.partIndex].show)continue;const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,r=t+e.width,s=i+e.height,[n,o,l,c]=this._gridIndex.getCellSpan(t,i,r,s);for(let a=o;a<=c;a++)for(let t=n;t<=l;t++)this._gridIndex.cells[a][t].push(e)}}}return!0}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const i=this._zoom,r=this._styleRepository.getStyleLayerByUID(e),s=r.getLayoutValue("symbol-placement",i)!==a.kt.POINT;let n=r.getLayoutValue("icon-rotation-alignment",i);n===a.I5.AUTO&&(n=s?a.I5.MAP:a.I5.VIEWPORT);let o=r.getLayoutValue("text-rotation-alignment",i);o===a.I5.AUTO&&(o=s?a.I5.MAP:a.I5.VIEWPORT);const l=r.getPaintValue("icon-translate",i),h=r.getPaintValue("icon-translate-anchor",i),c=r.getPaintValue("text-translate",i),d=r.getPaintValue("text-translate-anchor",i),u={iconAllowOverlap:r.getLayoutValue("icon-allow-overlap",i),iconIgnorePlacement:r.getLayoutValue("icon-ignore-placement",i),textAllowOverlap:r.getLayoutValue("text-allow-overlap",i),textIgnorePlacement:r.getLayoutValue("text-ignore-placement",i),iconRotationAlignment:n,textRotationAlignment:o,iconTranslateAnchor:h,iconTranslate:l,textTranslateAnchor:d,textTranslate:c};return this._styleProps.set(e,u),u}}},57197:(e,t,i)=>{i.d(t,{J:()=>h,W:()=>c});var r=i(98080),s=i(61315),n=i(42403),a=i(16878),o=i(22131),l=i(20783);class h extends l.Y{constructor(){super(...arguments),this.scale=1,this.offset=r.uY}}function c(e){e.attributes.add(o.r.POSITION,"vec2"),e.attributes.add(o.r.UV0,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new n.m("scale",(e=>e.scale)),new s.G("offset",(e=>e.offset))),e.vertex.main.add(a.H`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)}},59450:(e,t,i)=>{i.d(t,{H:()=>h,a:()=>d,b:()=>c});var r=i(37379),s=i(16878),n=i(73712),a=i(67058),o=i(20783),l=i(8118);class h extends o.Y{}function c(){const e=new l.N5;return e.include(r.c),e.fragment.uniforms.add(new a.N("colorTexture",(e=>e.color)),new n.x("depthTexture",(e=>e.mainDepth))),e.fragment.main.add(s.H`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const d=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:h,build:c},Symbol.toStringTag,{value:"Module"}))},59461:(e,t,i)=>{i.d(t,{S:()=>_,a:()=>b,b:()=>f});var r=i(87752),s=i(10382),n=i(37379),a=i(33273),o=i(53769),l=i(49008),h=i(42162),c=i(16878),d=i(38950),u=i(73712),p=i(72678),m=i(8118);const _=255,g=1/_;function f(){const e=new m.N5,t=e.fragment;return t.include(h.W),t.include(a.E),e.include(l.Ir),e.include(n.c),e.include(o.G,v),t.uniforms.add(new u.x("shadowMap",(e=>e.shadowMap.depthTexture)),new u.x("depthMap",(e=>e.depth?.attachment)),new d.F("inverseViewMatrix",(e=>(0,r.B8)(y,(0,r.Tl)(y,e.camera.viewMatrix,e.camera.center))))),t.constants.add("sampleValue","float",g),e.outputs.add("sampleCount","float"),t.main.add(c.H`sampleCount = 0.0;
float depth = depthFromTexture(depthMap, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float currentPixelDepth = linearizeDepth(depth);
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
return;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
return;
}
ivec2 texSize = textureSize(shadowMap, 0);
ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));
float depthShadow = readShadowMapDepth(uvShadow, shadowMap);
bool shadow = depthShadow < lvpos.z;
if (shadow) {
sampleCount = sampleValue;
}`),e}const y=(0,s.vt)(),v=new p.D,b=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:_,build:f},Symbol.toStringTag,{value:"Module"}))},59603:(e,t,i)=>{i.d(t,{B:()=>w});var r=i(93800),s=i(6946),n=(i(21265),i(45622)),a=i(15899),o=i(48602),l=(i(50925),i(14746),i(75269)),h=i(98080),c=i(89476),d=i(54232),u=i(96236),p=i(99741),m=i(8609),_=i(92453),g=i(60984),f=i(69473),y=i(75281),v=i(53801),b=i(86209);let w=class extends s.default{constructor(e){super(e),this._pending=new x,this._changes=new p.VR,this._renderers=new Map,this._sortedRenderers=new a.A,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlightOptions(e){return(0,n.Bs)(this._renderers,(t=>t.hasHighlightOptions(e)))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const e of this._renderers.values())if(0!==e.numGeometries&&!e.queryRenderOccludedState(g.m$.Occlude))return!0;return!1}get isEmpty(){return!this.updating&&0===this._renderers.size&&0===this._geometries.size}getMaterialRenderer(e){return this._renderers.get(e)}get sortedRenderers(){return this._sortedRenderers}commitChanges(e){if(!this.updating)return!1;this._processAddsRemoves();const t=(0,y.$T)(this._changes);let i=!1;return t.forEach(((t,r)=>{let s=this._renderers.get(r);!s&&t.adds.length>0&&(s=new b.y({material:r,highlightOrderMap:e}),s.initializeRenderContext(this.rendererContext.pluginContext,this._materials),this._renderers.set(r,s),i=!0),s&&(s.modify(t),s.updateHighlights(e),0===s.numGeometries&&(this._renderers.delete(r),s.destroy(),i=!0))})),this._changes.clear(),i&&this._updateSortedMaterialRenderers(),this._hasHighlights=(0,n.Bs)(this._renderers,(e=>{const t=e.produces.get(v.N.DRAPED_MATERIAL);return!!t&&t(u.V.Highlight)})),this._hasWater=(0,n.Bs)(this._renderers,(e=>{const t=e.produces.get(v.N.DRAPED_WATER);return!!t&&t(u.V.Normal)})),this.notifyChange("updating"),!0}updateHighlights(e){this._renderers.forEach((t=>t.updateHighlights(e)))}addGeometries(e,t){if(0===e.length)return;const i=this._validateRenderGeometries(e);for(const s of i)this._geometries.set(s.id,s);const r=this._pending.empty;for(const s of i)this._pending.adds.add(s);r&&this.notifyChange("updating"),t===f.q.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const i=this._pending.empty,r=this._pending.adds;for(const s of e)r.has(s)?(this._pending.removed.add(s),r.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===f.q.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(r),e.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case f.k.TRANSFORMATION:case f.k.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case f.k.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll((i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t)),t}precompile(e){return this._sortedRenderers.reduce(((t,i)=>i.precompile(e)||t),!1)}render(e){this._sortedRenderers.forAll((t=>{const i=t.acquireTechniques(e);i&&t.render(e,i)}))}intersect(e,t,i,r,s){for(const n of this._geometries.values()){if(!r(n))continue;this._intersectRenderGeometry(n,i,t,0,e,s);const a=this.rendererContext.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,i,t,a.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,i,t,-a.range,e,s)),s++}return s}_updateSortedMaterialRenderers(){this._sortedRenderers.clear();let e=0;for(const t of this._renderers.values())t.drapedPriority=e++,this._sortedRenderers.push(t);this._sortedRenderers.sort(((e,t)=>t.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-t.drapedPriority:(t.material?.renderPriority||0)-(e.material?.renderPriority||0)))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace((e=>{let{renderGeometry:t}=e;return!this._pending.has(t)})),this._pending.clear()}_intersectRenderGeometry(e,t,i,r,s,n){if(!e.visible||!e.material.visible)return;let a=0;r+=e.transformation[12],a=e.transformation[13],C[0]=i[0]-r,C[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,s,C,((i,r,a)=>{!function(e,t,i,r,s,n,a){const o=new d.MQ(n,a,t),l=t=>{t.set(_.dz.OVERLAY,o,e.dist,e.normal,e.transformation,i,r)};if((null==s.results.min.drapedLayerOrder||i>=s.results.min.drapedLayerOrder)&&(null==s.results.min.dist||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==_.oH.MIN&&(null==s.results.max.drapedLayerOrder||i<s.results.max.drapedLayerOrder)&&(null==s.results.max.dist||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===_.oH.ALL){const e=(0,m.G7)(s.ray);l(e),s.results.all.push(e)}}(t,a,n,e.material.renderPriority,s,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const{graphicUid:i}of e)null!=i&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const{graphicUid:i}of e)null!=i&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin((0,c.a)(e.boundingSphere))),e}get test(){}};(0,r._)([(0,o.MZ)()],w.prototype,"drapeSource",void 0),(0,r._)([(0,o.MZ)()],w.prototype,"updating",null),(0,r._)([(0,o.MZ)()],w.prototype,"rctx",null),(0,r._)([(0,o.MZ)({constructOnly:!0})],w.prototype,"rendererContext",void 0),(0,r._)([(0,o.MZ)()],w.prototype,"_materials",null),(0,r._)([(0,o.MZ)()],w.prototype,"_localOriginFactory",null),(0,r._)([(0,o.MZ)({readOnly:!0})],w.prototype,"isEmpty",null),(0,r._)([(0,o.MZ)()],w.prototype,"_renderers",void 0),(0,r._)([(0,o.MZ)()],w.prototype,"_geometries",void 0),w=(0,r._)([(0,l.$)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],w);class x{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const C=(0,h.vt)()},59963:(e,t,i)=>{i.d(t,{B:()=>m,a:()=>r,b:()=>p});var r,s=i(29094),n=i(65180),a=i(36781),o=i(57197),l=i(57554),h=i(42403),c=i(16878),d=i(67058),u=i(8118);function p(e){const t=new u.N5,i=t.fragment;if(t.include(o.W),e.background===r.Only){const r=e.output===n.x.ColorComposite;return r?i.uniforms.add(new l.t("backgroundColor",(e=>e.backgroundColor))):i.include(s.z),i.main.add(c.H`fragColor = vec4(${r?c.H`backgroundColor`:c.H`gridColor(uv)`}, 1.0);`),t}return t.include(a.P,e),i.uniforms.add(new d.N("tex",(e=>e.texture)),new h.m("opacity",(e=>e.opacity))),i.main.add(c.H`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),t}!function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(r||(r={}));const m=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return r},build:p},Symbol.toStringTag,{value:"Module"}))},60464:(e,t,i)=>{i.d(t,{g:()=>h});var r=i(7951),s=i(16213),n=i(8375),a=i(4127),o=i(86821),l=i(16878);function h(e,t){const i=e.fragment;switch(t.doubleSidedMode){case o.W.None:i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case o.W.View:e.include(a.em,t),i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case o.W.WindingOrder:i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:(0,r.Xb)(t.doubleSidedMode);case o.W.COUNT:}switch(t.normalType){case s.W.Attribute:case s.W.Compressed:e.include(n.Mh,t),i.main.add(l.H`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case s.W.ScreenDerivative:e.include(a.em,t),i.main.add(l.H`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`);default:case s.W.COUNT:}t.shadeNormals?i.main.add(l.H`vec3 fragmentShadingNormal = fragmentFaceNormal;`):t.spherical?(e.include(a.em,t),i.main.add(l.H`vec3 fragmentShadingNormal = normalize(positionWorld());`)):i.main.add(l.H`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)}},61129:(e,t,i)=>{i.d(t,{C:()=>s,s:()=>n});var r=i(70576);function s(e){return n(e)||(0,r.q8)(e)||(0,r.KQ)(e)}function n(e){return(0,r.oT)(e)||(0,r.x1)(e)}},61642:(e,t,i)=>{i.d(t,{V:()=>n});var r=i(27510),s=i(89475);class n extends s.Y{_createTransforms(){return{displayViewScreenMat3:(0,r.vt)(),tileMat3:(0,r.vt)()}}}},62510:(e,t,i)=>{i.d(t,{e:()=>_,v:()=>g});var r=i(55426),s=i(73982),n=i(96236),a=i(93003),o=i(16434),l=i(71723),h=i(86836),c=i(85645),d=i(92804),u=i(22131),p=i(92156),m=i(12723);class _ extends o.w{constructor(e,t){super(e,t,new a.$(s.C,(()=>i.e(61339).then(i.bind(i,61339)))),g)}initializePipeline(e){const{integratedMeshMode:t,output:i,blendingEnabled:s,cullFace:a,hasOccludees:o,hasPolygonOffset:u,oitPass:_}=e,g=t!==r.g.None,f=_===h.Y.NONE,y=_===h.Y.FrontFace;return(0,m.Ey)({blending:(0,n.RN)(i)&&s?(0,c.Yf)(_):null,culling:(0,m.Xt)(a),depthTest:{func:(0,c.K_)(_)},depthWrite:f||y?m.Uy:null,drawBuffers:i===n.V.Depth?{buffers:[p.Hr.NONE]}:(0,c.m6)(_,i),colorWrite:m.kn,stencilWrite:g||o?d.v0:null,stencilTest:g?(0,d.ub)(l.dd.IntegratedMeshMaskExcluded):o?d.qh:null,polygonOffset:f||y?u?{factor:2,units:2}:null:c.SE})}}const g=new Map([[u.r.POSITION,0],[u.r.NORMAL,1],[u.r.NORMALCOMPRESSED,1],[u.r.COLOR,2],[u.r.UV0,3],[u.r.UVREGION,4],[u.r.COMPONENTINDEX,5]])},62840:(e,t,i)=>{i.d(t,{C:()=>g,b:()=>_});var r=i(31238),s=i(77742),n=i(12796),a=i(11833),o=i(46027),l=i(66652),h=i(42162),c=i(87824),d=i(4241),u=i(16878),p=i(85593),m=i(8118);function _(){const e=new m.N5,{fragment:t}=e;return e.include(p.y,{needUVs:!1,needEyeDirection:!1}),t.include(l.a),t.include(h.W),e.include(r.W,{pbrMode:n.A9.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(a.p),e.include(s.C),e.include(o.g),t.uniforms.add(new c.d("cameraPosition",(e=>e.camera.eye)),new d.U("cloudsOpacity",(e=>e.clouds.opacity))).main.add(u.H`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),e}const g=Object.freeze(Object.defineProperty({__proto__:null,build:_},Symbol.toStringTag,{value:"Module"}))},63034:(e,t,i)=>{i.d(t,{d:()=>b});var r=i(64682),s=i(84190),n=i(87752),a=i(89227),o=i(30142),l=i(54671),h=i(31183),c=i(70075),d=i(18162),u=i(90772),p=i(91345),m=i(28515),_=i(10872),g=i(49943),f=i(1696),y=i(49807),v=i(51064);class b{constructor(e,t,i,r){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this._coordinateSystem=r,this._tmpCoordinateSystem=(0,m.vt)(r),this.referenceEllipsoid=(0,o.tO)(t),this.sphericalPCPF=(0,l.lO)(t)}set extent(e){e&&(0,m.b)(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return(0,m.Z7)(this._coordinateSystem,(0,u.vt)())}getAltitude(e){return(0,m.US)(this._coordinateSystem,e)}setAltitude(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return(0,m.E$)(this._coordinateSystem,i,t,e)}setAltitudeOfTransformation(e,t){(0,m.Jq)(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return(0,m.jI)(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,i){return(0,m.vf)(this._coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,p._.X,f.rq.get()),r=this.worldBasisAtPosition(e,p._.Y,f.rq.get()),s=this.worldBasisAtPosition(e,p._.Z,f.rq.get());return(0,n.hZ)(t,i[0],i[1],i[2],0,r[0],r[1],r[2],0,s[0],s[1],s[2],0,0,0,0,1),t}headingAtPosition(e,t){const i=this.worldUpAtPosition(e,f.rq.get()),s=this.worldBasisAtPosition(e,p._.Y,f.rq.get()),n=(0,g.EJ)(t,s,i);return(0,r.KJ)(n)}intersectManifoldClosestSilhouette(e,t,i){return(0,m.xW)(this._coordinateSystem,t,this._tmpCoordinateSystem),(0,m.lt)(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,t,i){(0,m.xW)(this._coordinateSystem,t,this._tmpCoordinateSystem);const r=f.rq.get();return(0,m.Ui)(this._tmpCoordinateSystem,e,r)?(0,a.c)(i,r):null}intersectInfiniteManifold(e,t,i){if(this.viewingMode===v.RT.Global)return this.intersectManifold(e,t,i);(0,m.xW)(this._coordinateSystem,t,this._tmpCoordinateSystem);const r=this._tmpCoordinateSystem.value,s=f.rq.get();return(0,_.Ui)(r.plane,e,s)?(0,a.c)(i,s):null}toRenderCoords(e,t,i){return(0,y.v)(e)?(0,h.g)(e,t,this.spatialReference):(0,d.F)(e,t,i,this.spatialReference)}fromRenderCoords(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,y.v)(t)?(null!=i&&(t.spatialReference=i),(0,c.E)(e,this.spatialReference,t)?t:null):(0,d.F)(e,this.spatialReference,t,i)?t:null}static create(e,t){switch(e){case v.RT.Local:return new b(v.RT.Local,t,(0,s.GA)(t),(0,m.oJ)());case v.RT.Global:return new b(v.RT.Global,t,1,(0,m.Sj)(t))}}static renderUnitScaleFactor(e,t){return(0,s.KX)(e)/(0,s.KX)(t)}}},63643:(e,t,i)=>{i.r(t),i.d(t,{default:()=>h});var r,s=i(93800),n=i(19455),a=i(48602),o=(i(21265),i(50925),i(14746),i(75269));let l=r=class extends n.A{constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new r(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};(0,s._)([(0,a.MZ)({readOnly:!0,type:["virtual"],json:{write:{isRequired:!0}}})],l.prototype,"type",void 0),(0,s._)([(0,a.MZ)({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],l.prototype,"directShadowsEnabled",void 0),l=r=(0,s._)([(0,o.$)("esri.webscene.VirtualLighting")],l);const h=l},63831:(e,t,i)=>{i.d(t,{D:()=>r,S:()=>s});class r{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}}class s{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}},64855:(e,t,i)=>{i.d(t,{O3:()=>o,Ox:()=>l,bR:()=>n,dC:()=>r});var r,s;!function(e){e[e.Unknown=0]="Unknown",e[e.Point=1]="Point",e[e.LineString=2]="LineString",e[e.Polygon=3]="Polygon"}(r||(r={}));class n{constructor(e,t){this.x=e,this.y=t}clone(){return new n(this.x,this.y)}equals(e,t){return e===this.x&&t===this.y}isEqual(e){return e.x===this.x&&e.y===this.y}setCoords(e,t){return this.x=e,this.y=t,this}normalize(){const e=this.x,t=this.y,i=Math.sqrt(e*e+t*t);return this.x/=i,this.y/=i,this}rightPerpendicular(){const e=this.x;return this.x=this.y,this.y=-e,this}leftPerpendicular(){const e=this.x;return this.x=-this.y,this.y=e,this}move(e,t){return this.x+=e,this.y+=t,this}assign(e){return this.x=e.x,this.y=e.y,this}assignAdd(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}assignSub(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}rotate(e,t){const i=this.x,r=this.y;return this.x=i*e-r*t,this.y=i*t+r*e,this}scale(e){return this.x*=e,this.y*=e,this}length(){const e=this.x,t=this.y;return Math.sqrt(e*e+t*t)}sub(e){return this.x-=e.x,this.y-=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}static distance(e,t){const i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}static add(e,t){return new n(e.x+t.x,e.y+t.y)}static sub(e,t){return new n(e.x-t.x,e.y-t.y)}}class a{constructor(e,t,i){this.ratio=e,this.x=t,this.y=i}}class o{constructor(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=r,this._pixelMargin=s,this._tileSize=512*r,this._dz=e,this._yPos=t,this._xPos=i}setPixelMargin(e){e!==this._pixelMargin&&(this._pixelMargin=e,this.setExtent(this._extent))}setExtent(e){this._extent=e,this._finalRatio=this._tileSize/e*(1<<this._dz);let t=this._pixelRatio*this._pixelMargin;t/=this._finalRatio;const i=e>>this._dz;t>i&&(t=i),this._margin=t,this._xmin=i*this._xPos-t,this._ymin=i*this._yPos-t,this._xmax=this._xmin+i+2*t,this._ymax=this._ymin+i+2*t}reset(e){this._type=e,this._lines=[],this._starts=[],this._line=null,this._start=0}moveTo(e,t){this._pushLine(),this._prevIsIn=this._isIn(e,t),this._moveTo(e,t,this._prevIsIn),this._prevPt=new n(e,t),this._firstPt=new n(e,t),this._dist=0}lineTo(e,t){const i=this._isIn(e,t),r=new n(e,t),s=n.distance(this._prevPt,r);let o,l,h,c,d,u,p,m;if(i)this._prevIsIn?this._lineTo(e,t,!0):(o=this._prevPt,l=r,h=this._intersect(l,o),this._start=this._dist+s*(1-this._r),this._lineTo(h.x,h.y,!0),this._lineTo(l.x,l.y,!0));else if(this._prevIsIn)l=this._prevPt,o=r,h=this._intersect(l,o),this._lineTo(h.x,h.y,!0),this._lineTo(o.x,o.y,!1);else{const e=this._prevPt,t=r;if(e.x<=this._xmin&&t.x<=this._xmin||e.x>=this._xmax&&t.x>=this._xmax||e.y<=this._ymin&&t.y<=this._ymin||e.y>=this._ymax&&t.y>=this._ymax)this._lineTo(t.x,t.y,!1);else{const i=[];if((e.x<this._xmin&&t.x>this._xmin||e.x>this._xmin&&t.x<this._xmin)&&(c=(this._xmin-e.x)/(t.x-e.x),m=e.y+c*(t.y-e.y),m<=this._ymin?u=!1:m>=this._ymax?u=!0:i.push(new a(c,this._xmin,m))),(e.x<this._xmax&&t.x>this._xmax||e.x>this._xmax&&t.x<this._xmax)&&(c=(this._xmax-e.x)/(t.x-e.x),m=e.y+c*(t.y-e.y),m<=this._ymin?u=!1:m>=this._ymax?u=!0:i.push(new a(c,this._xmax,m))),(e.y<this._ymin&&t.y>this._ymin||e.y>this._ymin&&t.y<this._ymin)&&(c=(this._ymin-e.y)/(t.y-e.y),p=e.x+c*(t.x-e.x),p<=this._xmin?d=!1:p>=this._xmax?d=!0:i.push(new a(c,p,this._ymin))),(e.y<this._ymax&&t.y>this._ymax||e.y>this._ymax&&t.y<this._ymax)&&(c=(this._ymax-e.y)/(t.y-e.y),p=e.x+c*(t.x-e.x),p<=this._xmin?d=!1:p>=this._xmax?d=!0:i.push(new a(c,p,this._ymax))),0===i.length)d?u?this._lineTo(this._xmax,this._ymax,!0):this._lineTo(this._xmax,this._ymin,!0):u?this._lineTo(this._xmin,this._ymax,!0):this._lineTo(this._xmin,this._ymin,!0);else if(i.length>1&&i[0].ratio>i[1].ratio)this._start=this._dist+s*i[1].ratio,this._lineTo(i[1].x,i[1].y,!0),this._lineTo(i[0].x,i[0].y,!0);else{this._start=this._dist+s*i[0].ratio;for(let e=0;e<i.length;e++)this._lineTo(i[e].x,i[e].y,!0)}this._lineTo(t.x,t.y,!1)}}this._dist+=s,this._prevIsIn=i,this._prevPt=r}close(){if(this._line.length>2){const e=this._firstPt,t=this._prevPt;e.x===t.x&&e.y===t.y||this.lineTo(e.x,e.y);const i=this._line;let r=i.length;for(;r>=4&&(i[0].x===i[1].x&&i[0].x===i[r-2].x||i[0].y===i[1].y&&i[0].y===i[r-2].y);)i.pop(),i[0].x=i[r-2].x,i[0].y=i[r-2].y,--r}}result(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._pushLine(),0===this._lines.length?null:(this._type===r.Polygon&&e&&h.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)}resultWithStarts(){if(this._type!==r.LineString)throw new Error("Only valid for lines");this._pushLine();const e=this._lines,t=e.length;if(0===t)return null;const i=[];for(let r=0;r<t;r++)i.push({line:e[r],start:this._starts[r]||0});return i}_isIn(e,t){return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}_intersect(e,t){let i,r,s;if(t.x>=this._xmin&&t.x<=this._xmax)r=t.y<=this._ymin?this._ymin:this._ymax,s=(r-e.y)/(t.y-e.y),i=e.x+s*(t.x-e.x);else if(t.y>=this._ymin&&t.y<=this._ymax)i=t.x<=this._xmin?this._xmin:this._xmax,s=(i-e.x)/(t.x-e.x),r=e.y+s*(t.y-e.y);else{r=t.y<=this._ymin?this._ymin:this._ymax,i=t.x<=this._xmin?this._xmin:this._xmax;const n=(i-e.x)/(t.x-e.x),a=(r-e.y)/(t.y-e.y);n<a?(s=n,r=e.y+n*(t.y-e.y)):(s=a,i=e.x+a*(t.x-e.x))}return this._r=s,new n(i,r)}_pushLine(){this._line&&(this._type===r.Point?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===r.LineString?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===r.Polygon&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0}_moveTo(e,t,i){this._type!==r.Polygon?i&&(e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.push(new n(e,t))):(i||(e<this._xmin&&(e=this._xmin),e>this._xmax&&(e=this._xmax),t<this._ymin&&(t=this._ymin),t>this._ymax&&(t=this._ymax)),e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.push(new n(e,t)),this._isH=!1,this._isV=!1)}_lineTo(e,t,i){let s,a;if(this._type!==r.Polygon)if(i){if(e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(s=this._line[this._line.length-1],s.equals(e,t)))return;this._line.push(new n(e,t))}else this._line&&this._line.length>0&&this._pushLine();else if(i||(e<this._xmin&&(e=this._xmin),e>this._xmax&&(e=this._xmax),t<this._ymin&&(t=this._ymin),t>this._ymax&&(t=this._ymax)),e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){s=this._line[this._line.length-1];const i=s.x===e,r=s.y===t;if(i&&r)return;this._isH&&i||this._isV&&r?(s.x=e,s.y=t,a=this._line[this._line.length-2],a.x===e&&a.y===t?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(a=this._line[this._line.length-2],this._isH=a.x===e,this._isV=a.y===t)):(this._isH=a.x===e,this._isV=a.y===t)):(this._line.push(new n(e,t)),this._isH=i,this._isV=r)}else this._line.push(new n(e,t))}}class l{setExtent(e){this._ratio=4096===e?1:4096/e}get validateTessellation(){return this._ratio<1}reset(e){this._lines=[],this._line=null}moveTo(e,t){this._line&&this._lines.push(this._line),this._line=[];const i=this._ratio;this._line.push(new n(e*i,t*i))}lineTo(e,t){const i=this._ratio;this._line.push(new n(e*i,t*i))}close(){const e=this._line;e&&!e[0].isEqual(e[e.length-1])&&e.push(e[0])}result(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines}}!function(e){e[e.sideLeft=0]="sideLeft",e[e.sideRight=1]="sideRight",e[e.sideTop=2]="sideTop",e[e.sideBottom=3]="sideBottom"}(s||(s={}));class h{static simplify(e,t,i){if(!i)return;const r=-t,n=e+t,a=-t,o=e+t,l=[],c=[],d=i.length;for(let h=0;h<d;++h){const e=i[h];if(!e||e.length<2)continue;let t,d=e[0];const u=e.length;for(let i=1;i<u;++i)t=e[i],d.x===t.x&&(d.x<=r&&(d.y>t.y?(l.push(h),l.push(i),l.push(s.sideLeft),l.push(-1)):(c.push(h),c.push(i),c.push(s.sideLeft),c.push(-1))),d.x>=n&&(d.y<t.y?(l.push(h),l.push(i),l.push(s.sideRight),l.push(-1)):(c.push(h),c.push(i),c.push(s.sideRight),c.push(-1)))),d.y===t.y&&(d.y<=a&&(d.x<t.x?(l.push(h),l.push(i),l.push(s.sideTop),l.push(-1)):(c.push(h),c.push(i),c.push(s.sideTop),c.push(-1))),d.y>=o&&(d.x>t.x?(l.push(h),l.push(i),l.push(s.sideBottom),l.push(-1)):(c.push(h),c.push(i),c.push(s.sideBottom),c.push(-1)))),d=t}if(0===l.length||0===c.length)return;h.fillParent(i,c,l),h.fillParent(i,l,c);const u=[];h.calcDeltas(u,c,l),h.calcDeltas(u,l,c),h.addDeltas(u,i)}static fillParent(e,t,i){const r=i.length,n=t.length;for(let a=0;a<n;a+=4){const n=t[a],o=t[a+1],l=t[a+2],h=e[n][o-1],d=e[n][o];let u=8092,p=-1;for(let t=0;t<r;t+=4){if(i[t+2]!==l)continue;const r=i[t],n=i[t+1],a=e[r][n-1],o=e[r][n];switch(l){case s.sideLeft:case s.sideRight:if(c(h.y,a.y,o.y)&&c(d.y,a.y,o.y)){const e=Math.abs(o.y-a.y);e<u&&(u=e,p=t)}break;case s.sideTop:case s.sideBottom:if(c(h.x,a.x,o.x)&&c(d.x,a.x,o.x)){const e=Math.abs(o.x-a.x);e<u&&(u=e,p=t)}}}t[a+3]=p}}static calcDeltas(e,t,i){const r=t.length;for(let s=0;s<r;s+=4){const r=[],n=h.calcDelta(s,t,i,r);e.push(t[s]),e.push(t[s+1]),e.push(t[s+2]),e.push(n)}}static calcDelta(e,t,i,r){const s=t[e+3];if(-1===s)return 0;const n=r.length;return n>1&&r[n-2]===s?0:(r.push(s),h.calcDelta(s,i,t,r)+1)}static addDeltas(e,t){const i=e.length;let r=0;for(let s=0;s<i;s+=4){const t=e[s+3];t>r&&(r=t)}for(let n=0;n<i;n+=4){const i=t[e[n]],a=e[n+1],o=r-e[n+3];switch(e[n+2]){case s.sideLeft:i[a-1].x-=o,i[a].x-=o,1===a&&(i[i.length-1].x-=o),a===i.length-1&&(i[0].x-=o);break;case s.sideRight:i[a-1].x+=o,i[a].x+=o,1===a&&(i[i.length-1].x+=o),a===i.length-1&&(i[0].x+=o);break;case s.sideTop:i[a-1].y-=o,i[a].y-=o,1===a&&(i[i.length-1].y-=o),a===i.length-1&&(i[0].y-=o);break;case s.sideBottom:i[a-1].y+=o,i[a].y+=o,1===a&&(i[i.length-1].y+=o),a===i.length-1&&(i[0].y+=o)}}}}const c=(e,t,i)=>e>=t&&e<=i||e>=i&&e<=t},65180:(e,t,i)=>{var r;i.d(t,{x:()=>r}),function(e){e[e.Composite=0]="Composite",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.GroupBackgroundComposite=3]="GroupBackgroundComposite",e[e.COUNT=4]="COUNT"}(r||(r={}))},66027:(e,t,i)=>{i.d(t,{C:()=>r,a:()=>a});var r,s=i(93800),n=i(21484);!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends n.K{constructor(){super(...arguments),this.type=r.Rain}}(0,s._)([(0,n.W)({count:r.COUNT})],a.prototype,"type",void 0)},67296:(e,t,i)=>{i.d(t,{A:()=>h,a:()=>d,b:()=>c});var r=i(37379),s=i(16878),n=i(73712),a=i(67058),o=i(20783),l=i(8118);class h extends o.Y{}function c(){const e=new l.N5;return e.include(r.c),e.fragment.uniforms.add(new a.N("colorTexture",(e=>e.color)),new n.x("depthTexture",(e=>e.mainDepth))),e.fragment.main.add(s.H`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const d=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:h,build:c},Symbol.toStringTag,{value:"Module"}))},68312:(e,t,i)=>{i.r(t),i.d(t,{default:()=>bx});var r=i(93800),s=i(29306),n=i(99104),a=i(89129),o=i(31396),l=i(74719),h=i(63160),c=i(42198),d=i(21265),u=i(50925),p=i(17741),m=i(30151),_=i(49959),g=i(79953),f=i(7187),y=i(16804),v=i(84190),b=i(34037),w=i(48602),x=i(32980),C=(i(14746),i(75269)),T=i(80556),M=i(6946),S=i(70605),R=i(83497);function A(e,t){const i=(0,R.oY)(e),r=(0,R.oY)(t),s=i.store,n=r.store,a=r.metadata;for(const o in a){const t=a[o],i=s.originOf(o),r=n.originOf(o);if(!t.readOnly&&r!==S.Gr.DEFAULTS)if(i===S.Gr.DEFAULTS)e.set(o,n.get(o));else{const e=s.get(o),t=n.get(o);e&&t&&t instanceof M.default&&e instanceof M.default&&e instanceof t.constructor&&A(e,t)}}}var E=i(28473),O=i(21),P=i(12560),D=i(82770),I=i(75400),L=i(96913),N=i(93321),H=i(69681),F=i(31183),V=i(90772),U=i(25071),z=i(28515),G=i(11099),q=i(78076),k=i(65655),B=i(45845),W=i(56945),Z=i(13141),j=i(4128),$=i(54815),Q=i(39379),Y=i(84249),X=i(51064);const K=()=>Promise.all([i.e(7736),i.e(26386)]).then(i.bind(i,26386)),J=()=>i.e(13723).then(i.bind(i,13723)),ee={"base-dynamic":()=>Promise.all([i.e(88483),i.e(76752)]).then(i.bind(i,76752)),"base-elevation":J,"base-tile":K,"bing-maps":K,"building-scene":()=>Promise.all([i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(69270),i.e(60071),i.e(17055),i.e(75031),i.e(66076),i.e(86300),i.e(7572)]).then(i.bind(i,7572)),catalog:()=>i.e(56483).then(i.bind(i,56483)),"catalog-dynamic-group":()=>i.e(83135).then(i.bind(i,83135)),"catalog-footprint":()=>Promise.all([i.e(29071),i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(60071),i.e(66836),i.e(36393),i.e(88173),i.e(26324),i.e(81596)]).then(i.bind(i,81596)),csv:()=>Promise.all([i.e(29071),i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(60071),i.e(66836),i.e(36393),i.e(88173),i.e(26324),i.e(65430)]).then(i.bind(i,65430)),dimension:()=>i.e(3974).then(i.bind(i,3974)),elevation:J,feature:()=>Promise.all([i.e(29071),i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(60071),i.e(66836),i.e(36393),i.e(88173),i.e(26324),i.e(27592)]).then(i.bind(i,27592)),geojson:()=>Promise.all([i.e(29071),i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(60071),i.e(66836),i.e(36393),i.e(88173),i.e(26324),i.e(63803)]).then(i.bind(i,63803)),graphics:()=>Promise.all([i.e(60071),i.e(66836),i.e(53417)]).then(i.bind(i,53417)),group:()=>i.e(56991).then(i.bind(i,56991)),imagery:()=>Promise.all([i.e(90801),i.e(88483),i.e(534)]).then(i.bind(i,534)),"integrated-mesh":()=>Promise.all([i.e(69270),i.e(60071),i.e(75031),i.e(66076),i.e(85354)]).then(i.bind(i,85354)),"integrated-mesh-3dtiles":()=>i.e(63162).then(i.bind(i,63162)),"line-of-sight":()=>i.e(67638).then(i.bind(i,67638)),"map-image":()=>Promise.all([i.e(88483),i.e(7736),i.e(74643)]).then(i.bind(i,74643)),media:()=>Promise.all([i.e(30124),i.e(24368),i.e(62791),i.e(9484)]).then(i.bind(i,59865)),"ogc-feature":()=>Promise.all([i.e(29071),i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(60071),i.e(66836),i.e(36393),i.e(88173),i.e(26324),i.e(52947)]).then(i.bind(i,52947)),"open-street-map":K,"oriented-imagery":()=>Promise.all([i.e(29071),i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(60071),i.e(66836),i.e(36393),i.e(88173),i.e(26324),i.e(27592)]).then(i.bind(i,27592)),"point-cloud":()=>Promise.all([i.e(69270),i.e(22214),i.e(25910)]).then(i.bind(i,25910)),viewshed:()=>i.e(18211).then(i.bind(i,18211)),voxel:()=>i.e(59462).then(i.bind(i,37081)),route:()=>Promise.all([i.e(60071),i.e(66836),i.e(7317)]).then(i.bind(i,7317)),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?Promise.all([i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(69270),i.e(60071),i.e(75031),i.e(66076),i.e(86300),i.e(34993),i.e(4534)]).then(i.bind(i,4534)):Promise.all([i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(69270),i.e(60071),i.e(66836),i.e(36393),i.e(75031),i.e(34993),i.e(54124)]).then(i.bind(i,28450)),stream:()=>Promise.all([i.e(29071),i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(60071),i.e(66836),i.e(36393),i.e(88173),i.e(83988),i.e(84747)]).then(i.bind(i,31516)),tile:K,"imagery-tile":()=>Promise.all([i.e(90801),i.e(74363)]).then(i.bind(i,74363)),"vector-tile":()=>Promise.all([i.e(26965),i.e(22210),i.e(58714),i.e(44692),i.e(5039)]).then(i.bind(i,5039)),wcs:()=>Promise.all([i.e(90801),i.e(74363)]).then(i.bind(i,74363)),"web-tile":K,wfs:()=>Promise.all([i.e(29071),i.e(68584),i.e(75106),i.e(60897),i.e(13791),i.e(60071),i.e(66836),i.e(36393),i.e(88173),i.e(26324),i.e(11108)]).then(i.bind(i,11108)),wms:()=>Promise.all([i.e(88483),i.e(29681)]).then(i.bind(i,29681)),wmts:()=>i.e(46609).then(i.bind(i,46609)),parquet:null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};const te=e=>null!=ee[e.type],ie=e=>{const t=ee[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new l.default(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)};var re=i(58828);const se="analyses-owner-handles";var ne,ae;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(ne||(ne={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(ae||(ae={}));let oe=class extends M.default{constructor(e){super(e),this._allAnalysisViews=new a.default,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=le(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,_.createAbortError)("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,_.createAbortError)()),this._attachedToViewResolver=le()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||t.state.list===ae.REMOVED)throw new l.default("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),se)}_disconnectOwners(){this.removeHandles(se),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const r of e)this._addAnalysis(r);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),i=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return(0,c.hA)((()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)}))}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:ne.PENDING,list:ae.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=(0,re.UT)((e=>this._createAnalysisViewPromise(t,e)))}else t.state.list=ae.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=ae.REMOVED,this._scheduleUpdate()):u.A.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=(0,f.schedule)((()=>this._update())))}_update(){this._scheduledUpdateHandle=(0,p.xt)(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list===ae.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case ne.PENDING:e.createAnalysisViewTask=(0,p.DC)(e.createAnalysisViewTask);break;case ne.CREATED:null!=e.view&&(this._allAnalysisViews.remove(e.view),e.view=(0,p.pR)(e.view),e.createAnalysisViewTask=null)}}))}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,null==s.module)try{s.module=await this._loadAnalysisModule(r)}catch(o){throw this._creatingViewCount-=1,o}if((0,_.isAborted)(t))throw this._creatingViewCount-=1,(0,_.createAbortError)("AnalysisView creation aborted");const n=new s.module.default({analysis:i,view:this.view});let a=!0;(0,_.onAbort)(t,(()=>{a&&(this._creatingViewCount-=1,n.destroy())}));try{await n.when()}catch(o){throw a=!1,n.destroyed||(this._creatingViewCount-=1,n.destroy()),o}if((0,_.isAborted)(t))throw(0,_.createAbortError)();return a=!1,e.view=n,e.state.view=ne.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return Promise.all([i.e(30124),i.e(31329),i.e(58005),i.e(92189),i.e(95792)]).then(i.bind(i,14306));case"dimension":return Promise.all([i.e(30124),i.e(31329),i.e(24368),i.e(67439),i.e(62791),i.e(70082),i.e(48261),i.e(58005),i.e(85090),i.e(61018),i.e(92189),i.e(14020),i.e(55408)]).then(i.bind(i,38829));case"direct-line-measurement":return Promise.all([i.e(31329),i.e(58005),i.e(92189),i.e(7339)]).then(i.bind(i,42924));case"line-of-sight":return Promise.all([i.e(30124),i.e(70082),i.e(48261),i.e(50312)]).then(i.bind(i,58878));case"slice":return Promise.all([i.e(30124),i.e(69270),i.e(70082),i.e(17055),i.e(67754),i.e(65243)]).then(i.bind(i,6200));case"viewshed":return Promise.all([i.e(30124),i.e(70082),i.e(48261),i.e(85090),i.e(81239),i.e(26284)]).then(i.bind(i,85522))}}};function le(){const e=(0,_.createResolver)();return e.promise.catch((()=>{})),e}(0,r._)([(0,w.MZ)()],oe.prototype,"updating",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],oe.prototype,"view",void 0),(0,r._)([(0,w.MZ)()],oe.prototype,"_allAnalysisViews",void 0),(0,r._)([(0,w.MZ)()],oe.prototype,"_creatingViewCount",void 0),oe=(0,r._)([(0,C.$)("esri.views.3d.analysis.AnalysisViewManager3D")],oe);const he=oe;var ce=i(85715),de=i(64682),ue=i(23311),pe=i(11741);let me=class extends M.default{constructor(e){super(e),this.collision=new ye,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===X.RT.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==X.RT.Local?this._set("altitude",e):u.A.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?(0,de.qE)(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return(0,de.qE)(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===X.RT.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fe;return i.min=ge.min,i.max=e,i}}_createDefaultTiltLocal(){const e=this.collision.enabled?(0,pe.su)([[4e3,ge.max],[1e4,(0,de.kU)(88)],[6e6,(0,de.kU)(88)]]):()=>ge.max;return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fe;return i.min=ge.min,i.max=e(t),i}}_createDefaultTiltGlobal(){const e=this.collision.enabled?(0,pe.su)([[4e3,ge.max],[5e4,(0,de.kU)(88)],[6e6,(0,de.kU)(88)],[2e7,ge.min]]):(0,pe.su)([[3e5,ge.max],[3e6,(0,de.kU)(88)],[6e6,(0,de.kU)(88)],[2e7,ge.min]]);return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fe;return i.min=ge.min,i.max=e(t),i}}};(0,r._)([(0,w.MZ)()],me.prototype,"altitude",null),(0,r._)([(0,w.MZ)({readOnly:!0})],me.prototype,"collision",void 0),(0,r._)([(0,w.MZ)()],me.prototype,"distance",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],me.prototype,"minimumPoiDistance",void 0),(0,r._)([(0,w.MZ)()],me.prototype,"tilt",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],me.prototype,"state",void 0),me=(0,r._)([(0,C.$)("esri.views.3d.state.Constraints")],me);const _e=function(e){return{min:-2e5,max:4*e.radius}}(ue.$O),ge={min:(0,de.kU)(.5),max:(0,de.kU)(179.5)},fe={min:0,max:0};let ye=class extends M.default{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};(0,r._)([(0,w.MZ)({type:Boolean})],ye.prototype,"enabled",void 0),(0,r._)([(0,w.MZ)({type:Number})],ye.prototype,"elevationMargin",void 0),ye=(0,r._)([(0,C.$)("esri.views.3d.state.Constraints.CollisionConstraint")],ye);let ve=class extends ce.A{constructor(){super(...arguments),this.min=_e.min,this.max=_e.max}};(0,r._)([(0,w.MZ)({type:Number})],ve.prototype,"min",void 0),(0,r._)([(0,w.MZ)({type:Number})],ve.prototype,"max",void 0),ve=(0,r._)([(0,C.$)("esri.views.3d.constraints.AltitudeConstraint")],ve);let be=class extends ce.A{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};(0,r._)([(0,w.MZ)({type:Number,value:1e-8})],be.prototype,"near",null),(0,r._)([(0,x.w)("near")],be.prototype,"castNear",null),(0,r._)([(0,w.MZ)({type:Number,value:1e-8})],be.prototype,"far",null),(0,r._)([(0,x.w)("far")],be.prototype,"castFar",null),(0,r._)([(0,w.MZ)({type:["auto","manual"]})],be.prototype,"mode",void 0),be=(0,r._)([(0,C.$)("esri.views.3d.constraints.ClipDistanceConstraint")],be);const we={min:(0,de.KJ)(ge.min),max:(0,de.KJ)(ge.max)};let xe=class extends ce.A{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return(0,de.qE)(e,we.min,we.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};(0,r._)([(0,w.MZ)({type:["auto","manual"]})],xe.prototype,"mode",void 0),(0,r._)([(0,w.MZ)({type:Number,value:we.max})],xe.prototype,"max",null),(0,r._)([(0,x.w)("max")],xe.prototype,"castMax",null),xe=(0,r._)([(0,C.$)("esri.views.3d.constraints.TiltConstraint")],xe);let Ce=class extends ce.A{constructor(e){super(e),this.tilt=new xe,this.altitude=new ve,this.clipDistance=new be}};(0,r._)([(0,w.MZ)({type:xe})],Ce.prototype,"tilt",void 0),(0,r._)([(0,w.MZ)({type:ve})],Ce.prototype,"altitude",void 0),(0,r._)([(0,w.MZ)({type:be})],Ce.prototype,"clipDistance",void 0),Ce=(0,r._)([(0,C.$)("esri.views.3d.constraints.Constraints")],Ce);var Te=i(58448),Me=i(89227),Se=i(54671),Re=i(70576),Ae=i(78757);function Ee(e){return(0,Re.aI)(e,Se.AI)||(0,Re.q8)(e)?{wkid:Ae.Y.GCSMARS2000}:(0,Re.aI)(e,Se.WR)||(0,Re.KQ)(e)?{wkid:Ae.Y.GCSMOON2000}:N.default.WGS84}var Oe=i(20889),Pe=i(30142),De=i(92212),Ie=i(1396);class Le{constructor(e,t,i,r,s,n,a,o){let l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:.5;this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=s,this.smoothness=n,this.cloudHeight=a,this.raymarchingSteps=o,this.median=l}}const Ne={sunny:new Le([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],Ie.p.SIXTEEN),cloudy:new Le([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],Ie.p.TWOHUNDRED,.6),rainy:new Le([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],Ie.p.TWOHUNDRED,.4),snowy:new Le([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],Ie.p.HUNDRED,.65),foggy:new Le([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],Ie.p.SIXTEEN)};Ne.default=Ne.sunny;var He=i(7951),Fe=i(67965),Ve=i(87752),Ue=i(10382),ze=i(32006),Ge=i(98080),qe=i(90030),ke=i(48672),Be=i(93003),We=i(16434),Ze=i(92156),je=i(12723);class $e extends We.w{constructor(e,t){super(e,t,new Be.$(ke.a,(()=>i.e(38012).then(i.bind(i,15631)))))}initializePipeline(e){return(0,je.Ey)({blending:(0,je.ox)(Ze.dn.CONSTANT_COLOR,Ze.dn.ONE_MINUS_CONSTANT_COLOR,Ze.Tb.ADD,e.writeTextureChannels===De.c.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Ze.MT.LEQUAL},colorWrite:je.kn})}}var Qe=i(98016),Ye=i(18484),Xe=i(3145);class Ke extends We.w{constructor(e,t){super(e,t,new Be.$(Qe.a,(()=>i.e(78708).then(i.bind(i,78708)))))}initializePipeline(e){return(0,je.Ey)({blending:e.mode===Ye.L.Full?je.fg:(0,je.p3)(Ze.dn.ZERO,Ze.dn.ONE,Ze.dn.ONE,Ze.dn.ZERO),depthTest:{func:Ze.MT.ALWAYS},colorWrite:je.kn})}}var Je=i(82350),et=i(77936);let tt=class extends M.default{constructor(e){super(e),this._needsRender=!0,this._passParameters=new Qe.N,this._configuration=new Ye.F,this._fbo=new Je.H(e.context.renderContext.rctx,new et.R(Xe.jj)),e.context.techniques.precompile(Ke,new Ye.F);const t=new Ye.F;t.mode=Ye.L.WeatherMap,e.context.techniques.precompile(Ke,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?Ye.L.WeatherMap:Ye.L.Full;const e=this.context.techniques.get(Ke,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){(0,ze.aI)(this._passParameters.weatherTile,e)||((0,ze.C)(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=(0,p.WD)(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,i=t.getViewport();return t.setViewport(0,0,Xe.jj,Xe.jj),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};(0,r._)([(0,w.MZ)({constructOnly:!0})],tt.prototype,"context",void 0),tt=(0,r._)([(0,C.$)("esri.views.3d.environment.NoiseTextureAtlas")],tt);var it=i(19565),rt=i(38729);let st=class extends M.default{constructor(e){super(e),this._state=(0,Oe.v)(De.tf.Idle),this._passParameters=new ke.C,this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this._tilesPerFace=1,this.coverage=(0,de.Cc)(Ne.default.coverage[0],Ne.default.coverage[1],.5),this.density=(0,de.Cc)(Ne.default.density[0],Ne.default.density[1],.5),this.absorption=(0,de.Cc)(Ne.default.absorption[0],Ne.default.absorption[1],.5),this.cloudSize=(0,de.Cc)(Ne.default.cloudSize[0],Ne.default.cloudSize[1],.5),this.detailSize=(0,de.Cc)(Ne.default.detailSize[0],Ne.default.detailSize[1],.5),this.smoothness=(0,de.Cc)(Ne.default.smoothness[0],Ne.default.smoothness[1],.5),this.cloudHeight=(0,de.Cc)(Ne.default.cloudHeight[0],Ne.default.cloudHeight[1],.5),this.raymarchingSteps=Ne.default.raymarchingSteps,this._viewMatrix=(0,Ue.vt)(),this._dirty=!0,this.running=!0,this._configuration=new Ie.H}initialize(){const e=(0,Pe.tO)(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(it.W6.CLOUDS_GENERATOR,this),(0,g.watch)((()=>this.coverage),t,g.initial),(0,g.watch)((()=>this.density),t,g.initial),(0,g.watch)((()=>this.absorption),t,g.initial),(0,g.watch)((()=>this.cloudSize),t,g.initial),(0,g.watch)((()=>this.detailSize),t,g.initial),(0,g.watch)((()=>this.smoothness),t,g.initial),(0,g.watch)((()=>this.cloudHeight),t,g.initial),(0,g.watch)((()=>this.raymarchingSteps),t,g.initial)]);const i=(0,Ge.o8)(this._computeWeatherTile());let r=0;this.addHandles((0,g.watch)((()=>{const e=this._computeWeatherTile();return(0,ze.aI)(i,e)||(++r,(0,ze.C)(i,e)),r}),t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=(0,p.pR)(this._passParameters.noiseTexture)}_precompileTechniques(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=De.c.RG,this.context.techniques.precompile($e,this._configuration),this._configuration.writeTextureChannels=De.c.BA,this.context.techniques.precompile($e,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case Ie.p.SIXTEEN:this._tilesPerFace=1;break;case Ie.p.HUNDRED:this._tilesPerFace=4;break;case Ie.p.COUNT:case Ie.p.TWOHUNDRED:this._tilesPerFace=8;break;default:(0,He.Xb)(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get($e,this._configuration)}_computeWeatherTile(){const{camera:e,environment:t}=this.view,{latitude:i,longitude:r}=e.position;if(null==i||null==r)return Ge.uY;(0,ze.hZ)(lt,(i+90)/180,(r+180)/360);const s=Math.floor(this._weatherTileCount*Math.abs(2*lt[0]-1));lt[0]=Math.floor(2*this._weatherTileCount*lt[0]),lt[1]=Math.floor(4*(this._weatherTileCount-s)*lt[1]);let n=0,a=0;if("virtual"!==t?.lighting?.type&&null!=t?.lighting?.date){const e=new Date(t.lighting.date);e.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),n=31*e.getUTCMonth()+e.getUTCDate(),a=e.getUTCFullYear()}return lt[0]=(lt[0]+n)%(2*this._weatherTileCount),lt[1]=(lt[1]+a%100)%(4*this._weatherTileCount),lt}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new tt({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(null==this._fbo){const i=new et.R(e);i.target=Ze.Ap.TEXTURE_CUBE_MAP,i.wrapMode=Ze.pF.CLAMP_TO_EDGE,this._fbo=new Je.H(t,i),this.parameters.data=this}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=(0,p.WD)(this._fbo),this.parameters.data=null}applyPreset(e,t){const i=e.median,r=e=>{const r=(0,de.Cc)(e[0],e[1],i);return t<.5?(0,de.Cc)(e[0],r,2*t):(0,de.Cc)(r,e[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompileTechniques()}setDirty(){this._dirty=this.running=!0}runTask(e){if(this.state===De.tf.Fading)return rt.G;this._dirty&&(this._faceIndex=this._tileIndex=0,this.state=De.tf.Rendering,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return rt.G;const i=nt[this._faceIndex],r=at[this._faceIndex];(0,Ve.xI)(this._viewMatrix,ot,i,r),(0,Fe.z0)(this._passParameters.viewMatrix,this._viewMatrix);const s=this.context.renderContext.rctx,n=s.getViewport(),a=ke.c/this._tilesPerFace,o=this._tileIndex*a;s.setViewport(0,o,ke.c,a);const l=this._ensureFrameBufferCube(ke.c);s.bindFramebuffer(l),s.bindTechnique(t,this.context.renderContext.bind,this._passParameters);const h=Ze.Ap.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return l.setColorTextureTarget(h),s.screen.draw(),s.gl.flush(),s.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this._faceIndex=this._tileIndex=0,this.state=De.tf.Ready,this.running=!1):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),rt.G}};(0,r._)([(0,w.MZ)({constructOnly:!0})],st.prototype,"context",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],st.prototype,"view",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],st.prototype,"requestRender",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"coverage",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"density",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"absorption",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"cloudSize",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"detailSize",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"smoothness",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"cloudHeight",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"raymarchingSteps",void 0),(0,r._)([(0,w.MZ)()],st.prototype,"running",void 0),st=(0,r._)([(0,C.$)("esri.views.3d.environment.CloudsRenderer")],st);const nt=[(0,qe.fA)(1,0,0),(0,qe.fA)(-1,0,0),(0,qe.fA)(0,1,0),(0,qe.fA)(0,-1,0),(0,qe.fA)(0,0,1)],at=[(0,qe.fA)(0,1,0),(0,qe.fA)(0,1,0),(0,qe.fA)(0,0,-1),(0,qe.fA)(0,0,1),(0,qe.fA)(0,1,0)],ot=(0,E.Ul)(),lt=(0,Ge.Ul)();var ht=i(26988),ct=i(3115),dt=i(75541),ut=i(22131),pt=i(20783);class mt extends pt.Y{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}}class _t extends We.w{constructor(e,t){super(e,t,new Be.$(dt.P,(()=>i.e(65409).then(i.bind(i,65409)))),new Map([[ut.r.POSITION,0],[ut.r.INSTANCEFEATUREATTRIBUTE,1]]))}initializePipeline(){return(0,je.Ey)({blending:je.Os,depthTest:{func:Ze.MT.LEQUAL},colorWrite:je.kn})}}var gt=i(66027),ft=i(66458),yt=i(98876),vt=i(62650),bt=i(71723),wt=i(9369),xt=i(80861),Ct=i(44480);let Tt=class extends vt.default{constructor(e){super(e),this.consumes={required:[ct.InternalRenderCategory.TRANSPARENT_ENVIRONMENT]},this.produces=ct.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new mt,this._configuration=new gt.a;const{view:t,type:i}=e;this._configuration.type="rainy"===i?gt.C.Rain:gt.C.Snow,t._stage.renderView.techniques.precompile(_t,this._configuration),this._passParameters.time=0,this._passParameters.radius=(0,Pe.tO)(t.spatialReference).radius,this.addHandles((0,g.watch)((()=>t.environment.weather),(e=>{e.type===i&&this.addHandles((0,g.watch)((()=>e.precipitation),(e=>this._adjustParticles(e)),g.syncAndInitial))}),g.syncAndInitial)),this.addHandles((0,g.watch)((()=>t._stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>{this._passParameters.opacity=e,1===e&&(this.removeHandles("opacity"),this.addHandles((0,g.watch)((()=>t._stage?.renderer.renderContext.bind.clouds.opacity??1),(e=>this._passParameters.opacity=e),g.syncAndInitial),"opacity"))}),g.sync),"opacity")}_adjustParticles(e){const t=e<.5?(0,de.Cc)(0,.35,2*e):(0,de.Cc)(.35,1,2*(e-.5));this._numParticles=Mt*t}destroy(){this._numParticles=0,this._vao=(0,p.WD)(this._vao),this._instanceIdBuffer=(0,p.WD)(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles((0,g.watch)((()=>this.renderContext?.bind.clouds.fadeFactor??1),(t=>{this._passParameters.opacity=1-t,1===t&&(this.removeAllHandles(),e())})),"opacity")}updateAnimation(e){const t=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*(0,ht.y)(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext;this._instanceIdBuffer??=this._createInstanceIndices(t);const i=Math.round(this._numParticles*this._passParameters.opacity),r=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.TRANSPARENT_ENVIRONMENT}));if(i<1)return r;const s=this.techniques.get(_t,this._configuration);if(!s.compiled)return this.requestRender(bt.C7.UPDATE),r;const n=t.bindTechnique(s,this.bindParameters,this._passParameters);return this._vao??=function(e,t){const i=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new wt.Z(e,t,new Map([["geometry",(0,ft.U)(St)]]),new Map([["geometry",xt.g.createVertex(e,Ze._U.STATIC_DRAW,i)]]))}(t,s.locations),t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),(0,Ct.yu)(t,s.locations,this._instanceIdBuffer,Rt,0),t.drawArraysInstanced(Ze.WR.TRIANGLES,0,3,i),(0,Ct.Hi)(t,s.locations,this._instanceIdBuffer,Rt),r}_createInstanceIndices(e){const t=[];for(let i=0;i<Mt;i++)t.push(i);return xt.g.createVertex(e,Ze._U.STATIC_DRAW,new Float32Array(t))}};(0,r._)([(0,w.MZ)()],Tt.prototype,"consumes",void 0),(0,r._)([(0,w.MZ)()],Tt.prototype,"produces",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Tt.prototype,"type",void 0),Tt=(0,r._)([(0,C.$)("esri.views.3d.environment.Precipitation")],Tt);const Mt=25e4,St=(0,yt.BP)().vec3f(ut.r.POSITION),Rt=(0,ft.U)((0,yt.BP)().f32(ut.r.INSTANCEFEATUREATTRIBUTE),1);var At=i(39584),Et=i(91077);let Ot=class extends Et.RW{constructor(e){super(e),this.produces=new Map([]),this._clouds=(0,Oe.v)(null),this._incarnation=0,this._precipitation=null}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?._stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.running}get weatherAvailable(){return(0,Me.l)(this.view.state.camera.eye)-(0,Pe.tO)(this.view.spatialReference).radius<=At.zF}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut((()=>{this._precipitationOutgoing=(0,p.pR)(this._precipitationOutgoing)})),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,i=()=>this._requestRender();this.addHandles([(0,g.watch)((()=>this._precipitation),i,g.sync),(0,g.watch)((()=>this._clouds.value?.state),i,g.sync),(0,g.watch)((()=>t.state.mode),i,g.sync),(0,g.watch)((()=>this._updateClouds()),i,g.sync),(0,g.watch)((()=>this._updatePrecipitation()),i,g.sync),(0,g.watch)((()=>this.weather),(e=>this._initWeather(e)))])}uninitializeRenderContext(){this._context=null,this._clouds.value=(0,p.pR)(this._clouds.value),this._precipitation=(0,p.pR)(this._precipitation),this._precipitationOutgoing=(0,p.pR)(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:i}=e;if("local"!==this.view.viewingMode&&t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);const e=this._clouds.value;e&&e.state===De.tf.Idle&&0===e.coverage&&!e.running&&e.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=(0,p.pR)(this._clouds.value));if(this._clouds.value)return;const i=this.view;this._clouds.value=new st({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return null==e||null==this._clouds.value||this._clouds.value.applyPreset(Ne[e.type],function(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t="rainy"===e.type||"snowy"===e.type,i=this._context;return t&&i&&(this._precipitation=new Tt({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlightOptions(e){return!1}};(0,r._)([(0,w.MZ)({constructOnly:!0})],Ot.prototype,"view",void 0),(0,r._)([(0,w.MZ)({type:Boolean,readOnly:!0})],Ot.prototype,"updating",null),(0,r._)([(0,w.MZ)()],Ot.prototype,"weatherAvailable",null),(0,r._)([(0,w.MZ)()],Ot.prototype,"_context",void 0),Ot=(0,r._)([(0,C.$)("esri.views.3d.environment.EnvironmentRenderer")],Ot);var Pt=i(66797),Dt=i(74871),It=i(10980),Lt=i(12258);let Nt=class extends Te.A.EventedAccessor{constructor(){super(),this._tmpLightParameters=new Dt.uf,this._defaultLightParameters=new Dt.uf,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new Lt.Qx,this._ambientLight=new Lt.$p,this._moonLight=new Lt._y,this._disableProjectionEngineAutoLoad=!1,this._disableWeather=!1,this._renderer=null,this._referencePositionGeographic=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===X.RT.Global&&(0,Re.B3)(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const e=this._view?.stateManager?.camera?.position?.spatialReference??N.default.WGS84,t=Ee(e);return this._disableProjectionEngineAutoLoad||(0,L.isLoadedOrLoadFor)(e,t)}connectView(e){if(this._renderer)return;this._renderer=new Ot({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([(0,g.watch)((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),g.sync),(0,g.watch)((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),g.sync),(0,g.watch)((()=>e.environment.lighting.directShadowsEnabled),t,g.sync),(0,g.watch)((()=>e.qualitySettings.ambientOcclusion),t,g.sync),(0,g.watch)((()=>e.qualitySettings.reflections),t,g.sync),(0,g.watch)((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),g.sync),(0,g.watch)((()=>[e.environment.weather.type,this.weatherEnabled]),(()=>this._updateLighting(null,It.U.FadeWithWeather)),g.sync),(0,g.watch)((()=>e.environment),(e=>e.setComputeWeatherAvailable((()=>this._weatherAvailable))),g.syncAndInitial),(0,g.watch)((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),g.syncAndInitial),(0,g.watch)((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),g.syncAndInitial),(0,g.watch)((()=>e.state.camera),i,g.syncAndInitial),(0,g.when)((()=>this._canProjectCameraPosition),i,g.sync)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=(0,p.pR)(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),null!=this._referencePositionGeographic)){const e=(0,Pt.aE)(this._referencePositionGeographic,this._tmpTz);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;if(!i)return;const{position:r}=i,s=Ee(r.spatialReference??N.default.WGS84),n=this._referencePositionGeographic??(0,E.vt)();if(!(0,F.g)(r,n,s))return this._referencePositionGeographic=null,void this._updateLighting();this._referencePositionGeographic=n,this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(n,e)||this._updateLighting(e)}_updateLighting(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:It.U.Immediate;const i=this._view,{lighting:r}=i.environment,s="virtual"===r.type,n=this._referencePositionGeographic,a=null!=n?this._tmpLightParameters:this._defaultLightParameters;if(n){e??=s?null:r.date;const t=this._weatherAvailable?i.environment.weather.type:"disabled";(0,Dt.$8)(e,n,i.state.viewingMode,t,i.state.camera,a)}else s&&(0,Dt.qI)(i.state.camera,i.state.viewingMode,a.direct.directionToLightSource);const o=this._mainLight,l=a.direct;(0,Me.h)(o.intensity,l.color,l.intensity*Math.PI),(0,Me.c)(o.direction,l.directionToLightSource),o.specularStrength=a.specularStrength,o.environmentStrength=a.environmentStrength;const h=this._ambientLight;(0,Me.h)(h.intensity,a.ambient.color,a.ambient.intensity);const c=this._moonLight;(0,Me.m)(c.intensity,Ht,Ft,a.globalFactor);const d=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));(0,Me.h)(c.intensity,c.intensity,d),(0,Me.c)(c.direction,l.directionToLightSource),this._view._stage.renderer.updateLighting([o,h,c],a.noonFactor,a.globalFactor,this._weatherAvailable?t:It.U.Immediate),this._updateRenderParameters()}_autoUpdateTimezone(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const i=this._tmpDate;i.setTime((t||this._view.environment.lighting.date).getTime());const r=(0,Pt.aE)(e,this._tmpTz);if(null==r)return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),a=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=null==this._referencePositionGeographic||(0,Dt.Md)(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};(0,r._)([(0,w.MZ)({type:Boolean,readOnly:!0})],Nt.prototype,"updating",null),(0,r._)([(0,w.MZ)()],Nt.prototype,"_disableProjectionEngineAutoLoad",void 0),(0,r._)([(0,w.MZ)()],Nt.prototype,"_disableWeather",void 0),(0,r._)([(0,w.MZ)()],Nt.prototype,"weatherEnabled",null),(0,r._)([(0,w.MZ)()],Nt.prototype,"_weatherAvailable",null),(0,r._)([(0,w.MZ)()],Nt.prototype,"referencePositionGeographic",null),(0,r._)([(0,w.MZ)()],Nt.prototype,"_renderer",void 0),(0,r._)([(0,w.MZ)()],Nt.prototype,"_referencePositionGeographic",void 0),(0,r._)([(0,w.MZ)()],Nt.prototype,"_canProjectCameraPosition",null),Nt=(0,r._)([(0,C.$)("esri.views.3d.environment.EnvironmentManager")],Nt);const Ht=(0,E.fA)(.22,.22,.33),Ft=(0,E.fA)(.22,.22,.22);var Vt=i(82301),Ut=i(49214),zt=i(13303);const Gt={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Ut.default,virtual:zt.default}};var qt,kt=i(17569),Bt=i(23682),Wt=i(63643);let Zt=qt=class extends kt.default{constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new qt({...t,lighting:t.lighting?"virtual"===t.lighting.type?zt.default.fromWebsceneLighting(t.lighting):Ut.default.fromWebsceneLighting(t.lighting):void 0})}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles((0,c.DQ)(t)),t}_convertLighting(e){return e?e instanceof Ut.default||e instanceof zt.default?e:e instanceof Bt.default?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new Ut.default({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof Wt.default?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new zt.default({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):(0,T.aq)(Gt,e):new Ut.default}clone(){return new qt({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Vt.clone)(this.background)})}cloneWithWebsceneEnvironment(e){return new qt({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Vt.clone)(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):Ut.default.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):zt.default.fromWebsceneLighting(e.lighting);default:return(0,He.Xb)(e.lighting),Ut.default.fromWebsceneLighting(e.lighting)}}};(0,r._)([(0,w.MZ)({nonNullable:!0})],Zt.prototype,"lighting",void 0),(0,r._)([(0,w.MZ)()],Zt.prototype,"_computeWeatherAvailable",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],Zt.prototype,"weatherAvailable",null),(0,r._)([(0,x.w)("lighting")],Zt.prototype,"castLighting",null),Zt=qt=(0,r._)([(0,C.$)("esri.views.3d.environment.SceneViewEnvironment")],Zt);const jt=Zt;var $t,Qt,Yt,Xt=i(91102),Kt=i(89476);!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}($t||($t={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(Qt||(Qt={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(Yt||(Yt={}));class Jt{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$t.ALL,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Qt.NONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Yt.TUMBLE;this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=r,this.interactionDirection=s,this.tiltMode=n}}function ei(e,t){return!!(e&t)}function ti(e,t,i,r,s,n){0!==e&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):null!=r?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))}const ii=new Jt($t.NONE);function ri(e,t,i,r){return t=t||e.viewForward,(0,Me.c)(r,t),(0,Me.h)(r,r,Math.sign((0,Me.f)(t,i))),r}var si=i(68388);function ni(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ii;if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(t.interactionType!==Qt.TUMBLE||!ei(t.selection,$t.TILT))}(e,i)||!e.state.constraints.altitude)return 0;const r=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,ai);!function(e,t,i){const r=t.interactionType;if(r===Qt.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===Qt.TUMBLE||r===Qt.ZOOM,h=ni(e,a),c=0===h?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=s,i.max=n,ti(h,c,l,o,.05*c,i)}(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),n=(0,de.qE)(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}const ai={min:0,max:0},oi=(0,E.vt)(),li=(0,E.vt)(),hi=(0,E.vt)(),ci=(0,E.vt)();function di(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ii;if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;pi.min=0,pi.max=r,function(e,t,i){const r=t.interactionType;if(r===Qt.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===Qt.ZOOM||r===Qt.PAN,h=di(e,a),c=0===h?0:ui(e,a);i.min=s,i.max=n,ti(h,c,l,o,.05*c,i)}(e,i,pi);const s=ui(e,t),n=pi.max-s;return n>=-1e-6?0:n}function ui(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?(0,Me.j)(t.eye,i.renderLocation):0}const pi={min:0,max:0},mi=(0,E.vt)(),_i=(0,E.vt)(),gi=(0,E.vt)(),fi=(0,E.vt)(),yi=(0,E.vt)();var vi,bi=i(68662);function wi(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:vi.EYE;const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=(0,bi.Rt)(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),a=s+r.collision.elevationMargin;if(n>=a)return!1;const o=(0,Me.l)(t.eye);if((0,Me.d)(xi,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(Ci,a,t.eye),i===vi.EYE_AND_CENTER)t.center=(0,Me.g)(xi,t.eye,xi);else if(i===vi.EYE_AND_CENTER_SCALE){const e=(o-n+a)/o;t.center=(0,Me.h)(xi,t.center,e)}return!0}!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(vi||(vi={}));const xi=(0,E.vt)(),Ci=(0,E.vt)();var Ti=i(47160);function Mi(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ii,s=arguments.length>4?arguments[4]:void 0;if(!e.state.constraints.tilt)return 0;const n=Math.min(t.relativeElevation*Ii,t.distance),a=e.state.constraints.tilt(n,Li);return function(e,t,i){if(t.interactionType===Qt.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=t;if(!r)return;const{min:n,max:a}=i,o=Mi(e,r,ii,t),l=0===o?0:(0,Ti.T)(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=a,t.interactionType===Qt.TUMBLE?(ei(t.selection,$t.ALTITUDE)&&Ai(e,r,i),ti(o,l,!0,s,Di,i)):ti(o,l,!1,s,Di,i)}(e,i,a),r.interactionType===Qt.TUMBLE&&ei(r.selection,$t.ALTITUDE)&&Ai(e,r.interactionStartCamera,a),i.tiltMode===Yt.LOOK_AROUND||r.tiltMode===Yt.LOOK_AROUND?function(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,r){const s=function(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+(0,Pe.tO)(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,Pi);return i.distance=Math.min(t.relativeElevation*Ii,t.distance),i.centerIsOnSurface=!1,null!=n?(i.distance=Math.min(t.relativeElevation*Ii,(0,Me.j)(t.eye,n)),i.tiltAtCenter=(0,Ti.T)(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=(0,Ti.T)(e.renderCoordsHelper,t.center,t.eye):((0,Kt.k)((0,Kt.b)(Kt.t,s),t.ray,Pi),i.distance=Math.min(t.relativeElevation*Ii,(0,Me.j)(t.eye,Pi)),i.tiltAtCenter=(0,de.XM)(-(0,Me.f)(t.viewForward,(0,Me.n)(Pi,Pi)))),i.radius=s,i.eyeRadius=(0,Me.l)(t.eye),i.constraints=e.state.constraints,i}(e,t,Ni),n=(0,de.qE)(s.tiltAtCenter,i.min,i.max);if(!Si(s.tiltAtCenter-n))return 0;let a,o;return s.centerIsOnSurface?(a=function(e){const{constraints:t,distance:i,tiltAtCenter:r}=e;let s=r,n=t.clampTilt(i,r);const a=Ri(e,n);if(t.clampTilt(a,r)===n)return n;let o=0;for(;o<10&&Si(n-s);){const i=(s+n)/2,r=Ri(e,i);Si(t.clampTilt(r,i)-i)?s=i:n=i,o++}return n}(s),o=function(e,t){const i=(0,de.YN)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=(0,de.YN)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}(s,a)):(a=s.constraints.clampTilt(s.distance,s.tiltAtCenter),r&&a<Math.PI/2&&(r.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(s,a)),r&&(r.eyeCenterDistance=Ri(s,a)),o}(e,t,i,r);case"local":return function(e,t,i,r){const s=(0,Ti.T)(e.renderCoordsHelper,t.center,t.eye),n=(0,de.qE)(s,i.min,i.max),a=s-n;if(!Si(a))return 0;if(r){const i=Math.abs(e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),s=e.renderCoordsHelper.getAltitude(t.eye)-i,a=Math.max(Math.cos(n),1e-4);Math.abs(a)>1e-4?r.eyeCenterDistance=s/a:r.eyeCenterDistance=t.distance}return a}(e,t,i,r)}}(e,t,a,s):function(e,t,i){const r=(0,Ti.T)(e.renderCoordsHelper,t.center,t.eye),s=r-(0,de.qE)(r,i.min,i.max);return Si(s)?s:0}(e,t,a)}function Si(e){return Math.abs(e)>1e-9}function Ri(e,t){if(!e.centerIsOnSurface)return e.distance;const i=Math.PI-(0,de.qE)(t,0,Math.PI),r=(0,de.YN)(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const t=Math.PI-r,s=Math.PI-i-t;return Math.sin(s)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function Ai(e,t,i){const r=e.state.constraints;if(e.state.isLocal||!r.altitude||!t)return;const s=(0,Me.k)(t.center),n=Math.sqrt(s),a=t.distance,o=(0,Pe.tO)(e.spatialReference).radius,l=r.altitude.min+o,h=r.altitude.max+o,c=(l*l-a*a-s)/(-2*n*a),d=(h*h-a*a-s)/(-2*n*a);i.min=Math.max(i.min,Math.min(Math.PI-(0,de.XM)(d),i.max)),i.max=Math.min(i.max,Math.PI-(0,de.XM)(c))}const Ei=(0,E.vt)(),Oi=(0,Ue.vt)(),Pi=(0,E.vt)(),Di=(0,de.kU)(5),Ii=30,Li={min:0,max:0},Ni={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},Hi={eyeCenterDistance:0,requiresTwoSteps:!1};var Fi=i(21940);function Vi(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Gi,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);let s=!1;for(let o=0;o<qi;o++){let t=0;for(const n of zi)if(ei(i.selection,n.type)){const a=Math.abs(n.error(e,r,i));n.apply(e,r,i)&&(s=!0,t+=a)}if(0===t)break}const n=ei(i.selection,$t.COLLISION),a=function(e,t){switch(e){case Qt.PAN:return vi.EYE_AND_CENTER;case Qt.ASCEND:return t.state.isGlobal?vi.EYE_AND_CENTER_SCALE:vi.EYE_AND_CENTER;default:return vi.EYE}}(i.interactionType,e);return n&&wi(e,r,a)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function Ui(e){const t=Math.min(1,e/150);return(0,Fi.Cs)(t)}const zi=[{type:$t.TILT,error:function(e,t,i){return Mi(e,t,i)*t.distance},apply:function e(t,i,r){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];Hi.eyeCenterDistance=0,Hi.requiresTwoSteps=!1;const n=Mi(t,i,r,ii,Hi);if(0===n)return!1;switch((0,Ve.$0)(Oi,-n,i.viewRight),r.tiltMode){case Yt.LOOK_AROUND:(0,Me.t)(Ei,i.viewForward,Oi),(0,Me.h)(Ei,Ei,Hi.eyeCenterDistance),i.center=(0,Me.g)(Pi,i.eye,Ei);break;case Yt.TUMBLE:(0,Me.d)(Ei,i.center,i.eye),(0,Me.t)(Ei,Ei,Oi),i.eye=(0,Me.d)(Pi,i.center,Ei);break;default:(0,He.Xb)(r.tiltMode)}return i.up=(0,Me.t)(Pi,i.up,Oi),!Hi.requiresTwoSteps||!s||e(t,i,r,!1)}},{type:$t.ALTITUDE,error:ni,apply:function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ii;const r=ni(e,t,i);if(0===r)return!1;const s=e.renderCoordsHelper,n=s.getAltitude(t.eye)+r,a=ri(t,i.interactionDirection,function(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),(0,Me.h)(r,r,i),r}(e,t,Math.sign(r),li),oi),o=(0,Me.c)(hi,t.viewForward),l=s.intersectInfiniteManifold((0,Xt.LV)(t.eye,a),n,ci);return t.eye=null!=l?l:s.setAltitude(ci,n,t.eye),t.center=(0,si.Rg)(ci,t.eye,o,t.center),!0}},{type:$t.DISTANCE,error:di,apply:function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ii;const r=di(e,t,i);if(0===r)return!1;const s=e.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const n=ui(e,t)+r,a=(0,Me.c)(mi,t.eye),o=ri(t,i.interactionDirection,function(e,t,i){return(0,Me.o)(i,e.eye,t)}(t,s.renderLocation,fi),gi);if(!(0,Kt.j)((0,Kt.l)(s.renderLocation,n),(0,Xt.LV)(t.eye,o),yi))return!1;t.eye=yi;const l=(0,Me.d)(_i,t.eye,a);t.center=(0,Me.g)(yi,t.center,l);const h=e.renderCoordsHelper.getAltitude(t.center),c=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,h,yi);return null!=c&&(t.center=c),!0}}],Gi=new Jt,qi=5;var ki=i(13473);class Bi{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=(0,E.vt)(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=(0,E.o8)(Ki),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===X.RT.Global){const i=((0,Me.l)(this.center)+(0,Me.l)(e.center))/2;t.pan=(0,pe.g7)(this.center,e.center)*i}else t.pan=(0,Me.j)(this.center,e.center);let i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,i){this.viewingMode===X.RT.Global?(0,pe.nu)(e.center,t.center,i.pan,this.center):(0,Me.m)(this.center,e.center,t.center,i.pan),this._distance=isFinite(t.distance)?(0,de.Cc)(e.distance,t.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=(0,de.Cc)(e.pitch,t.pitch,i.rotate);let r=e._yaw;const s=t._yaw;Math.abs(s-r)>=Math.PI&&(r+=2*(r<s?1:-1)*Math.PI),this._yaw=(0,de.Cc)(r,s,i.rotate),this._fov=(0,de.Cc)(e.fov,t.fov,i.fov)}copyFrom(e){(0,Me.c)(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,(0,Me.c)(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,er);(0,Me.c)(this.center,e.center),(0,Me.d)($i,e.center,e.eye),(0,Me.q)($i,$i,t),(0,Me.q)(Qi,e.up,t),this._distance=(0,Me.l)($i),0!==this._distance&&($i[0]/=this._distance,$i[1]/=this._distance,$i[2]/=this._distance),this._pitch=function(e){return Math.PI-(0,pe.g7)(Xi,e)}($i),this._yaw=function(e,t){const i=Yi;return Math.abs(t[2])<.5?((0,Me.c)(i,t),e[2]>0&&(0,Me.h)(i,i,-1)):(0,Me.c)(i,e),(0,Me.e)(Zi,i,Xi),(0,Me.n)(Zi,Zi),(0,pe.g7)(Ji,Zi,Xi)}($i,Qi),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,er);(0,Fe.mg)(t,t),this._axisAngleVec3(Ji,this._pitch-Math.PI/2,Ki,$i),this._axisAngleVec3(Xi,this._yaw,$i,$i),this._axisAngleVec3(Ji,this._pitch-Math.PI/2,Xi,Qi),this._axisAngleVec3(Xi,this._yaw,Qi,Qi),(0,Me.h)($i,$i,this._distance),(0,Me.q)($i,$i,t),(0,Me.q)(Qi,Qi,t),e.center=this.center,e.eye=(0,Me.d)($i,this.center,$i),e.up=Qi,e.fov=this._fov}_axisAngleVec3(e,t,i,r){const s=Math.cos(t),n=Math.sin(t);return(0,Me.h)(Wi,i,s),(0,Me.e)(Zi,e,i),(0,Me.h)(Zi,Zi,n),(0,Me.h)(ji,e,(1-s)*(0,Me.f)(e,i)),(0,Me.g)(r,(0,Me.g)(r,Wi,Zi),ji)}_lookAtOrientation(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,ki.vt)();return this._upAtLookAt(e,ji),(0,Me.e)(Wi,this.direction,ji),(0,Me.n)(Wi,Wi),0===Wi[0]&&0===Wi[1]&&0===Wi[2]&&(0,Me.c)(Wi,Ji),(0,Me.e)(Zi,ji,Wi),(0,Me.n)(Zi,Zi),t[0]=Wi[0],t[1]=Zi[0],t[2]=ji[0],t[3]=Wi[1],t[4]=Zi[1],t[5]=ji[1],t[6]=Wi[2],t[7]=Zi[2],t[8]=ji[2],t}_upAtLookAt(e,t){return this.viewingMode===X.RT.Local?(0,Me.c)(t,Xi):(0,Me.n)(t,e)}}const Wi=(0,E.vt)(),Zi=(0,E.vt)(),ji=(0,E.vt)(),$i=(0,E.vt)(),Qi=(0,E.vt)(),Yi=(0,E.vt)(),Xi=E.Cb,Ki=E.JP,Ji=E.Cw,er=(0,ki.vt)();var tr=i(60812);class ir{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=(0,ht.l5)(0),this._animation=new tr.X((()=>new Bi(e))),this._current=new Bi(e)}update(e,t,i){const{source:r,target:s}=this._animation.definition,n=(0,Me.d)(rr,t.center,e.center),a=(0,Me.l)(n);a>=1e-5?(n[0]/=a,n[1]/=a,n[2]/=a):(n[0]=0,n[1]=1,n[0]=0),(0,Me.c)(r.direction,n),(0,Me.c)(s.direction,n),r.copyFromRenderCamera(e),s.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,s,i),this.currentTime=(0,ht.l5)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,t){this.finished||(this.currentTime=(0,ht.l5)(this.currentTime+(0,ht.gr)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}const rr=(0,E.vt)();var sr;!function(e){e[e.Ready=0]="Ready",e[e.Rejected=1]="Rejected",e[e.Running=2]="Running",e[e.Stopped=3]="Stopped",e[e.Finished=4]="Finished"}(sr||(sr={}));let nr=class extends M.default{constructor(e){super(e),this.state=sr.Ready}get running(){return this.state===sr.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=sr.Stopped,!0)}finishController(){this.state=sr.Finished}get steppingFinished(){return!1}};(0,r._)([(0,w.MZ)({constructOnly:!0})],nr.prototype,"view",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],nr.prototype,"running",null),(0,r._)([(0,w.MZ)()],nr.prototype,"state",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],nr.prototype,"isInteractive",null),nr=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.CameraController")],nr);let ar=class extends nr{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject((0,_.createAbortError)()),this._asyncResult=null),this.state===sr.Finished||this.state===sr.Stopped?((0,p.Lw)(e),this.state===sr.Finished?e.resolve():e.reject((0,_.createAbortError)())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=sr.Running,null!=this.viewAnimation&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==sr.Ready&&this.state!==sr.Running||(this.viewAnimation.state===Y.default.State.FINISHED?this.finish():this.viewAnimation.state===Y.default.State.STOPPED&&(this.state=sr.Stopped))}onControllerEnd(e){null==this.viewAnimation||this.viewAnimation.done||(this.state===sr.Finished?this.viewAnimation.finish():this.state===sr.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===sr.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,_.createAbortError)()))}finish(){this.finishController()}};ar=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.AnimationController")],ar);var or=i(83607),lr=i(8609);let hr=class extends ar{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new ir(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new Y.default}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);cr.copyFrom(this.view.state.camera);const r=(0,lr.hz)(this.view.state.viewingMode);this._intersectionHelper.intersectRay(cr.ray,r,dr)&&(cr.center=dr),this.animation.update(cr,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?Fi.JC[e.easing]:e.easing}}};(0,r._)([(0,w.MZ)({constructOnly:!0})],hr.prototype,"mode",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],hr.prototype,"isInteractive",null),hr=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.PointToPointAnimationController")],hr);const cr=new or.default,dr=(0,E.vt)();function ur(e){return null!=e&&"type"in e&&"point-to-point"===e.type}var pr=i(5839),mr=i(21369),_r=i(66509),gr=i(49943),fr=i(1696);function yr(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:xr;return[e[0],e[1],e[2],e[3]]}function vr(e,t){return br(e[0],e[1],e[2],t,fr.Km.get())}function br(e,t,i,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:yr();return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function wr(e,t,i){return(0,Me.e)(i,e,t),(0,Me.n)(i,i),i[3]=(0,gr.g7)(e,t),i}const xr=[0,0,1,0];(0,_r.vt)(),(0,_r.vt)();var Cr=i(10872),Tr=i(9452);function Mr(e,t,i,r){const s=(0,Tr.vr)(t,i,Sr);return(0,Kt.j)(e,s,r)}const Sr=(0,Xt.vt)();var Rr,Ar=i(64863);!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(Rr||(Rr={}));const Er=[1,3e8],Or=1508e5,Pr={exclude:new Set([Ar.fo])};function Dr(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function Ir(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Lr(e,t,i){const r=(0,Ve.$0)(fr.Rc.get(),i[3],i);null==r||(0,Ve.t2)(r,Ue.zK)||((0,Me.d)(As,e.eye,t),(0,Me.t)(As,As,r),e.eye=(0,Me.g)(As,As,t),(0,Me.d)(As,e.center,t),(0,Me.t)(As,As,r),e.center=(0,Me.g)(As,As,t),e.up=(0,Me.t)(As,e.up,r))}function Nr(e,t,i,r){return(0,Cr.Ui)(e,(0,Tr.vr)(t,i,Is),r)}function Hr(e,t,i,r){const s=fr.rq.get();let n=1-i;(0,Me.d)(s,t,e.eye);const a=(0,Me.l)(s);let o=a*(1-n);n>=0&&o<r&&(o=r,n=-(o-a)/a),Math.abs(a-o)<1e-6||((0,Me.h)(s,s,n),e.eye=(0,Me.g)(As,e.eye,s),e.center=(0,Me.m)(As,e.center,t,n))}function Fr(e,t,i){t.getScreenCenter(Vr),Mr(e,t,Vr,As)&&(t.center=As);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const n=(0,Me.h)(fr.rq.get(),t.viewForward,s);t.eye=(0,Me.d)(As,t.center,n)}const Vr=(0,y.gs)();function Ur(e,t){(0,Me.i)(t,0,0,0);for(const i of e)(0,Me.g)(t,t,i);(0,Me.h)(t,t,1/e.length)}function zr(e,t,i,r){return Math.sin(e/(0,Me.l)(t))*(i+r.radius)}function Gr(e,t,i,r){return zr(Math.PI/2,t,i,r)+(e-Math.PI/2)}var qr;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(qr||(qr={}));const kr={Elevation:3e4,Angle:(0,de.kU)(16)},Br=(0,de.kU)(80);function Wr(e,t,i,r,s,n){const a=(0,E.vt)(),o=(0,Kt.c)();let l=!0,h=!0;return e.intersectScreen(i,a,n)?o[3]=(0,Me.l)(a):(h=!1,t.aboveGround&&s!==Rr.Ellipsoid?o[3]=Math.max((0,Me.l)(t.center),.9*r.radius):o[3]=(0,Me.l)(t.eye)-t.relativeElevation,s===Rr.Silhouette?Qr(o,t,i,a):l=Mr(o,t,i,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:h}}function Zr(e,t,i,r){const s=e.relativeElevation;if(s>kr.Elevation&&"global"===r)return qr.Horizontal;(0,Tr.vr)(e,t,Ls);const n=Math.sign(s),a=i.worldUpAtPosition(e.eye,As);return-n*(0,Me.f)(a,Ls.direction)<Math.sin(kr.Angle)*(0,Me.l)(Ls.direction)?qr.Vertical:qr.Horizontal}function jr(e,t,i){(0,Me.d)($r,i,t),e.eye=(0,Me.d)(As,e.eye,$r),e.center=(0,Me.d)(As,e.center,$r)}const $r=(0,E.vt)();function Qr(e,t,i,r){const s=(0,Tr.vr)(t,i,Is);return null!=s&&((0,Kt.k)(e,s,Yr),(0,Kt.j)(e,s,r)?!((0,Me.s)(Yr,s.origin)<(0,Me.s)(r,s.origin))||((0,Me.c)(r,Yr),!1):((0,Me.d)(Xr,t.eye,t.center),(0,Me.n)(Xr,Xr),(0,Cr.UB)(Xr,-(0,Me.f)((0,Me.n)(Xr,Xr),Yr),Kr),(0,Cr.Ui)(Kr,s,r),!1))}const Yr=(0,E.vt)(),Xr=(0,E.vt)(),Kr=(0,Cr.vt)();function Jr(e,t,i,r,s,n){let a=0;if((0,Me.e)(Ps,e,t),(0,Me.d)(Es,e,t),(0,Me.l)(e)<=s||!r.aboveGround){(0,Me.e)(i,Es,r.eye);const o=(0,Me.f)(e,t)/((0,Me.l)(e)*(0,Me.l)(t));if(o<.9999)a=(0,de.XM)(o);else{const i=(0,Me.l)((0,Me.e)((0,E.vt)(),e,t))/((0,Me.l)(e)*(0,Me.l)(t));a=(0,de.YN)(i)}const l=Math.cos((0,de.qE)(pr.wf.normalize((0,de.kU)(n)),0,Br));a=-a-Math.max(0,(0,Me.l)(t)-s)/(l*s)}else(0,Me.d)(es,r.eye,r.center),(0,Me.e)(i,Es,es),a=-(0,Me.l)(Es)/s;return(0,Me.n)(i,i),(0,Me.h)(i,i,(0,Me.l)(Ps)),a}const es=(0,E.vt)();function ts(e,t,i,r){let s,n;const a=Math.cos((0,de.qE)(pr.wf.normalize((0,de.kU)(r)),0,Br));return s=t>i?-(t-i)/(a*i):t<-i?Math.PI-(t+i)/(a*i):(0,de.XM)(t/i),n=e>i?-(e-i)/(a*i):e<-i?Math.PI-(e+i)/(a*i):(0,de.XM)(e/i),(n-s)*i}function is(e,t,i,r,s,n,a,o,l,h){(0,Me.e)(Ps,e,t),(0,z.U9)(n.up,n.eye,fs,ys,vs),(0,z.U9)([0,0,1],n.eye,ms,_s,gs),(0,Me.c)(i,_s),(0,Me.c)(r,ms),(0,Me.n)(i,i),(0,Me.h)(i,i,(0,Me.l)(Ps)),(0,z.PX)(e,(0,Me.n)(ys,ys),(0,Me.n)(vs,vs),(0,Me.n)(fs,fs),bs),(0,z.PX)(t,ys,vs,fs,ws),function(e,t,i,r,s,n,a,o,l,h){const c=ts(e[2],t[2],n[3],o),d=l?ts(e[0],t[0],n[3],180):t[0]-e[0],u=Math.sin(a)*d-Math.cos(a)*c,p=Math.cos(a)*d+Math.sin(a)*c;(0,Me.n)(As,s);const m=l?u/Math.sqrt(Math.abs(n[3]**2-(0,Me.f)(i,As)**2)):u/n[3],_=p/Math.sqrt(Math.abs(n[3]**2-(0,Me.f)(i,r)**2));(0,ze.hZ)(h,m,_)}(bs,ws,e,ms,_s,a,o,l,h,s)}function rs(e,t,i,r,s,n,a){(0,Ve.$0)(Ts,s,r),(0,Ve.$0)(Ms,a,n),(0,Ve.lw)(Ss,Ts,Ms),(0,Me.d)(t,e,i),(0,Me.t)(t,t,Ss),(0,Me.g)(t,t,i)}function ss(e,t,i,r,s,n){(0,Ve.$0)(Ts,r,i),(0,Ve.$0)(Ms,n,s),(0,Ve.lw)(Ss,Ts,Ms),(0,Me.d)(As,e.eye,t),(0,Me.t)(As,As,Ss),e.eye=(0,Me.g)(As,As,t),(0,Me.d)(As,e.center,t),(0,Me.t)(As,As,Ss),e.center=(0,Me.g)(As,As,t),(0,Me.d)(As,e.up,t),(0,Me.t)(As,As,Ss),e.up=(0,Me.g)(As,As,t)}const ns=.95,as=(0,de.kU)(18),os=45,ls=1e-7;let hs=!1;function cs(e,t,i,r,s,n){const a=Math.abs(r)>Math.PI-as||Math.abs(r)<as,o=(Math.abs(e[2])<i*ns||Math.abs(t)>i)&&n;return a&&o?!hs&&s<os-ls?hs=!0:hs&&s>os+ls&&(hs=!1):hs=!1,hs}function ds(e,t,i,r,s,n){if(n)wr(i,r,Cs),Lr(t,(0,Kt.a)(e),Cs);else{const n=Jr(i,r,Ds,t,e[3],s);Lr(t,(0,Kt.a)(e),vr(Ds,n))}}function us(e,t,i,r,s,n,a){const o=a?20:1;let l,h;(0,Me.c)(Rs,r),Os.copyFrom(t);for(let c=0;c<o&&(0,Me.s)(i,Rs)>1e-12&&(l=(0,Me.s)(i,Rs),is(i,Rs,_s,ms,xs,Os,e,s,n,a),ss(Os,(0,Kt.a)(e),ms,xs[1],_s,xs[0]),rs(Rs,Rs,(0,Kt.a)(e),ms,xs[1],_s,xs[0]),h=(0,Me.s)(i,Rs),h<l||0===c);c++)t.copyFrom(Os)}function ps(e,t,i,r,s,n,a,o,l){cs(e.center,(0,Me.f)(e.up,e.center),(0,Me.l)(e.center),-pr.wf.normalize((0,de.kU)(n)),a,t.aboveGround)?function(e,t,i,r,s,n){const{eye:a}=e;(0,z.U9)([0,0,1],a,ms,_s,gs);const o=t.translation[0]*i.pan,l="zoom"===s.mode?0:t.translation[1]*i.pan,h=Math.max(Math.sqrt(Math.abs(1-(0,Me.f)(e.center,ms)**2/(0,Me.l)(e.center)**2)),.5),c=(Math.sin(n)*l+Math.cos(n)*o)/h,d=-Math.cos(n)*l+Math.sin(n)*o;switch((0,Ve.e$)(r.pan.matrix,r.pan.matrix,c,ms),r.pan.enabled=!0,s.mode){case"pan":(0,Ve.e$)(r.pan.matrix,r.pan.matrix,d,_s),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l,-pr.wf.normalize((0,de.kU)(s))):function(e,t,i,r,s){const{eye:n,viewRight:a}=e,o=(0,Me.e)(fr.rq.get(),a,n),l=t.translation[0]*i.pan;switch(0!==l&&((0,Ve.e$)(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&((0,Ve.e$)(r.pan.matrix,r.pan.matrix,e,a),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l)}const ms=(0,E.vt)(),_s=(0,E.vt)(),gs=(0,E.vt)(),fs=(0,E.vt)(),ys=(0,E.vt)(),vs=(0,E.vt)(),bs=(0,E.vt)(),ws=(0,E.vt)(),xs=(0,Ge.vt)(),Cs=yr(),Ts=(0,Ue.vt)(),Ms=(0,Ue.vt)(),Ss=(0,Ue.vt)(),Rs=(0,E.vt)(),As=(0,E.vt)(),Es=(0,E.vt)(),Os=new or.default,Ps=(0,E.vt)(),Ds=(0,E.vt)(),Is={origin:(0,E.vt)(),direction:(0,E.vt)()},Ls={origin:(0,E.vt)(),direction:(0,E.vt)()};let Ns=class extends hr{constructor(){super(...arguments),this._zoomLocation=(0,E.vt)(),this._tmpCamera=new or.default,this._tmpViewDir=(0,E.vt)(),this._tmpRayDir=(0,Xt.vt)(),this._targetOnSphere=(0,E.vt)(),this._tmpCenter=(0,E.vt)(),this._beginCamera=new or.default,this._constraintOptions=new Jt($t.ALL_EXCEPT_COLLISION,Qt.ZOOM,null,this._beginCamera),this._sphere=(0,Kt.c)()}initialize(){this._intersector=(0,lr.hz)(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,s=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?Pr:{})&&(r=e>0,s=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Me.c)(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,s),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,ht.l5)(600),easing:Fi.PC}}_updateCamera(e,t,i,r){const s=Zr(e,i,this.view.renderCoordsHelper,this.view.viewingMode),n=Math.abs(this.view.camera.position.z),a=this._zoomLocation;(0,Me.n)(Fs,e.eye),(0,Me.h)(Fs,Fs,-1),(0,Tr.vr)(e,i,this._tmpRayDir),(0,Me.n)(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=(0,de.qE)(Math.min(8,1/Math.abs((0,Me.f)(Fs,this._tmpRayDir.direction)))*n,200,Or);if(s===qr.Horizontal){let r=.6**t;this._sphere[3]=(0,Me.l)(a),(0,Me.d)(this._tmpViewDir,e.center,e.eye);const s=Math.min((0,Me.l)(this._tmpViewDir),o);let n=s*r;if(r<=1&&n<4&&(n=4,r=n/s),Math.abs(s-n)<1e-6)return;const l=(0,Me.l)(e.center);if(this._sphere[3]!==l){const t=this._sphere[3]+r*(l-this._sphere[3]);e.center=(0,Me.h)(Hs,e.center,t/l)}(0,Me.h)(this._tmpViewDir,this._tmpViewDir,-r),e.eye=(0,Me.g)(Hs,e.center,this._tmpViewDir),Vi(this.view,e,this._constraintOptions),(0,Me.s)(a,e.center)>1e-12&&Mr(this._sphere,e,i,this._targetOnSphere)&&function(e,t,i,r,s,n,a){cs(i,(0,Me.f)(t.up,i),e[3],-pr.wf.normalize((0,de.kU)(s)),n,t.aboveGround)?us(e,t,i,r,-pr.wf.normalize((0,de.kU)(s)),n,a):ds(e,t,i,r,n,a)}(this._sphere,e,a,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let s=.6**Math.abs(t);const n=t>0?1:-1;(0,Me.d)(this._tmpViewDir,a,e.eye);const l=(0,Me.l)(this._tmpViewDir),h=this.view._stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,60);let c=null!=h?h:o;c=r&&t>0?Math.min(c,l):c,(0,Me.h)(this._tmpRayDir.direction,this._tmpRayDir.direction,c),(0,Me.g)(a,this._tmpRayDir.origin,this._tmpRayDir.direction);let d=c*s;const u=Math.max(4,1.01*e.nearFar[0]);if(t>0&&d<u&&(d=u,s=d/c),Math.abs(c-d)<1e-6)return;(0,Me.h)(this._tmpRayDir.direction,this._tmpRayDir.direction,n*(1-s)),e.eye=(0,Me.g)(Hs,e.eye,this._tmpRayDir.direction),e.center=(0,Me.g)(Hs,e.center,this._tmpRayDir.direction)}wi(this.view,e)}};Ns=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],Ns);const Hs=(0,E.vt)(),Fs=(0,E.vt)();var Vs=i(93989);let Us=class extends hr{constructor(){super(...arguments),this._zoomLocation=(0,E.vt)(),this._tmpCamera=new or.default,this._tmpRayDir=(0,E.vt)(),this._tmpCenter=(0,E.vt)(),this._beginCamera=new or.default,this._constraintOptions=new Jt($t.ALL,Qt.ZOOM,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const r=(0,lr.hz)(this.view.state.viewingMode);let s=!1;e>0?(s=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,0===this.view.map.ground.opacity?Pr:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Me.c)(this._zoomLocation,this._tmpCamera.center);const n=.6**e;let a=this.view._stage.renderView.getMinimalDepthForArea((0,Vs.ds)(this.view),t[0],t[1],this.view.state.camera,60);(0,Me.d)(qs,this._tmpCamera.eye,this._zoomLocation),(0,Me.n)(qs,qs);const o=(0,de.qE)(Math.min(8,1/Math.abs((0,Me.f)(Gs,qs)))*Math.abs(this.view.camera.position.z),200,Or);if(a=null!=a?a:o,a){const e=(0,E.vt)();(0,Me.d)(e,this._zoomLocation,this._tmpCamera.eye),(a<(0,Me.l)(e)||!s)&&((0,Me.n)(e,e),(0,Me.g)(this._zoomLocation,this._tmpCamera.eye,(0,Me.h)(e,e,a)))}this._updateCamera(this._tmpCamera,n,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,ht.l5)(600),easing:Fi.PC}}_updateCamera(e,t,i){(0,Me.d)(this._tmpRayDir,i,e.eye);const r=(0,Me.l)(this._tmpRayDir);let s=r*t;const n=t<=1,a=Math.max(4,1.01*e.nearFar[0]);0!==s&&(n&&s<a&&(s=a,t=s/r),Math.abs(r-s)<1e-6||((0,Me.h)(this._tmpRayDir,this._tmpRayDir,t),e.eye=(0,Me.d)(zs,i,this._tmpRayDir),e.center=(0,Me.m)(zs,e.center,i,1-t),Vi(this.view,e,this._constraintOptions)))}};Us=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.ZoomStepControllerLocal")],Us);const zs=(0,E.vt)(),Gs=(0,E.fA)(0,0,1),qs=(0,E.vt)();var ks=i(66759),Bs=i(28378);class Ws extends ks.l{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const t=e.data;if((0,Bs.j2)(t,"primary")){const i=this._view.state.isGlobal?new Ns({view:this._view,mode:"animation"}):new Us({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.step(Math.log(.5)/Math.log(.6),(0,y.gs)(t.x,t.y)),e.stopPropagation()}}}var Zs=i(60548),js=i(24646),$s=i(65920),Qs=i(96417);class Ys{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=(0,Pe.tO)(t),this._unitInMeters=(0,v.GA)(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r,s){s||(s={near:0,far:0});let n=e[2]*this._unitInMeters;const a=n,o=n-r,l=this._elevationProvider?.visibleElevationBounds;l&&(n=o>=0?a-this._unitInMeters*l.min:this._unitInMeters*l.max-a);const h={x:(i=null!=i?i:new P.default({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},c=Math.max(h.x,h.y,h.z);(0,Me.d)(ln,t,e),on[0]=ln[0]>0?i.xmax:i.xmin,on[1]=ln[1]>0?i.ymax:i.ymin,on[2]=ln[2]>0?c/2:-c/2,(0,Me.d)(on,on,e),(0,Me.n)(ln,ln);const d=1.1*(0,Me.f)(on,ln)*this._unitInMeters,u=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),p=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),m=p*nn*this._unitInMeters,_=p*an*this._unitInMeters,g=(0,de.qE)((n-_)/(m-_),0,1)**3,f=Math.min((0,de.Cc)(u,d,g),u)*Math.max(Math.log(Math.abs(o)),1);return Ks(Math.min(f,Math.max(34064e4,c))/this._unitInMeters,tn,this._unitInMeters,s)}}class Xs{constructor(e){this._referenceEllipsoid=(0,Pe.tO)(e)}compute(e,t,i,r,s){s||(s={near:0,far:0});const n=(0,Me.l)(e),a=n-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,r),l=Math.abs(a-r),h=Math.max(l,Math.abs(a)),c=Math.sqrt(h*(h+2*o)),d=n+this._referenceEllipsoid.radius,u=1.2*(0,de.Cc)(c,d,(0,Qs.GF)(h)),p=(Math.log(h)-Js)/(en-Js);return Ks(u,(0,de.qE)(tn-p*(tn-rn),rn,tn),1,s)}}function Ks(e,t,i,r){const s=sn/i,n=e/t;return n>s?(r.far=e,r.near=n):(r.near=s,r.far=r.near*t),r}const Js=7.983,en=16.994,tn=2e4,rn=100,sn=2,nn=.001,an=1e-4,on=(0,E.vt)(),ln=(0,E.vt)();let hn=class extends M.default{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&(0,bi.HD)(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>wi(this.view,e,vi.EYE_AND_CENTER)))}};(0,r._)([(0,w.MZ)({constructOnly:!0})],hn.prototype,"view",void 0),hn=(0,r._)([(0,C.$)("esri.views.3d.state.SurfaceCollisionConstraint")],hn);let cn=class extends M.default{constructor(e){super(e),this.nearFarHeuristic=function(e,t,i){return e===X.RT.Global?new Xs(i):new Ys(t,i)}(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([(0,g.watch)((()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far]),(()=>this._clipDistanceNearFarChanged())),(0,g.watch)((()=>this.view.constraints?.clipDistance?.mode),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e))),(0,g.watch)((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),g.sync),(0,g.watch)((()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max]),(()=>this._updateAltitude()),g.sync),(0,g.watch)((()=>this.view.constraints?.tilt?.max),(()=>this._updateTiltMax()),g.sync),(0,g.watch)((()=>this.view.constraints?.tilt?.mode),(()=>this._updateTilt()),g.sync),(0,g.watch)((()=>this.view.state?.camera),(()=>this._updateTiltAutoMax()),g.sync),(0,g.watch)((()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled]),(()=>this._updateCollision()),g.sync)]),this.view.state.isLocal&&this.addHandles((0,g.watch)((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),g.initial)),this._updateNearFar(),this.view.state.viewingMode!==X.RT.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new hn({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>dn(t,e)))}_updateNearFar(){this.view.state.updateCamera((e=>this._updateCameraNearFar(e)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?dn(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,(0,bi.Rt)(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints($t.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==X.RT.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,de.kU)(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,de.KJ)(i))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$t.ALL;this.view.state.updateCamera((t=>Vi(this.view,t,new Jt(e,Qt.NONE,null))))}};function dn(e,t){t&&(e.near=t.near,e.far=t.far)}(0,r._)([(0,w.MZ)({constructOnly:!0})],cn.prototype,"view",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],cn.prototype,"surfaceCollisionConstraint",void 0),cn=(0,r._)([(0,C.$)("esri.views.3d.state.ConstraintsManager")],cn);var un=i(15390);let pn=class extends nr{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=sr.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||(0,bi.HD)(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),wi(this.view,e,vi.EYE_AND_CENTER)||this.constraintEnabled||(this.state=sr.Stopped)}))}};(0,r._)([(0,w.MZ)({constructOnly:!0})],pn.prototype,"desiredCamera",null),pn=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],pn);var mn=i(64566),_n=i(52714);class gn{constructor(e,t,i){this._target=e,this._options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise(((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const i=new AbortController;null!=this._options.signal&&(0,_.onAbort)(this._options.signal,(()=>this.abort())),this._abortController=i,this._waitForReady()}))}_resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}_reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject((0,_.createAbortError)())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await(0,g.whenOnce)((()=>this.view.ready),this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await(0,_n.vt)(this.view,this._target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this._options.animate){if(null==this._animationController)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const t=!!(this._target instanceof n.default&&this._target.camera||this._target instanceof s.default),i=e.camera;if(null==i)return null;if(!this.view.stateManager.isCompatible(i)){const e=i.position,t=e&&e.spatialReference,r=t?t.wkid:"none",s=this.view.spatialReference?.wkid;return this._reject(new l.default("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${r}, view: ${s})`,{camera:i})),null}const r=(0,mn.Cz)(this.view,i);return null==r?(this._reject(new l.default("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(null==i)return void this._reject(new l.default("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.running||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new pn({view:this.view,desiredCamera:e.camera}),wi(this.view,e.camera,vi.EYE_AND_CENTER)):Vi(this.view,e.camera),t.begin(e.camera,this._options);const s=e=>{if(null!=this.view.state)switch(t.state){case sr.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case sr.Ready:case sr.Rejected:case sr.Running:case sr.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;r&&(i&&i.running?ur(i)&&null!=i.viewAnimation&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&t.state===sr.Finished&&(this.view.state.cameraController=r))}),(e=>s(e))),t.asyncResult={resolve:()=>s(),reject:e=>s(e)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return ur(i)&&(i.updateStateFromViewAnimation(),i.running&&(e=i,t=e.viewAnimation)),null==e&&(e=new hr({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),e.state===sr.Rejected)?(t?.stop(),this._reject(new l.default("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}}var fn=i(75281),yn=i(18683),vn=i(35677),bn=i(16345);let wn=class extends M.default{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=Pn,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?Pn:0}},this._propertiesPool=new vn.M({frustum:un.P},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new xn}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([(0,g.on)((()=>this.view.state.events),"before-camera-change",(e=>e&&this._updateElevation(e))),(0,g.watch)((()=>this.view.state?.camera),((e,t)=>this._cameraChangedHandler(e,t)),g.sync)]),(0,g.when)((()=>this.view.state?.camera),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.addHandles([(0,f.addFrameTask)({prepare:()=>this._prepareFrame()}),(0,g.watch)((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this.removeHandles(En)})),(0,g.on)((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])}destroy(){this.exit(),this._propertiesPool=(0,p.pR)(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=(0,mn.dl)(this.view,this.view.state.camera,Sn);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera((0,mn.Cz)(this.view,e),{applyConstraints:!1})||u.A.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=(0,mn.dl)(this.view,this.view.state.contentCamera,Sn);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=(0,mn.Cz)(this.view,e);null!=t?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles(On),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=(0,E.ci)(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.addHandles([(0,g.watch)((()=>this.contentCamera),(()=>{e.sticky||(this.removeHandles(On),this.test.contentCameraResetState.clear())})),(0,g.watch)((()=>this.zoom),(e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s))})),(0,g.watch)((()=>this.view.state.camera),(e=>{const t=(0,Me.s)(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}))],On),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():u.A.getLogger(this).error("#center=","Invalid center",e):u.A.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):u.A.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?$s.default.fromExtent(e):null}return(0,mn.Dd)(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=(0,mn.w1)(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||u.A.getLogger(this).error("#extent=","Invalid extent",e):u.A.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):u.A.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?(0,mn.WE)(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||u.A.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[fn.zj.TOP]/i),n=Math.round(t[fn.zj.RIGHT]/i),a=Math.round(t[fn.zj.BOTTOM]/i),o=Math.round(t[fn.zj.LEFT]/i);return null!=r&&r.top===s&&r.right===n&&r.bottom===a&&r.left===o?r:{top:s,right:n,bottom:a,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,An),this.view.state.updateCamera((e=>e.padding=An)))}_paddingToArray(e,t,i){e?(0,Zs.s)(i,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,Zs.s)(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){const e=this.padding;return(0,y.tc)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?(0,_n.Qq)(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||u.A.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const t=null!=e.camera?e.camera.position:e.targetGeometry,i=null!=t&&t.spatialReference;u.A.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}else u.A.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?(0,mn.J9)(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||u.A.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const i=this.view._stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&(0,Je.T)(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?._stage?.renderer.isFeatureEnabled(yn.n.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?._stage?.renderer;return e&&(e.isFeatureEnabled(yn.n.PhysicalPixelRendering,bn.M.IDLE)||e.isFeatureEnabled(yn.n.PhysicalPixelRendering,bn.M.INTERACTING)||e.isFeatureEnabled(yn.n.PhysicalPixelRendering,bn.M.ANIMATING))}preinit(e){return!(this._isOverridden("center")&&!(0,L.isLoadedOrLoadFor)(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!(0,L.isLoadedOrLoadFor)(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!(0,L.isLoadedOrLoadFor)(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||(0,L.isLoadedOrLoadFor)(this.viewpoint.targetGeometry?.spatialReference,e)&&(0,L.isLoadedOrLoadFor)(this.viewpoint.camera?.position?.spatialReference,e))}init(){this._constraintsManager=new cn({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===X.RT.Local&&this.addHandles((0,g.when)((()=>this.view.basemapTerrain.ready),(()=>{this.removeHandles(En),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),En)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(En),this._constraintsManager=(0,p.pR)(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},null!=this._gotoOperation&&this._gotoOperation.abort(t.animate),this._gotoOperation=new gn(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera((0,bi.bZ)(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t?.cameraController;i&&(t.updateCamera((t=>i.stepController(e,t))),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of Tn){const s=e.has(i),n=this._isOverridden(i);!s&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof s.default)return void this.setStateCamera((0,mn.Cz)(this.view,e),{applyConstraints:!1});if(e instanceof n.default){if(e.targetGeometry instanceof P.default){const t=(0,mn.wI)(this.view,e.targetGeometry,0,.5,mn.AO.LOCKED);return void(null!=t&&this.setStateCamera((0,mn.Cz)(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=(0,mn.wI)(this.view,e,0,.5,mn.AO.LOCKED);null!=t&&this.setStateCamera((0,mn.Cz)(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&Cn.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof n.default?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof s.default?this.isCompatible(e.position):e.spatialReference&&!(0,L.requiresLoad)(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Mn;return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Rn;const{heading:r,tilt:s}=this._getPreservingHeadingTilt(),n=(0,mn.rW)(this.view,r,s,e,t,mn.AO.ADJUST);return null==n?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:e}=this.view.pointsOfInterest;e.runTask(),t=e.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=(0,mn.wI)(this.view,e,t,i,mn.AO.ADJUST,Sn);return r?(0,mn.Cz)(this.view,r):null}_scaleToCamera(e){if(null==e)return null;const t=this.view,i=t.pointsOfInterest.centerOnContent;i.runTask();const r=i.renderLocation,s=t.pointsOfInterest.cameraOnSurface.renderLocation,n=(0,mn.lr)(t,e,t.state.contentCamera,r,s);return this._centerPointAtDistanceToCamera(r,n)}_zoomToCamera(e){return this._scaleToCamera((0,mn.XM)(this.view,e))}_viewpointToCamera(e){return(0,mn.Cz)(this.view,(0,_n.on)(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&Vi(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new pn({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(0!==i.width&&0!==i.height&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===i.width&&e.fullHeight===i.height&&e.pixelRatio===i.pixelRatio||(Rn.copyFrom(e),Rn.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,An),Rn.padding=An),Rn.fullWidth=i.width,Rn.fullHeight=i.height,Rn.pixelRatio=i.pixelRatio,this.view.state.camera=Rn),this._updateViewState()}}_updateElevation(e){const t=this.view.basemapTerrain?.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,r=t?(0,bi.Rt)(this.view,e.eye):0;e.relativeElevation=i-r}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=bn.M.ANIMATING:this.view.interacting?this.view.state.mode=bn.M.INTERACTING:(this.view.state.mode===bn.M.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=bn.M.INTERACTING:this.view.state.mode=bn.M.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};(0,r._)([(0,w.MZ)({type:s.default,dependsOn:["view.state.camera","ready"]})],wn.prototype,"camera",null),(0,r._)([(0,w.MZ)({type:s.default,dependsOn:["view.state.contentCamera","ready"]})],wn.prototype,"contentCamera",null),(0,r._)([(0,w.MZ)({type:I.default})],wn.prototype,"center",null),(0,r._)([(0,w.MZ)()],wn.prototype,"visibleArea",null),(0,r._)([(0,w.MZ)({type:P.default})],wn.prototype,"extent",null),(0,r._)([(0,w.MZ)({readOnly:!0})],wn.prototype,"frustum",null),(0,r._)([(0,w.MZ)()],wn.prototype,"_constraintsManager",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],wn.prototype,"constraintsManager",null),(0,r._)([(0,w.MZ)()],wn.prototype,"_initialViewpoint",null),(0,r._)([(0,w.MZ)({readOnly:!0})],wn.prototype,"hasInitialView",null),(0,r._)([(0,w.MZ)({readOnly:!0,type:Boolean})],wn.prototype,"ready",void 0),(0,r._)([(0,w.MZ)({type:Number})],wn.prototype,"scale",null),(0,r._)([(0,w.MZ)()],wn.prototype,"padding",null),(0,r._)([(0,w.MZ)({readOnly:!0})],wn.prototype,"screenCenter",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],wn.prototype,"view",void 0),(0,r._)([(0,w.MZ)({type:n.default})],wn.prototype,"viewpoint",null),(0,r._)([(0,w.MZ)({type:Number})],wn.prototype,"zoom",null),(0,r._)([(0,w.MZ)({readOnly:!0})],wn.prototype,"_rasterPixelRatio",null),(0,r._)([(0,w.MZ)({readOnly:!0})],wn.prototype,"_usePhysicalPixelRendering",null),(0,r._)([(0,w.MZ)({readOnly:!0})],wn.prototype,"_usePhysicalPixelRenderingAny",null),(0,r._)([(0,w.MZ)()],wn.prototype,"_windowDevicePixelRatio",void 0),(0,r._)([(0,w.MZ)()],wn.prototype,"_devicePixelRatioOverride",void 0),wn=(0,r._)([(0,C.$)("esri.views.3d.state.ViewStateManager")],wn);class xn{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const Cn=new Set(["camera","viewpoint","extent","scale","center","zoom"]),Tn=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Mn={heading:0,tilt:0},Sn=new s.default,Rn=new or.default,An=(0,js.vt)(),En="pending-initial-view",On="content-camera-reset",Pn=300;let Dn=class extends nr{constructor(){super(...arguments),this.startCamera=new or.default,this.currentCamera=new or.default,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<100}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=sr.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout((()=>this.notifyChange("isInteractive")),100),this.view.state.updateCamera((e=>this.stepController(0,e))),this.steppingFinished&&this.finishController()}};var In;(0,r._)([(0,w.MZ)({readOnly:!0})],Dn.prototype,"isInteractive",null),(0,r._)([(0,w.MZ)()],Dn.prototype,"_lastInteraction",void 0),Dn=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.InteractiveController")],Dn),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(In||(In={}));let Ln=class extends Dn{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=In.CENTER,this._rotScale=0,this._lastPoint=(0,Ge.vt)(),this._tmpWorldUp=(0,E.vt)(),this._tmpViewDir=(0,E.vt)(),this._tmpRotCurPoint=(0,Ge.vt)(),this._tmpTransf=(0,Ue.vt)(),this._tmpAxis=(0,E.vt)(),this._tmpPivotPoint=(0,E.vt)(),this._pivotPos=(0,E.vt)(),this._constraintOptions=new Jt($t.ALL,Qt.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===In.CENTER?3:1.5}begin(e){if(this.running){switch(this.pivot){case In.EYE:(0,Me.c)(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Qt.LOOK_AROUND,this._constraintOptions.tiltMode=Yt.LOOK_AROUND,this._constraintOptions.selection=$t.NONE;break;case In.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?Pr:{});t||(0,Me.c)(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Qt.TUMBLE,this._constraintOptions.tiltMode=Yt.TUMBLE,this._constraintOptions.selection=$t.ALL&~$t.DISTANCE;break}}Dr(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=(0,E.vt)();(0,Me.d)(r,this._pivotPos,i.eye);const s=(0,Me.l)(r),n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,Hn);let a=Math.max(Math.min(5,1/Math.abs((0,Me.f)(Hn,i.viewForward)))*n,10);t&&(a=Math.min(s,a));const o=(0,y.gs)(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=Zr(this.startCamera,o,this.view.renderCoordsHelper,this.view.viewingMode);let h=this.view._stage.renderView.getMinimalDepthForArea((0,Vs.ds)(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,225,90),c=this.view._stage.renderView.getMinimalDepthForArea((0,Vs.ds)(this.view),e[0],e[1],i,90);null==h&&null==c||(h=h??c??0,c=null==c||l===qr.Horizontal?h:c,a=h>c?c:h,a=t?Math.min(a,s):a),(0,Me.n)(r,r),(0,Me.c)(this._pivotPos,(0,Me.g)(this._tmpPivotPoint,i.eye,(0,Me.h)(this._tmpPivotPoint,r,a)))}update(e){if(this.running){switch(this.pivot){case In.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case In.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Vi(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),Dr(e,t,this._tmpRotCurPoint);let s=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;(0,Me.d)(this._tmpViewDir,i,r);const a=(0,Me.l)(this._tmpViewDir),o=(0,de.XM)((0,Me.f)(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===In.EYE){s*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;s=e-Math.max(-t,Math.min(t,e+s))}return s=(0,de.qE)(s+o,ge.min,ge.max)-o,(0,Me.e)(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===In.CENTER&&(n=-n),(0,Ve.$0)(this._tmpTransf,n,this._tmpWorldUp),(0,Ve.e$)(this._tmpTransf,this._tmpTransf,s,this._tmpAxis),(0,Me.t)(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=(0,Me.t)(Nn,e.up,this._tmpTransf),(0,Me.g)(Nn,r,this._tmpViewDir),(0,ze.C)(this._lastPoint,this._tmpRotCurPoint),Nn}};(0,r._)([(0,w.MZ)()],Ln.prototype,"pivot",void 0),Ln=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.RotateController")],Ln);const Nn=(0,E.vt)(),Hn=(0,E.vt)();class Fn extends ks.l{constructor(e,t,i,r){super(!0),this._view=e,this.pointerActions=t,this._pivot=i,this.registerIncoming("drag",r,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!(0,Bs.rE)(e.data,this.pointerActions))return;const i=(0,y.gs)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Ln({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}var Vn=i(21704),Un=i(6579),zn=i(27811),Gn=(i(17745),i(76697)),qn=i(87118);const kn="esri-fov-overlay",Bn={base:kn,outer:`${kn}-outer`,reset:`${kn}-reset`,text:`${kn}-text`};let Wn=class extends zn.default{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return(0,qn.K)("div",{class:Bn.outer},(0,qn.K)("div",{class:Bn.base},(0,qn.K)("p",{class:Bn.text},this._overlay),(0,qn.K)("p",{class:Bn.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||null==e)return"";const i=(0,Un.Me)((0,de.KJ)(e),"degrees","arithmetic","arithmetic",0),r=Zn/(2*Math.tan(e/2));return`${i} | ${(0,Un.zJ)(t,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&null!=this.fov?"\u21ba":""}};(0,r._)([(0,w.MZ)()],Wn.prototype,"onReset",void 0),(0,r._)([(0,w.MZ)(),(0,Gn.G)("esri/t9n/common")],Wn.prototype,"_messagesCommon",void 0),(0,r._)([(0,w.MZ)(),(0,Gn.G)("esri/core/t9n/Units")],Wn.prototype,"_messagesUnits",void 0),(0,r._)([(0,w.MZ)()],Wn.prototype,"fov",void 0),(0,r._)([(0,w.MZ)()],Wn.prototype,"_overlay",null),(0,r._)([(0,w.MZ)()],Wn.prototype,"_reset",null),Wn=(0,r._)([(0,C.$)("esri.widgets.FovOverlay")],Wn);const Zn=Math.sqrt(1872);let jn=class extends Dn{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov($n),this.updateTimeout()},this._center=(0,E.vt)(),this._viewForward=(0,E.vt)(),this._constraints=new Jt($t.ALL,Qt.ZOOM)}begin(e){!function(e){return!Array.isArray(e)}(e)?(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera)):this._showOverlay().fov=e.fov}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(null==this._lastDrag)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=(0,de.KJ)(i.fov)+e,s=(0,de.kU)((0,de.qE)(r,Qn,Yn));s!==i.fov?this._setFov(s):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new Vn.A({id:"esri.FovOverlay",node:new Wn({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=(0,p.pR)(this._overlay))}_setFov(e){const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=this._ensureStartSize(i)/Math.tan(e/2),s=(0,Me.g)(Xn,this._center,(0,Me.h)(Xn,this._viewForward,-r));i.eye=s,i.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=Ui(this.currentCamera.height-t.camera.height),Vi(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(e){if(null==this._startSize){(0,Me.c)(this._viewForward,e.viewForward);const t=this.view._stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,80),i=(0,Me.j)(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=t??i;(0,Me.g)(this._center,e.eye,(0,Me.h)(Xn,this._viewForward,r)),this._startSize=r*Math.tan(e.fov/2)}return this._startSize}};(0,r._)([(0,w.MZ)()],jn.prototype,"onStop",void 0),jn=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.FovController")],jn);const $n=(0,de.kU)((new s.default).fov),Qn=10,Yn=150,Xn=(0,E.vt)();let Kn=class extends Dn{constructor(){super(...arguments),this._pickPoint=(0,E.vt)(),this._tmpP0=(0,Ge.vt)(),this._panAxisAngle=yr(),this._tmpRayDir=(0,E.vt)(),this._tmpRayDirPick=(0,E.vt)(),this._targetOnSphere=(0,E.vt)(),this._navMode=qr.Horizontal,this._tmpRay={origin:(0,E.vt)(),direction:(0,E.vt)()},this.dragBeginPoint=(0,y.gs)(),this._normalizedAnchorPoint=(0,Ge.vt)(),this._constraintOptions=new Jt($t.ALL_EXCEPT_COLLISION,Qt.ZOOM,0,this.startCamera),this._sphere=(0,Kt.c)(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;(0,ze.C)(this.dragBeginPoint,e),Dr(this.startCamera,e,this._normalizedAnchorPoint);const t=(0,Pe.tO)(this.view.spatialReference),i=Wr(this._intersectionHelper,this.startCamera,e,t,Rr.Ellipsoid,0===this.view.map.ground.opacity?Pr:{});if(this._navMode=Zr(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===qr.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let t;(0,Tr.vr)(this.startCamera,e,this._tmpRay),(0,Me.n)(this._tmpRay.direction,this._tmpRay.direction),null!=i.scenePickPoint&&((0,Me.d)(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),t=(0,Me.l)(this._tmpRayDirPick));const r=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,ea);let s=(0,de.qE)(Math.min(30,1/Math.abs((0,Me.f)(ea,this._tmpRay.direction)))*r,Er[0],Er[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);s=null!=n?n:s,s=null!=t?Math.min(s,t):s,this._hasPickPoint=!0,(0,Me.h)(this._tmpRay.direction,this._tmpRay.direction,s),(0,Me.g)(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===qr.Horizontal){(0,Me.d)(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=(0,Me.l)(this._tmpRayDir);Dr(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this._sphere[3]/(0,Me.l)(this.currentCamera.center));this.currentCamera.center=(0,Me.h)(Jn,this.currentCamera.center,e)}(0,Me.h)(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=(0,Me.g)(Jn,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Ui((0,ze.Io)(this.dragBeginPoint,e)),Vi(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(Qr(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),wr(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Lr(this.currentCamera,(0,Kt.a)(this._sphere),this._panAxisAngle))}else{const t=(0,Me.l)(this._tmpRay.direction);Dr(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;(0,Me.h)(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=(0,Me.g)(Jn,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=(0,Me.g)(Jn,this.currentCamera.center,this._tmpRayDir)}wi(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};Kn=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.ZoomControllerGlobal")],Kn);const Jn=(0,E.vt)(),ea=(0,E.vt)();let ta=class extends Dn{constructor(){super(...arguments),this._tmpP=(0,E.vt)(),this._tmpDir=(0,E.vt)(),this._tmpN=(0,E.vt)(),this._tmpP0=(0,Ge.vt)(),this._tmpPoi=(0,E.vt)(),this._tmpRayDir=(0,E.vt)(),this.dragBeginPoint=(0,y.gs)(),this._normalizedAnchorPoint=(0,Ge.vt)(),this._constraintOptions=new Jt($t.ALL,Qt.ZOOM,0,this.startCamera,(0,E.vt)()),this._plane=(0,Cr.vt)()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;(0,ze.C)(this.dragBeginPoint,e),Dr(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,0===this.view.map.ground.opacity?Pr:{});(0,Me.d)(this._tmpDir,this._tmpP,this.startCamera.eye);const i=(0,Me.l)(this._tmpDir);(0,Me.n)(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z);let s=(0,de.qE)(Math.min(30,1/Math.abs((0,Me.f)(ra,this._tmpDir)))*r,Er[0],Er[1]);const n=this.view._stage.renderView.getMinimalDepthForArea((0,Vs.ds)(this.view),e[0],e[1],this.view.state.camera,80);s=null!=n?n:s,s=t?Math.min(s,i):s,(0,Me.h)(this._tmpDir,this._tmpDir,s),(0,Me.g)(this._tmpP,this.startCamera.eye,this._tmpDir),(0,Me.d)(this._tmpN,this.startCamera.eye,this.startCamera.center),(0,Me.n)(this._tmpN,this._tmpN),this._tmpN[1]<0&&(0,Me.v)(this._tmpN,this._tmpN),(0,Cr.O_)(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;(function(e,t,i,r){return(0,Cr.Ui)(e,(0,Tr.Z4)(t,i,Is),r)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||(0,Me.c)(this._tmpPoi,this.currentCamera.center),Dr(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);(0,ze.C)(this._normalizedAnchorPoint,this._tmpP0),(0,Me.d)(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=(0,Me.l)(this._tmpRayDir);let r=i*(1-t);this._constraintOptions.interactionDirection&&((0,Me.c)(this._constraintOptions.interactionDirection,this._tmpRayDir),(0,Me.h)(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||((0,Me.h)(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=(0,Me.g)(ia,this.currentCamera.eye,this._tmpRayDir),(0,Me.m)(ia,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?ia[2]=Math.max(this.startCamera.center[2],ia[2]):ia[2]=Math.min(this.startCamera.center[2],ia[2]),this.currentCamera.center=ia,this._constraintOptions.interactionFactor=Ui((0,ze.Io)(this.dragBeginPoint,e)),Vi(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};ta=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.ZoomControllerLocal")],ta);const ia=(0,E.vt)(),ra=(0,E.fA)(0,0,1);class sa extends ks.l{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=i,this.registerIncoming("drag",[i],(e=>this._handleZoom(e))),this.registerIncoming("drag",(e=>this._handleZoom(e)))}_handleZoom(e){const t=e.data;if(t.pointers.size>1)return;if(!(0,Bs.rE)(e.data,this.pointerActions))return;const i=(0,y.gs)(t.center.x,t.center.y);switch(t.action){case"start":{this._cameraController?.finish();const t=this._view,r=e.modifiers.has(this._fovModifier);this._cameraController=r?new jn({view:t,onStop:()=>this._stopController()}):t.state.isGlobal?new Kn({view:t}):new ta({view:t}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break}case"update":this._cameraController?.update(i);break;case"end":this._cameraController instanceof jn?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}}var na=i(90834),aa=i(86767),oa=i(91025);let la=class extends Dn{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new or.default,this._headingStart=0,this._constraintOptions=new Jt($t.ALL,Qt.NONE,0,new or.default,null,Yt.LOOK_AROUND)}handleEventGamepad(e){const t=(0,oa.f4)(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||(0,oa.IK)(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,(0,oa.UM)(this._keysButtonState,this._transformation)}directionActive(e){return 1===this._keysButtonState[e]}countActiveDirections(){return this._keysButtonState.reduce(((e,t)=>t>0?e+1:e),0)}deactivateDirection(e){this._keysButtonState[e]=0;const t=(0,oa.UM)(this._keysButtonState,this._transformation);(0,oa.IK)(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,ga),this._applyDisabledMovementTypes(ga),this._applyPan(ga.pan),this._applyRotate(ga.rotate),this._applyZoom(ga.zoom),this._applyAscend(ga.ascend),this._constraintOptions.interactionType=Qt.NONE,this._constraintOptions.selection=$t.COLLISION,Vi(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;(0,Me.d)(fa,t.center,t.eye),(0,Me.t)(fa,fa,e.matrix),t.center=(0,Me.g)(fa,fa,t.eye),t.up=(0,Me.t)(fa,t.up,e.matrix),this._constraintOptions.interactionType=Qt.LOOK_AROUND,this._constraintOptions.selection=$t.ALL_EXCEPT_COLLISION,Vi(this.view,t,this._constraintOptions)}_applyPan(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.currentCamera;e.enabled&&(t.eye=(0,Me.t)(fa,t.eye,e.matrix),t.center=(0,Me.t)(fa,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,Me.t)(fa,t.up,e.matrix)),this._constraintOptions.interactionType=Qt.PAN,this._constraintOptions.selection=$t.ALL,Vi(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=(0,Me.g)(fa,this.currentCamera.eye,(0,Me.h)(fr.rq.get(),t,e)),(0,Me.c)(ya,t),(0,Me.v)(ya,ya),this._constraintOptions.interactionDirection=ya,this._constraintOptions.interactionType=Qt.ZOOM,this._constraintOptions.selection=$t.ALL_EXCEPT_COLLISION,Vi(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,fr.rq.get());if(this._constraintOptions.interactionDirection=(0,Me.c)(ya,t),this.view.state.isGlobal){const t=(0,Me.l)(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=(0,Me.h)(fa,this.currentCamera.eye,i),this.currentCamera.center=(0,Me.h)(fa,this.currentCamera.center,i)}else{const i=(0,Me.h)(fr.rq.get(),t,e);this.currentCamera.eye=(0,Me.g)(fa,this.currentCamera.eye,i),this.currentCamera.center=(0,Me.g)(fa,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=Qt.ASCEND,this._constraintOptions.selection=$t.COLLISION,Vi(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=$t.ALL_EXCEPT_COLLISION,Vi(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,Ve.D_)(e.pan.matrix),e.rotate.enabled=!1,(0,Ve.D_)(e.rotate.matrix)}(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,fa)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,n=this._transformation,a=this.view.navigation.gamepad,o=(0,Me.i)(fr.rq.get(),s[0],s[1],0);(0,Me.n)(o,o);const l=n.translation[0]*e.pan;if(0!==l){const e=(0,Me.h)(fr.rq.get(),r,l);(0,Ve.Tl)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(a.mode){case"pan":{const t=-n.translation[1]*e.pan;if(0!==t){const e=(0,Me.h)(fr.rq.get(),o,t);(0,Ve.Tl)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:(0,He.Xb)(a.mode)}const h=n.translation[2]*e.ascend;i.ascend=h;const c=-n.heading*e.rotate;0!==c&&((0,Ve.e$)(i.rotate.matrix,i.rotate.matrix,c,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,fr.rq.get())),i.rotate.enabled=!0);const d=n.tilt*e.rotate,u=(0,Ti.T)(this.view.renderCoordsHelper,t.center,t.eye),p=(0,de.qE)(u+d,ge.min,ge.max)-u;p&&((0,Ve.e$)(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,n=this._transformation,a=this.view.navigation.gamepad,o=(0,Me.e)(fr.rq.get(),s,r);(0,Me.n)(o,o),(0,Me.v)(o,o),ps(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(ga.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=n.translation[2]*e.ascend;i.ascend=h;const c=-n.heading*e.rotate;0!==c&&((0,Ve.e$)(i.rotate.matrix,i.rotate.matrix,c,this._tmpCamera.eye),i.rotate.enabled=!0);const d=n.tilt*e.rotate,u=this._clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&((0,Ve.e$)(i.rotate.matrix,i.rotate.matrix,u,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=(0,Pe.tO)(this.view.spatialReference),s=zr(ge.min,t.origin,i,r);let n=0,a=0;const o=fr.rq.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){n=zr((0,Ti.T)(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),a=zr(ge.max,t.origin,i,r)}else{(0,Kt.k)((0,Kt.b)(Kt.t,i+r.radius),t,o);n=Gr(Math.PI+(0,gr.g7)(t.direction,o),t.origin,i,r),a=Gr(ge.max,t.origin,i,r)}return(0,de.qE)(n+e,s,a)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),n=t+Math.abs(s-t);return r.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=(0,mn.ZC)(this.view,t,0,ca,va),n=i.intersectManifoldClosestSilhouette((0,Xt.LV)(t,s),e,fr.rq.get()),a=(0,Me.j)(t,n),o=i.intersectManifoldClosestSilhouette((0,Xt.LV)(t,(0,Me.o)(fr.rq.get(),t,r.center)),e,fr.rq.get()),l=(0,Me.j)(t,o);return Math.min(a,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,fr.rq.get());if(s){const t=(0,Me.d)(fr.rq.get(),e,n),i=(0,Me.l)(t);(0,Me.h)(t,t,1/i);const r=(0,Me.n)(fr.rq.get(),e),s=(0,de.XM)((0,Me.f)(r,t));return i*Math.sin(Math.min(da,s))}{const i=(0,Me.c)(fr.rq.get(),e);return t.setAltitude(i,this._filteredSurfaceElevation),(0,Me.j)(n,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:pa}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+(0,Pe.tO)(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=fr.rq.get(),a=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),o=this._clampedDistanceToSurface(t,n),l=r.width/2,h=ua*r.width,c=ua*r.width,d=o*Math.tan(.5*r.fovX)/l,u=d/i,p=d/this._computeHeadingRotateRadius(n),m=a-t;return{pan:(s?u:d)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/l)*m-m),zoom:2**(h*e/l)*o-o,rotate:(0,de.qE)(p*c,ma,_a)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,Ve.D_)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,Ve.D_)(e.rotate.matrix))}static activatesFor(e,t){const i=(0,oa.f4)(t,e.navigation.gamepad,ha);return!("end"===t.action||(0,oa.IK)(i))}};(0,r._)([(0,w.MZ)({constructOnly:!0})],la.prototype,"gamepadDevice",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],la.prototype,"disableMovements",void 0),la=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.GamepadKeyboardController")],la);const ha={translation:[0,0,0],heading:0,tilt:0,zoom:0},ca=80,da=(0,de.kU)(ca),ua=.75,pa=5,ma=(0,de.kU)(30),_a=(0,de.kU)(80),ga={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,Ue.vt)()},rotate:{enabled:!1,matrix:(0,Ue.vt)()}},fa=(0,E.vt)(),ya=(0,E.vt)(),va=(0,aa.NP)();class ba extends ks.l{constructor(e){super(!0),this._view=e,this._watchHandles=new na.default,this._handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([(0,g.watch)((()=>this._view.navigation.gamepad.enabled),(e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))}),g.initial),(0,g.watch)((()=>this._view.navigation.gamepad.device),(e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)}))])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad?.running;if(i||la.activatesFor(this._view,e.data)){if(!i){const t=new la({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t),t.state!==sr.Rejected&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}var wa,xa=i(26135);!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(wa||(wa={}));class Ca extends ks.l{constructor(e,t){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:X.RT.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(t),this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleStop())),this._visibilityHandle=(0,xa.e)((e=>e?null:this._handleStop()))}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,wa.LEFT),this._addKeyMapping(e.pan.right,wa.RIGHT),this._addKeyMapping(e.pan.forward,wa.FORWARD),this._addKeyMapping(e.pan.backward,wa.BACKWARD),this._addKeyMapping(e.pan.up,wa.UP),this._addKeyMapping(e.pan.down,wa.DOWN),this._addKeyMapping(e.lookAround.headingLeft,wa.HEADINGLEFT),this._addKeyMapping(e.lookAround.headingRight,wa.HEADINGRIGHT),this._addKeyMapping(e.lookAround.tiltUp,wa.TILTUP),this._addKeyMapping(e.lookAround.tiltDown,wa.TILTDOWN),this._addKeyMapping(e.zoom.zoomIn,wa.ZOOMIN),this._addKeyMapping(e.zoom.zoomOut,wa.ZOOMOUT),this._addKeyAction(e.reset.heading,(()=>this._resetHeading())),this._addKeyAction(e.reset.tilt,(()=>this._resetTilt()))}_addKeyMapping(e,t){for(const i of this._eachKey(e))this._keyToDirection.set(i,t)}*_eachKey(e){"string"==typeof e?yield e:yield*e}_addKeyAction(e,t){for(const i of this._eachKey(e))this._keyToAction.set(i,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToAction.get(e.data.key);if(null!=t)return e.stopPropagation(),void t();const i=this._keyToDirection.get(e.data.key);if(null!=i&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new la({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i))return;if(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout((()=>{this._stickyKeyTimeoutHandle=void 0,null!=this._stickyDirection&&void 0!==this._stickyDirection&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)}),this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;const t=this._keyToDirection.get(e.data.key);if(null==t)return;e.stopPropagation();const i=void 0===this._stickyKeyTimeoutHandle;void 0===this._stickyKeyTimeoutHandle||1!==this._cameraControllerKeyboard?.countActiveDirections()?(this._cameraControllerKeyboard?.deactivateDirection(t),i&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch((()=>{}))}_resetTilt(){this._view.goTo({tilt:0}).catch((()=>{}))}}class Ta extends ks.l{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],(e=>this._handleFov(e))),this.registerIncoming("mouse-wheel",(e=>this._handleZoom(e)))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;const t=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new Ns({view:this._view,mode:"interaction"}):new Us({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-t.deltaY/60,(0,y.gs)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new jn({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==sr.Rejected)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return"zoom"===this._view.navigation.actionMap.mouseWheel}_stopFovController(){this._fovController?.finish(),this._fovController=null}}class Ma{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let Sa=class extends ar{constructor(){super(...arguments),this._beginCamera=new or.default,this._elapsedTimeSec=0,this.constraintOptions=new Jt($t.ALL,Qt.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new Y.default}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Vi(this.view,t,this.constraintOptions)}};Sa=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.momentum.MomentumController")],Sa);let Ra=class extends Sa{constructor(e){super(e),this.interactionType=Qt.PAN,this._tmpPan=(0,E.vt)()}momentumStep(e,t){const i=this.momentum.value(e);(0,Me.h)(this._tmpPan,this.momentum.direction,i),t.eye=(0,Me.d)(Aa,t.eye,this._tmpPan),t.center=(0,Me.d)(Aa,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};(0,r._)([(0,w.MZ)({constructOnly:!0})],Ra.prototype,"momentum",void 0),Ra=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Ra);const Aa=(0,E.vt)(),Ea=(0,E.vt)(),Oa=(0,E.vt)();let Pa=class extends Sa{constructor(e){super(e),this.interactionType=Qt.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);(0,Me.c)(Oa,t.eye),(0,Me.n)(Oa,Oa),(0,Me.e)(this.momentum.axis2,Oa,this.momentum.axis1),ss(t,Ea,this.momentum.axis1,i,this.momentum.axis2,r)}};(0,r._)([(0,w.MZ)({constructOnly:!0})],Pa.prototype,"momentum",void 0),Pa=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Pa);let Da=class extends Sa{set center(e){this._set("center",(0,E.o8)(e))}set axis(e){this._set("axis",(0,E.o8)(e))}constructor(e){super(e),this.interactionType=Qt.TUMBLE}momentumStep(e,t){const i=this.momentum.value(e);Lr(t,this.center,vr(this.axis,i))}};(0,r._)([(0,w.MZ)({constructOnly:!0})],Da.prototype,"momentum",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Da.prototype,"center",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],Da.prototype,"axis",null),Da=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.momentum.RotationMomentumController")],Da);let Ia=class extends Sa{set zoomCenter(e){this._set("zoomCenter",(0,E.o8)(e))}constructor(e){super(e),this.interactionType=Qt.ZOOM,this.constraintOptions.interactionDirection=(0,E.vt)()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;(0,Me.c)(i,t.eye);const r=this.momentum.valueDelta(0,e);Hr(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),(0,Me.o)(i,t.eye,i)}};(0,r._)([(0,w.MZ)({constructOnly:!0})],Ia.prototype,"momentum",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Ia.prototype,"zoomCenter",null),Ia=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Ia);let La=class extends Sa{set screenCenter(e){this._set("screenCenter",(0,y.gs)(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",(0,E.o8)(e))}constructor(e){super(e),this.interactionType=Qt.ZOOM,this.radius=0,this._tmpSceneCenter=(0,E.vt)(),this._tmpZoomAxisAngle=yr(),this._sphere=(0,Kt.c)()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Fr(this._sphere,t,i),this.constraintOptions.interactionType=Qt.ZOOM,Vi(this.view,t,this.constraintOptions),Qr(this._sphere,t,this.screenCenter,this._tmpSceneCenter),wr(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Lr(t,(0,Kt.a)(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Qt.PAN}};(0,r._)([(0,w.MZ)({constructOnly:!0})],La.prototype,"momentum",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],La.prototype,"screenCenter",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],La.prototype,"sceneCenter",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],La.prototype,"radius",void 0),La=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],La);var Na=i(81146),Ha=i(88664);class Fa{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}var Va=i(23521);const Ua=1e-5;class za extends Va.t{constructor(e,t,i,r,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6?arguments[6]:void 0;super(e,t,i),this._angularVelocity1=r,this.axis1=s,this.angularVelocity2=n,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class Ga{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=(0,E.vt)(),this._tmpAxis2=(0,E.vt)(),this._tmpAngles=(0,Ge.vt)(),this._time=new Ha.S(.3),this._screen=[new Ha.S(.4),new Ha.S(.4)],this._angle1=new Fa(.6),this._angle2=new Fa(.6),this._axis1=(0,E.vt)(),this._axis2=(0,E.vt)(),this._lastScene=(0,E.vt)()}addMomentumDirectRotation(e,t,i,r,s,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=Jr(this._lastScene,t,this._tmpAxis2,r,s,n);this._angle2.update(0),(0,Me.k)(this._tmpAxis2)<Ua?e=0:(0,Me.n)(this._axis1,this._tmpAxis2),this._angle1.update(e),(0,Me.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,n,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;is(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,s,n,a,!1),(0,Me.k)(this._tmpAxis2)<Ua?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),(0,Me.n)(this._axis1,this._tmpAxis1),(0,Me.n)(this._axis2,this._tmpAxis2)),(0,Me.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,s=null==i||null==r?0:i/r;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,i){const r=this._time.filteredDelta,s=this._angle1.filteredValue,n=this._angle2.filteredValue,a=null==r||null==n?0:n/r;return new za(e,t,i,null==r||null==s?0:s/r,this._axis1,a,this._axis2)}}var qa=i(99749),ka=i(45666);let Ba=class extends Dn{constructor(){super(...arguments),this._smoothRotation=new Ma(.05),this._rotationAxis=(0,E.vt)(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=(0,Cr.vt)(),this._beginRadius=0,this._smoothScaling=new Ma(.05),this._zoomCenterScreen=(0,y.gs)(),this._zoomMomentumEstimator=new ka.y,this._rotationMomentumEstimator=new qa.H,this._panSphericalMomentumEstimator=new Ga,this._panPlanarMomentumEstimator=new Na.O,this._adjustedSphere=(0,Kt.c)(),this._tmp3d=(0,E.vt)(),this._tmpScreenPointArray=(0,y.gs)(),this._beginScreenPoint=(0,y.gs)(),this._beginScenePoint=(0,E.vt)(),this._screenPickPoint=(0,y.gs)(),this._scenePickPoint=(0,E.vt)(),this._navMode=qr.Horizontal,this._sphere=(0,Kt.c)(),this._pointerCount=0,this._tmpInteractionDirection=(0,E.vt)(),this._beginCamera=new or.default,this._constraintOptions=new Jt($t.ALL,Qt.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-pr.wf.normalize((0,de.kU)(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),(0,y.WA)(e.center,this._screenPickPoint),(0,ze.C)(this._beginScreenPoint,this._screenPickPoint);const t=(0,Pe.tO)(this.view.spatialReference),i=Wr(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,Rr.Silhouette,0===this.view.map.ground.opacity?Pr:{});null!=i.scenePickPoint&&(this._scenePickPoint=i.scenePickPoint,this._sphere=i.sphere,(0,Me.c)(this._beginScenePoint,this._scenePickPoint),this._navMode=Zr(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===qr.Vertical&&this._preparePlanarPanMode(e,i.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navMode===qr.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===qr.Horizontal?new La({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Ia({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Da({view:this.view,momentum:i,center:(0,Kt.a)(this._sphere),axis:this._rotationAxis});if(this._navMode===qr.Horizontal){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new Pa({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new Ra({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const i=(0,Me.v)(this._tmp3d,this.startCamera.viewForward);(0,Cr.O_)(this._scenePickPoint,i,this._panningPlane);const r=(0,y.gs)(this._screenPickPoint[0],0),s=(0,E.vt)(),n=(0,Me.l)(this.startCamera.eye);this._adjustedSphere[3]=n<this._sphere[3]?n-100:this._sphere[3],Qr(this._adjustedSphere,this.startCamera,r,s);const a=(0,y.r_)();this.startCamera.projectToRenderScreen(s,a);const o=(0,E.vt)(),l=(0,E.vt)(),h=(0,E.vt)();(0,Me.d)(o,this._scenePickPoint,this.currentCamera.eye);const c=(0,Me.l)(o);(0,Me.n)(o,o);const d=5*Math.max(Math.abs(this.view.camera.position.z),50),u=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80);let p=null!=u?u:d;p=t?Math.min(p,c):p,(0,Me.c)(h,(0,Me.g)(l,this.currentCamera.eye,(0,Me.h)(l,o,p))),this._panningPlane[3]=-(0,Me.f)((0,Cr.Qj)(this._panningPlane),h),this.startCamera.center=(0,Me.g)(l,this.startCamera.eye,(0,Me.h)(l,this.startCamera.viewForward,p));const m=(0,y.WA)(e.center,this._tmpScreenPointArray);Nr(this._panningPlane,this.startCamera,m,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),Fr(this._sphere,this.currentCamera,this._smoothScaling.value),(0,y.WA)(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Qt.ZOOM,this._constraintOptions.interactionFactor=Ui(e.radius-this._beginRadius),Vi(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=(0,y.WA)(e.center,this._tmpScreenPointArray);Qr(this._sphere,this.currentCamera,t,this._tmp3d),cs(this._beginScenePoint,(0,Me.f)(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(us(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(ds(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Qt.PAN,this._constraintOptions.interactionFactor=Ui((0,ze.Io)(this._screenPickPoint,t)),Vi(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){(0,Me.n)(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||(0,Me.v)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+Ir(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),Lr(this.currentCamera,(0,Kt.a)(this._sphere),vr(this._rotationAxis,s)),this._constraintOptions.interactionType=Qt.TUMBLE,this._constraintOptions.interactionFactor=Ui(e.radius*i),Vi(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=(0,y.WA)(e.center,this._tmpScreenPointArray);Nr(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(jr(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Qt.PAN,this._constraintOptions.interactionFactor=Ui((0,ze.Io)(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Vi(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Hr(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Qt.ZOOM,this._constraintOptions.interactionFactor=Ui(e.radius-this._beginRadius),Vi(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){(0,Me.c)(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||(0,Me.v)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=Ir(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(r);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Lr(this.currentCamera,(0,Kt.a)(this._sphere),vr(this._rotationAxis,n)),this._constraintOptions.interactionType=Qt.TUMBLE,this._constraintOptions.interactionFactor=Ui(e.radius*n),Vi(this.view,this.currentCamera,this._constraintOptions)}};Ba=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],Ba);const Wa=(0,E.fA)(0,0,1);let Za=class extends Dn{constructor(){super(...arguments),this._rotationValueSmooth=new Ma(.05),this._scalingValueSmooth=new Ma(.05),this._planeHorizontal=(0,Cr.vt)(),this._planeVertical=(0,Cr.vt)(),this._rotationMomentumEstimator=new qa.H,this._panMomentumEstimator=new Na.O(300,12,.9),this._zoomMomentumEstimator=new ka.y,this._beginRadius=0,this._beginCenter=(0,E.vt)(),this._beginAngle=0,this._tmpPoints=[],this._navMode=qr.Horizontal,this._beginCenterScreen=(0,y.gs)(),this._tmpCentroid3d=(0,E.vt)(),this._tmpCentroid2d=(0,y.gs)(),this._tmp2d=(0,y.gs)(),this._pointerCount=0,this._beginCamera=new or.default,this._constraintOptions=new Jt($t.ALL,Qt.NONE,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),(0,y.WA)(e.center,this._beginCenterScreen),(0,Cr.UB)(Wa,0,this._planeHorizontal);const i=(0,E.vt)(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,0===this.view.map.ground.opacity?Pr:{}),s=(0,E.vt)();(0,Me.v)(s,this.startCamera.viewForward);const n=(0,E.vt)();(0,Me.c)(n,Wa);const a=(0,Me.f)(s,n);this._navMode=Zr(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const o=Math.min(5,1/Math.abs((0,Me.f)(n,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);(0,Cr.mP)(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||(0,Cr.ze)(this._planeHorizontal,this._planeHorizontal);const l=(0,E.vt)(),h=(0,E.vt)(),c=(0,E.vt)();(0,Me.d)(l,i,this.currentCamera.eye);const d=(0,Me.l)(l);if((0,Me.n)(l,l),this._navMode===qr.Vertical){(0,Me.h)(n,n,a),(0,Me.d)((0,Cr.Qj)(this._planeVertical),s,n),(0,Me.n)((0,Cr.Qj)(this._planeVertical),(0,Cr.Qj)(this._planeVertical)),(0,Cr.mP)(this._planeVertical,this._planeVertical,i);const t=this.view._stage.renderView.getMinimalDepthForArea((0,Vs.ds)(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80);let u=null!=t?t:o;u=r?Math.min(u,d):u,(0,Me.c)(c,(0,Me.g)(h,this.currentCamera.eye,(0,Me.h)(h,l,u))),this._planeVertical[3]=-(0,Me.f)((0,Cr.Qj)(this._planeVertical),c),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),Ur(this._tmpPoints,this._beginCenter)}else{const t=r?d:o;(0,Me.c)(c,(0,Me.g)(h,this.currentCamera.eye,(0,Me.h)(h,l,t))),this._planeHorizontal[3]=-(0,Me.f)((0,Cr.Qj)(this._planeHorizontal),c),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),Ur(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._navMode===qr.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=i,this._scalingValueSmooth.update(t),Hr(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Qt.ZOOM,this._constraintOptions.interactionFactor=Ui(Math.abs(e.radius-this._beginRadius)),Vi(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),Ur(this._tmpPoints,this._tmpCentroid3d),(0,y.WA)(e.center,this._tmpCentroid2d),jr(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Qt.PAN,this._constraintOptions.interactionFactor=Ui((0,ze.Io)(this._beginCenterScreen,this._tmpCentroid2d)),Vi(this.view,this.currentCamera,this._constraintOptions),t){const t=r,i=this._rotationValueSmooth.value,s=i+Ir(e.angle-i),n=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=n,this._rotationValueSmooth.update(s);const a=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp);const o=(0,Cr.Qj)(this._planeHorizontal);Lr(this.currentCamera,t,vr(o,a)),this._constraintOptions.interactionType=Qt.TUMBLE,this._constraintOptions.interactionFactor=Ui(Math.abs(e.radius*a)),Vi(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new Ia({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Da({view:this.view,momentum:i,center:this._beginCenter,axis:(0,Cr.Qj)(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new Ra({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;const s=this._tmp2d;let n=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===r[n]&&(r[n]=(0,E.vt)()),Nr(t,i,s,r[n]),n+=1})),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Za=(0,r._)([(0,C.$)("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],Za);class ja extends ks.l{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!(0,Bs.rE)(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,i=this._momentum&&this._momentum.running&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Ba({view:this._view}):new Za({view:this._view})}}class $a extends ks.l{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class Qa extends ks.l{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){const t=this._invert?-1:1,i=(0,y.gs)(0,e.data.delta*t);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new Ln({view:this._view,pivot:In.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}}var Ya=i(87757),Xa=i(51232),Ka=i(15271),Ja=i(92633),eo=i(99347),to=i(2102),io=i(97995),ro=i(65422);class so extends ks.l{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:40;super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new ro.w({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this._dragEventSeparator.handle(e)))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,n=1/0;for(const{x:m,y:_}of t.pointers.values())i=Math.max(i,m),r=Math.min(r,m),s=Math.max(s,_),n=Math.min(n,_);let a=-1/0,o=1/0,l=-1/0,h=1/0;for(const{x:m,y:_}of e.pointers.values())a=Math.max(a,m),o=Math.min(o,m),l=Math.max(l,_),h=Math.min(h,_);const c=i-r,d=s-n,u=a-o,p=l-h;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-c)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const s=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-s.y))})),i>=this._threshold}}let no=class extends M.default{constructor(){super(...arguments),this.mode="default",this._updateMode=e=>{let{mode:t,dragPrimary:i,dragSecondary:r,dragTertiary:s}=e;"pro"===t&&(r="zoom",s="pan"===i?"rotate":"pan");const n={dragPrimary:i,dragSecondary:r,dragTertiary:s};this._modeDragPan&&(this._modeDragPan.pointerActions=(0,Bs.nq)("pan",n)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=(0,Bs.nq)("rotate",n)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=(0,Bs.nq)("zoom",n))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary="pan"===e?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=(0,p.pR)(this._inputManager),this._source=(0,p.pR)(this._source)}connect(){const e=this.view;this._source=new Ya.S(this.view.surface,e.input);const t=[new eo.T,new to.e,new io.P,new Ja.X(this.view.navigation),new so],i=new Xa.e({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Ka.B],Xa.o.INTERNAL);const r={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new ja(e,["primary"]),this._modeDragRotate=new Fn(e,["secondary"],In.CENTER),this._modeDragZoom=new sa(e,["tertiary"],r.fov),this._modeKeyboardNavigation=new Ca(e,r),i.installHandlers("navigation",[new $a(e),new Ws(e),new ba(e),new Ta(e,r.fov),new Fn(e,["primary"],In.EYE,[r.lookAround.modifier]),new Fn(e,["secondary"],In.CENTER,[r.lookAround.modifier]),new ja(e,["tertiary"],[r.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new Qa(e)],Xa.o.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([(0,g.watch)((()=>this.view.navigation?.browserTouchPanEnabled),(e=>{this._source.browserTouchPanningEnabled=!e}),g.initial),(0,g.watch)((()=>{const{actionMap:e}=this.view.navigation,{dragPrimary:t,dragSecondary:i,dragTertiary:r}=e;return{mode:this.mode,dragPrimary:t,dragSecondary:i,dragTertiary:r}}),this._updateMode,g.syncAndInitial)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};(0,r._)([(0,w.MZ)()],no.prototype,"view",void 0),(0,r._)([(0,w.MZ)({type:["default","pro"]})],no.prototype,"mode",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],no.prototype,"updating",null),(0,r._)([(0,w.MZ)()],no.prototype,"latestPointerType",null),(0,r._)([(0,w.MZ)()],no.prototype,"latestPointerLocation",null),(0,r._)([(0,w.MZ)()],no.prototype,"multiTouchActive",null),(0,r._)([(0,w.MZ)()],no.prototype,"_inputManager",void 0),no=(0,r._)([(0,C.$)("esri.views.3d.input.SceneInputManager")],no);const ao=no;var oo=i(15899),lo=i(15492),ho=i(4794);let co,uo,po=!1,mo=!1,_o=!1,go=!1,fo=null;function yo(e){_o=ho.b.DECONFLICTOR_SHOW_VISIBLE,go=ho.b.DECONFLICTOR_SHOW_INVISIBLE,po=_o||go,mo=ho.b.DECONFLICTOR_SHOW_GRID,fo=null,po||mo?fo=()=>function(e){null==co&&(co=document.createElement("canvas"),co.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(co));const{state:t}=e,{camera:i,pixelRatio:r}=t,{width:s,height:n}=i,a=s*r,o=n*r;co.setAttribute("width",`${a}px`),co.setAttribute("height",`${o}px`),co.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${n}px`),uo=co.getContext("2d"),uo.clearRect(0,0,s,n),uo.font="12px Arial"}(e):co&&(co.parentElement.removeChild(co),co=null)}function vo(){fo&&(fo(),fo=null)}function bo(e,t,i,r,s){vo();const n=co.height,a=uo;a.beginPath(),a.lineWidth=1,a.strokeStyle=s,a.moveTo(e,n-i),a.lineTo(t,n-i),a.stroke(),a.lineTo(t,n-r),a.stroke(),a.lineTo(t,n-i),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.closePath()}function wo(e,t){po&&(t&&_o||!t&&go)&&bo(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var xo=i(8245),Co=i(92453),To=i(44375),Mo=i(99254),So=i(46314);const Ro=(0,E.vt)(),Ao=(0,E.vt)(),Eo=(0,js.vt)(),Oo=(0,js.vt)(),Po=(0,E.vt)(),Do=(0,Ue.vt)(),Io=(0,Kt.c)(),Lo=(0,Xt.vt)(),No=(0,E.vt)(),Ho=(0,V.vt)();class Fo{constructor(){this.aabr=(0,V.vt)(),this.distance=0,this.distanceToTerrain=0,this.culled=!1,this.visible=!1}}class Vo{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var Uo;!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(Uo||(Uo={}));class zo{constructor(){this.camera=new or.default,this.slicePlane=(0,U.d)(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),(0,U.a)(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Go=class extends M.default{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new zo,this._state=Uo.Idle,this._active=new Map,this._visible=new Map,this._iterators=new Bo,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0,this._updatingHandles=new lo.U}destroy(){this._updatingHandles.destroy(),this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==Uo.Idle||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const e=this._state/Uo.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case Uo.Idle:this._startUpdate(),e.madeProgress();case Uo.Process:if(this._state=Uo.Process,!this._processActiveGraphics(e))return;case Uo.Sort:if(this._state=Uo.Sort,!this._sortVisibleGraphics(e))return;case Uo.Deconflict:if(this._state=Uo.Deconflict,!this._deconflictVisibleGraphics(e))return;default:(function(e,t){if(!mo||!uo)return;vo();const i=uo;let r=0;for(let s=0;s<e.accBinsNumX;s++)for(let t=0;t<e.accBinsNumY;t++){const n=e.accBins[s][e.accBinsNumY-1-t];r+=n.length;const a=s*e.accBinsSizeX,o=(s+1)*e.accBinsSizeX,l=t*e.accBinsSizeY,h=(t+1)*e.accBinsSizeY;i.fillText(n.length.toFixed(),a+5,l+15),bo(a,o,l,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)})(this,this._visible),this._state=Uo.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){if(null==e||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?.geometries.length??0))return!1;const i=t?.geometries[0],r=i?.material;return r instanceof Mo.R}_startUpdate(){yo(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._viewState.camera;this._initBins(e,t),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new Fo,this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._visible.delete(e.graphics3DGraphic.graphic.uid),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,xo.Z.DECONFLICTION,!0)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_createTerrainIntersector(){const e=(0,lr.hz)(this.view.state.viewingMode);e.options.store=Co.oH.MIN;const t=this.view.basemapTerrain,i=this.view.state.camera;return(0,Ve.mg)(Do,this._viewState.camera.viewInverseTransposeMatrix),r=>{(0,Me.t)(Ao,r,Do),e.reset(i.eye,Ao,i),t.intersect(e,null,i.eye,Ao);const s=e.results.ground.dist;return null!=s?s*(0,Me.j)(Ao,i.eye):0}}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=this._viewState.camera.inverseProjectionMatrix,r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._viewState.camera.relativeElevation>0,s=(0,d.A)("enable-feature:non-occluded-hud")&&this.view.map.ground.opacity>0?this._createTerrainIntersector():null,n=r?Io:null;let a=0;for(null!=n&&((0,Me.t)((0,Kt.a)(n),E.uY,this._viewState.camera.viewMatrix),n[3]=(0,Pe.tO)(this.view.spatialReference).radius,a=(0,Kt.h)(n,E.uY));!e.done;){e.madeProgress();const r=t.next();if(!0===r.done)return this._resetActiveGraphicsIterator(),!0;const o=r.value,l=o?.info[this.visibilityGroup];l&&(this._collectGraphics3DGraphics(o,i,n,a,s),l.culled?(this._setGraphicVisibility(o,!1),this._visible.delete(o.graphics3DGraphic.graphic.uid)):this._visible.set(o.graphics3DGraphic.graphic.uid,o))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),!0===i.done)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===xo.u.LABEL;for(;!e.done;){e.madeProgress();const r=t.next();if(!0===r.done)return this._resetVisibleGraphicsIterator(),!0;const s=r.value,n=s.info[this.visibilityGroup];if(!n||n.culled){this._setGraphicVisibility(s,!1);continue}const a=s.graphics3DGraphic,o=!i||a.isVisible();n.visible=o&&!this._isConflicted(s),n.visible&&this._addToBins(s),this._setGraphicVisibility(s,n.visible),wo(n,n.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=qo(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=qo(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,r)=>{const s=t.pushNew();s.id=r,s.visible=e.graphics3DGraphic.getVisibilityFlag(i,xo.Z.DECONFLICTION);const n=e.info?.[i];s.prio=e.graphics3DGraphic.deconflictionPriority,s.distance=n?n.distance:Number.MAX_VALUE,s.behindTerrain=!!n&&0!==n.distanceToTerrain&&n.distance>n.distanceToTerrain})),yield;const r=t.iterableSort(((e,t)=>e.behindTerrain!==t.behindTerrain?+e.behindTerrain-+t.behindTerrain:e.prio!==t.prio?t.prio-e.prio:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?+t.visible-+e.visible:e.id-t.id));for(let s=r.next();!s.done;s=r.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(e,t,i,r,s){const n=e.graphics3DGraphic;if(n.destroyed)return;const a=e.info[this.visibilityGroup];if(!n.isVisible(xo.u.GRAPHIC,xo.Z.DECONFLICTION))return void(a.culled=!0);const o=this.getGraphicsLayers(n);(0,V.Ie)(a.aabr);let l=null;for(const h of o){if(!this.layerSupportsDeconfliction(h))continue;const n=h.stageObject.geometries[0].material;if(null==l){if(l=jo,this._getProjectionInfo(h,t,l),l.isOutsideScreen||this._isCulledBySlice(e,Ro)||null!=i&&Zo(l,i,r))return void(a.culled=!0);l.distanceToTerrain=s?.(l.positionView)??0}this._expandBoundingRect(a,h,n,l)}null==l?a.culled=!0:(a.distance=l.distance,a.distanceToTerrain=l.distanceToTerrain,a.culled=!1)}_getProjectionInfo(e,t,i){const r=this._viewState.camera,s=e.stageObject,n=s.geometries[0],a=n.material,o=(0,Kt.a)(s.boundingVolumeWorldSpace.bounds);(0,Me.t)(Ro,o,r.viewMatrix);const l=n.attributes,h=l.get(ut.r.NORMAL).data,c=l.get(ut.r.CENTEROFFSETANDDISTANCE).data;a.applyShaderOffsetsView(Ro,h,s.transformation,c,r,i.scaleInfo,Ro),(0,Zs.s)(Eo,Ro[0],Ro[1],Ro[2],1),(0,Zs.t)(Oo,Eo,r.projectionMatrix),(0,Me.h)(i.positionNDC,Oo,1/Oo[3]),a.applyShaderOffsetsNDC(i.positionNDC,c,r,i.positionNDC,Po),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(Po[2]),i.distance=Po[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),(0,Zs.s)(Oo,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),(0,Zs.t)(Eo,Oo,t),(0,Zs.b)(Eo,Eo,1/Eo[3]),(0,Me.i)(i.positionView,Ro[0],Ro[1],Ro[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&(0,U.e)(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,r){let{positionNDC:s,scaleInfo:n}=r;const{fullWidth:a,fullHeight:o,pixelRatio:l}=this._viewState.camera,h=t.getScreenSize(Wo);(0,To.MD)(h,n.factor,h),h[0]*=l,h[1]*=l;const c=(0,V.cY)(i.calculateRelativeScreenBounds(h,n.factorAlignment.scale*l,Ho),(0,de.Cc)(0,a,.5+.5*s[0]),(0,de.Cc)(0,o,.5+.5*s[1])),d=this.marginFactor;if(0!==d){const e=d*Math.min((0,V.VL)(c),(0,V.uJ)(c));c[0]-=e,c[1]-=e,c[2]+=e,c[3]+=e}(0,V.fT)(e.aabr,c,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];let r=!0;for(let s=Math.floor(i.aabr[0]/this._accBinsSizeX);s<=Math.floor(i.aabr[2]/this._accBinsSizeX);s++)if(!(s<0||s>=this._accBinsNumX))for(let e=Math.floor(i.aabr[1]/this._accBinsSizeY);e<=Math.floor(i.aabr[3]/this._accBinsSizeY);e++){if(e<0||e>=this._accBinsNumY)continue;r=!1;const n=this._accBins[s][e];for(let e=0;e<n.length;e++){const r=n.data[e],s=r.info[this.visibilityGroup];if(s&&s.visible&&r.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,(0,V.HY)(s.aabr,i.aabr)))return!0}}return r}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new oo.A)}}else for(let i=0;i<this._accBinsNumX;i++)for(let e=0;e<this._accBinsNumY;e++)this._accBins[i][e].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this._accBinsSizeX),r=Math.floor(t.aabr[2]/this._accBinsSizeX),s=Math.floor(t.aabr[1]/this._accBinsSizeY),n=Math.floor(t.aabr[3]/this._accBinsSizeY);for(let a=i;a<=r;a++)if(!(a<0||a>=this._accBinsNumX))for(let t=s;t<=n;t++)t<0||t>=this._accBinsNumY||this._accBins[a][t].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(this.visibilityGroup,xo.Z.DECONFLICTION,t),this.visibilityGroup===xo.u.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*qo(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}(0,r._)([(0,w.MZ)({constructOnly:!0})],Go.prototype,"view",void 0),(0,r._)([(0,w.MZ)({type:Boolean,readOnly:!0})],Go.prototype,"updating",null),(0,r._)([(0,w.MZ)({readOnly:!0})],Go.prototype,"_updatingHandles",void 0),Go=(0,r._)([(0,C.$)("esri.views.3d.layers.graphics.Deconflictor")],Go);class ko{constructor(){this.id=0,this.visible=!1,this.behindTerrain=!1,this.prio=0,this.distance=0}}class Bo{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.active=e,this.visible=t,this.sort=i,this.sortArray=new oo.A({allocator:e=>e||new ko})}}const Wo=(0,Ge.vt)();function Zo(e,t,i){return(0,Me.c)(Lo.direction,e.positionView),(0,Me.i)(Lo.origin,0,0,0),!!(0,Kt.j)(t,Lo,No)&&e.distanceWithoutPolygonOffset>i}const jo=new class{constructor(){this.positionView=(0,E.vt)(),this.positionNDC=(0,E.vt)(),this.distance=0,this.distanceToTerrain=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new So.D}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}};let $o=class extends Go{constructor(e){super(e),this.visibilityGroup=xo.u.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}initialize(){this._updatingHandles.add((()=>0===(this.view?.map?.ground?.opacity??0)),(()=>this.setDirty()))}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return rt.G;const t=performance.now();if(e.state!==bn.M.IDLE&&t-this._lastDeconfliction<2e3)return rt.G;super.runTask(e),this.state===Uo.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};(0,r._)([(0,w.MZ)({constructOnly:!0})],$o.prototype,"parent",void 0),$o=(0,r._)([(0,C.$)("esri.views.3d.layers.graphics.LabelDeconflictor")],$o);let Qo=class extends Go{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=xo.u.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add((()=>this.view?.state?.camera),(()=>{this._updateViewState(),this.setDirty()})),this._updatingHandles.add((()=>1===this.view?.map?.ground?.opacity),(()=>this.setDirty())),this._updatingHandles.add((()=>this.view?.slicePlane),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),g.initial),this._frameTask=this.view.resourceController.scheduler.registerTask(it.W6.GRAPHICS_DECONFLICTOR,this),this._labels=new $o({view:this.view,parent:this})}destroy(){this._labels=(0,p.pR)(this._labels),this._frameTask=(0,p.xt)(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;null!=e&&(0,U.t)(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new Vo(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),Yo(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s);const n=!this._graphicSupportsDeconfliction(i)||!Yo(e);i.setVisibilityFlag(xo.u.GRAPHIC,xo.Z.DECONFLICTION,n)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=Yo(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.setVisibilityFlag(xo.u.GRAPHIC,xo.Z.DECONFLICTION,!0)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function Yo(e){const t=e.layer;return!(!t?.featureReduction||"selection"!==t.featureReduction.type)}Qo=(0,r._)([(0,C.$)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Qo);var Xo=i(76164),Ko=i(31923),Jo=i(70586),el=i(12096),tl=i(67093),il=i(68693);class rl{constructor(e,t){this._renderCoordsHelper=e,this.opaqueGround=t,this._cache=new Map,this._cameraForward=(0,E.vt)(),this._cameraEye=(0,E.vt)(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=(0,E.vt)(),this._frustumBoundingSphereRadius=0,this._frustum=new un.P(e),this._renderSR=e.spatialReference;const i=(0,Se.lO)(this._renderSR);this._renderSREllipsoidRadius=(0,Pe.tO)(i).radius}setup(e){this._aboveGround=e.aboveGround,this._frustum.update(e),(0,Me.n)(this._cameraForward,e.viewForward),(0,Me.c)(this._cameraEye,e.eye),this._cameraFovY=e.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(e){if(this._cache.has(e.id))return this._cache.get(e.id);const t=this._isVisibleInFrustum(e);return this._cache.set(e.id,t),t}_isVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===X.RT.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,i=Cl;(0,Me.n)(i,e.direction);const r=e.points,s=Tl;(0,Me.a)(s,r[4],t);const n=.5*(0,Me.f)(s,s)/(0,Me.f)(i,s),a=this._frustumBoundingSphereCenter;(0,Me.b)(a,t,i,n);const o=1+n;this._frustumBoundingSphereRadius=o}_isTileVisibleInFrustumLocal(e){const t=e.spatialReference,i=e.extent,r=this._renderSR;if(ml[0]=i[0],ml[1]=i[1],ml[2]=0,ml[3]=i[2],ml[4]=i[3],ml[5]=0,!(0,tl.projectBuffer)(ml,t,0,ml,r,0))return!1;(0,Me.i)(_l[0],ml[0],ml[1],0),(0,Me.i)(_l[1],ml[3],ml[1],0),(0,Me.i)(_l[2],ml[3],ml[4],0),(0,Me.i)(_l[3],ml[0],ml[4],0),(0,Me.i)(gl,.5*(ml[0]+ml[3]),.5*(ml[1]+ml[4]),.5*(ml[2]+ml[5]));const s=eh,n=.5*(0,Me.G)(_l[0],_l[2]),a=this._frustum,o=this._frustumBoundingSphereRadius,l=this._frustumBoundingSphereCenter,h=Sl;(0,Me.a)(h,l,gl);const c=(0,Me.f)(s,h),d=Ml;if((0,Me.b)(d,gl,s,c),(0,Me.G)(d,l)>n+o)return!1;const u=this._cameraForward,p=(0,Me.f)(u,eh),m=this._cameraFovY,_=this._cameraEye;if(Math.abs(p)<Math.abs(Math.cos(.5*m))){let e=!0;const t=(0,Me.i)(th,u[0],u[1],0),i=(0,Me.f)(_,t);for(let r=0;r<4;++r){const s=_l[r];if((0,Me.f)(s,t)-i>0){e=!1;break}}if(e)return!1}{const e=_l[0],t=_l[2];if(e[0]<=_[0]&&_[0]<=t[0]&&e[1]<=_[1]&&_[1]<=t[1])return!0}const g=pl,f=this.opaqueGround&&this._aboveGround,y=this.opaqueGround&&!this._aboveGround,v=Math.min(y?Yl:1/0,c+o),b=Math.max(f?-430:-1/0,c-o);for(let w=0;w<4;++w)(0,Me.b)(g[w],_l[w],s,v),(0,Me.b)(g[w+4],_l[w],s,b);if(hl(a.planes,g,8))return!1;if(cl(a.planes,g,8))return!0;for(let w=0;w<4;++w){const e=g[w],t=g[w+4];if(ih(a.planes,e,t))return!0;const i=g[(w+1)%4];if(ih(a.planes,e,i))return!0;const r=g[4+(w+1)%4];if(ih(a.planes,t,r))return!0}if(nh[0][3]=+_l[0][0],nh[1][3]=-_l[2][0],nh[2][3]=+_l[0][1],nh[3][3]=-_l[2][1],nh[4][3]=+b,nh[5][3]=-v,cl(nh,a.points))return!0;if(cl(nh,a.points))return!0;for(let w=0;w<4;++w){const e=_,t=a.points[w+4];if(rh(nh,e,t))return!0;const i=a.points[4+(w+1)%4];if(rh(nh,t,i))return!0}return!1}_isTileVisibleInFrustumGlobal(e){if(e.level<dl)return!0;const t=e.spatialReference,i=e.extent,r=this.opaqueGround&&this._aboveGround,s=this.opaqueGround&&!this._aboveGround,n=_l,a=.5*(i[0]+i[2]);if((0,Me.i)(n[0],i[0],i[1],0),(0,Me.i)(n[1],i[2],i[1],0),(0,Me.i)(n[2],i[2],i[3],0),(0,Me.i)(n[3],i[0],i[3],0),(0,Me.i)(n[4],a,i[1],0),(0,Me.i)(n[5],a,i[3],0),!function(e,t,i,r,s,n){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const o=(0,il.jd)(t,s);if(null==o)return!1;if(o===il.pO){if(e===r&&i===n)return!0;const t=i+a;for(let s=i,a=n;s<t;++s,++a)(0,Me.c)(r[a],e[s]);return!0}const l=i+a;for(let h=i,c=n;h<l;++h,++c)o(e[h],0,r[c],0);return!0}(n,t,0,n,this._renderSR,0,6))return!1;const o=n[0][2]>0,l=n[3][2]<0,h=o||l,c=this._renderSREllipsoidRadius;if(h){const e=yl;sl(e,ah,n[0]);const t=vl;if(sl(t,ah,n[1]),o){const i=fl,r=n[4],s=bl;sl(s,r,ah),sl(i,s,r);const a=n[0];(0,Me.e)(a,e,i),al(a,c);const o=n[1];(0,Me.e)(o,t,i),al(o,c)}else if(l){const i=fl,r=n[5],s=bl;sl(s,r,ah),sl(i,r,s);const a=n[3];(0,Me.e)(a,i,e),al(a,c);const o=n[2];(0,Me.e)(o,i,t),al(o,c)}}const d=gl,u=(0,Me.a)(Pl,n[3],n[0]);(0,Me.n)(u,u);const p=(0,Me.g)(Dl,n[0],n[3]);(0,Me.h)(p,p,.5);const m=-(0,Me.f)(p,u),_=(0,Me.g)(Il,n[0],n[1]);(0,Me.h)(_,_,.5);const g=(0,Me.g)(Ll,n[2],n[3]);(0,Me.h)(g,g,.5);const f=(0,Me.a)(Nl,g,_);(0,Me.n)(f,f);const y=-(m+(0,Me.f)(u,_))/(0,Me.f)(u,f);(0,Me.b)(d,_,f,y),al(d,c);const v=this._frustumBoundingSphereRadius,b=this._frustumBoundingSphereCenter,w=this._frustum,x=w.planes,C=wl;(0,Me.n)(C,d);const T=(0,Me.f)(n[0],C)/(0,Me.H)(n[0]),M=w.origin,S=w.points;let R=!1;if(r){{R=!0;const e=(0,Me.n)(Xl,M);for(let t=0;t<4;++t){const i=S[4+t],r=(0,Me.a)((0,E.vt)(),i,M);(0,Me.n)(r,r);const s=(0,Me.e)((0,E.vt)(),e,r);(0,Me.n)(s,s);const n=(0,Me.e)((0,E.vt)(),r,s);if((0,Me.n)(n,n),(0,Me.f)(M,n)>c){R=!1;break}}}if(R&&(0,Me.f)(M,C)<c*T-Yl)return!1;const e=(0,Me.n)(Xl,w.origin);if((0,Me.f)(e,C)<0)return!1;{const e=(0,Me.n)(Kl,w.direction);if((0,Me.f)(e,C)>Jl)return!1}}const A=Math.sqrt(1-T*T);if(A>.9)return!0;let O=!1;const P=(0,Me.f)(C,b),D=(0,Me.H)(b);if(D<=v&&!x.some((e=>(0,Cr.mN)(e,Rl)>0))){if(!r)return!0;O=!0}const I=P/D;if(!O&&P<=0&&-P>v)return!1;const L=v/D;if(Math.sqrt(1-I*I)*Math.sqrt(1-L*L)-L*I>A)return!1;if(!R){if(n.some((e=>w.intersectsPoint(e))))return!0;if(w.intersectsPoint(d))return!0}const N=Al;(0,Me.a)(N,b,Rl);const H=(0,Me.f)(N,C),F=xl;(0,Me.h)(F,C,H);const V=(0,Me.G)(F,b),U=t.isWGS84,z=e.lij,G=U&&z[2]===2**z[0]-1,q=U&&0===z[2],k=q?Wl:G?kl:Gl,B=q?Zl:G?Bl:ql;if(!O){const e=n,t=jl,i=Hl,r=Fl,s=Rl;for(const n of k){const a=e[n];if(nl(i,e[(n+1)%4],a),nl(r,s,a),sl(t,r,i),ul(t,S,1))return!1}}let W=null;if(!r&&H<1.01*v){const e=2.5*v;if(V>T*e+v)return!1;const t=Ol,i=e/T;for(let r=0;r<4;++r)(0,Me.h)(t[r],n[r],i/c);(0,Me.i)(t[4],0,0,0),W=t}else{const e=(s?c+Yl:H+v)/T,t=r?c-Yl:(H-v)/T,i=El;for(let r=0;r<4;++r){const s=n[r];(0,Me.h)(i[r],s,t/c),(0,Me.h)(i[r+4],s,e/c)}W=i}if(hl(x,W,W.length))return!1;const Z=w.lines,j=Vl,$=Ul;for(const E of Z){(0,Me.n)($,E.direction);for(const e of B){const t=W[e];if((0,Me.n)(j,t),Ql($,j,W,S))return!1;const i=(e+1)%4;if(r){const e=W[i];if((0,Me.a)(j,e,t),(0,Me.n)(j,j),Ql($,j,W,S))return!1}if(s){const t=W[4+e],r=W[4+i];if((0,Me.a)(j,r,t),(0,Me.n)(j,j),Ql($,j,W,S))return!1}}}return!0}}function sl(e,t,i){return(0,Me.e)(e,t,i),(0,Me.n)(e,e),e}function nl(e,t,i){return(0,Me.a)(e,t,i),(0,Me.n)(e,e),e}function al(e,t){return(0,Me.h)(e,e,t/(0,Me.H)(e)),e}const ol=[el.FB.LEFT,el.FB.RIGHT,el.FB.BOTTOM,el.FB.TOP,el.FB.FAR];function ll(e,t,i){for(let r=0;r<i;++r)if((0,Cr.mN)(e,t[r])<=0)return!1;return!0}function hl(e,t,i){for(const r of ol)if(ll(e[r],t,i))return!0;return!1}function cl(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.length;for(let r=0;r<i;++r){const i=t[r];let s=!0;for(const t of e)if((0,Cr.mN)(t,i)>0){s=!1;break}if(s)return!0}return!1}const dl=2;function ul(e,t,i){for(const r of t)if((0,Me.f)(r,e)<i)return!1;return!0}const pl=[(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)()],ml=[0,0,0,0,0,0],_l=[(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)()],gl=(0,E.vt)(),fl=(0,E.vt)(),yl=(0,E.vt)(),vl=(0,E.vt)(),bl=(0,E.vt)(),wl=(0,E.vt)(),xl=(0,E.vt)(),Cl=(0,E.vt)(),Tl=(0,E.vt)(),Ml=(0,E.vt)(),Sl=(0,E.vt)(),Rl=(0,E.CN)(0,0,0),Al=(0,E.vt)(),El=[(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)()],Ol=[(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)()],Pl=(0,E.vt)(),Dl=(0,E.vt)(),Il=(0,E.vt)(),Ll=(0,E.vt)(),Nl=(0,E.vt)(),Hl=(0,E.vt)(),Fl=(0,E.vt)(),Vl=(0,E.vt)(),Ul=(0,E.vt)(),zl=(0,E.vt)(),Gl=[0,1,2,3],ql=[0,1,2,3],kl=[0,1,3],Bl=[0,1,3],Wl=[1,2,3],Zl=[1,2,3],jl=(0,E.vt)();const $l=[0,0];function Ql(e,t,i,r){if(0===i.length||0===r.length)return!0;const s=zl;sl(s,e,t);const n=r[0]<i[0],a=n?i:r,o=$l;return function(e,t,i){let r=1/0,s=-1/0;for(const n of i){const e=(0,Me.f)(t,n);r=Math.min(r,e),s=Math.max(s,e)}e[0]=r,e[1]=s}(o,s,n?r:i),function(e,t,i,r){let s=1/0,n=-1/0;for(const a of r){const r=(0,Me.f)(i,a);if(s=Math.min(s,r),n=Math.max(n,r),s<=t&&n>=e)return!1}return!0}(o[0],o[1],s,a)}const Yl=430,Xl=(0,E.vt)(),Kl=(0,E.vt)(),Jl=Math.cos(.25*Math.PI),eh=(0,E.fA)(0,0,1),th=(0,E.vt)();function ih(e,t,i){const r={t0:0,t1:1};for(const s of ol)if(!sh(e[s],t,i,r))return!1;return r.t0<r.t1}function rh(e,t,i){const r={t0:0,t1:1};for(const s of e)if(!sh(s,t,i,r))return!1;return r.t0<r.t1}function sh(e,t,i,r){let{t0:s,t1:n}=r;const a=(0,Cr.mN)(e,t),o=(0,Cr.mN)(e,i);if(a>=0&&o>=0)return!1;if(a<0&&o>=0){const e=-a/(o-a);if(e<s)return!1;e<n&&(n=e)}else if(a>=0&&o<0){const e=a/(a-o);if(e>n)return!1;e>s&&(s=e)}return r.t0=s,r.t1=n,!0}const nh=[(0,Cr.fA)(-1,0,0,1),(0,Cr.fA)(1,0,0,-1),(0,Cr.fA)(0,-1,0,1),(0,Cr.fA)(0,1,0,-1),(0,Cr.fA)(0,0,-1,1),(0,Cr.fA)(0,0,1,-1)],ah=(0,E.CN)(0,0,1);class oh{constructor(e,t,i){this._renderCoordsHelper=e,this._tilingScheme=t,this._camera=new or.default,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new rl(e,i)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){const{measures:t,extent:i,level:r}=e;t.visible=this._visibility.compute(e),t.distance=(0,V.Io)(i,this._focusOnMap),t.mergeable=!0,t.lodLevel=dl,t.splitPriority=Math.max(0,dl-r),t.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e))}_updateSplitAndLodGlobal(e){const t=e.level,i=this._renderCoordsHelper,{eye:r,fov:s}=this._camera,n=i.referenceEllipsoid.radius,a=(0,Me.H)(r)-n;if(2*Math.atan(n/a)<s&&a>0)return void(e.measures.lodLevel=Math.max(t,dl));const o=lh,{extent:l}=e,{_surfaceElevation:h}=this;(0,Me.i)(o[0],l[0],l[1],h),(0,Me.i)(o[1],l[2],l[1],h),(0,Me.i)(o[2],l[2],l[3],h),(0,Me.i)(o[3],l[0],l[3],h);const c=(0,Me.i)(hh,.5*(l[0]+l[2]),.5*(l[1]+l[3]),h),d=this._tilingScheme.spatialReference;for(let _=0;_<4;++_)i.toRenderCoords(o[_],d,o[_]);i.toRenderCoords(c,d,c);const u=(0,Me.n)(ph.direction,c),p=(0,Me.f)(r,u),m=(0,Me.h)(dh,u,p);this._updateSplitAndLod(e,o,c,m)}_updateSplitAndLodLocal(e){const t=lh,{extent:i}=e,{_surfaceElevation:r}=this;(0,Me.i)(t[0],i[0],i[1],r),(0,Me.i)(t[1],i[2],i[1],r),(0,Me.i)(t[2],i[2],i[3],r),(0,Me.i)(t[3],i[0],i[3],r);const s=this._tilingScheme.spatialReference;for(let c=0;c<4;++c)this._renderCoordsHelper.toRenderCoords(t[c],s,t[c]);const n=(0,Me.i)(hh,.5*(t[0][0]+t[2][0]),.5*(t[0][1]+t[2][1]),.25*(t[0][2]+t[1][2]+t[2][2]+t[3][2])),a=(0,Me.i)(ch,n[0],n[1],0),{eye:o,far:l}=this._camera,h=(0,Me.i)(dh,a[0],a[1],o[2]);(0,Me.i)(ph.origin,a[0],a[1],o[2]-2*l),(0,Me.c)(ph.direction,uh),this._updateSplitAndLod(e,t,n,h)}_updateSplitAndLod(e,t,i,r){const s=Math.max((0,Me.G)(t[0],t[2]),(0,Me.G)(t[1],t[3]),(0,Me.G)(t[0],i)+(0,Me.G)(i,t[2]),(0,Me.G)(t[1],i)+(0,Me.G)(i,t[3])),{eye:n,near:a,fov:o,viewForward:l,width:h,height:c,pixelRatio:d,frustum:u}=this._camera,p=(0,Me.f)(n,l),m=(0,Me.f)(i,l)-p,_=(0,Me.G)(i,n);let g=m,f=m,y=_,v=_;const b=(e,t)=>t<a?1:Math.sqrt(e*e-t*t)/t;let w=b(_,m);for(const D of t){const e=(0,Me.f)(D,l)-p;g=Math.min(g,e),f=Math.max(f,e);const t=(0,Me.G)(D,n);v=Math.max(v,t),y=Math.min(y,t);const i=b(t,e);w=Math.min(w,i)}if(f<a)return void(e.measures.lodLevel=0);const x=Math.cos(.5*o),C=(0,Me.G)(n,r);w>x&&C>_h*s&&(f=gh*v,g=gh*y);const T=.5*Math.sqrt(h*h+c*c)/d,M=2*Math.tan(.5*o),S=e=>Math.max(a,e)*mh/T*M,R=e.level,A=s*2**R*Math.max(1,M),E=S(g),O=Math.ceil(Math.log2(Math.max(1,A/E)));if(e.measures.lodLevel=Math.max(O,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-R,R<O){const i=+(0,el.bU)(u,t[0])+ +(0,el.bU)(u,t[1])+ +(0,el.bU)(u,t[2])+ +(0,el.bU)(u,t[3]);e.measures.splitPriority+=i}const P=S(f)/E;P>2.5&&(e.measures.splitPriority+=P)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===X.RT.Global}}const lh=[(0,E.vt)(),(0,E.vt)(),(0,E.vt)(),(0,E.vt)()],hh=(0,E.vt)(),ch=(0,E.vt)(),dh=(0,E.vt)(),uh=(0,E.CN)(0,0,1),ph=(0,Xt.fA)(E.uY,uh),mh=312,_h=.5,gh=2;var fh=i(4623);let yh=class extends M.default{constructor(e){super(e),this.tiles=new a.default,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=(0,Oe.v)(!1),this._pendingTiles=(0,Oe.v)(null),this._newTiles=new oo.A,this._tests=!1,this._measurements=new oh(e.renderCoordsHelper,e.tilingSchemeOwner.tilingScheme,this._opaqueGround)}initialize(){const e=()=>this._setDirty();this.addHandles([(0,g.watch)((()=>this.tileSize),(()=>this._reset()),g.syncAndInitial),(0,g.watch)((()=>this.cameraOnSurface?.location),e,g.syncAndInitial),(0,g.watch)((()=>this.viewState?.contentCamera),e,g.syncAndInitial),(0,g.watch)((()=>this.focus?.location),e,g.syncAndInitial),(0,g.watch)((()=>this.terrain?.baseOpacity??1),e),(0,g.watch)((()=>this.tilingScheme),(e=>{this._reset(),this._measurements=new oh(this.renderCoordsHelper,e,this._opaqueGround)}),g.sync),(0,g.watch)((()=>this._opaqueGround),(e=>this._measurements.opaqueGround=e),g.sync)]),this._frameWorker=this.scheduler?.registerTask(it.W6.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=(0,p.xt)(this._frameWorker)}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void u.A.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=(0,V.vt)();return(0,fh.k)(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}addClient(){const e=(0,Ko.c)();return this._clients.add(e),1===this._clients.size&&this._setDirty(),(0,c.hA)((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this._hasClients&&!this.suspended&&(this._frameWorker?this._dirty.value=!0:this.runTask(it.Bb))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty.value=!1}get running(){return this.updating}_reset(){this._newTiles.clear(),this._pendingTiles.value=null,this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map((t=>new Jo.m(t[0],t[1],t[2],e)))}runTask(e){e=this._tests?it.Bb:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),null!=this._frameWorker&&(this._frameWorker.priority=it.W6.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=it.W6.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:i,_newTiles:r}=this;t.setup(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter((e=>{if(t.update(e),e.measures.visible&&(!i||(0,V.HY)(e.extent,i))){if(e.measures.splitPriority>0)return!0;r.push(e)}return!1})).sort(vh),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:i,_filterExtentRect:r,_newTiles:s,_measurements:n}=this;for(;t.length>0&&this._tileBudgetExceeded<1;){const a=t.pop();if(e.madeProgress(),a.measures.splitPriority>0){i.ensureMaxLod(a.level+1);const e=a.createChildren();for(const i of e)n.update(i),!i.measures.visible||r&&!(0,V.HY)(i.extent,r)||(i.measures.splitPriority>0?t.push(i):s.push(i));t.sort(vh),this._tileBudgetExceeded>=1&&(this._mergeNewTiles(),this._tileBudgetExceeded>=1&&this._mergeNewTiles(!0))}else s.push(a);if(e.done)return}s.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),s.clear(),n.done()}get _tileBudgetExceeded(){return Math.max(0,(this._newTiles.length+(this._pendingTiles.value?.length??0))/60-1)}_mergeNewTiles(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const{_newTiles:t,_measurements:i}=this,r=new Map(t.map((e=>[e.id,e])));let s=!1;return r.forEach((n=>{const{lij:a,measures:o}=n;if(!o.mergeable||a[1]%2!=0||a[2]%2!=0||a[0]<=1||n.lodLevelDelta>=4)return;const l=o.lodLevel;let h=l,c=!0;const d=r.get((0,Jo.e)(a[0],a[1]+1,a[2]));let u=Math.abs((d?.measures.lodLevel??0)-l),p=0===u||e&&d?.measures.mergeable&&u<=1;if(!d||!p)return;h+=d.measures.lodLevel,c&&=0===u;const m=r.get((0,Jo.e)(a[0],a[1],a[2]+1));if(u=Math.abs((m?.measures.lodLevel??0)-l),p=0===u||e&&m?.measures.mergeable&&u<=1,!m||!p)return;h+=m.measures.lodLevel,c&&=0===u;const _=r.get((0,Jo.e)(a[0],a[1]+1,a[2]+1));if(u=Math.abs((_?.measures.lodLevel??0)-l),p=0===u||e&&_?.measures.mergeable&&u<=1,!_||!p)return;h+=_.measures.lodLevel,c&&=0===u,t.removeUnordered(n),t.removeUnordered(d),t.removeUnordered(m),t.removeUnordered(_);const g=new Jo.m(a[0]-1,a[1]/2,a[2]/2,this.tilingScheme);i.update(g),g.measures.visible=!0,g.measures.lodLevel=h/4,g.measures.mergeable=c,t.push(g),s=!0})),s}_updateTiles(){for(;this._mergeNewTiles(););for(;this._tileBudgetExceeded&&this._mergeNewTiles(!0););for(const r of this.tiles.items)r.used=!1;let e=!1;const t=this._newTiles.filter((t=>{const i=this._idToTile.get(t.id);return i?(e||=i.measures.lodLevel!==t.measures.lodLevel,i.measures={...t.measures},i.used=!0):this._idToTile.set(t.id,t),!i})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles(),!e||i.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};function vh(e,t){return e.lodLevelDelta-t.lodLevelDelta||e.measures.splitPriority-t.measures.splitPriority||t.measures.distance-e.measures.distance}(0,r._)([(0,w.MZ)({constructOnly:!0})],yh.prototype,"scheduler",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],yh.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],yh.prototype,"tilingSchemeOwner",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],yh.prototype,"cameraOnSurface",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],yh.prototype,"focus",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],yh.prototype,"viewState",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],yh.prototype,"terrain",void 0),(0,r._)([(0,w.MZ)()],yh.prototype,"tiles",void 0),(0,r._)([(0,w.MZ)()],yh.prototype,"tileSize",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],yh.prototype,"tilingScheme",null),(0,r._)([(0,w.MZ)()],yh.prototype,"filterExtent",null),(0,r._)([(0,w.MZ)({readOnly:!0})],yh.prototype,"_filterExtentRect",null),(0,r._)([(0,w.MZ)({readOnly:!0})],yh.prototype,"_rootTileIds",null),(0,r._)([(0,w.MZ)({value:!1})],yh.prototype,"suspended",null),(0,r._)([(0,w.MZ)({readOnly:!0})],yh.prototype,"updating",null),yh=(0,r._)([(0,C.$)("esri.views.3d.layers.support.FeatureTileTree3D")],yh);var bh=i(60735),wh=i(50330);let xh=class extends M.default{constructor(e){super(e),this._propertiesPool=new vn.M({camera:or.default},this),this._lastSeenCameraProjectionValues=new or.default,this.mode=bn.M.ANIMATING,this._cssCamera=new or.default,this._camera=new or.default,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new me({state:this}),this.events=new Te.A,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new vn.M({camera:or.default},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===X.RT.Global){const e=(0,Pe.tO)(this.spatialReference).radius;this.camera=new or.default({eye:(0,E.fA)(4*e,0,0),center:(0,E.fA)(e,0,0),up:(0,E.fA)(0,0,1)})}else this.camera=new or.default({eye:(0,E.fA)(0,0,100),center:(0,E.fA)(0,0,0),up:(0,E.fA)(0,1,0)})}get animation(){return this.cameraController instanceof ar&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(i/r),e}get camera(){return this._camera}set camera(e){e!==Th&&Th.copyFrom(e),Th.computeUp(this.viewingMode),this.events.emit("before-camera-change",Th);const t=this._camera;if(function(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[fn.zj.TOP]!==t.padding[fn.zj.TOP]||e.padding[fn.zj.RIGHT]!==t.padding[fn.zj.RIGHT]||e.padding[fn.zj.BOTTOM]!==t.padding[fn.zj.BOTTOM]||e.padding[fn.zj.LEFT]!==t.padding[fn.zj.LEFT]}(this._lastSeenCameraProjectionValues,Th)&&(this._lastSeenCameraProjectionValues.copyFrom(Th),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Th)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Th),this._cameraChanged=!t.almostEquals(Th),this._cameraChanged)){const e=(0,bh.rs)((()=>{this._cameraChanged=!1,e.remove()}))}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===bn.M.IDLE}get updating(){return this.mode!==bn.M.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){this._contentCamera=null!=e?e.clone():null}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return this.viewingMode===X.RT.Global}get isLocal(){return this.viewingMode===X.RT.Local}get viewingMode(){return(0,X.yX)(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,wh.cz);for(let t=0;t<e.length;){const i=e[t],r=e.findIndex((e=>e.name===i.name));r>=0&&t>r?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach(((t,i)=>e.set(t.name,i))),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(Mh),this.addHandles((0,g.when)((()=>e.state===sr.Finished||e.state===sr.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),Mh),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=sr.Rejected)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Th.copyFrom(this._get("camera")),e(Th),this.camera=Th,this._processingUpdates=!1,this._processUpdateQueue()}};(0,r._)([(0,w.MZ)({constructOnly:!0})],xh.prototype,"view",void 0),(0,r._)([(0,w.MZ)()],xh.prototype,"mode",void 0),(0,r._)([(0,w.MZ)({readOnly:!0,type:Y.default})],xh.prototype,"animation",null),(0,r._)([(0,w.MZ)({type:or.default})],xh.prototype,"cssCamera",null),(0,r._)([(0,w.MZ)()],xh.prototype,"_cssCamera",void 0),(0,r._)([(0,w.MZ)({type:or.default})],xh.prototype,"camera",null),(0,r._)([(0,w.MZ)()],xh.prototype,"_camera",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"pixelRatio",null),(0,r._)([(0,w.MZ)()],xh.prototype,"rasterPixelRatio",void 0),(0,r._)([(0,w.MZ)()],xh.prototype,"contentPixelRatio",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"alignPixelEnabled",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"updating",null),(0,r._)([(0,w.MZ)({})],xh.prototype,"_contentCamera",void 0),(0,r._)([(0,w.MZ)({type:or.default})],xh.prototype,"contentCamera",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"fixedContentCamera",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"events",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"isGlobal",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"isLocal",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"viewingMode",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"highlights",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"highlightOrderMap",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"navigating",null),(0,r._)([(0,w.MZ)({readOnly:!0})],xh.prototype,"stationary",null),(0,r._)([(0,w.MZ)()],xh.prototype,"_cameraChanged",void 0),(0,r._)([(0,w.MZ)()],xh.prototype,"cameraController",null),xh=(0,r._)([(0,C.$)("esri.views.3d.state.ViewState")],xh);const Ch=xh;const Th=new or.default,Mh="ViewStateHandles";var Sh=i(41317),Rh=i(2739),Ah=i(27464);class Eh{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new oo.A,this._tolerance=lr.TH,this._tmpRay=(0,Xt.vt)(),this._tmpRegion=(0,V.vt)(),this._validateHUDIntersector=(0,lr.hz)(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),Lh(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,Lh(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=Co.oH.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.5;return e.getRenderCenter(Uh,i,r),Uh[0]+=.0466,Uh[1]-=.0123,(0,Tr.dk)(e,Uh,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||(0,Ah.i3)(r)&&r.intersector!==Co.dz.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:lr.TH;this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===Co.dz.TERRAIN?1:t.type===Co.dz.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===Co.dz.TERRAIN?1:t.type===Co.dz.TERRAIN?-1:0))}_getPickRay(e,t){const i=this._view.state.camera;return(0,Tr.Z4)(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==X.RT.Local||null==e||(0,Me.g)(t,e.origin,(0,Me.n)(fr.rq.get(),e.direction)),!1}intersectElevationFromScreen(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,r)}_intersectElevation(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null==e)return null;const s=this._view,{renderCoordsHelper:n}=s,a=(0,v.G9)(s.spatialReference),o=null!=t?t.mode:"absolute-height",l=(0,Sh.M7)(t)/a,h=("on-the-ground"!==o?l+i:0)*a/n.unitInMeters,{camera:c}=s.state;if("absolute-height"===o){const t=n?.getAltitude(c.eye),i=(0,Me.f)((0,Me.n)(Fh,e.direction),n.worldUpAtPosition(c.eye,Vh));if(t<h&&i<0||t>=h&&i>0)return null;if(n.intersectInfiniteManifold(e,h,Fh)){const e=(0,Rh.zC)(s,Fh);return e.z??=0,e.z-=l,e}return null}const d=(0,y.sc)(fr.rq.get());c.projectToRenderScreen(e.origin,d);const u=new Nh(null,this._forEachLayer),{slicePlane:p}=s,m=null!=p?(0,Ah.Q5)(p):null,_=(0,lr.hz)(this.viewingMode);_.options.store=Co.oH.MIN,_.options.verticalOffset=h,_.options.normalRequired=!1;const g=e.origin,f=(0,Me.g)(fr.rq.get(),g,e.direction);_.reset(g,f,c),_.point=d;const b=r?"type"in r&&"graphics"===r.type?e=>e.layerUid!==r.uid:e=>e.graphicUid!==r.uid:null;switch(o){case"relative-to-scene":{const e=e=>(!b||b(e))&&!!e.lastValidElevationBB;_.intersect(u.layers,d,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===Co.dz.I3S||e.type===Co.dz.TERRAIN||e.type===Co.dz.TILES3D){const t=e.slicePlaneEnabled?m:null;e.intersect(_,t,_.rayBegin,_.rayEnd,d)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?m:null;e.intersect(_,t,_.rayBegin,_.rayEnd,d)}}))}if(_.results.min.getIntersectionPoint(Fh)){const e=(0,Rh.zC)(s,Fh);return e.z=i,e}return null}computeIntersection(e,t,i,r){if(null==e)return;const s=this._view.state.camera,n=(0,y.sc)(fr.rq.get());s.projectToRenderScreen(e.origin,n);const a=new Nh(i,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const o=e.origin,l=(0,Me.g)(fr.rq.get(),e.origin,e.direction);t.reset(o,l,s),t.intersect(a.layers,n,this._tolerance);const h=this._view.slicePlane,c=null!=h?(0,Ah.Q5)(h):null;t.intersect(a.sliceableLayers,n,this._tolerance,c);const d=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const i=e.layerUid,s=Array.isArray(i),h=s?i:[i];s&&(t.options.filteredLayerUids=[]);let u=!1;for(const r of h)a.filterLayerUid(r)?u=!0:s&&t.options.filteredLayerUids.push(r);if(t.options.isFiltered=!u,e.isGround&&d||!t.options.isFiltered){const i=e.slicePlaneEnabled?c:null;e.intersect(t,i,o,l,n,r)}}));const u=fr.rq.get(),p=this._view.basemapTerrain;if(i&&i.enableDraped&&null!=p.spatialReference&&t.results.ground.getIntersectionPoint(u)){const e=p.overlayManager.renderer,i=this._view.renderCoordsHelper.spatialReference,r=fr.rq.get();this._view.renderCoordsHelper.fromRenderCoords(u,r,p.spatialReference),r[2]=this._view.elevationProvider?.getElevation(u[0],u[1],u[2],i,"ground")??0,e.intersect(t,r,t.results.ground,(e=>a.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;(0,V.C)(this._tmpRegion,V.qv);const i=this._view.state.camera,r=[],s=this._tmpRegion,n=e=>{const t=new Dh(e),n=t.result.target.object.geometries.every((e=>e.material instanceof Mo.R&&e.material.parameters.occlusionTest));r.push({item:t,occlusionTest:n}),n&&(i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),(0,V.tK)(s,t.screenPoint))};e.sortResults(t.all),null!=t.min.dist&&n(t.min);for(const g of t.all)t.min.target.object!==g.target.object&&t.max.target.object!==g.target.object&&n(g);if(null!=t.max.dist&&t.max.target.object!==t.min.target.object&&n(t.max),!r.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);const a=i.fullWidth,o=i.fullHeight,l=Math.max(0,s[0]-Oh),h=Math.max(0,s[1]-Oh),c=Math.min((0,V.VL)(s)+2*Oh,a-l),d=Math.min((0,V.uJ)(s)+2*Oh,o-h),u=c>0&&d>0?new Uint8Array(c*d*4):null;u&&this._view._stage.renderer.readHUDVisibility(l,h,c,d,u);let p=!0;const m=null==e.results.max.dist;let _=0;for(const{item:g,occlusionTest:f}of r){let t=!f;if(f&&u)for(const e of Ph){const i=4*(Math.min(g.screenPoint[0]+e[0],a)-s[0]+(Math.min(g.screenPoint[1]+e[1],o)-s[1])*c);if(i>=0&&i<u.length&&u[i]){t=!0;break}}t&&(p&&(e.results.min.copy(g.result),p=!1),m&&e.results.max.copy(g.result),e.options.store===Co.oH.ALL&&e.results.all.splice(_++,0,g.result))}}}const Oh=1,Ph=(()=>{const e=[],t=Oh;for(let i=-1;i<=t;i++)for(let r=-1;r<=t;r++)e.push([r+t,i+t]);return e})();class Dh{constructor(e){this.result=e,this.screenPoint=(0,y.r_)()}}let Ih;function Lh(e){return Ih&&Ih.viewingMode===e||(Ih=(0,lr.hz)(e)),Ih}class Nh{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t((e=>{e.pickable&&this.filterLayerUid(e.apiLayerUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerUid(e){const{include:t,exclude:i}=this;return null==e?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}}function Hh(e){return"object"==typeof e&&"intersect"in e}const Fh=(0,E.vt)(),Vh=(0,E.vt)(),Uh=(0,y.r_)();var zh=i(30262),Gh=i(95528);let qh=class extends(Te.A.EventedMixin(M.default)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=(0,p.pR)(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,r,s){if(this._cacheEnabled&&null!=this.lastElevationQuery){const n=this.lastElevationQuery;if(e===n.x&&t===n.y&&i===n.z&&(0,Re.aI)(r,n.spatialReference)&&s===n.queryContext)return n.result}let n=null;return n=kh(n,this._im,e,t,i,r,s),null==n&&(n=kh(n,this._ground,e,t,i,r,s)),"scene"===s&&(n=kh(n,this._scene,e,t,i,r,s)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:n}),n}getSphereElevationBounds(e,t,i){const r=new Gh.H;function s(s){for(const n of s)if(n.getSphereElevationBounds){const s=n.getSphereElevationBounds(e,t,i);null!=s&&r.expandElevationRangeValues(s.elevationRangeMin,s.elevationRangeMax)}}return s(this._ground),s(this._im),"scene"===i&&s(this._scene),r}getRootElevationBounds(){const e=new Gh.H;for(const t of[this._im,this._ground,this._scene])t.forEach((t=>{if(t.getRootElevationBounds){const i=t.getRootElevationBounds();null!=i&&e.expandElevationRangeValues(i.elevationRangeMin,i.elevationRangeMax)}}));return e}async queryElevation(e,t,i,r,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const o=this._getElevationQuery(r);try{const l=await o.queryElevation(e,t,n,a);return"scene"===s?kh(l,this._scene,e,t,i,r,s):l}catch(l){return(0,_.throwIfAbortError)(l),this.getElevation(e,t,i,r,s)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.view.spatialReference;const t=this._cachedQuery;if(null!=t&&(0,Re.aI)(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:i,wkt:r,wkt2:s,latestWkid:n}=e,a=new zh.I(this.view.resourceController.scheduler,new N.default({wkid:i,wkt:r,wkt2:s,latestWkid:n}),(()=>this.view.map?.ground),{maximumAutoTileRequests:4});return this._cachedQuery=a,a}};function kh(e,t,i,r,s,n,a){for(const o of t){const t=o.getElevation(i,r,s,n,a);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}(0,r._)([(0,w.MZ)({constructOnly:!0})],qh.prototype,"view",void 0),(0,r._)([(0,w.MZ)()],qh.prototype,"spatialReference",null),qh=(0,r._)([(0,C.$)("esri.views.3d.support.CombinedElevationProvider")],qh);class Bh{static isValidProfile(e){return e in Bh.profiles}static getDefaultProfile(){return(0,d.A)("esri-iPhone")?"low":"medium"}static apply(e,t){const i=Bh.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods,t.graphics3D.uncompressedTextureDownsamplingEnabled=i.graphics3D.uncompressedTextureDownsamplingEnabled;const r=t.sceneService.object,s=i.sceneService.object;r.lodFactor=s.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}}Bh.test={reset(){const e=Zh();for(const t of Object.keys(e))Bh.profiles[t]=e[t]}};const Wh={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function Zh(){const e=!!(0,d.A)("esri-mobile"),t=!!(0,d.A)("ios"),i=(0,ht.l5)(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:(0,ht.l5)(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+Wh.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:e},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!(0,d.A)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:e?600+Wh.GalaxyS20:750+Wh.FullHD,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!(0,d.A)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:e?900+Wh.SurfacePro7:1500+Wh.FullHDRetina,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}!function(e){e.profiles=Zh()}(Bh);var jh,$h=i(96504);!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(jh||(jh={}));const Qh=[jh.ELEVATION,jh.MAP];var Yh=i(54404);async function Xh(e,t){const{results:i,ground:r}=await(0,Yh.oZ)(e,t),s=(!r.layer||!(0,q.Eq)(r.layer.type))&&r.mapPoint,n=[],a=function(e){const t=new Map;for(const i of e.allLayerViews){const e=i.layer.uid;t.set(e,i)}return t}(e),o=s?function(e,t){const i=new Set,r=[];for(let n=e.basemapTerrain.numLayers(jh.MAP)-1;n>=0;n--){const t=e.basemapTerrain.layerViewByIndex(n,jh.MAP);i.add(t.layer.uid),r.push(t)}const s=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:n}of s){const e=t.get(n);e&&(i.add(n),r.push(e))}return r.reverse(),{layerUids:i,layerViews:r}}(e,a):Kh;let l=0,h=0;const c=()=>{const e=o.layerViews[h];s&&e&&"fetchPopupFeaturesAtLocation"in e&&n.push({mapPoint:r.mapPoint,layerView:e}),++h};let d=null;for(;l<i.length||h<o.layerViews.length;){const t=i[l];if(t&&"graphic"!==t.type)++l;else if("scene"!==t?.layer?.type||t?.layer?.parent!==e?.map?.basemap)if(t){const e=t.layer?.uid,i=o.layerUids.has(e)&&t.distance===r.distance,s=a.get(t.layer?.uid);if(d??=t.mapPoint,h<o.layerViews.length&&(i||(t.distance??0)>r.distance)&&o.layerViews[h]!==s){c();continue}n.push({graphic:t.graphic,layerView:s}),++l}else c();else++l}return d??=r.mapPoint,{hits:n,location:d}}const Kh={layerUids:new Set,layerViews:[]};let Jh=class extends M.default{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};(0,r._)([(0,w.MZ)()],Jh.prototype,"minTotalNumberOfFeatures",void 0),(0,r._)([(0,w.MZ)()],Jh.prototype,"maxTotalNumberOfFeatures",void 0),(0,r._)([(0,w.MZ)()],Jh.prototype,"maxNumberOfDrawCalls",void 0),(0,r._)([(0,w.MZ)()],Jh.prototype,"maxTotalNumberOfVertices",void 0),(0,r._)([(0,w.MZ)()],Jh.prototype,"snapshotAvailable",void 0),(0,r._)([(0,w.MZ)()],Jh.prototype,"polygonLodFactor",void 0),(0,r._)([(0,w.MZ)()],Jh.prototype,"polylineLodFactor",void 0),(0,r._)([(0,w.MZ)()],Jh.prototype,"skipHighSymbolLods",void 0),(0,r._)([(0,w.MZ)()],Jh.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Jh=(0,r._)([(0,C.$)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Jh);let ec=class extends M.default{constructor(){super(...arguments),this.lodFactor=1}};(0,r._)([(0,w.MZ)()],ec.prototype,"lodFactor",void 0),ec=(0,r._)([(0,C.$)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],ec);let tc=class extends M.default{constructor(){super(...arguments),this.object=new ec,this.point=new ec,this.integratedMesh=new ec,this.pointCloud=new ec,this.uncompressedTextureDownsamplingEnabled=!1}};(0,r._)([(0,w.MZ)({type:ec})],tc.prototype,"object",void 0),(0,r._)([(0,w.MZ)({type:ec})],tc.prototype,"point",void 0),(0,r._)([(0,w.MZ)({type:ec})],tc.prototype,"integratedMesh",void 0),(0,r._)([(0,w.MZ)({type:ec})],tc.prototype,"pointCloud",void 0),(0,r._)([(0,w.MZ)()],tc.prototype,"uncompressedTextureDownsamplingEnabled",void 0),tc=(0,r._)([(0,C.$)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],tc);let ic=class extends M.default{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};(0,r._)([(0,w.MZ)()],ic.prototype,"lodBias",void 0),(0,r._)([(0,w.MZ)()],ic.prototype,"angledSplitBias",void 0),(0,r._)([(0,w.MZ)()],ic.prototype,"vtlContentZoom",void 0),(0,r._)([(0,w.MZ)()],ic.prototype,"elevationLevelDelta",void 0),(0,r._)([(0,w.MZ)()],ic.prototype,"reduceTileLevelDifferences",void 0),ic=(0,r._)([(0,C.$)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],ic);let rc=class extends M.default{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};(0,r._)([(0,w.MZ)()],rc.prototype,"pixelRatio",void 0),(0,r._)([(0,w.MZ)()],rc.prototype,"maxTotalNumberOfFeatures",void 0),rc=(0,r._)([(0,C.$)("esri.views.3d.support.QualitySettings.HeatmapSettings")],rc);let sc=class extends M.default{constructor(){super(...arguments),this.graphics3D=new Jh,this.sceneService=new tc,this.tiledSurface=new ic,this.heatmap=new rc,this.fadeDuration=(0,ht.l5)(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};(0,r._)([(0,w.MZ)({type:Jh})],sc.prototype,"graphics3D",void 0),(0,r._)([(0,w.MZ)({type:tc})],sc.prototype,"sceneService",void 0),(0,r._)([(0,w.MZ)({type:ic})],sc.prototype,"tiledSurface",void 0),(0,r._)([(0,w.MZ)({type:rc})],sc.prototype,"heatmap",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"fadeDuration",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"antialiasingEnabled",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"physicallyBasedRenderingEnabled",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"highQualityTransparency",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"highResolutionAtmosphere",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"reflections",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"ambientOcclusion",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"memoryLimit",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"additionalCacheMemory",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"frameRate",void 0),(0,r._)([(0,w.MZ)()],sc.prototype,"maximumPixelRatio",void 0),sc=(0,r._)([(0,C.$)("esri.views.3d.support.QualitySettings")],sc);const nc=sc;var ac=i(63034),oc=i(52086),lc=i(87523),hc=i(23060),cc=i(62631),dc=i(89893);class uc{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class pc{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new mc}}class mc{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class _c{constructor(e,t,i,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map((e=>new pc(e)))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,(0,dc.vA)(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}}class gc{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque="image/jpeg"===t}}var fc=i(98697);let yc=class extends M.default{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new _c(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),i&&(this._frameTask=i.registerTask(it.W6.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=(0,p.xt)(this._frameTask),this._tasks.forEach((e=>(0,p.DC)(e.abortController))),this._loadQueue=(0,p.pR)(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const s=(0,_.createResolver)();s.__signal=null!=r?r.signal:null;const n=this._createOrUpdateTask(e,t,i,r,s);return(0,_.onAbort)(r,(()=>this._cancelRequest(n,s))),s.promise}_createTask(e,t,i,r,s,n){const a=new bc(e,t,i,r,s);return this._updateTask(a,n),this._tasks.set(s,a),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,t){(0,cc.Xy)(e.resolvers,t),t.reject((0,_.createAbortError)()),0===e.resolvers.length&&(e.status===wc.DOWNLOADING&&(e.status=wc.CANCELLED,this._loadQueue.cancel(e),e.abortController?.abort(),e.request=null,e.abortController=null),e.status=wc.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,s){const n=function(e,t,i){return`${e}:${t}:${i}`}(r?.uid||e,t,i),a=this._tasks.get(n);return a?(this._updateTask(a,s),a):this._createTask(e,r,t,i,n,s)}_doneLoadingCB(e,t){this._loadQueue&&((0,dc.vA)(e.status===wc.DOWNLOADING),e.status=wc.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();(0,_.throwIfAborted)(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==wc.DOWNLOADED&&(t.err=t.err||(0,_.createAbortError)()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!(0,_.isAbortError)(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=(0,fc.EM)(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)(0,_.isAbortError)(t)?r.reject(t):r.reject(new l.default("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const t=i>0?(0,Vt.clone)(e.result):e.result;r.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===wc.CANCELLED)return!1;let i,r;switch(e.startTime=performance.now(),e.status=wc.DOWNLOADING,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const s=e.abortController.signal;e.request=(0,hc.default)(e.url,{...e.options,responseType:r,timeout:i,signal:s});const n=i=>{e.duration=performance.now()-e.startTime,e.size=i instanceof ArrayBuffer?i.byteLength:e.size||0,e.result=i,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=i=>{e.status===wc.DOWNLOADING&&t(e,i)};return"image+type"!==e.docType?(e.request.then((e=>n(e.data)),a),!0):(e.request.then((t=>{const o=t.data,l=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(o);if(r="image",e.size=o.byteLength,"unknown"===l)return e.request=(0,hc.default)(e.url,{responseType:r,timeout:i,signal:s}),void e.request.then((e=>n(e.data)),a);const h=new Blob([o],{type:l}),c=window.URL.createObjectURL(h);e.request=(0,hc.default)(c,{responseType:r,timeout:i,signal:s}),e.request.then((e=>n(new gc(e.data,l))),a).finally((()=>window.URL.revokeObjectURL(c)))}),a),!0)}get test(){}};(0,r._)([(0,w.MZ)({readOnly:!0})],yc.prototype,"updating",void 0),yc=(0,r._)([(0,C.$)("esri.views.3d.support.StreamDataLoader")],yc);const vc=0;class bc extends uc{constructor(e,t,i,r,s){super(r),this.url=e,this.options=t,this.docType=i,this.key=s,this.result=null,this.status=wc.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=vc}}var wc;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(wc||(wc={}));let xc=class extends M.default{constructor(){super(...arguments),this.updating=!1}};(0,r._)([(0,w.MZ)({readOnly:!0})],xc.prototype,"updating",void 0),xc=(0,r._)([(0,C.$)("esri.views.3d.support.ResourceController.ResourceControllerMain")],xc);let Cc=class extends xc{constructor(){super(...arguments),this._immediateTask=it.nu,this._normalTask=it.nu,this._updatingObjects=(0,Oe.v)([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=(0,it.mj)(),this._memoryController=(0,lc.w)(this.view),this._streamDataLoader=new yc,this._streamDataLoader.setup(oc.u1,oc.U0,this._scheduler),this.addHandles([(0,g.watch)((()=>this.view.state?.mode),(e=>{null!=e&&(this._scheduler.state=e)}),g.sync),(0,g.watch)((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=(0,f.addFrameTask)({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(it.W6.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(it.W6.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=(0,p.xt)(this._frameTask),this._streamDataLoader=(0,p.pR)(this._streamDataLoader),this._memoryController=(0,p.pR)(this._memoryController),this._scheduler=(0,p.pR)(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some((e=>e.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,s)=>t.request(i,r,e,s),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],(0,c.hA)((()=>{t.value=t.value.filter((t=>t!==e))}))}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,ht.y)(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};(0,r._)([(0,w.MZ)()],Cc.prototype,"view",void 0),(0,r._)([(0,w.MZ)()],Cc.prototype,"_scheduler",void 0),(0,r._)([(0,w.MZ)()],Cc.prototype,"_memoryController",void 0),(0,r._)([(0,w.MZ)()],Cc.prototype,"_streamDataLoader",void 0),(0,r._)([(0,w.MZ)()],Cc.prototype,"_immediateTask",void 0),(0,r._)([(0,w.MZ)()],Cc.prototype,"_normalTask",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],Cc.prototype,"updating",null),Cc=(0,r._)([(0,C.$)("esri.views.3d.support.ResourceController")],Cc);var Tc=i(78073),Mc=i(88796),Sc=i(91315);class Rc{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,r){const s=r?`gltfPBR:${e}`:`gltf:${e}`,n=this._gltfMemCache.get(s);return null!=n?Promise.resolve(n):Ac(this._gltfLoading,this._gltfMemCache,s,(async t=>{const{loadGLTF:s}=await Promise.all([i.e(32709),i.e(53255)]).then(i.bind(i,32709));return s(new Mc.R(t.streamDataRequester),e,t,r)}),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(i);return null!=r?Promise.resolve(r):Ac(this._wosrLoading,this._wosrMemCache,i,(t=>(0,Sc.Hh)(e,t)),t)}}async function Ac(e,t,i,r,s){(0,_.throwIfAborted)(s);const n=(0,_.onAbort)(s,(()=>function(e,t){const i=e.get(t);if(null!=i&&--i.refCount>0)return;e.delete(t),null!=i&&i.abortController.abort()}(e,i)));let a=e.get(i);if(a)a.refCount++;else{const t=new AbortController;a={refCount:1,abortController:t,promise:r({...s,signal:t.signal})},e.set(i,a)}try{const r=await a.promise;return t.put(i,r),e.delete(i),(0,_.throwIfAborted)(s),r}finally{(0,p.xt)(n)}}var Ec=i(43103);let Oc=class extends M.default{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(it.W6.TEXTURE_UNLOAD)??it.nu}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach((e=>this._releaseTextureRequest(e))),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);if(!r){const e=new Dc;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.add(e.texture)),this._textureRequests.set(i,e),r=e}return r.referenceCount++,new Pc(i,r.texture,(()=>this._release(i)))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!=t?`${e}.${t}px`:e}};(0,r._)([(0,w.MZ)()],Oc.prototype,"_frameTask",void 0),(0,r._)([(0,w.MZ)()],Oc.prototype,"updating",null),Oc=(0,r._)([(0,C.$)("esri.views.3d.support.TextureCollection")],Oc);class Pc{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}}class Dc{constructor(){this.referenceCount=0}}var Ic=i(51446);class Lc extends Oc{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){(0,_.throwIfAborted)(i);const r=i?.signal,s=this.makeUid(e,t);let n=this._textureRequests.get(s);if(!n){const i=new AbortController,r=this._streamDataRequester.request(e,"image",{uid:s,signal:i.signal});n=new Dc,n.abortController=i;const a=n;this._textureRequests.set(s,n),n.textureAsync=r.then((async i=>{const r=this._createTexture(e,i,t);return a.texture=r,a.abortController=null,await r.load(this._stage.renderView.renderingContext),this._stage.add(r),new Pc(s,r,(()=>this._release(s)))}),(e=>{throw a.abortController=null,e}))}n.referenceCount++;try{return await(0,_.whenOrAbort)(n.textureAsync,r)}catch(a){throw this._release(s),a}}_createTexture(e,t,i){const r={width:t.width,height:t.height,wrap:{s:Ze.pF.CLAMP_TO_EDGE,t:Ze.pF.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if((0,Ec.isSVG)(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new Ic.g(t,r)}}class Nc{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(oc.sK.SYMBOLOGY),this.objectResourceCache=new Rc(((t,i)=>e.resourceController.memoryController.newCache(t,i))),this.textures=new Lc(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=(0,Pe.tO)(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,To.mt)(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=(0,To.M4)(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return(0,c.hA)();this._graphicsOwners.push(e);const t=(0,g.watch)((()=>e.layer?.screenSizePerspectiveEnabled),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),(0,c.hA)((()=>{t.remove(),(0,cc.Xy)(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>!0===e.layer?.screenSizePerspectiveEnabled));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new na.default;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([(0,g.watch)((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,g.sync),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=(0,p.pR)(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;Hc.distance=e.centerOnSurfaceInfrequent.distance,Hc.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(Hc),this.screenSizePerspectiveSettingsLabels.update(Hc),this._view._stage.renderView.requestRender()}get test(){}}const Hc={distance:0,fovY:0};var Fc=i(79625),Vc=(i(54824),i(35727)),Uc=(i(62666),i(67349),i(85102)),zc=i(66607);class Gc{constructor(e){this.destination=e}hide(){null!=this.graphic&&(this.destination.remove(this.graphic),this.graphic=null)}}class qc extends Gc{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";super(e),this._symbol=new Uc.default({symbolLayers:new a.default([new Vc.default({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new zc.default({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(!t)return;this.hide();const i=new I.default({x:e[0],y:e[1],z:e[2],spatialReference:t});this.graphic=new Fc.default({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}}let kc=class extends M.default{constructor(e){super(e)}};(0,r._)([(0,w.MZ)({constructOnly:!0})],kc.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],kc.prototype,"surface",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],kc.prototype,"state",void 0),kc=(0,r._)([(0,C.$)("esri.views.3d.support.pointsOfInterest.PointOfInterest")],kc);const Bc=Array;let Wc=class extends kc{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new vn.M({location:I.default,renderLocation:Bc},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=(0,E.vt)(),this._tmpPoint=new I.default}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles((0,g.on)((()=>this.map?.ground?.layers),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=(0,p.pR)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=(0,Me.j)(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return(0,mn.Fj)(i,t)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),rt.G;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>jc&&this.renderCoordsHelper.viewingMode===X.RT.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?$c:0}).then((e=>this._updateSurfaceAltitude(e.geometry.z??0))).catch((e=>{(0,_.isAbortError)(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null})),this._pendingElevationQueryController=i,rt.G}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(Zc,this._estimatedSurfaceAltitude,this._camera.eye),(0,Me.p)(this._get("renderLocation"),Zc)||(this._set("renderLocation",(0,Me.c)(this._propertiesPool.get("renderLocation"),Zc)),this.notifyChange("renderLocation"))}};(0,r._)([(0,w.MZ)({constructOnly:!0})],Wc.prototype,"scheduler",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Wc.prototype,"cache",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Wc.prototype,"task",void 0),(0,r._)([(0,w.MZ)()],Wc.prototype,"location",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],Wc.prototype,"map",void 0),(0,r._)([(0,w.MZ)()],Wc.prototype,"renderLocation",void 0),(0,r._)([(0,w.MZ)()],Wc.prototype,"scale",null),(0,r._)([(0,w.MZ)()],Wc.prototype,"updating",null),Wc=(0,r._)([(0,C.$)("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],Wc);const Zc=(0,E.vt)(),jc=1e5,$c=1e6,Qc=Array;let Yc=class extends kc{constructor(e){super(e),this._propertiesPool=new vn.M({location:I.default,renderLocation:Qc},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=(0,E.vt)(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=(0,p.xt)(this._frameWorker),this._propertiesPool=(0,p.pR)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,rt.G}_updateRenderLocation(){const e=Kc;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=Jc;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&((0,Me.c)(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=(0,Me.j)(this._camera.eye,e):((0,Me.h)(e,this._camera.viewForward,this._get("distance")),(0,Me.g)(e,e,this._camera.eye)),(0,Me.p)(this._get("renderLocation"),e)||this._set("renderLocation",(0,Me.c)(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=(0,Pe.tO)(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=(0,Me.k)(i.eye),a=n<s*s,o=(0,Me.j)(i.eye,t);if(a&&o>r/4){const e=s-Math.sqrt(n);return(0,Me.h)(t,i.viewForward,e),(0,Me.g)(t,t,i.eye),!0}}else{const e=this.surface?.ready?this.surface.extent:null;null!=e&&(0,H.S)(e,this.surface?.spatialReference,ed,this.renderCoordsHelper.spatialReference)&&(t[0]=(0,de.qE)(t[0],ed[0],ed[2]),t[1]=(0,de.qE)(t[1],ed[1],ed[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(ho.b.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=(0,Me.j)(i,e),s=(0,Me.j)(i,t);if(Math.abs(s-r)/r>Xc)return!0}return!1}};(0,r._)([(0,w.MZ)({constructOnly:!0})],Yc.prototype,"scheduler",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Yc.prototype,"task",void 0),(0,r._)([(0,w.MZ)()],Yc.prototype,"distance",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Yc.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],Yc.prototype,"location",null),(0,r._)([(0,w.MZ)({readOnly:!0})],Yc.prototype,"renderLocation",void 0),(0,r._)([(0,w.MZ)()],Yc.prototype,"updating",void 0),Yc=(0,r._)([(0,C.$)("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],Yc);const Xc=.05,Kc=(0,E.vt)(),Jc=(0,E.vt)(),ed=(0,V.vt)();class td{constructor(e){this._handles=new na.default,this.events=new Te.A,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",(e=>this._layerViewsChanged(e)))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=(0,p.pR)(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this._handles.add(e.on("visible-geometry-changed",(()=>this._contentChanged())),e.uid)})),e.removed.forEach((e=>this._handles.remove(e.uid)))}_contentChanged(){this.events.emit("request-update",id)}}const id={},rd=Array;let sd=class extends kc{constructor(e){super(e),this._propertiesPool=new vn.M({location:I.default,renderLocation:rd},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([(0,g.watch)((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),(0,g.watch)((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.addHandles(this.scheduler.registerTask(it.W6.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=(0,p.pR)(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,nd);const s=Math.max(0,(Math.acos((0,Me.f)(nd,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!(0,Me.I)(e,t)){const e=this._propertiesPool.get("renderLocation");(0,Me.c)(e,t),this._set("renderLocation",e)}return rt.G}const n=1-(0,de.qE)(s/(.5*Math.PI),0,1),a=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(od);const o=this._propertiesPool.get("renderLocation");return(0,Me.m)(o,t,od,a),e&&(0,Me.I)(e,o)||this._set("renderLocation",o),rt.G}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter((0,y.r_)());if(i[1]=t.aboveGround?t.padding[fn.zj.BOTTOM]:t.fullHeight-t.padding[fn.zj.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,ad)){(0,Me.d)(ad,ad,t.eye);const i=(0,Me.n)(ad,ad);if(this.renderCoordsHelper.intersectInfiniteManifold((0,Xt.LV)(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};(0,r._)([(0,w.MZ)()],sd.prototype,"_dirty",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],sd.prototype,"scheduler",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],sd.prototype,"centerOnSurface",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],sd.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,r._)([(0,w.MZ)()],sd.prototype,"updating",null),(0,r._)([(0,w.MZ)()],sd.prototype,"location",null),(0,r._)([(0,w.MZ)()],sd.prototype,"renderLocation",void 0),(0,r._)([(0,w.MZ)()],sd.prototype,"worldUnitsPerContentPixel",null),sd=(0,r._)([(0,C.$)("esri.views.3d.support.pointsOfInterest.Focus")],sd);const nd=(0,E.vt)(),ad=(0,E.vt)(),od=(0,E.vt)();let ld=class extends M.default{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=(0,E.vt)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([(0,g.watch)((()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent]),(()=>this._update())),(0,g.on)((()=>this.surface?.layers),"change",(()=>this._update()))]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==this.surfaceView?.extent||null==this.surfaceView.spatialReference)return void this._set("location",null);const e=(0,V.gX)(this.surfaceView.extent),t=new I.default({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{}))):this._set("location",t)}};(0,r._)([(0,w.MZ)({constructOnly:!0})],ld.prototype,"view",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],ld.prototype,"cache",void 0),(0,r._)([(0,w.MZ)()],ld.prototype,"surface",null),(0,r._)([(0,w.MZ)()],ld.prototype,"surfaceView",null),(0,r._)([(0,w.MZ)({readOnly:!0})],ld.prototype,"location",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],ld.prototype,"renderLocation",null),ld=(0,r._)([(0,C.$)("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],ld);let hd=class extends M.default{constructor(e){super(e),this._tileGeometryUpdateExtent=(0,V.Ie)(),this._tileGeometryUpdateSpatialReference=null,this.events=new Te.A,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(it.W6.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",cd),(0,V.Ie)(this._tileGeometryUpdateExtent),this._set("updating",!1),rt.G):rt.G}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,(0,V.fT)(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,r=pd,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,dd,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,ud,t),dd[0]<ud[0]?(r[0]=dd[0],r[2]=ud[0]):(r[0]=ud[0],r[2]=dd[0]),dd[1]<ud[1]?(r[1]=dd[1],r[3]=ud[1]):(r[1]=ud[1],r[3]=dd[1]),(0,V.HY)(r,e)}};(0,r._)([(0,w.MZ)({constructOnly:!0})],hd.prototype,"state",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],hd.prototype,"centerOnSurfaces",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],hd.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],hd.prototype,"scheduler",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],hd.prototype,"surface",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],hd.prototype,"updating",void 0),hd=(0,r._)([(0,C.$)("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],hd);const cd={},dd=(0,E.vt)(),ud=(0,E.vt)(),pd=(0,V.Ie)();let md=class extends M.default{constructor(e){super(e),this.renderPointOfView=(0,E.vt)(),this._pois=new Array,this._debugCenters=null,this._tmpRay=(0,Xt.vt)(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new vn.M({renderPointOfView:_d},this)}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view;this._surfaceIntersector=(0,lr.hz)(e.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Co.oH.MIN,this._contentIntersector=(0,lr.hz)(e.viewingMode);const s=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,a=this.view.basemapTerrain?.elevationQueryCache,o={state:e,scheduler:n,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new Yc({...o,task:it.W6.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new Yc({...o,task:it.W6.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnContent",new Yc({...o,task:it.W6.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Wc({...o,cache:a,task:it.W6.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new hd({...o,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new td({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new ld({cache:a,view:this.view})),this._set("focus",new sd({state:e,scheduler:n,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([(0,g.watch)((()=>e.contentCamera),(e=>this._cameraChanged(e)),g.sync),(0,g.watch)((()=>t.extent),(()=>this._updateCenterPointsOfInterest())),(0,g.watch)((()=>this.view.map?.ground?.navigationConstraint?.type),(e=>{this._surfaceIntersector.options.backfacesTerrain="none"===e}),g.initial),(0,g.when)((()=>!t.updating),(()=>this._updateCenterPointsOfInterest()),g.sync),(0,g.on)((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),(0,g.on)((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),(0,g.watch)((()=>ho.b.SHOW_POI),(e=>this._setDebug(e)),g.initial)]),this._cameraChanged(this.view.state.contentCamera);for(const l of this._pois)l.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some((e=>e.updating)))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,gd,yd)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(gd):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,i=(0,Me.g)(gd,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(gd)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(gd)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=(0,Tr.dk)(t,e,fd);if(null==r)return null;const s=r.origin,n=(0,Me.g)(gd,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;(0,Me.p)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,Me.c)(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach((e=>e.hide())),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const e=this.view.graphics;this._debugCenters.set(this.centerOnContent,new qc(e,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new qc(e,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new qc(e,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new qc(e,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new qc(e,"green","Focus"))}for(const t of this._pois)this.addHandles((0,g.watch)((()=>t.renderLocation),(e=>this._debugCenters?.get(t)?.show(e,t.renderCoordsHelper.spatialReference)),g.initial),"debug")}get test(){}};(0,r._)([(0,w.MZ)()],md.prototype,"centerOnContent",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"centerOnSurfaceFrequent",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"centerOnSurfaceInfrequent",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"cameraOnSurface",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"focus",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"renderPointOfView",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"surfaceOrigin",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"contentGeometryUpdates",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"surfaceGeometryUpdates",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],md.prototype,"view",void 0),(0,r._)([(0,w.MZ)()],md.prototype,"updating",null),md=(0,r._)([(0,C.$)("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],md);const _d=Array,gd=(0,E.vt)(),fd=(0,Xt.vt)(),yd={exclude:new Set([Ar.fo])};var vd=i(88102),bd=i(5100),wd=i(24812);class xd{constructor(e,t){this._cache=e(t,((e,t,i)=>{switch(t){case wd.k2.ALL:return e.forEach((e=>e.dispose())),0;case wd.k2.SOME:{const t=e.shift();return t?(i-=Math.round(t.cachedMemory),t.dispose()):i>0&&(u.A.getLogger("esri/core/MemCachePool").warn("Encountered empty MemCachePool with non-zero memory."),i=0),i}}}))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();return t.length>0?i&&(t.cachedMemory=this._cache.getSize(e)-Math.round(i.cachedMemory),this._cache.updateSize(e,t)):this._cache.pop(e),i}put(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:wd.Cn;const r=this._cache.peek(e);if(r)r.push(t),r.cachedMemory=this._cache.getSize(e)+Math.round(t.cachedMemory),this._cache.updateSize(e,r);else{const r=new Cd(t);this._cache.put(e,r,i)}}}class Cd extends Array{constructor(e){super(),this.item=e,this.cachedMemory=e.cachedMemory,this.push(e)}}var Td=i(42672),Md=i(18162),Sd=i(18477),Rd=i(28606),Ad=i(31143);class Ed{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}var Od=i(68039),Pd=i(4742);class Dd{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new Od.Q(i,t)}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const s=e-this.level;if(s<=0)return r;const n=2**s;if(Math.floor(t/n)!==this.i||Math.floor(i/n)!==this.j)return r;let a=1/0,o=-1/0;const l=this.samplerData.data.width,h=this.samplerData.data.values,c=.5*Pd.sH;let d=(l-1)/n,u=(i-this.j*n)*d,p=(t-this.i*n)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,s=h[i],n=h[i+1],a=h[i+l],o=h[i+l+1];if(s+n+a+o<c){const i=u-e,l=p-t,h=(0,pe.BI)(s,n,a,o,i,l),c=(0,pe.BI)(s,n,a,o,i+d,l),m=(0,pe.BI)(s,n,a,o,i,l+d),_=(0,pe.BI)(s,n,a,o,i+d,l+d);return r.min=Math.min(h,c,m,_),r.max=Math.max(h,c,m,_),r}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let m=u;m<=u+d;m++)for(let e=p;e<=p+d;e++){const t=h[m+e*l];t<c?(a=Math.min(a,t),o=Math.max(o,t)):r.hasNoDataValues=!0}return r.min=a,r.max=o,r}}const Id=.5*Pd.sH;function Ld(e,t,i){if(null==i)return null;for(const r of i){if(!r)continue;const i=r.safeWidth;let s=(0,de.qE)(r.dy*(r.y1-t),0,i),n=(0,de.qE)(r.dx*(e-r.x0),0,i);const a=Math.floor(s),o=Math.floor(n),l=r.data.width,h=a*l+o,c=r.data.values,d=c[h],u=c[h+1],p=h+l,m=c[p],_=c[p+1];if(d+m+u+_<Id){s-=a,n-=o;const e=d+(u-d)*n;return e+(m+(_-m)*n-e)*s}}return null}var Nd=i(37858);let Hd=class extends M.default{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if("operationalLayerType"in i&&(0,q.If)(i.operationalLayerType)&&null!=this.viewSpatialReference){const t=Ud(i.fullExtent,this.viewSpatialReference);null!=t&&e.push((0,V.VY)(t))}})),e}};(0,r._)([(0,w.MZ)({readOnly:!0})],Hd.prototype,"layerViewsExtent",null),(0,r._)([(0,w.MZ)({readOnly:!0})],Hd.prototype,"tiledLayersExtent",null),(0,r._)([(0,w.MZ)({readOnly:!0})],Hd.prototype,"stencilEnabledExtents",null),(0,r._)([(0,w.MZ)()],Hd.prototype,"viewSpatialReference",void 0),(0,r._)([(0,w.MZ)()],Hd.prototype,"tilingScheme",void 0),(0,r._)([(0,w.MZ)()],Hd.prototype,"defaultTiledLayersExtent",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Hd.prototype,"layers",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Hd.prototype,"layerViews",void 0),Hd=(0,r._)([(0,C.$)("esri.views.3d.terrain.ExtentHelper")],Hd);let Fd=class extends Hd{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?Pd.cf:Pd.yt}};Fd=(0,r._)([(0,C.$)("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],Fd);let Vd=class extends Hd{_computeLayerViewsExtent(){const e=(0,V.Ie)(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=Ud("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);(0,V.fT)(e,r,e)}}));const i=(0,V.vQ)(e)?e:null,r=this._get("layerViewsExtent");return(0,V.aI)(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=(0,V.Ie)();this.layers.forEach((r=>{if(r.loaded&&(0,q.qK)(r)){const s=(0,Nd.Uo)(r,t,X.RT.Local);if(null==s)return;const{tileInfo:n,fullExtent:a}=s,o="tilemapCache"in r?r.tilemapCache?.effectiveMaxLOD:void 0;null!=n&&null!=a&&((0,Nd.Ci)(r)||e.compatibleWith(n,o)&&a.spatialReference.equals(e.spatialReference))&&(0,V.fT)(i,a,i)}})),(0,V.fT)(i,this.defaultTiledLayersExtent,i);const r=(0,V.vQ)(i)?i:null,s=this._get("tiledLayersExtent");return(0,V.aI)(r,s)?s:r}};function Ud(e,t){return null==e||e.spatialReference.equals(t)?e:(0,L.projectWithoutEngine)(e,e.spatialReference,t)}Vd=(0,r._)([(0,C.$)("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],Vd);var zd=i(44106),Gd=i(5616),qd=i(84654),kd=i(43208),Bd=i(59603),Wd=i(85293);function Zd(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const i of t)i.includes(".glsl")&&delete e[i]}}class jd{constructor(e,t){this.screen=e,this.olid=t}}const $d=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let Qd,Yd=class extends M.default{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0,this._maxResolution=(0,d.A)("esri-mobile")?2048:4096}initialize(){const e=this.view;this.renderer=new qd.or({parent:this}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.requestRender();this._groundIntersector=(0,lr.hz)(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([(0,g.watch)((()=>this.renderer.hasHighlights),t),this.renderer.events.on("has-water",(()=>e._stage?.renderer.updateHasFlags())),this.renderer.events.on("content-changed",t),(0,g.watch)((()=>e.state.camera.pixelRatio),t),(0,g.watch)((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.surface.requestRender())),(0,g.watch)((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),(0,g.watch)((()=>[e.state?.pixelRatio,e.state?.contentPixelRatio]),(()=>this.setPlacementDirty()),g.sync),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(it.W6.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(it.Bb,e.camera,bt.C7.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(bt.C7.BACKGROUND,e)}))]),e._stage.renderer.overlay=this}destroy(){this.view?._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.overlay=null),Qd&&(Qd.hide(),Qd=null),this.renderer=(0,p.pR)(this.renderer)}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=e.isWebMercator?new pr.hr(-20037508.342787,20037508.342787):new pr.hr(-180,180))):this.renderer.disposeOverlays()}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||ho.b.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?(0,Pe.tO)(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}render(){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._precompileShaders()?this._drawOverlays(bt.C7.UPDATE):null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,Bd.B)}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,bt.C7.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return rt.G;const r=this._computeOverlayResolution(t);this._computeOverlayExtents(t,r,Jd),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,Jd.stretch);const s=this._updateOverlay(zd.vr.INNER,Jd.inner,r,1*Jd.pixelRatioAdjustment,Jd.mapUnitsPerPixel),n=(0,V.VL)(Jd.inner)/(0,V.VL)(Jd.outer),a=this._updateOverlay(zd.vr.OUTER,Jd.outer,r,n*Jd.pixelRatioAdjustment,Jd.mapUnitsPerPixel);s!==ru.EXTENT&&a!==ru.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.updateOverlayParameters(i)),s===ru.NONE&&a===ru.NONE||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,s=Math.ceil(1.5*Math.max(i,r));return Math.min((0,Wd.Mv)(s),this._maxResolution)}_updateOverlay(e,t,i,r,s){if(0===this.renderer.overlays.length)return ru.NONE;const n=this.renderer.overlays[e],a=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=r,function(e,t){const i=1e-5,r=ho.b.TESTS_DISABLE_OPTIMIZATIONS?0:i*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}(t,n.extent)&&i===n.resolution)return a===s?ru.NONE:ru.RERENDER_ONLY;(0,V.C)(n.extent,t),n.resolution=i;const o=(0,V.gX)(n.extent);return n.renderLocalOrigin=(0,kd.f)(o[0],o[1],0,"OV_"+this._latestOriginId++),ru.EXTENT}updateOverlayParameters(e){this.surface.allTiles.forAll((e=>this.updateTileOverlayParameters(e))),this.surface.requestRender(e)}updateTileOverlayParameters(e){if(!e.renderData)return;const t=e.renderData.overlay;if(0===this.renderer.overlays.length)this._clearTileOverlayData(zd.vr.INNER,t),this._clearTileOverlayData(zd.vr.OUTER,t);else{const[i,r]=this.renderer.overlays,s=e.extent;this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,zd.vr.INNER,t),this._setTileOverlayData(s,zd.vr.OUTER,t)):(this._clearTileOverlayData(zd.vr.INNER,t),this._clearTileOverlayData(zd.vr.OUTER,t))}}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const i=this.renderer.overlays[zd.vr.INNER],r=this.renderer.overlays[zd.vr.OUTER],s=this._pointIsInExtent(e,i.extent)?i:r;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const r=this.renderer.overlays[t].extent,s=(0,V.VL)(r),n=(0,V.uJ)(r);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(r[0],a);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}i.setScale(t,(0,V.VL)(e)/s,(0,V.uJ)(e)/n),i.setOffset(t,(a-r[0])/s,(e[1]-r[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){Zd(),this.requestRender(),this.runTask(it.Bb)}requestRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt.C7.UPDATE;this.renderer.hasOverlays?(e===bt.C7.UPDATE?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view._stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r,s){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,iu,t,i);if(null==n)return!1;const a=n.origin,o=(0,Me.g)(Kd,n.origin,n.direction);this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,o);const l=this._groundIntersector.results.min;return l.getIntersectionPoint(s)&&l.withinDistance(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=(0,de.qE)(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+a,e.aboveGround?s-a:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=Kd;(0,Kt.k)((0,Kt.b)(Kt.t,(0,Pe.tO)(this.view.spatialReference).radius+o),(0,Xt.LV)(e.eye,e.viewForward),t),(0,Me.d)(t,t,e.eye);const s=pr.wf.normalize((0,gr.EJ)(e.viewForward,t,e.viewRight))/e.fovY+.5,n=s<=0||s>=1?.5:r;i=l?n*s:s+n*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),n=(0,js.fA)(0,s,1,0),a=(0,Zs.t)(n,n,e.projectionMatrix)[1],o=(0,de.qE)(.5+.5*a,0,1);i=1===o||0===o?.5:l?o*r:1-(1-o)*r}return this._intersectGroundFromView(e,.5,i,n.distance,t)}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=(0,E.vt)();this._findHorizonBasedPointOfInterest(e,s)||(0,Me.c)(s,r),ho.b.OVERLAY_SHOW_CENTER?(null==Qd&&(Qd=new qc(this.view.graphics,"red")),Qd.show(s,this._renderSR)):null!=Qd&&Qd.hide();const n=Math.max(.1,(0,Me.j)(e.eye,s)),a=(0,Ti.T)(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||(0,Md.F)(s,this._renderSR,s,this._spatialReference);const o=this.surface.extent,l=!this._isSpherical&&this._spatialReference?.isGeographic,h=l&&this._spatialReference?1/(0,Pe.tO)(this._spatialReference).metersPerDegree:1,c=this.view.state.contentPixelRatio,d=e.perScreenPixelRatio/c*n*h;i.mapUnitsPerPixel=d/this.worldToPCSRatio,i.stretch=this._overlayStretch;let u=t*d/2*i.stretch,p=!1,m=l?90:1/0;this._isSpherical&&o&&this._spatialReference&&(this._spatialReference.isWebMercator?(u/=Math.cos((0,Gd.y2lat)(s[1])),m=o[3]):(p=!0,u/=(0,Pe.tO)(this._spatialReference).metersPerDegree,m=90),u>=m&&(u=m,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let _=1;p&&(_=1/Math.max(.2,Math.cos(Math.abs((0,de.kU)(s[1])))),u*_>180&&(_=180/u),i.mapUnitsPerPixel*=_);const g=Math.log(2)/12;u=Math.exp(Math.round(Math.log(u)/g)*g);const f=u*_,y=.5*t/(32*f),v=.5*t/(32*u);s[0]=Math.round(s[0]*y)/y,s[1]=Math.round(s[1]*v)/v;const b=i.inner;b[0]=s[0]-f,b[1]=s[1]-u,b[2]=s[0]+f,b[3]=s[1]+u,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,m);const w=i.outer;if(6*f>(0,V.VL)(o))(0,V.C)(w,o);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)w[0]=b[0]-f,w[1]=b[1]-u,w[2]=b[2]+f,w[3]=b[3]+u;else{(0,Md.F)(e.eye,this._renderSR,Kd,this._spatialReference),(0,ze.Re)(Xd,s,Kd);let t=-Math.atan2(Xd[1],Xd[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));(0,Zs.b)(Xd,$d[i],2*u),Xd[0]*=_,Xd[2]*=_,(0,Zs.g)(w,b,Xd)}if(this._isSpherical)w[0]=this._longitudeCyclical.clamp(w[0]),w[2]=this._longitudeCyclical.clamp(w[2]),w[1]=Math.max(w[1],-m),w[3]=Math.min(w[3],m);else{const e=(0,V.E$)(b,o,eu),t=(0,V.E$)(w,o,tu);(0,V.gR)(e,t)&&(w[2]=w[0],w[3]=w[1])}const x=Math.abs(b[2]-b[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,x),i.pixelRatioAdjustment=i.mapUnitsPerPixel/x}_precompileShaders(){return!!this.renderer.hasOverlays&&(this.renderer.precompileShaders(this.view.state),!0)}_drawOverlays(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.view.state;if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),r!==this.renderer.computeValidity()&&this.updateOverlayParameters(bt.C7.UPDATE),i?(this.surface.requestRender(e),e===bt.C7.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(bt.C7.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,V.HY)(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:(0,V.gR)(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),(0,V.cY)(e,r,s)}get test(){}};(0,r._)([(0,w.MZ)()],Yd.prototype,"_spatialReference",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],Yd.prototype,"running",null),(0,r._)([(0,w.MZ)()],Yd.prototype,"_placementDirty",void 0),(0,r._)([(0,w.MZ)()],Yd.prototype,"_contentUpdated",void 0),(0,r._)([(0,w.MZ)()],Yd.prototype,"_isSpherical",null),(0,r._)([(0,w.MZ)()],Yd.prototype,"worldToPCSRatio",null),(0,r._)([(0,w.MZ)()],Yd.prototype,"renderer",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Yd.prototype,"view",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Yd.prototype,"surface",void 0),(0,r._)([(0,w.MZ)()],Yd.prototype,"suspended",null),(0,r._)([(0,w.MZ)()],Yd.prototype,"updating",null),(0,r._)([(0,w.MZ)({type:Boolean})],Yd.prototype,"rendersOccludedDraped",null),Yd=(0,r._)([(0,C.$)("esri.views.3d.terrain.OverlayManager")],Yd);const Xd=(0,js.vt)(),Kd=(0,E.vt)(),Jd=new class{constructor(){this.inner=(0,V.vt)(),this.outer=(0,V.vt)(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},eu=(0,V.vt)(),tu=(0,V.vt)(),iu=(0,Xt.vt)();var ru;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(ru||(ru={}));var su=i(4309),nu=i(26282),au=i(75093);class ou{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=(0,su.Ie)(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=(0,p.Gz)(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,(0,su.Ie)(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),(0,Me.g)(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:r,typedBufferStride:s}=this.vertexAttributes.normalCompressed;(0,au.Tz)(t,r,this.getEdgeAttributeIndex(e,i),s)}setEdgeNormalFromValues(e,t,i,r,s){this._setNormal(this.getEdgeAttributeIndex(e,t),i,r,s)}setEdgeVertexFromValuesRawPositionUV(e,t,i,r,s,n,a){const o=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(o,i,r,s),this._setUV(o,n,a)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,r,s,n,a,o,l,h){const c=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(c,i,r,s),this._setUV(c,n,a),this._setNormal(c,o,l,h)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,r){const{typedBuffer:s,typedBufferStride:n}=this.vertexAttributes.normalCompressed;(0,au.aT)(s,e,t,i,r,n)}_setUV(e,t,i){hu(this.vertexAttributes.uv0,e,t,i)}getEdgeAttributeIndex(e,t){return(0,Nd.GH)(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}}const lu=16384;function hu(e,t,i,r){e.setValues(t,i*lu,r*lu)}class cu{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}}class du{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=(0,p.pR)(this._current),this._next=(0,p.pR)(this._next),this._waiting=(0,p.pR)(this._waiting),this._delayed=(0,p.pR)(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=du.test.fadeMoment;if(null!=this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,uu.Immediate),this._delayed=null)),null!=this._next){e=e||performance.now();const t=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,r=this._next.type!==zd.ZY.FADING,s=e-this._fadeStart>=t;(i||r||s)&&((0,p.pR)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=du.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return null!=this._next||null!=this._delayed}push(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:uu.Immediate;this._delayed=(0,p.pR)(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=e);const i=du.test.fadeMoment||performance.now();return t!==uu.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):null==this._next?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(null!=e&&((0,p.pR)(this._waiting),this._waiting=e))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}}var uu;du.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(uu||(uu={}));class pu{constructor(e,t,i,r,s,n){this.texture=e,this.type=t,this.offsetAndScale=i,e.retain(),this.opacities=(0,E.fA)(r,s,n)}destroy(){this.texture.release()}}class mu{constructor(){this._scales=(0,js.fA)(-1,-1,-1,-1),this._offsets=(0,js.fA)(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}var _u=i(52877),gu=i(96236),fu=i(92804),yu=i(88607);class vu extends We.w{constructor(e,t){super(e,t,new Be.$(yu.a,(()=>i.e(12319).then(i.bind(i,12319)))),bu),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:i,output:r}=e,s=e.backfaceCullingEnabled&&!i;return(0,je.Ey)({blending:i?je.Os:null,culling:s?je.PI:null,depthTest:i?null:{func:Ze.MT.LESS},depthWrite:i?null:je.Uy,colorWrite:je.kn,stencilTest:t?(0,fu.Rv)(bt.dd.IntegratedMeshMaskExcluded):null,drawBuffers:r===gu.V.Depth?{buffers:[Ze.Hr.NONE]}:null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}const bu=new Map([[ut.r.POSITION,0],[ut.r.UV0,1],[ut.r.NORMALCOMPRESSED,2]]);class wu{constructor(){this.geometry=new ou,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureOpacity=1,this._textureRef=new du((()=>this._tile.surface.fadeDuration)),this.overlay=new mu,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new cu,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),Nd.L8&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)(0,Nd.GH)(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const t=i.surface.extent;if(null!=t&&(0===e&&i.extent[3]>t[3]||1===e&&i.extent[2]>t[2]||2===e&&i.extent[1]<t[1]||3===e&&i.extent[0]<t[0]))return r}const s=i.level,n=Nd.Rz[e];if(!t)return(0,Nd.GH)(null==i.surface?.rootTiles||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(n)),r;if(t.loaded){const i=t,n=i.renderData.geometryState,a=s-i.level;if((0,Nd.GH)(a>=0),0===a){const e=n.numVerticesPerSide-1;return Math.max(e,r)}const o=2**a,l=n.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}(0,Nd.GH)(!t.leaf);let a=r;return t.forAllSubtreeOnSide((0,Nd.JM)(n),(e=>e===i||(e.loaded?(a=Math.max(a,2**(e.level-s)),!0):((0,Nd.GH)(!e.leaf),!1)))),a}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=t=>(t.loaded||t.level===e.level)&&t?.intersectsClippingArea,r=t.edgePeerNeighbors,s=t.edgePeerNeighborSamplerVersions;for(let n=0;n<4;++n){const a=e.findNeighborTile(Nd.Rz[n],i),o=Ou(e,a),l=o?.renderData?.geometryState.samplerDataVersion??-1,h=r[n],c=o!==Ou(e,h),d=s[n]!==l;Nd.L8&&a&&((0,Nd.GH)(e.level>=a.level),(0,Nd.GH)(e.level-a.level<=Pd.nU)),r[n]=a,(c||d)&&(s[n]=l,this._markEdgeDirty(n));const u=t.edgeResolutions[n],p=this._calculateEdgeResolution(n,a);(0,Nd.GH)((0,de.r6)(p)),(0,Nd.GH)(p>=1),t.edgeResolutions[n]=p,u!==p&&this._markEdgeResolutionDirty(n)}for(let n=0;n<4;++n){const s=e.findNeighborTile(Nd.XQ[n],i);t.cornerPeerNeighbors[n]=s;const a=Ou(e,r[n]),o=Ou(e,r[(n+1)%4]),l=Ou(e,s);Eu[n]=l,Eu[(n+1)%4]=o,Eu[(n+2)%4]=e,Eu[(n+3)%4]=a,(0,Nd.GH)(Eu.some((t=>t?.loaded||t===e)));const h=Eu.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);Eu.forEach(((e,t)=>{e&&e?.level>h&&(Eu[t]=null)})),(0,Nd.GH)(Eu.some((t=>t?.loaded||t===e)));const c=t.cornerNeighborCornerTiles,d=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){const t=Eu[e],i=t?.renderData.geometryState.samplerDataVersion??-1,r=4*n+e,s=c[r]!==t,a=!s&&d[r]!==i;(s||a)&&(c[r]=t,d[r]=i,this._markCornerDirty(n))}Nd.L8&&(0,Nd.GH)(Vu.some((t=>c[4*n+t]?.loaded||c[4*n+t]===e)))}Nd.L8&&(0,Nd.GH)(this.geometryState.edgeResolutions.every((e=>e>0)));for(let n=0;n<4;++n)Eu[n]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;Nd.L8&&(0,Nd.GH)(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every((e=>e>0))),this.intersectionData=null;const{tile:t,_vao:i,geometry:r,geometryState:s}=this,n=!i||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,a=0!==this.dirtyEdgeResolutions,o=s.edgeResolutions.reduce(((e,t)=>e+t+1),0),l=n||a&&o>(r?.maxEdgeVertexCount??0),h=!l&&a,c=!h&&(0!==this.dirtyEdges||a),d=!c&&0!==this.dirtyCorners;l?(this.releaseGeometry(),this._createGeometry(e)):h?t.updateEdgeElevationsAndResolutions():c||d?t.updateEdgeElevations():d?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=(0,p.WD)(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i,r){const s=t?Ze.Ab.RGBA:Ze.Ab.RGB;return null!=this._texture&&(i===zd.ZY.FADING&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==s)&&this.releaseTexture(),null==this._texture&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){null!=this._texture&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture)&&(e.setTextureReference(new pu(this._texture,zd.ZY.FADING,t,this._textureOpacity,0,1)),!0)}get numVerticesPerSideChanged(){return!!(this._modifiedFlags&Pu)}get samplerDataChanged(){return!!(this._modifiedFlags&Du)}get clippingAreaChanged(){return!!(this._modifiedFlags&Iu)}get wireframeChanged(){return!!(this._modifiedFlags&Lu)}get dirtyEdges(){return this._modifiedFlags>>Nu&15}get dirtyCorners(){return this._modifiedFlags>>Hu&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>Fu&15}_markCornerDirty(e){const t=1<<e<<Hu;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<Nu;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<Fu;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<Hu|15<<Nu|15<<Fu}updateGeometryState(){const e=this._elevationInfo,t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.minimumVerticesPerSide,r=Math.max(i,5);let s=t.clippingArea;t.intersectsClippingArea&&!t.withinClippingArea||(s=null);const n=this.geometryState;let a=!1;n.numVerticesPerSide!==r&&(this._modifiedFlags|=1,n.numVerticesPerSide=r,n.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,n.samplerData=e.samplerData,n.samplerDataVersion++,a=!0),(0,cc.aI)(n.clippingArea,s)||(this._modifiedFlags=4,n.clippingArea=s,a=!0);const o=t.surface.wireframe;return n.wireframe!==o&&(this._modifiedFlags=8,n.wireframe=o,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,i=this.geometry.indices,r=e.gl;this._vao=new wt.Z(e,bu,new Map([["geometry",(0,ft.U)(t.layout)]]),new Map([["geometry",xt.g.createVertex(e,r.STATIC_DRAW,t.buffer)]]),xt.g.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:uu.Immediate;e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[jh.ELEVATION],i=t.length,r=new Array(i);let s=0,n=0,a=!1;for(let h=0;h<i;h++){const i=t[h],o=i.upsampleInfo?.tile;if(o){const t=o.layerInfo[jh.ELEVATION][h].data,i=t&&t.samplerData;e&&e[s]===i||(a=!0),r[s++]=i,n=Math.max(n,o.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(h,jh.ELEVATION);if((0,_u.Cn)(this.tile,t)){const t=i.data;e&&e[s]===t.samplerData||(a=!0),r[s++]=t.samplerData,n=this.tile.level}}}null!=e&&e.length!==s&&(a=!0);const o=s>0,l=o?r:null;return o&&(r.length=s),{changed:a,samplerData:l,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!Nd.L8)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||0===e.level)return void(0,Nd.GH)(e?.loaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const i=Nd.Rz.map(((i,r)=>null!=t&&(r<2?-1:1)*(e.extent[3-r]-t[3-r])<0)),r=e.level;(0,Nd.GH)(0===this.dirtyCorners),(0,Nd.GH)(0===this.dirtyEdges),(0,Nd.GH)(0===this.dirtyEdgeResolutions),(0,Nd.GH)(!this.numVerticesPerSideChanged),(0,Nd.GH)(!this.samplerDataChanged),(0,Nd.GH)(!this.clippingAreaChanged),(0,Nd.GH)(!this.wireframeChanged);const s=Nd.XQ.map((t=>e.findNeighborCornerTileExact(t,(t=>!t.intersectsClippingArea||t.loaded||t.level===e.level))??null)).map((e=>e?.intersectsClippingArea?e:null)),n=this.geometryState;for(let a=0;a<4;++a){const t=n.cornerPeerNeighbors[a],i=s[a];(0,Nd.GH)(i===t,`Tile[${e.lij}].corner[${a}] out of date: cur=[${t?.lij}] exp=[${i?.lij}]`)}Nd.Rz.forEach(((t,s)=>{if(i[s])return;const n=e.findNeighborTile(t,(e=>(e.level===r||e?.loaded)&&e?.intersectsClippingArea));if(!n){const i=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void(0,Nd.GH)(!i)}(0,Nd.GH)(n.loaded||n.level===e.level),(0,Nd.GH)(n===this.geometryState.edgePeerNeighbors[s]);const a=r-n.level;if(!n.loaded)return(0,Nd.GH)(!n.leaf),void(0,Nd.GH)(0===a);const o=n.renderData;(0,Nd.GH)(e.isEdgeNeighbor(n,t)),(0,Nd.GH)(a>=0);const l=2**a;if(a<0)return void(0,Nd.GH)(!1);const h=e.renderData,c=h.geometry,d=h.localOrigin,u=c.getEdgeCount(s),p=c.numVerticesPerSide-1,m=o.geometry;if(!m)return void(0,Nd.GH)(!1);const _=o.localOrigin,g=this.geometryState.edgePeerNeighbors[s];if(g?.loaded){const e=g.renderData;(0,Nd.GH)(h.geometryState.edgePeerNeighborSamplerVersions[s]===e.geometryState.samplerDataVersion),(0,Nd.GH)(this.geometryState.edgePeerNeighborSamplerVersions[s]===e.geometryState.samplerDataVersion)}const f=(s+2)%4,y=m.getEdgeCount(f),v=u-1,b=y-1;(0,Nd.GH)(v*l===b,`Tile[${e.lij}]:e${s},res=${v} edgeRes mismatch with Neighbor[${n.lij}]:e${f},res=${b} (expected:${v*l})`);const w=e.extent,x=t===nu.N.NORTH||t===nu.N.SOUTH,C=y-1,T=C>>a,M=u-1;if(T<1)return void(0,Nd.GH)(1===M);(0,Nd.GH)(T===M),(0,Nd.GH)((0,de.r6)(T));const S=m.numVerticesPerSide-1;(0,Nd.GH)(a>0||T===Math.max(S,p));const R=e.getNeighborEdgeStartVertexIndex(s,n);(0,Nd.GH)(0<=R&&R<l);const A=R*T;(0,Nd.GH)(0<=A&&A<=C-T);let O=0,P=A;c.getEdgeVertexPosition(s,xu,d,0),c.getEdgeVertexPosition(s,Cu,d,u-1);const D=(0,Me.j)(xu,Cu),I=Math.max(Au,1e-4*D);for(let i=0;i<=T;++i){c.getEdgeVertexPosition(s,xu,d,O),m.getEdgeVertexPosition(f,Cu,_,P);const r=i/T,a=x?w[0]+r*(w[2]-w[0]):t===nu.N.WEST?w[0]:w[2],l=x?t===nu.N.SOUTH?w[1]:w[3]:w[1]+r*(w[3]-w[1]),p=e.surface.extent;if(null==p||(0,V.Rj)(p,a,l)){const t=(0,Me.G)(xu,Cu),i=(0,Me.H)(xu)-ue.$O.radius,r=(0,Me.H)(Cu)-ue.$O.radius,g=t<I;if(!g){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${s}[${O}/${u}] and [${n.lij}].edge${f}[${P}/${y}]`),null!=p&&console.warn("  surface extent= ",p," x,y=",a,",",l);const v=(0,E.vt)();(0,Me.d)(v,h.localOrigin,o.localOrigin),(0,Me.H)(v)>0&&console.warn(`   localOrigins: ${h.localOrigin} vs ${o.localOrigin} d=${(0,Me.H)(v)} [${v}]`),(()=>{const t=(0,E.o8)(xu),i=(0,E.o8)(Cu);e.updateEdgeElevations(),n.updateEdgeElevations(),c.getEdgeVertexPosition(s,xu,d,O),m.getEdgeVertexPosition(f,Cu,_,P);const r=(0,E.vt)();(0,Me.a)(r,xu,t),(0,Me.H)(r)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${t} vs ${xu} d=${(0,Me.H)(r)} [${r}]`),(0,Me.a)(r,Cu,i),(0,Me.H)(r)>0&&console.warn(`  XXX Neighbor[${n.lij}] edge out of date: ${i} vs ${Cu} d=${(0,Me.H)(r)} [${r}]`)})();const b=c.getEdgeCount(s),w=m.getEdgeCount(y);(0,Nd.GH)(g,`Mismatch in tile [${e.lij}].edge[${s}][${O}/${b}] vs neighbor [${n.lij}].edge[${f}][${P}/${w}] ${(0,Nd.hC)(xu)} vs ${(0,Nd.hC)(Cu)}  dist=${t} h(t|n|d)=${i}|${r}|${r-i}`)}c.getEdgeNormal(s,Tu,O),m.getEdgeNormal(f,Mu,P),(0,Me.n)(Su,Tu),(0,Me.n)(Ru,Mu);const v=(0,Me.f)(Su,Ru),b=1-v<.01||e===n;if(!b){const t=(0,E.vt)();(0,Me.a)(t,Tu,Mu);const i=()=>`Mismatch in tile edge normal ${(0,Nd.xl)(e.lij)} (${O}/${u-1}) edge ${s} vs neighbor ${(0,Nd.xl)(n.lij)}  (${P}/${y-1}) nedge ${f} :${(0,Nd.hC)(Tu)} vs ${(0,Nd.hC)(Mu)}  dot = ${v} : ${(0,Nd.hC)(t)}`;console.warn("Mismatch in tile edge normal: ",i());{e.updateEdgeElevations(),n.updateEdgeElevations();const t=(0,E.vt)(),i=(0,E.vt)();c.getEdgeNormal(s,t,O),m.getEdgeNormal(f,i,P),(0,Me.I)(Tu,t)||console.warn("Missing update in tile normal: ",(0,Nd.hC)(Tu)," => ",(0,Nd.hC)(t)),(0,Me.I)(Mu,i)||console.warn("Missing update in neighbor normal: ",(0,Nd.hC)(Mu)," => ",(0,Nd.hC)(i))}(0,Nd.GH)(b,i())}}O+=1,P+=1}}))}}const xu=(0,E.vt)(),Cu=(0,E.vt)(),Tu=(0,E.vt)(),Mu=(0,E.vt)(),Su=(0,E.vt)(),Ru=(0,E.vt)(),Au=1,Eu=[null,null,null,null];function Ou(e,t){return t?.loaded||t===e?t:null}const Pu=1,Du=2,Iu=4,Lu=8,Nu=4,Hu=8,Fu=12,Vu=[0,1,2,3];class Uu{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,zd.ZY.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),{minLevel:r,maxLevel:s}=i.dataLevelRange,n=this._desiredMinLevelDelta,a=this._progressiveLevelModulo+n,o=this._scaleRangeEnabled?_u.Cn:()=>!0;let l=this.tile;const h=l.level;let c;const d=this._tileLayerInfo.upsampleInfo,u=d?.tile?.level??-1,p=null!=d&&u-h>=n,m=(0,_u.ZZ)(i),_="vector-tile-3d"===i.type?i.schemaHelper:null;for(;l&&o(l,i)&&l.level>=r;){const i=l.level,o=h-i,d=l.layerInfo[t][e];if(d.data&&o>=n){(!p||i>u)&&this._setUpsampleTile(l),d.dataInvalidated&&(c=l);break}const g=_?.getLevelRowColumn(l.lij)??l.lij;if("unavailable"!==m?.getAvailability(g[0],g[1],g[2])&&i<=s&&!d.data&&!d.dataMissing&&((!c||l.level===r||i%Pd.EY==0||h-c.level<n)&&(c=l),o>=a))break;l=l.parent}if(null!=c&&h-c.level<n)if(d)c=null;else{const i=this._findAncestorWithData();null!=i&&(this._setUpsampleTile(i),c=i.layerInfo[t][e].dataInvalidated?i:null)}return c}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,zd.ZY.FADING,t)}get test(){}}const zu=new Error("Abstract method called on TileAgent"),Gu=new class extends Uu{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw zu}get _progressiveLevelModulo(){throw zu}dispose(){}};var qu;!function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"}(qu||(qu={}));class ku{constructor(){this.waitingAgents=new oo.A,this.pendingUpdates=0}static acquire(e){const t=Bu.acquire();return t._init(e),t}release(){this.dispose(),Wu.delete(this),Bu.release(this)}dispose(){this.loadingAgent=(0,p.WD)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=(0,Nd.n8)(this._data)}static prune(){Bu.prune(0)}_init(e){this.waitingAgents.clear(),this._data=(0,Nd.n8)(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=(0,p.DC)(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this.upsampleInfo)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;this.upsampleInfo.tile?.unrefMapData()}t.refMapData(),(0,_u.vx)(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){(0,Nd.n8)(this._data),this._data=e}}const Bu=new Td.A(ku,null,(()=>{})),Wu=new Map;var Zu;!function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.GEOMETRY=8]="GEOMETRY",e[e.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=32]="TEXTURE_FADING"}(Zu||(Zu={}));class ju{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,V.vt)(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=(0,V.vt)(),this.centerAtSeaLevel=(0,E.vt)(),this._center=[(0,E.vt)(),(0,Kt.c)(),(0,E.vt)()],this.up=(0,E.TS)(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=(0,E.vt)(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){Yu.prune(0),Xu.prune(0),ku.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[Ju.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=e?.frustumVisibility??qu.INTERSECTS;this._frustumVisibility=t===qu.INSIDE?qu.INSIDE:t===qu.OUTSIDE?qu.OUTSIDE:this._calculateFrustumVisibility(this.surface.frustum);const i=this._frustumVisibility!==qu.OUTSIDE&&this._intersectsClippingArea;i!==this._visible&&(this._visible=i,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,r,s){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=(0,Pe.tO)(s.tilingScheme.spatialReference),s.tilingScheme.getExtent(e,t,i,this.extent),s.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,s.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Ju.MIDDLE][3]=0,this.elevationLevel=e,r&&!Number.isNaN(r.elevationBoundsMin)?(this._elevationBoundsMin=r.elevationBoundsMin,this._elevationBoundsMax=r.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.clearChildren(),this._surface=s,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const n of Qh){const e=s.numLayers(n),t=this.layerInfo[n];for(const i of t)i.release();t.length=e;for(let i=0;i<e;i++)t[i]=ku.acquire(this._surface.upsampleInfoPool),n===jh.ELEVATION&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(s.tilingScheme.pixelSize,Pd.Me)}dispose(){null!=this._surface&&((0,Nd.bk)(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key),this.layerInfo.forEach((e=>{e.forEach((e=>e.release())),e.length=0})),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty())}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),null==this._surface?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[jh.MAP].reduce(((e,t)=>{let{data:i}=t;return e+((0,fc.kC)(i)?i.usedMemoryPerReference:0)}),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:e}of this.layerInfo[jh.MAP])(0,fc.kC)(e)?this._vectorTileMemory+=e.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(e);for(const e of this.layerInfo[jh.ELEVATION])this._usedMemory+=e.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.cachedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i?.data?e===jh.MAP?this._cached?0:this.getTerrainDataMemory(i.data):e===jh.ELEVATION?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return(0,fc.Cs)(e)?e.texture.usedMemory:(0,fc.k$)(e)?e.memoryUsage:(0,fc.kC)(e)?e.usedMemoryPerReference:(0,fc.EM)(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[Ju.MIDDLE],i=e,r=t[0],s=t[1],n=t[2],a=i[2]*r+i[6]*s+i[10]*n+i[14];this.screenDepth=a<0?0:a/(i[3]*r+i[7]*s+i[11]*n+i[15])}shouldSplit(e,t,i){if(!this.visible)return Zu.NONE;if(e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(e.frustum)===qu.OUTSIDE))return Zu.NONE;const r=this.level;(0,Me.d)(np,(0,Kt.a)(this._center[Ju.MIDDLE]),t);let s=(0,Me.k)(np),n=np,a=(0,Kt.a)(this._center[Ju.MIDDLE]);(0,Me.d)(ap,this._center[Ju.TOP],t);const o=(0,Me.k)(ap);o<s&&(s=o,n=ap,a=this._center[Ju.TOP]),(0,Me.d)(op,this._center[Ju.BOTTOM],t);const l=(0,Me.k)(op);if(l<s&&(s=l,n=op,a=this._center[Ju.BOTTOM]),this._edgeLen2>s&&r<e.maxLod)return Zu.SPLIT;const h=Math.sqrt(s),c=e.fovX*h*2,d=this._edgeLen/c,u=()=>{if(r<e.maxLod)return this.elevationLevel=r,Zu.NONE;const t=r+Math.ceil(-Math.log2(e.relativeWidthLimit/d));return t!==this.elevationLevel?(this.elevationLevel=t,Zu.ELEVATION):Zu.NONE},p=null!=i?i-r:1/0;if(p<=.5)return u();const m=(0,Me.f)(this.up,np),_=this._elevationBoundsMax-this._elevationBoundsMin,g=_/this.edgeLen;if(e.aboveGround&&m>0&&g<.001&&m/h-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-g>0)return Zu.NONE;const f=null!=i?3-Math.min(p,2):1;if(d*f<e.relativeWidthLimit||r>=e.maxLod)return u();if(r<7)return Zu.SPLIT;(0,Me.h)(lp,this.up,m),(0,Me.d)(lp,lp,n);const y=(0,Me.k)(lp);if(y<=this.radius*this.radius)return Zu.SPLIT;(0,Me.h)(lp,lp,this.radius/Math.sqrt(y)),(0,Me.g)(lp,lp,a),(0,Me.d)(lp,t,lp);const v=Math.min(1,(Math.abs((0,Me.f)(lp,this.up))+.5*_+this._curvatureHeight)/(0,Me.l)(lp)),b=.1/e.angledSplitBias,w=e.fovY*h*2;return v*(this._edgeLen/w*f)<b*e.relativeHeightLimit?Zu.NONE:Zu.SPLIT}createChildren(){const e=this._children,t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e[0]=this.surface.createTile(t,i,r,this),e[1]=this.surface.createTile(t,i,r+1,this),e[2]=this.surface.createTile(t,i+1,r,this),e[3]=this.surface.createTile(t,i+1,r+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of Qh)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const e of Qh){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==Gu&&(Qu(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(Zu.GEOMETRY),this.resetPendingUpdate(Zu.TEXTURE_NOFADING),this.resetPendingUpdate(Zu.TEXTURE_FADING)}unloadMapData(){const e=this.layerInfo[jh.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==Gu&&(Qu(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if((0,V.aI)(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._withinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._withinClippingArea,s=!(i||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||r||s||this.setPendingUpdate(Zu.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i?.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Qh){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==Gu&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(Zu.SPLIT)||e!==jh.ELEVATION&&!this._loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===Zu.SPLIT||e===Zu.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const s=(0,fc.kC)(r.data);return i.dataArrived(this,s),!0}if(r.requestPromise)return!0;(0,p.DC)(r.requestAbort),r.requestAbort=new AbortController;const s=this._surface.requestTileData(this,e,t,r.requestAbort);if(!s)return r.requestAbort=null,!1;const n=()=>{r.requestPromise===s&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=s,s.then(n,n),!0}get leaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return(0,Me.k)((0,Me.d)(lp,(0,Kt.a)(this._center[Ju.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],s=r.waitingAgents,n=null!=s.removeUnordered(i);(0,Nd.bk)(n,"agent has not requested this piece of map data"),s.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const r=(0,fc.kC)(i),s=this.layerInfo[t][e];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll((e=>e.dataArrived(this,r))),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const i=this.layerInfo[t][e];i.dataMissing=!0,i.waitingAgents.forAll((e=>e.dataMissing())),i.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor((i=>i.updateRenderData(e,t))),e){case jh.MAP:return this._updateTexture(t);case jh.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===zd.ZY.FADING?Zu.TEXTURE_NOFADING:Zu.TEXTURE_FADING),this.setPendingUpdate(e===zd.ZY.FADING?Zu.TEXTURE_FADING:Zu.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(Zu.GEOMETRY);for(const e of this.layerInfo[jh.ELEVATION])e.pendingUpdates|=Zu.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let i=1/0,r=-1/0;const s=this.layerInfo[jh.ELEVATION];let n=!0;for(const a of s)null!=a.elevationBounds&&(i=Math.min(i,a.elevationBounds.min),r=Math.max(r,a.elevationBounds.max),a.elevationBounds.hasNoDataValues||(n=!1));n&&(i=Math.min(i,0),r=Math.max(r,0)),e===i&&t===r||(this._elevationBoundsMin=i,this._elevationBoundsMax=r,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,i=.5*(e+t),r=this._center;(0,Me.h)(lp,this.up,i),(0,Me.g)((0,Kt.a)(r[Ju.MIDDLE]),this.centerAtSeaLevel,lp),(0,Me.h)(lp,this.up,e),(0,Me.g)(r[Ju.TOP],this.centerAtSeaLevel,lp),(0,Me.h)(lp,this.up,t),(0,Me.g)(r[Ju.BOTTOM],this.centerAtSeaLevel,lp)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[jh.ELEVATION][e],r=this.elevationLevelDelta,s=Math.max(this.elevationLevel-r,0),n=i.elevationBounds;if(null!=n&&n.level>=t&&n.level<=s)return;const a=this._surface.layerViewByIndex(e,jh.ELEVATION);if(!(0,_u.Cn)(this,a))return;const o=Ku;let l=!1;const h=i.data;if(h&&h.level<=s){const e=i.data;o.min=e.samplerData.data.minValue,o.max=e.samplerData.data.maxValue,o.hasNoDataValues=e.samplerData.data.hasNoDataValues,o.level=this.level,l=!0}else{let t,i,n=0;for(let a=this._parent;a&&(!i||n<r)&&(n=this.elevationLevel-a.level,t=i||t,i=a.layerInfo[jh.ELEVATION][e].data,!(!i&&t&&a.level<=s));a=a.parent);i=i||t,i&&(i.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],o),o.min!==1/0&&(o.level=i.level,l=!0))}l&&(null==i.elevationBounds&&(i.elevationBounds=new Ed),i.elevationBounds.copyFrom(o))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const a of r)a.loadingAgent&&a.loadingAgent!==Gu&&(Qu(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<r.length;++a)void 0===e[a]&&r[a].release();const s=new Array(...r),n=t.length;r.length=n;for(let a=0;a<n;a++){const e=t[a];r[a]=e>-1?s[e]:ku.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,zd.ZY.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===Gu&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Qh){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==Gu&&(i.loadingAgent.setSuspension(t),i.loadingAgent===Gu&&this.updateRenderData(e,zd.ZY.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==Gu&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=Gu,i.data||null!=i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||(0,q.jZ)(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let r=e;r<t;++r){const e=this._surface.layerViewByIndex(r,i);if((0,Nd.KE)(e)&&"normal"!==e?.layer?.blendMode||(0,q.jZ)(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const r=this._isSuspended(t);for(let s=e;s<i.length;++s){const n=i[s],a=this._surface.layerViewByIndex(s,t);let o=!1;if(n.loadingAgent?(0,_u.Cn)(this,a)?(n.loadingAgent!==Gu&&n.loadingAgent.setSuspension(r),n.loadingAgent!==Gu&&(o=n.loadingAgent.update())):n.dispose():(0,_u.Cn)(this,a)&&(n.loadingAgent=$u(this,s,t,r),o=n.loadingAgent.startLoading(),o?n.loadingAgent===Gu&&this.setPendingUpdate(Zu.GEOMETRY):(Qu(n.loadingAgent),n.loadingAgent=Gu)),n.loadingAgent===Gu&&this.updateRenderData(t,zd.ZY.FADING),!this._hasBlendModes(e,i.length,t)&&o&&a.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-t),r=(0,de.qE)(1+(this._maxTesselation>>i),2,this._maxTesselation+1),s=this.minimumVerticesPerSide;return Math.max(r,s)}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(null!=i)for(const r of i)if(ep(r,e)){let i=r,s=e[0]-i.level-1;for(;s>=0&&!i.leaf&&!t(i);){const t=e[1]>>s&1,r=e[2]>>s&1;i=i.children[2*t+r],s--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this._lij,r=this._getNeighborLIJ(i,e);return r?tp(i,r)?t(this)?this:null:this._findLIJ(r,t):null}findCorner(e,t){const i=e===nu.N.NORTH_EAST?1:e===nu.N.NORTH_WEST?0:e===nu.N.SOUTH_WEST?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[i];return r}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,(e=>t(e)||e.level===this.level))?.findCorner((0,Nd.jj)(e),t)||null}forAllSubtreeOnSide(e,t){const i=e===nu.N.NORTH?[0,1]:e===nu.N.NORTH_EAST?[1]:e===nu.N.EAST?[1,3]:e===nu.N.SOUTH_EAST?[3]:e===nu.N.SOUTH?[2,3]:e===nu.N.SOUTH_WEST?[2]:e===nu.N.WEST?[0,2]:[0],r=e=>{const s=e.children;!t(e)&&s[0]&&i.forEach((e=>r(s[e])))};r(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if((0,Nd.GH)(!Nd.L8||i>=0),0===i)return 0;const r=2**i,s=!(1&~e),n=s?0:1,a=t.lij[n+1]*r,o=this._lij[n+1],l=o-a,h=s?r-1-l:l;return Nd.L8&&((0,Nd.GH)(a<=o&&o<a+r),(0,Nd.GH)(0<=h&&h<r)),h}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.loaded;Nd.Rz.forEach((t=>{const r=this.findNeighborTile(t,i);null!=r&&r!==this&&r.forAllSubtreeOnSide((0,Nd.JM)(t),(i=>!!i.loaded&&(e(i,t),!0)))})),Nd.XQ.forEach((t=>{const r=this.findNeighborTile(t,i)?.findCorner((0,Nd.jj)(t),(e=>e.loaded));(0,Nd.GH)(!r||ip(this,r,t)),r?.loaded&&e(r,t)}))}_getNeighborLIJ(e,t){const i=(0,Nd.uK)(t)?-1:(0,Nd.mJ)(t)?1:0,r=(0,Nd.Ec)(t)?-1:(0,Nd.sZ)(t)?1:0,s=[e[0],e[1]+i,e[2]+r];return s[1]<0?null:this.surface.isGlobal?this._wrapLIJ(s):s[2]<0?null:s}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(null==e)return!1;if(0===this.level&&0===e.level){if(this._eastEnd&&e._westEnd&&t===nu.N.EAST)return!0;if(this._westEnd&&e._eastEnd&&t===nu.N.WEST)return!0}const i=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case nu.N.NORTH:return(0,Nd.yL)(this.extent[3],e.extent[1],i);case nu.N.SOUTH:return(0,Nd.yL)(this.extent[1],e.extent[3],i);case nu.N.EAST:return(0,Nd.yL)(this.extent[2],e.extent[0],i)||(0,Nd.yL)(this.extent[2],-e.extent[0],i);case nu.N.WEST:return(0,Nd.yL)(this.extent[0],e.extent[2],i)||(0,Nd.yL)(this.extent[0],-e.extent[2],i)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return 0===this._lij[2]}checkGeometryWaterproofness(){Nd.aL&&((0,Nd.GH)(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if((0,Nd.uK)(e)&&t[3]+r>=i[3])return!1;if((0,Nd.mJ)(e)&&t[1]-r<=i[1])return!1;const s=this.surface.isGlobal;return!(!s&&(0,Nd.Ec)(e)&&t[0]-r<=i[0])&&!(!s&&(0,Nd.sZ)(e)&&t[2]+r>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;(0,Me.c)(this._lastPOI,e);const i=this._center[Ju.MIDDLE],r=e[0]-i[0],s=e[1]-i[1],n=e[2]-i[2];this.distanceToPOI=r*r+s*s+n*n}}function $u(e,t,i,r){const s=i===jh.ELEVATION?Xu.acquire():Yu.acquire();return s.init(e,t,i,r),s}function Qu(e){e.dispose(),function(e){return"elevation"===e.type}(e)?Xu.release(e):function(e){return"map"===e.type}(e)&&Yu.release(e)}const Yu=new Td.A(class extends Uu{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Pd.EY}}),Xu=new Td.A(class extends Uu{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}),Ku=new Ed;var Ju;function ep(e,t){const i=e.lij,r=t[0]-i[0];return!(r<0)&&t[1]>>r===i[1]&&t[2]>>r===i[2]}function tp(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function ip(e,t,i){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?rp(e,t,i):rp(t,e,(0,Nd.jj)(i)))}function rp(e,t,i){(0,Nd.GH)(e.level>=t.level);const r=(0,Nd.hL)(i),s=(0,Nd.HF)(i),n=e.extent,a=t.extent,o=[r?n[0]:n[2],s?n[3]:n[1]],l=[r?a[2]:a[0],s?a[1]:a[3]],h=1e-5*(n[2]-n[0]),c=(0,Nd.yL)(o[0],l[0],h)||e.surface.isGlobal&&(0,Nd.yL)(o[0],-l[0],h),d=(0,Nd.yL)(o[1],l[1],h);if(c&&d)return!0;if(e.level===t.level)return(0,Nd.GH)(!1),!1;if(!c&&!d)return(0,Nd.GH)(!1),!1;const u=c?sp(a[1],a[3],n[1],n[3],h):sp(a[0],a[2],n[0],n[2],h);return(0,Nd.GH)(u),u}function sp(e,t,i,r,s){return e-s<=i&&i<=r&&r<=t+s}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(Ju||(Ju={}));const np=(0,E.vt)(),ap=(0,E.vt)(),op=(0,E.vt)(),lp=(0,E.vt)();function hp(e,t){const{tile:i,geometry:r,geometryState:s}=e,{extentInRadians:n,surface:a}=i,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:h,wireframe:c}=s,d=h-1,u=(h-2)**2,p=o&&(t===zd.JG.HAS_SOUTH_POLE||t===zd.JG.HAS_BOTH_POLES),m=o&&(t===zd.JG.HAS_NORTH_POLE||t===zd.JG.HAS_BOTH_POLES),_=((p?1:0)+(m?1:0))*qp*h,g=Up(s),f=u+_+4*g,y=l.tileGeometryCache.acquire(f);r.numVerticesPerSide=h,r.vertexAttributes=y,r.maxEdgeVertexCount=g;const{boundingBox:v}=r;(0,su.Ie)(v);const b=mp(e);Dp.update(d,n,b),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:s}=e,{numVerticesPerSide:n,samplerData:a}=r,o=n-2,l=n-1,{vertexAttributes:h,boundingBox:c}=i,d=h.position,u=h.uv0,{typedBuffer:p,typedBufferStride:m}=h.normalCompressed,{extent:_}=t,g=_[0],f=_[2],y=_[1],v=_[3],b=t.ellipsoid.radius,w=s[0],x=s[1],C=s[2],T=d.typedBuffer,M=d.typedBufferStride,S=1/l;let R=0;if(1<=o){const e=S,t=y*(1-e)+v*e,i=Dp.sinLatLUT[1],r=Dp.cosLatLUT[1];for(let s=1;s<=o;s++){const n=s*S,o=g*(1-n)+f*n,l=Dp.sinLonLUT[s],h=Dp.cosLonLUT[s],d=b+Ld(o,t,a),p=d*h*r-w,m=d*l*r-x,_=d*i-C;Vp(p,m,_,c);const y=(s-1)*M;T[y]=p,T[y+1]=m,T[y+2]=_,hu(u,s-1,n,e)}}for(let A=1;A<=o;A++){const e=A*S,t=y*(1-e)+v*e,i=Dp.sinLatLUT[A],r=Dp.cosLatLUT[A],s=A+1,n=s*S,h=y*(1-n)+v*n,d=Dp.sinLatLUT[s],_=Dp.cosLatLUT[s],E=Dp.sinLonLUT[0],O=Dp.cosLonLUT[0],P=b+Ld(g,t,a);let D=O*r*P-w,I=E*r*P-x,L=i*P-C;const N=R*M;let H=T[N],F=T[N+1],V=T[N+2];for(let v=1;v<=o;v++){const e=v*S,s=g*(1-e)+f*e,E=Dp.sinLonLUT[v],O=Dp.cosLonLUT[v];let P=0,N=0,U=0;if(v<o){const e=(R+1)*M;P=T[e],N=T[e+1],U=T[e+2]}else{const e=Dp.sinLonLUT[l],s=Dp.cosLonLUT[l],n=b+Ld(f,t,a);P=s*r*n-w,N=e*r*n-x,U=i*n-C}const z=D,G=I,q=L;D=H,I=F,L=V,H=P,F=N,V=U;const k=P-z,B=N-G,W=U-q;let Z=0,j=0,$=0;if(A>1){const e=(R-o)*M;Z=T[e],j=T[e+1],$=T[e+2]}else{const e=Dp.sinLatLUT[0],t=Dp.cosLatLUT[0],i=b+Ld(s,y,a);Z=O*t*i-w,j=E*t*i-x,$=e*i-C}const Q=b+Ld(s,h,a),Y=O*_*Q-w,X=E*_*Q-x,K=d*Q-C;if(A<o){const t=R+o,i=t*M;T[i]=Y,T[i+1]=X,T[i+2]=K,Vp(Y,X,K,c),hu(u,t,e,n)}const J=Z-Y,ee=j-X,te=$-K;let ie=O*r,re=E*r,se=i;se*se<.999&&(ie=W*ee-B*te,re=k*te-W*J,se=B*J-k*ee);const ne=1/Math.sqrt(ie*ie+re*re+se*se);(0,au.aT)(p,R,ie*ne,re*ne,se*ne,m),++R}}}(e),r.poleVerticesStartIndex=u;const w=function(e,t,i){const{tile:r,localOrigin:s,geometry:n}=e,{extent:a,ellipsoid:o}=r,{boundingBox:l,numVerticesPerSide:h,vertexAttributes:c,poleVerticesStartIndex:d}=n,u=h-1,p=s[0],m=s[1],_=s[2],g=o.radius,f=a[1],y=a[3],v=[];let b=d;const w=(e,t)=>{const i=t*h;Vp(-p,-m,e*g-_,l),v.push(new Op(1===e,i,1===e?0:2,b,qp));const r=pp(-1===e?f:y,g),s=e*Math.PI/2-r,n=.99*(1===e?1:-1),a=g+0,{position:o,uv0:d}=c,{typedBuffer:w,typedBufferStride:x}=c.normalCompressed;for(let h=1;h<=qp;++h){const e=r+s*(h/qp),t=Math.cos(e),i=Math.sin(e);for(let r=0;r<=u;r++){const e=r/u,s=Dp.sinLonLUT[r],h=Dp.cosLonLUT[r]*t,c=s*t,g=i,f=h*a-p,y=c*a-m,v=g*a-_;Vp(f,y,v,l),o.setValues(b,f,y,v),hu(d,b,e,n),(0,au.aT)(w,b,h,c,g,x),++b}}};return t&&w(-1,0),i&&w(1,u),v}(e,p,m);r.edgeVerticesStartIndex=u+_,Cp(e),cp(e),bp(r,w,c),e.intersectionData=null}function cp(e){e.tile.intersectsClippingArea&&(up(e),dp(e))}function dp(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{geometry:i,geometryState:r,tile:s,localOrigin:n}=e,{level:a,extent:o,extentInRadians:l,ellipsoid:h}=s,c=h.radius,d=l[0],u=l[2],p=l[1],m=l[3],{samplerData:_}=r,g=o[0],f=o[2],y=o[1],v=o[3],b=mp(e),{boundingBox:w,vertexAttributes:x}=i,C=n[0],T=n[1],M=n[2],S=x.position,R=S.typedBuffer,A=S.typedBufferStride,E=x.uv0;for(let O=0;O<4;++O){const n=1===O||3===O,l=r.edgeResolutions[O];(0,Nd.GH)((0,de.r6)(l));const h=l+1,x=Ou(s,r.edgePeerNeighbors[O]);if(Np(s,x,O)){Mp(e,O,x);continue}const S=null!=x;(0,Nd.GH)(!S||x.level===s.level),(0,Nd.GH)(!S||(0,_u.lR)(s,x)<=0);const P=x?.renderData,D=P?.geometryState;if(Nd.L8){const e=s.surface;if(!x&&e&&!e.updatingRootTiles){const t=Nd.Rz[O],i=s.findNeighborTile(t,(e=>e.loaded||e.leaf||e.level===s.level));i?i.intersectsClippingArea&&((0,Nd.GH)(!i.loaded),(0,Nd.GH)(!i.leaf),(0,Nd.GH)(i.level===a)):(0,Nd.GH)(null==e?.rootTiles||!s.shouldHaveNeighbor(t))}}const I=1===O?o[2]:o[0],L=x?.extent,N=L&&n?1===O?L[0]:L[2]:I,H=0===O?o[3]:o[1],F=1===O?1:0,V=0===O?1:0,U=1===O?u:d,z=0===O?m:p,G=Math.sin(U),q=Math.cos(U),k=Math.sin(z),B=Math.cos(z),W=D?.samplerData,Z=S?(e,t,i)=>.5*(Ld(e,t,_)+Ld(i,t,W)):(e,t,i)=>Ld(e,t,_),j=i.outerEdgesOffsetAndLength[2*O+0],$=t&&h>3?h-3:1,Q=null!=_&&_.some((e=>null!=e)),Y=null!=W&&W.some((e=>null!=e)),X=Q||Y,K=1/l,J=j;(0,Nd.GH)(!L||(0,Nd.yL)(L[2]-L[0],o[2]-o[0])),(()=>{const e=1===O?-1:3===O?1:0,t=0===O?-1:2===O?1:0,r=(o[2]-o[0])*K,s=e*r,a=t*r,l=n?e*((u-d)*K):0,p=n?0:t*K,m=V,x=n?U+l:U,P=n?Math.sin(x):G,D=n?Math.cos(x):q,L=n?U-l:U,j=n?Math.sin(L):G,Q=n?Math.cos(L):q,Y=n?z:b(m+p),ee=n?k:Math.sin(Y),te=n?B:Math.cos(Y),ie=n?z:b(m-p),re=n?k:Math.sin(ie),se=n?B:Math.cos(ie);let ne=0,ae=0,oe=0;{const e=0*K,t=n?I:g*(1-e)+f*e,i=n?N:t,r=n?y*(1-e)+v*e:H,s=n?U:d*(1-e)+u*e,a=n?G:Math.sin(s),o=n?q:Math.cos(s),l=n?b(e):z,h=n?Math.sin(l):k,p=n?Math.cos(l):B,m=c+Z(t,r,i);ne=o*p*m,ae=a*p*m,oe=h*m}let le=0,he=0,ce=0;{const e=1*K,t=n?I:g*(1-e)+f*e,i=n?N:t,r=n?y*(1-e)+v*e:H,s=n?U:d*(1-e)+u*e,a=n?G:Math.sin(s),o=n?q:Math.cos(s),l=n?b(e):z,h=n?Math.sin(l):k,p=n?Math.cos(l):B,m=c+Z(t,r,i);le=o*p*m,he=a*p*m,ce=h*m}for(let o=1;o<h-1;o+=$){let e=0,t=0,r=0;{const i=(o+1)*K,s=n?I:g*(1-i)+f*i,a=n?N:s,l=n?y*(1-i)+v*i:H,h=n?U:d*(1-i)+u*i,p=n?G:Math.sin(h),m=n?q:Math.cos(h),_=n?b(i):z,w=n?Math.sin(_):k,x=n?Math.cos(_):B,C=c+Z(s,l,a);e=m*x*C,t=p*x*C,r=w*C}const l=e,h=t,p=r,m=le,x=he,L=ce;le=l,he=h,ce=p;{const e=J+o,t=e*A,i=m-C,r=x-T,s=L-M;R[t]=i,R[t+1]=r,R[t+2]=s,Vp(i,r,s,w);const a=o*K;hu(E,e,n?F:a,n?a:V)}const $=ne,Y=ae,ie=oe;ne=m,ae=x,oe=L;const de=m,ue=x,pe=L,me=1/Math.sqrt(de*de+ue*ue+pe*pe),_e=pe*me;let ge=0,fe=0,ye=0;if(X&&_e*_e<.999){let e=0,t=0,i=0;{const r=0===O?-1:1;e=r*(l-$),t=r*(h-Y),i=r*(p-ie)}{const r=o*K,l=n?I:g*(1-r)+f*r,h=n?N:l,p=n?y*(1-r)+v*r:H,m=n?U:d*(1-r)+u*r,w=n?G:Math.sin(m),x=n?q:Math.cos(m),C=n?b(r):z,T=n?Math.sin(C):k,M=n?Math.cos(C):B;let R=de,A=ue,E=pe;if(S){const e=c+Ld(h-s,p-a,W),t=n?M:se;R=(n?Q:x)*t*e,A=(n?j:w)*t*e,E=(n?T:re)*e}{const r=c+Ld(l+s,p+a,_),o=n?M:te,h=(n?D:x)*o*r,d=(n?P:w)*o*r,u=(n?T:ee)*r;S||(R=2*de-h,A=2*ue-d,E=2*pe-u);const m=3===O?-1:1,g=m*(R-h),f=m*(A-d),y=m*(E-u);ge=i*f-t*y,fe=e*y-i*g,ye=t*g-e*f;const v=1/Math.sqrt(ge*ge+fe*fe+ye*ye);ge*=v,fe*=v,ye*=v}}}else ge=de*me,fe=ue*me,ye=pe*me;i.setEdgeNormalFromValues(O,o,ge,fe,ye)}})()}}function up(e){Sp(e)}function pp(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function mp(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius;return t=>function(e,t,i,r){return pp(e*(1-r)+t*r,i)}(e[1],e[3],i,t)}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function _p(e,t){const{tile:i,geometryState:r,geometry:s}=e,{extent:n,surface:a}=i,{wireframe:o}=r,l=n[0],h=n[1],c=n[2]-l,d=n[3]-h,{numVerticesPerSide:u,clippingArea:p}=r,m=null!=p?Math.max(0,(p[0]-l)/c):0,_=null!=p?Math.max(0,(p[1]-h)/d):0,g=null!=p?Math.min(1,(p[2]-l)/c):1,f=null!=p?Math.min(1,(p[3]-h)/d):1,y=(u-2)**2,v=Up(r),b=y+4*v,w=a.renderer.tileGeometryCache.acquire(b),{boundingBox:x}=s;(0,su.Ie)(x),s.numVerticesPerSide=u,s.vertexAttributes=w,s.maxEdgeVertexCount=v,s.minu=m,s.minv=_,s.maxu=g,s.maxv=f,function(e){const t=e.tile;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:s}=e,{samplerData:n,clippingArea:a,numVerticesPerSide:o}=r,{surface:l,extent:h,ellipsoid:c}=t,{isWebMercatorOnPlateCarree:d}=l,u=null!=a?a:Ip,p=h[0],m=h[1],_=h[2],g=h[3],f=Math.max(p,u[0]),y=Math.min(_,u[2]),v=Math.max(m,u[1]),b=Math.min(g,u[3]),w=c.radius,x=t.horizontalScale,C=o-1,T=o-2,{minu:M,minv:S,maxu:R,maxv:A,boundingBox:E,vertexAttributes:O}=i,P=O.position,D=O.uv0,{typedBuffer:I,typedBufferStride:L}=O.normalCompressed,N=s[0],H=s[1],F=s[2],V=P.typedBuffer,U=P.typedBufferStride;let z=0;const G=(0,de.qE)(m,v,b),q=d?(Math.PI/2-2*Math.atan(Math.exp(-G/w)))*w:G*x,k=1/C,B=(0,de.qE)(m*(1-k)+g*k,v,b);let W=q,Z=d?(Math.PI/2-2*Math.atan(Math.exp(-B/w)))*w:B*x;for(let j=1;j<=T;j++){const e=j/C,t=(0,de.qE)(m*(1-e)+g*e,v,b),i=(0,de.qE)(e,S,A),r=Z,s=(j-1)/C,a=(0,de.qE)(m*(1-s)+g*s,v,b),o=W,l=(j+1)/C,h=(0,de.qE)(m*(1-l)+g*l,v,b),c=d?(Math.PI/2-2*Math.atan(Math.exp(-h/w)))*w:h*x,u=(0,de.qE)(l,S,A);W=Z,Z=c;const O=(0,de.qE)(p,f,y);let P=O*x,G=Ld(O,t,n);const q=1/C,k=(0,de.qE)(q,M,R),B=(0,de.qE)(p*(1-k)+_*k,f,y);let $=k,Q=B,Y=B*x,X=Ld(B,t,n);if(1===j){const e=Y-N,t=W-H,r=X-F,s=0*U;V[s]=e,V[s+1]=t,V[s+2]=r,Vp(e,t,r,E);hu(D,z,(0,de.qE)(q,M,R),i)}for(let d=1;d<=T;d++){const e=Y,s=X,l=(d+1)/C,m=(0,de.qE)(l,M,R),g=(0,de.qE)(p*(1-l)+_*l,f,y),v=Q;Q=g;{const e=z+1,s=e*U;if(1===j||d===T){const a=g*x,o=Ld(g,t,n);if(1===j&&d<T){const t=a-N,n=r-H,l=o-F;V[s]=t,V[s+1]=n,V[s+2]=l,Vp(t,n,l,E),hu(D,e,m,i)}Y=a,X=o}else Y=V[s]+N,X=V[s+2]+F}const b=Y,w=X,S=P,A=G;P=e,G=s;const O=(z-T)*U,q=1===j?Ld(v,a,n):V[O+2]+F,k=Ld(v,h,n);if(j<T){const t=z+T,i=t*U,r=e-N,s=c-H,n=k-F;V[i]=r,V[i+1]=s,V[i+2]=n,Vp(r,s,n,E);const a=$;$=m,hu(D,t,a,u)}{const e=b-S,t=o-c,i=t*(w-A),r=e*(q-k),s=-t*e,n=i*i+r*r+s*s;if(0===n)(0,au.aT)(I,z,0,0,1,L);else{const e=1/Math.sqrt(n);(0,au.aT)(I,z,i*e,r*e,s*e,L)}}++z}}}(e),s.edgeVerticesStartIndex=y,Cp(e),gp(e),bp(s,[],o),e.intersectionData=null}function gp(e,t){e.tile.intersectsClippingArea&&(yp(e),fp(e,!1))}function fp(e,t){const{geometry:i,geometryState:r,localOrigin:s}=e,n=e.tile,{surface:a,extent:o}=n,{clippingArea:l,samplerData:h}=r,c=null!=l?l:Ip,d=o[0],u=o[2],p=o[1],m=o[3],_=[m>c[3],u>c[2],p<c[1],d<c[0]],g=n.horizontalScale,f=vp(a.isWebMercatorOnPlateCarree,n.ellipsoid.radius,g),{minu:y,minv:v,maxu:b,maxv:w,boundingBox:x}=i,C=Math.max(d,c[0]),T=Math.min(u,c[2]),M=Math.max(p,c[1]),S=Math.min(m,c[3]),R=s[0],A=s[1],E=s[2];for(let O=0;O<4;++O){const s=1===O||3===O,o=r.edgeResolutions[O];(0,Nd.GH)((0,de.r6)(o));const l=o+1,c=_[O],P=Ou(n,r.edgePeerNeighbors[O]);if(!c&&Np(n,P,O)){Mp(e,O,P);continue}const D=null!=P&&!c,I=P?.renderData,L=I?.geometryState;if(Nd.L8&&((0,Nd.GH)(!D||P.level===n.level),(0,Nd.GH)(!D||(0,_u.lR)(n,P)<=0),n&&!P&&!a.updatingRootTiles)){const e=Nd.Rz[O],t=n.findNeighborTile(e,(e=>e.loaded||e.leaf||e.level===n.level));a.updatingRootTiles||(t?t.intersectsClippingArea&&((0,Nd.GH)(!t.loaded),(0,Nd.GH)(!t.leaf),(0,Nd.GH)(t.level===n.level)):(0,Nd.GH)(null==a?.rootTiles||!n.shouldHaveNeighbor(e)))}const N=(0,de.qE)(1===O?u:d,C,T),H=(0,de.qE)(0===O?m:p,M,S),F=L?.samplerData,V=t&&l>3?l-3:1,U=(0,de.qE)(1===O?1:0,y,b),z=(0,de.qE)(0===O?1:0,v,w),G=D?(e,t)=>.5*(Ld(e,t,F)+Ld(e,t,h)):(e,t)=>Ld(e,t,h),q=(u-d)/o,k=s?1===O?q:-q:0,B=s?0:0===O?q:-q,W=-k,Z=-B;let j=0,$=0,Q=0;{const e=0/o,t=s?N:(0,de.qE)(d*(1-e)+u*e,C,T),i=s?(0,de.qE)(p*(1-e)+m*e,M,S):H,r=G(t,i);j=t*g,$=f(i),Q=r}let Y=0,X=0,K=0;{const e=1/o,t=s?N:(0,de.qE)(d*(1-e)+u*e,C,T),i=s?(0,de.qE)(p*(1-e)+m*e,M,S):H,r=G(t,i);Y=t*g,X=f(i),K=r}for(let e=1;e<l-1;e+=V){const t=e/o,r=Y,n=X,a=K;{const o=s?U:(0,de.qE)(t,y,b),l=s?(0,de.qE)(t,v,w):z,h=r-R,c=n-A,d=a-E;Vp(r,c,d,x),i.setEdgeVertexFromValuesRawPositionUV(O,e,h,c,d,o,l)}{const t=(e+1)/o,i=s?N:(0,de.qE)(d*(1-t)+u*t,C,T),r=s?(0,de.qE)(p*(1-t)+m*t,M,S):H,n=G(i,r);Y=i*g,X=f(r),K=n}const l=Y,c=K,_=j,P=$,I=Q;j=r,$=n,Q=a;let L=0,V=0,q=0;if(s){const e=X-n,i=c-a,s=P-n,o=I-a,l=(0,de.qE)(p*(1-t)+m*t,M,S),d=N+W,u=d*g-r,_=Ld(d,l,h)-a,f=3===O?-1:1;if(L=f*(-s+e)*_,V=f*u*(-o+i),q=-f*u*(-s+e),D){const t=N+k,n=t*g-r;L=(-s+e)*(_-(Ld(t,l,F)-a)),V=(u-n)*(-o+i),q=-(u-n)*(-s+e)}}else{const e=l-r,i=c-a,s=_-r,o=I-a,p=(0,de.qE)(d*(1-t)+u*t,C,T),m=H+Z,g=Ld(p,m,h)-a,y=f(m)-n,v=2===O?-1:1;if(L=v*y*(-o+i),V=v*(-s+e)*g,q=-v*y*(-s+e),D){const t=p,r=H+B,l=f(r)-n;L=(-y+l)*(-o+i),V=(-s+e)*(-g+(Ld(t,r,F)-a)),q=-(-y+l)*(-s+e)}}const J=1/Math.sqrt(L*L+V*V+q*q);i.setEdgeNormalFromValues(O,e,L*J,V*J,q*J)}}}function yp(e,t){Sp(e)}function vp(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function bp(e,t,i){const{numVerticesPerSide:r,vertexAttributes:s,maxEdgeVertexCount:n}=e,a=r-1,o=s.count,l=2*(r-3)*(r-3),h=4*(a+n-3),c=Vu.reduce(((t,i)=>t+(a+e.getEdgeCount(i)-3)),0),d=t.reduce(((e,t)=>e+a*(2*(t.latitudeResolution-1)+1)),0),u=3*(i?2:1),p=(l+h+d)*u,m=o>=65536?new Uint32Array(p):new Uint16Array(p);for(let _=0;_<p;++_)m[_]=0;e.indices=m,e.indexCount=(l+c+d)*u,e.poleIndicesStartIndex=l*u,e.edgeIndicesStartIndex=(l+d)*u,i?(function(e){const{indices:t,numVerticesPerSide:i,vertexAttributes:r}=e,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=i-2;let l=0;for(let h=0;h<i-3;++h){const e=h*o;for(let r=0;r<i-3;++r){const i=h*o+r,s=i+1,c=s+o,d=c-1,u=e+r,p=u+1,m=p+o;zp(u,p,m,m-1,a,n)?(Gp(t,l,i,s,c),l+=6,Gp(t,l,c,d,i)):(Gp(t,l,i,s,d),l+=6,Gp(t,l,d,c,s)),l+=6}}}(e),function(e,t){const{indices:i,numVerticesPerSide:r,poleIndicesStartIndex:s}=e,n=r-1;let a=s;for(const o of t){const t=o.connectedOuterEdgeOffset;let s=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<o.latitudeResolution;++e){const t=0===e?o.rowOffset:s+r;for(let r=0;r<n;r++)Gp(i,a,s,s+1,t+r),a+=6,e<o.latitudeResolution-1&&(Gp(i,a,s+1,t+r+1,t+r),a+=6),s+=l;s=t,l=1}}}(e,t),xp(e)):(function(e){const{numVerticesPerSide:t,indices:i,vertexAttributes:r}=e,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=t-2,l=t-3,h=0,c=t-3;let d=0;for(let u=0;u<l;++u){const e=u*o;for(let t=h;t<c;++t){const r=e+t,s=r+1,l=s+o,h=l-1;zp(r,s,l,h,a,n)?(i[d]=r,i[d+1]=s,i[d+2]=l,i[d+3]=l,i[d+4]=h,i[d+5]=r):(i[d]=r,i[d+1]=s,i[d+2]=h,i[d+3]=h,i[d+4]=s,i[d+5]=l),d+=6}}}(e),function(e,t){const{numVerticesPerSide:i,indices:r,poleIndicesStartIndex:s}=e,n=i-1;let a=s;for(const o of t){const t=o.isNorth?1:2,s=o.isNorth?2:1,l=o.isNorth?3:4,h=o.isNorth?4:3;let c=e.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),d=1;for(let e=0;e<o.latitudeResolution;++e){const u=0===e?o.rowOffset:c+i;for(let i=0;i<n;i++){const n=u+i;r[a]=c,r[a+t]=c+1,r[a+s]=n,e<o.latitudeResolution-1?(r[a+l]=c+1,r[a+h]=n+1,r[a+5]=n,a+=6):a+=3,c+=d}c=u,d=1}}}(e,t),wp(e))}function wp(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,s=i-1,n=s-2;let a=r;for(let o=0;o<4;++o){const i=Fp[o];let r=0,l=0;const h=e.getEdgeCount(o),c=i.count;(0,Nd.GH)(c===s-1);const d=1===o||2===o,u=d?1:2,p=d?2:1,m=e.getEdgeFirstVertexIndex(o),_=1,g=i.vertex0Index,f=i.stride;for(;r<h-1||l<c-1;){const e=g+l*f,i=m+r*_,o=r<h-1,d=l<c-1,y=o&&(!d||(o?0+s*(r+.5)/(h-1):0)<=(d?1+n*(l+.5)/(c-1):0));y?++r:++l;const v=y?i+_:e+f;t[a]=e,t[a+u]=i,t[a+p]=v,a+=3}}e.indexCount=a}function xp(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,s=i-1,n=s-2;let a=r;for(let o=0;o<4;++o){const i=Fp[o];let r=0,l=0;const h=e.getEdgeCount(o),c=i.count;(0,Nd.GH)(c===s-1);const d=1===o||2===o,u=d?1:3,p=d?3:1,m=e.getEdgeFirstVertexIndex(o),_=1,g=i.vertex0Index,f=i.stride;for(;r<h-1||l<c-1;){const e=g+l*f,i=m+r*_,o=r<h-1,d=l<c-1,y=o&&(!d||(o?0+s*(r+.5)/(h-1):0)<=(d?1+n*(l+.5)/(c-1):0));y?++r:++l;const v=y?i+_:e+f;t[a]=e,t[a+u]=i,t[a+u+1]=i,t[a+p]=v,t[a+p+1]=v,t[a+5]=e,a+=6}}e.indexCount=a}function Cp(e){const{geometry:t,geometryState:i}=e,{edgeResolutions:r}=i,{numVerticesPerSide:s,edgeVerticesStartIndex:n}=t,a=s-2;let o=n;for(let l=0;l<4;++l){{const e=0===l||2===l,t=(0===l?a-1:0)*a+(1===l?a-1:0),i=(e?0:1)*a+(e?1:0),r=Fp[l];r.vertex0Index=t,r.stride=i,r.count=a}{const e=r[l]+1;t.outerEdgesOffsetAndLength[2*l+0]=o,t.outerEdgesOffsetAndLength[2*l+1]=e,o+=e}}}function Tp(e){Cp(e),e.geometryState.wireframe?xp(e.geometry):wp(e.geometry)}function Mp(e,t,i){const{geometryState:r,geometry:s,tile:n,localOrigin:a}=e,o=1===t||3===t,l=r.edgeResolutions[t];(0,Nd.GH)((0,de.r6)(l));const h=l+1,{boundingBox:c,minu:d,minv:u,maxu:p,maxv:m,vertexAttributes:_}=s,g=(0,de.qE)(1===t?1:0,d,p),f=(0,de.qE)(0===t?1:0,u,m),y=i.renderData,v=y.geometryState,b=y.geometry,w=(t+2)%4,x=b.getEdgeCount(w),C=n.getNeighborEdgeStartVertexIndex(t,i)*l,T=l*2**(n.level-i.level);(0,Nd.GH)(v.edgeResolutions[w]===T),(0,Nd.GH)(x-1===T);const M=y.localOrigin[0]-a[0],S=y.localOrigin[1]-a[1],R=y.localOrigin[2]-a[2],A=s.getEdgeFirstVertexIndex(t),E=_.position,O=E.typedBuffer,P=E.typedBufferStride,D=_.normalCompressed,I=D.typedBuffer,L=D.typedBufferStride,N=_.uv0,H=b.vertexAttributes,F=b.getEdgeFirstVertexIndex(w),V=H.position.typedBuffer,U=H.position.typedBufferStride,z=H.normalCompressed.typedBuffer,G=H.normalCompressed.typedBufferStride;for(let q=1;q<h-1;++q){const e=A+q,t=F+(C+q),i=e*P,r=t*U,s=V[r]+M,n=V[r+1]+S,a=V[r+2]+R;O[i]=s,O[i+1]=n,O[i+2]=a,Vp(s,n,a,c);const h=e*L,_=t*G;I[h]=z[_],I[h+1]=z[_+1];const y=q/l;hu(N,e,o?g:(0,de.qE)(y,d,p),o?(0,de.qE)(y,u,m):f)}}function Sp(e){const{geometry:t,geometryState:i,localOrigin:r}=e,{clippingArea:s,samplerData:n}=i,{minu:a,minv:o,maxu:l,maxv:h,boundingBox:c,vertexAttributes:d}=t,u=e.tile,{surface:p,ellipsoid:m,extent:_,extentInRadians:g,horizontalScale:f}=u,y="local"===p.view?.viewingMode,v=m.radius;let b=0,w=0,x=0;const C=y?(()=>{const e=s,t=null!=e&&(_[3]>e[3]||_[2]>e[2]||_[1]<e[1]||_[0]<e[0]),i=vp(p.isWebMercatorOnPlateCarree,v,f);return(r,s,n)=>{const a=0===r?_[0]:_[2],o=0===s?_[1]:_[3],l=t?(0,de.qE)(a,e[0],e[2]):a,h=t?(0,de.qE)(o,e[1],e[3]):o,c=n;b=l*f,w=i(h),x=c}})():(e,t,i)=>{const r=g[0===t?1:3],s=g[0===e?0:2],n=Math.cos(r),a=Math.sin(r),o=Math.sin(s),l=Math.cos(s),h=v+i;b=l*n*h,w=o*n*h,x=a*h};let T=0,M=0,S=0,R=0,A=0,E=0,O=0,P=0,D=0;const I=y&&p.isWebMercatorOnPlateCarree,L=(e,t,i,r,s)=>{let n=0,a=0,o=0;if(y){const e=t*f,s=I?(Math.PI/2-2*Math.atan(Math.exp(-i/v)))*v:i*f;n=e-b,a=s-w,o=r-x}else{const s=mp(e),l=e.tile,h=l.extent,c=l.extentInRadians,d=(t-h[0])/(h[2]-h[0]),u=(i-h[1])/(h[3]-h[1]),p=c[0]*(1-d)+c[2]*d,m=s(u),_=Math.cos(m),g=Math.sin(m),f=Math.sin(p),y=Math.cos(p),C=v+r;n=y*_*C-b,a=f*_*C-w,o=g*C-x}switch(s){case 0:O+=n,P+=a,D+=o;break;case 1:R-=n,A-=a,E-=o;break;case 2:O-=n,P-=a,D-=o;break;case 3:R+=n,A+=a,E+=o}},N=s??Ip,H=_[0],F=_[2],V=_[1],U=_[3],z=[U>N[3],F>N[2],V<N[1],H<N[0]],G=Math.max(H,N[0]),q=Math.min(F,N[2]),k=Math.max(V,N[1]),B=Math.min(U,N[3]),W=e=>Math.max(N[0],Math.min(N[2],e)),Z=e=>Math.max(N[1],Math.min(N[3],e)),j=e=>{const t=i.cornerNeighborCornerTiles;T=0,M=0,S=1,R=0,A=0,E=0,O=0,P=0,D=0;let r=1/0;for(let i=0;i<4;++i){const s=t[4*e+i];r=Math.min(r,s?.level??1/0)}for(let i=0;i<4;++i){const s=t[4*e+i];Lp[i]=s?.level===r?s:null}let s=1,n=0;for(let i=0;i<4;++i){const e=Lp[i];e&&(s=Math.max(s,e?.renderData.geometryState.numVerticesPerSide),n=e.extent[2]-e.extent[0])}const a=n,o=s;(0,Nd.GH)(o>1);const l=a/o;for(let i=0;i<4;++i){const e=Lp[(i+3)%4],t=Lp[i%4];if(!e&&!t)continue;const r=0===i?1:1===i?2:2===i?3:0,s=0===i?2:1===i?3:2===i?0:1;if(e&&t){const n=Pp[i][0]*l,a=Pp[i][1]*l,o=e.extent,h=W(o[0===r||1===r?2:0]+n),c=Z(o[0===r||3===r?3:1]+a),d=t.extent,u=W(d[0===s||1===s?2:0]+n),p=Z(d[0===s||3===s?3:1]+a),m=e.renderData,_=t.renderData,g=Ld(h,c,m.geometryState.samplerData),f=Ld(u,p,_.geometryState.samplerData);L(m,h,c,.5*(g+f),i)}else{const n=e??t,a=e?r:s,o=n.extent,h=Pp[i],c=W(o[0===a||1===a?2:0]+h[0]*l),d=Z(o[0===a||3===a?3:1]+h[1]*l),u=n.renderData,p=Ld(c,d,u.geometryState.samplerData);L(u,c,d,p,i)}}if(!y){const e=Math.sqrt(b*b+w*w+x*x);T=b/e,M=w/e,S=x/e}if(y||S*S<.999){const e=Math.sqrt(R*R+A*A+E*E);R/=e,A/=e,E/=e;const t=Math.sqrt(O*O+P*P+D*D);O/=t,P/=t,D/=t,T=E*P-A*D,M=R*D-E*O,S=A*O-R*P;const i=1/Math.sqrt(T*T+M*M+S*S);T*=i,M*=i,S*=i}},$=i.cornerNeighborCornerTiles;for(let Q=0;Q<4;++Q){const e=Q,s=(Q+1)%4,p=0===Q||1===Q?1:0,m=0===Q||3===Q?1:0,_=(0,de.qE)(p,a,l),g=(0,de.qE)(m,o,h),f=t.getEdgeFirstVertexIndex(e),y=t.getEdgeCount(e),v=0===Q||3===Q?y-1:0,R=t.getEdgeFirstVertexIndex(s),A=t.getEdgeCount(s),E=0===Q||1===Q?A-1:0;let O=-1;for(let t=0;t<4;++t){const e=$[4*Q+t],i=$[4*Q+O];e&&(-1===O||(0,_u.lR)(i,e)>0)&&(O=t)}const P=O,D=$[4*Q+P];if(D!==u){const e=u.level-D.level,t=2**e,s=[D.lij[0]+e,D.lij[1]*t,D.lij[2]*t],n=[s[1]+t===u.lij[1],0===Q&&(1===P||0===P&&D!==$[4*Q+3])||1===Q&&(0===P||1===P&&D!==$[4*Q+2]),s[1]===u.lij[1]+1,2===Q&&(3===P||2===P&&D!==$[4*Q+1])||3===Q&&(2===P||3===P&&D!==$[4*Q+0])],a=n.reduce(((e,t)=>e+(t?1:0)),0);(0,Nd.GH)(1===a||2===a);let o=-1,l=-1;const h=D.renderData;if(1===a){const e=n.findIndex((e=>e));(0,Nd.GH)(0<=e&&e<=3),o=(e+2)%4;const t=i.edgeResolutions[e];l=u.getNeighborEdgeStartVertexIndex(e,D)*t+t*(0===e&&0===Q||1===e&&0===Q||2===e&&1===Q||3===e&&3===Q?1:0)}else{(0,Nd.GH)(n[1]||n[3]),o=n[1]?3:1;const e=h.geometryState.edgeResolutions[o];l=0===Q||3===Q?0:e}const p=h.geometry;{const e=f+v,t=R+E,i=p.getEdgeFirstVertexIndex(o)+l,s=p.vertexAttributes,n=h.localOrigin;{const a=s.position,o=a.typedBuffer,l=i*a.typedBufferStride,h=o[l]+n[0]-r[0],u=o[l+1]+n[1]-r[1],p=o[l+2]+n[2]-r[2];Vp(h,u,p,c);const m=d.position,_=m.typedBuffer;{const t=e*m.typedBufferStride;_[t]=h,_[t+1]=u,_[t+2]=p}{const e=t*m.typedBufferStride;_[e]=h,_[e+1]=u,_[e+2]=p}}const a=d.uv0;hu(a,e,_,g),hu(a,t,_,g);{const r=s.normalCompressed.typedBuffer,n=i*s.normalCompressed.typedBufferStride,a=d.normalCompressed,o=a.typedBuffer;{const t=e*a.typedBufferStride;o[t]=r[n],o[t+1]=r[n+1]}{const e=t*a.typedBufferStride;o[e]=r[n],o[e+1]=r[n+1]}}}}else{let i;if(z[e]||z[s]){i=Ld((0,de.qE)(H*(1-p)+F*p,G,q),(0,de.qE)(V*(1-m)+U*m,k,B),n)}else i=Rp($,Q);C(p,m,i),j(Q);const a=b-r[0],o=w-r[1],l=x-r[2];Vp(a,o,l,c),t.setEdgeVertexFromValuesRawPositionUVNormal(e,v,a,o,l,_,g,T,M,S),t.setEdgeVertexFromValuesRawPositionUVNormal(s,E,a,o,l,_,g,T,M,S)}}for(let Q=0;Q<4;++Q)Lp[Q]=null}function Rp(e,t){const i=4*t,r=Vu.reduce(((t,r)=>Math.min(t,e[i+r]?.level??1/0)),1/0);Nd.L8&&((0,Nd.GH)(!e[i+0]||!e[i+2]||ip(e[i+0],e[i+2],nu.N.SOUTH_WEST)),(0,Nd.GH)(!e[i+1]||!e[i+3]||ip(e[i+1],e[i+3],nu.N.NORTH_WEST)));let s=0,n=0;for(let o=0;o<4;++o){const t=e[i+o];if(t&&t.level===r){const e=0===o||1===o,i=0===o||3===o,r=t.extent,a=r[e?0:2],l=r[i?1:3],h=t.renderData?.geometryState?.samplerData;n+=Ld(a,l,h),s++}}const a=s?n/s:0;return(0,Nd.GH)(null!=a),a}function Ap(e){const{vao:t,geometry:i}=e,{vertexAttributes:r,edgeVerticesStartIndex:s}=i,n=r.position.typedBuffer;t.vertexBuffers.get("geometry").setSubData(n,s,s,n.length)}function Ep(e){const{vao:t,geometry:i}=e,{indices:r,indexCount:s,edgeIndicesStartIndex:n}=i;t.indexBuffer.setSubData(r,n,n,s)}class Op{constructor(e,t,i,r,s){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=i,this.rowOffset=r,this.latitudeResolution=s}}const Pp=[[0,1],[1,0],[0,-1],[-1,0]],Dp=new class{constructor(){this.sinLonLUT=new Array(Pd.Me+1),this.cosLonLUT=new Array(Pd.Me+1),this.sinLatLUT=new Array(Pd.Me+1),this.cosLatLUT=new Array(Pd.Me+1)}update(e,t,i){const r=t[0],s=t[2];for(let n=0;n<=e;n++){const t=n/e,a=r*(1-t)+s*t;this.sinLonLUT[n]=Math.sin(a),this.cosLonLUT[n]=Math.cos(a);const o=i(t);this.sinLatLUT[n]=Math.sin(o),this.cosLatLUT[n]=Math.cos(o)}}},Ip=(0,V.fA)(-1/0,-1/0,1/0,1/0),Lp=[null,null,null,null];function Np(e,t,i){if(!t)return!1;const r=(0,_u.lR)(e,t);return r>0||0===r&&i>=2}class Hp{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return(0,Nd.GH)(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const Fp=[new Hp,new Hp,new Hp,new Hp];function Vp(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}function Up(e){const{edgeResolutions:t,numVerticesPerSide:i}=e,r=1+Math.max(...t);return Math.max(i,r)}function zp(e,t,i,r,s,n){const a=e*s,o=n[a],l=n[a+1],h=n[a+2],c=t*s,d=n[c],u=n[c+1],p=n[c+2],m=i*s,_=n[m],g=n[m+1],f=n[m+2],y=r*s,v=n[y],b=n[y+1],w=n[y+2];return(d-v)*(d-v)+(u-b)*(u-b)+(p-w)*(p-w)>(o-_)*(o-_)+(l-g)*(l-g)+(h-f)*(h-f)}function Gp(e,t,i,r,s){e[t]=i,e[t+1]=r,e[t+2]=r,e[t+3]=s,e[t+4]=s,e[t+5]=i}const qp=6;var kp=i(30051);class Bp extends ju{constructor(e,t,i,r,s){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=(0,V.vt)(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,i,r,s)}init(e,t,i,r,s){super.init(e,t,i,r,s);const n=s.view.renderSpatialReference,a=s.spatialReference,o=null!=n&&(0,Re.r1)(n)&&null!=a&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const{isWebMercatorOnPlateCarree:l}=s,h=this._extentInRenderSR,c=this.extent;if(l){const e=(0,E.fA)(c[0],c[1],0);(0,Md.F)(e,N.default.WebMercator,e,N.default.PlateCarree);const t=(0,E.fA)(c[2],c[3],0);(0,Md.F)(t,N.default.WebMercator,t,N.default.PlateCarree),h[0]=e[0],h[1]=e[1],h[2]=t[0],h[3]=t[1]}else for(let d=0;d<4;++d)h[d]=c[d]*o;this.centerAtSeaLevel[0]=.5*(h[0]+h[2]),this.centerAtSeaLevel[1]=.5*(h[1]+h[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(h[2]-h[0],h[3]-h[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),s=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(r,s);this._center[Ju.MIDDLE][3]=n}_calculateFrustumVisibility(e){const t=this._aabb(),i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5];let l=!0;for(let h=0;h<6;h++){const t=e[h],c=t[0],d=t[1],u=t[2],p=t[3];if(c*(c>0?i:n)+d*(d>0?r:a)+u*(u>0?s:o)+p>=0)return qu.OUTSIDE;l=l&&c*(c<0?i:n)+d*(d<0?r:a)+u*(u<0?s:o)+p<=0}return l?qu.INSIDE:qu.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return(0,su.LV)(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,i,r){return Wp[0]=1/t[0],Wp[1]=1/t[1],Wp[2]=1/t[2],(0,kp.d2)(this._aabb(),e,Wp,i,r)}createGeometry(){_p(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,i=this.renderData;let r=e,s=t;if(i){const e=i.geometry.boundingBox;r=e[2],s=e[5]}else if(!this.leaf){r=1/0,s=-1/0;for(const e of this.children){const t=e;r=Math.min(r,t._subtreeGeometryElevationBoundMin),s=Math.max(s,t._subtreeGeometryElevationBoundMax)}}if(r!==this._subtreeGeometryElevationBoundMin||s!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=s;const e=this.parent;e?._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){(function(e){e.tile.intersectsClippingArea&&(yp(e),fp(e,!0),Ap(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){(function(e){e.tile.intersectsClippingArea&&(gp(e),Ap(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){(function(e){e.tile.intersectsClippingArea&&(Tp(e),gp(e),Ap(e),Ep(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}}const Wp=(0,E.vt)();var Zp=i(48572);class jp{constructor(){this.extent=(0,js.vt)(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let $p=class extends M.default{constructor(){super(...arguments),this._queries=new oo.A({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new oo.A({initialSize:30}),this._queryPool=new Td.A(jp)}queryVisibleLevelRange(e,t,i,r){const s=this._queryPool.acquire();(0,Zs.c)(s.extent,e),s.minLevel=t??-Number.MAX_VALUE,s.maxLevel=i??Number.MAX_VALUE,s.callback=r,this._queryQueue.push(s),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],s=r.extent;t>=r.minLevel&&t<=r.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};(0,r._)([(0,w.MZ)()],$p.prototype,"updating",null),$p=(0,r._)([(0,C.$)("esri.views.3d.terrain.ScaleRangeQueries")],$p);var Qp=i(66028);class Yp extends ju{constructor(e,t,i,r,s){super(),this._convexHull=new Array(24),this._boundingSphere=(0,Kt.c)(),this._baseUsedMemory=1816,this.init(e,t,i,r,s)}init(e,t,i,r,s){super.init(e,t,i,r,s);const n=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],l=this.extentInRadians[2],h=this.extentInRadians[3],c=(0,de.Cc)(o,h,.5),d=(0,de.Cc)(a,l,.5),u=0===e?0:Math.min(Math.abs(o),Math.abs(h));this._edgeLen=(l-a)*Math.cos(u)*n,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=n-Math.sqrt(n*n-this._edgeLen2/4),function(e,t,i,r){const s=Math.cos(i);e[0]=Math.cos(t)*s*r,e[1]=Math.sin(t)*s*r,e[2]=Math.sin(i)*r}(this.centerAtSeaLevel,d,c,this.ellipsoid.radius),(0,Me.n)(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])(0,Me.i)((0,Kt.a)(e[Ju.MIDDLE]),0,0,0),(0,Me.i)(e[Ju.TOP],0,0,0),(0,Me.i)(e[Ju.BOTTOM],0,0,0),e[Ju.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[Ju.MIDDLE],i=this.convexHull;let r=0;for(let e=0;e<8;++e)r=Math.max(r,Kp((0,Kt.a)(t),i,3*e));e[Ju.MIDDLE][3]=Math.sqrt(r)}}_calculateFrustumVisibility(e){if(!(0,el.m7)(e,this._boundingSphere))return qu.OUTSIDE;if(this.lij[0]<10)return qu.INTERSECTS;const t=this.convexHull,i=this.surface.view.state.camera.near;let r=!0;for(let s=0;s<el.YH;s++){const n=s===el.FB.NEAR,a=e[s],o=a[0],l=a[1],h=a[2],c=a[3]-(n?i:0);let d=!1;for(let e=0;e<8;++e){const i=3*e;if(o*t[i]+l*t[i+1]+h*t[i+2]+c<0){if(d=!0,!r)break}else r=!1}if(!d)return qu.OUTSIDE}return r?qu.INSIDE:qu.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){hp(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),Nd.L8&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=(0,Kt.a)(e),i=this.elevationBoundsMin,r=this.elevationBoundsMax,s=this.ellipsoid.radius,n=r;if(0===this.level)(0,Me.i)(t,0,0,0),e[3]=s+n;else{const n=this.extentInRadians,a=.5*(n[0]+n[2]),o=n[1],l=n[3];em(im,a,o,s),em(rm,a,l,s),(0,Me.g)(t,im,rm),(0,Me.h)(t,t,(s+.5*(i+r))/(0,Me.H)(t));const h=this.convexHull;let c=0;const d=(e,t)=>{const i=e[0]-h[3*t],r=e[1]-h[3*t+1],s=e[2]-h[3*t+2];return Math.sqrt(i*i+r*r+s*s)};for(let e=0;e<8;++e){const i=d(t,e);c=Math.max(c,i)}const u=c;e[3]=u+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const i=this.elevationBoundsMin,r=this.elevationBoundsMax,s=this._getPatchType(),n=this.surface.isWebMercator,a=n&&s===zd.JG.HAS_NORTH_POLE,o=n&&s===zd.JG.HAS_SOUTH_POLE,l=o||a,h=Math.PI/2,c=e[0],d=e[2],u=o?-h:e[1],p=a?h:e[3],m=.5*(c+d),_=i,g=t+(l?Math.min(0,_-1):_),f=(e,t,i)=>em(e,t,i,g),y=(0,E.vt)(),v=(0,E.vt)(),b=(0,E.vt)(),w=(0,E.vt)();f(y,c,u),f(v,c,p),f(b,d,p),f(w,d,u);const x=(e,t)=>{for(let i=0;i<3;++i)this._convexHull[3*t+i]=e[i]};x(y,0),x(v,1),x(b,2),x(w,3);const C=r,T=t+(l?Math.max(0,C+1):C),M=(0,E.vt)(),S=(0,E.vt)(),R=(0,E.vt)();em(S,m,p,g),em(R,m,u,g),(0,Me.g)(M,S,R),(0,Me.n)(M,M);const A=(0,E.vt)(),O=(0,E.vt)(),P=(e,t)=>{(0,Me.a)(O,e,t),(0,Me.n)(O,O);const i=-(0,Me.f)(e,A)/(0,Me.f)(O,A);(0,Nd.GH)(i>=0),(0,Me.h)(O,O,i),(0,Me.g)(e,e,O)};if(2**this.lij[0]>2*this.lij[1]){const e=R,t=(0,E.vt)();(0,Me.e)(t,tm,e),(0,Me.n)(t,t),(0,Me.e)(A,e,t),(0,Me.n)(A,A),(0,Nd.GH)((0,Nd.yL)((0,Me.f)(A,e)/(0,Me.H)(e),0)),P(y,v),P(w,b),x(y,0),x(w,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=S,t=(0,E.vt)();(0,Me.e)(t,tm,e),(0,Me.n)(t,t),(0,Me.e)(A,t,e),(0,Me.n)(A,A),P(v,y),P(b,w),x(v,1),x(b,2)}const D=(e,t)=>{const i=T/(0,Me.f)(t,M);for(let r=0;r<3;++r)this._convexHull[3*e+r]=t[r]*i};D(4,y),D(5,v),D(6,b),D(7,w)}_getPatchType(){const e=this.lij[1],t=0===e,i=e===(1<<this.level)-1;return t?i?zd.JG.HAS_BOTH_POLES:zd.JG.HAS_NORTH_POLE:i?zd.JG.HAS_SOUTH_POLE:zd.JG.REGULAR}intersectsRay(e,t,i,r){const s=this._boundingSphere,n=s[3]+i,a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=s[0]-e[0],l=s[1]-e[1],h=s[2]-e[2],c=(o*t[0]+l*t[1]+h*t[2])/a,d=t[0]*c-o,u=t[1]*c-l,p=t[2]*c-h;return d*d+u*u+p*p<n*n}get minimumVerticesPerSide(){return this.level<Xp.length?Xp[this.level]+1:2}updateCornerElevations(){(function(e){e.tile.intersectsClippingArea&&(up(e),dp(e,!0),Ap(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){(function(e){e.tile.intersectsClippingArea&&(cp(e),Ap(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){(function(e){e.tile.intersectsClippingArea&&(Tp(e),cp(e),Ap(e),Ep(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!Nd.L8)return;if(this.level<=2)return;const e=this._boundingSphere,t=e[3],i=(0,Kt.a)(e),r=(0,E.vt)(),s=this.ellipsoid.radius,n=this.elevationBoundsMin,a=this.elevationBoundsMax,o=s+n,l=this._center[Ju.MIDDLE][3],h=this.convexHull,c=(e,t)=>{for(let i=0;i<3;++i)e[i]=h[3*t+i]};{const e=(0,E.vt)(),t=(0,E.vt)(),i=(0,E.vt)(),r=(0,E.vt)(),s=(0,E.vt)(),n=(n,a,o,l)=>{c(t,n),c(i,a),c(r,o),(0,Me.a)(t,t,i),(0,Me.a)(r,r,i),(0,Me.e)(e,t,r),(0,Me.n)(e,e);const h=(0,Me.f)(e,i);c(s,l);const d=(0,Me.f)(e,s),u=Math.abs(d-h);(0,Nd.GH)((0,Nd.yL)(u,0),`Non coplanar ${n},${a},${o},${l} diff = ${u}`)};n(0,1,2,3),n(4,5,6,7),n(0,1,4,5),n(1,2,5,6),n(2,3,6,7),n(3,0,7,4)}const d=(0,Qp.jh)(24),u=(0,E.vt)(),p=(0,E.vt)(),m=(0,E.vt)(),_=(0,E.vt)(),g=(e,t,i,r)=>{c(u,t),c(p,i),c(m,r),(0,Me.a)(u,u,p),(0,Me.n)(u,u),(0,Me.a)(m,m,p),(0,Me.n)(m,m),(0,Me.e)(_,u,m),(0,Me.n)(_,_);const s=(0,Me.f)(_,p);((e,t,i)=>{const r=4*e;for(let s=0;s<3;++s)d[r+s]=t[s];d[r+3]=i})(e,_,s)};g(0,0,1,2),g(1,1,0,4),g(2,1,5,2),g(3,3,2,6),g(4,4,0,3),g(5,4,6,5);const f=(e,t,i,r)=>{const s=4*e;return d[s]*t+d[s+1]*i+d[s+2]*r-d[s+3]},y=(e,t,i,r)=>f(e,t,i,r)>=-1,v=(e,t)=>y(e,t[0],t[1],t[2]),b=2**this.lij[0]>2*this.lij[1],w=(e,r,s)=>Math.sqrt(Jp(e,r,s,i[0],i[1],i[2]))<t,x=e=>w(e[0],e[1],e[2]),C=(e,t)=>w(e[t],e[t+1],e[t+2]),T=this.extentInRadians,M=.5*(T[0]+T[2]),S=T[1],R=T[3],A=(0,E.vt)(),O=(0,E.vt)();em(A,M,R,o),em(O,M,S,o);const P=b?"Upper":"Lower";let D=!0;for(let E=0;E<6;++E){for(let e=0;e<8;++e){const t=3*e,i=y(E,h[t],h[t+1],h[t+2]);D&&=i,(0,Nd.GH)(i,`Tile[${this.lij}] Convex hull point ${e} outside of plane ${E}`)}(0,Nd.GH)(v(E,O),`Tile[${this.lij}] (${P}) bottom mid outside of plane ${E}`),(0,Nd.GH)(v(E,A),`Tile[${this.lij}] (${P}) top mid outside of plane ${E}`)}(0,Nd.GH)(D,"Not all convex hull points are inside  convex hull polyhedron"),(0,Nd.GH)(x(O),`Tile[${this.lij}] (${P}) bottom mid outside of bounding sphere`),(0,Nd.GH)(x(A),`Tile[${this.lij}] (${P}) top mid outside of bounding sphere`);for(let E=0;E<8;++E){const e=C(h,3*E);(0,Nd.GH)(e,`Tile[${this.lij}] Convex hull point ${E} outside of bounding sphere`)}for(let E=0;E<6;++E)for(let e=0;e<8;++e){const t=3*e;y(E,h[t],h[t+1],h[t+2])||console.error(`Tile[${this.lij}] Convex hull point ${e} outside of plane ${E}`)}const{extentInRadians:I}=this,L=Math.max(I[2]-I[0],I[3]-I[1]),N=Math.round(L*s),{renderData:H}=this;if(!H)return;const{geometry:F,geometryState:V,localOrigin:U}=H,z=F.vertexAttributes?.position;if(!z)return;const G=(0,E.vt)(),q=F.numVerticesPerSide-2,{indices:k,indexCount:B,edgeVerticesStartIndex:W,poleVerticesStartIndex:Z}=F;if(!k)return;const j=new Set;for(let E=0;E<B;++E){const e=k[E];if(j.has(e))continue;j.add(e);const o=e<Z,h=e>=W;let c=!1,d=-1;if(h){let t=W;for(let i=0;i<4;++i){const r=V.edgeResolutions[i];if(e===t||e===t+r-1){c=!0;break}if(t+=r,e<t){d=i;break}}}const u=h?V.edgePeerNeighbors[d]:null,p=h&&u&&(0,_u.lR)(this,u)>0;z.getVec(e,r),(0,Me.g)(G,r,U);const m=(0,Me.H)(G)-s;let _=0,g=!1;const v=n-m,b=m-a,w=v>1,x=b>1,C=w||x,T=()=>{const t=o?"internal":h&&!c?"edge":c?"corner":"pole";return`Tile[${this.lij}].vertex[${e}]:${t}`+(w?"(below)":x?"(above)":"")+(p?"(Neighbor)":"")},M=(0,Me.G)(G,i);if(M>=t+0){const e=M-t;C||(console.error(`${T()} is out of the bounding sphere by ${e.toFixed(0)} / ${t.toFixed(0)}[tol=0] h=${m.toFixed(0)} / [${n.toFixed(0)}..${a.toFixed(0)}] (${(e/t).toFixed(0)})`),g=!0)}for(let i=0;i<6;++i)if(!y(i,G[0],G[1],G[2])){const r=f(i,G[0],G[1],G[2]),s=e%q,o=(e-s)/q;0===i&&v||5===i&&b||(console.error(`${T()} (${s},${o})|${q}] is out of the bounding trapezoid plane ${i} h=${Math.round(m)} / [${Math.round(n)}..${Math.round(a)}] dist=${Math.round(r)} radii = ${Math.round(t)}/${Math.round(l)}} : maxL = ${N}`),++_)}if(g||_>0)break}}get convexHull(){return this._convexHull}}const Xp=[128,64,64,32,16,8,8,4];function Kp(e,t,i){return Jp(e[0],e[1],e[2],t[i],t[i+1],t[i+2])}function Jp(e,t,i,r,s,n){const a=r-e,o=s-t,l=n-i;return a*a+o*o+l*l}const em=(e,t,i,r)=>{const s=Math.cos(t),n=Math.sin(t),a=Math.cos(i),o=Math.sin(i);e[0]=r*a*s,e[1]=r*a*n,e[2]=r*o},tm=[0,0,1],im=(0,E.vt)(),rm=(0,E.vt)();let sm=class extends M.default{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};(0,r._)([(0,w.MZ)()],sm.prototype,"fovX",void 0),(0,r._)([(0,w.MZ)()],sm.prototype,"fovY",void 0),(0,r._)([(0,w.MZ)()],sm.prototype,"relativeWidthLimit",void 0),(0,r._)([(0,w.MZ)()],sm.prototype,"relativeHeightLimit",void 0),(0,r._)([(0,w.MZ)()],sm.prototype,"maxLod",void 0),(0,r._)([(0,w.MZ)()],sm.prototype,"angledSplitBias",void 0),(0,r._)([(0,w.MZ)()],sm.prototype,"aboveGround",void 0),(0,r._)([(0,w.MZ)()],sm.prototype,"frustum",void 0),sm=(0,r._)([(0,C.$)("esri.views.3d.terrain.SplitLimits")],sm);var nm=i(76517),am=i(73803);const om=(0,yt.BP)().vec3f(ut.r.POSITION).vec2i16(ut.r.UV0).vec2i16(ut.r.NORMALCOMPRESSED,{glNormalized:!0});class lm{constructor(e){this._storage=new xd(((t,i)=>e.newCache(t,i)),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,r=function(e){return e.toString()}(t),s=i.pop(r);if(s)return s;const n=om.createBuffer(t);return n.release=()=>i.put(r,n),n}clear(){this._storage.clear()}destroy(){this._storage.destroy()}}var hm=i(57197),cm=i(59963);class dm extends hm.J{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=E.uY}}class um extends We.w{constructor(e,t){super(e,t,new Be.$(cm.B,(()=>i.e(25190).then(i.bind(i,25190)))))}}var pm=i(73795),mm=i(12147),_m=(i(60529),i(83652)),gm=(i(47116),i(95476),i(27510)),fm=i(63831),ym=i(55736),vm=i(79381),bm=i(52188),wm=i(88636),xm=i(7835);const Cm=(0,gm.vt)();var Tm=i(61642),Mm=i(563);class Sm{constructor(){this._renderParams={reshuffleManager:new Mm.E,context:null,drawPhase:1,state:new Rm,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new Tm.V(new _m.A(0,0,0,0),0,0,0,512,512,4096,4096),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,i,r,s,n,a,o,l,h){const c=this._backgroundTile;this._updateRenderParameters(e,t,c,i,s,n,a,o,l,h),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,c,r)}renderContent(e,t,i,r,s,n,a,o,l,h,c,d){this._declutter(i),r.forAll((e=>{let{sourceLayerInfo:{data:t}}=e;return this._declutter(t)}));const u=r.length>0;u&&this._stencilSymbols(e,t,i,r,s,n,a,o,l,h,c,d);let p=1;i.stencilRef=u?p:0,e.setStencilFunction(Ze.MT.EQUAL,i.stencilRef,255),this._render(e,t,i,s,n,a,o,l,h,c,d),r.forAll((t=>{let{sourceLod:i,offset:r,sourceLayerInfo:{data:l}}=t;l.stencilRef=++p,this._renderSymbols(e,i,l,s,n,a,o,r,h,c,d)}))}_stencilSymbols(e,t,i,r,s,n,a,o,l,h,c,d){let u=1;i.stencilRef=u,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(Ze.eA.KEEP,Ze.eA.KEEP,Ze.eA.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(Ze.MT.ALWAYS,i.stencilRef,255),this._stencilTileSymbols(e,t,i,s,n,a,o,l,h,c,d),r.forAll((t=>{let{sourceLod:i,offset:r,sourceLayerInfo:{data:l}}=t;l.stencilRef=++u,e.setStencilFunction(Ze.MT.ALWAYS,l.stencilRef,255),this._stencilTileSymbols(e,i,l,s,n,a,o,r,h,c,d)})),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,r,s,n,a,o,l,h,c){e.setStencilFunction(Ze.MT.EQUAL,i.stencilRef,255),this._render(e,t,i,r,s,n,a,o,l,h,c,xm.Dc.SYMBOL)}_render(e,t,i,r,s,n,a,o,l,h,c,d){this._updateRenderParameters(e,t,i,r,n,a,o,l,h,c),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,i,s,d)}_stencilTileSymbols(e,t,i,r,s,n,a,o,l,h,c){this._updateRenderParameters(e,t,i,r,n,a,o,l,h,c),this._renderParams.stencilSymbols=!0,i.triangleCount=0,r.drawSymbols(this._renderParams,i,s)}_updateRenderParameters(e,t,i,r,s,n,a,o,l,h){"type"in i&&"vector-tile"===i.type&&!i.stage&&i.attachWithContext(e);const c=t[0]-s.getLevelShift(t[0]),d=this._renderParams;d.context=e,d.painter=r,d.glyphMosaic=r.glyphMosaic,d.spriteMosaic=r.spriteMosaic,d.pixelRatio=l*h,d.displayLevel=c,d.requiredLevel=c;const u=s.getScale(t[0]),[p,m]=s.getOffset(t,n*u),_=.125*n*u/o,g=i.transforms.displayViewScreenMat3;g[0]=_,g[4]=-_,g[6]=-1-p-a[0]*n*2,g[7]=1+m+(1-a[1])*n*2-2;const f=d.state,y=o/h;f.size[0]=y,f.size[1]=y,f.pixelRatio=h,f.rotation=(360-this._heading)%360;const v=2/y;(0,Fe.hZ)(f.displayViewMat3,v,0,0,0,-v,0,-1,1,1);const b=(0,Fe.D_)(f.displayMat3),w=(0,mm.DF)(this._heading);(0,Fe.Tl)(b,b,[y/2,y/2]),(0,Fe.e$)(b,b,w),(0,Fe.Tl)(b,b,[-y/2,-y/2]),(0,Fe.lw)(b,f.displayViewMat3,b)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(function(e,t){const i=e.transforms.tileUnitsToPixels,r=(0,mm.DF)(t),s=Math.cos(r),n=Math.sin(r),a=Math.ceil(512*(Math.abs(n)+Math.abs(s)));(0,Fe.D_)(Cm),(0,Fe.Tl)(Cm,Cm,[a/2,a/2]),(0,Fe.e$)(Cm,Cm,r),(0,Fe.Tl)(Cm,Cm,[-256,-256]),(0,Fe.hs)(Cm,Cm,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=Cm;const o=[],l=new bm.t(4096,o,(()=>new fm.S)),h=new vm.q(o,l,((i,r,s)=>new ym.s(i,r,s,e.styleRepository,e.key.level,t)),((e,t)=>{(0,wm.jy)(e,t,!1)}),(()=>0),(t=>{const i=e.styleRepository.getStyleLayerByUID(t).getLayoutProperty("visibility");return!i||i.getValue()!==xm.bv.NONE}));o.push(e),l.add(e),h.setScreenSize(a,a),h.continue(1/0),l.removeTile(e),e.transforms.tileUnitsToPixels=i}(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}}class Rm{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=(0,ki.vt)(),this.displayViewMat3=(0,ki.vt)(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}}var Am=i(45979),Em=i(21484);class Om extends Em.K{constructor(){super(...arguments),this.blendMode=Am.IU.Normal}}(0,r._)([(0,Em.W)({count:Am.IU.COUNT})],Om.prototype,"blendMode",void 0);var Pm=i(23193),Dm=i(65180),Im=i(2799);class Lm extends Om{constructor(){super(...arguments),this.output=Dm.x.Composite,this.baseOpacityMode=Pm.Q.NotRequired,this.premultipliedSource=Im.g.Off}}(0,r._)([(0,Em.W)({count:Dm.x.COUNT})],Lm.prototype,"output",void 0),(0,r._)([(0,Em.W)({count:Pm.Q.COUNT})],Lm.prototype,"baseOpacityMode",void 0),(0,r._)([(0,Em.W)({count:Im.g.COUNT})],Lm.prototype,"premultipliedSource",void 0);class Nm extends Lm{constructor(){super(...arguments),this.background=cm.a.BelowLayer}}(0,r._)([(0,Em.W)({count:cm.a.COUNT})],Nm.prototype,"background",void 0);var Hm=i(19752);class Fm extends We.w{constructor(e,t){super(e,t,new Be.$(Hm.R,(()=>i.e(32666).then(i.bind(i,32666)))))}}class Vm extends Lm{constructor(){super(...arguments),this.colorizerType=pm.T.Stretch,this.stretchType=pm.M.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}}(0,r._)([(0,Em.W)({count:pm.T.COUNT})],Vm.prototype,"colorizerType",void 0),(0,r._)([(0,Em.W)({count:pm.M.COUNT})],Vm.prototype,"stretchType",void 0),(0,r._)([(0,Em.W)()],Vm.prototype,"applyColormap",void 0),(0,r._)([(0,Em.W)()],Vm.prototype,"requireBilinearWithNN",void 0);var Um=i(30179);class zm{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach((e=>e.dispose())),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new Je.H(this._rctx,new et.R(e),new Um.q(Ze.yQ.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}}var Gm=i(97626),qm=i(16665),km=i(64177);class Bm{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new Sm,this._bindParameters=new Gm.k(null),this._blendLayersTechniqueConfig=new Nm,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=(0,qm.Q7)(this._rctx,qm.PE.Pos2Tex)}dispose(){this._fbos.forEach(p.WD),this._fbos=null,this._vtFBO=(0,p.WD)(this._vtFBO),this._vaoQuad=(0,p.WD)(this._vaoQuad),this._vectorTileHelper=(0,p.WD)(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendLayersTechnique(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Im.g.Off,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:cm.a.BelowLayer;return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=r,this._blendLayersTechniqueConfig.background=s,this._techniques.precompile(um,this._blendLayersTechniqueConfig),this._techniques.get(um,this._blendLayersTechniqueConfig)}drawBackground(e,t){const i=this._acquireBlendLayersTechnique(Am.IU.Normal,t?Dm.x.ColorComposite:Dm.x.GridComposite,Pm.Q.NotRequired,Im.g.Off,cm.a.Only),r=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(r)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Ze.WR.TRIANGLE_STRIP,0,(0,Ct.mT)(this._vaoQuad,"geometry"))}drawGroup(e,t,i,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Im.g.On;t===Dm.x.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const n=e.baseOpacity<1?Pm.Q.Required:Pm.Q.NotRequired,a=this._acquireBlendLayersTechnique(r,t,n,s),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawImageData(e,t,i,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Im.g.Off;if(null==e.texture)return;const n=e.baseOpacity<1?Pm.Q.Required:Pm.Q.NotRequired;e.fboTexture=t===Dm.x.GroupBackgroundComposite||r===Am.IU.Normal&&n===Pm.Q.NotRequired&&s===Im.g.Off?null:this.switch(i).colorTexture;const a=this._acquireBlendLayersTechnique(r,t,n,s),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawRasterData(e,t,i,r,s){const n=s.sourceLayerInfo.data;if(!n.source)return;if(s.tile.surface.layerViewByIndex(s.layerIndex,jh.MAP).ensureSymbolizerParameters(n),!n.bind(this._rctx))return;const a=e.baseOpacity<1?Pm.Q.Required:Pm.Q.NotRequired;e.fboTexture=r===Am.IU.Normal&&a===Pm.Q.NotRequired?null:this.switch(i).colorTexture;const o=this._acquireRasterColorizerTechnique(n,t,r,a);n.opacity=e.opacity;const l=n.getUniforms();l.scale=s.scale,l.offset=s.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(o,this._bindParameters,l);this._render(h)}_acquireRasterColorizerTechnique(e,t,i,r){const s=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(s.type);return null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new Vm,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=r,this._rasterColorizerConfig.colorizerType=n,this._rasterColorizerConfig.applyColormap=!!s.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?pm.M.Noop:pm.M.PerBand,this._techniques.precompile(Fm,this._rasterColorizerConfig),this._techniques.get(Fm,this._rasterColorizerConfig)}drawVectorData(e,t,i,r,s,n,a,o){const l=this._rctx,h=s.sourceLayerInfo.data,c=s.tile.surface.layerViewByIndex(s.layerIndex,jh.MAP),d=e.baseOpacity<1?Pm.Q.Required:Pm.Q.NotRequired,p=d===Pm.Q.Required||e.opacity<1||r!==Am.IU.Normal||t!==Dm.x.Composite,m=p?Im.g.On:Im.g.Off,_=this._acquireBlendLayersTechnique(r,t,d,m);l.setPipelineState(_.getPipeline());let g=null,f=null;p?(f=this.currentFBO(i),null==this._vtFBO&&(this._vtFBO=new zm(this._rctx)),g=this._vtFBO.get(i),l.bindFramebuffer(g),this._clearCurrentFBO()):o&&l.clear(Ze.NV.DEPTH);try{this._vectorTileHelper.renderBackground(l,s.sourceLod,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/s.scale),s.offset,a,n,c.contentZoom),h&&this._vectorTileHelper.renderContent(l,s.sourceLod,h,s.vtlNeighborInfos,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/s.scale),s.offset,a,n,c.contentZoom)}catch($t){u.A.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",$t)}return!g||(l.bindFramebuffer(f),e.texture=g.colorTexture,e.offset=Ge.uY,e.scale=1,this.drawImageData(e,t,i,r,m),o)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,km.g.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(Ze.Ap.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,km.g.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(Ze.NV.COLOR|Ze.NV.DEPTH|Ze.NV.STENCIL)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._current=t,t>=this._fbos.length)for(let r=this._fbos.length;r<=t;r++)this._fbos.push(new zm(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}}class Wm{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}var Zm=i(19992);class jm{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&(this._cache?(this._texture.isCompressing&&this._texture.abortCompression(),this._cache.put(this._generateCacheKey(),this)):this.dispose())}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}_generateCacheKey(){return`${this._texture.descriptor.width} ${this._texture.descriptor.pixelFormat}`+((0,Zm.pL)(this._texture)?"compressed":"")}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}}var $m=i(74125);function Qm(e){return e instanceof HTMLImageElement||e instanceof HTMLCanvasElement}class Ym extends $m.B{constructor(e){super("TextureCompressionWorker","compress",{compress:e=>[e.data]},e)}isCompressible(e){return Qm(e)}}class Xm{constructor(e,t,i,r,s,n){this.start=e,this.end=t,this.blendMode=i,this.opacity=r,this.output=s,this.baseOpacity=n}}let Km=class extends M.default{constructor(e){super(e),this._passParameters=new dm,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1}initialize(){this._maxAnisotropy=this.rctx.parameters.maxMaxAnisotropy,this._compositor=new Bm(this.rctx,this.techniques),this._ensureBackgroundTexture(this.tileSize),this.texturesBeingCompressed=0}dispose(){this._compositor=(0,p.WD)(this._compositor),this._backgroundTexture=(0,p.Gz)(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let s=0,n=0,a=this.tileSize,o=!1,l=!1;const h=i.view.state.contentPixelRatio;let c=!1;r_.clear(),s_.length=0;const d=e.layerInfo[jh.MAP];let u=0,p=null;for(;u<d.length;u++){const t=i.layerViewByIndex(u,jh.MAP),m=t.layer,_=!(0,_u.Cn)(e,t),g=m.opacity,f=t.fullOpacity;if(l=l||(0,q.rz)(m),(0,Nd.KE)(t)){let e="normal"!==t.layer.blendMode;if((0,q.jZ)(m.parent)){const t=m.parent.uid;null!=t&&""!==t&&(e=t_(m.parent)||e)}e&&(c=e,o=!1)}if((_||0===g)&&!c){d[u].pendingUpdates&=~(Zu.TEXTURE_NOFADING&Zu.TEXTURE_FADING);continue}++n;const y=(0,Nd.G3)(t),v=Jm(e,u,y);if(v){if(d[u].pendingUpdates&=~(Zu.TEXTURE_NOFADING&Zu.TEXTURE_FADING),(0,q.jZ)(m.parent)){const e=m.parent.uid;null!=e&&""!==e&&i_(m.parent,u)}y?a=Math.max(a,this.tileSize*h):1===r&&1===f&&(t.isOpaque||this._dataToTexture(v)&&v.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++s,null===p&&(p=u)}}const m=a/this.tileSize,_=this._ensureBackgroundTexture(this.tileSize);0!==s&&null!==p?1===s&&!c&&this._useLayerTexture(e,p)||this._composeLayers(e,t,u-1,l,a,m,!o||c,r_,c):function(e,t,i,r){const s=e.renderData,n=!r&&null!=s.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?uu.Delayed:uu.Immediate;s.setTextureReference(new pu(i,zd.ZY.FADING,a_,e.surface.baseOpacity,0,1),n)}(e,n,_,t!==zd.ZY.FADING)}_ensureBackgroundTexture(e){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(e),this._passParameters.offset=Ge.uY,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,jh.MAP),r=(0,q.rz)(i.layer),s=r?e.surface.baseOpacity:1,n=r?1:e.surface.baseOpacity,a=i.fullOpacity,o=Jm(e,t,!1);return!!this._dataToTexture(o)&&(e.renderData.setTextureReference(new pu(o.sourceLayerInfo.data,zd.ZY.FADING,(0,js.fA)(o.offset[0],o.offset[1],o.scale,o.scale),s,n,a)),!0)}_composeLayers(e,t,i,r,s,n,a,o,l){this._compositor.ensureBuffer(s);const h=e.surface.baseOpacity;let c=!1,d=Ze.Cj.LINEAR_MIPMAP_LINEAR,u=!1,p=0;for(let f=i;f>=0;f--){const t=e.surface.layerViewByIndex(f,jh.MAP),i=t.layer,m=(0,Nd.G3)(t),_=Jm(e,f,m),g=i.opacity,y=!(0,_u.Cn)(e,t);if(!_||(0===g||y)&&!l)continue;const v=!(0,q.rz)(i)&&!c;v&&(c=!0);let b=!1;o.forEach((e=>{e.start===f&&(e.output=r?Dm.x.Composite:a&&v?this.backgroundIsGrid?Dm.x.GridComposite:Dm.x.ColorComposite:Dm.x.Composite,e.baseOpacity=v?h:1,s_.push(e),this._compositor.openGroup(s),b=!0)}));const w=0===p,x=b?Dm.x.GroupBackgroundComposite:a&&w?this.backgroundIsGrid?Dm.x.GridComposite:Dm.x.ColorComposite:Dm.x.Composite,C=Am.wy[(0,Nd.KE)(t)?t.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=v&&!b&&h<1?h:1,this._passParameters.opacity=g,(0,Nd.cU)(_)?u=this._compositor.drawVectorData(this._passParameters,x,s,C,_,n,this.tileSize,u):(0,Nd.fe)(_)?(this._compositor.drawRasterData(this._passParameters,x,s,C,_),e_(_)&&(d=Ze.Cj.NEAREST)):this._dataToTexture(_)&&(this._passParameters.texture=_.sourceLayerInfo.data.texture,this._passParameters.offset=_.offset,this._passParameters.scale=_.scale,this._compositor.drawImageData(this._passParameters,x,s,C));s_.length>0&&s_[s_.length-1].end===f;){const e=s_.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=Ge.uY,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,s,Am.wy[e.blendMode])}p++}const m=e.renderData,_=l||c&&h<1,g=m.ensureTexture(s,_,t,(()=>this._buildTexture(s,_,d)));this._compositor.copyFBOToTexture(g),this._compositor.unbind(),m.setTextureReference(new pu(g,t,a_,c?1:h,0,1))}_dataToTexture(e){if((0,Nd.rI)(e)){const t=e.sourceLayerInfo,i=1===e.scale;t.data=this._buildTexture(t.data,!0,i),e.tile.setMemoryDirty()}return(0,Nd.E5)(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ze.Cj.LINEAR_MIPMAP_LINEAR;if(null==e)return null;const r=new et.R;r.wrapMode=Ze.pF.CLAMP_TO_EDGE,r.samplingMode="boolean"==typeof i?Ze.Cj.LINEAR_MIPMAP_LINEAR:i,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0,t||(r.pixelFormat=Ze.Ab.RGB);const s=this.rctx,n="boolean"==typeof i&&i;let a;if("number"==typeof e)r.width=r.height=e,a=this._buildTileTexture(r,e);else if((0,fc.EM)(e))r.isOpaque=e.isOpaque,r.isOpaque&&(r.pixelFormat=Ze.Ab.RGB),a=this._buildTileTexture(r,e.element.width,n,e.element);else try{r.width=e.width,r.height=e.height,a=this._buildTileTexture(r,e.width,n,e)}catch(l){a=new jm((0,qm.TD)(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=s.bindTexture(a.texture,km.g.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),s.bindTexture(o,km.g.TEXTURE_UNIT_FOR_UPDATES),a}_buildTileTexture(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0;const s=`${t} ${e.pixelFormat}`,n=this.cache.pop(s)??this.cache.pop(s+"compressed");if(i&&=Qm(r),n)return n.retain(),i&&n.texture.enableCompression(!0),n.texture.setData(r),n;e.shouldCompress=i;const a=new km.g(this.rctx,e,r);return a.isCompressing&&(this.texturesBeingCompressed++,this.addHandles([(0,g.watch)((()=>a.isCompressing),(e=>{e?this.texturesBeingCompressed++:this.texturesBeingCompressed--}),g.sync)])),new jm(a,this.cache)}get test(){}};function Jm(e,t,i){n_.layerIndex=t,n_.vtlNeighborInfos.clear();const r=e.layerInfo[jh.MAP][t];if((0,ze.hZ)(n_.offset,0,0),n_.tile=e,n_.scale=1,n_.sourceLod=e.lij,n_.sourceLayerInfo=r,n_.isVTLBackground=i,r.data)return i&&e.forEachLoadedNeighbor(((i,s)=>{if(i.level!==e.level)return;const n=i.layerInfo[jh.MAP][t];if(!(0,Nd.Y4)(n)||r.data===n.data)return;const a=n_.vtlNeighborInfos.pushNew();a.offset=o_[s],a.sourceLod=i.lij,a.sourceLayerInfo=n})),n_;const s=r.upsampleInfo,n=s?.tile?.layerInfo[jh.MAP][t];return n&&s.tile?(n_.tile=s.tile,(0,ze.C)(n_.offset,s.offset),n_.scale=s.scale,n_.sourceLod=s.tile.lij,n_.sourceLayerInfo=n,n_):i?n_:null}function e_(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function t_(e){let t="normal"!==e.blendMode;return(0,q.jZ)(e.parent)&&(t=t_(e.parent)||t),t}function i_(e,t){(0,q.jZ)(e.parent)&&i_(e.parent,t);const i=e.uid;if(null!=i&&""!==i){const r=r_.get(i);r?r.start=t:r_.set(i,new Xm(t,t,e.blendMode,e.opacity,Dm.x.Composite,1))}}(0,r._)([(0,w.MZ)({constructOnly:!0})],Km.prototype,"rctx",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Km.prototype,"techniques",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Km.prototype,"cache",void 0),(0,r._)([(0,w.MZ)()],Km.prototype,"tileSize",void 0),(0,r._)([(0,w.MZ)()],Km.prototype,"texturesBeingCompressed",void 0),Km=(0,r._)([(0,C.$)("esri.views.3d.terrain.TileRenderer")],Km);const r_=new Map,s_=new Array,n_=new class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new oo.A({allocator:e=>e||new Wm})}},a_=(0,js.fA)(0,0,1,1),o_=new Array;o_[nu.N.NORTH]=[0,-1],o_[nu.N.NORTH_EAST]=[-1,-1],o_[nu.N.EAST]=[-1,0],o_[nu.N.SOUTH_EAST]=[-1,1],o_[nu.N.SOUTH]=[0,1],o_[nu.N.SOUTH_WEST]=[1,1],o_[nu.N.WEST]=[1,0],o_[nu.N.NORTH_WEST]=[1,-1];var l_=i(71311);const h_=1e-6;class c_{constructor(e,t,i,r,s){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=s}}class d_{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=r,this._rayDirection=(0,E.vt)(),this._callback=f_,this._intersectionOptions=g_,this.bspNodeTree=new Array;const s=i-t,n=new(s<m_?Uint8Array:s<__?Uint16Array:Uint32Array)(s);this.triangleIndexMap=n;for(let a=0;a<s;++a)n[a]=a;{const a=function(e,t,i,r,s){const n=i-t,a=new Float32Array(6*n);for(let o=0;o<n;++o){const i=3*(o+t),n=e[i]*s,l=e[i+1]*s,h=e[i+2]*s;for(let e=0;e<3;++e){const t=r[n+e],i=r[l+e],s=r[h+e];a[6*o+e]=Math.min(t,i,s),a[6*o+3+e]=Math.max(t,i,s)}}return a}(e,t,i,r.data,r.stride),o=(0,de.qE)(Math.log2(s/40),2,10),l=(e,t,i)=>{const r=function(e,t,i,r){if(r<=i)return(0,su.fA)(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*e[i];for(let e=0;e<3;++e)u_[e]=t[r+0+e],p_[e]=t[r+3+e]}for(let s=i+1;s<r;++s){const i=6*e[s];for(let e=0;e<3;++e)u_[e]=Math.min(u_[e],t[i+0+e]),p_[e]=Math.max(p_[e],t[i+3+e])}return(0,su.fA)(u_[0],u_[1],u_[2],p_[0],p_[1],p_[2])}(n,a,e,t),s=t-e;if(s<=40){const i=new c_(r,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:h,midValue:c}=function(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(r),d=function(e,t,i,r,s,n){let a=i,o=r;for(;a<o;){const i=e[a];t[6*i+s+3]<=n?++a:(--o,e[a]=e[o],e[o]=i)}let l=a;for(o=r;l<o;){const i=e[o-1];t[6*i+s]>=n?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:a,mid:l}}(n,a,e,t,h,c),u=(e,t)=>{if(i>o)return;const r=t-e;return r<40||r>=.8*s?void 0:l(e,t,i+1)},p=new c_(r,h,c,d.next,d.mid);return this.bspNodeTree.push(p),p.leftNode=u(e,d.next),p.rightNode=u(d.mid,t),p};l(0,s,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.positions;(0,kp.h7)(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,i.data,i.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),d_.numFacesTested+=t-e}intersectRay(e,t,i,r){d_.numFacesTested=0;const s=e,n=t,a=n[0]-s[0],o=n[1]-s[1],l=n[2]-s[2];if(a*a+o*o+l*l<h_)return;this._rayFrom=s;const h=this._rayDirection;h[0]=a,h[1]=o,h[2]=l;const c=this.triangleIndexMap.length;this._callback=r,this._intersectionOptions=i,this.intersectRayBSP(this.bspNodeTree[0],0,c),this._callback=f_,this._intersectionOptions=g_}intersectRayBSP(e,t,i){const r=this._rayFrom,s=this._rayDirection;if(!function(e,t,i){const r=t,s=i;let n=0,a=1/0;for(let o=0;o<3;++o){{const t=e[o];if(r[o]<t){if(s[o]<=h_)return!1;const e=(t-r[o])/s[o];n=Math.max(n,e)}else if(s[o]<=-1e-6){const e=(t-r[o])/s[o];a=Math.min(a,e)}if(n>a)return!1}{const t=e[o+3];if(r[o]>t){if(s[o]>=-1e-6)return!1;const e=(t-r[o])/s[o];n=Math.max(n,e)}else if(s[o]>=h_){const e=(t-r[o])/s[o];a=Math.min(a,e)}if(n>a)return!1}}return!0}(e.aabb,r,s))return;const n=e.axis,a=e.d;if(r[n]<a||s[n]<0){const i=t,r=e.midStartIndex;if(i<r){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,r):this.intersectRayTriangleRange(i,r)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[n]>a||s[n]>0){const t=e.rightStartIndex,r=i;if(t<r){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,r):this.intersectRayTriangleRange(t,r)}}}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}d_.numFacesTested=0;const u_=[1/0,1/0,1/0],p_=[-1/0,-1/0,-1/0];const m_=255,__=65535,g_=new kp.JG,f_=()=>{};var y_=i(75747),v_=i(65069),b_=i(60984),w_=i(53801),x_=i(34360),C_=i(16213),T_=i(69261),M_=i(12796),S_=i(12188),R_=i(51448);class A_ extends R_.E{constructor(e){super(),this.spherical=e,this.overlayMode=S_.w9.Disabled,this.tileBlendInput=y_.k.LayerOnly,this.transparencyMode=l_.S.Opaque,this.pbrMode=M_.A9.Simplified,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.normalType=C_.W.Compressed,this.textureCoordinateType=T_.I.Compressed,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.canHaveOverlay=!0}}(0,r._)([(0,Em.W)({count:S_.w9.COUNT})],A_.prototype,"overlayMode",void 0),(0,r._)([(0,Em.W)({count:y_.k.COUNT})],A_.prototype,"tileBlendInput",void 0),(0,r._)([(0,Em.W)({count:l_.S.COUNT})],A_.prototype,"transparencyMode",void 0),(0,r._)([(0,Em.W)({count:M_.A9.COUNT})],A_.prototype,"pbrMode",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"receiveShadows",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"backfaceCullingEnabled",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"textureFadingEnabled",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"renderOccluded",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"screenSpaceReflections",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"cloudReflections",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"tileBorders",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"visualizeNormals",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"screenSizePerspective",void 0),(0,r._)([(0,Em.W)()],A_.prototype,"receiveAmbientOcclusion",void 0);const E_=(0,su.vt)();let O_=class extends Et.RW{get _isGlobal(){return this._stage.viewingMode===X.RT.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,r,s){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._ellipsoidRadius=r,this.type=Co.dz.TERRAIN,this.isGround=!0,this._passParameters=new yu.T,this._drawParameters=new x_.P,this._renderDataPool=new Td.A(wu),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new _u.C2,this._castShadows=!1,this._inViewshed=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=b_.m$.Occlude,this.produces=new Map([[w_.N.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===l_.S.Opaque],[w_.N.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===l_.S.Transparent||this.transparency===l_.S.InvisibleWithDraped)],[w_.N.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileSize=256,this._configuration=new A_(t.viewingMode===X.RT.Global),this._tileTextureCache=new xd(((e,t)=>s.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new lm(s)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles((0,g.watch)((()=>this._overlayRenderer.rendersOccludedDraped),(e=>{this.renderOccludedFlags=e?qd.O8:b_.m$.Occlude,this.setNeedsRender()}),g.sync))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?Et.B7:Et.qo}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get tileRenderer(){return this._tileRenderer}get texturesBeingCompressed(){return this._tileRenderer?this._tileRenderer?.texturesBeingCompressed:null}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerUid(){return Ar.fo}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,Zu.TEXTURE_FADING)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const i=(0,js.fA)(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,i)??!1}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===Zu.TEXTURE_FADING?zd.ZY.FADING:zd.ZY.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const i of e.layerInfo[jh.ELEVATION])i.pendingUpdates&=~Zu.GEOMETRY;e.resetPendingUpdate(Zu.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return E.uY;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt.C7.UPDATE;this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt.C7.UPDATE;this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt.C7.UPDATE;this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new Km({rctx:this._rctx,tileSize:this._tileSize,techniques:this._techniques,cache:this._tileTextureCache}),this.updateTileBackground(),this._emptyTex=(0,qm.TD)(this._rctx)}uninitializeRenderContext(){this._emptyTex=(0,p.WD)(this._emptyTex),this._tileRenderer=(0,p.WD)(this._tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==l_.S.Opaque)return;const s=P_,n=D_;(0,Me.d)(s,r,i),(0,Me.i)(n,1/s[0],1/s[1],1/s[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,h=e.options.store===Co.oH.MIN,c=!!e.results.ground.target,d=(0,Ar.dd)(e.verticalOffset),u=e.tolerance;let p,m=h&&null!=a.dist?a.dist:1/0;const _=e.options,g=_.normalRequired||!_.backfacesTerrain,f=new kp.JG(!1,g),y=c=>{const y=c.renderData;if(!y?.vao)return;const v=y.geometry;(0,su.hZ)(E_,v.boundingBox);const b=y.localOrigin;null!=d&&(d.localOrigin=b,d.applyToAabb(E_));const w=E_;if(I_[0]=i[0]-b[0],I_[1]=i[1]-b[1],I_[2]=i[2]-b[2],!(0,kp.d2)(w,I_,n,u,m))return;const x=(e,t,i)=>{e.set(this.type,c,t,i,Ue.zK),m=h&&null!=a.dist?a.dist:1/0},C=(n,h,c)=>{if((!g||null!=c)&&n>=0&&(_.backfacesTerrain||(0,Me.f)(c,s)<0)&&(_.invisibleTerrain||!_.selectionMode||null==t||t(i,r,n))){if((null==l.dist||n<l.dist)&&x(l,n,c),_.isFiltered)return;_.store===Co.oH.ALL&&(null==p?(p=(0,lr.G7)(e.ray),x(p,n,c),e.results.all.push(p)):n<p.dist&&x(p,n,c)),(null==a.dist||n<a.dist)&&x(a,n,c),_.store!==Co.oH.MIN&&(null==o.dist||n>o.dist)&&x(o,n,c)}},T=L_;(0,Me.d)(T,r,b);const{indices:M,indexCount:S}=v,R=v.vertexAttributes,A=R.getField(ut.r.POSITION,nm.xs),E=new v_.K(A.typedBuffer,3,R.stride/4),O=S/3;if(!d&&O>200){const e=c.renderData;null==e.intersectionData&&(e.intersectionData=new d_(M,0,O,E)),e.intersectionData.intersectRay(I_,T,f,C)}else(0,kp.Z$)(I_,T,0,O,M,E,d,f,C)},v=this._rootTiles;null!=v&&(()=>{const t=this._tileIterator;t.reset(v);const r=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||r&&e.intersectsClippingArea)||null==d&&!e.intersectsRay(i,s,u,m)||c&&this._useStencilForTile(e)?t.skipSubtree():y(e)})()}processScaleRangeQueries(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const i of t)null!=i.renderData?.textureReference&&e.queriesForTile(i);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!(0,d.A)("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const i=e.bind.viewshedEnabled;if(this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0),e.bind.slot===w_.N.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&qd.O8))return null}else{const t=this.transparency===l_.S.Opaque?w_.N.OPAQUE_TERRAIN:w_.N.TRANSPARENT_TERRAIN;if(e.bind.slot!==t)return null}if(this.transparency===l_.S.Invisible)return null;switch(this._configuration.screenSpaceReflections=this._configuration.cloudReflections=this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.overlayMode=this._overlayRenderer.mode,e.output){case gu.V.Color:case gu.V.ColorEmission:return this._configuration.screenSpaceReflections=null!=e.bind.ssr.lastFrameColor,this._configuration.cloudReflections=null!=e.bind.clouds.data,this._configuration.receiveShadows=e.bind.shadowMap.ready,this._configuration.receiveAmbientOcclusion=null!=e.bind.ssao,this._acquireTechnique(e.output,e.bind.slot===w_.N.OCCLUDED_TERRAIN);case gu.V.Shadow:case gu.V.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(gu.V.Shadow,!1):null;case gu.V.ViewshedShadow:return this._inViewshed?this._acquireTechnique(gu.V.ViewshedShadow,!1):null;case gu.V.Depth:case gu.V.Normal:return this._acquireTechnique(e.output,!1);case gu.V.ObjectAndLayerIdColor:return this._acquireTechnique(gu.V.ObjectAndLayerIdColor,!1);case gu.V.Highlight:return this._overlayRenderer.hasHighlights?this._acquireTechnique(gu.V.Highlight,!1):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case gu.V.Color:case gu.V.ColorEmission:{const i=e.bind.slot===w_.N.OCCLUDED_TERRAIN?am.A.Occluded:am.A.Color;this._renderMaterialPass(e,t,i);break}case gu.V.Depth:case gu.V.Normal:this._renderAuxiliaryPass(e,t,am.A.Color,this._visiblePatchesByOrigin);break;case gu.V.Highlight:{const i=e.bind.highlight?.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(am.A.Highlight)&&this._overlayRenderer.hasHighlightOptions(i)&&this._renderAuxiliaryPass(e,t,am.A.Highlight,this._visiblePatchesByOrigin);break}case gu.V.Shadow:case gu.V.ShadowExcludeHighlight:case gu.V.ViewshedShadow:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case gu.V.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,am.A.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=vd.default.toUnitRGBA(e);i=(0,E.fA)(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,zd.ZY.FADING))),this._configuration.tileBlendInput=t.backgroundIsGrid?y_.k.GridComposite:null!=t.backgroundColor?y_.k.ColorComposite:y_.k.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Zp.X.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)(0,_u.Ey)(this.renderOrder,i,t);e.sort(((e,t)=>(0,_u.Ri)(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i){this._numTilesCulled++;continue}const r=i.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(r);t||(t=[],this._allPatchesByOrigin.set(r,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let s=this._visiblePatchesByOrigin.get(r);s||(s=[],this._visiblePatchesByOrigin.set(r,s)),s.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i,r){const s=e.rctx;this._passParameters.overlayContent=i,s.bindTechnique(t,e.bind,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;r.forEach((r=>{this._drawParameters.origin=r[0].renderData.localOrigin,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters);for(let s=0;s<r.length;s++)this._renderPatch(e,t,r[s],Ze.WR.TRIANGLES,n,i)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=e.bind.camera,n=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const e=(0,To.mt)(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const a=this._stencilEnabledLayerExtents.length>0,o=i===am.A.Occluded;o&&(n.bindTexture("tex",this._emptyTex),n.setUniform3fv("textureOpacities",E.uY),n.setUniform4fv("texOffsetAndScale",js.uY));const l=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:E.uY;this._configuration.tileBlendInput===y_.k.ColorComposite&&n.setUniform3fv("backgroundColor",l);const h=this.wireframe?Ze.WR.LINES:Ze.WR.TRIANGLES;this._configuration.textureFadingEnabled&&n.bindTexture("texNext",this._emptyTex);const c=this._visiblePatchesByOrigin;for(const d of c.values()){const r=d[0].renderData.localOrigin;this._drawParameters.origin=r,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const s of d){const r=s.renderData,l=r.textureReference;if(null!=l){if(!o){n.setUniform4fv("texOffsetAndScale",l.offsetAndScale),n.bindTexture("tex",l.texture.texture);const e=r.textureFadeFactor,t=e<1?r.nextTextureReference:null;this._configuration.textureFadingEnabled&&null!=t&&e<1?(n.setUniform1f("fadeFactor",e),n.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),n.setUniform3fv("nextTexOpacities",t.opacities),n.bindTexture("texNext",t.texture.texture)):n.setUniform1f("fadeFactor",1),r.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",l.opacities)}this._renderPatch(e,t,s,h,a,i),s.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,i,r,s,n){const a=i.renderData,o=a.vao,l=o?.indexBuffer;if(!o||null==l)return void(Nd.L8&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const h=t.program;null==n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,a.overlay),s&&(t.useStencil=this._useStencilForTile(i),e.rctx.setPipelineState(t.getPipeline()));const c=a.geometry.indexCount;e.rctx.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(r,c,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e,t){return this._configuration.output=e,this._configuration.renderOccluded=t,this._techniques.get(vu,this._configuration)}get test(){}hasHighlightOptions(e){return this._overlayRenderer.hasHighlightOptions(e)}};(0,r._)([(0,w.MZ)({readOnly:!0})],O_.prototype,"_isGlobal",null),(0,r._)([(0,w.MZ)()],O_.prototype,"renderOccludedFlags",void 0),(0,r._)([(0,w.MZ)({value:!1})],O_.prototype,"renderingDisabled",null),(0,r._)([(0,w.MZ)({value:!0})],O_.prototype,"visible",null),(0,r._)([(0,w.MZ)()],O_.prototype,"texturesBeingCompressed",null),(0,r._)([(0,w.MZ)()],O_.prototype,"renderPatchBorders",null),(0,r._)([(0,w.MZ)()],O_.prototype,"visualizeNormals",null),(0,r._)([(0,w.MZ)()],O_.prototype,"cullBackFaces",null),(0,r._)([(0,w.MZ)({value:Zp.X.FRONT_TO_BACK})],O_.prototype,"renderOrder",null),(0,r._)([(0,w.MZ)()],O_.prototype,"wireframe",null),O_=(0,r._)([(0,C.$)("esri.views.3d.terrain.TerrainRenderer")],O_);const P_=(0,E.vt)(),D_=(0,E.vt)(),I_=(0,E.vt)(),L_=(0,E.vt)();class N_{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}var H_=i(61129),F_=i(49386);let V_=class extends M.default{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",(()=>this._update())),(0,g.watch)((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!(0,q.qK)(t)||t.isRejected())&&!(t.isFulfilled()&&!function(e,t,i){return null!=(0,Nd.Uo)(e,t,i)}(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!("vector-tile"===t?.type||(0,Nd.Ci)(t))))),e)if(e.isResolved()){const t=(0,Nd.Uo)(e,this.viewSpatialReference,this.viewingMode);if(null!=t){const e=new F_.n(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===X.RT.Global){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=F_.n.makeWebMercatorAuxiliarySphere(t):(0,H_.s)(i)&&(e=F_.n.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles((0,g.watch)((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===X.RT.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=F_.n.WebMercatorAuxiliarySphere:(0,H_.C)(e)&&(this.tilingScheme=F_.n.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||(0,V.aI)(e,this.extent)||(this.tilingScheme=F_.n.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};(0,r._)([(0,w.MZ)()],V_.prototype,"tilingScheme",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],V_.prototype,"extent",void 0),(0,r._)([(0,w.MZ)({value:!1})],V_.prototype,"tilingSchemeLocked",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],V_.prototype,"viewSpatialReference",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],V_.prototype,"layers",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],V_.prototype,"extentHelper",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],V_.prototype,"viewingMode",void 0),V_=(0,r._)([(0,C.$)("esri.views.3d.terrain.TilingSchemeLogic")],V_);class U_{constructor(){this._offset=(0,Ge.vt)(),this.scale=0}get offset(){return this._offset}init(e,t,i,r){this.tile=e,this._offset[0]=t,this._offset[1]=i,this.scale=r}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}}var z_;let G_=z_=class extends(Te.A.EventedMixin(M.default)){get allTiles(){return this._allTiles}constructor(e){super(e),this._scaleRangeQueries=new $p,this._iteratorPool=new Td.A(_u.C2,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new _u.V$,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new N_,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=(0,E.vt)(),this._eyePosSurfaceSR=(0,E.vt)(),this._splitLimits=new sm,this._frustum=(0,el.vt)(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new lo.U,this._frameTask=it.nu,this._allTiles=new oo.A,this._upsampleInfoPool=new Td.A(U_),this._shouldEmitChangeEvent=!1,this._destroying=!1,this._rootTilesExtent=(0,V.vt)(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=N.default.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new Ed(1/0,-1/0),this.rootTileElevationBounds=new Ed(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new Yd({...e,surface:this}),this._isGlobal=!e.view?.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?Yp:Bp,this._ellipsoid=(0,Pe.tO)(e.view.spatialReference)}initialize(){const e=this.view,t=e.resourceController,r=t.memoryController;this._tileCache=new xd(((e,t)=>r.newCache(e,t)),"terrain-tile"),this._upsampleMapCache=r.newCache("terrain-upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new Sd.E(r.newCache("elevation-query"));const s=this.overlayManager;this._renderer=new O_(s.renderer,e._stage,this._allTiles,this._ellipsoid.radius,r),this.addHandles([(0,g.watch)((()=>s.renderer.isEmpty),(()=>this._evaluateTransparency())),(0,g.watch)((()=>this.renderer.visible),(e=>this.suspended=!e)),(0,g.watch)((()=>this.heading),(e=>{this._renderer.updateHeading(e),this._updateTileTextures(zd.ZY.FADING)})),(0,g.watch)((()=>({heading:e.camera?.heading,state:e.state?.mode})),(e=>{let{heading:t,state:i}=e;if(null==t)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(t/90)%360);const r=Math.round(t)%360,s=Math.abs(r-this.heading);(i===bn.M.IDLE||Math.min(s,360-s)>=30)&&(this.heading=r)}))],"overlayManager"),this.addHandles([(0,g.watch)((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?zd.ZY.UNFADED:zd.ZY.IMMEDIATE)}),g.syncAndInitial),(0,g.watch)((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?zd.ZY.UNFADED:zd.ZY.IMMEDIATE)),g.syncAndInitial),(0,g.watch)((()=>this.backgroundColor),((e,t)=>{e?.equals(t)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))}),g.sync),(0,g.watch)((()=>this.snapLevel),(()=>this._viewChanged=!0),g.sync),(0,g.watch)((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),(0,g.watch)((()=>ho.b.TERRAIN_TILE_TREE_SHOW_TILES),(t=>{t&&!this._treeDebugger?i.e(73744).then(i.bind(i,73744)).then((t=>{let{TerrainTileTree3DDebugger:i}=t;!this._treeDebugger&&ho.b.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new i({view:e}))})):t||(this._treeDebugger=(0,p.pR)(this._treeDebugger))}),g.initial)]),this.addHandles([(0,g.watch)((()=>this._renderer.tileRenderer?.texturesBeingCompressed),((e,t)=>{t&&e<t&&(this.setMemoryDirty(),this._allTiles.forAll((e=>e.setMemoryDirty())))}))]),this.addHandles([(0,g.watch)((()=>this._renderer.texturesBeingCompressed),((e,t)=>{0===e&&e!==t&&this.requestRender()}))]);const{spatialReference:n}=e;this._extentHelper=function(e,t){return e===X.RT.Global?new Fd(t):new Vd(t)}(this.viewingMode,{layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:n});const a=new bd.A({getCollections:()=>e.defaultsFromMap?.mapCollections?.map((e=>{let{layers:t}=e;return t})),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),o=new V_({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:n});this._set("tilingSchemeLogic",o),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(oc.sK.ELEVATION),this._mapDataRequester=t.createStreamDataRequester(oc.sK.BASEMAP);const l=t.scheduler;this._frameTask=l.registerTask(it.W6.TERRAIN_SURFACE,this),this.addHandles([(0,g.watch)((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),g.initial),(0,g.watch)((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),g.sync),(0,g.watch)((()=>this.extent),(()=>this._updateRootTiles()),g.initial),e.on("resize",(()=>this._viewChangeUpdate())),(0,g.watch)((()=>{const t=e.state;return[this._lodBias,this.lodSnappingEnabled,e.quality,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),g.syncAndInitial),(0,g.watch)((()=>e.qualitySettings?.fadeDuration),(e=>this._renderer.textureFadingEnabled=e>0),g.initial),(0,g.watch)((()=>e.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._renderer.pbrMode=e?M_.A9.Simplified:M_.A9.Disabled),g.initial),(0,g.watch)((()=>e.qualitySettings?.tiledSurface.elevationLevelDelta),(()=>this._updateAllTileGeometries())),(0,g.watch)((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),g.sync)]),this.addHandles(e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._destroying=!0,this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",(0,p.pR)(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,p.pR)(this.overlayManager)),this._tileCache=(0,p.pR)(this._tileCache),ju.prune(),this._treeDebugger=(0,p.pR)(this._treeDebugger),this._renderer=(0,p.pR)(this._renderer),this._iteratorPool=(0,p.pR)(this._iteratorPool),this._upsampleMapCache=(0,p.pR)(this._upsampleMapCache),this._elevationQueryCache=(0,p.pR)(this._elevationQueryCache),this._set("view",null),this._extentHelper=(0,p.pR)(this._extentHelper),this._upsampleInfoPool=(0,p.pR)(this._upsampleInfoPool),Wu.size>0&&(console.log(`${Wu.size} live TilePerLayerInfo allocations:`),Wu.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:e,tilingScheme:t}=this,i=e.scale;if(t&&i){const r=t.levelAtScale(i)+e.qualitySettings.tiledSurface.lodBias,s=t.getMaxLod();return r<=0?null:Math.min(r,s||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(null==t||null==e)return null;const i=(0,V.vt)(),r=(0,fh.k)(t,i,e)?i:null,s=this._get("extent");return(0,V.aI)(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=(0,V.E$)(this.groundExtent,this._userClippingExtent,(0,V.vt)()),t=this._get("extent");return(0,V.aI)(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.renderer.texturesBeingCompressed)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===l_.S.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,i,r){const s=this._rootTiles;if(!s?.length)return null;if(0===s[0].layerInfo[jh.ELEVATION].length)return null;let n=this._elevationProjectorCache.get(r);if(void 0===n&&(n=(0,il.jd)(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,n)),null==n)return u.A.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=(0,Me.i)(k_,e,t,i);return n(a,0,a,0),$_(s,a[0],a[1])}getElevations(e,t,i){const r=this._rootTiles,s=r?r[0].layerInfo[jh.ELEVATION].length:0;if(r?.length&&0!==s)for(let n=0;n<t;++n){const t=3*n;i(n,$_(r,e[t],e[t+1]))}else for(let n=0;n<t;++n)i(n,null)}getScale(e){if(!this.tilingScheme)return null;if(!(0,F.g)(e,k_,this.spatialReference))return u.A.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const i of t)if(i?.containsPoint(k_)){let e=i;for(;e.children[0]&&!e.rendered;){const t=e.children[0].extent;let i=0;k_[0]>t[2]&&(i+=1),k_[1]<t[1]&&(i+=2),e=e.children[i]}return this._getLodBiasCorrectedScale(e.level)}return 1/0}_ensureProjector(e){const t=this._projectorCache.get(e);if(t)return t;const i=(0,il.jd)(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,i),i}getSphereElevationBounds(e,t){const i=this._ensureProjector(t);if(null==i)return u.A.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;(0,Kt.e)(e,B_);const r=(0,Kt.a)(B_);i(r,0,r,0);const s=new Gh.H,n=this._rootTiles;if(null!=n){const e=[];for(const i of n)e.push(i);let t=0;for(;t<e.length;){const i=e[t];if(++t,!(0,V.m7)(i.extent,B_))continue;const r=i.children;if(null==r[0]||i.rendered)s.expandElevationRangeValues(i.elevationBoundsMin,i.elevationBoundsMax);else for(const t of r)e.push(t)}}return s}getRootElevationBounds(){return new Gh.H(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!(0,F.g)(e,(0,Kt.a)(B_),this.spatialReference))return u.A.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;B_[3]=t;let i=null;const r=e=>{if(e&&(0,V.m7)(e.extent,B_)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)r(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},s=this._rootTiles;if(null!=s)for(const n of s)r(n);return i}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+a,n+a,r)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?t?l_.S.Invisible:l_.S.InvisibleWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?l_.S.Opaque:l_.S.Transparent;return this._renderer.transparency=r,i!==r}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;(0,Nd.bk)(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??N.default.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&(0,Re.r1)(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}_acquireTile(e,t,i,r){const s=this._tileCache.pop(z_._tileMemcacheKey);return s?(s.init(e,t,i,r,this),s):new this._tileConstructor(e,t,i,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=W_;let r=t.rootTilesInExtent(e,i,5*Pd.SR);if(null!=this._rootTiles){if(r.length>Pd.SR)return void u.A.getLogger(this).warn(Pd.hB);const e=this._rootTiles.map((e=>e.lij)),t=(0,cc.iv)(e,r,tp);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>tp(t,e.lij)))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,r.length>Pd.SR&&(u.A.getLogger(this).warn(Pd.P2),r=t.rootTilesInExtent(e,i,Pd.SR)),this._setRootTiles(r.map((e=>this._newRootTile(e))));(0,V.aI)(i,this._rootTilesExtent)||(this._rootTilesExtent=(0,V.vt)(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter((e=>e.loaded&&e.intersectsClippingArea));e.sort(_u.lR),e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(_u.lR);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===Zu.SPLIT}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(Zu.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(Zu.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=(0,_u.kh)(e),i=this.visibleElevationBounds;let r=t?i.min:1/0,s=t?i.max:-1/0;const n=this.extent,a=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(n)&&e.resetPendingUpdate(Zu.GEOMETRY)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(a),e.renderData&&(r=Math.min(e.elevationBoundsMin,r),s=Math.max(e.elevationBoundsMax,s))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(i.min!==r||i.max!==s)&&(this.visibleElevationBounds=new Ed(r,s))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach((i=>{let{elevationBoundsMin:r,elevationBoundsMax:s}=i;e=Math.min(e,r),t=Math.max(t,s)}));const r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new Ed(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=(0,el.C)(this._splitLimits.frustum??(0,el.vt)(),t.frustum):this._splitLimits.frustum=null,(0,el.C)(this._frustum,e.frustum),(0,Me.c)(this._eyePosRenderSR,t.eye),(0,Md.F)(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor((e=>{this._layerViews[jh.MAP].some(Nd.G3)&&e.setPendingUpdate(Zu.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)}))}_updateTileTexture(e,t){const i=e.resetPendingUpdate(Zu.TEXTURE_FADING)?Zu.TEXTURE_FADING:!!e.resetPendingUpdate(Zu.TEXTURE_NOFADING)&&Zu.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=Z_.extent;(0,V.Ie)(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>(0,V.fT)(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),Z_.spatialReference=this.spatialReference,this.emit("elevation-change",Z_),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),Nd.L8&&this._checkTileInvariant(),!e.hasProgressed)return rt.G}_checkTileInvariant(){const e=new Map;this._allTiles.forAll((t=>e.set(t,new Set))),this._allTiles.forAll((t=>{if((0,Nd.bk)(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,i=t.children.reduce(((t,i)=>t+(e(i)?0:1)),0);if((0,Nd.bk)(t.unmergableChildCount===i,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${i}`),t.hasPendingUpdate(Zu.MERGE)){(0,Nd.bk)(!t.hasPendingUpdate(Zu.SPLIT),"Tile can be both split and merge at the same time");for(const e of t.children)(0,Nd.bk)(e.leaf||e.hasPendingUpdate(Zu.MERGE),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(t.rendered){const e=t.renderData?.geometryState.edgePeerNeighbors[i];if(null!=e){{const r=t.level-e.level<=Pd.nU;r||(console.log(`tile level delta [${t.lij.toString()}] vs [${e.lij.toString()}] > ${Pd.nU}  (edge[${i}])`),(0,Nd.bk)(r,`tile level delta [${t.level}] vs [${e.level}] > ${Pd.nU}`))}(0,Nd.bk)(t.level-e.level<=Pd.nU,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${e.lij.toString()}]`)}}const r=t.level-Pd.nU,s=e=>e.leaf||e.level===t.level,n=t.findNeighborTile(Nd.Rz[i],s);if(null!=n){if(t.leaf&&t.level>=Pd.nU){let i=n;for(;t.level-i.level<Pd.nU;)i=i.parent;if(!tp([r,t.lij[1]>>Pd.nU,t.lij[2]>>Pd.nU],i.lij)){const r=e.get(i);(0,Nd.bk)(!r.has(t),"Cannot already have neighbor"),r.add(t)}}(0,Nd.bk)(n.rendered||n.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),(0,Nd.bk)(t.level-n.level<=Pd.nU,`Tile level delta [${t.level}] vs [${n.level}] > ${Pd.nU}`)}}})),this._allTiles.forAll((t=>{const i=t.maxLevelDeltaNeighborCount,r=e.get(t);(0,Nd.bk)(i===r.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${r.size}`)}))}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new Q_(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll((e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0}));const n=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),a=e.parent,o=null!=a&&a.hasPendingUpdate(Zu.MERGE),l=o?Zu.MERGE:e.shouldSplit(r,s,i),h=l===Zu.SPLIT;e.leaf?Y_(e,h):t.pushAll(e.children),o?(e.resetPendingUpdate(Zu.SPLIT),e.leaf||e.setPendingUpdate(Zu.MERGE),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(n)):h?(e.resetPendingUpdate(Zu.MERGE),e.leaf&&e.setPendingUpdate(Zu.SPLIT)):(e.resetPendingUpdate(Zu.SPLIT)&&e.updateAgentSuspension(),l===Zu.ELEVATION&&e.updateAgents(jh.ELEVATION),e.leaf||(e.setPendingUpdate(Zu.MERGE),e.resetPendingUpdate(Zu.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||((0,_u.jV)(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){(0,Nd.GH)(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter((e=>e.loaded&&e.intersectsClippingArea));if(0===t.length)return void e.clear();const i=(i,r)=>{!r?.loaded||!r.intersectsClippingArea||r.level<i.level||e.has(r)||(e.add(r),t.push(r),r.renderData.updateNeighborData())};t.sort(_u.lR);const r=t.length;for(let s=0;s<r;++s){const r=t[s];(0,Nd.GH)(r.loaded),(0,Nd.GH)(r.intersectsClippingArea);const n=r.renderData;n.updateNeighborData();const a=n.dirtyEdgeResolutions,o=n.geometryState,l=e=>{const t=Nd.XQ[e];i(r,o.cornerPeerNeighbors[e]?.findCorner((0,Nd.jj)(t),(e=>e.loaded)))};for(let t=0;t<4;++t)if(a&1<<t){const s=n.geometryState.edgePeerNeighbors[t];s&&s?.level>=r.level&&s.forAllSubtreeOnSide((0,Nd.JM)(Nd.Rz[t]),(t=>!(!t.loaded||!t.intersectsClippingArea)&&((0,Nd.GH)(e.has(t)||(0,_u.lR)(r,t)<0),i(r,t),!0))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,Nd.L8&&Nd.aL&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let n=!1;const a=!this._allTiles.some((s=>{if(!i&&!r&&!s.visible)return e.done;let a=s;if(s.hasPendingUpdate(Zu.MERGE)){if(!t||s.unmergableChildCount>0)return e.done;for(s.resetPendingUpdate(Zu.MERGE);null!=a.parent&&0===a.parent.unmergableChildCount&&a.parent.resetPendingUpdate(Zu.MERGE);)a=a.parent;this._mergeTile(a),n=!0,e.madeProgress()}else if(s.resetPendingUpdate(Zu.SPLIT)){let t=!0;const i=s.level;if(i>=Pd.nU){const e=e=>e.leaf||i-e.level<Pd.nU;for(let r=0;r<4;++r){const n=s.findNeighborTile(Nd.Rz[r],e);null!=n&&i-n.level===Pd.nU&&(t=!1,Nd.L8&&((0,Nd.GH)(n.leaf),(0,Nd.GH)(n.hasPendingUpdate(Zu.SPLIT))))}}t?(this._splitTile(s),e.madeProgress(),n=!0):s.setPendingUpdate(Zu.SPLIT)}return e.done}));if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!i){i=!0;continue}if(!n)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(Zu.GEOMETRY)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done))),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(bt.C7.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Pd.CU}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=(0,de.qE)(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeSubtree(e){const t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?K_(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(z_._tileMemcacheKey,e)}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){(0,Nd.bk)(e.leaf,"Tile that is already split should not be split again!"),(0,Nd.bk)(e.rendered,"Tile marked to split is not rendered"),K_(e);const t=e.createChildren();this._allTiles.pushArray(t),e.updateAgentSuspension(),(0,Nd.bk)(e.rendered,"parent should be rendered"),t.forEach((e=>this._loadTile(e))),t.forEach((e=>this._pendingTilesToUpdate.add(e))),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach((e=>Y_(e,e.hasPendingUpdate(Zu.SPLIT)))),++this._performanceInfo.numSplit}_emitTileScaleChange(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.level;j_.spatialReference=this.spatialReference,j_.extent=e.extent,j_.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",j_)}createTile(e,t,i,r){(0,Nd.bk)(!!r,"createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(Zu.SPLIT),s}get _shortBatches(){return this.view.state.mode!==bn.M.IDLE}_mergeTile(e){(0,Nd.bk)(!e.hasPendingUpdate(Zu.SPLIT),"_mergeTile sanity check"),(0,Nd.bk)(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),(0,Nd.bk)(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),Y_(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(e)}_handleLayerViewChanges(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:it.Bb;if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(let s=this.view.allLayerViews.length-1;s>=0;s--){const e=this.view.allLayerViews.items[s];if(i.add(e.uid),(0,Nd.eS)(e)||(0,Nd.Gk)(e))if(this._basemapLayerViewHandles.has(e.uid)&&!(0,Nd.Gk)(e)){const i=this._layerClassFromLayerView(e),s=this._getLayerIdxByUID(i,e.uid);null!=s&&((s<r||null==r)&&(t=!0),r=s)}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){let e=0===this.view.map?.ground?.opacity;for(const t of this.view.allLayerViews.items)if((0,Nd.LC)(t)&&!(0,q.rz)(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if(((0,Nd.KE)(e)||(0,Nd.Gk)(e))&&(0,Am.aO)(Am.wy[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return(0,Nd.oX)(e)?jh.ELEVATION:jh.MAP}_registerTiledLayerView(e){const t=[];if(((0,Nd.KE)(e)||(0,Nd.Gk)(e))&&t.push((0,g.watch)((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(zd.ZY.UNFADED)}))),!(0,Nd.Gk)(e)){const i=this._layerClassFromLayerView(e);t.push((0,g.watch)((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push((0,g.watch)((()=>e.fullOpacity),(()=>this._updateTileTextures(zd.ZY.UNFADED)))),t.push((0,g.watch)((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!(0,Nd.eS)(e)||!e.fullExtent)return;const r=this._layerClassFromLayerView(e);if(r===jh.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[r].push(e)}));for(const r of Qh){const e=this._layerViews[r],i=t[r];i.reverse();const s=i.length;let n=e.length!==s;const a=new Array(s),o=new Array(e.length);this._layerIndexByUid[r].clear();for(let t=0;t<s;t++){const s=i[t].uid;this._layerIndexByUid[r].set(s,t);const l=e.indexOf(i[t]);a[t]=l,t!==l&&(n=!0),l>-1&&(o[l]=t)}if(n){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;)e.next().modifyLayers(o,a,r);this._layerViews[r]=i,this._restartAllAgents(r),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===jh.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(jh.MAP),e===zd.ZY.IMMEDIATE?this.renderer.updateTileTexture(t,Zu.TEXTURE_NOFADING):t.updateRenderData(jh.MAP,e)})),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt.C7.UPDATE;this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||(0,Nd.G3)(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,(0,_.throwIfAborted)(r),(0,_.isAbortError)(t)||this._dataMissing(e,i,s),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){if(this._destroying)return Promise.resolve();const s=t===jh.ELEVATION;return r.requester??=s?this._elevationDataRequester:this._mapDataRequester,s?(0,Nd.oX)(i)?this._requestElevationTileData(e,i,r):Promise.reject():(0,Nd.LC)(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=r=>{!(0,_.isAborted)(i)&&r&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,r))};return t.fetchTile(e.lij,i).then((e=>this._frameTask.schedule((()=>r(e)))),(i=>{(0,_.isAbortError)(i)||(u.A.getLogger(this).error(`Tile ${e.lij.toString()} layer ${jh.ELEVATION}/${t.uid} error ${i}`),this._dataMissing(e,jh.ELEVATION,t),this.requestUpdate())})).finally((()=>--this._asyncWorkItems))}_elevationDataArrived(e,t,i){const r=this._layerIndexByUid[jh.ELEVATION].get(t.uid);if(null==r)return void u.A.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",jh.ELEVATION,e.lij.toString());const s=new Dd(e.lij,e.extent,i);e.dataArrived(r,jh.ELEVATION,s);const n=[e],a=e.level,o=this._iteratorPool.acquire();for(o.reset(n);!o.done;){const e=o.next();e.findElevationBoundsForLayer(r,a),e.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(n)}_requestMapTileData(e,t,i){var r=this;++this._asyncWorkItems;const s=(r,s)=>{(0,Nd.n8)(s),(0,_.isAborted)(i)||(console.error(`Tile ${e.lij.toString()} layer ${jh.MAP}/${t.uid} error ${r}`),this._dataMissing(e,jh.MAP,t),this.requestUpdate())},n=e=>t=>s(t,e);return t.fetchTile(e.lij,i).then((r=>this._frameTask.schedule((()=>{this.requestUpdate(),(0,_.isAborted)(i)?(0,Nd.n8)(r):this._mapTileDataArrived(e,t,r)}),i.signal,n(r)).catch(n(r))),(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r._frameTask.schedule((()=>s(e,t)))})).finally((()=>--this._asyncWorkItems))}_mapTileDataArrived(e,t,i){const r=this._getLayerIdxByUID(jh.MAP,t.uid);if(null==r)return(0,Nd.n8)(i),void u.A.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(r,jh.MAP,i)}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i){const r=this._getLayerIdxByUID(t,i.uid);null!=r?e.dataMissing(r,t):u.A.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.leaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce(((e,t)=>e+t.usedMemory),0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return null!=r&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!Nd.aL)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},r=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.leaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)r(t)},s=e=>{const t=e.parent?.visible??!0,i=e.visible;e.computeVisibility();const r=e.visible;if(i!==r&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",i," instead of ",r),!e.leaf)for(const n of e.children)s(n)};for(const n of e)r(n),s(n)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}enableInternalChecks(e){(0,Nd.T7)(e)}enableWaterproofnessChecks(e){(0,Nd.Tn)(e)}};G_._tileMemcacheKey="TerrainTileMemcache",(0,r._)([(0,w.MZ)()],G_.prototype,"_renderer",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],G_.prototype,"_scaleRangeQueries",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],G_.prototype,"view",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],G_.prototype,"overlayManager",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"_hasPendingUpdates",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"_asyncWorkItems",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"_allTilesDirty",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"_allTilesSorted",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"_viewChanged",void 0),(0,r._)([(0,w.MZ)({type:Number})],G_.prototype,"heading",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"_splitLimits",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"_watchUpdatingTracking",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"_frameTask",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"snapLevel",null),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"lodSnappingEnabled",null),(0,r._)([(0,w.MZ)()],G_.prototype,"_userClippingExtent",null),(0,r._)([(0,w.MZ)()],G_.prototype,"_rootTilesExtent",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"extent",null),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"groundExtent",null),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"_tilingSchemeExtent",null),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"updating",null),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"running",null),(0,r._)([(0,w.MZ)(Ad.S)],G_.prototype,"updatingProgress",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"updatingProgressValue",null),(0,r._)([(0,w.MZ)()],G_.prototype,"_maxNumUpdating",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"baseOpacity",null),(0,r._)([(0,w.MZ)()],G_.prototype,"hasCompositeBlendMode",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"viewingMode",null),(0,r._)([(0,w.MZ)()],G_.prototype,"maxTextureScale",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"ready",null),(0,r._)([(0,w.MZ)({value:Zp.X.FRONT_TO_BACK})],G_.prototype,"renderOrder",null),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"rootTiles",null),(0,r._)([(0,w.MZ)()],G_.prototype,"_rootTiles",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"spatialReference",null),(0,r._)([(0,w.MZ)({type:vd.default})],G_.prototype,"backgroundColor",null),(0,r._)([(0,w.MZ)({value:!1})],G_.prototype,"slicePlaneEnabled",null),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"tilingScheme",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"tilingSchemeLocked",null),(0,r._)([(0,w.MZ)({readOnly:!0})],G_.prototype,"tilingSchemeLogic",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"wireframe",null),(0,r._)([(0,w.MZ)({value:!1})],G_.prototype,"suspended",null),(0,r._)([(0,w.MZ)()],G_.prototype,"fadeDuration",null),(0,r._)([(0,w.MZ)()],G_.prototype,"visibleElevationBounds",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"rootTileElevationBounds",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"_layerViewsDirty",void 0),(0,r._)([(0,w.MZ)()],G_.prototype,"renderPatchBorders",null),(0,r._)([(0,w.MZ)()],G_.prototype,"visualizeNormals",null),(0,r._)([(0,w.MZ)()],G_.prototype,"renderingDisabled",null),G_=z_=(0,r._)([(0,C.$)("esri.views.3d.terrain.TerrainSurface")],G_);const q_=G_,k_=(0,E.vt)(),B_=(0,Kt.c)(),W_=(0,V.vt)();new oo.A;const Z_=new Rd.L("ground"),j_={spatialReference:null,extent:null,scale:0};function $_(e,t,i){for(const r of e){if(!r.containsPointXY(t,i))continue;let e=r;for(;e&&!e.renderData;){const r=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[r]}return Ld(t,i,e?.renderData?.geometryState.samplerData??null)}return null}class Q_{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[i+r]=e[r];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function Y_(e,t){!e.leaf||e.level<Pd.nU||eg(e,(e=>{t&&X_(e);const i=J_(e);if(e.maxLevelDeltaNeighborCount++,i){let t=e.parent;for(;t;){const e=J_(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}}))}function X_(e){if(e.hasPendingUpdate(Zu.SPLIT))return;let t=e.parent;for(;t?.resetPendingUpdate(Zu.MERGE);)t=t.parent;e.resetPendingUpdate(Zu.MERGE),e.leaf&&e.setPendingUpdate(Zu.SPLIT),e.level<Pd.nU||eg(e,(e=>{X_(e)}))}function K_(e){e.level<Pd.nU||eg(e,(e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,J_(t));)t=t.parent}}))}function J_(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function eg(e,t){if(e.level<Pd.nU)return;const i=e.level-Pd.nU,r=e.lij[1]>>Pd.nU,s=e.lij[2]>>Pd.nU,n=e=>e.leaf||e.level===i;for(let a=0;a<4;++a){const o=e.findNeighborTile(Nd.Rz[a],n);if(!o||o.level!==i)continue;const l=o.lij;l[1]===r&&l[2]===s||t(o)}}var tg=i(99741),ig=i(71602),rg=i(20196),sg=i(69291),ng=i(44e3),ag=i(69473);class og{constructor(e,t,i,r){this.operation=e,this.geometry=t,this.states=i,this.sync=r}}let lg=class extends M.default{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);if(!i)return;let r=0;i.forEach(((i,s)=>{const n=this._ensureGeomRecord(e,s);r+=i.size,i.forEach(((e,i)=>{let{geometry:r,operation:a,states:o}=e,l=!1;if(a===ag.q.UPDATE){const e=n.get(i);if(e){if(o&ag.k.TRANSFORMATION){const t=this.model.getObject(s);this.model.updateRenderGeometryTransformation(t,r,e)&&(l=!0)}l||t.updates.push({renderGeometry:e,updateType:o})}else(0,dc.vA)(!1,"ModelDirtySet.commitLayer: invalid update")}if(a===ag.q.REMOVE||l){const e=n.get(i);e?(t.removes.push(e),n.delete(i)):a===ag.q.REMOVE&&(0,dc.vA)(!1,"ModelDirtySet.commitLayer: invalid remove")}if(a===ag.q.ADD||l){const e=this.model.getObject(s);if(null!=e){const s=this.model.getRenderGeometry(e,r);t.adds.push(s),n.set(i,s)}}})),0===n.size&&this._residentGeomRecords.get(e).delete(s)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this._dirtyRecordCount-=r}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.get(e);i&&i.forEach(((i,r)=>{const s=this._ensureGeomRecord(e,r);i.forEach(((e,i)=>{let{geometry:n,operation:a,states:o,sync:l}=e,h=!1;if(a===ag.q.UPDATE&&l){const e=s.get(i);if(e){if(o&ag.k.TRANSFORMATION){const t=this.model.getObject(r);this.model.updateRenderGeometryTransformation(t,n,e)&&(h=!0)}h||t.updates.push({renderGeometry:e,updateType:o})}else(0,dc.vA)(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}}))}))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach((e=>e.forEach((e=>t.push(e)))))}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,null,ag.q.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(ag.k.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(ag.k.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(ag.k.OCCLUDEE,e)}attributesChanged(e){let{object:t,geometry:i,sync:r}=e;this._updateOrCreateDirtyRecord(t,i,null,ag.q.UPDATE,ag.k.GEOMETRY,r)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const r of t.geometries)this._geometryAdded(t,r,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const r of t.geometries)this._geometryRemoved(t,r,i)}transformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i.geometry,t,ag.q.UPDATE,ag.k.TRANSFORMATION)}))}shaderTransformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((t=>{t.objectShaderTransformationChanged(e.shaderTransformation)}))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,i,ag.q.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,i,ag.q.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ag.k.NONE,n=arguments.length>5&&void 0!==arguments[5]&&arguments[5];i=i??this._getParentLayerId(e);const a=e.id,o=t.id,l=this._ensureDirtyRecord(i,a),h=l.get(o);if(h){const e=h.operation;e===ag.q.REMOVE&&r===ag.q.ADD&&h.states!==ag.k.NONE?h.operation=ag.q.UPDATE:e===ag.q.REMOVE&&r===ag.q.ADD||e===ag.q.ADD&&r===ag.q.REMOVE?(l.delete(o),this._dirtyRecordCount--):e!==ag.q.UPDATE||r!==ag.q.REMOVE&&r!==ag.q.UPDATE?((0,dc.vA)((e===ag.q.REMOVE||e===ag.q.ADD)&&r===ag.q.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),h.states|=s):(h.operation=r,h.states|=s),h.sync=h.sync||n}else l.set(o,new og(r,t,s,n)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:Ko.M}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,r)=>{i.forEach(((i,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const n=[];i.forEach((e=>{const t=e.operation;n[t]||(n[t]=[]),n[t].push(e.geometry.id)}));for(let r=0;r<n.length;r++)if(n[r]){t+=" "+e[r-1]+": ";for(let e=0;e<n[r].length;e++)t+=n[r][e]+", "}}))})),t}get test(){}};(0,r._)([(0,w.MZ)()],lg.prototype,"_dirtyRecordCount",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],lg.prototype,"model",void 0),lg=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],lg);const hg=lg;var cg=i(10625);let dg=class extends M.default{constructor(){super(...arguments),this.dirtySet=new hg({model:this}),this._content=new Map,this._originFactory=new ng.g(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;(0,dc.vA)(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),(0,rg.r)(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),(0,rg.r)(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(const t of e)t&&((0,dc.vA)(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)t&&((0,dc.vA)(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach((i=>{i.type===e&&t(i)}))}getRenderGeometry(e,t){const i=new cg.$(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});i.transformation=e.getCombinedStaticTransformation(t,ug);const{localOrigin:r}=t;return i.localOrigin=null!=r?r:this._originFactory.getOrigin((0,Kt.a)(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(null==e)return!1;i.transformation=e.getCombinedStaticTransformation(t,ug);const r=this._originFactory.getOrigin((0,Kt.a)(i.boundingSphere));return i.localOrigin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<sg.X.COUNT;++i)e[i]=t.filter((e=>e.type===i)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){}};(0,r._)([(0,w.MZ)({constructOnly:!0})],dg.prototype,"dirtySet",void 0),dg=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.parts.Model")],dg);const ug=(0,Ue.vt)();var pg=i(15173),mg=i(2925),_g=i(6893),gg=i(98862);class fg extends _g.U{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=(0,E.vt)()}}class yg extends We.w{constructor(e,t){super(e,t,new Be.$(gg.C,(()=>i.e(76314).then(i.bind(i,76314)))))}initializePipeline(e){return(0,je.Ey)({blending:e.reduced?je.fg:(0,je.ox)(Ze.dn.SRC_ALPHA,Ze.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:e.reduced?Ze.MT.ALWAYS:Ze.MT.LEQUAL},colorWrite:je.kn})}}class vg extends Em.K{constructor(){super(...arguments),this.reduced=!1}}(0,r._)([(0,Em.W)()],vg.prototype,"reduced",void 0);var bg=i(15500);let wg=class extends vt.default{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[ct.InternalRenderCategory.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=ct.InternalRenderCategory.OPAQUE_ENVIRONMENT,this.requestRender(bt.C7.UPDATE)}_disable(){this.produces="disabled",this.requestRender(bt.C7.UPDATE)}};(0,r._)([(0,w.MZ)()],wg.prototype,"produces",void 0),(0,r._)([(0,w.MZ)()],wg.prototype,"consumes",void 0),wg=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],wg);var xg=i(67296);class Cg extends We.w{constructor(e,t){super(e,t,new Be.$(xg.a,(()=>i.e(44896).then(i.bind(i,44896)))))}initializePipeline(){return(0,je.Ey)({blending:(0,je.ox)(Ze.dn.SRC_ALPHA,Ze.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:Ze.MT.ALWAYS},colorWrite:je.kn})}}var Tg=i(99590);let Mg=class extends wg{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new xg.A,this._vao=null,this._passParameters=new fg,this._configuration=new vg}initialize(){this.techniques.precompile(yg,this._configuration),this.techniques.precompile(Cg),this._configuration.reduced=!0,this.techniques.precompile(yg,this._configuration),this._configuration.reduced=!1,this.addHandles([(0,g.watch)((()=>this.view.environment.background),(e=>{const t=e instanceof Tg.default?(0,mg.QP)(e.color):js.uY;(0,Me.i)(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])}),g.syncAndInitial),(0,g.watch)((()=>this.view._stage?.renderer?.fullResolutionAtmosphere),(e=>this._configuration.reduced=!e),g.syncAndInitial),(0,g.watch)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),g.syncAndInitial)])}destroy(){this._vao=(0,p.WD)(this._vao)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.OPAQUE_ENVIRONMENT}));if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=(0,qm.Q7)(i,qm.PE.Pos2Tex);const r=t.getAttachment(i.gl.DEPTH_STENCIL_ATTACHMENT);this._update();const s=this.techniques.get(yg,this._configuration);if(!s.compiled)return this.requestRender(bt.C7.UPDATE),t;if(!this._configuration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ze.WR.TRIANGLE_STRIP,0,4),t.attachDepth(r),t;const n=this.techniques.get(Cg);if(!n.compiled)return this.requestRender(bt.C7.UPDATE),t;const a=i.getViewport(),o=this.bindParameters.camera,l=(0,Me.l)(o.eye)-ue.$O.radius;let h;const c=ue.$O.atmosphereHeight;if(l<c){const e=Math.min(1,Math.max(0,l/c));h=(0,de.Cc)(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(l-c)/(15*c)));h=(0,de.Cc)(.3,.6,e)}const d=(0,Wd.Mv)(Math.round(h*o.fullViewport[2])),u=(0,Wd.Mv)(Math.round(h*o.fullViewport[3]));i.setViewport(0,0,d,u);const p=this.fboCache.acquire(d,u,"chapman",bg.N.RGBA);return i.bindFramebuffer(p.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ze.WR.TRIANGLE_STRIP,0,4),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=p.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(r),p.release(),t}_update(){const e=this.bindParameters.camera,t=(0,Me.k)(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]**2,s=(0,de.qE)((i-this._passParameters.radii[0])/ue.$O.atmosphereHeight,0,1);(0,Zs.s)(this._passParameters.heightParameters,i,t,r,s);const n=this.view.basemapTerrain?.getLowerBoundRadius()??0;(0,ze.hZ)(this._passParameters.radii,n,n+ue.$O.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*n-Qs.UP)*Qs.UP),this._passParameters.altitudeFade=(0,Qs.GF)(i-n)}};Mg=(0,r._)([(0,C.$)("esri.views.3d.environment.ChapmanAtmosphere")],Mg);var Sg=i(62840);class Rg extends We.w{constructor(e,t){super(e,t,new Be.$(Sg.C,(()=>i.e(64236).then(i.bind(i,64236)))))}initializePipeline(){return(0,je.Ey)({blending:(0,je.p3)(Ze.dn.ONE,Ze.dn.ZERO,Ze.dn.SRC_ALPHA,Ze.dn.ONE),depthTest:{func:Ze.MT.LEQUAL},colorWrite:je.kn})}}let Ag=class extends wg{constructor(e){super(e),this._planetRadius=(0,Pe.tO)(e.view.spatialReference).radius}initialize(){this.techniques.precompile(Rg),this.addHandles([(0,g.watch)((()=>null!=this.view.environment.weather&&this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),g.initial)])}destroy(){this._vao=(0,p.WD)(this._vao)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.OPAQUE_ENVIRONMENT})),i=this.bindParameters.clouds;if(!i.data)return t;const r=this.techniques.get(Rg);if(!r.compiled)return this.requestRender(bt.C7.UPDATE),t;const s=this.renderingContext;this._vao??=(0,qm.Q7)(s);const n=s.bindTechnique(r,this.bindParameters);return s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(Ze.WR.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(bt.C7.UPDATE),t}};Ag=(0,r._)([(0,C.$)("esri.views.3d.environment.CloudsComposition")],Ag);var Eg=i(81480);class Og extends We.w{constructor(e,t){super(e,t,new Be.$(Eg.a,(()=>i.e(932).then(i.bind(i,932)))))}initializePipeline(){return(0,je.Ey)({blending:(0,je.p3)(Ze.dn.SRC_ALPHA,Ze.dn.ZERO,Ze.dn.ONE_MINUS_SRC_ALPHA,Ze.dn.ONE),colorWrite:je.kn})}}let Pg=class extends wg{constructor(){super(...arguments),this.consumes={required:[ct.InternalRenderCategory.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=ct.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,this.requestRender(bt.C7.UPDATE)}};(0,r._)([(0,w.MZ)()],Pg.prototype,"consumes",void 0),Pg=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],Pg);let Dg=class extends Pg{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new Ig,this._oldParameters=new Ig,this._fadedParameters=new Ig,this._parameters=this._newParameters,this._passParameters=new Eg.F;const t=(0,Pe.tO)(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view._stage.renderView.techniques.precompile(Og)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([(0,g.watch)((()=>this.view.environment.atmosphereEnabled),(()=>this.toogle()),g.syncAndInitial),(0,g.watch)((()=>this.view.environment.weather),(()=>this.toogle()),g.syncAndInitial),(0,g.watch)((()=>this._updateFogParameters()),(()=>{}),g.syncAndInitial)]),this.addHandles((0,g.watch)((()=>this._fadeFactor),(e=>this._fade(e)),g.syncAndInitial))}get _fadeFactor(){return this.view._stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){const{_newParameters:t,_oldParameters:i}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=i:(this._fadedParameters.lerp(i,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t="foggy"===e.type||"snowy"===e.type||"rainy"===e.type;this._newParameters.strength="foggy"===e.type?(0,de.Cc)(3e-5,.005,e.fogStrength**3):"snowy"===e.type||"rainy"===e.type?(0,de.Cc)(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,"foggy"!==e.type&&"snowy"!==e.type||(0,Me.c)(this._newParameters.color,Fg),"rainy"===e.type&&(0,Me.c)(this._newParameters.color,Hg),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(bt.C7.UPDATE)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.TRANSPARENT_ENVIRONMENT}));if(0===this._parameters.amount)return t;if(this._update(),this._passParameters.amount<=0)return t;const i=this.techniques.get(Og);if(!i.compiled)return this.requestRender(bt.C7.UPDATE),t;const r=this.renderingContext,s=t.getAttachment(r.gl.DEPTH_STENCIL_ATTACHMENT);return t.attachDepth(null),r.bindFramebuffer(t.fbo),r.bindTechnique(i,this.bindParameters,this._passParameters),r.screen.draw(),t.attachDepth(s),t}_update(){const e=this.bindParameters.camera;(0,Me.n)(Lg,e.eye);const t=Math.max(0,(0,Me.f)(Lg,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;(0,Me.h)(Ng,i,.1),(0,Me.m)(this._passParameters.color,Ng,i,t);const r=(0,Me.l)(e.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-(0,de.TF)(.95*At.zF,1*At.zF,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}};Dg=(0,r._)([(0,C.$)("esri.views.3d.environment.Fog")],Dg);class Ig{constructor(){this.color=(0,E.vt)(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,(0,Me.c)(this.color,e.color)}lerp(e,t,i){this.amount=(0,de.Cc)(e.amount,t.amount,i),this.strength=(0,de.Cc)(e.strength,t.strength,i),(0,Me.m)(this.color,e.color,t.color,i)}}const Lg=(0,E.vt)(),Ng=(0,E.vt)(),Hg=(0,E.fA)(.5,.5,.5),Fg=(0,E.fA)(1.5,1.5,1.5);var Vg=i(92148),Ug=i(24344);class zg extends We.w{constructor(e,t){super(e,t,new Be.$(Vg.a,(()=>i.e(39376).then(i.bind(i,39376)))))}initializePipeline(e){const t=e.geometry===Ug.d.Cylinder;return(0,je.Ey)({blending:je.Ky,culling:t?je.PI:void 0,depthTest:{func:Ze.MT.LEQUAL},colorWrite:je.kn})}}const Gg=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);var qg=i(69586),kg=i(86580);let Bg=class extends wg{constructor(){super(...arguments),this._configuration=new Ug.$,this._passParameters=new Vg.S,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=Ug.d.Cylinder,this.addHandles([(0,g.watch)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),g.initial)])}destroy(){this._passParameters.texture=(0,p.WD)(this._passParameters.texture),this._vao=(0,p.WD)(this._vao)}precompile(){this.techniques.precompile(zg,this._configuration)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.OPAQUE_ENVIRONMENT})),i=this.techniques.get(zg,this._configuration);if(!i.compiled)return this.requestRender(bt.C7.UPDATE),t;const r=this.renderingContext;if(this._vao||(this._vao=function(e){const t=(0,kg.Y6)(1,2,!1),{data:i,indices:r}=t[0][1],s=Zg.createBuffer(r.length),n=s.position;for(let a=0;a<r.length;++a){const e=3*r[a%3==0?a+2:a%3==2?a-2:a];n.set(a,0,i[e]),n.set(a,1,i[e+1]),n.set(a,2,i[e+2])}return new wt.Z(e,qg.D,new Map([["geometry",(0,ft.U)(Zg)]]),new Map([["geometry",xt.g.createVertex(e,Ze._U.STATIC_DRAW,s.buffer)]]))}(r),this._vaoCount=(0,Ct.mT)(this._vao,"geometry")),!this._passParameters.texture){const e=new et.R;e.wrapMode=Ze.pF.CLAMP_TO_EDGE,e.flipped=!0,e.width=1,e.height=512,this._passParameters.texture=new km.g(r,e,Gg)}const s=r.bindTechnique(i,this.bindParameters,this._passParameters);return function(e,t){(0,Ve.C)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}(Wg,this.bindParameters.camera.viewMatrix),s.setUniformMatrix4fv("view",Wg),r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Ze.WR.TRIANGLES,0,this._vaoCount),t}};Bg=(0,r._)([(0,C.$)("esri.views.3d.environment.LocalAtmosphere")],Bg);const Wg=(0,Ue.vt)(),Zg=(0,yt.BP)().vec3f(ut.r.POSITION);var jg=i(46576);const $g=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),Qg=128,Yg=-1e4,Xg=(0,pe.su)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let Kg=class extends wg{constructor(e){super(e),this._passParameters=new Vg.S,this._configuration=new Ug.$,this._vao=null,this._vaoCount=0,this._fadeVao=null,this._fadeVaoCount=0,this._texV1=1;const t=e.view,i=(0,Pe.tO)(t.spatialReference),{outerAtmosphereRimWidth:r,radius:s}=i;this._planetRadius=s,this._innerRimFactor=1+Yg/s,this._middleRimFactor=1+0/s,this._outerRimFactor=1+r/s,this._texV0=0/r,this._texVScale=this._texV1-this._texV0;const n=t._stage.renderView.techniques;n.precompile(zg,this._configuration),this._configuration.geometry=Ug.d.Underground,n.precompile(zg,this._configuration)}initialize(){this.addHandles((0,g.watch)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),g.initial))}destroy(){this._passParameters.texture=(0,p.WD)(this._passParameters.texture),this._fadeVao=(0,p.WD)(this._fadeVao),this._vao=(0,p.WD)(this._vao)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.OPAQUE_ENVIRONMENT}));this._update();const i=this.renderingContext;if(!this._passParameters.texture){const e=new et.R;e.wrapMode=Ze.pF.CLAMP_TO_EDGE,e.flipped=!0,e.width=1,e.height=512,this._passParameters.texture=new km.g(i,e,$g)}if(this._passParameters.undergroundFadeAlpha<1){this._vao||(this._vao=this._createRibbon(i),this._vaoCount=(0,Ct.mT)(this._vao,"geometry")),this._configuration.geometry=Ug.d.Cone;const e=this.techniques.get(zg,this._configuration);if(!e.compiled)return this.requestRender(bt.C7.UPDATE),t;i.bindTechnique(e,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ze.WR.TRIANGLES,0,this._vaoCount)}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao||(this._fadeVao=(0,qm.Q7)(i),this._fadeVaoCount=(0,Ct.mT)(this._fadeVao,"geometry")),this._configuration.geometry=Ug.d.Underground;const e=this.techniques.get(zg,this._configuration);if(!e.compiled)return this.requestRender(bt.C7.UPDATE),t;i.bindTechnique(e,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(Ze.WR.TRIANGLE_STRIP,0,this._fadeVaoCount)}return t}_update(){const e=this.bindParameters.camera,t=(0,E.vt)(),i=this._planetRadius,r=(0,Me.l)(e.eye),s=r-i;if(s<0){const e=Math.min(-s/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(50,s),a=i+Yg;this._passParameters.innerScale=function(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}(i+n,i,a)-1,this._passParameters.altitudeFade=(0,Qs.GF)(s),(0,Me.h)(t,e.eye,(i+50)/r),Jg(t,e.center,e.up,i,this._passParameters.silhouette);const o=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),l=1-511/512,h=Xg(s);let c=this._texV0+l*this._texVScale,d=this._texV0+o*h*this._texVScale;if(s>50){Jg(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),r=(0,de.qE)((t-1.5)/(o-1.5),0,1);c=this._texV0+r*l*this._texVScale,d=this._texV0+(0,de.Cc)(this._texV1,o*h,r)*this._texVScale}(0,ze.hZ)(this._passParameters.texV,c,d)}_createRibbon(e){const t=(0,jg.oe)(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let n=0;n<Qg;n++){const e=9*n+3;t[e]=n,t[e+1]=this._innerRimFactor,t[e+2]=-1,t[e+3]=n,t[e+4]=this._middleRimFactor,t[e+5]=0,t[e+6]=n,t[e+7]=this._outerRimFactor,t[e+8]=1;const r=3*n+1,s=127===n?1:r+3,a=15*n;i[a]=r,i[a+1]=r+1,i[a+2]=s+1,i[a+3]=s+1,i[a+4]=s,i[a+5]=r,i[a+6]=r+1,i[a+7]=r+2,i[a+8]=s+2,i[a+9]=s+2,i[a+10]=s+1,i[a+11]=r+1,i[a+12]=r,i[a+13]=s,i[a+14]=0}const r=sf.createBuffer(i.length),s=r.position;for(let n=0;n<i.length;++n){const e=3*i[n];s.set(n,0,t[e]),s.set(n,1,t[e+1]),s.set(n,2,t[e+2])}return new wt.Z(e,qg.D,new Map([["geometry",(0,ft.U)(sf)]]),new Map([["geometry",xt.g.createVertex(e,Ze._U.STATIC_DRAW,r.buffer)]]))}_computeScreenRimWidth(e,t,i,r){return(0,Me.g)(tf,r.center,r.v2),(0,Me.h)(rf,tf,this._outerRimFactor),(0,Ve.t5)(ef,t,tf,i),(0,dc.Cv)(tf,ef,e.projectionMatrix,e.viewport,tf),(0,dc.Cv)(rf,ef,e.projectionMatrix,e.viewport,rf),(0,Me.j)(tf,rf)/e.height}};function Jg(e,t,i,r,s){const n=(0,Me.l)(e),a=r*Math.sqrt(n*n-r*r)/n,o=Math.sqrt(r*r-a*a),l=s.v1,h=s.v2;return(0,Me.h)(s.center,e,o/n),(0,Me.e)(l,e,t),(0,Me.k)(l)<1&&(0,Me.e)(l,e,i),(0,Me.h)(l,l,a/(0,Me.l)(l)),(0,Me.e)(h,l,e),(0,Me.h)(h,h,a/(0,Me.l)(h)),a}Kg=(0,r._)([(0,C.$)("esri.views.3d.environment.MarsAtmosphere")],Kg);const ef=(0,Ue.vt)(),tf=(0,E.vt)(),rf=(0,E.vt)();const sf=(0,yt.BP)().vec3f(ut.r.POSITION),nf=Kg;var af=i(45622),of=i(25048),lf=i(55239),hf=i(40753),cf=i(24132),df=i(44873),uf=i(99717);class pf{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{const t=this._indexRanges;let i=0,r=t.length/2;if(e<t[2*i]||e>t[2*r]+t[2*r+1])return!1;for(;r-i>0;){const s=Math.floor(.5*(i+r)),n=t[2*s];if(e<n){if(r-i==1)return!1;r=s}else{if(e<n+t[2*s+1])return!0;if(r-i==1)return!1;i=s+1}}return!1}}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const n=e[s];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let t=r;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1],a=e[s],o=e[n];t[r]=a,t[r+1]=o-a}return t}}class mf{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRangesMap=null,this.cachedShadowmapRanges=null;const i=this.count;this.visibility=new pf(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let r=0;r<i;r++)this.materialDataIndices[r]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this.cachedGeometryRanges&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRangesMap(){return 0===this.componentHighlights.size?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRangesMap)}get shadowmapRanges(){return 0===this.componentHighlights.size?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedShadowmapRanges)}markHighlightsDirty(){this.cachedHighlightRangesMap=null,this.cachedShadowmapRanges=null}markVisibilityDirty(){this.cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let i=t.length!==e.length;t.length=Math.min(e.length,8);for(let r=0;r<e.length;++r){const s=e.at(r).name;t.length<r?(i=!0,t.push(s)):t[r]!==s&&(t[r]=s,i=!0)}return i}_updateCachedHighlightRanges(){if(null==this.cachedHighlightRangesMap||null==this.cachedShadowmapRanges){const{highlightRangesMap:e,shadowmapRangesMap:t}=function(e,t,i,r){const s=new Map,n=[];if(e.size>0){let a=i.length;t.forEachComponent((t=>{let o=!1;for(let n=r.length-1;n>=0;--n){const a=r[n],l=e.get(a);if((l?.[t]??0)>0){const e=(0,af.tE)(s,a,(()=>[])),r=i[t],n=i[t+1];e.push(r),e.push(n-r),o||=a===wh.Tv;break}}return o||(a!==t-1&&(n.length>0&&n.push(i[a+1]-n[n.length-1]),n.push(i[t])),a=t),!0})),n.length>0&&n.push(i[a+1]-n[n.length-1])}return{highlightRangesMap:s,shadowmapRangesMap:n}}(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this.cachedHighlightRangesMap=e,this.cachedShadowmapRanges=t}}}class _f{constructor(e,t,i,r,s,n){this.transform=e,this.toMapSpace=t,this.obb=i,this.componentData=r,this.renderable=s,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=(0,p.pR)(this.intersectionGeometry),this.renderable=(0,p.pR)(this.renderable),this.componentData=(0,p.pR)(this.componentData)}}function gf(e,t){return new(function(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}(e))(t)}class ff{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=(0,E.fA)(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}intersectRay(e,t,i){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(i):this._intersectRayWithBVH(e,t,i))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,i){this._ensureBVH(),i?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],i=e[1];if(!this.localMode){const{geometryMinZ:r,planetCenterZ:s}=this,n=(r-s)/(e[2]-s);t=e[0]*n,i=e[1]*n}const{_bspNodes:r}=this;let s=0;for(;s>=0;){const e=r[s],{d:n,dim:a,minIndexIndex:o,minMidIndexIndex:l,maxMidIndexIndex:h,maxIndexIndex:c,aabb2D:d}=e;if(t<d[0]||t>d[2]||i<d[1]||i>d[3])break;if(-1===a||-1===e.child0&&-1===e.child1){this._intersectRange(o,c);break}{this._intersectRange(l,h);const r=(0===a?t:i)-n;if(r<0){if(-1===e.child0){this._intersectRange(o,l);break}s=e.child0}else{if(!(r>0))break;if(-1===e.child1){this._intersectRange(h,c);break}s=e.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let i=e[0],r=e[1],s=t[0],n=t[1];const{geometryMinZ:a}=this;if(!this.localMode){let o=0,l=1;const h=Math.min(.5*this.planetCenterZ,a),c=e[2],d=t[2];if(c<h&&d<h)return;if(c<h&&(o=(h-c)/(d-c)),d<h&&(l=(h-c)/(d-c)),o>l)return;const u=(1-o)*e[0]+o*t[0],p=(1-o)*e[1]+o*t[1],m=(1-o)*e[2]+o*t[2],_=(1-l)*e[0]+l*t[0],g=(1-l)*e[1]+l*t[1],f=(1-l)*e[2]+l*t[2],{planetCenterZ:y}=this,v=a-y,b=v/(m-y);i=u*b,r=p*b;const w=v/(f-y);s=_*w,n=g*w}const o=s-i,l=n-r,h=this._bspNodes;let c=1;{const{aabb2D:e}=h[0],t=(e,t,i,r)=>{if(Math.abs(t)<1e-5*Math.max(r-i,1))return!1;const s=t>0,n=s?r:i,a=e+c*t;return(s?a<n:a>n)&&(c=Math.max((n-e)/t,c),!0)},s=()=>t(i,o,e[0],e[2]),n=()=>t(r,l,e[1],e[3]);Math.abs(o)>=Math.abs(l)?s()||n():n()||s()}const d=[0,0,c];let u=0;for(;u<d.length;){const e=d[u];let t=d[u+1],s=d[u+2];if(u+=3,t>s)continue;const n=h[e],{minIndexIndex:a,maxIndexIndex:p}=n,{child0:m,child1:_,minMidIndexIndex:g,maxMidIndexIndex:f,aabb2D:y,d:v,dim:b}=n;{const e=i+t*o,r=i+s*o,n=Math.min(e,r),a=Math.max(e,r),l=y[0],h=y[2];if(a<l||h<n)continue;if(n<l){const e=(l-i)/o;o>0?t=Math.max(t,e):s=Math.min(s,e)}if(h<a){const e=(h-i)/o;o>0?s=Math.min(s,e):t=Math.max(t,e)}}{const e=r+t*l,i=r+s*l,n=Math.min(e,i),a=Math.max(e,i),o=y[1],h=y[3];if(a<o||h<n)continue;if(n<o){const e=(o-r)/l;l>0?t=Math.max(t,e):s=Math.min(s,e)}if(h<a){const e=(h-r)/l;l>0?s=Math.min(s,e):t=Math.max(t,e)}}if(-1===m&&-1===_)this._intersectRange(a,p);else{const e=0===b?i:r,n=0===b?o:l,h=e+t*n,u=e+s*n,y=Math.min(h,u),w=Math.max(h,u),x=(0,de.qE)((v-e)/n,0,c);a<g&&y<=v&&(-1!==m?(d.push(m),d.push(n>=0?t:Math.max(t,x)),d.push(n>=0?Math.min(s,x):s)):this._intersectRange(a,g)),this._intersectRange(g,f),f<p&&v<=w&&(-1!==_?(d.push(_),d.push(n>=0?Math.max(t,x):t),d.push(n>=0?s:Math.min(s,x))):this._intersectRange(f,p))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=gf(e,e);this._elementIndexMap=t;for(let u=0;u<e;++u)t[u]=u;const i=this.model.getAabbs2D();let r=0;const s=this._bspNodes;s.length=0;const{localMode:n}=this;let a=!1;if(!n){const{planetCenterZ:e,geometryMinZ:t}=this;a=e>=0||t<.5*e}const o=[],l=(e,t,i,r,s)=>{o.push(e),o.push(t),o.push(i),o.push(r<0?-1:(s?0:1)+2*r)},{maxBspNodeDepth:h,minBspNodeElementCount:c}=this,d=(e,r,o,d,u)=>{const p=s.length;if(p>0&&(a||o>=h||r-e<c))return;const m=[0,0,0,0];!function(e,t,i,r,s){let n=1/0,a=1/0,o=-1/0,l=-1/0;for(let h=t;h<i;++h){const e=4*r[h];n=Math.min(n,s[e+0]),a=Math.min(a,s[e+1]),o=Math.max(o,s[e+2]),l=Math.max(l,s[e+3])}e[0]=n,e[1]=a,e[2]=o,e[3]=l}(m,e,r,t,i);const{d:_,dim:g}=n?function(e){const t=e[0],i=e[1],r=e[2],s=e[3];let n,a;return r-t>=s-i?(a=.5*(t+r),n=0):(a=.5*(i+s),n=1),{d:a,dim:n}}(m):function(e){const t=e[0],i=e[1],r=e[2],s=e[3];let n,a;return r-t>=s-i?(n=0,a=.5*(t+r)):(n=1,a=.5*(i+s)),{dim:n,d:a}}(m),{rangeMidStart:f,rangeMidEnd:y}=function(e,t,i,r,s,n){let a=e;{let e=t;for(;a<e;){const t=s[a];yf(t,i,r,n)<0?++a:(--e,s[a]=s[e],s[e]=t)}}const o=a;let l=a,h=t;for(;l<h;){const e=s[h-1];yf(e,i,r,n)>0?--h:(s[h-1]=s[l],s[l]=e,++l)}return{rangeMidStart:o,rangeMidEnd:h}}(e,r,g,_,t,i),v=o===h-1,b=!v&&f>=e+c,w=!v&&r>=y+c;if(b||w||0===p){const t=new vf(e,f,y,r,g,_,m);if(b&&l(e,f,o+1,p,!0),w&&l(y,r,o+1,p,!1),s.push(t),-1!==d){const e=s[d];u?e.child0=p:e.child1=p}}};for(l(0,e,0,-1,!1);r<o.length;){const e=o[r],t=o[r+1],i=o[r+2],s=o[r+3];r+=4;const n=s>>1;d(e,t,i,n,s-(n<<1)==0)}this._generatedBVH=!0}}function yf(e,t,i,r){const s=4*e,n=r[s+0+t];return r[s+2+t]<i?-1:n>i?1:0}class vf{constructor(e,t,i,r,s,n,a){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=i,this.maxIndexIndex=r,this.dim=s,this.d=n,this.aabb2D=a,this.child0=-1,this.child1=-1}}class bf{constructor(e,t,i,r,s,n,a,o,l){this.componentIndex=e,this.vertexData=t,this.vertexStride=i,this.indexData=r,this.startTriangleNumber=s,this.endTriangleNumber=n,this.geometryMinZ=a,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=(0,E.vt)(),this.ray0=(0,E.vt)(),this.isVerticalRay=!1,this._triangleHitCallback=xf,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new ff(n-s,this)}getAabbs2D(){return this.localMode?function(e,t,i,r,s){const n=t-e,a=new Float64Array(4*n);for(let o=0;o<n;++o){const t=3*(o+e),n=s*i[t+0],l=r[n+0],h=r[n+1],c=s*i[t+1],d=r[c+0],u=r[c+1],p=s*i[t+2],m=r[p+0],_=r[p+1],g=4*o;a[g+0]=Math.min(l,d,m),a[g+1]=Math.min(h,u,_),a[g+2]=Math.max(l,d,m),a[g+3]=Math.max(h,u,_)}return a}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):function(e,t,i,r,s,n,a){const o=n-a,l=t-e,h=new Float64Array(4*l);for(let c=0;c<l;++c){const t=3*(c+e),n=s*i[t+0],l=r[n+0],d=r[n+1],u=o/(r[n+2]-a),p=l*u,m=d*u,_=s*i[t+1],g=r[_+0],f=r[_+1],y=o/(r[_+2]-a),v=g*y,b=f*y,w=s*i[t+2],x=r[w+0],C=r[w+1],T=o/(r[w+2]-a),M=x*T,S=C*T,R=4*c;h[R+0]=Math.min(p,v,M),h[R+1]=Math.min(m,b,S),h[R+2]=Math.max(p,v,M),h[R+3]=Math.max(m,b,S)}return h}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,i,r,s,n){(0,Me.c)(this.ray0,e),(0,Me.a)(this.rayDirection,t,e),this.isVerticalRay=i,this.totalElevationOffset=r,this.normalRequired=n,this._triangleHitCallback=s,this._bvh.intersectRay(e,t,i),this._triangleHitCallback=xf}intersectRange(e,t){const i=this._bvh.elementIndexMap;wf(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,i,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}}function wf(e,t,i,r,s,n,a,o,l,h,c){let d=arguments.length>11&&void 0!==arguments[11]?arguments[11]:null,u=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0;0!==o?(0,kp.zW)(e,t,i,r,s,n,a,o,l,h,c,d,u):(0,kp.h7)(e,t,i,r,s,n,a,h,c,d,u)}function xf(){}function Cf(e,t,i,r){if(i>=t)return e;null==e&&(e=function(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return{isVisibleBit:!e,data:new Uint32Array(0)}}());const s=e.isVisibleBit;let n=e.data;const a=Mf(n),o=i/a|0,l=i-a*o,h=(t-1)/a|0,c=n,d=r===s;if(!(i<c.length*a)&&d){const e=o+1,t=Math.ceil(c.length*cc.Ji),i=h+1;let r=Math.max(e,t);r=Math.min(r,i),n=new Uint32Array(r),n.set(c)}return o<n.length&&(n[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(n[o],l,d)),e.data=n,e}function Tf(e,t){if(null==e)return!0;const{isVisibleBit:i,data:r}=e,s=Mf(r);return t<r.length*s?function(e,t,i,r){const s=i/r|0,n=i-s*r;return function(e,t){return!!(e&1<<t)}(t[s],n)===e}(i,r,t,s):!e.isVisibleBit}function Mf(e){return 8*e.BYTES_PER_ELEMENT}class Sf{constructor(e,t,i,r,s,n,a,o){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=r,this._componentAabbs3D=s,this.geometryMinZ=n,this.planetCenterZ=a,this.localMode=o,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=Of,this._ray1=Pf,this._invDir=(0,E.vt)(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=If,this._callback=Df,this.rayDirectionC=(0,E.vt)(),this._componentIndexMap=null,this._bvh=new ff(r.count,this),this.componentIntersectionData=new Array(r.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:i}=this,r=new Float64Array(4*e),s=this._componentAabbs3D;for(let n=0;n<e;++n){const e=6*n,a=s[e+0],o=s[e+1],l=s[e+2],h=s[e+3],c=s[e+4],d=i/(l-t),u=i/(s[e+5]-t),p=Math.min(a*d,a*u),m=Math.min(o*d,o*u),_=Math.max(h*d,h*u),g=Math.max(c*d,c*u),f=4*n;r[f+0]=p,r[f+1]=m,r[f+2]=_,r[f+3]=g}return r}getAabbs2DLocal(){const{numComponents:e}=this,t=new Float64Array(4*e),i=this._componentAabbs3D;for(let r=0;r<e;++r){const e=6*r,s=i[e+0],n=i[e+1],a=i[e+3],o=i[e+4],l=4*r;t[l+0]=s,t[l+1]=n,t[l+2]=a,t[l+3]=o}return t}intersectRay(e,t,i,r,s,n,a){const{isVerticalRay:o}=a;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=i,this._verticalOffset=r,this._tolerance=n,this._intersectionOptions=a,this._componentIndexMap=this._bvh.elementIndexMap,(0,kp.OO)(e,t,this._invDir),this._callback=s,this._bvh.intersectRay(e,t,o),this._callback=Df}intersectRange(e,t){const i=this._componentIndexMap,r=this._components,s=r.pickability,n=r.visibility;for(let a=e;a<t;++a){const e=i?i[a]:a;Tf(s,e)&&n.isVisible(e)&&this._intersectComponent(e)}}getComponentTriangleCount(e){const t=this._components.offsets,i=t[e]/3;return t[e+1]/3-i}getComponentAabb3D(e,t){const i=this._componentAabbs3D,r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}_intersectComponent(e){if(!Tf(this._components.pickability,e))return;const t=this.getComponentAabb3D(e,Rf);let i=!1;const{localMode:r,_componentVerticalOffsets:s,_verticalOffset:n,_ray0:a,_ray1:o,_invDir:l,planetCenterZ:h,_tolerance:c,rayDirectionC:d,componentIntersectionData:u}=this,{isVerticalRay:p}=this._intersectionOptions,m=this._components.offsets,_=(0,Me.c)(Af,a),g=(0,Me.c)(Ef,o),f=s?.[e]??0,y=f+(n?.offset??0);if(0!==y&&(r?(_[2]=a[2]-y,g[2]=o[2]-y,i=!0):null!=n&&(n.componentOffset=f)),null==n||i||0===y||n.applyToAabb(t),!(0,kp.Wb)(t,_,l,c))return;(0,Me.a)(d,g,_);const v=m[e]/3,b=m[e+1]/3,w=b-v,x=(t,i,r)=>{this._callback(t,i,e,r)},{vertexData:C,vertexStride:T,indexData:M,_intersectionOptions:S}=this,{normalRequired:R}=S;if(w>Lf){let t=u[e];null==t&&(t=new bf(e,C,T,M,v,b,this.geometryMinZ,h,r),u[e]=t),t.intersectRay(_,g,p,i?0:y,x,R)}else wf(_,d,v,b,M,C,T,i?0:y,h,R,x)}}const Rf=(0,su.vt)(),Af=(0,E.vt)(),Ef=(0,E.vt)(),Of=(0,E.vt)(),Pf=(0,E.vt)(),Df=()=>{},If=new kp.JG,Lf=40;class Nf{constructor(e,t,i){this.viewingMode=e,this.positionData=t,this._components=i,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=(0,E.vt)(),this._componentBvh=null,this._aabb=[0,0,0,0,0,0],this._indices=t.indices?(0,lf.Dg)(t.indices):(0,lf.tM)(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,n,a,o){this.verticalOffset=r,this.componentVerticalOffsets=s;const{position:l}=n,h=(0,Me.a)(Hf,e,l),c=(0,Me.a)(Ff,t,l),d=(0,Fe.B8)(Vf,n.rotationScale);(0,Me.q)(h,h,d),(0,Me.q)(c,c,d);const u=(0,Fe.mg)(zf,d);if(this.viewingMode===X.RT.Global){const e=this._planetCenter;(0,Me.v)(e,l),(0,Me.q)(e,e,d)}this._intersectComponents(h,c,s,r,((e,t,i,r)=>{o(i,e,r?(0,Me.q)(Uf,r,u):null,t)}),i,a)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),i=.5*(e[1]+e[4]),r=.5*(e[2]+e[5]),s=this._components.count,n=(0,jg.oe)(6*s),a=this._indices,o=this._positions,l=this._components.offsets;let h=0,c=1/0,d=1/0,u=1/0,p=-1/0,m=-1/0,_=-1/0;for(let g=0;g<s;g++){const e=l[g],s=l[g+1];let f=1/0,y=1/0,v=1/0,b=-1/0,w=-1/0,x=-1/0;if(e<s)for(let t=e;t<s;t++){const e=3*a[t],i=o[e],r=o[e+1],s=o[e+2];f=Math.min(f,i),y=Math.min(y,r),v=Math.min(v,s),b=Math.max(b,i),w=Math.max(w,r),x=Math.max(x,s)}else f=t,y=i,v=r,b=t,w=i,x=r;n[h++]=f,n[h++]=y,n[h++]=v,n[h++]=b,n[h++]=w,n[h++]=x,c=Math.min(c,f),d=Math.min(d,y),u=Math.min(u,v),p=Math.max(p,b),m=Math.max(m,w),_=Math.max(_,x)}return this._aabb[0]=c,this._aabb[1]=d,this._aabb[2]=u,this._aabb[3]=p,this._aabb[4]=m,this._aabb[5]=_,n}_intersectComponents(e,t,i,r,s,n,a){let o=this._componentBvh;null==o&&(o=new Sf(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=o),o.intersectRay(e,t,i,r,s,n,a)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===X.RT.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}}const Hf=(0,E.vt)(),Ff=(0,E.vt)(),Vf=(0,ki.vt)(),Uf=(0,E.vt)(),zf=(0,ki.vt)();class Gf{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}}class qf{constructor(e,t,i,r){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}dispose(){this.vao.dispose()}}var kf=i(55411);function Bf(e,t){const i=new kf.d,{eye:r,frustum:s,viewForward:n}=e;t.forAll((e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=(0,Me.f)((0,Me.a)(ny,t.center,r),n),o=t.projectedRadius(n);if(i.within(a-o)&&i.within(a+o))return;const l=function(e,t){let i=0;for(let r=0;r<iy;r++){const s=e.intersectPlane(t[r]);if(s>0)return-1;0===s&&(i|=1<<r)}return i}(t,s);if(-1===l)return;if(0===l)return Zf.far=a+o,Zf.near=a-o,void i.union(Zf);const h=Wf.pushNew();h.near=a-o,h.far=a+o,h.mask=l,h.object=e}));for(let a=0;a<Wf.length;a++){const e=Wf.data[a];if(i.within(e.near)&&i.within(e.far))continue;Zf.far=e.far,Zf.near=1/0;const t=ey(null!=e.object.offsetObb?e.object.offsetObb:e.object.obb,r,Qf,(t=>{let i=Yf;for(let r=0;r<iy&&t.length>0;r++){if(!(e.mask&1<<r))continue;Xf(s[r],t,i);const n=t;t=i,i=n}for(let e=0;e<t.length;e+=3){(0,Me.i)(jf,t.data[e],t.data[e+1],t.data[e+2]);const i=(0,Me.f)((0,Me.a)(jf,jf,r),n);Zf.near=Math.min(Zf.near,i)}}));0===t&&(Zf.near=0),i.union(Zf)}return Wf.length=0,i}const Wf=new oo.A({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),Zf=new kf.d,jf=(0,E.vt)(),$f=(0,E.vt)(),Qf=new oo.A({deallocator:null}),Yf=new oo.A({deallocator:null});function Xf(e,t,i){i.length=0;const r=t.length-3;Kf(jf,t,r);const s=(0,Cr.mN)(e,jf);s<=0&&(i.push(jf[0]),i.push(jf[1]),i.push(jf[2]));let n=0,a=s;for(;n<r;n+=3){Kf($f,t,n);const r=(0,Cr.mN)(e,$f);a*r<0&&((0,Me.m)(jf,$f,jf,r/(r-a)),Jf(i,jf)),r<=0&&Jf(i,$f),a=r,(0,Me.c)(jf,$f)}a*s<0&&(Kf($f,t,r),(0,Me.m)(jf,$f,jf,s/(s-a)),Jf(i,jf))}function Kf(e,t,i){return(0,Me.i)(e,t.data[i],t.data[i+1],t.data[i+2])}function Jf(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function ey(e,t,i,r){(0,mr.Xr)(sy,e.quaternion),(0,Me.a)(ny,t,e.center),(0,Me.w)(ny,ny,sy);const s=e.halfSize,n=8*((ny[0]<-s[0]?-1:ny[0]>s[0]?1:0)+3*(ny[1]<-s[1]?-1:ny[1]>s[1]?1:0)+9*(ny[2]<-s[2]?-1:ny[2]>s[2]?1:0)+13),a=ty[n];if(0===a)return a;(0,Fe.I0)(ry,e.quaternion),(0,Fe.hs)(ry,ry,e.halfSize);const o=(t,i)=>{const r=ty[n+i+1];return(0,Me.i)(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),(0,Me.q)(t,t,ry),(0,Me.g)(t,e.center,t)};return i.length=0,Jf(i,o(ay,0)),Jf(i,o(oy,1)),Jf(i,o(ny,2)),Jf(i,o(ly,3)),r(i),1===a||(i.length=0,Jf(i,ay),Jf(i,ly),Jf(i,o(ny,4)),Jf(i,o(hy,5)),r(i),2===a||(i.length=0,Jf(i,ay),Jf(i,hy),Jf(i,o(ny,6)),Jf(i,oy),r(i))),a}const ty=(()=>{const e=new Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),iy=4;const ry=(0,ki.vt)(),sy=(0,_r.vt)(),ny=(0,E.vt)(),ay=(0,E.vt)(),oy=(0,E.vt)(),ly=(0,E.vt)(),hy=(0,E.vt)();class cy{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((i=>i.renderable.material.submit(e,t,i)))}queryDepthRange(e){return this._objects.visibleObjects.length?Bf(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some((e=>e.renderable.material.hasEmissions))}hasHighlightOptions(e){return this._objects.hasHighlightOptions(e)}}var dy=i(94362);class uy{constructor(){this.externalColor=(0,js.vt)(),this.externalColorMixMode=df.k5.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}}var py=i(99969),my=i(62510),_y=i(88242),gy=i(96122),fy=i(19151),yy=i(25874);const vy=()=>u.A.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class by{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new oo.A,this._hidden=new oo.A,this._renderSubmit=new cy(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new fy.A(e.rctx,2+((0,gy.E)()?1:0))}destroy(){(0,dc.vA)(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll((e=>e.destroy())),this._hidden.forAll((e=>e.destroy())),this._visible.clear(),this._hidden.clear()}createObject(e){const t=e.geometry,i=new mf(this._componentBufferManager,(0,lf.Dg)(t.componentOffsets)),r=this._createRenderable(e,i),s=new Nf(this._viewingMode,t.positionData,i),n=new _f(e.transform,e.toMapSpace,e.obb.clone(),i,r,s);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=(0,Me.s)(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.componentData.visibility.reset(t),i.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.componentData.visibility.componentCount;return{visible:i,invisible:t.componentData.count-i}}setComponentData(e,t){const i=e,{renderable:r,componentData:s}=i,n=r.material,a=s.materialDataBuffer,o=s.materialDataIndices,l=new uy,h=a.textureBuffer,c=new Uint8Array(4),d=new Uint32Array(c.buffer);let u=0,p=0,m=0,_=s.verticalOffsets,g=1/0,f=-1/0,y=!1,v=!1,b=0;for(let w=0;w<s.count;w++){t(w,l),u+=+(l.externalColor[3]<1),p+=+(l.externalColorMixMode===df.k5.Replace&&1===l.externalColor[3]),m+=+l.castShadows,(0,df._j)(l.externalColor,l.externalColorMixMode,c),c[2]=254&c[2]|+l.castShadows,h.setData(o[w],0,c[0],c[1],c[2],c[3]),y||=w>0&&b!==d[0],b=d[0],v||=0!==l.elevationOffset,v&&null==_&&(_=new Array(w).fill(0)),null!=_&&(_[w]=l.elevationOffset),g=Math.min(g,l.elevationOffset),f=Math.max(f,l.elevationOffset),(0,_y.B)(l.elevationOffset,c),h.setData(o[w],1,c[0],c[1],c[2],c[3]);const e=l.objectAndLayerIdColor;null!=e&&h.setData(o[w],2,e[0],e[1],e[2],e[3]),l.pickable!==Tf(s.pickability,w)&&(s.pickability=Cf(s.pickability,s.count,w,l.pickable))}s.verticalOffsets=v?_:null,i.offsetObb=v?(0,uf.gm)(i.obb,g,f,this._viewingMode,i.offsetObb??i.obb.clone()):null,y||v||(0,gy.E)()?(n.componentParameters=new py.em,n.componentParameters.castShadows=xy(m,s.count),n.componentParameters.transparent=xy(u,s.count),n.componentParameters.opaqueOverride=xy(p,s.count),n.componentParameters.texture=h,h.updateTexture()):(n.componentParameters=new py.Wo,n.componentParameters.castShadows=l.castShadows?py.d0.All:py.d0.None,n.componentParameters.externalColor=l.externalColor,n.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e.intersectionGeometry.getComponentAabb(t,i);const s=e,n=s.componentData.verticalOffsets;if(r||null==n)return i;const a=n[t];if(this._viewingMode===X.RT.Local||0===a)return i[2]+=a,i[5]+=a,i;const o=(0,Ar.XG)(a);return o.localOrigin=s.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const s=e,n=s.componentData,a=n.count,o=n.verticalOffsets,l=s.intersectionGeometry,h=this._viewingMode===X.RT.Local,c=l.getComponentAabbs(),d=Cy;let u=1/0,p=-1/0;for(let m=0;m<a;m++){const e=6*m,n=o?.[m]??0;let a=1/0,l=-1/0;if(h)a=c[e+2]+n+t,l=c[e+5]+n+t;else{if(d[0]=c[e],d[1]=c[e+1],d[2]=c[e+2],d[3]=c[e+3],d[4]=c[e+4],d[5]=c[e+5],0!==n){const e=(0,Ar.XG)(n);e.localOrigin=s.transform.position,e.applyToAabb(d)}const a=Math.max(Math.abs(d[3]),Math.abs(d[0])),o=Math.max(Math.abs(d[4]),Math.abs(d[1])),l=t+d[5]+i;r.expandElevationRangeValues(t+d[2],Math.sqrt(a*a+o*o+l*l)-i)}r.expandElevationRangeValues(a,l),u=Math.min(u,a),p=Math.max(p,l)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=u,this._elevationRangeCacheMax=p}intersect(e,t,i,r,s,n,a){const o=e,{transform:l}=o,{position:h}=l;return null!=s&&(s.localOrigin=h),o.intersectionGeometry.intersect(t,i,r,s,o.componentData.verticalOffsets,l,n,a)}addEdges(e,t,i,r,s){const n=e,{indices:a,positions:o}=n.intersectionGeometry,l=n.componentData.offsets;return t.addComponentObject(n,o,a,l,i,r,s)}async extractEdgeInformation(e,t,r){const s=e,n=s.componentData.visibility;if(n.allInvisible()){const{extractComponentsEdgeLocationsLayout:e}=await i.e(88824).then(i.bind(i,88824));return{buffer:e.createBuffer(0),origin:[0,0,0]}}const{indices:a,positions:o}=s.intersectionGeometry,l=s.componentData.offsets,{EdgeInputBufferLayout:h}=await i.e(25084).then(i.bind(i,25084)),c=h.createBuffer(o.length/3);(0,cf.c)(c.position.typedBuffer,o,c.position.typedBufferStride,3),(0,hf.c)(c.position,c.position,s.transform.rotationScale),this._setComponentIndices(c.componentIndex,a,l);const d=c.count,u=this._computeVisibilityIndices(a,n,l,d);return{origin:(0,E.o8)(s.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:u,indicesLength:u.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},r)}}_setComponentIndices(e,t,i){let r=0;for(let s=0;s<i.length-1;s++){const n=i[s],a=i[s+1];for(let i=n;i<a;i++){const s=t?t[i]:i;e.set(s,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let s=0;t.forEachComponentRange(((e,t)=>(s+=i[t]-i[e],!0)));const n=(0,of.iu)(e)?2===e?.BYTES_PER_ELEMENT||r<=65536?new Uint16Array(s):new Uint32Array(s):new Array(s);let a=0;return t.forEachComponentRange(((t,r)=>{const s=i[t],o=i[r];for(let i=s;i<o;i++)n[a++]=e?e[i]:i;return!0})),n}addComponentHighlight(e,t,i){const r=e.componentData,s=(0,af.tE)(r.componentHighlights,i,(()=>new Uint32Array(r.count+1)));{const e=this._activeHighlightOptions.get(i)??0;this._activeHighlightOptions.set(i,e+1)}0===s[t]++&&(r.markHighlightsDirty(),this._notifyDirty()),s[r.count]++}removeComponentHighlight(e,t,i){const{componentData:r}=e,s=r.componentHighlights.get(i);if(void 0===s)return void vy().warn("Removing non-existing highlight.");const n=s[t];if(0===n)return void vy().warn("Removing non-existing highlight.");this._removeActiveHighlight(i);const a=s[r.count];if(n>1)return s[t]=n-1,void(s[r.count]=a-1);s[t]=0,1===a?r.componentHighlights.delete(i):s[r.count]=a-1,r.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const i=this._activeHighlightOptions.get(e);if(void 0===i)vy().warn("Removing non-existing highlight.");else{const r=i-t;r<0&&vy().warn("Removing non-existing highlight."),r<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,r)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:i}=t;if(i.size>0){for(const e of i)this._removeActiveHighlight(e[0],e[1][t.count]);i.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlightOptions(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,s=r.vertices.layoutParameters,n=xt.g.createVertex(i,Ze._U.STATIC_DRAW,r.vertices.data),a=r.indices?xt.g.createIndex(i,Ze._U.STATIC_DRAW,r.indices):null,o=(0,ft.U)((0,dy.h)(s)),l=new Uint16Array(r.vertices.count);for(let m=0;m<t.count;m++){const e=t.offsets[m],i=t.offsets[m+1],s=t.materialDataIndices[m];if(null!=r.indices)for(let t=e;t<i;t++)l[r.indices[t]]=s;else for(let t=e;t<i;t++)l[t]=s}const h=xt.g.createVertex(i,Ze._U.STATIC_DRAW,l.buffer),c=new py.f5(e.transform,e.toMapSpace),d=new yy.Z(i,my.v,new Map([["data",o],["componentIndices",wy]]),new Map([["data",n],["componentIndices",h]]),a),u=new qf(d,Ze.WR.TRIANGLES,s,null!=a),p={cameraDepthSquared:.5,gpuMemoryEstimate:n.usedMemory+h.usedMemory+(null!=a?a.usedMemory:0)};return new Gf(c,u,p)}_notifyDirty(){this._renderManager.notifyDirty()}}const wy=(0,ft.U)((0,yt.BP)().u16(ut.r.COMPONENTINDEX));function xy(e,t){return e===t?py.d0.All:0===e?py.d0.None:py.d0.Some}const Cy=(0,su.vt)();class Ty{constructor(e,t,i,r,s){this.rctx=e,this.viewingMode=t,this.stippleTextures=i,this.waterTextures=r,this.markerTextures=s}get spherical(){return this.viewingMode===X.RT.Global}get doublePrecisionRequiresObfuscation(){return this.rctx.driverTest.doublePrecisionRequiresObfuscation.result}}var My=i(30466),Sy=i(69436);let Ry=class extends vt.default{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find((e=>{let{name:t}=e;return"olid"===t})),i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.clearFramebuffer(js.uY,!0,!0),this.view._stage.renderer.renderAllGeometry(gu.V.ObjectAndLayerIdColor),i.clear(Ze.NV.DEPTH|Ze.NV.STENCIL),this.view._stage.renderer.renderHUD(Sy.D.NotOccluded),t}};(0,r._)([(0,w.MZ)()],Ry.prototype,"consumes",void 0),(0,r._)([(0,w.MZ)()],Ry.prototype,"produces",void 0),Ry=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],Ry);var Ay=i(16079),Ey=i(19416);let Oy=class extends vt.default{constructor(e){super(e),this.consumes={required:[ct.InternalRenderCategory.OCCLUDED]},this.produces=ct.InternalRenderCategory.OCCLUDED,this._blit=new Ay.G(e.view._stage.renderView.techniques,Ey.d.PremultipliedAlpha)}precompile(){const e=this.view._stage.renderer;e.plugins.plugins.forAll((t=>{e.precompileSlots(t,w_.N.OCCLUDED_TERRAIN,w_.N.TRANSPARENT_OCCLUDER_MATERIAL),t.material&&e.precompileOccludedSlots(t,Dy)}))}render(e){const t=e.find((e=>{let{name:t}=e;return t===this.produces})),i=this.view._stage.renderer;let r=0;if(Py.clear(),i.plugins.plugins.forAll((e=>{e.material&&e.queryRenderOccludedState(b_.m$.OccludeAndTransparentStencil)&&(r|=b_.m$.OccludeAndTransparentStencil,Py.push(e))})),Py.length>0&&(i.renderSlots(Py,w_.N.OCCLUDER_MATERIAL),r&b_.m$.OccludeAndTransparentStencil&&this._renderAndComposite(t,.5,(()=>i.renderSlots(Py,w_.N.TRANSPARENT_OCCLUDER_MATERIAL)),!1,!1)),Py.clear(),i.plugins.plugins.forAll((e=>{if(!e.material)return;const t=e.queryRenderOccludedState(b_.m$.OccludeAndTransparent),i=e.queryRenderOccludedState(b_.m$.Transparent),s=e.queryRenderOccludedState(b_.m$.Opaque);(t||i||s)&&(r|=t?b_.m$.OccludeAndTransparent:i?b_.m$.Transparent:b_.m$.Opaque,Py.push(e))})),r|=i.plugins.renderOccludedFlags,!r)return t;for(const s of Dy)r&s&&this._renderAndComposite(t,s===b_.m$.Opaque?1:.5,(()=>i.renderOccludedSlots(Py,s)),!0,bt.dd.OutlineVisualElementMask);return Py.clear(),t}_renderAndComposite(e,t,i,r,s){const n=this.renderingContext,{width:a,height:o}=e.fbo,l=this.fboCache.acquire(a,o,"tmp color"),h=r?this.fboCache.acquireDepth(bg.z.DEPTH_STENCIL_TEXTURE,a,o,"tmp depth"):e.getAttachment(Ze.nI);l.attachDepth(h),n.bindFramebuffer(l.fbo),n.clearFramebuffer(js.uY,r,s),i(),l.detachDepth(),this._blit.blend(n,l,e,this.bindParameters,t),r&&h.release(),l.release()}};(0,r._)([(0,w.MZ)()],Oy.prototype,"consumes",void 0),(0,r._)([(0,w.MZ)()],Oy.prototype,"produces",void 0),Oy=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],Oy);const Py=new oo.A,Dy=[b_.m$.OccludeAndTransparent,b_.m$.Transparent,b_.m$.Opaque];var Iy=i(59450);class Ly extends We.w{constructor(e,t){super(e,t,new Be.$(Iy.a,(()=>i.e(14663).then(i.bind(i,14663)))))}initializePipeline(){return(0,je.Ey)({blending:(0,je.p3)(Ze.dn.ONE,Ze.dn.ZERO,Ze.dn.ONE_MINUS_SRC_COLOR,Ze.dn.ONE),depthTest:{func:Ze.MT.ALWAYS},colorWrite:je.kn})}}var Ny=i(1824);class Hy extends _g.U{constructor(){super(...arguments),this.hazeStrength=1}}class Fy extends We.w{constructor(e,t){super(e,t,new Be.$(Ny.H,(()=>i.e(2983).then(i.bind(i,2983)))))}initializePipeline(e){return e.reduced?(0,je.Ey)({blending:je.fg,depthTest:{func:Ze.MT.ALWAYS},colorWrite:je.kn}):(0,je.Ey)({blending:(0,je.p3)(Ze.dn.ONE,Ze.dn.ZERO,Ze.dn.ONE_MINUS_SRC_COLOR,Ze.dn.ONE),colorWrite:je.kn})}}class Vy extends Em.K{constructor(){super(...arguments),this.reduced=!1}}(0,r._)([(0,Em.W)()],Vy.prototype,"reduced",void 0);let Uy=class extends Pg{constructor(e){super(e),this._compositingPassParameters=new Iy.H,this._passParameters=new Hy,this._hazeConfiguration=new Vy,this._vao=null,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view._stage.renderView.techniques;t.precompile(Fy,new Vy);const i=new Vy;i.reduced=!0,t.precompile(Fy,i),t.precompile(Ly)}initialize(){this.addHandles([(0,g.watch)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),g.syncAndInitial),(0,g.watch)((()=>this.view._stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>this._fade(e)),g.syncAndInitial),(0,g.watch)((()=>this.view.environment.weather.type),(e=>this._newAmount="rainy"===e?0:1),g.syncAndInitial),(0,g.watch)((()=>this.view._stage.renderer?.fullResolutionAtmosphere),(e=>this._hazeConfiguration.reduced=!e),g.syncAndInitial)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:(0,de.Cc)(this._oldAmount,this._newAmount,e)}destroy(){this._vao=(0,p.WD)(this._vao)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.TRANSPARENT_ENVIRONMENT}));if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=(0,qm.Q7)(i,qm.PE.Pos2Tex);const r=this.techniques.get(Fy,this._hazeConfiguration);if(!r.compiled)return t;const s=t.getAttachment(i.gl.DEPTH_STENCIL_ATTACHMENT);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(s),t;const n=this.techniques.get(Ly);if(!n.compiled)return t;const a=i.getViewport(),o=this.camera,l=(0,Me.l)(o.eye)-ue.$O.radius;let h;const c=ue.$O.atmosphereHeight;if(l<c){const e=Math.min(1,Math.max(0,l/c));h=(0,de.Cc)(.4,.5,e)}else{const e=Math.min(1,Math.max(0,(l-c)/(15*c)));h=(0,de.Cc)(.5,1,e)}const d=(0,Wd.Mv)(Math.round(h*o.fullViewport[2])),u=(0,Wd.Mv)(Math.round(h*o.fullViewport[3]));i.setViewport(0,0,d,u);const p=this.fboCache.acquire(d,u,"haze",bg.N.RGBA);return i.bindFramebuffer(p.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=p.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(s),p.release(),t}_renderCommon(e){null!=this._vao&&(e.bindVAO(this._vao),e.drawArrays(Ze.WR.TRIANGLE_STRIP,0,4))}_update(){const e=this.bindParameters.camera,t=(0,Me.k)(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],s=(0,de.qE)((i-this._passParameters.radii[0])/ue.$O.atmosphereHeight,0,1);(0,Zs.s)(this._passParameters.heightParameters,i,t,r,s);const n=this.view.basemapTerrain?.getLowerBoundRadius()??0;(0,ze.hZ)(this._passParameters.radii,n,n+ue.$O.atmosphereHeight),this._passParameters.hazeStrength=(0,de.Cc)((0,de.Cc)(.6,1,(0,de.TF)(9500,10500,i-ue.$O.radius)),1,this._amount)}};Uy=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.haze.Haze")],Uy);var zy=i(17992),Gy=i(53769),qy=i(43444);class ky extends Gy.QR{constructor(){super(...arguments),this.shadowColor=(0,js.fA)(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class By extends We.w{constructor(e,t){super(e,t,new Be.$(qy.S,(()=>i.e(65108).then(i.bind(i,65108))))),this.primitiveType=Ze.WR.TRIANGLE_STRIP}initializePipeline(){return(0,je.Ey)({blending:je.Ky,colorWrite:je.kn,depthTest:null,depthWrite:null})}}const Wy=1/512;let Zy=class extends vt.default{constructor(e){super(e),this.produces=ct.RenderCategory.COMPOSITE,this.consumes={required:[ct.RenderCategory.COMPOSITE,"highlights"]},this._passParameters=new ky,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([(0,g.watch)((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??wh.Ps,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??wh.d2,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=(0,mg.QP)(e??wh.xc),this._ensureMaxOpacity()}),g.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(bt.C7.UPDATE)}precompile(){this.techniques.precompile(By)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.RenderCategory.COMPOSITE})),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;const r=this.techniques.get(By);if(r.compiled){this._passParameters.highlight=e.find((e=>{let{name:t}=e;return"highlights"===t}))?.getTexture(),this._passParameters.origin=i.camera.center;const s=this.renderingContext;s.bindFramebuffer(t.fbo),s.bindTechnique(r,i,this._passParameters),s.screen.draw()}else this.requestRender(bt.C7.UPDATE);return t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-(0,de.TF)(4e4,5e4,e.relativeElevation);const i=this.viewingMode===X.RT.Global?(0,Me.n)(jy,e.center):(0,Me.i)(jy,0,0,1),r=(0,Me.f)(i,t);return this._passParameters.dayNightTerminator=(0,de.TF)(0,1,(0,de.qE)(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=Wy}};(0,r._)([(0,w.MZ)()],Zy.prototype,"produces",void 0),(0,r._)([(0,w.MZ)()],Zy.prototype,"consumes",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],Zy.prototype,"viewingMode",void 0),Zy=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],Zy);const jy=(0,E.vt)();var $y=i(72538),Qy=i(98160);class Yy extends We.w{constructor(e,t){super(e,t,new Be.$(Qy.a,(()=>i.e(49136).then(i.bind(i,49136)))))}initializePipeline(){return(0,je.Ey)({blending:je.Os,depthTest:null,depthWrite:null,colorWrite:je.kn})}}var Xy=i(15862);let Ky=class extends vt.default{constructor(){super(...arguments),this.produces=ct.InternalRenderCategory.MAGNIFIER,this.consumes={required:[ct.InternalRenderCategory.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new Qy.M,this._vao=null,this._magnifier=null,this._tmpScreenPoint=(0,y.gs)(),this._tmpRenderPoint=(0,y.QG)()}initialize(){this.addHandles([(0,g.watch)((()=>this.view.magnifier),(e=>this._update(e)),g.syncAndInitial)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces=ct.InternalRenderCategory.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles((0,g.watch)((()=>this._magnifier?.version),t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=(0,p.WD)(this._vao)}_disposeTextures(){this._passParameters.mask=(0,p.WD)(this._passParameters.mask),this._passParameters.overlay=(0,p.WD)(this._passParameters.overlay),this._passParameters.input=(0,p.WD)(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(Yy)}render(e){const t=this._validMagnifier,i=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.MAGNIFIER}));if(null==t)return i;if(null==this._imageSources)return this.requestRender(bt.C7.UPDATE),i;const r=this.renderingContext,s=this.camera.pixelRatio,n=Math.ceil(s*t.size);this._vao??=(0,qm.Q7)(r,qm.PE.Pos2,qg.D,0,1);const a=this.techniques.get(Yy);if(this._ensureTextureResources(r,n),!a.compiled||!this._passParameters.input)return this.requestRender(bt.C7.UPDATE),i;const o=Math.ceil(1/this._factor*n),l=this._passParameters.input;l.resize(o,o),(0,y.WA)(t.position,this._tmpScreenPoint);const h=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),c=this.camera.fullWidth,d=this.camera.fullHeight,u=.5*o,p=.5*o;h[0]=(0,de.qE)(h[0],u,c-u-1),h[1]=(0,de.qE)(h[1],p,d-p-1);const m=Math.floor(h[0]-u),_=Math.floor(h[1]-p);return r.bindFramebuffer(i.fbo),a.program.bindTexture("textureInput",l),r.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,m,_,o,o,0),this._passParameters.magnifier=t,r.bindTechnique(a,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(Ze.WR.TRIANGLE_STRIP,0,4),i}_loadResources(e){const{maskUrl:t,overlayUrl:i}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:(0,re.UT)((async e=>{const r=null==t||null==i?(0,Xy.u)(e):null,s=null!=t?(0,$y.D)(t,{signal:e}):r.then((e=>e.mask)),n=null!=i?(0,$y.D)(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await n}}))})}_ensureTextureResources(e,t){if(null==this._imageSources||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)return;this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t;const i=new et.R;i.internalFormat=Ze.Ab.RGBA,i.wrapMode=Ze.pF.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!(0,Ec.isSVG)(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new km.g(e,i,this._imageSources.overlay),i.pixelFormat=i.internalFormat=Ze.Ab.ALPHA,i.preMultiplyAlpha=!1,this._passParameters.mask=new km.g(e,i,this._imageSources.mask),i.pixelFormat=i.internalFormat=Ze.Ab.RGBA,i.flipped=!1,this._passParameters.input=new km.g(e,i)}};(0,r._)([(0,w.MZ)()],Ky.prototype,"produces",void 0),(0,r._)([(0,w.MZ)()],Ky.prototype,"consumes",void 0),(0,r._)([(0,w.MZ)()],Ky.prototype,"_imageSources",void 0),(0,r._)([(0,w.MZ)()],Ky.prototype,"_imageLoadTask",void 0),Ky=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],Ky);var Jy=i(48782);class ev extends We.w{constructor(e,t){super(e,t,new Be.$(Jy.B,(()=>i.e(37806).then(i.bind(i,37806)))))}initializePipeline(){return(0,je.Ey)({colorWrite:je.kn})}}var tv=i(22301);class iv extends We.w{constructor(e,t){super(e,t,new Be.$(tv.B,(()=>i.e(58717).then(i.bind(i,58717)))))}initializePipeline(){return(0,je.Ey)({colorWrite:je.kn})}}var rv=i(21628);class sv extends We.w{constructor(e,t){super(e,t,new Be.$(rv.E,(()=>i.e(72636).then(i.bind(i,72636)))))}initializePipeline(){return(0,je.Ey)({colorWrite:je.kn})}}class nv extends pt.Y{}let av=class extends vt.default{constructor(e){super(e),this.produces="disabled",this.consumes={required:[ct.InternalRenderCategory.ANTIALIASING],optional:[ct.RenderCategory.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new nv}initialize(){this.addHandles([(0,g.watch)((()=>this.isEnabled()),(e=>e?this.enable():this.disable()),g.syncAndInitial)])}async enable(){if(this.produces=ct.InternalRenderCategory.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await i.e(22117).then(i.bind(i,22117));await this._loadTextures(t,e),this.requestRender(bt.C7.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){(0,_.throwIfAborted)(t);const[i,r]=await Promise.allSettled([(0,$y.D)(e.areaTexture,{signal:t}),(0,$y.D)(e.searchTexure,{signal:t})]);if((0,_.throwIfAborted)(t),"fulfilled"!==i.status||"fulfilled"!==r.status)return;const s=this.renderingContext;this._areaTexture=ov(s,Ze.Cj.LINEAR,Ze.Ab.RGB,i.value),this._searchTexture=ov(s,Ze.Cj.NEAREST,Ze.Ab.LUMINANCE,r.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=(0,p.WD)(this._searchTexture),this._areaTexture=(0,p.WD)(this._areaTexture)}precompile(){this.techniques.precompile(sv),this.techniques.precompile(ev),this.techniques.precompile(iv)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.ANTIALIASING}));if(!this._areaTexture||!this._searchTexture)return this.requestRender(bt.C7.UPDATE),t;const i=this.techniques.get(sv),r=this.techniques.get(ev),s=this.techniques.get(iv);if(!i.compiled||!r.compiled||!s.compiled)return this.requestRender(bt.C7.UPDATE),t;const n=e.find((e=>{let{name:t}=e;return t===ct.RenderCategory.COMPOSITE}));if(!n)return t;const a=n.fbo.width,o=n.fbo.height,l=this.renderingContext;l.setViewport(0,0,a,o);const h=this.fboCache.acquire(a,o,"smaa edges",bg.N.RG);l.bindFramebuffer(h.fbo),l.setClearColor(0,0,0,1),l.clear(Ze.NV.COLOR),this._smaaParameters.color=n.getTexture();const c=this.bindParameters;l.bindTechnique(i,c,this._smaaParameters),l.screen.draw();const d=this.fboCache.acquire(a,o,"smaa blend");return l.bindFramebuffer(d.fbo),l.setClearColor(0,0,1,1),l.clear(Ze.NV.COLOR),this._smaaParameters.inputTexture=h.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(r,c,this._smaaParameters),l.screen.draw(),h.release(),l.bindFramebuffer(t.fbo),l.setClearColor(0,1,0,1),l.clear(Ze.NV.COLOR),this._smaaParameters.inputTexture=d.getTexture(),l.bindTechnique(s,c,this._smaaParameters),l.screen.draw(),d.release(),t}};function ov(e,t,i,r){const s=new et.R;return s.pixelFormat=i,s.wrapMode=Ze.pF.CLAMP_TO_EDGE,s.width=r.width,s.height=r.height,s.samplingMode=t,new km.g(e,s,r)}(0,r._)([(0,w.MZ)()],av.prototype,"produces",void 0),(0,r._)([(0,w.MZ)()],av.prototype,"consumes",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],av.prototype,"isEnabled",void 0),(0,r._)([(0,w.MZ)()],av.prototype,"_abortController",void 0),av=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.smaa.SMAA")],av);var lv=i(99570),hv=i(21772),cv=i(5655);class dv extends pt.Y{constructor(){super(...arguments),this.modelMatrix=(0,Ue.vt)()}}class uv extends We.w{constructor(e,t){super(e,t,new Be.$(cv.S,(()=>i.e(19341).then(i.bind(i,19341)))))}initializePipeline(){return(0,je.Ey)({blending:je.Ky,depthTest:{func:Ze.MT.LEQUAL},colorWrite:je.kn})}}let pv=class extends wg{constructor(){super(...arguments),this._starData=null,this._loadDataTask=null,this._numPoints=0,this._passParameters=new dv}initialize(){this.addHandles([(0,g.watch)((()=>this.view.environment.starsEnabled),(e=>e?this._enable():this._disable()),g.initial),(0,g.watch)((()=>"virtual"===this.view.environment.lighting.type?null:this.view.environment.lighting.date),(e=>this._update(e)),g.syncAndInitial)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=(0,p.DC)(this._loadDataTask),this._numPoints=0,this._vao=(0,p.WD)(this._vao),this._starData=null}precompile(){this.techniques.precompile(uv)}render(e){const t=e.find((e=>{let{name:t}=e;return t===ct.InternalRenderCategory.OPAQUE_ENVIRONMENT})),i=this.renderingContext;if(this.loading)return this.requestRender(bt.C7.UPDATE),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,i);const r=this.techniques.get(uv);return r.compiled?(i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ze.WR.POINTS,0,this._numPoints),t):(this.requestRender(bt.C7.UPDATE),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/vv,function(e,t,i,r){const s=bv.createBuffer(r),n=s.position,a=s.color,o=s.size;for(let l=0;l<r;l++){const e=t[2*l],r=t[2*l+1];n.set(l,0,-Math.cos(e)*Math.sin(r)),n.set(l,1,-Math.sin(e)*Math.sin(r)),n.set(l,2,-Math.cos(r));const s=_v(i[l]),h=mv(gv[s[1]]);a.set(l,0,255*h[0]),a.set(l,1,255*h[1]),a.set(l,2,255*h[2]),a.set(l,3,255),o.set(l,s[0])}return new wt.Z(e,qg.D,new Map([["geometry",(0,ft.U)(bv)]]),new Map([["geometry",xt.g.createVertex(e,Ze._U.STATIC_DRAW,s.buffer)]]))}(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*function(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}(e),r=(0,Ve.C)(this._passParameters.modelMatrix,yv);(0,Ve.Qr)(r,r,-i*Math.PI),(0,Ve.lw)(r,fv,r),(0,Ve.Qr)(r,r,-t*Math.PI),this.requestRender(bt.C7.UPDATE)}_createLoadDataTask(){if(this._starData)return null;const e=(0,re.UT)((async e=>{const{data:t}=await(0,hv.N)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});(function(e){if(!e)throw new l.default("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/vv;if(t%1!=0||t>5e4||t<5e3)throw new l.default("stars:invalid-data","Failed to create stars because star catalogue data is invalid")})(t),this._starData=t}));return e.promise.catch((e=>{(0,_.isAbortError)(e)||u.A.getLogger(this).error(e)})).then((()=>{this.destroyed||this.requestRender(bt.C7.UPDATE)})),e}};function mv(e){return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}function _v(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}pv=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.effects.stars.Stars")],pv);const gv=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],fv=(0,Ue.fA)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),yv=(0,Ue.fA)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),vv=9,bv=(0,yt.BP)().vec3f(ut.r.POSITION).vec4u8(ut.r.COLOR).f32(ut.r.SIZE);var wv=i(29072),xv=i(8696),Cv=i(12151);class Tv extends We.w{constructor(e,t){super(e,t,new Be.$(Cv.a,(()=>i.e(88727).then(i.bind(i,88727)))))}initializePipeline(){return(0,je.Ey)({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}class Mv{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new Ey.N,this._passParameters=new wv.C,this._hudParameters=new Cv.H,this._configuration.blitMode=Ey.d.PremultipliedAlpha,this._techniques.precompile(xv.N,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(xv.N,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=Ey.d.Alpha,this._techniques.precompile(xv.N,this._configuration),this._configuration.blitMode=Ey.d.Depth,this._techniques.precompile(xv.N,this._configuration),this._techniques.precompile(Tv)}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniques.get(Tv);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this._composite(e,t,Ey.d.PremultipliedAlpha,i)}composite(e,t){this._composite(e,t,Ey.d.Alpha,1)}blitDepthToLinearDepth(e,t){this._composite(e,t,Ey.d.Depth,1)}_composite(e,t,i,r){this._configuration.blitMode=i,this._configuration.hasOpacityFactor=1!==r,this._passParameters.texture=t,this._passParameters.opacity=r;const s=this._techniques.get(xv.N,this._configuration);this._rctx.bindTechnique(s,e,this._passParameters),this._rctx.screen.draw()}}var Sv=i(20907),Rv=i(57942);class Av{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new nm.XP(new ArrayBuffer(4)),this._layerToOidToColor=new Rv.O,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Rv.O,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,r,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;e&&t&&i&&r&&(this._layerUidToId.set(r,i),this._layerUidToPopupEnabled.set(r,s),s&&this._layerUidToGraphicsUidToObjectId.set(r,t,{objectId:e,attributeNodeId:n,attributeIndex:a,subLayerId:o}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return(0,js.fA)(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;const t=this._layerUidToPopupEnabled.get(e.layerUid);if(void 0===t)return this.colorZero;if(!1===t)return this.colorZero;const i=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid)?.objectId;if(!i)return this.colorZero;let r=this._layerToOidToColor.get(e.layerUid,i);if(!r){if((0,d.A)("enable-feature:objectAndLayerId-screenshot-testing"))r=i;else for(;!r;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(r=e)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,i,r),this._colorToUID.set(r,e)}const s=new ArrayBuffer(4);return new DataView(s).setUint32(0,r,!1),new nm.XP(s)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const r=this._layerUidToGraphicsUidToObjectId.get(i.layerUid,i.graphicUid),s=this._layerUidToId.get(i.layerUid);r&&s&&e.set(t,r.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:r.objectId,lid:s,attrId:r.attributeNodeId,attrIdx:r.attributeIndex,subLayerId:r.subLayerId}:{type:"object-and-layer-id",olid:r.objectId,lid:s})}return e}}i(39466),i(77751),i(21965);var Ev=i(1021),Ov=i(22682);class Pv extends Ov.H{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get cachedMemory(){return this.attachment.usedMemory}}class Dv extends Pv{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=Ov.w.COLOR}}class Iv extends Pv{constructor(){super(...arguments),this.type=Ov.w.DEPTH}}var Lv=i(32704);class Nv{constructor(e,t){this._last=new oo.A,this._incarnation=0,this._cache=new xd(e,t)}destroy(){this._last?.forAll((e=>e.dispose())),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new oo.A:e||(this._last?.forAll((e=>e.dispose())),this._last=null)}clean(){this._last?.filterInPlace((e=>!(e.incarnation<this._incarnation)||(this._cache.put(e.key,e),!1)))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find((t=>t.key===e));if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce(((e,t)=>e+t.cachedMemory),0)??0}}var Hv=i(97306);class Fv{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new Nv(e.newCache,"FBOCache"),this._depthCache=new Nv(e.newCache,"DepthAttachmentCache"),this._colorCache=new Nv(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach((t=>t.type===Ov.w.FBO&&e(t.name,t.fbo,t.numberOfColorAttachments)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>e+("getTexture"in t?t.getTexture()?.usedMemory??0:t.cachedMemory)),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:bg.N.RGBA;const s=Uv(r,e,t);let n=this._cache.pop(s);if(n){n.retain(),n.setName(i);const e=this.rctx.getBoundFramebufferObject();if(this.rctx.bindFramebuffer(n.fbo),this.rctx.setDrawBuffers([Ze.Nm.COLOR_ATTACHMENT0]),!n.fbo)throw new l.default("attempt to use a not existing framebuffer");this.rctx.unbindTexture(n.fbo.colorTexture),this.rctx.bindFramebuffer(e)}else n=new Lv.default(s,i,new Je.H(this.rctx,{...jv[r],width:e,height:t}),(e=>{e??=bg.z.DEPTH_STENCIL_TEXTURE;const t=this._acquireDepth(e,n.fbo.width,n.fbo.height,`${n.name} depth`);return n.attachDepth(t),t.release(),n}),((i,r,s)=>{r??=bg.N.RGBA;const a=this._acquireColor(r,e,t,s??`${n.name} color ${i}`);return this.rctx.unbindTexture(a.attachment),n.attachColor(a,i),a.release(),n}),(()=>{this.debugCallback?.(n.name,n.fbo,n.numberOfColorAttachments),this._acquired.delete(n),n.detachAll(),this._cache.put(n)}));return this._trackHandle(n)}acquireDepth(e,t,i,r){return this._acquireDepth(e,t,i,r)}_acquireDepth(e,t,i,r){const s=Uv(e,t,i),n=this._depthCache.pop(s);if(n)return n.retain(),n.name=r,this._trackHandle(n);const a=e===bg.z.DEPTH_STENCIL_TEXTURE?new Iv(s,new km.g(this.rctx,{...Qv[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._depthCache.put(a)})):new Iv(s,new Hv.l(this.rctx,{...Qv[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._depthCache.put(a)}));return a.name=r,this._trackHandle(a)}_acquireColor(e,t,i,r){const s=Uv(e,t,i),n=this._colorCache.pop(s);if(n)return n.retain(),n.name=r,this._trackHandle(n);const a=new Dv(s,new km.g(this.rctx,{...jv[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._colorCache.put(a)}));return a.name=r,this._trackHandle(a)}_trackHandle(e){return this._acquired.add(e),e}}const Vv=new Lv.default("default","default",null,(()=>Vv),(()=>Vv),(()=>{}));function Uv(e,t,i){return`${e}x${t}x${i}`}Vv.release=()=>!1;const zv=new et.R;zv.pixelFormat=Ze.Ab.RED,zv.internalFormat=Ze.H0.R8,zv.wrapMode=Ze.pF.CLAMP_TO_EDGE;const Gv=new et.R;Gv.pixelFormat=Ze.Ab.RG,Gv.internalFormat=Ze.H0.RG8,Gv.wrapMode=Ze.pF.CLAMP_TO_EDGE;const qv=new et.R;qv.internalFormat=Ze.H0.RGBA4,qv.dataType=Ze.ld.UNSIGNED_SHORT_4_4_4_4,qv.wrapMode=Ze.pF.CLAMP_TO_EDGE;const kv=new et.R;kv.wrapMode=Ze.pF.CLAMP_TO_EDGE;const Bv=new et.R;Bv.wrapMode=Ze.pF.CLAMP_TO_EDGE,Bv.samplingMode=Ze.Cj.LINEAR_MIPMAP_LINEAR,Bv.hasMipmap=!0,Bv.maxAnisotropy=8;const Wv=new et.R;Wv.pixelFormat=Ze.Ab.RED,Wv.dataType=Ze.ld.HALF_FLOAT,Wv.internalFormat=Ze.H0.R16F,Wv.samplingMode=Ze.Cj.NEAREST;const Zv=new et.R;Zv.dataType=Ze.ld.HALF_FLOAT,Zv.internalFormat=Ze.H0.RGBA16F,Zv.samplingMode=Ze.Cj.NEAREST;const jv={[bg.N.RED]:zv,[bg.N.RG]:Gv,[bg.N.RGBA4]:qv,[bg.N.RGBA]:kv,[bg.N.RGBA_MIPMAP]:Bv,[bg.N.R16F]:Wv,[bg.N.RGBA16F]:Zv},$v=new et.R;$v.pixelFormat=Ze.Ab.DEPTH_STENCIL,$v.dataType=Ze.ld.UNSIGNED_INT_24_8,$v.samplingMode=Ze.Cj.NEAREST,$v.wrapMode=Ze.pF.CLAMP_TO_EDGE,$v.internalFormat=Ze.Ab.DEPTH24_STENCIL8;const Qv={[bg.z.DEPTH_STENCIL_TEXTURE]:$v,[bg.z.DEPTH16_BUFFER]:new Um.q(Ze.yQ.DEPTH_COMPONENT16,4)};var Yv,Xv=i(96013),Kv=i(86836);!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(Yv||(Yv={}));class Jv{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Yv.FrontToBack;this._rctx=e,this._techniques=t,this._sorting=i,this._draws=new oo.A({allocator:e=>e??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,s){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=i,n.material=e,n.depthSquaredHint=r,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,n.highlightName=s}acquire(e,t){return this._draws.map((i=>i.material.acquireTechnique(this._techniques,e,t,i.geometry.parameters)))}dispatch(e,t,i){const r=this._rctx;this._previouslyBoundDraw.clear();let s=null;const n=this._draws.length,a=t.highlight?.name;for(let o=0;o<n;o++){const n=this._draws.data[o];if(e.identifier===Xv.z.Highlight){const e=n.highlightName;if(e){if(e!==a)continue}else if(!a||!t.overlay?.hasHighlightOptions(a))continue}const l=i[o];l===s&&t.oitPass===Kv.Y.NONE||(r.bindTechnique(l,t,e),s=l);const{geometryRanges:h,indexType:c,geometry:d,material:u}=n;r.bindVAO(d.vao),this._previouslyBoundDraw.get(l)!==u&&(l.program.bindDraw(t,e,u),this._previouslyBoundDraw.set(l,u));const p=h.length,{primitiveType:m}=d;for(let e=0;e<p;e+=2){const t=h[e],i=h[e+1];if(0!==c){const e=eb.get(c);r.drawElements(m,i,c,t*e)}else r.drawArrays(m,t,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===Yv.FrontToBack?1:-1;this._draws.sort(((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==r?r:t.geometry.vao.byteSize-i.geometry.vao.byteSize}))}get count(){return this._draws.length}}const eb=new Map;eb.set(Ze.pe.UNSIGNED_BYTE,1),eb.set(Ze.pe.UNSIGNED_SHORT,2),eb.set(Ze.pe.UNSIGNED_INT,4);var tb=i(8375);class ib{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new Jv(t,i),this.transparent=new Jv(t,i,Yv.BackToFront),this.integratedMesh=new Jv(t,i),this.shadowMap=new Jv(t,i),this.highlight=new Jv(t,i),this.highlightIntegratedMesh=new Jv(t,i),this.highlightShadowMap=new Jv(t,i),this.viewshedShadowMap=new Jv(t,i),this.nonHighlightShadowMap=new Jv(t,i)}}class rb extends tb.Zo{constructor(){super(...arguments),this.slicePlaneLocalOrigin=(0,E.vt)(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}}class sb extends rb{constructor(){super(...arguments),this.identifier=Xv.z.Material,this.output=gu.V.Color,this.transparent=!1}}class nb extends rb{constructor(){super(...arguments),this.identifier=Xv.z.ShadowMap}}class ab extends rb{constructor(){super(...arguments),this.identifier=Xv.z.Highlight}}class ob extends rb{constructor(){super(...arguments),this.identifier=Xv.z.ViewshedShadowMap}}var lb=i(18560);let hb=class extends Et.RW{constructor(){super({}),this.produces=new Map([[w_.N.OPAQUE_MATERIAL,e=>this._produces(e,w_.N.OPAQUE_MATERIAL)],[w_.N.TRANSPARENT_MATERIAL,e=>this._produces(e,w_.N.TRANSPARENT_MATERIAL)],[w_.N.INTEGRATED_MESH,e=>this._produces(e,w_.N.INTEGRATED_MESH)]]),this._materialPassParameters=new sb,this._shadowPassParameters=new nb,this._highlightPassParameters=new ab,this._viewshedPassParameters=new ob,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new ib(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,(e=>e.count>0))}prepareRender(e){if(0!==this._systems.size&&null!=this._passes){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((t=>t.submit(this._passes,e.bind)));for(const e of Object.values(this._passes))e.finishSubmit()}}acquireTechniques(e){if(0===this._systems.size)return null;const t=e.output===gu.V.Shadow||e.output===gu.V.ShadowHighlight||e.output===gu.V.ShadowExcludeHighlight?this._shadowPassParameters:e.output===gu.V.ViewshedShadow?this._viewshedPassParameters:e.output===gu.V.Highlight?this._highlightPassParameters:this._materialPassParameters,i=e.bind;return this._updateParameters(i.camera,t,i.slot===w_.N.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,((t,i)=>t.acquire(i,e.bind)))}render(e,t){this._invoke(e.output,e.bind.slot,((i,r)=>i.dispatch(r,e.bind,t)))}_invoke(e,t,i){if(null==this._passes)return null;switch(t){case w_.N.OPAQUE_MATERIAL:switch(e){case gu.V.Color:case gu.V.ColorEmission:case gu.V.Depth:case gu.V.Normal:case gu.V.ObjectAndLayerIdColor:return i(this._passes.opaque,this._materialPassParameters);case gu.V.Highlight:return i(this._passes.highlight,this._highlightPassParameters);case gu.V.Shadow:return i(this._passes.shadowMap,this._shadowPassParameters);case gu.V.ShadowHighlight:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case gu.V.ShadowExcludeHighlight:return i(this._passes.nonHighlightShadowMap,this._shadowPassParameters);case gu.V.ViewshedShadow:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case w_.N.TRANSPARENT_MATERIAL:switch(e){case gu.V.Color:case gu.V.ColorEmission:case gu.V.Depth:case gu.V.Normal:case gu.V.ObjectAndLayerIdColor:return i(this._passes.transparent,this._materialPassParameters)}break;case w_.N.INTEGRATED_MESH:switch(e){case gu.V.Color:case gu.V.ColorEmission:case gu.V.Depth:case gu.V.Normal:case gu.V.ObjectAndLayerIdColor:return i(this._passes.integratedMesh,this._materialPassParameters);case gu.V.Highlight:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new kf.d;return this._systems.forEach((i=>t.union(i.queryDepthRange(e)))),t}get hasEmissions(){let e=!1;return this._systems.forEach((t=>e=t.hasEmissions||e)),e}_updateParameters(e,t,i){const r=e.viewInverseTransposeMatrix;(0,Me.i)(cb,r[3],r[7],r[11]),ub.set(cb),(0,Me.c)(t.transformWorldFromViewTH,ub.high),(0,Me.c)(t.transformWorldFromViewTL,ub.low),(0,Me.c)(t.slicePlaneLocalOrigin,cb),(0,Fe.z0)(t.transformViewFromCameraRelativeRS,e.viewMatrix),(0,Ve.C)(t.transformProjFromView,e.projectionMatrix),t.identifier===Xv.z.Material&&(this._materialPassParameters.transparent=i,(0,Fe.mg)(db,t.transformViewFromCameraRelativeRS),(0,Fe.B8)(t.transformNormalViewFromGlobal,db))}hasHighlightOptions(e){for(const t of this._systems)if(t.hasHighlightOptions(e))return!0;return!1}};hb=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],hb);const cb=(0,E.vt)(),db=(0,ki.vt)(),ub=new lb.p;var pb=i(50508);var mb=i(24591);class _b{constructor(e){this._context=e,this._nodes=new oo.A}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),mb.Ns&&console.log(`Registered render nodes: ${this._nodes.map((e=>{let{declaredClass:t}=e;return t})).join(", ")}`)}remove(e){this._nodes.remove(e),mb.Ns&&console.log(`Registered render nodes: ${this._nodes.map((e=>{let{declaredClass:t}=e;return t})).join(", ")}`)}produces(e){return this._nodes.some((t=>{let{produces:i}=t;return i===e}))}require(e){const t=this._nodes,i=i=>t.reduce(((t,r)=>{let{consumes:s,produces:n}=r;return t+(!s.required.includes(e)||null!=i&&n!==i?0:1)}),0);for(var r=arguments.length,s=new Array(r>1?r-1:0),n=1;n<r;n++)s[n-1]=arguments[n];return 0===s.length?i():s.reduce(((e,t)=>e+i(t)),0)}optional(e){const t=this._nodes,i=i=>t.reduce(((t,r)=>{let{consumes:s,produces:n}=r;return t+(!s.optional?.includes(e)||null!=i&&n!==i?0:1)}),0);for(var r=arguments.length,s=new Array(r>1?r-1:0),n=1;n<r;n++)s[n-1]=arguments[n];return 0===s.length?i():s.reduce(((e,t)=>e+i(t)),0)}updateAnimation(e){return this._nodes.reduce(((t,i)=>i.updateAnimation(e)||t),!1)}precompile(){++this._context.techniques.precompiling;for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(const r of t)this._nodes.forEach((e=>{e.produces===r&&e.precompile()}));--this._context.techniques.precompiling}render(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>{};const r=e.name,s=this._nodes.filter((e=>{let{produces:t}=e;return t===r}));return 0===s.length?function(e){return e.name}(e)?e:Vv:(s.forEach((n=>{const a=[e];for(const e of n.consumes.required){if(e===r)continue;const s=t.get(e);if(s)a.push(s);else if("emissive"!==e||!t.get(r)?.hasAttachment(e))return void(i&&i(a))}if(n.consumes.optional)for(const e of n.consumes.optional){if(e===r)continue;const i=t.get(e);i&&a.push(i)}try{const i=n.doRender(a);i&&i!==e&&(r!==i.name&&(u.A.getLogger(n).errorOnce(`RenderNode produced ${i.name}, expected ${r}`),i.setName(r)),e.release(),e=i,t.set(r,e))}catch(s){u.A.getLogger(n).errorOnce(s)}i&&i(a)})),this._context.rctx.enforceState(),e)}requireGeometryDepth(){return this._nodes.some((e=>"disabled"!==e.produces&&e.requireGeometryDepth))}get test(){return{nodes:this._nodes}}}class gb{constructor(e){this.context=e,this._renderPlugins=new oo.A,this._slots=new Array,this._version=(0,Oe.v)(0);for(let t=0;t<w_.N.MAX_SLOTS;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach((e=>e.destroy())),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),(0,_.createAbortError)();this._renderPlugins.push(e),e.produces.forEach(((t,i)=>this._slots[i].push(e))),this.context.requestRender(),this._version.value++},r=e.initializeRenderContext(this.context,t);if((0,_.isPromiseLike)(r))return r.then(i);i()}remove(e){this._renderPlugins.removeUnordered(e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((t=>t!==e));this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((i=>t=i.updateAnimation?.(e)||t)),t}precompile(){++this.context.techniques.precompiling;const e=this.context.renderContext.bind.slot;for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];for(const s of i)this.context.renderContext.bind.slot=s,this._forEachRender((()=>{}));this.context.renderContext.bind.slot=e,--this.context.techniques.precompiling}render(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];for(const s of i)this.context.renderContext.bind.slot=s,this._forEachRender(((t,i)=>t.render(this.context.renderContext,i,e)))}_forEachRender(e){const t=this.context.renderContext.bind.slot,i=this.context.renderContext.output;this._slots[t].forEach((r=>{const s=r.produces.get(t);if(!s?.(i)||r.isDecoration&&!this.context.renderContext.bind.decorations)return;const n=r.acquireTechniques(this.context.renderContext);n&&e(r,n)}))}queryDepthRange(e){const t=new kf.d;return this._renderPlugins.forAll((i=>{const r=i.queryDepthRange?.(e);t.union(r)})),t}get updating(){return this._version.value>=0&&this._renderPlugins.some((e=>e.running))}produces(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return i.some((t=>this._slots[t].some((i=>{const r=i.produces.get(t);return!!r&&r(e)}))))}consumes(e){return this._renderPlugins.some((t=>t.consumes().required.includes(e)))}hasHighlightOptions(e){return fb.some((t=>this._slots[t].some((t=>t.hasHighlightOptions(e)))))}get hasDecorations(){return this._renderPlugins.some((e=>e.isDecoration))}get hasOccludees(){return this._renderPlugins.some((e=>e.hasOccludees))}get hasEmissions(){return this._renderPlugins.some((e=>e.hasEmissions))}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|t.renderOccludedFlags),b_.m$.None)}get usedMemory(){return this._renderPlugins.reduce(((e,t)=>t.material?e:e+(t.usedMemory??0)),0)}get test(){}}const fb=[w_.N.OPAQUE_MATERIAL,w_.N.TRANSPARENT_MATERIAL,w_.N.DRAPED_MATERIAL,w_.N.HUD_MATERIAL,w_.N.LABEL_MATERIAL];var yb=i(38275);class vb extends We.w{constructor(e,t){super(e,t,new Be.$(yb.a,(()=>i.e(36736).then(i.bind(i,36736)))))}initializePipeline(e){return(0,je.Ey)({blending:je.Ky,colorWrite:je.kn,drawBuffers:e.hasEmission?{buffers:[Ze.Nm.COLOR_ATTACHMENT0,Ze.Nm.COLOR_ATTACHMENT1]}:{buffers:[Ze.Nm.COLOR_ATTACHMENT0]}})}}class bb extends Em.K{constructor(){super(...arguments),this.hasEmission=!1}}(0,r._)([(0,Em.W)()],bb.prototype,"hasEmission",void 0);class wb{constructor(e){this._techniques=e,this._parameters=new yb.O,this._configuration=new bb,e.precompile(vb,this._configuration),this._configuration.hasEmission=!0,e.precompile(vb,this._configuration)}blend(e,t,i,r,s){this._parameters.colorTexture=t.getTexture(),s&&(this._parameters.emissionTexture=t.getTexture(Ze.Nm.COLOR_ATTACHMENT1),this._parameters.emissionFrontFaceTexture=i.getTexture(Ze.Nm.COLOR_ATTACHMENT1)),this._parameters.alphaTexture=t.getTexture(s?Ze.Nm.COLOR_ATTACHMENT2:Ze.Nm.COLOR_ATTACHMENT1),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmission=s;const n=this._techniques.get(vb,this._configuration);e.bindTechnique(n,r,this._parameters),e.screen.draw()}}class xb{constructor(e,t){this._camera=e,this._dt=(0,ht.l5)(0),this._time=(0,ht.l5)(0),this._lastUpdate=(0,ht.l5)(0),this._lastUpdate=t,this._time=t}advance(e,t,i){const r=(0,ht.l5)(t-this._lastUpdate);this._dt=(0,ht.l5)(r/i),this._time=(0,ht.l5)(this._time+r),this._lastUpdate=t,this._camera=e}forceTime(e){this._lastUpdate=this._time=e,this._dt=(0,ht.l5)(0)}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}}class Cb{constructor(){this._step=Eb,this._dilation=1,this._firstIdleTime=(0,ht.l5)(0)}frame(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=(0,ht.l5)(performance.now())):this._firstIdleTime=(0,ht.l5)(0),(0,d.A)("disable-feature:high-quality-idle"))this._dilation=1;else{const e=t?performance.now()-this._firstIdleTime:0;if(e>=Mb+Sb)return this._step=(0,ht.l5)(1/0),void(this._dilation=1);this._dilation=e>=Mb?Rb:1}const i=(0,de.qE)(e/Tb,Eb,Ob);this._step===1/0?this._step=(0,ht.l5)(i):this._step=(0,ht.l5)(this._step*Ab+i*(1-Ab))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=(0,ht.l5)(0)}}const Tb=.5,Mb=(0,ht.l5)(12e4),Sb=(0,ht.l5)(1e4),Rb=10,Ab=.9,Eb=(0,ht.l5)(1e3),Ob=(0,ht.l5)(1e3/30);var Pb,Db=i(68957),Ib=i(51255);!function(e){e[e.SHADOW_CASTERS=0]="SHADOW_CASTERS",e[e.FULL_SCENE=1]="FULL_SCENE"}(Pb||(Pb={}));function Lb(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Pb.SHADOW_CASTERS,s=0;if(!t.some((e=>!!e.material&&(s+=e.numGeometries,s>=1e4))))return Zb.compute(e,t,r);const n=new kf.d;return i.forAll((t=>n.union(function(e,t){if(!t.visible)return;const i=new kf.d,r=t.getSpatialQueryAccelerator();return r?function(e,t,i){const{eye:r,viewForward:s,frustum:n}=t,a=e=>e.visible,o=i.objectCount;if(o<500)Bb.set(t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,Ib.A.DepthOrder.FRONT_TO_BACK,Bb,((i,r)=>{Nb(e,t,i),Bb.far=e.near,r.setRange(Bb)}),n,a),Bb.set(Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,Ib.A.DepthOrder.BACK_TO_FRONT,Bb,((i,r)=>{Nb(e,t,i),Bb.near=e.far,r.setRange(Bb)}),n,a);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(s,Ib.A.DepthOrder.FRONT_TO_BACK,n,a,r),h=i.findClosest(s,Ib.A.DepthOrder.BACK_TO_FRONT,n,a,r);l&&h&&(Fb(e,t,l.boundingVolumeWorldSpace.bounds),Fb(e,t,h.boundingVolumeWorldSpace.bounds))}}(i,e,r):function(e,t,i){Wb.clear(),i.forAll((e=>{e.visible&&0!==e.geometries.length&&Wb.add(e)})),Wb.empty||(Wb.sort(t),Bb.set(t.near,Math.min(e.near,t.far)),Wb.forEachInDepthRange(Bb,Ib.A.DepthOrder.FRONT_TO_BACK,((i,r)=>{r<e.near&&Nb(e,t,i)})),Bb.set(Math.max(e.far,t.near),t.far),Wb.forEachInDepthRange(Bb,Ib.A.DepthOrder.BACK_TO_FRONT,((t,i,r)=>{e.far=Math.max(e.far,r)})))}(i,e,t.objects),i}(e,t)))),n}function Nb(e,t,i){if(!i.visible)return;if(!(0,el.m7)(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=kb;i.geometries.forEach((i=>{(0,Ve.lw)(s,r,i.transformation);const n=(0,pe.hG)(s);Hb(e,t,i.boundingInfo,s,n)}))}function Hb(e,t,i,r,s){if(null==i)return;(0,Me.t)((0,Kt.a)(qb),i.center,r);const{eye:n,viewForward:a}=t,o=a[0]*(qb[0]-n[0])+a[1]*(qb[1]-n[1])+a[2]*(qb[2]-n[2]);if(qb[3]=i.radius*s,!(o-qb[3]>e.near&&o+qb[3]<e.far)&&(0,el.m7)(t.frustum,qb))if(i.radius>100&&i.getChildren())for(const l of i.getChildren())Hb(e,t,l,r,s);else jb.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function Fb(e,t,i){const r=t.eye,s=t.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}function Vb(e,t,i){let r=[e,t,i];for(let s=0;s<4;++s){const e=r;r=[];for(let t=0;t<e.length;++t){const i=e[t],n=e[(t+1)%e.length];Ub(n,s)?(Ub(i,s)||r.push(zb(i,n,s)),r.push(n)):Ub(i,s)&&r.push(zb(i,n,s))}}return r}function Ub(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,dc.vA)(!1)}function zb(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,Zs.l)((0,js.vt)(),e,t,r)}const Gb=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],qb=(0,Kt.c)(),kb=(0,Ue.vt)(),Bb=new kf.d,Wb=new class{constructor(){this._items=new oo.A({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.object.boundingVolumeWorldSpace.bounds,s=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=s,e.near=s-r[3],e.far=s+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(t===Ib.A.DepthOrder.FRONT_TO_BACK)for(let r=0;r<this._items.length;++r){const t=this._items.data[r];t.far<e.near||t.near>e.far||i(t.object,t.near,t.far)}else for(let r=this._items.length-1;r>=0;--r){const t=this._items.data[r];t.far<e.near||t.near>e.far||i(t.object,t.near,t.far)}}},Zb=new class{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new kf.d(0,0)}compute(e,t,i){this._reset();const{viewMatrix:r}=e;t.forAll((e=>{e.forEachGeometry((e=>{if(!e.visible||i===Pb.SHADOW_CASTERS&&!e.castShadow)return;const t=e.boundingSphere,s=r[2]*t[0]+r[6]*t[1]+r[10]*t[2]+r[14],n=s-t[3],a=s+t[3];this._geometries.push(e),this._near.push(-a),this._far.push(-n)}))}));const s=new kf.d;if(0===this._geometries.length)return s;for(let l=0;l<this._geometries.length;++l)this._near[l]>s.far&&(s.far=this._near[l]),this._near[l]>2&&this._far[l]<s.near&&(s.near=this._far[l]);const n=this._looseRange;n.near=Math.max(.5*s.near,2),n.far=2*s.far;let a=0,o=0;for(let l=0;l<this._geometries.length;++l)this._near[l]<s.near&&(this._near[l]>=n.near?s.near=this._near[l]:this._nearCandidates[a++]=l),this._far[l]>s.far&&(this._far[l]<=n.far?s.far=this._far[l]:this._farCandidates[o++]=l);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return s;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let l=0;l<this._nearCandidates.length;++l){const t=this._nearCandidates[l];if(this._near[t]<s.near){const i=this._geometries[t],{boundingInfo:r,shaderTransformation:n}=i;this._includeNearBoundingInfoRec(e,r,n,s)}}for(let l=0;l<this._farCandidates.length;++l){const t=this._farCandidates[l];if(this._far[t]>s.far){const i=this._geometries[t],{boundingInfo:r,shaderTransformation:n}=i;this._includeFarBoundingInfoRec(e,r,n,s)}}return this._reset(),s}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const i=(0,Kt.a)(e),r=(0,Kt.g)(e);return t[0][0]*i[0]+t[0][1]*i[1]+t[0][2]*i[2]+t[0][3]>r||t[1][0]*i[0]+t[1][1]*i[1]+t[1][2]*i[2]+t[1][3]>r||t[2][0]*i[0]+t[2][1]*i[1]+t[2][2]*i[2]+t[2][3]>r||t[3][0]*i[0]+t[3][1]*i[1]+t[3][2]*i[2]+t[3][3]>r}_includeNearBoundingInfoRec(e,t,i,r){if(null==t)return;const s=t.center;(0,Me.t)((0,Kt.a)(qb),s,i),qb[3]=t.radius*(0,pe.hG)(i);const{frustum:n}=e;if(this._isOutsideSidePlanes(qb,n))return;const a=qb[0],o=qb[1],l=qb[2],h=qb[3],{viewMatrix:c}=e,d=c[2]*a+c[6]*o+c[10]*l+c[14],u=d+h;if(!(-(d-h)<2||-u>=r.near))if(-u>this._looseRange.near)r.near=-u;else{if(h>100){const s=t.getChildren();if(void 0!==s){for(const t of s)this._includeNearBoundingInfoRec(e,t,i,r);return}}jb.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,i,r){if(null==t)return;const s=t.center;(0,Me.t)((0,Kt.a)(qb),s,i),qb[3]=t.radius*(0,pe.hG)(i);const{frustum:n}=e;if(this._isOutsideSidePlanes(qb,n))return;const[a,o,l,h]=qb,{viewMatrix:c}=e,d=c[2]*a+c[6]*o+c[10]*l+c[14]-h;if(!(-d<=r.far))if(-d<this._looseRange.far)r.far=-d;else{if(h>100){const s=t.getChildren();if(void 0!==s){for(const t of s)this._includeFarBoundingInfoRec(e,t,i,r);return}}jb.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}},jb=new class{constructor(){this._modelViewProj=(0,Ue.vt)(),this._clipPosition=[(0,js.vt)(),(0,js.vt)(),(0,js.vt)(),(0,js.vt)(),(0,js.vt)(),(0,js.vt)(),(0,js.vt)(),(0,js.vt)()]}unionDepthRangeWithAABB(e,t,i,r,s){const n=this._modelViewProj;(0,Ve.lw)(n,t,i);let a=!1;for(let o=0;o<8;++o){const e=this._clipPosition[o],t=0===o||3===o||4===o||7===o?r[0]:s[0],i=0===o||1===o||4===o||5===o?r[1]:s[1],a=o<4?r[2]:s[2];e[0]=n[0]*t+n[4]*i+n[8]*a+n[12],e[1]=n[1]*t+n[5]*i+n[9]*a+n[13],e[2]=n[2]*t+n[6]*i+n[10]*a+n[14],e[3]=n[3]*t+n[7]*i+n[11]*a+n[15]}for(let o=0;o<12;++o){const t=Vb(this._clipPosition[Gb[o][0]],this._clipPosition[Gb[o][1]],this._clipPosition[Gb[o][2]]);let i=!0;for(let e=0;e<t.length;++e)if(t[e][3]>=2){i=!1;break}if(!i){a=!0;for(let i=0;i<t.length;++i){const r=t[i][3];Number.isFinite(r)&&(e.near=Math.min(r,e.near),e.far=Math.max(r,e.far))}}}return a}},$b={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};class Qb{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new Gm.q(0,0),this._clearColor=(0,js.vt)()}dispose(){this._color=(0,p.Gz)(this._color),this.releaseDepth()}initialize(e,t,i,r){this._size.width=e,this._size.height=t,(0,Je.T)(this._size,this._fbos.rctx.parameters.maxTextureSize);const s=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=r,(0,Zs.c)(this._clearColor,i),s}releaseDepth(){this._color?.detachDepth(),this._depth=(0,p.Gz)(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const e=null==this._color;if(this.color.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(this.color.fbo),e){const e=this._fbos.rctx;e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear(Ze.NV.COLOR|Ze.NV.DEPTH|Ze.NV.STENCIL),this._requiresEmission&&e.gl.clearBufferfv(e.gl.COLOR,1,Ev.uY)}}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(Ze.Nm.COLOR_ATTACHMENT1,bg.N.RGBA,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(bg.z.DEPTH_STENCIL_TEXTURE,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}}var Yb=i(29025);class Xb{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}}var Kb=i(51037);class Jb extends We.w{constructor(e,t){super(e,t,new Be.$(Kb.a,(()=>i.e(51933).then(i.bind(i,51933))))),this.primitiveType=Ze.WR.TRIANGLE_STRIP}initializePipeline(){return(0,je.Ey)({blending:je.Ky,colorWrite:je.kn,depthTest:null,depthWrite:null})}}var ew=i(855);const tw=1/512;let iw=class extends M.default{constructor(e,t,i,r){super({}),this._techniques=e,this._rctx=t,this._data=i,this._requestRender=r,this._passParameters=new Kb.S(this._data),this._configuration=new ew.q,this._enabled=!1,this._vao=(0,qm.Q7)(t)}dispose(){this._stop(),this._vao=(0,p.WD)(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(Jb,this._configuration)}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._techniques.get(Jb,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,(0,Ct.mT)(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>tw}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}get _bandsEnabled(){return this._configuration.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._configuration.bandsEnabled=e,this._requestRenderIfEnabled())}_setColor(e){const t=this._passParameters.color;(0,Zs.a)(e,t)||((0,Zs.c)(this._passParameters.color,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};(0,r._)([(0,w.MZ)()],iw.prototype,"opacityFromElevation",null),iw=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],iw);var rw=i(45917),sw=i(59461);class nw extends We.w{constructor(e,t){super(e,t,new Be.$(sw.a,(()=>i.e(27909).then(i.bind(i,27909))))),this.primitiveType=Ze.WR.TRIANGLE_STRIP}initializePipeline(){return(0,je.Ey)({blending:je.vg,colorWrite:je.kn,depthTest:null,depthWrite:null})}}let aw=class extends M.default{constructor(e,t,i,r,s,n){super({}),this.fbos=e,this._techniques=t,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=n,this._progress=0,this._sampleCount=0,this._passParameters=new Gy.QR,this._cachedLightDirections=[],this._depthRange=kf.d.zero,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=e.rctx,this._bindParameters=new Gm.k(new rw.p(e,i.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=(0,qm.Q7)(this._rctx),this._accumulationRenderer=new iw(t,this._rctx,this,n);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(it.W6.SHADOW_ACCUMULATOR,this),(0,g.watch)((()=>i.renderView),(e=>{this.removeHandles(lw),null!=e&&this.addHandles(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),lw)}),g.syncAndInitial),(0,g.watch)((()=>this._previewing),(()=>this._requestRenderIfEnabled()),g.sync)],this._shadowAccumulatorKey),t.precompile(nw)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=(0,p.WD)(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=(0,p.WD)(this._fbo),this._vao=(0,p.WD)(this._vao),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this._active&&this._previewing||this._refining}get _refining(){return this._active&&!this._doneAccumulating&&!this._previewing}get _active(){return null!=this._fbo&&this._sampleCount>0}get canAccumulate(){return null!=this._bindParameters.depth&&this._depthRange!==kf.d.zero&&this._opacityFromElevation>tw}get _doneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if((0,cc.aI)(t,e,Me.I))return;const i=Math.min(sw.S,e.length);t.length=i,this._sampleCount=i;for(let r=0;r<i;++r)t[r]=(0,Me.c)(t[r]??(0,E.vt)(),e[r]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._refining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._doneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,r){if(this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=r,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.accumulating||!this.canAccumulate)return!1;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();let s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(ow,this._sampleCount);s-=this._progress;for(let n=0;n<s;++n)this._accumulateShadow(),this._requestRender();return this._cameraForcedForScreenshot=!1,s>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){if(void 0!==e.enabled){const t=null!=this._fbo;e.enabled!==t&&(e.enabled?this._enable():this._disable())}void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){return!this._active||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,Ze.Ab.RGBA,Ze.ld.UNSIGNED_BYTE,hw),hw[0]/this._progress)}_enable(){this._progress=0;const e=new et.R;e.pixelFormat=Ze.Ab.RED,e.internalFormat=Ze.H0.R8,e.wrapMode=Ze.pF.CLAMP_TO_EDGE,this._fbo=new Je.H(this._rctx,e),this._requestRender()}_disable(){this._fbo=(0,p.WD)(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(Ze.NV.COLOR),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);const e=this._techniques.get(nw);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,(0,Ct.mT)(this._vao,"geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-(0,de.TF)(4e4,5e4,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};(0,r._)([(0,w.MZ)()],aw.prototype,"_progress",void 0),(0,r._)([(0,w.MZ)()],aw.prototype,"_sampleCount",void 0),(0,r._)([(0,w.MZ)()],aw.prototype,"_fbo",void 0),(0,r._)([(0,w.MZ)()],aw.prototype,"_depthRange",void 0),(0,r._)([(0,w.MZ)()],aw.prototype,"_previewing",void 0),(0,r._)([(0,w.MZ)()],aw.prototype,"_accumulationRenderer",void 0),(0,r._)([(0,w.MZ)()],aw.prototype,"_refining",null),(0,r._)([(0,w.MZ)()],aw.prototype,"_active",null),(0,r._)([(0,w.MZ)()],aw.prototype,"canAccumulate",null),(0,r._)([(0,w.MZ)()],aw.prototype,"_doneAccumulating",null),(0,r._)([(0,w.MZ)()],aw.prototype,"_opacityFromElevation",null),(0,r._)([(0,w.MZ)()],aw.prototype,"running",null),aw=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],aw);const ow=6,lw="renderView",hw=new Uint8Array(4),cw=(0,U.d)();class dw{constructor(){this._plane=(0,U.d)()}get plane(){return this._plane}set plane(e){(0,U.a)(e||cw,this._plane)}}var uw,pw=i(7757),mw=i(86209),_w=i(32959),gw=i(47886);class fw{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach((e=>{const t=this._timer.createQuery(),i=this._timer.createQuery();this._queryPool.push(t,i),this._queryResults.set(e,null)}))}start(){gw.z0||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((e=>{this._timer.deleteQuery(e)})),this._queryResults.forEach((e=>{null!=e&&this._timer.deleteQuery(e)}))}}!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.DEPTH="depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.APPLY_ACCUMULATED_SHADOWS="apply accumulated shadows",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.NORMALS="normals",e.SSAO="SSAO",e.HIGHLIGHTS="highlights",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.TRANSPARENT_MATERIAL_WITHOUT_DEPTH="transparent material without depth",e.OPAQUE_ENVIRONMENT="opaque environment",e.TRANSPARENT_ENVIRONMENT="transparent environment",e.OCCLUDED="occluded",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish",e.FOCUS_AREA_MASK="focus area mask"}(uw||(uw={}));const yw=Object.values(ct.RenderCategory).concat(Object.values(ct.InternalRenderCategory)).concat(Object.values(uw)),vw="Total";class bw{constructor(e){this._rctx=e,this._startTimeStampCPU=(0,ht.l5)(0),this._lastTimeStampCPU=(0,ht.l5)(0),this._totalCPUTime=new _w.A(vw),this._cpuTimeSamplers=new Map(yw.map((e=>[e,new _w.A(e)]))),this._enableGPUTimer=0,this._totalGPUTime=new _w.A("GPU"),this._gpuTimeSamplers=new Map(yw.map((e=>[e,new _w.A(e)]))),this._totalTime=(0,ht.l5)(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return(0,ht.l5)(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...yw,vw];this._gpuTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new fw(i,t)}(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=(0,p.WD)(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=(0,ht.l5)(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach((e=>e.push(0))),this._gpuTimerPool.start())}advance(e){const t=(0,ht.l5)(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const e=this._gpuTimerPool.stop(uw.FINISH);this._gpuTimeSamplers.get(uw.FINISH).set(e),this._rctx.gl.flush()}const e=(0,ht.l5)(performance.now()-this._startTimeStampCPU);this._totalTime=(0,ht.l5)(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce(((e,t)=>e+(t.last||0)),0)),++this._totalFrameCount}}class ww{constructor(e,t,i,r,s,n){this._stage=e,this._techniques=i,this._rctx=r,this._compositingHelper=s,this._requestRender=n,this._pluginsHas={hudElements:!1,water:!1},this._renderers=new Map,this.renderPassManager=new hb,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=(0,js.fA)(0,0,0,1),this._sliceHelper=new dw,this._blit=null,this._oitblend=null,this._state=(0,Oe.v)(bn.M.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new Cb,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=(0,Oe.v)(0),this._lastFrameTime=(0,ht.l5)(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new Xb,this._releaseNormals=e=>{e.some((e=>{let{name:t}=e;return"normals"===t}))&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new Fv(r),this._renderStateFeatures=(0,Oe.v)((0,yn.u)(!(0,d.A)("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new Qb(this.fboCache),this.performanceInfo=new bw(this._rctx),this._shadowMap=new rw.p(this.fboCache,e.viewingMode),this._shadowAccumulator=new aw(this.fboCache,i,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t}),((e,t,i)=>{const r=this._stage.view.qualitySettings.maximumPixelRatio;e.shadowMap.start(e.camera,t,i,!0,r),this._renderShadowCascades(gu.V.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(e.camera,e.contentCamera)}),n),this._renderContext=new Yb.AZ(this._rctx,this._shadowMap,i),this._nodes=new _b(this._renderContext),this._plugins=new gb({renderContext:this._renderContext,techniques:i,materials:t,requestRender:n,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this._plugins.add(this.renderPassManager),this._handles=[(0,g.watch)((()=>this._stage.view.state.camera),(()=>n()),g.syncAndInitial),(0,g.watch)((()=>ho.b.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(pw.x.TRANSPARENT):()=>{},n()}),g.initial),(0,g.watch)((()=>this._stage.view.environment.background?.color),(e=>{const t=e?(0,mg.QP)(e):js.uY;(0,Zs.s)(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),n()}),g.syncAndInitial),(0,g.watch)((()=>this._stage.view.state.camera.relativeElevation),(e=>this._inGlobeView=(e??1/0)>=pb.b),g.syncAndInitial),(0,g.watch)((()=>this._bindParameters.clouds.fadeFactor),(()=>this._bindParameters.fadeLighting()),g.sync),(0,g.watch)((()=>this._bindParameters.clouds.data?.state),(()=>n()),g.sync),(0,g.watch)((()=>this._stage.view.state.highlights),(e=>{this._bindParameters.highlights=e,this._updateHighlights(),n()}),g.initial)]}destroy(){this._handles.forEach((e=>e.remove())),this._gpuTimerHandle=(0,p.xt)(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=(0,p.DC)(this._loadEdgeViewTask),this._edgeView=(0,p.pR)(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._renderers.clear(),this._blit=null,this._oitblend=null,Db.j.prune(),mw.y.prune(),(0,lf.BF)()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!(0,d.A)("disable-feature:high-quality-idle");this._renderStateFeatures.value=(0,yn.u)(t,e),this._requestRender()}isFeatureEnabled(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._state.value;return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate((r=>r.set(t,e,i))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(yn.n.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(yn.n.WaterReflection))}get _hasHighlights(){return this._plugins.produces(gu.V.Highlight,w_.N.OPAQUE_MATERIAL,w_.N.TRANSPARENT_MATERIAL,w_.N.DRAPED_MATERIAL,w_.N.HUD_MATERIAL,w_.N.LABEL_MATERIAL)}hasHighlightOptions(e){return this._plugins.hasHighlightOptions(e)}get _hasHUDHighlights(){return this._plugins.produces(gu.V.Highlight,w_.N.HUD_MATERIAL,w_.N.LABEL_MATERIAL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(yn.n.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(yn.n.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(yn.n.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=(0,p.Gz)(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=(0,p.Gz)(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=(0,p.Gz)(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=(0,p.Gz)(this._bindParameters.depth),this._bindParameters.hudVisibility=(0,p.Gz)(this._bindParameters.hudVisibility)}get updating(){return null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=(0,re.UT)((async e=>{const{EdgeView:t}=await i.e(96444).then(i.bind(i,96444));(0,_.throwIfAborted)(e);const r=this._edgeView=new t({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:Iw(this._stage.view.resourceController)});return this._handles.push((0,g.watch)((()=>r.updating),(()=>this._requestRender()),g.sync)),this._requestRender(),this._edgeViewCallbacks.forEach((e=>e(r))),this._edgeViewCallbacks.length=0,r}))),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&(0,Ve.aI)(this._bindParameters.ssr.reprojectionMatrix,Ue.zK)}set _reprojectionMatrix(e){(0,cc.yo)(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:i}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const t="virtual"!==e.environment.lighting.type;i.enableFillLights!==t&&(i.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}set slicePlane(e){this._sliceHelper.plane!==e&&(this._sliceHelper.plane=e,this._requestRender())}get plugins(){return this._plugins}getMaterialRenderer(e){return this._renderers.get(e)}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:i,removes:r,updates:s}=e;0===i.length&&0===r.length&&0===s.length||((0,fn.$T)(e).forEach(((i,r)=>{if(t.done)return;let s=this._renderers.get(r);null==s&&i.adds.length>0&&(s=new mw.y({material:r,highlightOrderMap:this._stage.view.state.highlightOrderMap}),s.initializeRenderContext(this._plugins.context),this._plugins.add(s),this._renderers.set(r,s)),s&&(s.modify(i),s.updateHighlights(this._stage.view.state.highlightOrderMap),0===s.numGeometries&&(this._renderers.delete(s.material),this._plugins.remove(s),s.destroy())),i.removes.forEach((t=>e.removes.removeUnordered(t))),i.adds.forEach((t=>e.adds.removeUnordered(t))),i.updates.forEach((t=>e.updates.removeUnordered(t))),t.madeProgress()})),this.updateHasFlags())}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(gu.V.Color,...Aw),e.water=this._plugins.produces(gu.V.Normal,w_.N.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new xb(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation),null!=e.forcedAnimationTime&&this._animationTimer.forceTime(e.forcedAnimationTime);const i=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==i&&(this._gpuTimerHandle=i?(0,p.xt)(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn.fS.Default,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];try{return this._isRendering=!0,this._render(e,t,i,r)}catch(s){console.error(`Exception during rendering: ${s}`)}finally{this._isRendering=!1}return new jd(this._pluginInput.get(ct.RenderCategory.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:i,navigatingOpacity:r,maxDelta:s,tiltFadeStart:n,tiltFadeEnd:a,altitudeStart:o,altitudeEnd:l}=$b,h=this._stage.view,c=h.stateManager.camera,d=h.qualitySettings.fadeDuration,u=e===bn.M.IDLE?i:r,p=(0,de.qE)((c.tilt-n)/(a-n),0,1),m=(0,de.qE)((c.position.z??0-o)/(l-o),0,1),_=(0,de.Cc)((0,de.Cc)(1,u,p),1,m),g=this._bindParameters.hudOccludedFragmentOpacity;if(d<=0||g===_||0===this._lastFrameTime||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=_,void(this._lastFrameTime=t);const f=t-this._lastFrameTime;this._lastFrameTime=t;const y=Math.min(Math.abs(i-r)*f/d,s);y>=Math.abs(_-g)?this._bindParameters.hudOccludedFragmentOpacity=_:(this._bindParameters.hudOccludedFragmentOpacity=g+Math.sign(_-g)*y,this._requestRender())}_render(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn.fS.Default,r=arguments.length>3?arguments[3]:void 0;this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=i===fn.fS.Default,this._disposeBindBuffers();const{camera:s,contentCamera:n,mode:a,alignPixelEnabled:o}=e;this._state.value=a;const l=this._nodes.produces("magnifier-color"),h=this._nodes.produces(ct.RenderCategory.FINAL),c=this._nodes.require("emissive",ct.RenderCategory.FINAL,ct.RenderCategory.COMPOSITE)>0&&this._plugins.hasEmissions,d=c?gu.V.ColorEmission:gu.V.Color;this._renderContext.time=t,this._renderContext.output=d,this._bindParameters.oitPass=Kv.Y.NONE,this._bindParameters.alignPixelEnabled=o,this._bindParameters.decorations=!r,this._bindParameters.mainDepth=null,this._bindParameters.slicePlane=this._sliceHelper.plane,this._bindParameters.viewshedEnabled=this._nodes.produces(ct.InternalRenderCategory.VIEWSHED),this._renderOverlay(t),s.setGLViewport(this._rctx);const u=this._framebuffer,m=u.initialize(s.fullWidth,s.fullHeight,this._backgroundColor,c);this.hasReflections?(m?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=m):m?.release(),this._ensureBindParametersCamera(s,n),this._updateHUDOccludedFragmentOpacity(a,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!r;const _=this._highQualityTransparency&&this._hasTransparentTerrain,g=this._plugins.produces(gu.V.Color,...Sw);this._precompilePrepasses(),this.performanceInfo.advance(uw.PREPARE);const f=this._computeDepthRange(s);this._renderShadowMap(s,this._bindParameters.lighting.mainLight.direction,f),this._ensureBindParametersCamera(s,n),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(f,s,n),this._ensureBindParametersSSR(t),this._precompileShaders(_,g,d),this._renderContext.output=d,u.bind(),this._bindParameters.mainDepth=u.depth.attachment;const y=this.plugins.produces(gu.V.Color,...Mw);y&&this._renderOpaqueGeometry(),u.update((e=>this._renderNodes(ct.RenderCategory.OPAQUE,e,y))),this.fboCache.debugCallback?.(ct.RenderCategory.OPAQUE,u.color.fbo),u.update((e=>this._renderNodes(ct.InternalRenderCategory.OPAQUE_ENVIRONMENT,e))),this.fboCache.debugCallback?.(ct.InternalRenderCategory.OPAQUE_ENVIRONMENT,u.color.fbo),this._renderTerrainDepth(_),this._renderEdges(pw.x.OPAQUE),u.bind(),this._renderPlugins(w_.N.VOXEL,uw.VOXEL),this._renderHiddenTransparentEdges(),g&&(this._oitEnabled?this._renderOIT(xw.Geometry,d):this._renderTransparentGeometry()),u.update((e=>this._renderNodes(ct.RenderCategory.TRANSPARENT,e,g))),this.fboCache.debugCallback?.(ct.RenderCategory.TRANSPARENT,u.color.fbo),this._renderGeometryDepth(_),this._renderHUDVisibility(),_||this._plugins.render(this._pluginInput,w_.N.LINE_CALLOUTS),this._renderEdges(pw.x.TRANSPARENT);const v=this._hasTransparentTerrain?this._renderTransparentTerrain():null;v&&(this.performanceInfo.advance(uw.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(_?this._renderLineCallouts(Sy.D.Occluded):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,v.getTexture())),this._renderHUD(Sy.D.Occluded,u.color,d))),this._bindParameters.cullAboveTerrain=!1,v&&(u.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,v.getTexture()),v.release(),_&&(this._renderEdges(pw.x.OPAQUE),g&&(this._oitEnabled?this._renderOIT(xw.Geometry,d):this._renderTransparentGeometry(),this.performanceInfo.advance(uw.TRANSPARENT)),this._renderEdges(pw.x.TRANSPARENT))),this._bindParameters.ssao=(0,p.Gz)(this._bindParameters.ssao),_&&this._renderLineCallouts(Sy.D.NotOccluded),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment(),this._pluginInput.set(ct.InternalRenderCategory.FOCUSAREA,this._renderFocusAreaGeometry()),u.update((e=>this._renderNodes(ct.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,e))),u.update((e=>this._renderNodes(ct.InternalRenderCategory.VIEWSHED,e))),u.update((e=>this._renderNodes(ct.InternalRenderCategory.LASERLINES,e))),u.update((e=>this._renderNodes(ct.InternalRenderCategory.OCCLUDED,e))),this._pluginInput.set("highlights",this._renderHighlightPrepass());const b=i===fn.fS.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;u.update((e=>this._renderNodes(ct.RenderCategory.COMPOSITE,e))),this._pluginInput.release(ct.InternalRenderCategory.FOCUSAREA);const w=!(i!==fn.fS.Default||h||l&&!r),x=this._pluginInput.get(ct.RenderCategory.COMPOSITE),C=w?Vv:this.fboCache.acquire(x.fbo.width,x.fbo.height,ct.InternalRenderCategory.ANTIALIASING),T=this._nodes.produces(ct.InternalRenderCategory.ANTIALIASING)?this._renderNodes(ct.InternalRenderCategory.ANTIALIASING,C):this._blitFBO(x,C,!1);let M;this._pluginInput.set(ct.InternalRenderCategory.ANTIALIASING,T),this._hasHUDHighlights?(this._renderHUD(Sy.D.NotOccluded,T,d),M=this._renderNodes(ct.InternalRenderCategory.HIGHLIGHTS,T)):(M=this._renderNodes(ct.InternalRenderCategory.HIGHLIGHTS,T),this._renderHUD(Sy.D.NotOccluded,M,d));const S=this._renderNodes(ct.InternalRenderCategory.MAGNIFIER,M);return l&&!r&&i===fn.fS.Default&&!h&&this._blitFBO(S),h?(S.attachDepth(u.depth),this._blitFBO(this._renderNodes(ct.RenderCategory.FINAL,S)),S.detachDepth()):this._pluginInput.set(ct.RenderCategory.FINAL,S),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),u.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),i!==fn.fS.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new jd(this._pluginInput.get(ct.RenderCategory.FINAL),b)}_precompileShaders(e,t,i){if(++this._plugins.context.techniques.precompiling,this._renderContext.output=i,this._precompileOpaqueGeometry(),this._nodes.precompile(ct.InternalRenderCategory.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=gu.V.Depth,this._plugins.precompile(w_.N.TRANSPARENT_TERRAIN),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=i,this._plugins.precompile(w_.N.TRANSPARENT_TERRAIN),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(ct.InternalRenderCategory.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(w_.N.OCCLUSION_PIXELS),this._plugins.precompile(w_.N.LINE_CALLOUTS),this._precompileHUD(Sy.D.Occluded),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(ct.InternalRenderCategory.VIEWSHED,ct.InternalRenderCategory.LASERLINES,ct.InternalRenderCategory.OCCLUDED,ct.InternalRenderCategory.ANTIALIASING,ct.InternalRenderCategory.HIGHLIGHTS),this._precompileHUD(Sy.D.NotOccluded),this._hasHighlights){const e=this._bindParameters;e.highlights.forEach(((t,i)=>{e.highlightLevel=i,this._precompileAllGeometry(gu.V.Highlight)})),e.highlightLevel=null}this._nodes.precompile(ct.RenderCategory.COMPOSITE,ct.InternalRenderCategory.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(w_.N.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_updateHighlights(){const e=this._stage.view.state;this._renderers.forEach((t=>t.updateHighlights(e.highlightOrderMap)))}_renderFocusAreaGeometry(){if(!this._nodes.produces(ct.InternalRenderCategory.FOCUSAREA))return null;const{width:e,height:t}=this._framebufferSize;let i=this.fboCache.acquire(e,t,ct.InternalRenderCategory.FOCUSAREA);return i=this._nodes.render(i,this._pluginInput),this.performanceInfo.advance(uw.FOCUS_AREA_MASK),i}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let i=this.fboCache.acquire(t.width,t.height,"olid");return i.acquireDepth(bg.z.DEPTH_STENCIL_TEXTURE),i=this._nodes.render(i,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(uw.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,i}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===bt.C7.BACKGROUND;if(i||t){const e=i?this.performanceInfo.elapsedTime:0;let r=0;t?r=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const s=Math.max(e,r);this._animationTimestep.frame(s,i)}}readMainDepth(e,t){const{mainDepth:i,camera:r}=this._bindParameters;if(!i)return;const s=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(s.fbo),r.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(js.uY),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,i),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),s.fbo?.readPixels(e[0],e[1],e[2],e[3],Ze.Ab.RGBA,Ze.ld.UNSIGNED_BYTE,t),s.release()}readHUDVisibility(e,t,i,r,s){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,i,r,Ze.Ab.RGBA,Ze.ld.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"edges"),s=this._bindParameters.geometryDepth;this.renderToTargets((()=>t.render(this._bindParameters,e)),r,s??this._framebuffer.depth,js.uY),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,r.getTexture()),r.release(),this.performanceInfo.advance(e===pw.x.OPAQUE?uw.OPAQUE_EDGES:uw.TRANSPARENT_EDGES)}_renderOverlay(e){this._bindParameters.overlay=this.overlay?.render(e),this._bindParameters.overlay&&this.performanceInfo.advance(uw.OVERLAY)}_renderShadowMap(e,t,i){if(!this.shadowsEnabled)return;const r=this._shadowMap;r.start(e,t,i,this.isFeatureEnabled(yn.n.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(gu.V.ShadowHighlight,this._shadowMap),r.moveSnapshot(rw.z.Highlight),this._renderShadowCascades(gu.V.ShadowExcludeHighlight,this._shadowMap),r.copySnapshot(rw.z.ExcludeHighlight),this._renderShadowCascades(gu.V.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(gu.V.Shadow),r.finish(),e.setGLViewport(this._rctx),this.performanceInfo.advance(uw.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._shadowMap;for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(gu.V.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._needsShadowAccumulation||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");if(e){const t=this._needsDepth?e.getAttachment(Ze.nI):null;t?.retain(),this._pluginInput.set(ct.InternalRenderCategory.SSAO,this._renderSSAO()),this._renderGeometryWithoutNormalsDepth(t)}else this._renderAllGeometryDepth()}_renderGeometryWithoutNormalsDepth(e){if(!this._needsDepth||!e)return void(this._bindParameters.depth=(0,p.Gz)(this._bindParameters.depth));const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"depth");i.attachDepth(e),e.release(),this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(Ze.NV.STENCIL),this._renderGeometryWithoutNormals(gu.V.Depth),(0,p.Gz)(this._bindParameters.depth),this._bindParameters.depth=i.obtainDepthTexture(),i.release(),this.performanceInfo.advance(uw.DEPTH)}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=(0,p.Gz)(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth").acquireDepth(bg.z.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(Ze.NV.DEPTH|Ze.NV.STENCIL),this.renderAllGeometry(gu.V.Depth),(0,p.Gz)(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(uw.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=(0,p.Gz)(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=gu.V.Depth;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"terrain depth").acquireDepth(bg.z.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(Ze.NV.DEPTH|Ze.NV.STENCIL),this._renderTransparentTerrain(),(0,p.Gz)(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=r.obtainDepthTexture(),this._renderContext.output=t,r.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=(0,p.Gz)(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:i,height:r}=this._framebufferSize,s=this.fboCache.acquire(i,r,"geometry depth").acquireDepth(bg.z.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(Ze.NV.DEPTH|Ze.NV.STENCIL),this._renderOpaqueAndTransparentGeometry(gu.V.Depth),this._renderContext.output=t,(0,p.Gz)(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=s.obtainDepthTexture(),s.release()}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowAccumulation}_computeDepthRange(e){if(!this._needsDepthRange)return kf.d.zero;const t=Lb(e,this._plugins.plugins,this._stage.layers);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}get _normalsRequired(){const e=this._nodes.require("normals",ct.RenderCategory.FINAL,ct.RenderCategory.COMPOSITE,ct.RenderCategory.OPAQUE,ct.RenderCategory.TRANSPARENT,ct.InternalRenderCategory.VIEWSHED,ct.InternalRenderCategory.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(gu.V.Normal),this._needsDepth&&this._precompileAllGeometry(gu.V.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(gu.V.ShadowHighlight),this._precompileShadowCascades(gu.V.ShadowExcludeHighlight),this._precompileShadowCascades(gu.V.ShadowHighlight)):this._precompileShadowCascades(gu.V.Shadow)),this._needsShadowAccumulation&&this._precompileAllGeometry(gu.V.Shadow)}_renderNormals(){const e=this._normalsRequired;if(0===e)return;const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"normals",bg.N.RGBA);i.acquireDepth(bg.z.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(js.uY,!0,!0),this._renderGeometryWithNormals(gu.V.Normal);const r=this._nodes.optional("normals",ct.RenderCategory.FINAL,ct.RenderCategory.COMPOSITE,ct.RenderCategory.OPAQUE,ct.RenderCategory.TRANSPARENT,ct.InternalRenderCategory.VIEWSHED);return i.retain(e+r-1),this.performanceInfo.advance(uw.NORMALS),i}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return void e?.detachDepth();Vv.setName(ct.InternalRenderCategory.SSAO);const t=this._nodes.render(Vv,this._pluginInput);return this._bindParameters.ssao=t,e.detachDepth(),this._pluginInput.release("normals"),this.performanceInfo.advance(uw.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(w_.N.TRANSPARENT_TERRAIN),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];for(const s of i)this._bindParameters.slot=s,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const i of t)this._renderContext.renderOccludedMask=i,this.precompileSlots(e,...Rw);this._renderContext.renderOccludedMask=Yb.Vr}renderSlots(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];for(const s of i)this._bindParameters.slot=s,e.forAll((e=>{const t=e.acquireTechniques(this._renderContext);t&&e.render(this._renderContext,t,this._pluginInput)}))}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>b_.m$.Occlude&&this._plugins.render(this._pluginInput,w_.N.OCCLUDED_TERRAIN),this.renderSlots(e,...Rw),this._renderContext.renderOccludedMask=Yb.Vr}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(this._pluginInput,w_.N.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(gu.V.ViewshedShadow)}renderViewshedShadowMap(e){const{camera:t,contentCamera:i}=this._bindParameters,r=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(gu.V.ViewshedShadow),this._ensureBindParametersCamera(t,i),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=r}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,...Cw),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(this._pluginInput,...Tw)}_precompileOpaqueGeometry(){this._plugins.precompile(...Mw)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...Mw)}_renderTransparentGeometry(){this._plugins.render(this._pluginInput,...Sw)}get _hasTransparentTerrain(){return this._plugins.produces(gu.V.Color,w_.N.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){const e=()=>this._plugins.render(this._pluginInput,w_.N.TRANSPARENT_TERRAIN);if(!(0,gu.RN)(this._renderContext.output))return void e();const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,i,this._framebuffer.depth,js.uY),i}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,w_.N.OCCLUSION_PIXELS)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=(0,p.Gz)(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let i=this._bindParameters.hudVisibility;i?.fbo?.width===e&&i?.fbo?.height===t||(i?.release(),i=this.fboCache.acquire(e,t,"hud visibility",bg.N.RGBA4),this._bindParameters.hudVisibility=i);const r=this._bindParameters.geometryDepth;i.attachDepth(r||this._framebuffer.depth),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(this._pluginInput,w_.N.OCCLUSION_PIXELS),i.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(uw.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===Sy.D.Occluded){const e=()=>this._plugins.render(this._pluginInput,w_.N.LINE_CALLOUTS),t=this._framebufferSize,i=this.fboCache.acquireDepth(bg.z.DEPTH16_BUFFER,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,i,void 0,!0,!0),i.release()}else this._plugins.render(this._pluginInput,w_.N.LINE_CALLOUTS)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=gu.V.Highlight,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&(0,gu.RN)(this._renderContext.output)?(this._bindParameters.oitPass=Kv.Y.ColorAlpha,this._plugins.precompile(...Aw),this._bindParameters.oitPass=Kv.Y.FrontFace,this._plugins.precompile(...Aw),this._bindParameters.oitPass=Kv.Y.NONE):this._plugins.precompile(...Aw),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,i){if(this._pluginsHas.hudElements){if(this._oitEnabled){const r=this._renderOIT(xw.HUD,i,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,r.getTexture()),r.release()}else if(this._renderContext.output=i,e===Sy.D.Occluded){const t=()=>this._renderHUDElements(e),i=this._framebufferSize,r=this.fboCache.acquireDepth(bg.z.DEPTH16_BUFFER,i.width,i.height,"hud");this.renderToTargets(t,this._framebuffer.color,r,void 0,!0,!0),r.release()}else t.acquireDepth(bg.z.DEPTH16_BUFFER),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===Sy.D.Occluded?uw.HUD_OCCLUDED:uw.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(this._pluginInput,...Aw)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(gu.V.ShadowHighlight,w_.N.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:i}=this,r=this._framebufferSize,s=e.acquire(r.width,r.height,"highlights",bg.N.RG);return s.acquireDepth(bg.z.DEPTH_STENCIL_TEXTURE),t.bindFramebuffer(s.fbo),t.clearFramebuffer(js.uY,!0),this._renderContext.output=gu.V.Highlight,t.bindFramebuffer(s.fbo),(0,zy.VO)(t,e,r,i,(()=>this._renderHighlightGeometries())),this.performanceInfo.advance(uw.HIGHLIGHTS),s}_renderHighlightGeometries(){this._plugins.render(this._pluginInput,...Ew),this._rctx.clear(Ze.NV.DEPTH),this._renderHUDElements(Sy.D.Both)}get _needsShadowAccumulation(){return this._shadowAccumulator.accumulating}_renderShadowAccumulation(e,t,i){this._needsShadowAccumulation&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,e,t,i)&&this.performanceInfo.advance(uw.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&(0,gu.RN)(this._renderContext.output)?(this._bindParameters.oitPass=Kv.Y.ColorAlpha,this._plugins.precompile(...Sw),this._bindParameters.oitPass=Kv.Y.FrontFace,this._plugins.precompile(...Sw),this._bindParameters.oitPass=Kv.Y.NONE):this._plugins.precompile(...Sw)}_renderOIT(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sy.D.Both;const r=e===xw.HUD,s=this._framebufferSize,n=r?this.fboCache.acquire(s.width,s.height,"oit hud composite"):null,a=r?()=>this._renderHUDElements(i):()=>this._renderTransparentGeometry(),o=this._bindParameters,l=this._renderContext.output;this._renderContext.output=t,o.oitPass=Kv.Y.ColorAlpha;const h=n?"oit hud color+alpha":"oit color+alpha",c=this.fboCache.acquire(s.width,s.height,h,bg.N.RGBA16F),d=t===gu.V.ColorEmission;d&&c.acquireColor(Ze.Nm.COLOR_ATTACHMENT1,bg.N.RGBA16F,"emissive"),c.acquireColor(d?Ze.Nm.COLOR_ATTACHMENT2:Ze.Nm.COLOR_ATTACHMENT1,bg.N.R16F),n||c.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(c.fbo),this._rctx.clearFramebuffer([0,0,0,1]),d&&this._rctx.gl.clearBufferfv(this._rctx.gl.COLOR,1,Ev.uY),a(),c.detachDepth(),o.oitPass=Kv.Y.FrontFace;const u=this.fboCache.acquire(s.width,s.height,n?"oit hud front":"oit front");return d&&u.acquireColor(Ze.Nm.COLOR_ATTACHMENT1,bg.N.RGBA,"emissive"),n?u.acquireDepth(bg.z.DEPTH16_BUFFER):u.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(u.fbo),this._rctx.clearFramebuffer(js.uY,!!n),a(),u.detachDepth(),o.oitPass=Kv.Y.NONE,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(Ze.NV.COLOR)):this._framebuffer.bind(),this._oitblend??=new wb(this._techniques),this._oitblend.blend(this._rctx,c,u,o,d),n?.detachDepth(),u.release(),c.release(),this._renderContext.output=l,n}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(uw.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(this._pluginInput,w_.N.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance(uw.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(this._pluginInput,e),this.performanceInfo.advance(t))}_renderNodes(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return i&&this.performanceInfo.advance(e),t;const r=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),r}_blitFBO(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Vv,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this._blit??=new Ay.G(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),i&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Ue.zK:((0,Ve.B8)(Pw,this._bindParameters.camera.viewMatrix),(0,Ve.B8)(Ow,this._bindParameters.camera.projectionMatrix),(0,Ve.lw)(Dw,Pw,Ow),(0,Ve.lw)(Dw,this._renderContext.lastFrameCamera.viewMatrix,Dw),(0,Ve.lw)(Dw,this._renderContext.lastFrameCamera.projectionMatrix,Dw),this._reprojectionMatrix=Dw);const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Ue.zK,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,i,r){this._bindParameters.updateLighting(e,t,i,r),this._requestRender(bt.C7.UPDATE)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,i,r){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],n=arguments.length>5&&void 0!==arguments[5]&&arguments[5];t.attachDepth(i),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(r,s,n),e(),t.detachDepth()}get test(){}}var xw;(0,r._)([(0,w.MZ)({readOnly:!0})],ww.prototype,"fullResolutionAtmosphere",null),(0,r._)([(0,w.MZ)()],ww.prototype,"_edgeView",void 0),(0,r._)([(0,w.MZ)()],ww.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(xw||(xw={}));const Cw=[w_.N.INTEGRATED_MESH,w_.N.OPAQUE_TERRAIN,w_.N.OPAQUE_MATERIAL,w_.N.TRANSPARENT_MATERIAL],Tw=[w_.N.OPAQUE_MATERIAL_WITHOUT_NORMALS,w_.N.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],Mw=[w_.N.INTEGRATED_MESH,w_.N.OPAQUE_TERRAIN,w_.N.OPAQUE_MATERIAL,w_.N.OPAQUE_MATERIAL_WITHOUT_NORMALS],Sw=[w_.N.TRANSPARENT_MATERIAL,w_.N.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],Rw=[w_.N.OPAQUE_MATERIAL,w_.N.TRANSPARENT_MATERIAL,w_.N.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],Aw=[w_.N.LINE_CALLOUTS_HUD_DEPTH,w_.N.HUD_MATERIAL,w_.N.LABEL_MATERIAL],Ew=[w_.N.TRANSPARENT_MATERIAL,w_.N.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,w_.N.OPAQUE_MATERIAL,w_.N.OPAQUE_MATERIAL_WITHOUT_NORMALS,w_.N.TRANSPARENT_TERRAIN,w_.N.INTEGRATED_MESH,w_.N.OPAQUE_TERRAIN],Ow=(0,Ue.vt)(),Pw=(0,Ue.vt)(),Dw=(0,Ue.vt)();function Iw(e){return t=>e.immediate.schedule(t)}var Lw=i(34289);class Nw{constructor(e){this._rctx=e,this._vao=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Lw.lK,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:qg.D;const r=new Float32Array([-1,-1,3,-1,-1,3]);return new wt.Z(e,i,new Map([["geometry",t]]),new Map([["geometry",xt.g.createVertex(e,Ze._U.STATIC_DRAW,r)]]))}(e)}destroy(){this._vao=(0,p.WD)(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(Ze.WR.TRIANGLES,0,3))}get test(){}}class Hw{constructor(e,t,i){this._rctx=e,this._locations=t,this._layout=i,this._cache=new xd(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let i=this._cache.pop(t);return i||(i=new wt.Z(this._rctx,this._locations,new Map([["geometry",this._layout]]),new Map([["geometry",xt.g.createVertex(this._rctx,Ze._U.STATIC_DRAW)]])),i.vertexBuffers.get("geometry")?.setSize(e),i)}deleteVao(e){if(null==e)return;const t=e.byteSize.toString();this._cache.put(t,e)}}var Fw=i(89576),Vw=i(54776);class Uw extends Vw.e{constructor(e,t){super(e,t),this._vaoCaches=new Rv.O,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this.screen=new Nw(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches?.forAll((e=>e.dispose())),this._vaoCaches?.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){super.dispose(),this._appleAmdDriverHelper?.dispose(),this.screen.destroy(),this._vaoCaches.forAll((e=>e.dispose())),this._vaoCaches.clear()}get newCache(){return this._newCache}getVaoCache(e,t){const i=Array.from(e).join("."),r=JSON.stringify(t),s=this._vaoCaches.get(i,r);if(s)return s;const n=new Hw(this,e,t);return this._vaoCaches.set(i,r,n),n}bindTechnique(e,t,i,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),i&&(e.program.bindPass(i,t),r&&e.program.bindDraw(t,i,r)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new Fw.H(this),this._appleAmdDriverHelper.run())}get test(){}}function zw(e){return!!e.frameUpdate}let Gw=class extends M.default{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new Te.A,this._frameTask=e.view.resourceController.scheduler.registerTask(it.W6.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(sg.X.Texture,(e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",bt.C7.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(null==t)return null;const i=t.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(e)})),r=new qw(e,(()=>{this._frameTask.schedule((()=>{r.isUnreferenced&&t.unload()}))}));return this._textures.set(e,r),r.ref(),t.glTexture?(this._updateGLTexture(r,t.glTexture),zw(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule((()=>{const i=t.load(this._stage.renderView.renderingContext),s=i=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,i),zw(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r);return(0,_.isPromiseLike)(i)?i.then(s,(e=>(this._loadingCount--,r.loadingPromise=null,(0,_.isAbortError)(e)||u.A.getLogger(this).error(e),null))):s(i)})),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",bt.C7.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};(0,r._)([(0,w.MZ)()],Gw.prototype,"_loadingCount",void 0),(0,r._)([(0,w.MZ)()],Gw.prototype,"_frameTask",void 0),(0,r._)([(0,w.MZ)()],Gw.prototype,"updating",null),Gw=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.lib.TextureRepository")],Gw);class qw{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(u.A.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}var kw=i(42402),Bw=i(43286);var Ww=i(67650);let Zw=class extends M.default{constructor(){super(...arguments),this._passParameters=new jw,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=(0,p.DC)(this._resourcesTask),this._passParameters.waveNormal=(0,p.WD)(this._passParameters.waveNormal),this._passParameters.wavePerturbation=(0,p.WD)(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=(0,re.UT)((async t=>{await Promise.allSettled([this._loadImageResource(e,(0,hv.s)("esri/images/materials/water/normals.jpg"),(e=>this._passParameters.waveNormal=e),t),this._loadImageResource(e,(0,hv.s)("esri/images/materials/water/perturbation.jpg"),(e=>this._passParameters.wavePerturbation=e),t)])}))),this._resourcesTask.finished?bt.Am.LOADED:bt.Am.LOADING}async _loadImageResource(e,t,i,r){try{const s=await(0,$y.D)(t,{signal:r});(0,_.throwIfAborted)(r);const n=new et.R(s.width,s.height);n.pixelFormat=Ze.Ab.RGB,n.samplingMode=Ze.Cj.LINEAR_MIPMAP_LINEAR,n.hasMipmap=!0,n.maxAnisotropy=8,i(new km.g(e,n,s))}catch(s){u.A.getLogger(this).error("Failed to load water material normal texture.",s)}}};(0,r._)([(0,w.MZ)()],Zw.prototype,"_resourcesTask",void 0),(0,r._)([(0,w.MZ)({type:Boolean,readOnly:!0})],Zw.prototype,"updating",null),Zw=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],Zw);class jw extends pt.Y{}const $w=new Map;function Qw(){return $w}var Yw=i(28757),Xw=i(99571);class Kw{constructor(e,t){this.parameters=e,this.fbos=t}}class Jw{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(bt.C7.BACKGROUND);const t=(0,_.createResolver)();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(null==this._rctx){i.resolver.reject();continue}const r={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},s=this._renderScreenshot(e,r,t);i.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const r=e.getContext("2d"),s=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),t=this._renderFunctions.renderOverlay(e,i.disableDecorations,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:s,resample:n}=e,a=this._ensureScreenshotEncodeCanvas();let o=(0,Xw.xR)(i,r,a);this._rctx.gl.readPixels(0,0,i,r,Ze.Ab.RGBA,Ze.pe.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(a,o,{...e,region:void 0});const l=(0,Xw.xR)(s.width,s.height,a);return(0,Yw.resampleHermite)(o,l,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),n=(0,Xw.xR)(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,Ze.Ab.RGBA,Ze.pe.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(s,n,e)}_renderScreenshot(e,t,i){const r=e.parameters.camera,s={width:t.framebufferWidth,height:t.framebufferHeight};(0,Je.T)(s,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let n=!1;const a=s.width!==r.fullWidth||s.height!==r.fullHeight,o=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,l=a||t.disableDecorations||o||t.objectAndLayerIdColor;let h=null,c=null;if(l){const a=r.clone();if(t.ignorePadding){const e=(0,js.o8)(a.padding);for(let i=0;i<4;i++)e[i]=Math.round(e[i]/a.pixelRatio*t.pixelRatio);a.padding=e}a.fullWidth=s.width,a.fullHeight=s.height,a.pixelRatio=t.pixelRatio;const o=r.fovX-a.fovX,l=r.fovY-a.fovY;o<0&&o<l?a.fovX=r.fovX:l<0&&l<o&&(a.fovY=r.fovY);const d={camera:a,contentCamera:a,mode:bn.M.IDLE,alignPixelEnabled:!0,contentPixelRatio:a.pixelRatio,forcedAnimationTime:e.parameters.forcedAnimationTime};this._forceCameraHook(d),n=!0;const u=this._renderFunctions.renderScene(d,i,t.objectAndLayerIdColor?fn.fS.ObjectAndLayerID:fn.fS.Screenshot,t.disableDecorations);c=u.screen,h=u.olid}this._rctx.bindFramebuffer(c?.fbo);const d=this._readbackScreenshot(t,(()=>{this._rctx.bindFramebuffer(null),c?.release()}));let u=null;if(t.objectAndLayerIdColor){const e=()=>{this._rctx.bindFramebuffer(null),h?.release()};this._rctx.bindFramebuffer(h?.fbo),u=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(l&&!this._rctx.contextAttributes.alpha)for(let p=3;p<d.data.length;p+=4)d.data[p]=255;if(u&&!this._rctx.contextAttributes.alpha)for(let p=3;p<u.data.length;p+=4)u.data[p]=255;return n&&this._forceCameraHook(e.parameters),[d,u]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}}const ex=!1;let tx=class extends M.default{constructor(e){super(e),this.events=new Te.A,this.waterTextures=new Zw,this.olidRenderHelper=(0,gy.E)()?new Av:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._savedFadeDuration=(0,ht.l5)(0);const t=e.stage;try{this._initializeContext(t)}catch(s){return void console.error("Failed to initialize context",s)}const{memoryController:i}=t.view.resourceController;this.stippleTextures=(0,Ww.Ry)(this._rctx,i),this.markerTextures=function(e,t){return new Bw.f((t=>(0,kw.sS)(t,e)),(e=>e),t)}(this._rctx,i),this._techniques=new My.I(new Ty(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new Gw(t),this.addHandles(this._textures.events.on("changed",(e=>this.requestRender(e)))),this._materials=new Sv.v(this._textures,this._techniques,(()=>this.requestRender()),(()=>this.requestRender())),this._compositingHelper=new Mv(this._rctx,this._techniques),this.renderer=new ww(t,this._materials,this._techniques,this._rctx,this._compositingHelper,(e=>this.requestRender(e))),this.addHandles([(0,g.watch)((()=>t.view.ready),(e=>{e&&this._createRenderNodes()}),g.initial),(0,g.watch)((()=>this.waterTextures?.updating),(()=>this.requestRender()),g.initial),(0,g.watch)((()=>t.view.qualityProfile),(e=>this.renderer?.updateRenderFeatures(e)),g.syncAndInitial)]);const r={renderScene:(e,t,i,r)=>this.renderer.render(e,t,i,r),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(e,i,r)=>t.options.screenshot.renderOverlay(e,i,r)};this._screenshotManager=new Jw(this._rctx,r,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(t)}destroy(){const e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=(0,p.xt)(this._frameTask),this._techniques=(0,p.pR)(this._techniques),this._componentObjects=(0,p.pR)(this._componentObjects),this._screenshotManager=(0,p.pR)(this._screenshotManager),(0,p.pR)(this.renderer),this._textures=(0,p.pR)(this._textures),(0,p.pR)(this.waterTextures),(0,p.pR)(this.markerTextures),(0,p.pR)(this.stippleTextures),this._canvas=null,this._rctx=(0,p.pR)(this._rctx)}_createRenderNodes(){const{view:e,viewingMode:t}=this.stage;new pv({view:e}),(0,Re.KQ)(e.spatialReference)||(t===X.RT.Local?new Bg({view:e}):(0,Re.q8)(e.spatialReference)?new nf({view:e}):(new Mg({view:e}),new Ag({view:e}),new Uy({view:e}),new Dg({view:e}))),new lv.n({view:e,isEnabled:()=>this.renderer.hasSSAO}),new av({view:e,isEnabled:()=>this.renderer.hasSMAA}),new Ky({view:e}),new zy.f4({view:e}),new Zy({view:e,viewingMode:t}),new Oy({view:e}),(0,gy.E)()&&new Ry({view:e})}requestRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt.C7.UPDATE;this._needsRender=!0,e===bt.C7.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,r,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:s;const a=r.constrainWindowSize(t,i,s*r.pixelRatio,n*r.pixelRatio),o=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,o);const l=(e,t,i)=>(0,pg.T)(t,e)*(i[1]-i[0])+i[0];let h=Number.MAX_VALUE;for(let c=0;c<a[2]*a[3];c++){const e=l(4*c,o,r.nearFar);h>e&&e!==r.nearFar[0]&&e!==r.nearFar[1]&&(h=e)}if(e){const s=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);null!=s&&h>s&&s!==r.nearFar[0]&&s!==r.nearFar[1]&&(h=s)}return h===Number.MAX_VALUE?void 0:h}_ensureLinearDepthArrayBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){Zd(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,r=bt.C7.BACKGROUND,s=!1;const n={preRender:s=>{let{time:n}=s;i=this.updating,r=this._needsUpdate?bt.C7.UPDATE:bt.C7.BACKGROUND,e.commitSyncLayers(),n=this._testTime??n,((0,ht.l5)(n-this._lastAnimationUpdate)>this.renderer.animationTimestep||null!=t.forcedAnimationTime||i||this._needsRender)&&(this.renderer.updateAnimation(t,n)&&this.requestRender(bt.C7.BACKGROUND),this._lastAnimationUpdate=n)},render:e=>{let{time:i}=e;if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,i=this._testTime??i,this.renderer.render(t,i),s=!0,e&&this.renderer.hasReflections&&(this.requestRender(bt.C7.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:e=>{let{time:i}=e;this._textures.update();const r=new Kw(t,this.renderer.fboCache);i=this._testTime??i,this._screenshotManager.update(r,i)},finish:()=>{s&&(this.renderer.finish(t.mode===bn.M.IDLE?r:bt.C7.UPDATE),s=!1)}};this._frameTask=(0,f.addFrameTask)(n)}_initializeContext(e){const{options:t}=e,i=t.canvas??document.createElement("canvas");i.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=i;const r={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},s=i.getContext("webgl2",r);if(null==s)return void u.A.getLogger(this).error("A WebGL2 context could not be created.");this._rctx=function(e,t){const i=(e,i)=>t.view.resourceController.memoryController.newCache(e,i),r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8,newCache:i};if(ex){let t=ix.get(e);return t?(t.configure(r),t.ref(),t):(t=new Uw(e,r),ix.set(e,t),t.ref(),t)}return new Uw(e,r)}(s,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&u.A.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:n}=e;!this._rctx.contextAttributes.alpha&&(0,d.A)("safari")>=11&&(n.style.backgroundColor="black"),n.contains(i)||n.appendChild(i)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get componentObjectCollection(){return null==this._componentObjects&&(this._componentObjects=new by(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}updateQualitySettings(e){null!=this._testTime&&(this._savedFadeDuration=e.fadeDuration,e.fadeDuration=(0,ht.l5)(0))}set testTime(e){this._testTime=e,null==e?this.stage.view.qualitySettings.fadeDuration=this._savedFadeDuration:this.updateQualitySettings(this.stage.view.qualitySettings)}get testTime(){return this._testTime}};(0,r._)([(0,w.MZ)({type:Boolean,readOnly:!0})],tx.prototype,"updating",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],tx.prototype,"stage",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"_rctx",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"_canvas",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"stippleTextures",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"markerTextures",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"waterTextures",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],tx.prototype,"olidRenderHelper",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"_textures",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],tx.prototype,"renderer",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"_screenshotManager",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"componentObjectCollection",null),(0,r._)([(0,w.MZ)()],tx.prototype,"_componentObjects",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"_needsUpdate",void 0),(0,r._)([(0,w.MZ)()],tx.prototype,"_needsWaterReflectionUpdate",void 0),tx=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.parts.RenderView")],tx);const ix=Qw();let rx=class extends M.default{constructor(e){super(e),this._model=new dg,this._layers=new oo.A,this._asyncChangeSet=new tg.VR,this._syncChangeSet=new tg.VR,this._layerSyncSet=new Set}initialize(){this._set("renderView",new tx({stage:this})),this._frameTask=this.view.resourceController.scheduler.registerTask(it.W6.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){return this.renderView?.renderer}add(e){this._model.add(e),(0,rg.r)(e)&&this._addLayer(e),this.renderView.requestRender()}remove(e){null!=e&&!this.destroyed&&this._model.remove(e)&&((0,rg.r)(e)&&this._removeLayer(e),this.renderView.requestRender())}addMany(e){null!=e&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){null!=e&&(this._model?.removeMany(e),this.renderView?.requestRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),!e.hasProgressed)return rt.G}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{if(e.done)return;const r=this._layerSyncSet.has(i.id)||i.updatePolicy===ig.q.SYNC,s=r?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,s),this._layerSyncSet.delete(i.id),s.empty||(this.renderer.modify(s,r?it.Bb:e),this.renderView.requestRender(),e.madeProgress())})),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,it.Bb),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==ig.q.ASYNC||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===ig.q.SYNC?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)}));for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,it.Bb),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,it.Bb),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,it.Bb))}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),r=()=>{Hh(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if((0,_.isPromiseLike)(i))return i.then(r);r()}removeRenderPlugin(e){this.destroyed||(Hh(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get performanceInfo(){return this._model.getStats()}get test(){}};(0,r._)([(0,w.MZ)({constructOnly:!0})],rx.prototype,"view",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],rx.prototype,"options",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],rx.prototype,"viewingMode",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],rx.prototype,"container",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],rx.prototype,"updating",null),(0,r._)([(0,w.MZ)({constructOnly:!0})],rx.prototype,"_model",void 0),(0,r._)([(0,w.MZ)()],rx.prototype,"renderView",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],rx.prototype,"renderer",null),(0,r._)([(0,w.MZ)({readOnly:!0})],rx.prototype,"running",null),rx=(0,r._)([(0,C.$)("esri.views.3d.webgl-engine.Stage")],rx);var sx=i(28008),nx=i(19983),ax=i(53605),ox=i(66380),lx=i(81202);const hx=new Set,cx=()=>u.A.getLogger("esri/views/support/TextureCompressionHelper");var dx=i(92077),ux=i(42804);let px=class extends ux.default{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};(0,r._)([(0,w.MZ)()],px.prototype,"components",void 0),px=(0,r._)([(0,C.$)("esri.views.ui.3d.DefaultUI3D")],px);const mx=px;let _x=class extends((0,B.c)((0,$.e)((0,W.u)(Q.default)))){constructor(e){var t;super(e),t=this,this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new vn.M({slicePlane:U.B},this),this._resourceController=function(e){return new Cc({view:e})}(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Qo({view:this}),this.labeler=new Xo.C({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new k.X,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Ce,this.environment=new jt,this.environmentManager=new Nt,this.floors=new a.default,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new he({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Ch({view:this}),this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new mx,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.focusAreas=new Z.T({view:this}),(0,b.n_)();const i=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!=e&&e.type===m.R.MOVE||(t._updatingChanged(),t.map&&t.map.allLayers.forEach((async e=>{try{await e.when()}catch{}t._updatingChanged()})))};this.addHandles([(0,g.on)((()=>this.map?.allLayers),"after-changes",(e=>i(e)),{onListenerAdd:()=>i(),onListenerRemove:()=>i(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),(0,g.watch)((()=>this.map),(e=>{e&&"load"in e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new ao({view:this}),this.stateManager=new wn({view:this})}initialize(){if((0,d.A)("enable-feature:esri-compress-textures")){const e=function(e,t){return km.g.compressionWorkerHandle??=new Ym((0,lx.m)(t)),hx.has(e)?cx().warn("Repeated texture compression worker initialization by the same view."):hx.add(e),km.g.compressionWorkerHandle}(this,this.resourceController);this.addResolvingPromise(e.promise)}this.groundView=new j.default({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.addHandles((0,g.on)((()=>this.map?.allLayers),"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),g.initial),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),g.initial),this.updatingHandles.add((()=>this.qualitySettings.frameRate??0),(e=>(0,f.setFrameDuration)(e>0?1e3/Math.ceil(e):0)),g.initial),this.updatingHandles.add((()=>this.map?.ground),e,g.syncAndInitial),this.updatingHandles.add((()=>this.map?.ground?.opacity),(()=>this._updateDefaultHitTestOptions()),g.syncAndInitial),this.addHandles((0,g.watch)((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),g.sync))}destroy(){this.destroyed||(function(e){km.g.compressionWorkerHandle&&(hx.delete(e)||cx().warn("Unknown view attempted to destroy the texture compression worker."),hx.size||((0,p.pR)(km.g.compressionWorkerHandle),km.g.compressionWorkerHandle=null))}(this),this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",(0,p.pR)(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=(0,p.pR)(this.sharedSymbolResources),this._set("labeler",(0,p.pR)(this.labeler)),this._set("deconflictor",(0,p.pR)(this.deconflictor)),this._resourceController=(0,p.pR)(this._resourceController),this._set("stateManager",(0,p.pR)(this.stateManager)),this._set("inputManager",(0,p.pR)(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",(0,p.pR)(this.environmentManager)),this._set("environment",(0,p.pR)(this.environment)),this.groundView=(0,p.pR)(this.groundView),this._exitBasemapTerrain(),this._stage?.destroy())}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{sticky:!1};return this.stateManager.installContentCameraReset(e)}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||(0,p.eJ)(e,"clippingArea");return!this._userClippingArea&&!(0,p.eJ)(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof P.default?this.spatialReference&&(t=gx(t,this.spatialReference),null==t)?(u.A.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(u.A.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?u.A.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===X.RT.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:gx(t,e)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||N.default.WGS84,i=gx(this.clippingArea,t);null!=i&&(e=null!=e?e.intersection(i):i);const r=this._get("dataExtent");return null!=e&&e.equals(r)?r:e}get _groundAndLayersExtent(){const e=this.spatialReference||N.default.WGS84;let t;const i=i=>{const r=gx(i,e);null!=r&&(null!=t?t.union(r):t=r.clone())},r=this.basemapTerrain;if(r?.spatialReference){const e=r.groundExtent;i(new P.default({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const e=e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||i(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(null==t)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const s=this._get("_groundAndLayersExtent");return t.equals(s)?s:t}castEnvironment(e){return e?e instanceof jt?e:e instanceof kt.default?this.environment?.cloneWithWebsceneEnvironment(e)??jt.fromWebsceneEnvironment(e):(0,T.dp)(jt,e):new jt}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){Bh.isValidProfile(e)&&(Bh.apply(e,this.qualitySettings),this._stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||Bh.getDefaultProfile()}set slicePlane(e){if(null!=this._stage&&(this._stage.renderer.slicePlane=e),null==e)return void this._set("slicePlane",null);const t=this._propertiesPool.get("slicePlane");(0,U.a)(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?(0,G.i1)(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?D.default.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((r=>{if(r.isFulfilled()){if(r.updating){if(t=!0,r.suspended||(0,Nd.eS)(r))return;++i,e+=r.updatingProgress}}else++i}));for(const s of this._updatingObjects)if(null!=s&&s.updating){const t=.1;i+=t,e+=.5*t}for(const s of this._updatingObjectsWithProgress)null!=s&&s.updating&&(++i,e+=s.updatingProgress);const r=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||r||this._createGraphicsViewController||this.inputManager?.updating||this.map?.allLayers?.some((e=>!e.isFulfilled()))||this.textures?.updating),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const i=performance.now();if(e<1){const t=Math.min((i-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?i:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(null!=e)return(0,X._s)(e);const t=this.spatialReference;return t?null!=this.defaultsFromMap?.viewingMode&&t.equals(this.defaultsFromMap.spatialReference)?(0,X._s)(this.defaultsFromMap.viewingMode):(0,ox.M)(t,X.RT.Global)?"global":"local":"global"}set viewingMode(e){this.ready?u.A.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get highlightOptions(){return this.highlights.find((e=>{let{name:t}=e;return t===wh.Tv}))??new sx.default}set highlightOptions(e){for(let t=0;t<this.highlights.length;++t)if(this.highlights.at(t).name===wh.Tv)return void this.highlights.items[t].assignFrom(e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new Tc.default(this)}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return u.A.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=(0,ax.FV)(e)?(0,ax.xB)(this,e):e;return(0,Rh.av)(this,i,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return u.A.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(null==e.z?(0,$h.R1)(this.elevationProvider,e):null)??0;return(0,F.g)(e,fx,this.renderSpatialReference,t),this.state.camera.projectToScreen(fx,yx),(0,y.tc)(yx[0],yx[1])}pixelSizeAt(e,t){if(!this.ready)return u.A.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!e)return 0;const i=this.renderSpatialReference;(0,F.g)(e,fx,i);const r=this.state.camera.computeScreenPixelSizeAt(fx);return t&&i!==t?r*(0,v.GA)(i)/(0,v.GA)(t):r}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,(()=>this.pixelSizeAt(e))):1}hitTest(e,t){if(!this.ready)return u.A.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=(0,ax.FV)(e)?(0,ax.xB)(this,e):e;return(0,Rh.CB)(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return Xh(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new l.default("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(t);return(await Promise.resolve().then(i.bind(i,28757))).encode(r,t,this._pixelFormat())}async _takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(t);return(await Promise.resolve().then(i.bind(i,28757))).encodeData(r,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(t),{encodeData:s}=await Promise.resolve().then(i.bind(i,28757));return[s(r[0],this._pixelFormat()),s(r[1],this._pixelFormat())]}async _completeSettings(e){const{toRenderSettings:t,screenshotSuperSampleSettings:r}=await Promise.resolve().then(i.bind(i,28757)),s=t(e,this);return s.pixelRatio/=this.state.pixelRatio,r(s,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){}async takeScreenshotWithObjectAndLayerId(e){if(!(0,gy.E)())throw new l.default("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:t}=await Promise.resolve().then(i.bind(i,28757)),r=await this._completeSettings(e);await this.whenReady();const s=await this._stage.renderView.takeScreenshotWithOID(r),n=t(s[0],r,this._pixelFormat()),a=await this._completeSettings(e);return a.format="png",[n,t(s[1],a,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const e=this._stage.renderView.olidRenderHelper;if(e)return e.getColorToObjectAndLayerIdMapping();throw new l.default("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return ie(e)}hasLayerViewModule(e){return te(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=(0,dx.z)(this.type);const t=(0,d.A)("safari");if(t&&t<9&&(e=new l.default("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw u.A.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.viewingMode:null)??null;return null!=e?(0,X.yX)(e):null}getSpatialReferenceSupport(e,t){const i=this._predeterminedViewingMode;if(null!=i)return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,X.RT.Local),s=this._validateSpatialReferenceForViewingMode(e,t,X.RT.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,X.RT.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,X.RT.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!(0,ox.M)(e,i)&&(null==t||!!(0,q.qC)(t)||(!(0,q.qK)(t)||null!=(0,Nd.Uo)(t,e,i))&&(!(0,q.qe)(t)||i!==X.RT.Global))}_makeSpatialReferenceConstraints(e,t,i){if(null==t)return[{spatialReference:e,viewingMode:i}];const{isWebMercator:r,isWGS84:s}=e;return(0,q.qC)(t)&&(r||s)?s&&i!==X.RT.Local&&null!==(0,Nd._y)(t.tileInfo,t.fullExtent,e,X.RT.Global)?[{spatialReference:r?N.default.WGS84:N.default.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:N.default.WebMercator,viewingMode:i}]:(0,q.qK)(t)||(0,q.qe)(t)||!r&&!s?(0,q.qK)(t)&&r&&i!==X.RT.Global?[{spatialReference:e,viewingMode:i},{spatialReference:N.default.WGS84,viewingMode:X.RT.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?N.default.WGS84:N.default.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport(e),i=this._predeterminedViewingMode;return t||(null!=i?u.A.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${(0,X._s)(i)} viewing mode.`):e.isGeographic&&u.A.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}trackGraphicState(e){if(!e.graphic)return u.A.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&null!=t&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),(0,c.hA)((()=>{r=!0,null!=i&&(i.remove(),i=null)}))}maskOccludee(e){if(!e)return u.A.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&null!=t&&(0,nx.Uk)(t)&&(i=t.maskOccludee(e))};return null!=t?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),(0,c.hA)((()=>{r=!0,null!=i&&(i.remove(),i=null)}))}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.filter((e=>"media-3d"!==e.type)).find((t=>t.layer===e.layer)):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await(0,g.whenOnce)((()=>this.graphicsView)),this.graphicsView;if(!e.layer||!this.map)throw new l.default("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{s.added.includes(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new q_({view:this})),this._set("elevationProvider",new qh({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new md({view:this})),this._set("featureTiles",new yh({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=null!=this.basemapTerrain.extent&&null!=this.basemapTerrain.spatialReference?(0,L.project)((0,V.w1)(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((()=>ho.b.FEATURE_TILE_TREE_SHOW_TILES),(e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(i.e(64487).then(i.bind(i,64487))).then((e=>{let{FeatureTileTree3DDebugger:t}=e;!this._featureTreeDebugger&&ho.b.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))})):e||!this._featureTreeDebugger||ho.b.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),g.syncAndInitial),this.updatingHandles.add((()=>this.clippingArea),e,g.syncAndInitial),this.updatingHandles.add((()=>this.basemapTerrain.extent),e,g.syncAndInitial)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.featureTiles&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this._set("featureTiles",(0,p.pR)(this.featureTiles)),this._set("pointsOfInterest",(0,p.pR)(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference,t=this.state.isGlobal,i=(0,z.Gs)(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",ac.d.create(this.state.viewingMode,i)),t||this.addHandles((0,g.watch)((()=>this.basemapTerrain?.extent),(e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!(0,H.S)(e,this.basemapTerrain.spatialReference,vx,t)||(this.renderCoordsHelper.extent=vx)}),g.sync),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(lr.TH/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!=e&&e.type===m.R.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.addHandles((0,g.watch)((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),g.sync),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;const r=e.getContext("2d");return r.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t}),r.getImageData(0,0,i.width,i.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,i)=>this._renderScreenshotOverlay(e,t,i)}},t=new Eh(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=(0,o.$)(this.surface);this._stage=new rx({view:this,options:e,container:i}),this._stage.renderer.slicePlane=this.slicePlane,this.addHandles([this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this._stage.renderer.setParameters({highQualityTransparency:e})),g.initial),this.on("pointer-move",(()=>this._stage?.renderer.resetAnimation())),(0,h.on)(this._stage.renderView.canvas,"webglcontextlost",(e=>{this.fatalError=new l.default("webgl-context-lost",e.statusMessage)}))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(lr.TH/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=(0,p.pR)(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Nc({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await Promise.all([i.e(60071),i.e(66836),i.e(61982)]).then(i.bind(i,61982))).default;(0,_.throwIfAborted)(e),await(0,g.whenOnce)((()=>this.basemapTerrain?.ready),e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),null!=this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=(0,X.yX)(this.viewingMode);e===X.RT.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles((0,g.on)((()=>this.graphics),"after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded();const t=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties:null,i=t?.environment;i&&(this._overrideDefaultEnvironmentOnly?A(this.environment,i):this.environment=this.environment.cloneWithWebsceneEnvironment(i)),this.timeExtent=t?.timeExtent,this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new Oc(this._stage,this.resourceController.scheduler));const r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",(0,p.pR)(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Ar.fo);for(const e of this.map.allLayers.items)(0,q.Eq)(e.type)&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Ar.fo);for(const e of this.map.allLayers.items)(0,q.Eq)(e.type)&&e.opacity<1&&this._defaultHitTestOptions.exclude.add(e.uid)}}};function gx(e,t){return null!=e&&(0,L.canProjectWithoutEngine)(e.spatialReference,t)?(0,L.project)(e,t):null}_x.type="3d",(0,r._)([(0,w.MZ)()],_x.prototype,"_userClippingArea",void 0),(0,r._)([(0,w.MZ)()],_x.prototype,"_resourceController",void 0),(0,r._)([(0,w.MZ)()],_x.prototype,"_stage",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"deconflictor",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"labeler",void 0),(0,r._)([(0,w.MZ)((0,O.C)(k.X,"analyses"))],_x.prototype,"analyses",void 0),(0,r._)([(0,w.MZ)({type:Y.default,readOnly:!0})],_x.prototype,"animation",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"basemapTerrain",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"elevationProvider",void 0),(0,r._)([(0,w.MZ)()],_x.prototype,"camera",null),(0,r._)([(0,w.MZ)({type:s.default})],_x.prototype,"contentCamera",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"canvas",void 0),(0,r._)([(0,w.MZ)({type:I.default})],_x.prototype,"center",null),(0,r._)([(0,w.MZ)({type:P.default})],_x.prototype,"clippingArea",null),(0,r._)([(0,w.MZ)({type:Ce})],_x.prototype,"constraints",void 0),(0,r._)([(0,w.MZ)({type:P.default,readOnly:!0})],_x.prototype,"renderDataExtent",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"tileInfo",null),(0,r._)([(0,w.MZ)({type:P.default,readOnly:!0})],_x.prototype,"dataExtent",null),(0,r._)([(0,w.MZ)({type:P.default,readOnly:!0})],_x.prototype,"_groundAndLayersExtent",null),(0,r._)([(0,w.MZ)({type:jt})],_x.prototype,"environment",void 0),(0,r._)([(0,x.w)("environment")],_x.prototype,"castEnvironment",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"environmentManager",void 0),(0,r._)([(0,w.MZ)({type:P.default})],_x.prototype,"extent",null),(0,r._)([(0,w.MZ)({type:a.default})],_x.prototype,"floors",void 0),(0,r._)([(0,w.MZ)()],_x.prototype,"screenCenter",null),(0,r._)([(0,w.MZ)()],_x.prototype,"frustum",null),(0,r._)([(0,w.MZ)({type:Number,readOnly:!0})],_x.prototype,"fullOpacity",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"graphicsView",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"analysisViewManager",void 0),(0,r._)([(0,w.MZ)()],_x.prototype,"groundView",void 0),(0,r._)([(0,w.MZ)({type:Boolean})],_x.prototype,"initialExtentRequired",null),(0,r._)([(0,w.MZ)()],_x.prototype,"defaultsFromMapSettings",null),(0,r._)([(0,w.MZ)()],_x.prototype,"interacting",null),(0,r._)([(0,w.MZ)()],_x.prototype,"stationary",null),(0,r._)([(0,w.MZ)()],_x.prototype,"navigating",null),(0,r._)([(0,w.MZ)()],_x.prototype,"map",void 0),(0,r._)([(0,w.MZ)()],_x.prototype,"padding",null),(0,r._)([(0,w.MZ)({type:md,readOnly:!0})],_x.prototype,"pointsOfInterest",void 0),(0,r._)([(0,w.MZ)({type:yh,readOnly:!0})],_x.prototype,"featureTiles",void 0),(0,r._)([(0,w.MZ)()],_x.prototype,"_featureTreeDebugger",void 0),(0,r._)([(0,w.MZ)({type:Boolean})],_x.prototype,"screenSizePerspectiveEnabled",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],_x.prototype,"deactivatedWebGLExtensions",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],_x.prototype,"debugWebGLExtensions",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],_x.prototype,"renderCanvas",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],_x.prototype,"state",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"inputManager",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"stateManager",void 0),(0,r._)([(0,w.MZ)({type:["low","medium","high"]})],_x.prototype,"qualityProfile",null),(0,r._)([(0,w.MZ)({type:nc,get(){let e=this._get("qualitySettings");return e||(e=new nc,Bh.apply(this.qualityProfile,e)),e}})],_x.prototype,"qualitySettings",void 0),(0,r._)([(0,w.MZ)()],_x.prototype,"slicePlane",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"typeSpecificPreconditionsReady",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"sceneIntersectionHelper",void 0),(0,r._)([(0,w.MZ)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],_x.prototype,"resolution",null),(0,r._)([(0,w.MZ)({type:Number})],_x.prototype,"scale",null),(0,r._)([(0,w.MZ)()],_x.prototype,"heightModelInfo",null),(0,r._)([(0,w.MZ)()],_x.prototype,"spatialReference",void 0),(0,r._)([(0,w.MZ)({type:Boolean,constructOnly:!0})],_x.prototype,"alphaCompositingEnabled",void 0),(0,r._)([(0,w.MZ)({constructOnly:!0})],_x.prototype,"preserveDrawingBufferEnabled",void 0),(0,r._)([(0,w.MZ)({type:Boolean})],_x.prototype,"supersampleScreenshotsEnabled",void 0),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"type",void 0),(0,r._)([(0,w.MZ)(),(0,x.w)((e=>e instanceof ux.default?e:(0,T.PZ)(mx,e)))],_x.prototype,"ui",void 0),(0,r._)([(0,w.MZ)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],_x.prototype,"updating",null),(0,r._)([(0,w.MZ)()],_x.prototype,"_updatingObjects",null),(0,r._)([(0,w.MZ)()],_x.prototype,"_updatingObjectsWithProgress",null),(0,r._)([(0,w.MZ)({type:Number,readOnly:!0,dependsOn:["updating"]})],_x.prototype,"updatingProgress",void 0),(0,r._)([(0,w.MZ)({type:["global","local"]})],_x.prototype,"viewingMode",null),(0,r._)([(0,w.MZ)({type:n.default})],_x.prototype,"viewpoint",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"visibleArea",null),(0,r._)([(0,w.MZ)({type:Number})],_x.prototype,"zoom",null),(0,r._)([(0,w.MZ)({type:sx.default})],_x.prototype,"highlightOptions",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"quality",null),(0,r._)([(0,w.MZ)({readOnly:!0})],_x.prototype,"resolutionScale",null),(0,r._)([(0,w.MZ)()],_x.prototype,"textures",void 0),_x=(0,r._)([(0,C.$)("esri.views.SceneView")],_x);const fx=(0,E.vt)(),yx=(0,y.gs)(),vx=(0,V.vt)(),bx=_x},70586:(e,t,i)=>{i.d(t,{e:()=>o,m:()=>n});var r=i(30142),s=i(90772);class n{constructor(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:o(e,t,i);this._tilingScheme=r,this.id=n,this.lij=[0,0,0],this.extent=(0,s.vt)(),this.measures=new a,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=e,this.lij[1]=t,this.lij[2]=i,r.getExtent(e,t,i,this.extent)}get planetRadius(){return(0,r.tO)(this.spatialReference).radius}get spatialReference(){return this._tilingScheme.spatialReference}get resolution(){return this._tilingScheme.resolutionAtLevel(this.measures.lodLevel)}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const e=this.lij[0]+1,t=2*this.lij[1],i=2*this.lij[2];return[new n(e,t,i,this._tilingScheme),new n(e,t+1,i,this._tilingScheme),new n(e,t,i+1,this._tilingScheme),new n(e,t+1,i+1,this._tilingScheme)]}}class a{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}}function o(e,t,i){return`${e}/${t}/${i}`}},71311:(e,t,i)=>{var r;i.d(t,{S:()=>r}),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.InvisibleWithDraped=2]="InvisibleWithDraped",e[e.Invisible=3]="Invisible",e[e.COUNT=4]="COUNT"}(r||(r={}))},72678:(e,t,i)=>{i.d(t,{D:()=>n});var r=i(93800),s=i(21484);class n extends s.K{constructor(){super(...arguments),this.receiveShadows=!0}}(0,r._)([(0,s.W)()],n.prototype,"receiveShadows",void 0)},73795:(e,t,i)=>{var r,s;i.d(t,{M:()=>s,T:()=>r}),function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(r||(r={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(s||(s={}))},73982:(e,t,i)=>{i.d(t,{C:()=>H,b:()=>N});var r=i(23311),s=i(73803),n=i(55426),a=i(88242),o=i(77548),l=i(49443),h=i(96236),c=i(75304),d=i(69261),u=i(769),p=i(8375),m=i(4127),_=i(22860),g=i(65228),f=i(60464),y=i(94564),v=i(61209),b=i(3290),w=i(10894),x=i(12796),C=i(42072),T=i(53769),M=i(61535),S=i(12188),R=i(96757),A=i(96109),E=i(16878),O=i(73712),P=i(67058),D=i(14480),I=i(8118),L=i(12621);function N(e){const t=new I.N5,{vertex:i,fragment:N}=t;t.include(m.em,e),t.include(p.Mh,e),t.include(u.c,e),t.include(d.U,e),t.include(l.oD,e),t.include(a.cz,e),t.include(R.H,e),N.include(c.S4,e),t.include(C.E,e),t.include(M.Z,e);const{output:H,pbrMode:F,hasNormalTexture:V,snowCover:U,receiveShadows:z,spherical:G,ellipsoidMode:q}=e,k=F===x.A9.Normal||F===x.A9.Schematic;k&&(t.include(x._Z,e),V&&t.include(v.W,e));const B=H===h.V.Shadow||H===h.V.ShadowHighlight||H===h.V.ShadowExcludeHighlight,W=B&&e.componentData===a.Sg.Varying,Z=e.integratedMeshMode===n.g.ColorOverlay||e.integratedMeshMode===n.g.ColorOverlayWithWater;if(Z){t.include(b.kA,e),t.include(S.Tv,e);const s=q===A.T.Earth,n=q===A.T.Earth,a=s?r.$O.radius:n?r.sH.radius:r.Sw.radius;i.code.add(`\n      ${(0,E.If)(G,`const float invRadius = ${E.H.float(1/a)};`)}\n      vec2 projectOverlay(vec3 pos) { return pos.xy ${(0,E.If)(G,"/ (1.0 + invRadius * pos.z);")}; }`)}const j=Z&&(0,h.RN)(H)&&F===x.A9.WaterOnIntegratedMesh;j&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"));const $=e.vertexDiscardMode===o.q.None,Q=e.vertexDiscardMode===o.q.Opaque;if(i.main.add(E.H`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${(0,E.If)(W,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${(0,E.If)(!$,`{ if (externalColor.a ${Q?">":"<="} ${E.H.float(1-1/255)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${(0,E.If)(H===h.V.ObjectAndLayerIdColor,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepth();
    forwardObjectAndLayerIdColor();
    ${(0,E.If)(j,G?E.H`
              groundNormal = normalize(positionWorld());
              tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
              tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:E.H`
              groundNormal = vec3(0.0, 0.0, 1.0);
              tbnTangent = vec3(1.0, 0.0, 0.0);
              tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${(0,E.If)(Z,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${E.H.float(L.Q)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),(0,h.RN)(H))return t.include(y.o,e),t.include(f.g,e),t.include(b.kA,e),t.include(D.z,e),z&&t.include(T.G,e),N.code.add(E.H`
      float evaluateShadow() {
        return ${z?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),Z&&N.uniforms.add(new P.N("ovColorTex",((e,t)=>(0,S.Lg)(e,t)))),N.main.add(E.H`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
      ${(0,E.If)(Z,E.H`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}
    `),k?((0,w.O4)(N),G&&(0,b.eU)(N),N.main.add(E.H`
        applyPBRFactors();
        ${(0,E.If)(F===x.A9.Normal,E.H`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${(0,E.If)(V,"mat3 tangentSpace = computeTangentSpace(fragmentShadingNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${V?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 normalGround = ${G?E.H`normalize(positionWorld())`:E.H`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${(0,E.If)(U,E.H`float snow = smoothstep(0.5, 0.55, dot(fragmentFaceNormal, normalize(positionWorld())));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${(0,E.If)(Z,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 emission = getEmissions();
        ${(0,E.If)(G,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${G?E.H`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(G&&(0,b.eU)(N),j&&N.uniforms.add(new O.x("ovNormalTex",(e=>e.overlay?.getTexture(s.A.WaterNormal)))),N.main.add(E.H`
        ${(0,E.If)(G,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${z?G?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":G?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${(0,E.If)(U,E.H`float snow = smoothstep(0.5, 0.55, dot(fragmentFaceNormal, normalize(positionWorld())));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${(0,E.If)(Z,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${(0,E.If)(j,E.H`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),N.main.add("outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative);"),t;const Y=H===h.V.Normal,X=H===h.V.ObjectAndLayerIdColor,K=H===h.V.Highlight,J=B||H===h.V.ViewshedShadow;return J&&t.include(_.L,e),Y&&t.include(f.g,e),t.include(g.Q,e),N.main.add(E.H`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${(0,E.If)(J,"outputDepth(linearDepth);")}
    ${(0,E.If)(Y,E.H`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${(0,E.If)(X,Z?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${(0,E.If)(K,E.H`${(0,E.If)(Z,E.H`
           vec2 overlayHighlightTexel = getAllOverlayHighlightValuesEncoded();
           calculateOcclusionAndOutputHighlightOverlay(overlayHighlightTexel);`,E.H`calculateOcclusionAndOutputHighlight();`)}`)}`),t}const H=Object.freeze(Object.defineProperty({__proto__:null,build:N},Symbol.toStringTag,{value:"Module"}))},74871:(e,t,i)=>{i.d(t,{$8:()=>_,Md:()=>y,ld:()=>v,qI:()=>g,uf:()=>w});var r=i(64682),s=i(87752),n=i(10382),a=i(32006),o=i(98080),l=i(89227),h=i(28473),c=i(51064),d=i(11443),u=i(11741);const p={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class m{constructor(e,t){this.direct=e,this.ambient=t}}function _(e,t,i,s,n,c){(0,l.i)(c.ambient.color,1,1,1),c.ambient.intensity=p.global.ambient,(0,l.i)(c.direct.color,1,1,1),c.direct.intensity=p.global.direct;const u=t[2],m=(0,r.qE)((Math.abs(u)-p.local.altitude)/(p.global.altitude-p.local.altitude),0,1);let _;if(c.globalFactor=m,null!=e&&(_=d.S.getTimes(e,t[1],t[0])),m<1){let t;if(null!=e)t=function(e,t,i){const r=e.valueOf();let s,n;t.polarException===d.S.PolarException.MIDNIGHT_SUN?(s=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===d.S.PolarException.POLAR_NIGHT?(s=r-2,n=r-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const c=n-s,u=s+c/2,p=c/4,m=u-p,_=u+p,g=.06*c,f=s-g/2,y=s+g/2,v=n-g/2,b=n+g/2,w=(0,o.vt)(),x=(0,h.vt)(),C=(0,h.vt)();let B="";if(r<f||r>b)(0,a.C)(w,L),(0,l.c)(x,S),(0,l.c)(C,O),B="night";else if(r<y){const e=(r-f)/(y-f);(0,a.Cc)(w,L,N,e),(0,l.m)(x,S,R,e),(0,l.m)(C,O,P,e),B="sun rising"}else if(r<m){const e=(r-y)/(m-y);(0,a.Cc)(w,N,H,e),(0,l.m)(x,R,A,e),(0,l.m)(C,P,D,e),B="early morning"}else if(r<u){const e=(r-m)/(u-m);(0,a.Cc)(w,H,F,e),(0,l.m)(x,A,E,e),(0,l.m)(C,D,I,e),B="late morning"}else if(r<_){const e=(r-u)/(_-u);(0,a.Cc)(w,F,V,e),(0,l.m)(x,E,U,e),(0,l.m)(C,I,z,e),B="early afternoon"}else if(r<v){const e=(r-_)/(v-_);(0,a.Cc)(w,V,G,e),(0,l.m)(x,U,q,e),(0,l.m)(C,z,k,e),B="late afternoon"}else if(r<b){const e=(r-v)/(b-v);(0,a.Cc)(w,G,L,e),(0,l.m)(x,q,S,e),(0,l.m)(C,k,O,e),B="sun setting"}let W=0;switch(i){case"rainy":case"foggy":W=.8;break;case"snowy":W=.5}W>0&&(M(x,W),M(C,W));const Z=T(i);return{direct:{intensity:w[0]*Z.direct,color:x},ambient:{intensity:w[1]*Z.ambient,color:C},timeOfDay:B}}(e,_,s);else{const e=T(s);t={direct:{intensity:p.local.directAtNoon*e.direct,color:(0,h.fA)(1,1,1)},ambient:{intensity:p.local.ambientAtNoon*e.ambient,color:(0,h.fA)(1,1,1)},timeOfDay:"early afternoon"}}(0,l.m)(c.ambient.color,t.ambient.color,c.ambient.color,m),c.ambient.intensity=(0,r.Cc)(t.ambient.intensity,c.ambient.intensity,m),(0,l.m)(c.direct.color,t.direct.color,c.direct.color,m),c.direct.intensity=(0,r.Cc)(t.direct.intensity,c.direct.intensity,m),c.specularStrength="rainy"===s||"snowy"===s||"foggy"===s?0:1,c.environmentStrength="rainy"===s?.7:"snowy"===s||"foggy"===s?.75:1}c.noonFactor=null!=e?function(e,t){const i=e.valueOf();let s,n;t.polarException===d.S.PolarException.MIDNIGHT_SUN?(s=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===d.S.PolarException.POLAR_NIGHT?(s=i-2,n=i-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const a=s+(n-s)/2;return 1-(0,r.qE)(Math.abs(i-a)/432e5,0,1)}(e,_):1,null!=e?f(e,t,i,c.direct.directionToLightSource):g(n,i,c.direct.directionToLightSource)}function g(e,t,i){t===c.RT.Global?(0,l.n)(Z,e.eye):(0,l.i)(Z,0,0,1),(0,l.h)(j,e.viewForward,-1);const r=(0,u.g7)(j,Z),n=Math.max(r-2*Q,0),a=.85*n/(n+1),o=Math.max(Q,r-Q-a);(0,s.$0)(W,-o,e.viewRight),(0,l.t)(i,j,W),(0,l.g)(i,i,(0,l.h)($,e.viewRight,Y)),(0,l.n)(i,i)}function f(e,t,i,n){const a=C,o=(0,s.D_)(x);if(i===c.RT.Global)d.S.getPosition(e,0,0,a),(0,l.i)(n,0,0,-1),(0,s.eL)(o,o,-a.azimuth),(0,s.Z8)(o,o,-a.altitude),(0,l.t)(n,n,o);else{const i=p.planarDirection,h=i.globalAngles,c=t[2];let u=(Math.abs(c)-i.localAltitude)/(i.globalAltitude-i.localAltitude);u=(0,r.qE)(u,0,1),u<1?(d.S.getPosition(e,t[1],t[0],a),a.azimuth=(1-u)*a.azimuth+u*h.azimuth,a.altitude=(1-u)*a.altitude+u*h.altitude):(a.azimuth=h.azimuth,a.altitude=h.altitude),(0,l.i)(n,0,-1,0),(0,s.Qr)(o,o,-a.azimuth),(0,s.eL)(o,o,-a.altitude),(0,l.t)(n,n,o)}}function y(e,t){if(t===c.RT.Global)return!0;const i=p.planarDirection;return Math.abs(e)<i.localAltitude}function v(e,t,i,r,s){const n=e.getTime(),a=t.getTime()-n,o=Math.floor(a/i)+1,l=new Array(o);for(let c=0;c<o;++c)B.setTime(n+i*c),l[c]=(0,h.vt)(),f(B,r,s,l[c]);return l}const b=(0,h.fA)(.5773502691896258,-.5773502691896258,.5773502691896258);class w{constructor(){this.ambient={color:(0,h.fA)(1,1,1),intensity:.55},this.direct={color:(0,h.fA)(1,1,1),intensity:.55,directionToLightSource:(0,h.o8)(b)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const x=(0,n.vt)(),C={azimuth:0,altitude:0};function T(e){switch(e){case"disabled":case"sunny":case"cloudy":return new m(1,1);case"rainy":return new m(.4,1.2);case"snowy":return new m(.5,1.3);case"foggy":return new m(.2,1.6)}}function M(e,t){const i=(e[0]+e[1]+e[2])/3;e[0]+=(i-e[0])*t,e[1]+=(i-e[1])*t,e[2]+=(i-e[2])*t}const S=(0,h.fA)(.01,.01,.01),R=(0,h.fA)(1,.6,.5),A=(0,h.fA)(1,.98,.98),E=(0,h.fA)(1,1,1),O=(0,h.fA)(.8,.8,1),P=(0,h.fA)(.8,.8,1),D=(0,h.fA)(.98,.98,1),I=(0,h.fA)(1,1,1),L=(0,o.fA)(.01,p.local.ambientAtNight),N=(0,o.fA)(p.local.directAtTwilight,p.local.ambientAtTwilight),H=(0,o.fA)(.9*p.local.directAtNoon,p.local.ambientAtNoon),F=(0,o.fA)(p.local.directAtNoon,p.local.ambientAtNoon),V=H,U=A,z=D,G=N,q=R,k=P;const B=new Date(0),W=(0,n.vt)(),Z=(0,h.vt)(),j=(0,h.vt)(),$=(0,h.vt)(),Q=.25,Y=.2},75541:(e,t,i)=>{i.d(t,{P:()=>v,b:()=>p});var r=i(89227),s=i(28473),n=i(66027),a=i(87824),o=i(57554),l=i(42403),h=i(16878),c=i(38950),d=i(22131),u=i(8118);function p(e){const t=new u.N5;return t.attributes.add(d.r.POSITION,"vec3"),t.attributes.add(d.r.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new a.d("cameraPosition",(e=>e.camera.eye)),new o.t("offset",((e,t)=>function(e,t){const i=t.camera.eye,s=.5*e.width,n=1/e.width,a=(0,r.K)(m,(0,r.i)(m,(i[0]+s)*n,(i[1]+s)*n,(i[2]+s)*n));return(0,r.a)(a,i,(0,r.h)(a,a,e.width))}(e,t))),new l.m("width",(e=>e.width)),new l.m("time",(e=>e.time)),new c.F("proj",(e=>e.camera.projectionMatrix)),new c.F("view",(e=>e.camera.viewMatrix))),t.varyings.add("vUv","vec2"),t.vertex.code.add(h.H`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),t.vertex.main.add(h.H`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===n.C.Rain?h.H`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:h.H`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),t.fragment.uniforms.add(new l.m("opacity",(e=>e.opacity)),new a.d("particleColor",(t=>function(e,t){const i=t.type===n.C.Rain?f:g,s=(0,r.h)(m,i,y),a=e.camera.eye;(0,r.n)(_,a);const o=Math.max(0,(0,r.f)(_,e.lighting.mainLight.direction));return(0,r.m)(s,s,i,o)}(t,e)))),t.fragment.main.add(h.H`
    float d = length(vUv - vec2(0.5));

    ${e.type===n.C.Rain?h.H`d = 0.35 * smoothstep(0.5, 0.0, d);`:h.H`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),t}const m=(0,s.vt)(),_=(0,s.vt)(),g=(0,s.fA)(1,1,1),f=(0,s.fA)(.85,.85,.85),y=.7,v=Object.freeze(Object.defineProperty({__proto__:null,build:p},Symbol.toStringTag,{value:"Module"}))},75747:(e,t,i)=>{var r;i.d(t,{k:()=>r}),function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(r||(r={}))},76164:(e,t,i)=>{i.d(t,{C:()=>$,c:()=>ee});var r=i(93800),s=i(6946),n=i(58828),a=(i(21265),i(50925)),o=i(17741),l=i(49959),h=i(79953),c=i(48602),d=(i(14746),i(75269)),u=i(98080),p=i(34156),m=i(81192),_=i(65860),g=i(8245),f=i(57392),y=i(79462),v=i(11336),b=i(67350);function w(e){return e instanceof b.Q?e.graphics3DSymbol:e instanceof v.Z?e:null}var x=i(89227),C=i(28473),T=i(4309),M=i(13366),S=i(43353),R=i(93665),A=i(99254);const E=()=>a.A.getLogger("esri.views.3d.layers.graphics.labelPlacement");class O{constructor(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._graphic=e,this._symbol=t,this._class=i,this._disablePlacement=r}get placement(){const e=this._verticalOffsetPlacement;if(null==e)return null;const t=this._getPlacementInfo(e);if(null==t)return null;const i=t.anchor,r=!!e.hasLabelVerticalOffset,s=e.verticalOffset,n=new S.A(s,i,r);return this._calculatePlacementOffsets(n,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:i}=this,r=w(i.graphics3DSymbol),s="point-3d"===r?.symbol.type?r.symbol:null,n=I[e]||this._defaultPlacementInfo;return s?.supportsCallout()&&s.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:s.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t?.hasVisibleVerticalOffset()||null!=s&&s.supportsCallout()&&s.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:n&&function(e){return"above-center"===e}(n.placement)?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(E().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,i=I[t],r=i||this._defaultPlacementInfo;return t&&!i&&E().warnOncePerTick(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(r)}_calculatePlacementOffsets(e,t){const i=this._graphic.graphic.geometry;if(null==i)return null;switch(i.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const r=M.VN-R.Xd;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(null==e)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:C.uY,anchor:"center"};case"polygon":{const e=this._firstSymbolLayer;return"extrude"===e?.type?I["above-center"]:{placement:"center-center",normalizedOffset:C.uY,anchor:"center"}}case"point":case"mesh":return I["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(null==t)return null;if(null!=this._disablePlacement)return this._class.labelPlacement?(E().warnOncePerTick(P(e?.placement,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e;const i=t.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":if(this._class.labelPlacement)return E().warnOncePerTick(P(e?.placement,`'${i}' geometries`)),this._defaultPlacementInfo;break;case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(null==i)return;const r=this._graphic.layers[0];switch(null!=r?r.getCenterObjectSpace(e.translation):(0,x.i)(e.translation,0,0,0),i.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,r);break;case"object":D(e,t,r)}}_setMeshSpecificPlacement(e,t){const i=this._firstSymbolLayer;null!=i&&"fill"===i.type&&D(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(null!=i)switch(i.type){case"extrude":{const i=this._graphic.layers[0];null!=i?(i.getBoundingBoxObjectSpace(H),(0,T.gX)(H,e.translation),e.translation[2]=(0,T.uJ)(H)/2):(0,x.i)(e.translation,0,0,0),D(e,t,i);break}}}_setHUDSpecificPlacement(e,t,i){const{_graphic:r}=this,s=null!=i?i.getScreenSize():null;if(r.isDraped||null==s)e.hasLabelVerticalOffset||"center"===e.anchor||(I[this._class.labelPlacement]&&E().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const i=this._normalizedSymbolAnchorPos;e.screenOffset[0]=s[0]/2*(t.normalizedOffset[0]-i[0]);const r=s[1]/2*(t.normalizedOffset[1]-i[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=r,e.centerOffsetUnits="screen"):e.screenOffset[1]=r}}get _firstSymbolLayer(){const e=w(this._graphic.graphics3DSymbol);return null!=e?e.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0],t=e?.stageObject.geometries[0].material??null;if(t&&t instanceof A.R){const e=t.parameters.anchorPosition;N[0]=2*(e[0]-.5),N[1]=2*(e[1]-.5)}else N[0]=0,N[1]=0;return N}}function P(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function D(e,t,i){const r=null!=i?i.getBoundingBoxObjectSpace(H):H,s=(0,C.fA)(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const a=e.translation[2],o=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=(0,x.l)(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}const I={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},L={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const ie in L){const e=L[ie],t=I[ie];e.forEach((e=>{I[e]=t}))}Object.freeze&&(Object.freeze(I),Object.keys(I).forEach((e=>{Object.freeze(I[e]),Object.freeze(I[e]?.normalizedOffset)})));const N=[0,0],H=(0,T.vt)();var F=i(151);class V{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var U=i(90218),z=i(82192),G=i(22131),q=i(20196),k=i(19565),B=i(38729);class W{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class Z{constructor(e,t,i,r,s){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=s,this.calloutSymbolLayerIndex=0}}class j{constructor(e,t,i,r,s,n,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=n,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new q.x(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}}let $=class extends s.default{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([(0,h.watch)((()=>this.view.state?.camera),(()=>this.setDirty())),(0,h.watch)((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(k.W6.LABELER,this)]),this._textTextureAtlas=new z.C({view:this.view}),this._hudMaterialCollection=new V(this.view._stage),this._calloutMaterialCollection=new V(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=(0,o.WD)(this._textTextureAtlas),this._hudMaterialCollection=(0,o.WD)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,o.WD)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),te.graphic=null,te.renderingInfo=null,te.layer=null}_activateLabelingContext(e){e.graphics.forEach(((t,i)=>{const r=new W(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(g.u.LABEL,g.Z.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(g.u.LABEL,g.Z.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(i,(e=>Y(t.stageObject,e)))),Q(t.stageObject,i))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach((e=>e.remove())),e.textureAtlasHandles.length=0}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),B.G}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(X(t))this._dirty=!0;else if(K(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[i,r]of t.labelsToInitialize)if(this._ensureGraphics3DResources(r)&&(this._labels.set(i,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(i),e.madeProgress()),e.done){this._dirty=!0;break}this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),(0,l.throwIfAborted)(t),e.scaleVisibility?.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo?.filter((e=>!!e.symbol));if(!s||0===s.length)return;let o=!1;await(0,n.jJ)(s,(async(r,s)=>{const h=r.symbol,c=w(i.getOrCreateGraphics3DSymbol(h));if(null==c)return void a.A.getLogger(this).error("Failed to create Graphics3DSymbol for label");await c.load(),(0,l.throwIfAborted)(t);let d=null;(0,_.YX)(h)&&h.hasVisibleCallout()&&(d=(0,f.L)(h,i.symbolCreationContext),await d.load(),(0,l.throwIfAborted)(t));const u=await(0,n.Ke)((0,m.l)(r,e.layer.fieldsIndex,this.view.spatialReference));if((0,l.throwIfAborted)(t),!0===u.ok){const i=await this._createTextRenderParameters(c.symbol);(0,l.throwIfAborted)(t),e.labelClassContexts[s]=new Z(r,c,d,i,u.value)}else a.A.getLogger(this).error(`Label expression failed to evaluate: ${u.error}`),o=!0})),(0,l.throwIfAborted)(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if((0,l.isAbortError)(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:U.G.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,o.DC)(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s,n){const a=new S.J(i,(0,F.Dt)(i.anchor),(0,F.fy)(i.anchor),e.text,(0,u.fA)(e.displayWidth,e.displayHeight));return te.graphic=t,te.layer=r,te.renderingInfo=null,s.createLabel(te,a,this._hudMaterialCollection,this._textTextureAtlas,(()=>n.placement?.elevationOffset??null))}_createLineCalloutGraphic(e,t,i,r,s){te.graphic=e,te.layer=s;const n=r.screenOffset[0];return te.renderingInfo=new y.AG(null,t,r.translation,r.centerOffset,n,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(te)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(K(r)||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let s=!1;const n=t.graphic,a=i.layer,o=ee(i.layer);for(let l=0;l<r.length;l++){const h=e.textRenderers[l],c=e.textLabelPlacements[l];if(null==h||null==c)continue;const d=r[l],u=d.graphics3DSymbol,p=J(u),m=u.symbolLayers[0];if(!m)continue;m.setElevationInfoOverride(i.elevationInfoOverride);const _=new O(t,p,d.labelClass),f=this._createTextSymbolGraphic(h,n,c,a,m,_);if(null==f)return!1;f._labelClass=d.labelClass,f._labelIndex=l,t.addLabelGraphic(f,i.stageLayer),t.deconflictionPriority=d.textRenderParameters?.definition.size??0,t.setVisibilityFlag(g.u.LABEL,g.Z.USER,o),t.setVisibilityFlag(g.u.LABEL,g.Z.SCALE_RANGE,!0),t.setVisibilityFlag(g.u.LABEL,g.Z.DECONFLICTION,!1),s=!0;const y=d.graphics3DCalloutSymbolLayer;if(y&&c.hasLabelVerticalOffset){y.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(n,p,y,c,a);null!=e&&(d.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,i.stageLayer))}break}return s&&i.scaleVisibility?.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];e?.onRemoveGraphic(i)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(K(i))return;const r=e.graphics3DGraphic.graphic;for(let n=0;n<i.length;n++){const a=i[n];if(e.textRenderers[n]=null,e.textLabelPlacements[n]=null,null==a?.textRenderParameters)continue;const o=a.labelFunction;let l;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?(0,p.wP)(r,t.layer):r;l=o.evaluate(e)}catch(s){l=null}else l=o.evaluate(r);if(null==l||""===l||/^\s+$/.test(l))continue;const h=a.graphics3DSymbol;if(!h.symbolLayers[0])continue;const c=e.graphics3DGraphic,d="label-3d"===h.symbol?.type?h.symbol:null,u=a.labelClass,m=t.disablePlacement,_=new O(c,d,u,m).placement;if(null==_)continue;const g=(0,F.Dt)(_.anchor),f=(0,F.QE)(g);e.textRenderers[n]=new R.Js(l,f,a.textRenderParameters,z.C.maxSize),e.textLabelPlacements[n]=_}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new W(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const i=t.graphic.uid,r=this._labels.get(i);if(!r)return!0;for(const s of r.graphics3DGraphic.labelLayers)if(null!=s._labelClass&&!e.labelClassContexts[s._labelIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(s,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.graphics.forEach((e=>r.set(e.graphic.uid,e)));const s=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=ee(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i?.emptySymbolLabelSupported||!1,s=i?.elevationInfoOverride||null,n=i?.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new j(this.view._stage,a,e,t,r,s,n,ee(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),updateGraphicGeometry:e=>this._updateGraphicGeometry(o,e),layerLabelsEnabled:()=>ee(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.textureAtlasHandles.length?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>X(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(X(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){}};function Q(e,t){e.geometries[0].setAttributeData(G.r.SIZE,[t.displayWidth,t.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],G.r.SIZE)}function Y(e,t){e.geometries[0].setAttributeData(G.r.UV0,t),e.geometryVertexAttributeUpdated(e.geometries[0],G.r.UV0,!0)}function X(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function K(e){return!e||0===e.length}function J(e){return"label-3d"===e.symbol?.type?e.symbol:null}function ee(e){return!0===e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}(0,r._)([(0,c.MZ)({constructOnly:!0})],$.prototype,"view",void 0),(0,r._)([(0,c.MZ)({constructOnly:!0})],$.prototype,"deconflictor",void 0),(0,r._)([(0,c.MZ)()],$.prototype,"_textTextureAtlas",void 0),(0,r._)([(0,c.MZ)({type:Boolean,readOnly:!0})],$.prototype,"updating",null),$=(0,r._)([(0,d.$)("esri.views.3d.layers.graphics.Labeler")],$);const te=new y.Rj(null,null,null)},76809:(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});class r{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}}},76845:(e,t,i)=>{i.r(t),i.d(t,{default:()=>l});var r=i(93800),s=i(19455),n=i(48602),a=(i(21265),i(50925),i(14746),i(75269));let o=class extends s.A{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};(0,r._)([(0,n.MZ)({readOnly:!0,json:{read:!1}})],o.prototype,"type",void 0),o=(0,r._)([(0,a.$)("esri.webscene.background.Background")],o);const l=o},77548:(e,t,i)=>{var r;i.d(t,{q:()=>r}),function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(r||(r={}))},78073:(e,t,i)=>{i.r(t),i.d(t,{default:()=>a});var r=i(87436),s=i(37255),n=i(76809);class a{constructor(e){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,null!=e.resourceController){const t=e.resourceController.memoryController;this.totalMemory=(t.maxMemory??0)*r.u.MEGABYTES,this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=t.usedCacheMemory}this.terrainMemory=e.basemapTerrain?.usedMemory??0,this.edgesMemory=e._stage?.renderer.usedMemory.edges??0,this.fboMemory=e._stage?.renderer.usedMemory.fbos??0,e.allLayerViews?.items.forEach((e=>{(0,s.T)(e)&&this.layerPerformanceInfos.push(new n.default(e))})),this.layerPerformanceInfos.sort(((e,t)=>t.memory-e.memory))}}},79381:(e,t,i)=>{i.d(t,{q:()=>n});var r=i(28826);function s(e,t){if(e.priority-t.priority)return e.priority-t.priority;const i=e.tile.key,r=t.tile.key;return i.world-r.world?i.world-r.world:i.level-r.level?i.level-r.level:i.row-r.row?i.row-r.row:i.col-r.col?i.col-r.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}class n{get running(){return this._running}constructor(e,t,i,r,s,n){this._visibleTiles=e,this._symbolRepository=t,this._createCollisionJob=i,this._assignTileSymbolsOpacity=r,this._symbolLayerSorter=s,this._isLayerVisible=n,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}return this._running=!1,!0}_createSelectionJob(){const e=this._symbolRepository.uniqueSymbols;for(let s=0;s<e.length;s++){const t=e[s];for(let e=0;e<t.uniqueSymbols.length;e++){const i=t.uniqueSymbols[e];for(const e of i.tileSymbols)e.selectedForRendering=!1}}const t=[];let i=0,r=0;const n=this._isLayerVisible;const a=this._symbolLayerSorter;return{work:function(a){let o;const l=performance.now();for(;r<e.length;r++,i=0){const s=e[r],h=s.styleLayerUID;if(!n(h)){t[r]||(t[r]={styleLayerUID:h,symbols:[]});continue}t[r]=t[r]||{styleLayerUID:h,symbols:[]};const c=t[r];for(;i<s.uniqueSymbols.length;i++){if(o=s.uniqueSymbols[i],i%100==99&&performance.now()-l>a)return!1;let e=null,t=!1,r=!1;for(const i of o.tileSymbols)if(!r||!t){const s=i.tile;(!e||s.isCoverage||s.neededForCoverage&&!t)&&(e=i,(s.neededForCoverage||s.isCoverage)&&(r=!0),s.isCoverage&&(t=!0))}if(e.selectedForRendering=!0,r){c.symbols.push(e),o.show=!0;for(const e of o.parts)e.show=!0}else o.show=!1}}for(const e of t)e.symbols.sort(s);return!0},get sortedSymbols(){return t.sort(a)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let i=0;function r(t,i){for(const e of t.symbols.values())a(e,i);e(t,i);for(const e of t.childrenTiles)r(e,i)}return{work(e){const s=performance.now();for(;i<t.length;i++){if(performance.now()-s>e)return!1;const n=t[i];null==n.parentTile&&r(n,performance.now())}return!0}}}}function a(e,t){for(const i of e){const e=i.unique;for(const i of e.parts){const s=i.targetOpacity>.5?1:-1;i.startOpacity+=s*((t-i.startTime)/r.zk),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=e.show&&i.show?1:0}}}},81146:(e,t,i)=>{i.d(t,{O:()=>l});var r=i(89227),s=i(28473),n=i(88664),a=i(23521);class o extends a.t{constructor(e,t,i,r,s){super(e,t,i),this._sceneVelocity=r,this.direction=s}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}}class l{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._time=new n.S(.6),this._screen=[new n.S(.4),new n.S(.4)],this._scene=[new n.S(.6),new n.S(.6),new n.S(.6)],this._tmpDirection=(0,s.vt)()}add(e,t,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?0:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,s=null==r||null==i?0:i/r;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,i){(0,r.i)(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const s=(0,r.l)(this._tmpDirection);s>0&&(0,r.h)(this._tmpDirection,this._tmpDirection,1/s);const n=this._time.filteredDelta;return new o(e,t,i,null==n?0:s/n,this._tmpDirection)}}},81192:(e,t,i)=>{i.d(t,{W:()=>f,l:()=>g});var r=i(74719),s=i(50925),n=i(14125),a=i(66845),o=i(23224),l=i(7249),h=i(95011),c=i(61381),d=i(78534),u=i(96247);const p=()=>s.A.getLogger("esri.layers.support.labelFormatUtils"),m={type:"simple",evaluate:()=>null},_={getAttribute:(e,t)=>e.field(t)};async function g(e,t,i){if(!e||!e.symbol||!t)return m;const s=e.where,a=(0,c.XJ)(e);let o;if("arcade"===a.type){const e=(0,d.o)(a.expression),s=t.get(e);if(s&&((0,h.isIntegerField)(s)||(0,h.isNumericField)(s)||(0,h.isStringField)(s)))o={type:"simple",evaluate(e){const t="attributes"in e?e.attributes?.[s.name]:e.field(s.name);return null==t?"":t.toString()}};else{const e=await(0,u.$I)(a.expression,i,t);if(null==e)return m;o={type:"arcade",evaluate(t,s){try{const i="attributes"in t?e.repurposeFeature(t):t;i.contextTimeZone=s??null;const r=e.evaluate({$view:{timeZone:s},$feature:i},e.services);if(null!=r)return r.toString()}catch(i){p().error(new r.default("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:i,feature:t,expression:a}))}return null},needsHydrationToEvaluate:()=>null==(0,c.tH)(a.expression)}}}else o={type:"simple",evaluate:e=>a.expression.replaceAll(/{[^}]*}/g,(i=>{const r=i.slice(1,-1),s=t.get(r);if(!s)return i;let n=null;return n="attributes"in e?e?.attributes?.[s.name]:e.field(s.name),null==n?"":f(n,s)}))};if(s){let e;try{e=await(0,n.parseWhereClause)(s,t)}catch(g){return p().error(new r.default("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:s,error:g})),m}const i=o.evaluate;o.evaluate=(t,n)=>{const a="attributes"in t?void 0:_;try{if(e.testFeature(t,a))return i(t,n)}catch(g){p().error(new r.default("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:s,feature:t,error:g}))}return null}}return o}function f(e,t){if(null==e)return"";const i=t.domain;if(i)if("codedValue"===i.type||"coded-value"===i.type){const t=e;for(const e of i.codedValues)if(e.code===t)return e.name}else if("range"===i.type){const{max:r,min:s}=(0,l.A5)(t),n=+e;if(null!=s&&null!=r&&s<=n&&n<=r)return i.name}let r=e;return(0,h.isDateField)(t)?r=(0,a.Yq)(r,(0,a.J2)("short-date")):(0,h.isNumericField)(t)&&(r=(0,o.ZV)(+r)),r||""}},81202:(e,t,i)=>{function r(e){return t=>{if(e.immediate)return e.immediate.schedule(t);const i="No immediate scheduler";throw console.error(i),new Error(i)}}i.d(t,{m:()=>r})},81480:(e,t,i)=>{i.d(t,{F:()=>g,a:()=>y,b:()=>f});var r=i(28473),s=i(33273),n=i(77742),a=i(87824),o=i(57554),l=i(42403),h=i(16878),c=i(73712),d=i(85593),u=i(29026),p=i(47998),m=i(20783),_=i(8118);class g extends m.Y{constructor(){super(...arguments),this.color=(0,r.vt)(),this.strength=4e-6,this.atmosphereC=1,this.amount=0}}function f(){const e=new _.N5;e.include(d.y,{needUVs:!0,needEyeDirection:!0});const t=e.fragment;return t.uniforms.add(new l.m("atmosphereC",(e=>e.atmosphereC)),new a.d("cameraPosition",(e=>e.camera.eye)),new c.x("depthTexture",(e=>e.mainDepth)),new l.m("fogStrength",(e=>e.strength)),new l.m("fogAmount",(e=>e.amount)),new o.t("fogColor",(e=>e.color))),e.include(n.C),t.include(u.t),t.include(p.b),t.include(s.E),t.code.add(h.H`float getFogAmount(float dist, vec3 rayDir) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return fogAmount * (1.0 - exp(-dist * fogStrength));
}`),t.main.add(h.H`vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = depthFromTexture(depthTexture, uv);
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linearizeDepth(depthSample);;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
float fogAmount = getFogAmount(terrainDepth, rayDir);
vec4 fog = vec4(fogColor, 1.0) * fogAmount;
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),e}const y=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:g,build:f},Symbol.toStringTag,{value:"Module"}))},82350:(e,t,i)=>{i.d(t,{H:()=>u,T:()=>m});i(21265);var r=i(50925),s=i(17741),n=i(80861),a=i(24591),o=i(92156),l=i(45192),h=i(97306),c=i(64177);const d=()=>r.A.getLogger("esri.views.webgl.FramebufferObject");class u{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(o.vt.FramebufferObject,this);const r=p(t)?t:new c.g(this._context,t);if(this._colorAttachments.set(o.Nm.COLOR_ATTACHMENT0,r),this._validateTextureDescriptor(r.descriptor),this._validateColorAttachmentPoint(o.Nm.COLOR_ATTACHMENT0),null!=i)if(function(e){return p(e)||null!=e&&"pixelFormat"in e}(i))this._depthStencilTexture=p(i)?i:new c.g(this._context,i),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const e=function(e){return null!=e&&"type"in e&&e.type===l.p.RenderBuffer}(i)?i:new h.l(this._context,i);this._depthStencilBuffer=e,this._validateRenderBufferDescriptor(e.descriptor)}}dispose(){if(0===this._colorAttachments.size&&!this._glName)return;const e=this._context.getBoundFramebufferObject();this._colorAttachments.forEach(((e,t)=>this.detachColorTexture(t)?.dispose())),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(e),this._context.instanceCounter.decrement(o.vt.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){return this._colorAttachments.get(o.Nm.COLOR_ATTACHMENT0)}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){const e=this._colorAttachments.get(o.Nm.COLOR_ATTACHMENT0);return e?.descriptor?.width??0}get height(){const e=this._colorAttachments.get(o.Nm.COLOR_ATTACHMENT0);return e?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce(((e,t)=>{let[i,r]=t;return e+r.usedMemory}),this.depthStencil?.usedMemory??0)}getColorTexture(e){const t=this._colorAttachments.get(e);return t&&p(t)?t:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.Nm.COLOR_ATTACHMENT0;if(!e)return;this._validateColorAttachmentPoint(t);const i=e.descriptor;this._validateTextureDescriptor(i),this.detachColorTexture(t)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,t)),this._colorAttachments.set(t,e)}detachColorTexture(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o.Nm.COLOR_ATTACHMENT0;const t=this._colorAttachments.get(e);if(t){if(this._initialized){const t=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e),this._context.bindFramebuffer(t)}return this._colorAttachments.delete(e),t}}setColorTextureTarget(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.Nm.COLOR_ATTACHMENT0;const i=this._colorAttachments.get(t);i&&this._framebufferTexture2D(i.glName,t,e)}attachDepthStencil(e){if(e)switch(e.type){case l.p.Texture:return this._attachDepthStencilTexture(e);case l.p.RenderBuffer:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(null==e)return;const t=e.descriptor;t.pixelFormat!==o.Ab.DEPTH_STENCIL&&t.pixelFormat!==o.Ab.DEPTH24_STENCIL8&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),t.dataType!==o.ld.UNSIGNED_INT_24_8&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._validateTextureDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,o.nI)),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e}detachDepthStencilTexture(){const e=this._depthStencilTexture;if(e&&this._initialized){const e=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),this._framebufferTexture2D(null,o.nI),this._context.bindFramebuffer(e)}return this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(null==e)return;const t=e.descriptor;if(this._validateRenderBufferDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const i=this._context.gl,r=this._getGLAttachmentPoint(t);i.framebufferRenderbuffer(o.R.FRAMEBUFFER,r,i.RENDERBUFFER,e.glName)}this._depthStencilBuffer=e}detachDepthStencilBuffer(){const e=this._depthStencilBuffer;if(e&&this._initialized){const t=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this);const i=this._context.gl,r=this._getGLAttachmentPoint(e.descriptor);i.framebufferRenderbuffer(o.R.FRAMEBUFFER,r,i.RENDERBUFFER,null),this._context.bindFramebuffer(t)}return this._depthStencilBuffer=null,e}copyToTexture(e,t,i,r,s,n,a){(e<0||t<0||s<0||n<0)&&console.error("Offsets cannot be negative!"),(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!");const l=a.descriptor;a.descriptor.target!==o.Ap.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(null==l?.width||null==l?.height||e+i>this.width||t+r>this.height||s+i>l.width||n+r>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const h=this._context,d=h.bindTexture(a,c.g.TEXTURE_UNIT_FOR_UPDATES);h.setActiveTexture(c.g.TEXTURE_UNIT_FOR_UPDATES),h.bindFramebuffer(this),h.gl.copyTexSubImage2D(o.Ap.TEXTURE_2D,0,s,n,e,t,i,r),h.bindTexture(d,c.g.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,t,i,r,s,n,a){(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,t,i,r,s,n,a)}async readPixelsAsync(e,t,i,r,s,a,l){const{gl:h}=this._context,c=n.g.createPixelPack(this._context,o._U.STREAM_READ,l.byteLength);this._context.bindBuffer(c);const d=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),h.readPixels(e,t,i,r,s,a,0),this._context.unbindBuffer(o.NZ.PIXEL_PACK_BUFFER),this._context.bindFramebuffer(d),await c.getSubDataAsync(l),c.dispose()}resize(e,t){if(this.width===e&&this.height===t)return;const i={width:e,height:t};m(i,this._context.parameters.maxTextureSize),this._colorAttachments.forEach((e=>e.resize(i.width,i.height))),this._depthStencilTexture?.resize(i.width,i.height),this._initialized&&(m(i,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(i.width,i.height),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1)}initializeAndBind(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o.R.FRAMEBUFFER;const t=this._context.gl;if(this._initialized)return void t.bindFramebuffer(e,this.glName);this._glName&&t.deleteFramebuffer(this._glName);const i=t.createFramebuffer();if(t.bindFramebuffer(e,i),this._colorAttachments.forEach(((t,i)=>this._framebufferTexture2D(t.glName,i,_(t),e))),this._depthStencilBuffer){const i=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(e,i,t.RENDERBUFFER,this._depthStencilBuffer.glName)}else this._depthStencilTexture&&this._framebufferTexture2D(this._depthStencilTexture.glName,t.DEPTH_STENCIL_ATTACHMENT,_(this._depthStencilTexture),e);(0,a.en)()&&t.checkFramebufferStatus(e)!==t.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=i,this._initialized=!0}_framebufferTexture2D(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.Nm.COLOR_ATTACHMENT0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.Ap.TEXTURE_2D,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:o.R.FRAMEBUFFER,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this._context.gl.framebufferTexture2D(r,t,i,e,s)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const t=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(o.R.FRAMEBUFFER,t,e.RENDERBUFFER,null)}this._depthStencilBuffer=(0,s.WD)(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture=(0,s.WD)(this._depthStencilTexture))}_validateTextureDescriptor(e){e.target!==o.Ap.TEXTURE_2D&&e.target!==o.Ap.TEXTURE_CUBE_MAP&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),m(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderBufferDescriptor(e){m(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case o.yQ.DEPTH_COMPONENT16:case o.yQ.DEPTH_COMPONENT24:case o.yQ.DEPTH_COMPONENT32F:return this._context.gl.DEPTH_ATTACHMENT;case o.yQ.DEPTH24_STENCIL8:case o.yQ.DEPTH32F_STENCIL8:case o.yQ.DEPTH_STENCIL:return this._context.gl.DEPTH_STENCIL_ATTACHMENT;case o.yQ.STENCIL_INDEX8:return this._context.gl.STENCIL_ATTACHMENT}}_validateColorAttachmentPoint(e){if(-1===u._MAX_COLOR_ATTACHMENTS){const{gl:e}=this._context;u._MAX_COLOR_ATTACHMENTS=e.getParameter(e.MAX_COLOR_ATTACHMENTS)}const t=e-o.Nm.COLOR_ATTACHMENT0;t+1>u._MAX_COLOR_ATTACHMENTS&&r.A.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${t+1}. Implementation supports up to ${u._MAX_COLOR_ATTACHMENTS} color attachments`)}}function p(e){return null!=e&&"type"in e&&e.type===l.p.Texture}function m(e,t){const i=Math.max(e.width,e.height);if(i>t){d().warn(`Resizing FBO attachment size ${e.width}x${e.height} to device limit ${t}`);const r=t/i;return e.width=Math.round(e.width*r),e.height=Math.round(e.height*r),!1}return!0}function _(e){return e.descriptor.target===o.Ap.TEXTURE_CUBE_MAP?o.Ap.TEXTURE_CUBE_MAP_POSITIVE_X:o.Ap.TEXTURE_2D}u._MAX_COLOR_ATTACHMENTS=-1},84964:(e,t,i)=>{i.d(t,{H:()=>d});var r=i(4064),s=i(80861),n=i(92156),a=i(82350),o=i(64177),l=i(77936),h=i(25874),c=i(31129);class d extends c._{constructor(e){super(),this._rctx=e;this._program=e.programCache.acquire("\n    precision highp float;\n\n    attribute vec2 a_pos;\n    varying vec2 v_uv;\n\n    void main() {\n      v_uv = a_pos;\n      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n    precision highp float;\n\n    varying vec2 v_uv;\n\n    uniform sampler2D u_texture;\n\n    void main() {\n      gl_FragColor = texture2D(u_texture, v_uv);\n    }\n    ",new Map([["a_pos",0]]))}dispose(){super.dispose()}_test(e){const t=this._rctx;if(!t.gl)return e.dispose(),!0;const i=new l.R(1);i.wrapMode=n.pF.CLAMP_TO_EDGE,i.samplingMode=n.Cj.NEAREST;const c=new a.H(t,i),d=s.g.createVertex(t,n._U.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),p=new h.Z(t,new Map([["a_pos",0]]),r.VS,new Map([["geometry",d]])),m=new l.R;m.samplingMode=n.Cj.LINEAR,m.wrapMode=n.pF.CLAMP_TO_EDGE;const _=new o.g(t,m,u);t.useProgram(e),t.bindTexture(_,0),e.setUniform1i("u_texture",0);const g=t.getBoundFramebufferObject(),{x:f,y:y,width:v,height:b}=t.getViewport();t.bindFramebuffer(c),t.setViewport(0,0,1,1),t.setClearColor(0,0,0,0),t.setBlendingEnabled(!1),t.clear(n.NV.COLOR),t.bindVAO(p),t.drawArrays(n.WR.TRIANGLE_STRIP,0,4);const w=new Uint8Array(4);return c.readPixels(0,0,1,1,n.Ab.RGBA,n.ld.UNSIGNED_BYTE,w),p.dispose(),c.dispose(),_.dispose(),t.setViewport(f,y,v,b),t.bindFramebuffer(g),255!==w[0]}}const u=new Image;u.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",u.width=5,u.height=5,u.decode()},85593:(e,t,i)=>{i.d(t,{y:()=>l});var r=i(87752),s=i(10382),n=i(16878),a=i(38950),o=i(22131);function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{needUVs:!0,needEyeDirection:!0};e.attributes.add(o.r.POSITION,"vec2"),e.varyings.add("worldRay","vec3");const{needUVs:i,needEyeDirection:s}=t;i&&e.varyings.add("uv","vec2"),s&&e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add(new a.F("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new a.F("inverseViewMatrix",(e=>(0,r.Qw)(h,e.camera.viewMatrix)))),e.vertex.main.add(n.H`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${(0,n.If)(s,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${(0,n.If)(i,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)}const h=(0,s.vt)()},86209:(e,t,i)=>{i.d(t,{y:()=>D});var r=i(93800),s=i(62631),n=(i(21265),i(64682)),a=i(17741),o=i(57942),l=i(15899),h=i(35920),c=i(48602),d=(i(50925),i(75269)),u=i(87752),p=i(10382),m=i(66458),_=i(96236),g=i(91077),f=i(99610),y=i(69473),v=i(53801),b=i(89893),w=i(34360);class x{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.from=e,this.to=t}get numElements(){return this.to-this.from}}function C(e){if(e.length<2)return;const t=new Map;e.forAll((e=>t.set(e.from,e)));let i=!0;for(;i;){i=!1;for(let r=0;r<e.length;++r){const s=e.data[r],n=t.get(s.to);n&&(s.to=n.to,t.delete(n.from),e.removeUnordered(n),i=!0)}}}class T extends x{constructor(e,t,i,r){super(t,i),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(r)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let i=-1,r=null;t.foreachHighlightOptions((t=>{const s=e.get(t)??-1;s>i&&(i=s,r=t)})),this._highlightName=r}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return null!=this.geometry.occludees}}var M=i(45622);class S{constructor(){this.first=0,this.count=0}}var R=i(50330);class A{constructor(){this._numElements=0,this._instances=new Map,this.holes=new l.A({allocator:e=>e||new x,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=E(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=E(),this.drawCommandsShadowHighlightRest=E()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e,t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const e of this.instances.values())this.updateDrawState(e);this.updateDrawCommands(e,t)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,i){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=i,this._numElements+=r.numElements)}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e,t){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;const{sortedInstances:i}=this;if(this._updateHighlightDrawCommands(e,i),!this.needsMultipleCommands()){const e=this.drawCommandsDefault.pushNew(),i=this.holes.front();return null!=this.vao&&1===this.holes.length&&i.to===Math.floor(this.vao.byteSize/t)?(e.first=0,void(e.count=i.from)):(e.first=1/0,e.count=0,this._instances.forEach((t=>{e.first=Math.min(e.first,t.from),e.count=Math.max(e.count,t.to)})),void(e.count-=e.first))}for(const r of i)r.isVisible&&O(r.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,r)}get sortedInstances(){return Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from))}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const i of t)i.updateHighlightOptions(e),i.isVisible&&i.highlightName&&this.highlightNames.add(i.highlightName);this._updateHighlightDrawCommands(e)}_updateHighlightDrawCommands(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.sortedInstances;const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:r}=this;i.clear(),r.clear();for(const s of t){if(s.updateHighlightOptions(e),!s.isVisible)continue;const{highlightName:t}=s;t&&(this.highlightNames.add(t),O((0,M.tE)(i,t,E),s)),t&&t===R.Tv||O(r,s)}}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function E(){return new l.A({allocator:e=>e||new S,deallocator:e=>e})}function O(e,t){const i=e.back();if(null==i){const i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.numElements;i.count=e}else{const i=e.pushNew();i.first=t.from,i.count=t.numElements}}class P{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}let D=class extends g.RW{get _hasHighlights(){return this._highlightNames.size>0}hasHighlightOptions(e){return this._highlightNames.has(e)}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new w.P,this._highlightNames=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=(0,a.WD)(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this._updateProduces()}_updateProduces(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==_.V.Highlight&&t!==_.V.ShadowHighlight||this._hasHighlights))&&e(t)))}))}initializeRenderContext(e,t){this._glMaterials=new f.c(this.material,t??e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,(0,m.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.cachedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>{let{geometry:i}=t;return e(i)}))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}updateHighlights(e){this.highlightOrderMap=e,this._highlightNames.clear(),this._dataByOrigin.forEach((t=>{t.buffers.forEach((t=>{t.updateHighlights(e),t.highlightNames.forEach((e=>this._highlightNames.add(e)))}))})),this._updateProduces()}_updateGeometries(e){const t=this._bufferWriter;if(null==t)return;const i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,s=this._dataByOrigin.get(e.localOrigin.id),n=s?.findBuffer(e.id);if(null==n)return;const a=n.instances.get(e.id);if(r.updateType&(y.k.GEOMETRY|y.k.TRANSFORMATION)){const r=B(t.elementCount(a.geometry.geometry.attributes)*i),s=t.vertexBufferLayout.createView(r.buffer);this._writeGeometry(e,s,0),n.vao.vertexBuffers.get("geometry").setSubData(r,a.from*i,0,a.numElements*i)}r.updateType&(y.k.HIGHLIGHT|y.k.OCCLUDEE|y.k.VISIBILITY)&&(n.drawCommandsDirty=!0)}}_computeDeltas(e,t){const i=new o.O;for(const r of e){const e=r.localOrigin;if(null==e)continue;let t=i.get(e.id,null);null==t&&(t=new I(e.vec3),i.set(e.id,null,t)),t.changes.push(r)}for(const r of t){const e=r.localOrigin;if(null==e)continue;const t=this._dataByOrigin.get(e.id),s=t?.findBuffer(r.id);if(null==s)continue;let n=i.get(e.id,s);null==n&&(n=new I(e.vec3),i.set(e.id,s,n)),n.changes.push(r)}return i}_addAndRemoveGeometries(e,t){if(null==this._bufferWriter||null==this._vaoCache)return;const{_bufferWriter:i,_dataByOrigin:r}=this,n=i.vertexBufferLayout.stride/4,a=this._computeDeltas(e,t);a.forEach(((e,t)=>{const o=e.get(null),l=o?.changes??[];a.delete(t,null);let h=r.get(t);if(e.forEach(((e,o)=>{if(a.delete(t,o),null==o)return void(0,b.vA)(!1,"No VAO for removed geometries");if(o.instances.size===e.changes.length)return this._vaoCache.deleteVao(o.vao),(0,s.Xy)(h.buffers,o),void(0===h.buffers.length&&0===l.length&&r.delete(t));const c=o.numElements,d=o.vao.byteSize/4,u=l.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),p=e.changes.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),m=Math.min((c+u-p)*n,q),_=m>d;m>V&&m<d/2?(e.changes.forEach((e=>{let{id:t}=e;return o.deleteInstance(t)})),o.instances.forEach((e=>{let{geometry:t}=e;return l.push(t)})),this._vaoCache.deleteVao(o.vao),(0,s.Xy)(h.buffers,o)):_?this._applyAndRebuild(o,l,e):this._applyRemoves(o,e)})),l.length>0)for(null==h&&(h=new P(o.origin),r.set(t,h)),h.buffers.forEach((e=>this._applyAdds(e,l)));l.length>0;)h.buffers.push(this._applyAndRebuild(new A,l,null))}))}_updateDrawCommands(){this._highlightNames.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&(0,h.FB)(this._highlightNames,e.highlightNames),this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,i){if(i)for(const p of i.changes)e.deleteInstance(p.id);const r=this._bufferWriter,s=r.vertexBufferLayout.stride,n=s/4,a=Math.floor(q/n);let o=e.numElements;for(;t.length>0;){const i=t.pop(),s=r.elementCount(i.geometry.attributes);if(o+s>a&&o>0){t.push(i);break}o+=s;const n=new T(i,0,0,this.highlightOrderMap);(0,b.vA)(null==e.instances.get(i.id)),e.addInstance(i.id,n)}const l=o*n,h=B(l),c=r.vertexBufferLayout.createView(h.buffer);let d=0;e.resetInstanceSummary(),e.instances.forEach(((t,i)=>{this._writeGeometry(t.geometry,c,d);const s=d;d+=r.elementCount(t.geometry.geometry.attributes),e.updateInstance(i,s,d),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(W(l)),e.vao.vertexBuffers.get("geometry").setSubData(h,0,0,d*n),e.holes.clear();const u=e.holes.pushNew();return u.from=d,u.to=Math.floor(e.vao.byteSize/s),e.updateDrawCommands(this.highlightOrderMap,s),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;for(const a of t.changes){const t=a.id,i=e.instances.get(t);if(!i)continue;e.deleteInstance(t);const r=F.back();if(r){if(r.to===i.from){r.to=i.to;continue}if(r.from===i.to){r.from=i.from;continue}}const s=F.pushNew();s.from=i.from,s.to=i.to}C(F);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=F.reduce(((e,t)=>Math.max(e,t.numElements)),0)*i,s=B(r);s.fill(0,0,r);const n=e.vao.vertexBuffers.get("geometry");F.forAll((e=>n.setSubData(s,e.from*i,0,e.numElements*i))),e.holes.pushArray(F.data,F.length),F.forAll(((e,t)=>F.data[t]=null)),F.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,n=e.numElements,a=t.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),o=Math.min((n+a)*r,q),l=4*o;if(e.vao.byteSize<W(q-V)&&l>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);C(e.holes);const h=new Array;for(const s of t){const t=i.elementCount(s.geometry.attributes),r=L(e.holes,t);h.push(r)}const c=e.vao.vertexBuffers.get("geometry");let d=0,u=0,p=0;const m=B(o),_=i.vertexBufferLayout.createView(m.buffer);t.forEach(((t,s)=>{const n=h[s];if(null==n)return;if(p!==n){const e=p-u;e>0&&c.setSubData(m,u*r,0,e*r),u=n,d=0}const a=i.elementCount(t.geometry.attributes);this._writeGeometry(t,_,d),d+=a,p=n+a;const o=new T(t,n,n+a,this.highlightOrderMap);(0,b.vA)(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const g=p-u;g>0&&c.setSubData(m,u*r,0,g*r),(0,s.$i)(t,((e,t)=>null==h[t]))}_writeGeometry(e,t,i){null!=this._bufferWriter&&((0,u.C)(N,e.transformation),N[12]-=e.localOrigin.vec3[0],N[13]-=e.localOrigin.vec3[1],N[14]-=e.localOrigin.vec3[2],(0,u.B8)(H,N),(0,u.mg)(H,H),this._bufferWriter.write(N,H,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,i))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e,r=this.material.produces.get(i.slot);if(!r?.(t))return null;const{highlight:s,slot:n}=i,a=t===_.V.ShadowHighlight,o=t===_.V.Highlight,l=o||a,h=s?.name;if(l&&(0===this._highlightNames.size||o&&h&&!this._highlightNames.has(h)))return null;const c=e=>o&&!!h&&!e.has(h),d=t===_.V.ShadowExcludeHighlight,u=!(l||d);for(const{buffers:p}of this._dataByOrigin.values())for(const r of p){if(c(r.highlightNames))continue;const s=a?r.drawCommandsHighlights.get(R.Tv):l?h?r.drawCommandsHighlights.get(h):r.drawCommandsHighlights.size>0:((d&&r.needsMultipleCommands()?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null)?.length??!1,o=u&&r.drawCommandsOccludees||null;if(s||o?.length){const r=this._glMaterials.load(e.rctx,n,t),s=r?.beginSlot(i);if(s)return s}}return null}render(e,t){const{output:i,bind:r}=e,{slot:s,highlight:n}=r,a=i===_.V.Highlight,o=n?.name??"";if(a&&!n)return;const h=i===_.V.ShadowHighlight,c=a||h,d=i===_.V.ShadowExcludeHighlight,u=!(c||d),p=s===v.N.OCCLUDER_MATERIAL||s===v.N.TRANSPARENT_OCCLUDER_MATERIAL?s:null,{rctx:m}=e;m.runAppleAmdDriverHelper();const g=m.bindTechnique(t,r,this.material.parameters);for(const _ of this._dataByOrigin.values())for(const e of _.buffers){if(a&&(!e.hasHighlights||!e.drawCommandsHighlights.has(o)))continue;if(h&&(!e.hasHighlights||!e.drawCommandsHighlights.has(R.Tv)))continue;const i=()=>{const t=[],i=e.drawCommandsHighlights.get(R.Tv)??new l.A;return i&&t.push(i),t},s=c&&!h?e.drawCommandsHighlights.get(o)??null:null,n=h?i():c?s?[s]:Z:d&&e.needsMultipleCommands()?[e.drawCommandsShadowHighlightRest]:[e.drawCommandsDefault],f=n.some((e=>e.length>0)),y=u&&e.drawCommandsOccludees||null;if(f||y?.length){if(this._drawParameters.origin=_.origin,g.bindDraw(r,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(e.vao),m.bindVAO(e.vao),f)for(const e of n)m.setPipelineState(t.getPipeline(!1,p)),e.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count)));y?.length&&(m.setPipelineState(t.getPipeline(!0,p)),y.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count))))}}}static prune(){k=new Float32Array(V)}get test(){}};(0,r._)([(0,c.MZ)({constructOnly:!0})],D.prototype,"material",void 0),(0,r._)([(0,c.MZ)({})],D.prototype,"highlightOrderMap",void 0),D=(0,r._)([(0,d.$)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],D);class I{constructor(e){this.origin=e,this.changes=new Array}}function L(e,t){const i=e.find((e=>e.numElements>=t));if(null==i)return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}const N=(0,p.vt)(),H=(0,p.vt)(),F=new l.A({allocator:e=>e||new x,deallocator:null}),V=65536,U=4*V,z=1024,G=16777216,q=G/4;let k=new Float32Array(V);function B(e){return k.length<e&&(k=new Float32Array(e)),k}function W(e){const t=4*e;return t<=z?z:t<U?(0,n.cU)(t):Math.max(Math.min(Math.ceil(1.5*t/U)*U,G),t)}const Z=[]},87523:(e,t,i)=>{i.d(t,{G:()=>d,w:()=>c});var r=i(93800),s=i(6946),n=(i(21265),i(50925)),a=i(24812),o=i(7187),l=i(48602),h=(i(14746),i(75269));function c(e){return new u({view:e})}const d=.1;let u=class extends s.default{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new a.F,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles((0,o.addFrameTask)({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,i){return new a.Mn(e,this._cacheStorage,t,i)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>d&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,d),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){if(!this.view)return;this.view._stage?.renderer?.tick();const e=this.view._stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0),i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}(e)){const r=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*r,i+=e.unloadedMemory*r}}));const r=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),s=1048576*this.maxMemory;if(t>s&&r){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);n.A.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(s)} Current: ${e(t)} Projected: ${e(t+i)} Quality: ${r}%`)}this._usedMemory=t/s,this._memoryPredicted=(t+i)/s;const a=s-t;this._cacheStorage.maxSize=Math.max(0,a+1048576*this.additionalCacheMemory)}get test(){}};(0,r._)([(0,l.MZ)({constructOnly:!0})],u.prototype,"view",void 0),(0,r._)([(0,l.MZ)()],u.prototype,"maxMemory",null),(0,r._)([(0,l.MZ)()],u.prototype,"additionalCacheMemory",null),(0,r._)([(0,l.MZ)({readOnly:!0})],u.prototype,"memoryFactor",null),(0,r._)([(0,l.MZ)({readOnly:!0})],u.prototype,"updating",null),(0,r._)([(0,l.MZ)({readOnly:!0})],u.prototype,"usedMemory",null),(0,r._)([(0,l.MZ)({readOnly:!0})],u.prototype,"usedCacheMemory",null),(0,r._)([(0,l.MZ)()],u.prototype,"_quality",void 0),(0,r._)([(0,l.MZ)()],u.prototype,"_usedMemory",void 0),(0,r._)([(0,l.MZ)()],u.prototype,"_updating",void 0),(0,r._)([(0,l.MZ)()],u.prototype,"_stableQuality",void 0),(0,r._)([(0,l.MZ)()],u.prototype,"_maxMemory",void 0),(0,r._)([(0,l.MZ)()],u.prototype,"_additionalCacheMemory",void 0),u=(0,r._)([(0,h.$)("esri.views.3d.support.MemoryController")],u)},88607:(e,t,i)=>{i.d(t,{T:()=>L,a:()=>V,b:()=>N});var r=i(87752),s=i(10382),n=i(89227),a=i(28473),o=i(73803),l=i(71311),h=i(49443),c=i(96236),d=i(75304),u=i(50366),p=i(16213),m=i(84025),_=i(69261),g=i(29471),f=i(22860),y=i(65228),v=i(39459),b=i(3290),w=i(10894),x=i(16849),C=i(12796),T=i(53769),M=i(12188),S=i(55102),R=i(35490),A=i(87824),E=i(16878),O=i(12901),P=i(67058),D=i(8118),I=i(12621);class L extends S.Rq{}function N(e){const t=new D.N5,{vertex:i,fragment:s,varyings:a}=t,{output:L,pbrMode:N,overlayMode:V,tileBorders:U,spherical:z,transparencyMode:G,screenSizePerspective:q}=e;t.include(m.I),t.include(p.Y,e),t.include(_.U,e);const k=()=>{t.include(x.n,e),i.code.add(E.H`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};(0,R.NB)(i,e),t.include(u.d,e);const B=G===l.S.InvisibleWithDraped||G===l.S.Invisible,W=V!==M.w9.Disabled,Z=W&&B;switch(L){case c.V.ColorEmission:case c.V.Color:{t.include(S.BK,e),t.include(b.kA,e),W&&(e.pbrMode=N===C.A9.Simplified?C.A9.TerrainWithWater:C.A9.Water,t.include(M.eO,e),e.pbrMode=N);const l=V===M.w9.EnabledWithWater;l&&t.include(g.O,e),a.add("vnormal","vec3"),a.add("vpos","vec3"),a.add("vup","vec3"),k(),q&&(0,R.S7)(i);const c=e.receiveShadows&&!e.renderOccluded;c&&t.include(h.oD,e),q&&(a.add("screenSizeDistanceToCamera","float"),a.add("screenSizeCosAngle","float")),i.main.add(E.H`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${(0,E.If)(l,E.H`forwardVertexTangent(vnormal);`)}

          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${(0,E.If)(W,"setOverlayVTC(uv);")}
          ${(0,E.If)(U,"forwardTextureCoordinates();")}
          ${(0,E.If)(q,E.H`vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
                 screenSizeDistanceToCamera = length(viewPos);
                 vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
                 screenSizeCosAngle = abs(viewSpaceNormal.z);`)}
          ${(0,E.If)(c,"forwardLinearDepth();")}`),t.fragment.include(d.HQ,e),t.include(b.kA,e),t.include(v.n,e),t.include(T.Bz,e),(0,R.yu)(s,e),(0,b.a8)(s),(0,b.eU)(s),s.uniforms.add(i.uniforms.get("localOrigin"),new A.d("viewDirection",(e=>{let{camera:t}=e;return(0,n.n)(F,(0,n.i)(F,t.viewMatrix[12],t.viewMatrix[13],t.viewMatrix[14]))}))),l&&s.uniforms.add(new P.N("ovWaterTex",((e,t)=>t.overlay?.getTexture(o.A.WaterNormal))),new O.S("view",((e,t)=>{let{origin:i}=e,{camera:s}=t;return(0,r.Tl)(H,s.viewMatrix,i)})));const u=.2;s.code.add(E.H`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),(0,w.Gc)(s),(0,w.O4)(s),s.main.add(E.H`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${c?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":z?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${(0,E.If)(W,E.H`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${(0,E.If)(B,`if (overlayColor.a < ${E.H.float(I.Q)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${E.H.float(I.Q)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${E.H.float(u)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${N===C.A9.Simplified||N===C.A9.TerrainWithWater?E.H`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:E.H`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${(0,E.If)(l,E.H`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${E.H.float(u)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${(0,E.If)(q,E.H`float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0));
                   if (perspectiveScale <= 0.25) {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
                   } else if (perspectiveScale <= 0.5) {
                     fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
                   } else if (perspectiveScale >= 0.99) {
                     fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
                   } else {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
                   }`)}
          ${(0,E.If)(e.visualizeNormals,z?E.H`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:E.H`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${(0,E.If)(U,E.H`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case c.V.Depth:Z&&t.include(M.eO,e),i.main.add(E.H`
        ${(0,E.If)(Z,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);`),s.main.add(`${(0,E.If)(Z,`if (getCombinedOverlayColor().a < ${E.H.float(I.Q)}) discard;`)}`);break;case c.V.Shadow:case c.V.ShadowHighlight:case c.V.ShadowExcludeHighlight:case c.V.ViewshedShadow:t.include(f.L,e),(0,h.Mu)(t),(0,h.xJ)(t),i.main.add(E.H`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),s.main.add(E.H`outputDepth(linearDepth);`);break;case c.V.Normal:Z&&t.include(M.eO,e),a.add("vnormal","vec3"),(0,R.S7)(i),k(),i.main.add(E.H`
        ${(0,E.If)(Z,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),s.main.add(E.H`
        ${(0,E.If)(Z,`if (getCombinedOverlayColor().a < ${E.H.float(I.Q)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case c.V.Highlight:W&&t.include(M.eO,e),i.main.add(E.H`
        ${(0,E.If)(W,"setOverlayVTC(getUV0());")}
        gl_Position = transformPosition(proj, view, position);`),t.include(y.Q,e),s.main.add(E.H`
        ${(0,E.If)(W,E.H`
           vec2 overlayHighlightTexel = getAllOverlayHighlightValuesEncoded();
           calculateOcclusionAndOutputHighlightOverlay(overlayHighlightTexel);`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(L===c.V.ObjectAndLayerIdColor)if(W)e.pbrMode=C.A9.Disabled,t.include(M.eO,e),e.pbrMode=N,i.main.add(E.H`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());`),s.main.add(E.H`fragColor = getOverlayColorTexel();`);else{const e=G===l.S.Opaque;i.main.add(E.H`${(0,E.If)(e,"gl_Position = transformPosition(proj, view, position);")}`),s.main.add(E.H`fragColor = vec4(0.0);`)}return t}const H=(0,s.vt)(),F=(0,a.vt)(),V=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:L,build:N},Symbol.toStringTag,{value:"Module"}))},88636:(e,t,i)=>{i.d(t,{I:()=>a,OI:()=>d,X1:()=>l,jy:()=>h,xT:()=>o});var r=i(91683),s=i(26204),n=i(63831);function a(e,t,i,r,s,n){const a=i-s;if(a>=0)return(t>>a)+(r-(n<<a))*(e>>a);const o=-a;return t-(n-(r<<o))*(e>>o)<<o}class o{constructor(e,t,i){this._rows=Math.ceil(t/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let r=0;r<this._rows;r++){this.cells[r]=new Array(this._columns);for(let e=0;e<this._columns;e++)this.cells[r][e]=[]}}getCell(e,t){const i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][r]||null}getCellSpan(e,t,i,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function l(e,t,i,r,s,a,o){const l=t[r++];for(let h=0;h<l;h++){const l=new n.D(a,o);l.xTile=t[r++],l.yTile=t[r++],l.hash=t[r++],l.priority=t[r++],l.featureIndex=t[r++];const h=t[r++];for(let e=0;e<h;e++){const e=t[r++],s=t[r++],n=t[r++],a=t[r++],o=!!t[r++],h=t[r++],c=i[r++],d=i[r++],u=t[r++],p=t[r++];l.colliders.push({xTile:e,yTile:s,dxPixels:n,dyPixels:a,hard:o,partIndex:h,width:u,height:p,minLod:c,maxLod:d})}const c=e[r++];for(let t=0;t<c;t++)l.textVertexRanges.push([e[r++],e[r++]]);const d=e[r++];for(let t=0;t<d;t++)l.iconVertexRanges.push([e[r++],e[r++]]);s.push(l)}return r}function h(e,t,i){for(const[r,s]of e.symbols)c(e,t,i,s,r)}function c(e,t,i,s,n){const a=e.layerData.get(n);if(a.type===r.NP.SYMBOL){for(const t of s){const r=t.unique;let s;if(t.selectedForRendering){const t=r.parts[0],n=t.startOpacity,a=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===a;const o=i?Math.floor(127*n)|a<<7:a?255:0;s=o<<24|o<<16|o<<8|o}else s=0;for(const[e,i]of t.iconVertexRanges)for(let t=e;t<e+i;t+=4)a.iconOpacity[t/4]=s;if(t.selectedForRendering){const t=r.parts[1],n=t.startOpacity,a=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===a;const o=i?Math.floor(127*n)|a<<7:a?255:0;s=o<<24|o<<16|o<<8|o}else s=0;for(const[e,i]of t.textVertexRanges)for(let t=e;t<e+i;t+=4)a.textOpacity[t/4]=s}a.lastOpacityUpdate=t,a.opacityChanged=!0}}function d(e,t,i,r){const n=e.colliders;let a,o,l,h;for(const c of n)if(e.unique.show&&e.unique.parts[c.partIndex].show&&(a=c.xScreen-r[0]+c.dxScreen,o=c.yScreen-r[1]+c.dyScreen,l=a+c.width,h=o+c.height,(0,s.w4)(i,t.x,t.y,a,o,l,h)))return!0;return!1}},88664:(e,t,i)=>{i.d(t,{S:()=>r});class r{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return void 0!==this.lastValue}hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return void 0===this.lastValue?NaN:e-this.lastValue}_updateDelta(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}},89475:(e,t,i)=>{i.d(t,{Y:()=>a});var r=i(67965),s=i(13767),n=i(83652);class a extends s.q{constructor(e,t,i,r,s,a){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:s,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:a;super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new n.A(e),this.resolution=t,this.x=i,this.y=r,this.width=s,this.height=a,this.rangeX=o,this.rangeY=l}destroy(){this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[s,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*t,o=this.height/this.rangeY*t;(0,r.hZ)(i,a,0,0,0,o,0,s,n,1),(0,r.lw)(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}}},90373:(e,t,i)=>{i.d(t,{y:()=>c,p:()=>h});var r=i(61315),s=i(16878),n=i(67058);function a(e){e.fragment.uniforms.add(new n.N("u_transformGrid",(e=>e.u_transformGrid)),new r.G("u_transformSpacing",(e=>e.common.u_transformSpacing)),new r.G("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add(s.H`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}var o=i(57197),l=i(3581);class h extends o.J{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function c(e,t){e.include(a),e.fragment.uniforms.add(new n.N("u_image",(e=>e.u_image)),new l.e("u_flipY",(e=>e.common.u_flipY)),new l.e("u_applyTransform",(e=>e.common.u_applyTransform)));const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add(new r.G("u_srcImageSize",(e=>e.common.u_srcImageSize))),e.fragment.code.add(s.H`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),i?e.fragment.code.add(s.H`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(s.H`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}},91683:(e,t,i)=>{var r,s,n;i.d(t,{$q:()=>n,NP:()=>r,kh:()=>s}),function(e){e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(r||(r={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.OUTLINE=2]="OUTLINE",e[e.LINE=3]="LINE",e[e.ICON=4]="ICON",e[e.CIRCLE=5]="CIRCLE",e[e.TEXT=6]="TEXT",e[e.TILEINFO=7]="TILEINFO"}(s||(s={})),function(e){e[e.PAINTER_CHANGED=0]="PAINTER_CHANGED",e[e.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",e[e.LAYER_CHANGED=2]="LAYER_CHANGED",e[e.LAYER_REMOVED=3]="LAYER_REMOVED",e[e.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(n||(n={}))},92143:(e,t,i)=>{i.d(t,{IV:()=>_,LF:()=>s,T9:()=>c,Wq:()=>o,d_:()=>n,g2:()=>u,gT:()=>a,hs:()=>d,iT:()=>m,kM:()=>l,l3:()=>h,n0:()=>g,r7:()=>p});var r=i(84190);function s(e){return{value:e}}function n(e,t){return{type:(0,r.t$)(t),value:e,unit:t}}function a(e,t){return{type:(0,r.t$)(t),value:e,unit:t}}function o(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"arithmetic";return{type:(0,r.t$)(t),value:e,unit:t,rotationType:i}}function l(e,t){const i=h(e,t);return"angle"===e.type?o(i,t,e.rotationType):function(e,t){return{type:(0,r.t$)(t),value:e,unit:t}}(i,t)}function h(e,t){return(0,r.oU)(e.value,e.unit,t)}function c(e,t){return null==e?t:null==t||e.value>(0,r.oU)(t.value,t.unit,e.unit)?e:t}function d(e,t){return null==e?null:{...e,value:e.value*t}}function u(e,t,i){if(t===i)return e;switch(i){case"arithmetic":case"geographic":return 90-e}}const p=n(0,"meters"),m=a(0,"square-meters"),_=(o(0,"radians"),o(0,"degrees")),g=o(0,"degrees","geographic")},92148:(e,t,i)=>{i.d(t,{S:()=>y,a:()=>w,b:()=>v,c:()=>b});var r=i(98080),s=i(28473),n=i(24344),a=i(50366),o=i(10894),l=i(61315),h=i(87824),c=i(57554),d=i(42403),u=i(16878),p=i(38950),m=i(67058),_=i(22131),g=i(20783),f=i(8118);class y extends g.Y{constructor(){super(...arguments),this.texV=(0,r.vt)(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new v}}class v{constructor(){this.center=(0,s.vt)(),this.v1=(0,s.vt)(),this.v2=(0,s.vt)()}}function b(e){const t=new f.N5,{vertex:i,fragment:r}=t;if((0,o.Gc)(i),e.geometry===n.d.Underground)t.attributes.add(_.r.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add(new h.d("cameraPosition",(e=>e.camera.eye)),new d.m("undergroundFadeAlpha",(e=>e.undergroundFadeAlpha))),i.main.add(u.H`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),r.main.add(u.H`fragColor = color;`);else{t.include(a.d,e),t.attributes.add(_.r.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const s=e.geometry===n.d.Cylinder;i.uniforms.add(new p.F("proj",(e=>e.camera.projectionMatrix)),new p.F("view",(e=>e.camera.viewMatrix))),s||(t.varyings.add("innerFactor","float"),i.uniforms.add(new c.t("silCircleCenter",(e=>e.silhouette.center))),i.uniforms.add(new c.t("silCircleV1",(e=>e.silhouette.v1))),i.uniforms.add(new c.t("silCircleV2",(e=>e.silhouette.v2))),i.uniforms.add(new l.G("texV",(e=>e.texV))),i.uniforms.add(new d.m("innerScale",(e=>e.innerScale))));const o=6.2831853,h=1/128;i.main.add(u.H`
      ${s?u.H`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:u.H`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${u.H.float(o*h)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${u.H.float(h)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),r.uniforms.add(new m.N("tex",(e=>e.texture))),s||r.uniforms.add(new d.m("altitudeFade",(e=>e.altitudeFade))),r.main.add(u.H`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${s?u.H`fragColor = atmosphereColor;`:u.H`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return t}const w=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:v,SimpleAtmospherePassParameters:y,build:b},Symbol.toStringTag,{value:"Module"}))},93989:(e,t,i)=>{i.d(t,{Bk:()=>a,ds:()=>o,r8:()=>l});let r,s=null;const n=new Map;async function a(e){null==s&&(null==r&&(r=i.e(76304).then(i.bind(i,76304))),s=await r);const t=e.view;let a=n.get(t);return a||(a=new s.default({view:t}),n.set(t,a)),a.addVoxelLayer(e)}function o(e){return n.get(e)}function l(e){const t=e.view,i=n.get(t);i&&i.removeVoxelLayer(e)<1&&(n.delete(t),0===n.size&&(r=null,s=null))}},94362:(e,t,i)=>{i.d(t,{$:()=>o,h:()=>l});var r=i(98876),s=i(69261),n=i(22131),a=i(20783);class o extends a.Y{constructor(e,t,i,r,s){super(),this.colors=e,this.textureCoordinates=t,this.hasNormals=i,this.shadeNormals=r,this.applySSAO=s}}function l(e){let{hasNormals:t,textureCoordinates:i,colors:a}=e;const o=(0,r.BP)().vec3f(n.r.POSITION);return t&&o.vec2i16(n.r.NORMALCOMPRESSED,{glNormalized:!0}),i===s.I.Default?o.vec2f(n.r.UV0):i===s.I.Atlas&&(o.vec2f(n.r.UV0),o.vec4u16(n.r.UVREGION,{glNormalized:!0})),a&&o.vec4u8(n.r.COLOR,{glNormalized:!0}),o}},94564:(e,t,i)=>{i.d(t,{o:()=>l});var r=i(769),s=i(71425),n=i(21152),a=i(12738),o=i(16878);function l(e,t){e.include(r.c,t),e.fragment.include(s.N);const i=e.fragment;i.uniforms.add(new n.V("baseColor",(e=>e.baseColor))),i.uniforms.add(new a.J("objectOpacity",(e=>e.objectOpacity))),t.hasVertexColors?i.code.add(o.H`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(o.H`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(o.H`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}},95515:(e,t,i)=>{i.d(t,{o:()=>o});var r=i(96417),s=i(6893),n=i(87824),a=i(16878);function o(e,t){e.include(s.C);e.uniforms.add(new n.d("cameraPosition",(e=>e.camera.eye))),e.constants.add("betaRayleigh","vec3",r.II),e.constants.add("betaCombined","vec3",r.cl),e.constants.add("betaMie","float",r.Oe),e.code.add(a.H`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${(0,a.If)(t,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${a.H.float(6)};

      for (int i = 0; i < ${a.H.int(6)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${(0,a.If)(!t,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${(0,a.If)(!t,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${t?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":a.H`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)}},95528:(e,t,i)=>{i.d(t,{H:()=>r});class r{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1/0;this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}},96109:(e,t,i)=>{i.d(t,{T:()=>r,V:()=>n});var r,s=i(70576);function n(e){return e&&(0,s.q8)(e)?r.Mars:e&&(0,s.KQ)(e)?r.Moon:r.Earth}!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(r||(r={}))},96417:(e,t,i)=>{i.d(t,{GF:()=>n,II:()=>o,Oe:()=>h,UP:()=>a,cl:()=>c});var r=i(64682),s=i(28473);function n(e){const t=1e5;return(0,r.qE)((e-t)/9e5,0,1)}const a=1e4,o=(0,s.fA)(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),l=(0,s.fA)(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),h=3996e-9,c=(0,s.fA)(parseFloat(Number(o[0]+l[0]).toFixed(6)),parseFloat(Number(o[1]+l[1]).toFixed(6)),parseFloat(Number(o[2]+l[2]).toFixed(6)))},97306:(e,t,i)=>{i.d(t,{l:()=>a});var r=i(92156),s=i(45192),n=i(30179);class a{constructor(e,t){this._context=e,this._descriptor=t,this.type=s.p.RenderBuffer,this._context.instanceCounter.increment(r.vt.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:n,height:a,internalFormat:o,multisampled:l}=t;l?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,o,n,a):i.renderbufferStorage(i.RENDERBUFFER,o,n,a),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,t=this._context.parameters.maxSamples;return e?Math.min(e,t):t}get usedMemory(){return(0,n.e)(this._descriptor)}resize(e,t){const i=this._descriptor;if(i.width===e&&i.height===t)return;i.width=e,i.height=t;const r=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):r.renderbufferStorage(r.RENDERBUFFER,i.internalFormat,i.width,i.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(r.vt.Renderbuffer,this),this._context=null)}}},98016:(e,t,i)=>{i.d(t,{N:()=>d,a:()=>p,b:()=>u});var r=i(98080),s=i(18484),n=i(3145),a=i(37379),o=i(61315),l=i(16878),h=i(20783),c=i(8118);class d extends h.Y{constructor(){super(...arguments),this.weatherTile=(0,r.fA)(0,0)}}function u(e){const t=new c.N5;if(t.include(a.c,!1),t.fragment.code.add(l.H`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),e.mode===s.L.Full){const e=2,i=8;t.fragment.code.add(l.H`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),t.fragment.code.add(l.H`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),t.fragment.code.add(l.H`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),t.fragment.code.add(l.H`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${l.H.float(n.ik)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${l.H.float(i)});

      float worley0 = worley(p, ${l.H.float(e)} * 2.0);
      float worley1 = worley(p, ${l.H.float(e)} * 8.0);
      float worley2 = worley(p, ${l.H.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${l.H.float(e)});
      float worley1 = worley(p, ${l.H.float(e)} * 2.0);
      float worley2 = worley(p, ${l.H.float(e)} * 4.0);
      float worley3 = worley(p, ${l.H.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.uniforms.add(new o.G("weatherTile",(e=>e.weatherTile))).code.add(l.H`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${l.H.float(n.QG)});

      // Get global coordinates of p
      p += weatherTile * ${l.H.float(n.QG)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${l.H.float(n.M4)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.mode===s.L.Full?t.fragment.main.add(l.H`
      float padWidth = 1.0;
      float paddedSize = ${l.H.float(n.CQ)} + 2.0 * padWidth;
      float tileCount = ${l.H.float(n.ik)} * ${l.H.float(n.ik)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${l.H.float(n.CQ)};
        }

        if (startPadY) {
          pixel.y += ${l.H.float(n.CQ)};
        }

        if (endPadX) {
          pixel.x -= ${l.H.float(n.CQ)};
        }

        if (endPadY) {
          pixel.y -= ${l.H.float(n.CQ)};
        }

        uv = vec2(pixel.xy / ${l.H.float(n.CQ)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${l.H.float(n.CQ)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${l.H.float(n.ik)} * ${l.H.float(n.ik)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${l.H.float(n.ik)} * ${l.H.float(n.ik)});
      p = p_;
      p.z /= (${l.H.float(n.ik)} * ${l.H.float(n.ik)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${l.H.float(n.QG)} * (gl_FragCoord.xy / ${l.H.float(n.jj)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):t.fragment.main.add(l.H`
      vec2 mapUV = ${l.H.float(n.QG)} * (gl_FragCoord.xy / ${l.H.float(n.jj)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),t}const p=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:d,build:u},Symbol.toStringTag,{value:"Module"}))},98160:(e,t,i)=>{i.d(t,{M:()=>p,a:()=>y,b:()=>m});var r=i(16804),s=i(60548),n=i(24646),a=i(3581),o=i(94409),l=i(16878),h=i(67058),c=i(22131),d=i(20783),u=i(8118);class p extends d.Y{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}}function m(){const e=new u.N5;return e.attributes.add(c.r.POSITION,"vec2"),e.vertex.uniforms.add(new o.E("drawPosition",((e,t)=>function(e,t){const i=t.camera.pixelRatio,n=e.magnifier.offset.x*i,a=e.magnifier.offset.y*i;(0,r.WA)(e.magnifier.position,_);const o=t.camera.screenToRender(_,g),l=Math.ceil(i*e.magnifier.size),{fullWidth:h,fullHeight:c}=t.camera;return(0,s.s)(f,(o[0]+n)/h*2-1,(o[1]-a)/c*2-1,l/h*2,l/c*2)}(e,t)))),e.varyings.add("vUV","vec2"),e.vertex.main.add(l.H`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),e.fragment.uniforms.add(new h.N("textureInput",(e=>e.input))),e.fragment.uniforms.add(new h.N("textureMask",(e=>e.mask))),e.fragment.uniforms.add(new h.N("textureOverlay",(e=>e.overlay))),e.fragment.uniforms.add(new a.e("maskEnabled",(e=>e.magnifier.maskEnabled))),e.fragment.uniforms.add(new a.e("overlayEnabled",(e=>e.magnifier.overlayEnabled))),e.fragment.code.add(l.H`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),e.fragment.main.add(l.H`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),e}const _=(0,r.gs)(),g=(0,r.QG)(),f=(0,n.vt)(),y=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:p,build:m},Symbol.toStringTag,{value:"Module"}))},98697:(e,t,i)=>{function r(e){return null!=e&&"type"in e&&"vector-tile"===e.type}function s(e){return null!=e&&"type"in e&&"raster-tile"===e.type}function n(e){return null!=e&&"type"in e&&"tile-texture"===e.type}function a(e){return null!=e&&"type"in e&&"image+type"===e.type}i.d(t,{Cs:()=>n,EM:()=>a,k$:()=>s,kC:()=>r})},98862:(e,t,i)=>{i.d(t,{C:()=>_,b:()=>m});var r=i(95515),s=i(77742),n=i(10894),a=i(57554),o=i(42403),l=i(16878),h=i(73712),c=i(85593),d=i(29026),u=i(47998),p=i(8118);function m(e){const t=new p.N5;t.include(c.y);const{reduced:i}=e,{fragment:m}=t;return(0,n.Gc)(m),t.include(s.C),m.include(d.t),m.include(u.b),m.include(r.o,!1),m.uniforms.add(new a.t("backgroundColor",(e=>e.backgroundColor)),new o.m("innerFadeDistance",(e=>e.innerFadeDistance)),new o.m("altitudeFade",(e=>e.altitudeFade)),new h.x("depthTexture",(e=>e.mainDepth))).code.add(l.H`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(l.H`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${(0,l.If)(!i,l.H`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),t}const _=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},99590:(e,t,i)=>{i.r(t),i.d(t,{default:()=>u});var r,s=i(93800),n=i(88102),a=i(48602),o=(i(21265),i(50925),i(14746),i(47332)),l=i(75269),h=i(78281),c=i(76845);let d=r=class extends c.default{constructor(e){super(e),this.type="color",this.color=new n.default([0,0,0,1])}clone(){return new r(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};(0,s._)([(0,o.e)({color:"color"},{readOnly:!0})],d.prototype,"type",void 0),(0,s._)([(0,a.MZ)((0,h.E)({nonNullable:!0}))],d.prototype,"color",void 0),d=r=(0,s._)([(0,l.$)("esri.webscene.background.ColorBackground")],d);const u=d},99749:(e,t,i)=>{i.d(t,{H:()=>s});var r=i(39635);class s extends r.P{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,arguments.length>3&&void 0!==arguments[3]?arguments[3]:12)}add(e,t){const i=this.value.lastValue;if(null!=i){let t=e-i;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;e=i+t}super.add(e,t)}}},99969:(e,t,i)=>{i.d(t,{f5:()=>H,d0:()=>x,Wo:()=>V,em:()=>U});var r=i(93800),s=i(67965),n=i(13473),a=i(89227),o=i(28473),l=i(60548),h=i(24646),c=i(44873),d=i(73803),u=i(62510),p=i(55426),m=i(88242),_=i(77548),g=i(20783);class f extends g.Y{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class y{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function v(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(t,i)=>{const r=t._parameterCount??0;if(t._parameterCount=r+1,e.vectorOps){const s=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(e){const t=this[r];if(null==t)this[r]=[...e];else{if(s.equals(t,e))return;s.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function b(){return(e,t)=>{const i=e._parameterCount??0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(e){this[i]!==e&&(this[i]=e,this._setDirty())}})}}var w,x,C=i(96013),T=i(96236),M=i(16213),S=i(82606),R=i(86821),A=i(12796),E=i(96109),O=i(18560),P=i(71723),D=i(86836),I=i(14391),L=i(50330),N=i(12621);class H extends f{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=(0,h.CN)(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=I.mb,this.emissiveFactor=(0,o.CN)(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.commonMaterialParameters=new F,this.componentParameters=new V,this.objectOpacity=1,this.textureAlphaCutoff=N.Q,this.alphaDiscardMode=P.sf.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=E.T.Earth,this.hasOccludees=!1;const i=new O.p(e.position),r=(0,n.o8)(e.rotationScale);(0,s.B8)(r,r),(0,s.mg)(r,r),this.transformNormalGlobalFromModel=r,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get hasEmissions(){return null!=this.emissionTexture||!(0,a.p)(this.emissiveFactor,o.uY)}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(e,t,i,r){const s=new p.E(e.context.spherical,e.context.doublePrecisionRequiresObfuscation);s.hasVertexColors=r.colors,s.hasNormals=r.hasNormals,s.textureCoordinateType=r.textureCoordinates,s.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,s.hasOcclusionTexture=null!=this.occlusionTexture,s.hasNormalTexture=null!=this.normalTexture,s.oitPass=t.identifier===C.z.Material&&null!=i.oitPass?i.oitPass:D.Y.NONE,s.terrainDepthTest=t.identifier===C.z.Material&&i.terrainDepthTest,s.cullAboveTerrain=t.identifier===C.z.Material&&i.cullAboveTerrain,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?R.W.View:R.W.None,s.hasColorTexture=null!=this.baseColorTexture;const n=this._computeWhichMaterialPass();if(s.blendingEnabled=n===w.Transparent||n===w.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?function(e){return null!=e.overlay?.getTexture(d.A.ColorNoRasterImage)}(i)?function(e){return null!=e.overlay?.getTexture(d.A.WaterNormal)}(i)?p.g.ColorOverlayWithWater:p.g.ColorOverlay:p.g.NoOverlay:p.g.None,s.hasPolygonOffset=this.polygonOffsetEnabled,s.pbrMode=s.integratedMeshMode===p.g.ColorOverlayWithWater?A.A9.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?r.shadeNormals&&this.isIntegratedMesh?A.A9.Disabled:A.A9.Schematic:A.A9.Normal:A.A9.Disabled,s.emissionSource=null!=this.emissionTexture?S.ZX.Texture:s.pbrMode===A.A9.Normal?S.ZX.Value:S.ZX.None,s.shadeNormals=r.shadeNormals,s.normalType=s.hasNormals?M.W.Compressed:M.W.ScreenDerivative,s.hasSlicePlane=null!=i.slicePlane&&this.commonMaterialParameters.hasSlicePlane,t.identifier===C.z.ShadowMap)s.output=T.V.Shadow,s.vertexDiscardMode=_.q.None;else if(t.identifier===C.z.ViewshedShadowMap)s.output=T.V.ViewshedShadow,s.vertexDiscardMode=_.q.None;else if(t.identifier===C.z.Highlight)s.output=T.V.Highlight,s.vertexDiscardMode=_.q.None;else{switch(n===w.OpaqueAndTransparent?s.vertexDiscardMode=t.transparent?_.q.Opaque:_.q.Transparent:s.vertexDiscardMode=_.q.None,s.output=t.output,s.receiveAmbientOcclusion=s.receiveShadows=!1,t.output){case T.V.Color:case T.V.ColorEmission:s.receiveAmbientOcclusion=r.applySSAO&&null!=i.ssao,s.hasOccludees=i.hasOccludees,s.receiveShadows=i.shadowMap.ready,s.screenSpaceReflections=null!=i.ssr.lastFrameColor,s.cloudReflections=null!=i.clouds.data;break;case T.V.ObjectAndLayerIdColor:s.objectAndLayerIdColor=!0}s.snowCover=this.hasSnowCover(i)}const a=e.get(u.e,s);return this._setClean(),a}hasSnowCover(e){return null!=e.weather&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}submit(e,t,i){if(this.objectOpacity<=0)return;const{componentData:r,renderable:s}=i,{geometry:n}=s,a=s.meta.cameraDepthSquared;r.updateHighlights(t.highlights);const{geometryRanges:o,highlightRangesMap:l,shadowmapRanges:h}=r;switch(this._computeWhichMaterialPass()){case w.Opaque:e.opaque.submitDraw(this,n,o,a);break;case w.Transparent:e.transparent.submitDraw(this,n,o,a);break;case w.OpaqueAndTransparent:e.opaque.submitDraw(this,n,o,a),e.transparent.submitDraw(this,n,o,a);break;case w.IntegratedMesh:e.integratedMesh.submitDraw(this,n,o,a),function(e){return null!=e.overlay?.getTexture(d.A.Highlight)}(t)&&e.highlightIntegratedMesh.submitDraw(this,n,o,a)}if(this.componentParameters.castShadows!==x.None){if(null!=l)for(const t of l)t[0]===L.Tv&&e.highlightShadowMap.submitDraw(this,n,t[1],a,t[0]);null!=h&&e.nonHighlightShadowMap.submitDraw(this,n,h,a),e.shadowMap.submitDraw(this,n,o,a)}if(null!=l)for(const c of l)e.highlight.submitDraw(this,n,c[1],a,c[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,n,o,a)}_computeWhichMaterialPass(){if(this.isIntegratedMesh)return w.IntegratedMesh;if(this.objectOpacity<1)return w.Transparent;if(this.componentParameters.opaqueOverride===x.All)return w.Opaque;if(this.baseColor[3]<1||this.alphaDiscardMode===P.sf.Blend||this.alphaDiscardMode===P.sf.MaskBlend)return w.Transparent;switch(this.componentParameters.transparent){case x.None:return w.Opaque;case x.All:return w.Transparent;case x.Some:return w.OpaqueAndTransparent}}}(0,r._)([v({vectorOps:l.v})],H.prototype,"baseColor",void 0),(0,r._)([v()],H.prototype,"usePBR",void 0),(0,r._)([v()],H.prototype,"hasParametersFromSource",void 0),(0,r._)([v({vectorOps:a.J})],H.prototype,"mrrFactors",void 0),(0,r._)([v({vectorOps:a.J})],H.prototype,"emissiveFactor",void 0),(0,r._)([v({dispose:!0})],H.prototype,"baseColorTexture",void 0),(0,r._)([v({dispose:!0})],H.prototype,"metallicRoughnessTexture",void 0),(0,r._)([v({dispose:!0})],H.prototype,"emissionTexture",void 0),(0,r._)([v({dispose:!0})],H.prototype,"occlusionTexture",void 0),(0,r._)([v({dispose:!0})],H.prototype,"normalTexture",void 0),(0,r._)([b()],H.prototype,"commonMaterialParameters",void 0),(0,r._)([b()],H.prototype,"componentParameters",void 0),(0,r._)([v()],H.prototype,"objectOpacity",void 0),(0,r._)([v()],H.prototype,"textureAlphaCutoff",void 0),(0,r._)([v()],H.prototype,"alphaDiscardMode",void 0),(0,r._)([v()],H.prototype,"isIntegratedMesh",void 0),(0,r._)([v()],H.prototype,"polygonOffsetEnabled",void 0),(0,r._)([v()],H.prototype,"ellipsoidMode",void 0),(0,r._)([v()],H.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(w||(w={}));class F extends y{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=P.s2.Back,this.hasSlicePlane=!0}}(0,r._)([v()],F.prototype,"doubleSided",void 0),(0,r._)([v()],F.prototype,"cullFace",void 0),(0,r._)([v()],F.prototype,"hasSlicePlane",void 0);class V extends y{constructor(){super(...arguments),this.externalColor=(0,h.fA)(1,1,1,1),this.externalColorMixMode=c.k5.Multiply,this.castShadows=x.All}get transparent(){return this.externalColor[3]<1?x.All:x.None}get opaqueOverride(){return this.externalColorMixMode===c.k5.Replace&&1===this.externalColor[3]?x.All:x.None}get visible(){return this.externalColor[3]>0?x.All:x.None}get type(){return m.Sg.Uniform}}(0,r._)([v({vectorOps:l.v})],V.prototype,"externalColor",void 0),(0,r._)([v()],V.prototype,"externalColorMixMode",void 0),(0,r._)([v()],V.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(x||(x={}));class U extends y{constructor(){super(...arguments),this.texture=null,this.transparent=x.None,this.opaqueOverride=x.None,this.castShadows=x.None}get type(){return m.Sg.Varying}}(0,r._)([v()],U.prototype,"texture",void 0),(0,r._)([v()],U.prototype,"transparent",void 0),(0,r._)([v()],U.prototype,"opaqueOverride",void 0),(0,r._)([v()],U.prototype,"castShadows",void 0)}}]);