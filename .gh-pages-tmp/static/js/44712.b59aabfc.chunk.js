"use strict";(self.webpackChunkever_wading_birds=self.webpackChunkever_wading_birds||[]).push([[44712,55052],{9137:(e,t,i)=>{i.d(t,{D:()=>o,S:()=>h});var s=i(64682),l=i(50821),r=i(17745),n=i(87118);function o(e,t){let{level:i,class:s,...o}=e;const h=a(i);return(0,n.K)(`h${h}`,{...o,"aria-level":String(h),class:(0,r.Ly)(l.D.heading,s),role:"heading"},t)}function a(e){return(0,s.qE)(Math.ceil(e),1,6)}function h(e){return a(e+(arguments.length>1&&void 0!==arguments[1]?arguments[1]:1))}},44712:(e,t,i)=>{i.r(t),i.d(t,{default:()=>w});var s=i(93800),l=(i(88677),i(79953)),r=i(48602),n=(i(21265),i(50925),i(14746),i(75269)),o=i(27811);const a="esri-floor-filter",h=`${a}__filter-menu`,d={floorFilter:a,floorFilterLayout:`${a}__layout--`,floorFilterPosition:`${a}__position--`,buttonContainer:`${a}__button-container`,buttonContainerLevels:`${a}__button-container--levels`,buttonInfo:`${a}__button-info`,buttonLabel:`${a}__button-label`,browseButton:`${a}__browse-button`,closeLevelsButton:`${a}__close-levels-button`,zoomButton:`${a}__zoom-button`,zoomButtonLevels:`${a}__zoom-button--levels`,minimizeToggleButton:`${a}__minimize-toggle-button`,levelsContainer:`${a}__levels-container`,levelButton:`${a}__level-button`,levelButtonActive:`${a}__level-button--active`,iconFlip:"esri-collapse__icon-flip",separator:`${a}__separator`,filterMenu:h,filterMenuHeader:`${h}-header`,filterMenuHeaderTextGroup:`${h}-header-text-group`,filterMenuHeaderText:`${h}-header-text`,filterMenuHeaderSubtext:`${h}-header-subtext`,filterMenuHeaderBack:`${h}-header-back`,filterMenuSearch:`${h}-search`,filterMenuSearchInput:`${h}-search-input`,filterMenuItems:`${h}-items`,filterMenuItemName:`${h}-item-name`,filterMenuSelectedItem:`${h}-item-name--selected`,filterMenuSite:`${h}-site`,filterMenuFacility:`${h}-facility`,selectedItemCircle:`${a}__selected-item-circle`};var c=i(55052),u=i(50821),v=i(9137),f=i(52353),m=i(17745),p=i(76697),y=i(87118),_=i(99961);const g=new Set(["ArrowUp","ArrowDown","End","Home"]);let M=class extends o.default{constructor(e,t){super(e,t),this._activeMenu=null,this._activeMenuIndex={levels:-1,menuItems:-1},this._baseNode=null,this._facilitiesListNode=null,this._levelsListNode=null,this._sitesListNode=null,this._searchInput=null,this.viewModel=new c.default,this.messages=null,this.messagesCommon=null,this.headingLevel=2,this._resizeObserver=new ResizeObserver((()=>this.scheduleRender())),this.addHandles((0,l.watch)((()=>this._searchInput),(()=>this._focusSearch())))}destroy(){this._resizeObserver?.disconnect()}get enabled(){return this.viewModel.enabled}set enabled(e){this.viewModel.enabled=e}get longNames(){return this.viewModel.longNames}set longNames(e){this.viewModel.longNames=e}get minimized(){return this.viewModel.minimized}set minimized(e){this.viewModel.minimized=e}get pinnedLevels(){return this.viewModel.pinnedLevels}set pinnedLevels(e){this.viewModel.pinnedLevels=e}get site(){return this.viewModel.site}set site(e){this.viewModel.site=e}get facility(){return this.viewModel.facility}set facility(e){this.viewModel.facility=e}get level(){return this.viewModel.level}set level(e){this.viewModel.level=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return"floor-plan"}set icon(e){this._overrideIfSome("icon",e)}updateWebDocument(e){return this.viewModel.updateWebDocument(e)}render(){const{longNames:e}=this,t=e&&this.viewModel.isNormalMode?"expanded":"collapsed",i=this._renderButtons(),s=this._renderFilterMenu(),l=(0,y.K)("div",{class:this.classes(d.separator)}),r=this._getComponentPosition(),n=this._getPosition(r),o="top-right"===r||"bottom-right"===r,a="top-left"===r||"bottom-left"===r,h=(0,m.V8)(this.container),c=h&&a||!h&&o?s:i,v=h&&a||!h&&o?i:s;return(0,y.K)("div",{afterCreate:this._afterBaseNodeCreate,class:this.classes(d.floorFilter,u.D.widget,`${d.floorFilterLayout}${t}`,`${d.floorFilterPosition}${n}`),key:"floor-filter-menu"},c,this.viewModel?.filterMenuOpen?l:null,v)}_renderButtons(){const e=this._getComponentPosition(),t=[];return"top"===this._getPosition(e)?(t.push(this._renderBrowseButton()),t.push(this._renderLevelButtons()),t.push(this._renderCloseLevelsButton()),t.push(this._renderZoomButton()),t.push(this._renderCollapseToggleButton())):(t.push(this._renderCollapseToggleButton()),t.push(this._renderZoomButton()),t.push(this._renderCloseLevelsButton()),t.push(this._renderLevelButtons()),t.push(this._renderBrowseButton())),(0,y.K)("div",{class:this.classes(u.D.widget,d.buttonContainer),key:"button-container"},t)}_renderBrowseButton(){const{longNames:e,messages:t}=this;return(0,y.K)("button",{"aria-expanded":this.viewModel.filterMenuOpen.toString(),"aria-label":t.buttons.browse,bind:this,class:this.classes(u.D.widget,u.D.widgetButton,u.D.interactive,("loading"===this.viewModel.state||"disabled"===this.viewModel.state)&&u.D.buttonDisabled,d.browseButton,this.viewModel?.filterMenuOpen&&u.D.widgetButtonActive),key:"browse-button",onclick:this._toggleFilterMenu,title:t.buttons.browse,type:"button"},(0,y.K)("div",{class:this.classes(d.buttonInfo)},(0,y.K)("span",{class:this.classes(f.T.icon,f.T.urbanModel)}),(0,y.K)("span",{class:this.classes(d.buttonLabel)},e&&this.viewModel.isNormalMode?t.buttons.browse:null)))}_renderLevelButtons(){if(!this.viewModel?.filterFeatures?.levels?.levelsInfo||!this.facility)return null;const{facility:e,messagesCommon:t,messages:i}=this,s=this.viewModel?.getFacility(e),l=this.viewModel?.getFacilityLevels(e),r=l.map((e=>this._renderLevelButton(e)));if(!r.length)return null;const n=s&&(0,_.V)(i.selector.levelsLabel,{name:`"${s.name}"`});if(this._isWebScene(this.view?.map)&&r?.length>1){const i={id:`all--${e}`,facilityId:e,shortName:t.all,longName:t.all,levelNumber:null,verticalOrder:null},s=this._renderLevelButton(i);r.push(s)}return(0,y.K)("ul",{afterCreate:m.cA,"aria-label":n,bind:this,class:this.classes(d.levelsContainer),"data-id":"levels","data-node-ref":"_levelsListNode",key:"levels-button-container",onkeydown:this._handleListKeydown},r)}_renderLevelButton(e){const{longNames:t}=this,{shortName:i,longName:s,id:l}=e,r=`levels--${l}`,n=this.level===l,o=t&&this.viewModel.isNormalMode?s:i;return this.viewModel.isNormalMode||n||this.viewModel.levelsExpanded?(0,y.K)("li",{key:r},(0,y.K)("button",{bind:this,class:this.classes(u.D.widgetButton,n?u.D.widgetButtonActive:null,u.D.interactive,d.levelButton),"data-id":l,"data-list-id":"levels",onclick:this._levelSelected,onfocus:this._onItemFocus,type:"button"},o)):null}_renderCloseLevelsButton(){if(!this.level||this.viewModel.isNormalMode||!this.viewModel.levelsExpanded)return null;const{messagesCommon:e}=this;return(0,y.K)("button",{"aria-label":e.close,bind:this,class:this.classes(u.D.widget,u.D.widgetButton,u.D.interactive,d.closeLevelsButton),key:"close-levels-button",onclick:this._closeLevels,title:e.close,type:"button"},(0,y.K)("div",{class:this.classes(d.buttonInfo)},(0,y.K)("span",{class:this.classes(f.T.icon,f.T.close)})))}_renderZoomButton(){const{longNames:e,messages:t,facility:i,site:s}=this,l=this.viewModel?.filterMenuType,r=this.viewModel?.filterMenuOpen,n=this.viewModel?.getSite(s),o=this.viewModel?.getFacility(i),a="site"===l&&r?!n:!o;return(0,y.K)("button",{"aria-label":t.buttons.zoomTo,bind:this,class:this.classes(u.D.widget,u.D.widgetButton,a&&u.D.buttonDisabled,u.D.interactive,this.viewModel?.getFacilityLevels(i).length>0?d.zoomButtonLevels:d.zoomButton),key:"zoom-button",onclick:this._zoomToClicked,title:t.buttons.zoomTo,type:"button"},(0,y.K)("div",{class:this.classes(d.buttonInfo)},(0,y.K)("span",{class:this.classes(f.T.icon,f.T.zoomToObject)}),(0,y.K)("span",{class:this.classes(d.buttonLabel)},e&&this.viewModel.isNormalMode?t.buttons.zoomTo:null)))}_renderCollapseToggleButton(){const{longNames:e,messagesCommon:t}=this,i=e?f.T.collapse:f.T.expand,s=this.classes(f.T.icon,i,d.iconFlip),l=e?t.collapse:t.expand;return(0,y.K)("button",{"aria-label":l,bind:this,class:this.classes(u.D.widget,u.D.widgetButton,u.D.interactive,d.minimizeToggleButton),key:"minimize-toggle-button",onclick:this._toggleCollapsed,title:l,type:"button"},(0,y.K)("div",{class:this.classes(d.buttonInfo)},(0,y.K)("span",{class:s}),(0,y.K)("span",{class:this.classes(d.buttonLabel)},e&&this.viewModel.isNormalMode?t.collapse:null)))}_renderFilterMenu(){return this.viewModel?.filterMenuOpen?"site"===this.viewModel?.filterMenuType?this._renderSiteFilterMenu():"facility"===this.viewModel?.filterMenuType?this._renderFacilityFilterMenu():null:null}_renderSiteFilterMenu(){const{messages:e,messagesCommon:t}=this,i=this.site?this.viewModel?.getSite(this.site)?.name:e.selector.selectSite,s=(0,y.K)("div",{class:this.classes(`${d.filterMenuHeader}`),key:"filter-menu-site-header"},(0,y.K)("div",{class:this.classes(d.filterMenuHeaderTextGroup)},(0,y.K)(v.D,{class:this.classes(d.filterMenuHeaderText),level:this.headingLevel},i)),(0,y.K)("button",{bind:this,class:this.classes(f.T.icon,f.T.close),onclick:this._closeClicked,title:t.close,type:"button"})),l=this._renderSearchInput(),r=this._renderSiteItems();return(0,y.K)("div",{class:this.classes(d.filterMenu),key:"filter-menu-site"},s,l,r)}_renderFacilityFilterMenu(){const{messages:e,messagesCommon:t,site:i}=this,s=this.viewModel?.getSite(i)?.name,l=this.facility&&this.viewModel?.getFacility(this.facility)?.name||e.selector.selectFacility,r=this.viewModel.hasMultipleSites?(0,y.K)("button",{bind:this,class:this.classes(d.filterMenuHeaderBack),onclick:this._backClicked,title:t.back,type:"button"},(0,y.K)("span",{class:this.classes((0,m.V8)(this.container)?f.T.right:f.T.left)})):null,n=this.viewModel.hasMultipleSites?(0,y.K)(v.D,{class:this.classes(d.filterMenuHeaderSubtext),level:(0,v.S)(this.headingLevel)},s):null,o=(0,y.K)("div",{class:this.classes(d.filterMenuHeader),key:"filter-menu-site-header"},r,(0,y.K)("div",{class:this.classes(d.filterMenuHeaderTextGroup)},(0,y.K)(v.D,{class:this.classes(d.filterMenuHeaderText),level:this.headingLevel},l),n),(0,y.K)("button",{bind:this,class:this.classes(f.T.icon,f.T.close),onclick:this._closeClicked,title:t.close,type:"button"})),a=this._renderSearchInput(),h=this._renderFacilityItems();return(0,y.K)("div",{class:this.classes(d.filterMenu),key:"filter-menu-facility"},o,a,h)}_renderSearchInput(){const{messagesCommon:e}=this,t=!!(this.viewModel.searchTerm&&this.viewModel.searchTerm?.length>0);return(0,y.K)("div",{class:this.classes(d.filterMenuSearch),key:"filter-menu-search"},(0,y.K)("span",{class:this.classes(f.T.icon,f.T.search),key:"filter-menu-search-icon"}),(0,y.K)("input",{afterCreate:m.cA,bind:this,class:this.classes(d.filterMenuSearchInput),"data-node-ref":"_searchInput",oninput:this._onSearchChange,onpaste:this._onSearchChange,placeholder:e.search,value:this.viewModel.searchTerm??void 0}),t?(0,y.K)("span",{bind:this,class:this.classes(f.T.icon,f.T.close),key:"filter-menu-search-clear",onclick:this._onSearchClear,title:e.clear}):null)}_renderBlueCircle(){return(0,y.K)("span",{class:this.classes(d.selectedItemCircle),key:"floor-filter__selected-item-circle"})}_renderSiteItems(){if(!this.viewModel?.filterFeatures?.sites?.sitesInfo)return null;const{messages:e}=this,t=this.viewModel.filterFeatures.sites.sitesInfo,i=this.viewModel.filterSites(t).map((e=>this._renderSiteItem(e))),s=0===i.length&&this.viewModel?.searchTerm&&(0,y.K)("div",{class:this.classes(u.D.empty)},e.noResults);return(0,y.K)("ul",{afterCreate:m.cA,"aria-label":e.selector.sitesLabel,bind:this,class:this.classes(d.filterMenuItems),"data-id":"sites","data-node-ref":"_sitesListNode",key:"filter-menu-items--sites",onkeydown:this._handleListKeydown,tabIndex:-1},i,s)}_renderSiteItem(e){const{name:t,id:i}=e,s=`filter-menu-site--${i}`,l=this.site===i;return(0,y.K)("li",{key:s},(0,y.K)("button",{bind:this,class:this.classes(d.filterMenuSite),"data-id":i,"data-list-id":"sites",onclick:this._siteSelected,onfocus:this._onItemFocus,type:"button"},l?this._renderBlueCircle():null,(0,y.K)("span",{class:this.classes(l?d.filterMenuSelectedItem:d.filterMenuItemName)},t),(0,y.K)("span",{class:this.classes((0,m.V8)(this.container)?f.T.left:f.T.right)})))}_renderFacilityItems(){if(!this.viewModel?.filterFeatures?.facilities?.facilitiesInfo)return null;const{messages:e,site:t}=this,i=this.viewModel.getSite(t),s=this.viewModel.filterFeatures.facilities.facilitiesInfo,l=this.viewModel.filterFacilities(s).map((e=>this._renderFacilityItem(e))),r=0===l.length&&this.viewModel?.searchTerm&&(0,y.K)("div",{class:this.classes(u.D.empty)},e.noResults),n=i?(0,_.V)(e.selector.siteFacilitiesLabel,{name:`"${i.name}"`}):e.selector.facilitiesLabel;return(0,y.K)("ul",{afterCreate:m.cA,"aria-label":n,bind:this,class:this.classes(d.filterMenuItems),"data-id":"facilities","data-node-ref":"_facilitiesListNode",key:"filter-menu-items--facilities",onkeydown:this._handleListKeydown,tabIndex:-1},l,r)}_renderFacilityItem(e){const{name:t,id:i}=e,s=`filter-menu-facility--${i}`,l=this.facility===i;return(0,y.K)("li",{key:s},(0,y.K)("button",{bind:this,class:this.classes(d.filterMenuFacility),"data-id":i,"data-list-id":"facilities",onclick:this._facilitySelected,onfocus:this._onItemFocus,type:"button"},l?this._renderBlueCircle():null,(0,y.K)("span",{class:this.classes(l?d.filterMenuSelectedItem:d.filterMenuItemName)},t)))}_afterBaseNodeCreate(e){this._baseNode&&this._resizeObserver?.unobserve(this._baseNode),this._baseNode=e,this._resizeObserver?.observe(this._baseNode)}_toggleCollapsed(){this.longNames=!this.longNames}_toggleFilterMenu(){const e=this.viewModel?.filterMenuOpen??!1;this.viewModel.filterMenuOpen=!e}_setFilterMenuType(e){this.viewModel.filterMenuType=e}_zoomToClicked(){if(this.site&&"site"===this.viewModel?.filterMenuType&&this.viewModel?.filterMenuOpen){const e=this.viewModel?.getSite(this.site);this.viewModel.goTo(e)}else if(this.facility){const e=this.viewModel?.getFacility(this.facility);this.viewModel.goTo(e)}else if(this.site){const e=this.viewModel?.getSite(this.site);this.viewModel.goTo(e)}}_onSearchChange(e){const t=e.target;""===t.value?this.viewModel.searchTerm=null:t.value&&this.viewModel?.searchTerm!==t.value&&(this.viewModel.searchTerm=t.value)}_onSearchClear(){this.viewModel.searchTerm=null}_closeClicked(){this.viewModel.searchTerm=null,this.viewModel.filterMenuOpen=!1}_backClicked(){this._setFilterMenuType("site"),this.viewModel.searchTerm=null}_siteSelected(e){const t=e.currentTarget.getAttribute("data-id"),i=this.viewModel.getSite(t);let s=!1;this.site!==t&&(this.facility=null,this.level=null,s=!0,this.viewModel.levelsExpanded=!1),this.site=t,this.viewModel.searchTerm=null,this._setFilterMenuType("facility"),this.viewModel.goTo(i),s&&this.viewModel.setFloors(null)}_facilitySelected(e){const t=e.currentTarget.getAttribute("data-id"),i=this.viewModel.getFacility(t);let s=!1;if(this.facility!==t){if("base-floors"===this.viewModel.filterMode){const e=this.viewModel?.getBaseLevel(i);this.level=e?e.id:null}else this.level=null;s=!0,this.viewModel.levelsExpanded=!1}if(this.facility=t,this.viewModel.goTo(i),s){const e=this.viewModel.getLevel(this.level);this.viewModel.setFloors(e)}if(!this.viewModel.isNormalMode){const e=this.viewModel.getFacilityLevels(t);e?.length>1&&(this.viewModel.levelsExpanded=!0)}setTimeout((()=>this._focusActiveLevel()),50)}_levelSelected(e){const t=e.currentTarget.getAttribute("data-id");this.level=t}_closeLevels(){this.viewModel.levelsExpanded=!1}_isWebScene(e){return"esri.WebScene"===e?.declaredClass}_getComponentPosition(){return null!=this.container?this.view?.ui?.getPosition(this.container):null}_getPosition(e){switch(e){case"bottom-right":case"bottom-left":return"bottom";default:return"top"}}_handleListKeydown(e){const t=e.currentTarget.getAttribute("data-id");let i=null;"sites"===t||"facilities"===t?(this._activeMenu!==t&&(this._activeMenuIndex.menuItems=-1),this._activeMenu=t,i="menuItems"):"levels"===t&&(i="levels");const s="sites"===t?this._sitesListNode:"facilities"===t?this._facilitiesListNode:"levels"===t?this._levelsListNode:null,{key:l}=e,r="Tab"===l,n=g.has(l);n&&e.preventDefault();const o=s?.getElementsByTagName("li");o&&0!==o.length&&(n||r)&&this._handleItemNavigation(l,e.shiftKey,o,r,i)}_handleItemNavigation(e,t,i,s,l){if(!l)return;this._activeMenuIndex[l]===i.length&&this._activeMenuIndex[l]--,-1===this._activeMenuIndex[l]&&this._activeMenuIndex[l]++;const r=this._activeMenuIndex[l];switch(e){case"Home":this._activeMenuIndex[l]=0;break;case"End":this._activeMenuIndex[l]=i.length-1;break;case"ArrowUp":this._activeMenuIndex[l]=this._activeMenuIndex[l]<=0?i.length-1:this._activeMenuIndex[l]-1;break;case"ArrowDown":this._activeMenuIndex[l]=this._activeMenuIndex[l]===i.length-1?0:this._activeMenuIndex[l]+1}if("Tab"===e&&t&&this._activeMenuIndex[l]>=0&&this._activeMenuIndex[l]--,"Tab"===e&&!t&&this._activeMenuIndex[l]<i.length&&this._activeMenuIndex[l]++,r!==this._activeMenuIndex[l]&&this._activeMenuIndex[l]>-1&&this._activeMenuIndex[l]<i.length&&!s){const e=i[this._activeMenuIndex[l]].getElementsByTagName("button"),t=1===e?.length?e[0]:null;t?.focus()}}_focusSearch(){this._searchInput?.focus()}_focusActiveLevel(){const{level:e}=this,t=this._levelsListNode,i=t?.getElementsByTagName("li");if(!e||!t||!i)return;const s=this._facilitiesListNode?.getElementsByTagName("li");this._activeMenuIndex.menuItems=s?s.length-1:-1;const l=[];for(let r=0;r<i.length;r++){const e=i[r].getElementsByTagName("button");1===e?.length&&l.push(e[0])}l.forEach(((t,i)=>{t.getAttribute("data-id")===e&&(t.focus(),this._activeMenuIndex.levels=i)}))}_onItemFocus(e){const t=e.currentTarget,i=t.getAttribute("data-list-id"),s=t.getAttribute("data-id"),l="sites"===i?this._sitesListNode:"facilities"===i?this._facilitiesListNode:"levels"===i?this._levelsListNode:null;if(!l)return;const r=l?.getElementsByTagName("li");if(!r)return;const n=[];Array.from(r).forEach((e=>{const t=e.getElementsByTagName("button");1===t?.length&&n.push(t[0])}));let o=null;switch(i){case"sites":case"facilities":o="menuItems";break;case"levels":o="levels"}if(!o)return;const a=o;n.forEach(((e,t)=>{e.getAttribute("data-id")===s&&this._activeMenuIndex[a]!==t&&(this._activeMenuIndex[a]=t)}))}};(0,s._)([(0,r.MZ)()],M.prototype,"_searchInput",void 0),(0,s._)([(0,r.MZ)()],M.prototype,"enabled",null),(0,s._)([(0,r.MZ)()],M.prototype,"longNames",null),(0,s._)([(0,r.MZ)()],M.prototype,"minimized",null),(0,s._)([(0,r.MZ)()],M.prototype,"pinnedLevels",null),(0,s._)([(0,r.MZ)()],M.prototype,"site",null),(0,s._)([(0,r.MZ)()],M.prototype,"facility",null),(0,s._)([(0,r.MZ)()],M.prototype,"level",null),(0,s._)([(0,r.MZ)()],M.prototype,"view",null),(0,s._)([(0,r.MZ)({type:c.default})],M.prototype,"viewModel",void 0),(0,s._)([(0,r.MZ)(),(0,p.G)("esri/widgets/FloorFilter/t9n/FloorFilter")],M.prototype,"messages",void 0),(0,s._)([(0,r.MZ)(),(0,p.G)("esri/t9n/common")],M.prototype,"messagesCommon",void 0),(0,s._)([(0,r.MZ)()],M.prototype,"goToOverride",null),(0,s._)([(0,r.MZ)()],M.prototype,"headingLevel",void 0),(0,s._)([(0,r.MZ)()],M.prototype,"icon",null),M=(0,s._)([(0,n.$)("esri.widgets.FloorFilter")],M);const w=M},55052:(e,t,i)=>{i.r(t),i.d(t,{default:()=>_});var s=i(93800),l=i(6946),r=i(58828),n=i(89129),o=i(74719),a=i(49959),h=i(79953),d=i(26988),c=i(48602),u=(i(21265),i(50925),i(14746),i(75269)),v=i(99982),f=i(34248),m=i(46047),p=i(30920);let y=class extends((0,p.A)(l.default)){constructor(e){super(e),this.filterMenuOpen=!1,this.filterMenuType="site",this.filterMode="base-floors",this.levelsExpanded=!0,this.searchTerm=null,this.view=null,this._updateFloorFilterTask=null,this._viewHeightBreakpoint=null,this._viewWidthBreakpoint=null}initialize(){this.addHandles([(0,h.watch)((()=>this.view?.map),(e=>{null!=this._updateFloorFilterTask&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null),this._updateFloorFilterTask=(0,r.UT)((async t=>{await this._updateFloorFilterFromMap(e),(0,a.throwIfAborted)(t),this._setInitialViewState(e)}))}),h.initial),(0,h.watch)((()=>this.view),((e,t)=>{this._unregisterWidget(t),this._registerWidget(e),this._watchSearchResults(e)}),h.syncAndInitial),(0,h.watch)((()=>this.view?.widthBreakpoint??null),(e=>{this._viewWidthBreakpoint=e})),(0,h.watch)((()=>this.view?.heightBreakpoint??null),(e=>{this._viewHeightBreakpoint=e}))])}destroy(){this._unregisterWidget(this.view),this.view=null,null!=this._updateFloorFilterTask&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)}set enabled(e){this._callOverride("enabled",e)}set facility(e){if(e&&this._isOverridden("facility")){const t=this.getFacility(e);this.hasMultipleSites&&(this.site=t?.siteId||null)}this._callOverride("facility",e)}set filterFeatures(e){this._callOverride("filterFeatures",e)}set filterLayers(e){this._callOverride("filterLayers",e)}get hasFacilities(){return null!=this.filterLayers?.facilityLayer&&this.filterFeatures?.facilities?.facilitiesInfo?.length>0}get hasLevels(){return null!=this.filterLayers?.levelLayer&&this.filterFeatures?.levels?.levelsInfo?.length>0}get hasMultipleSites(){return null!=this.filterLayers?.siteLayer&&this.filterFeatures?.sites?.sitesInfo?.length>1}get isNormalMode(){let e=!0;const t=this._viewWidthBreakpoint;return"xsmall"!==this._viewHeightBreakpoint&&"xsmall"!==t||(e=!1),e}set level(e){if(!e)return this._callOverride("level",e),this.facility=null,this.site=null,void this.setFloors(null);let t=null,i=null;const s=e?.split("--");if(s?.length>1&&"all"===s[0]?(i=s[1],t={id:e,facilityId:i,shortName:null,longName:null,levelNumber:null,verticalOrder:null}):(t=this.getLevel(e),i=t?.facilityId??null),this.level!==e||this.isNormalMode||this.levelsExpanded)t&&this.hasFacilities&&this.hasLevels?(this.facility=i,this.hasMultipleSites&&(this.site=this.getFacility(i)?.siteId||null),this.setFloors(t)):this._isOverridden("level")&&(this.facility=null,this.site=null,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null)),this._callOverride("level",e);else{const e=this.getFacilityLevels(i);e?.length>1&&(this.levelsExpanded=!0)}}set longNames(e){this._callOverride("longNames",e)}set minimized(e){this._callOverride("minimized",e)}set pinnedLevels(e){this._callOverride("pinnedLevels",e)}set site(e){this._callOverride("site",e)}get state(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}filterFacilities(e){let t=e;return this.searchTerm&&(this.searchTerm=this.searchTerm.trim(),t=e.filter((e=>{const{name:t}=e;return t.toLowerCase().includes(this.searchTerm?.toLowerCase())}))),this.site&&(t=t.filter((e=>e.siteId===this.site))),t.sort(((e,t)=>{const i=e.name,s=t.name;return i.localeCompare(s,void 0,{sensitivity:"base"})}))}filterSites(e){let t=e;return this.searchTerm&&(this.searchTerm=this.searchTerm.trim(),t=e.filter((e=>{const{name:t}=e;return t.toLowerCase().includes(this.searchTerm?.toLowerCase())}))),t.sort(((e,t)=>{const i=e.name,s=t.name;return i.localeCompare(s,void 0,{sensitivity:"base"})}))}getBaseLevel(e){const t=this.filterFeatures?.levels?.levelsInfo;let i=null;if(e){const{id:s}=e;if(t&&t.length>0&&(t.forEach((e=>{0===e.verticalOrder&&e.facilityId===s&&(i=e)})),!i)){let e=null;t.forEach((t=>{t.facilityId===s&&(e?(t.verticalOrder??0)>=0?null!=e.verticalOrder&&(e.verticalOrder<0||(t.verticalOrder??0)<e.verticalOrder)&&(e=t):null!=e.verticalOrder&&null!=t.verticalOrder&&e.verticalOrder<0&&t.verticalOrder>e.verticalOrder&&(e=t):e=t)})),e&&(i=e)}}return i}getFacility(e){return this.filterFeatures?.facilities?.facilitiesInfo?.find((t=>t.id===e))??null}getFacilityLevels(e){return e&&this.filterFeatures?.levels?.levelsInfo?this.filterFeatures.levels.levelsInfo.filter((t=>t.facilityId===e)).sort(((e,t)=>{const i=e.verticalOrder??0,s=t.verticalOrder??0;return i>s?-1:i===s?0:1})):[]}getLevel(e){return this.filterFeatures?.levels?.levelsInfo?.find((t=>t.id===e))??null}getSite(e){return this.filterFeatures?.sites?.sitesInfo?.find((t=>t.id===e))??null}goTo(e){const{view:t}=this;if(!t||!e)return;const{geometry:i}=e;i&&i.extent&&this.callGoTo({target:i.extent,options:{duration:(0,d.l5)(1e3),easing:"in-out-quad"}})}setFloors(e){const{view:t}=this;t&&(t?.map?.allLayers?.forEach((e=>{"feature"===e.type&&this._computeViewAllModeFloors(e)})),t.floors=new n.default(this._computeFloors(e)))}updateWebDocument(e){if((0,m.r)(e)){const t=new f.A({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:this.site??null,facility:this.facility??null,level:this.level??null});e.widgets?e.widgets.floorFilter=t:e.widgets=new v.A({floorFilter:t})}}_computeFloors(e){if("single-floor"===this.filterMode)this._computeSingleFloor(e);else if("base-floors"===this.filterMode)return"3d"===this.view?.type?this._computeBaseFloors3D(e):this._computeBaseFloors(e);return this._computeEmptyFloors()}_computeSingleFloor(e){if(!e)return this._computeEmptyFloors();const t=[];return"all"===e?.id?this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&t.push(e.id)})):e&&t.push(e.id),t}_computeBaseFloors(e){const t=this.filterFeatures?.levels?.levelsInfo;if(!t?.length)return this._computeEmptyFloors();const i=[];"all"===e?.id?this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&i.push(e.id)})):e&&i.push(e.id);const s=e?.facilityId;return t.forEach((e=>{const{id:t,facilityId:l,verticalOrder:r}=e;(s||0!==r||i.includes(t))&&(l===s||0!==r||i.includes(t))||i.push(t)})),i}_computeBaseFloors3D(e){const t=this.filterFeatures?.levels?.levelsInfo;if(!t?.length)return this._computeEmptyFloors();const i=[],s=e?.id.split("--")??[];s?.length>1&&"all"===s[0]?this.getFacilityLevels(e?.facilityId).forEach((e=>{e.id&&i.push(e.id)})):e&&i.push(e.id);const l=e?.facilityId;return t.forEach((e=>{const{id:t,facilityId:s}=e;(l||i.includes(t))&&(s===l||i.includes(t))||i.push(t)})),i}_computeEmptyFloors(){return[]}async _setFilterLayers(){const{view:e}=this;if(e&&!this._isOverridden("filterLayers")){if(!(0,m.r)(e.map)&&!function(e){return"esri.WebScene"===e.declaredClass}(e.map))throw new o.default("Map must be a webmap or webscene");{const t=e.map,i=t?.allLayers;if(i?.items?.length>0){const e={siteLayer:null,facilityLayer:null,levelLayer:null},s=t.floorInfo?.siteLayer?.layerId,l=t.floorInfo?.facilityLayer?.layerId,r=t.floorInfo?.levelLayer?.layerId,n=t.floorInfo?.siteLayer?.sublayerId||t.floorInfo?.facilityLayer?.sublayerId||t.floorInfo?.levelLayer?.sublayerId;if(!l||!r)return;const o=i.items.filter((e=>"feature"===e.type||"scene"===e.type)),a=i.items.filter((e=>"map-image"===e.type));if(a?.length>0&&n){await Promise.all(a.map((e=>e.load())));const i=t.floorInfo?.siteLayer?.sublayerId,n=t.floorInfo?.facilityLayer?.sublayerId,o=t.floorInfo?.levelLayer?.sublayerId;a.forEach((t=>{const a=t.id,h=t?.allSublayers,d=h?.items;(a===s||a===l||a===r)&&d?.length>0&&h.items.forEach((t=>{const l=t.id;a===s&&l===i?e.siteLayer=t:l===n?e.facilityLayer=t:l===o&&(e.levelLayer=t)}))}))}o?.length>0&&o.forEach((t=>{const i=t.id;i===s?e.siteLayer=t:i===l?e.facilityLayer=t:i===r&&(e.levelLayer=t)})),this.filterLayers=e}}}}async _getFilterFeatures(){if(this._isOverridden("filterFeatures"))return this.filterFeatures;const[e,t,i]=await Promise.all([this._getSites(),this._getFacilities(),this._getLevels()]);return{sites:e,facilities:t,levels:i}}async _getSites(){const e={sitesInfo:[]},{filterLayers:t,view:i}=this,s=i?.map,{siteLayer:l}=t;if(!l||!s?.floorInfo?.siteLayer)return e;const r=l.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0,"type"in l&&"scene"===l.type&&(r.multipatchOption="xyFootprint");const{siteIdField:n,nameField:o}=s.floorInfo.siteLayer,a=await l.queryFeatures(r);if(a?.features?.length>0){const t=a.features,i=l?.fieldsIndex.get(n)?.name||n,s=l?.fieldsIndex.get(o)?.name||o;null!=i&&null!=s&&t.forEach((t=>{const l=t.attributes,r=t.geometry,n=l[i],o=l[s];n&&o&&e.sitesInfo.push({id:n,name:o,geometry:r})}))}return e}async _getFacilities(){const{filterLayers:e,view:t}=this,i=t?.map,{facilityLayer:s}=e,l={facilitiesInfo:[]};if(!s||!i?.floorInfo?.facilityLayer)return l;const r=s.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0,"type"in s&&"scene"===s.type&&(r.multipatchOption="xyFootprint");const{facilityIdField:n,siteIdField:o,nameField:a}=i.floorInfo.facilityLayer,h=await s.queryFeatures(r);if(h?.features?.length>0){const e=h.features,t=s?.fieldsIndex.get(n)?.name||n,i=s?.fieldsIndex.get(o)?.name||o,r=s?.fieldsIndex.get(a)?.name||a;t&&i&&r&&e.forEach((e=>{const s=e.attributes,n=e.geometry,o=s[t],a=s[i],h=s[r];o&&h&&l.facilitiesInfo.push({id:o,siteId:a,name:h,geometry:n})}))}return l}async _getLevels(){const{filterLayers:e,view:t}=this,i=t?.map,{levelLayer:s}=e,l={levelsInfo:[]};if(!s||!i?.floorInfo?.levelLayer)return l;const r=s.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0;const{levelIdField:n,facilityIdField:o,longNameField:a,shortNameField:h,levelNumberField:d,verticalOrderField:c}=i.floorInfo.levelLayer,u=await s.queryFeatures(r);if(u?.features?.length>0){const e=u.features,t=s?.fieldsIndex.get(n)?.name||n,i=s?.fieldsIndex.get(o)?.name||o,r=s?.fieldsIndex.get(a)?.name||a,v=s?.fieldsIndex.get(h)?.name||h,f=s?.fieldsIndex.get(d)?.name||d,m=s?.fieldsIndex.get(c)?.name||c;t&&i&&r&&v&&f&&m&&e.forEach((e=>{const s=e.attributes,n=s[t],o=s[i],a=s[r],h=s[v],d=s[f],c=s[m];n&&o&&a&&h&&"number"==typeof d&&"number"==typeof c&&l.levelsInfo.push({id:n,facilityId:o,longName:a,shortName:h,levelNumber:d,verticalOrder:c})}))}return l}_registerWidget(e){const t=e?.persistableViewModels.includes(this);t||e?.persistableViewModels.add(this)}_unregisterWidget(e){e?.persistableViewModels.remove(this)}_watchSearchResults(e){e?.on("select-result-floor",(e=>{const t=this.getLevel(e);t&&this.level!==e&&(this.level=e,this.setFloors(t))}))}async _setInitialViewState(e){if(this.view)try{await this.view.when(),await this._setFilterLayers();const t=await this._getFilterFeatures();if(!t)return;if(this.filterFeatures=t,!this.hasFacilities||!this.hasLevels)return void console.error("Facilities and Levels are required for the Floor Filter widget");if(this.hasMultipleSites||(this.filterMenuType="facility"),this.facility&&this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),t=this.getLevel(this.level);this.site||(this.site=e?.siteId||void 0),this.setFloors(t)}else if(this.facility&&!this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),t=this.getBaseLevel(e);this.site||(this.site=e?.siteId||void 0),this.level=t?.id||void 0,this.setFloors(t)}else if(!this.facility&&this.level){this.filterMenuType="facility";const e=this.getLevel(this.level),t=this.getFacility(e?.facilityId);this.facility=t?.id||void 0,this.site||(this.site=t?.siteId||void 0),this.setFloors(e)}else if(!this.site||this.facility||this.level){if(!e||!(0,m.r)(e))return void this.setFloors(null);const t=e?.widgets?.floorFilter;if(!t)return void this.setFloors(null);t.site&&!this.site&&(this.site=t.site,this.filterMenuType="facility"),this.setFloors(null)}else this.filterMenuType="site",this.setFloors(null)}catch(t){console.error("Couldn't retrieve sites, facilities, and levels",t)}}_callOverride(e,t){this._override(e,t)}async _updateFloorFilterFromMap(e){if(!e||!(0,m.r)(e))return;const t=e?.widgets?.floorFilter;t&&(this._isOverridden("enabled")||(this.enabled=t.enabled),this._isOverridden("longNames")||(this.longNames=t.longNames),this._isOverridden("minimized")||(this.minimized=t.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=t.pinnedLevels),this._isOverridden("site")||(this.site=t.site),this._isOverridden("facility")||(this.facility=t.facility),this._isOverridden("level")||(this.level=t.level))}_computeViewAllModeFloors(e){const{filterFeatures:t}=this;if(e.floorInfo?.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const{level:i,facility:s}=this,l=[];t.levels.levelsInfo.forEach((e=>{const{id:t,facilityId:r}=e;s&&r===s?i&&t===i&&l.push(t):l.push(t)})),e.floorInfo.viewAllLevelIds=new n.default(l)}}};(0,s._)([(0,c.MZ)({value:!1})],y.prototype,"enabled",null),(0,s._)([(0,c.MZ)({value:void 0})],y.prototype,"facility",null),(0,s._)([(0,c.MZ)({value:null})],y.prototype,"filterFeatures",null),(0,s._)([(0,c.MZ)({value:null})],y.prototype,"filterLayers",null),(0,s._)([(0,c.MZ)()],y.prototype,"filterMenuOpen",void 0),(0,s._)([(0,c.MZ)()],y.prototype,"filterMenuType",void 0),(0,s._)([(0,c.MZ)()],y.prototype,"filterMode",void 0),(0,s._)([(0,c.MZ)()],y.prototype,"hasFacilities",null),(0,s._)([(0,c.MZ)()],y.prototype,"hasLevels",null),(0,s._)([(0,c.MZ)()],y.prototype,"hasMultipleSites",null),(0,s._)([(0,c.MZ)({readOnly:!0})],y.prototype,"isNormalMode",null),(0,s._)([(0,c.MZ)({value:void 0})],y.prototype,"level",null),(0,s._)([(0,c.MZ)({value:!1})],y.prototype,"longNames",null),(0,s._)([(0,c.MZ)()],y.prototype,"levelsExpanded",void 0),(0,s._)([(0,c.MZ)({value:!1})],y.prototype,"minimized",null),(0,s._)([(0,c.MZ)({value:!1})],y.prototype,"pinnedLevels",null),(0,s._)([(0,c.MZ)()],y.prototype,"searchTerm",void 0),(0,s._)([(0,c.MZ)({value:void 0})],y.prototype,"site",null),(0,s._)([(0,c.MZ)({readOnly:!0})],y.prototype,"state",null),(0,s._)([(0,c.MZ)()],y.prototype,"view",void 0),(0,s._)([(0,c.MZ)()],y.prototype,"_viewHeightBreakpoint",void 0),(0,s._)([(0,c.MZ)()],y.prototype,"_viewWidthBreakpoint",void 0),(0,s._)([(0,c.MZ)()],y.prototype,"updateWebDocument",null),y=(0,s._)([(0,u.$)("esri.widgets.FloorFilter.FloorFilterViewModel")],y);const _=y}}]);