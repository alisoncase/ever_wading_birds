"use strict";(self.webpackChunkever_wading_birds=self.webpackChunkever_wading_birds||[]).push([[87176,88317,89501],{9093:(e,t,i)=>{i.d(t,{A:()=>I});var a=i(93800),o=i(79625),r=i(6946),s=i(58828),n=i(89129),l=i(17741),d=i(49959),c=i(79953),u=i(14125),p=i(48602),h=(i(21265),i(50925),i(14746),i(75269)),y=i(15492),w=i(9674),f=i(78076),g=i(92471),m=i(98461),_=i(12130),v=i(88317),k=i(48362);function b(e){return new v.default({fromNetworkElement:M(e.fromFeature,e.utilityNetwork),toNetworkElement:M(e.toFeature,e.utilityNetwork),associationType:e.associationType,globalId:(0,_.yS)()})}function M(e,t){const i=(0,f.Sv)(e.sourceLayer)?e.sourceLayer.parent:e.sourceLayer;if(i&&"globalIdField"in i&&"layerId"in i&&i.globalIdField){const a=t.getSourceIdByLayerId(i.layerId),o="junction"===t.getSourceTypeById(a)?t.getTerminalConfiguration(e):void 0,r=o?.terminals.at(0)?.id,s=i.fieldsIndex.get("assetGroup").name,n=i.fieldsIndex.get("assetType").name,l=e.attributes[s],d=e.attributes[n],c=e.attributes[i.globalIdField];if(c&&null!=a)return new k.default({globalId:c,networkSourceId:a,assetGroupCode:l,assetTypeCode:d,terminalId:r})}}var A=i(39652);const F="association-key";let C=class extends r.default{constructor(e){super(e),this.graphic=null,this.layer=null,this.map=null,this.utilityNetwork=null,this.associationType=null,this.featureCount=0,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=30,this.selectedFeature=null,this.association=null,this.filterOptionsVisible=!1,this.filterWhereClause=null,this._rulesTable=null,this._canAssociate=!1,this._whereClause=null,this._setUpItemsTask=null,this._updatingHandlesSetUp=new y.U,this._queryFeaturesTask=null,this._updatingHandlesQueryFeatures=new y.U,this._validateAssociationTask=null,this._updatingHandlesAssociation=new y.U,this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await(0,d.ignoreAbortErrors)(this._query()).catch((()=>this._cancelQuery())),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async e=>{this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await(0,d.ignoreAbortErrors)(this._queryFeatureCount(e)).catch((()=>this._cancelQueryFeatureCount())),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null)},this._queryPageController=async()=>{const e=new AbortController;this._queryPageAbortController=e,await(0,d.ignoreAbortErrors)(this._queryPage()).catch((()=>this._cancelQueryPage())),this._queryPageAbortController===e&&(this._queryPageAbortController=null)},this._queryDebounced=(0,d.debounce)(this._queryController,100),this._queryFeatureCountDebounced=(0,d.debounce)(this._queryFeatureCountController,100),this._queryPageDebounced=(0,d.debounce)(this._queryPageController,100)}initialize(){this.addHandles([(0,c.watch)((()=>[this.graphic,this.layer,this.map,this.utilityNetwork,this.globalId,this.associationType]),(()=>this._syncLayerItems()),c.initial),(0,c.watch)((()=>[this.selectedLayer,this.filterWhereClause,this.featuresPerPage]),(()=>{this.selectedLayer&&this._setUpFeatures()})),(0,c.watch)((()=>this.selectedFeature),(()=>{this._setUpAssociation()})),(0,c.watch)((()=>this.featurePage),(()=>this._queryPageDebounced()))])}destroy(){this._setUpItemsTask=(0,l.DC)(this._setUpItemsTask),this._updatingHandlesSetUp.destroy(),this._queryFeaturesTask=(0,l.DC)(this._queryFeaturesTask),this._updatingHandlesQueryFeatures.destroy(),this._validateAssociationTask=(0,l.DC)(this._validateAssociationTask),this._updatingHandlesAssociation.destroy(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}get mapLayers(){const{map:e}=this;if(!e)return null;const t=new Set,i=e=>{!(0,g.isAssociatedFeatureSupportedLayer)(e)||(0,f.F2)(e)||t.has(e)||t.add(e)},a=e=>{(0,w.isLayerFromCatalog)(e)||"catalog-footprint"===e.type||((0,f.cM)(e)?(e.layers?.forEach(i),e.tables?.forEach(i)):(0,m.pJ)(e)?(e.sublayers?.forEach(i),e.subtables?.forEach(i)):(0,f.F2)(e)?e.sublayers?.forEach(i):i(e))};return e.allLayers.forEach(a),e.allTables.forEach(a),new n.default([...t])}get state(){const{_queryAbortController:e,_queryPageAbortController:t,canQuery:i}=this;return e||t||this._updatingHandlesQueryFeatures.updating?"querying":this.canLoad&&this._updatingHandlesSetUp.updating?"loading":this._updatingHandlesAssociation.updating?"validating":i?"ready":"disabled"}get canAddAssociation(){return!(this.updating||!this.association)&&this._canAssociate}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){const{layer:e}=this;return e?.globalIdField??null}get layerItems(){return this._get("layerItems")||new n.default}get featureItems(){return this._get("featureItems")||new n.default}set featurePage(e){const{featuresPerPage:t,featureCount:i}=this,a=Math.ceil(i/t)||1;this._set("featurePage",Math.min(Math.max(e,1),a))}get featurePage(){return this._get("featurePage")}get canLoad(){const{map:e,utilityNetwork:t,graphic:i,associationType:a}=this;return!!(e&&t&&i&&a)}get canQuery(){const{utilityNetwork:e,graphic:t,associationType:i,selectedLayer:a}=this;return!!(e&&t&&i&&a)}get updating(){return this._updatingHandlesSetUp.updating||this._updatingHandlesAssociation.updating}get selectedLayer(){return this._get("selectedLayer")}set selectedLayer(e){e!==this.selectedLayer&&(this.filterWhereClause=null),this._set("selectedLayer",e)}get queryWhereClause(){const{_whereClause:e,filterWhereClause:t}=this;return(0,u.sqlAnd)(e,t)}async _queryFeatureCount(e){const{selectedLayer:t,_queryFeatureCountAbortController:i}=this;if(this._set("featureCount",0),!t)return;await t.load();const a=t.createQuery();a.returnGeometry=!1,a.where=(0,u.sqlAnd)(a.where,e);const o=await t.queryFeatureCount(a,{signal:i?.signal});o>0&&this._set("featureCount",o)}async _query(){const{canQuery:e,queryWhereClause:t,_queryAbortController:i,featureItems:a}=this;e&&(this.featurePage=1,a.destroyAll(),this.featureCount&&!this.destroyed&&a.addMany(await this._queryAssociatedFeatures(t,{signal:i?.signal})))}async _queryPage(){const{canQuery:e,queryWhereClause:t,featurePage:i,_queryPageAbortController:a,featureCount:o,featureItems:r}=this;e&&(i<2||!o||r.addMany(await this._queryAssociatedFeatures(t,{signal:a?.signal})))}_convertTypeToDirection(e){switch(e){case"attachment":return[{type:"attachment",direction:"from"}];case"connectivity":return[{type:"junction-junction-connectivity"},{type:"junction-edge-from-connectivity"},{type:"junction-edge-midspan-connectivity"},{type:"junction-edge-to-connectivity"}];case"container":return[{type:"containment",direction:"to"}];case"content":return[{type:"containment",direction:"from"}];case"structure":return[{type:"attachment",direction:"to"}]}}async getRulesTable(){const{utilityNetwork:e}=this;if(!e)return null;if(this._rulesTable)return this._rulesTable;const t=await e.getRulesTable();return await(t?.load()),this._rulesTable=t,t}async _syncLayerItems(){(0,l.DC)(this._setUpItemsTask);const{graphic:e,associationType:t,layerItems:i,canLoad:a}=this,o=(0,s.UT)((async o=>{if(this.selectedLayer=null,i.destroyAll(),!a)return;const r=this.mapLayers?.toArray();if(!r)return;if(o.aborted)return;const s=await this.getRulesTable(),n=this._convertTypeToDirection(t.type),l=s?.getLayersCanAssociateWith(e,r,n);o.aborted||i.addMany(l||[])}));this._updatingHandlesSetUp.addPromise(o.promise),this._setUpItemsTask=o}async _setUpFeatures(){(0,l.DC)(this._queryFeaturesTask);const{graphic:e,associationType:t,selectedLayer:i,canQuery:a}=this;if(!a)return;const o=(0,s.UT)((async a=>{const o=await this.getRulesTable(),r=this._convertTypeToDirection(t.type),s=o?.getFeaturesCanAssociateWithClause(e,i,r);this._whereClause=s,a.aborted||(await this._queryFeatureCountDebounced(this.queryWhereClause),await this._queryDebounced())}));this._updatingHandlesQueryFeatures.addPromise(o.promise),this._queryFeaturesTask=o}_determineFromAndTo(e,t,i){return"from"===i?{fromFeature:e,toFeature:t}:{fromFeature:t,toFeature:e}}_determineJunctionEdgeConnectivity(e,t){const{utilityNetwork:i}=this,a=(0,f.Sv)(e.sourceLayer)?e.sourceLayer.parent:e.sourceLayer,o=(0,f.Sv)(t.sourceLayer)?t.sourceLayer.parent:t.sourceLayer;if(!(i&&a&&"layerId"in a&&o&&"layerId"in o))return{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"};const r=i.getSourceIdByLayerId(a.layerId),s=i.getSourceIdByLayerId(o.layerId);if(!r||!s)return{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"};const n="junction"===i.getSourceTypeById(r),l="junction"===i.getSourceTypeById(s);return n&&l?{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"}:l?{fromFeature:t,toFeature:e,type:"junction-edge-midspan-connectivity"}:{fromFeature:e,toFeature:t,type:"junction-edge-midspan-connectivity"}}_setUpAssociationHandles(){this.removeHandles(F),this.association&&this.addHandles((0,c.watch)((()=>[this.association?.associationType,this.association?.fromNetworkElement,this.association?.fromNetworkElement?.terminalId,this.association?.toNetworkElement,this.association?.toNetworkElement?.terminalId]),(()=>this.validateAssociation()),c.initial),F)}_setUpAssociation(){const{utilityNetwork:e,graphic:t,selectedFeature:i,associationType:a}=this;if(!(e&&t&&i&&a))return void(this.association=null);const o=this._convertTypeToDirection(a.type);if(o.length>1){const{fromFeature:a,toFeature:o,type:r}=this._determineJunctionEdgeConnectivity(t,i.feature);return this.association=b({fromFeature:a,toFeature:o,utilityNetwork:e,associationType:r}),void this._setUpAssociationHandles()}const{fromFeature:r,toFeature:s}=this._determineFromAndTo(t,i.feature,o[0].direction);this.association=b({fromFeature:r,toFeature:s,utilityNetwork:e,associationType:o[0].type}),this._setUpAssociationHandles()}async _processFeatures(e){return Promise.all(e.map((async e=>{const{sourceLayer:t}=e;return t&&"getFeatureTitle"in t?{label:await t.getFeatureTitle(e),feature:e}:{label:(0,A.R)(e),feature:e}})))}async _queryAssociatedFeatures(e,t){const{featuresPerPage:i,layer:a,featurePage:o,featureCount:r,selectedLayer:s}=this,{canQuery:n,globalId:l}=this;if(!n||!a||!s||null==l)return[];const d=((o-1)*i+r)%r,c=i,{historicMoment:p,gdbVersion:h}=s,y=s.createQuery();y.where=(0,u.sqlAnd)(y.where,e),y.start=d,y.num=c,y.returnGeometry=!1,y.historicMoment=p,y.gdbVersion=h,y.outFields=["*"];const w=await s.queryFeatures(y,{signal:t?.signal});return await this._processFeatures(w.features)}validateAssociation(){(0,l.DC)(this._validateAssociationTask);const{utilityNetwork:e,association:t}=this,i=(0,s.UT)((async()=>{e&&t&&(this._canAssociate=await e.canAddAssociation(t))}));this._updatingHandlesAssociation.addPromise(i.promise),this._validateAssociationTask=i}};(0,a._)([(0,p.MZ)({type:o.default})],C.prototype,"graphic",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"layer",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"map",void 0),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"mapLayers",null),(0,a._)([(0,p.MZ)()],C.prototype,"utilityNetwork",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"associationType",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"state",null),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"canAddAssociation",null),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"globalId",null),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"globalIdField",null),(0,a._)([(0,p.MZ)()],C.prototype,"featureCount",void 0),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"layerItems",null),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"featureItems",null),(0,a._)([(0,p.MZ)()],C.prototype,"_queryAbortController",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"_queryPageAbortController",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"_queryFeatureCountAbortController",void 0),(0,a._)([(0,p.MZ)({value:1})],C.prototype,"featurePage",null),(0,a._)([(0,p.MZ)()],C.prototype,"featuresPerPage",void 0),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"canLoad",null),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"canQuery",null),(0,a._)([(0,p.MZ)({readOnly:!0})],C.prototype,"updating",null),(0,a._)([(0,p.MZ)()],C.prototype,"selectedLayer",null),(0,a._)([(0,p.MZ)()],C.prototype,"selectedFeature",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"association",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"filterOptionsVisible",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"filterWhereClause",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"queryWhereClause",null),(0,a._)([(0,p.MZ)()],C.prototype,"_rulesTable",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"_canAssociate",void 0),(0,a._)([(0,p.MZ)()],C.prototype,"_whereClause",void 0),C=(0,a._)([(0,h.$)("esri.widgets.FeatureForm.UtilityNetworkAssociationAddAssociationViewModel")],C);const I=C},54057:(e,t,i)=>{function a(e){return null!=e&&"object"==typeof e&&"type"in e&&null!==e.type&&("column"===e.type||"field"===e.type||"group"===e.type||"attachment"===e.type||"relationship"===e.type)}function o(e){return!(!e||!("field"in e))}function r(e){return!(!e||!("columns"in e))}function s(e){return!(!e||!("relationshipId"in e))}function n(e){return!(!e||!("onShowAttachments"in e))}i.d(t,{CE:()=>a,DU:()=>n,Ie:()=>r,JY:()=>o,Lv:()=>s})},81069:(e,t,i)=>{i.r(t),i.d(t,{createFeatureServices:()=>s});var a=i(65073),o=i(46707);const r=(e,t)=>{for(const i of e)if("feature"===i.type||"subtype-group"===i.type){if(!i.url)continue;const e=(0,a.qg)(i.url).url.path,r=t.get(e);if(r)r.layers.push(i);else{const a=new o.default({url:e}),r=[i];t.set(e,{featureService:a,layers:r})}}else"group"===i.type&&r(i.layers.filter((e=>"feature"===e.type||"subtype-group"===e.type||"group"===e.type)),t)};function s(e){const t=new Map;return r(e,t),t}},87176:(e,t,i)=>{i.r(t),i.d(t,{default:()=>se});var a,o=i(93800),r=i(79625),s=i(74719),n=i(42198),l=i(50925),d=i(17741),c=i(49959),u=i(83626),p=i(79953),h=i(35920),y=i(48602),w=(i(21265),i(14746),i(75269)),f=i(5172),g=i(78076),m=i(81069),_=i(68947),v=i(51232),k=i(91690),b=i(50330),M=i(6946);let A=a=class extends M.default{constructor(e){super(e),this.editorItem=null,this.feature=null,this.utilityNetwork=null,this.associationType=null,this.parent=null,this.associationInput=null,this.viewModel=null}static async create(e){const{feature:t,parent:i,viewModel:o,utilityNetwork:r,associationType:n,associationInput:l}=e,d=o.editorItems.find((e=>e.layer===t.layer));if(!d)throw new s.default("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return new a({editorItem:d,feature:t,parent:i,viewModel:o,utilityNetwork:r,associationType:n,associationInput:l})}};(0,o._)([(0,y.MZ)({constructOnly:!0})],A.prototype,"editorItem",void 0),(0,o._)([(0,y.MZ)()],A.prototype,"feature",void 0),(0,o._)([(0,y.MZ)({constructOnly:!0})],A.prototype,"utilityNetwork",void 0),(0,o._)([(0,y.MZ)({constructOnly:!0})],A.prototype,"associationType",void 0),(0,o._)([(0,y.MZ)()],A.prototype,"parent",void 0),(0,o._)([(0,y.MZ)()],A.prototype,"associationInput",void 0),(0,o._)([(0,y.MZ)()],A.prototype,"viewModel",void 0),A=a=(0,o._)([(0,w.$)("esri.widgets.Editor.AddAssociationWorkflowData")],A);const F=A;var C,I=i(53856),S=i(39262),T=i(9093),Z=i(39652);const E={exit:Symbol()};let V=C=class extends I.default{constructor(e){super(e),this._utilityNetworkAssociationAddAssociationViewModel=new T.A,this._highlightHelper=null,this.sourceFeatureItem=null,this.type="add-association"}initialize(){const{data:e}=this,{view:t}=e.viewModel;t&&(this._highlightHelper=new _.A({view:t,highlightName:b.n4}),this.addHandles((0,n.hA)((()=>this._highlightHelper?.removeAll()))));const i=new AbortController;this.addHandles((0,n.rE)(i)),this._updatingHandles.addPromise(this._setup(i))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get utilityNetworkAssociationAddAssociationViewModel(){return this._utilityNetworkAssociationAddAssociationViewModel}get hasPendingEdits(){return!!this._utilityNetworkAssociationAddAssociationViewModel.selectedFeature}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get reliesOnOwnerAdminPrivileges(){return this.editorItem.capabilities.create.reliesOnOwnerAdminPrivileges}async enter(){this._initializeUtilityNetworkAssociationAddAssociationViewModel()}exit(){this.removeHandles(E.exit)}async start(){return await super.start(),null}async _setup(e){const{data:t}=this,{feature:i}=t;try{const a=await(0,S.mU)(i,t.viewModel.view.spatialReference,e.signal);if((0,c.isAborted)(e))return;const o=a.sourceLayer&&"getFeatureTitle"in a.sourceLayer?await a.sourceLayer.getFeatureTitle(a):(0,Z.R)(a);if((0,c.isAborted)(e))return;this.sourceFeatureItem={feature:i,label:o},this._initializeUtilityNetworkAssociationAddAssociationViewModel()}catch(a){this.cancel({force:!0,error:new s.default("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:a}})})}}_initializeUtilityNetworkAssociationAddAssociationViewModel(){const{viewModel:{view:e},utilityNetwork:t,associationType:i}=this.data,a=this._utilityNetworkAssociationAddAssociationViewModel;a.graphic=this.sourceFeatureItem.feature,a.map=e?.map,a.utilityNetwork=t,a.layer=this.layer,a.associationType=i,t.networkSystemLayers.loadAssociationsTable(),this.addHandles([(0,p.watch)((()=>a.selectedLayer),(e=>{e&&this.go("add-association-select-feature")})),(0,p.watch)((()=>a.selectedFeature),(e=>{e&&this.go("add-association-create-association")}))],E.exit)}static async create(e){const t=new C({data:await F.create(e),onCommit:this._onCommitFactory(e.applyEditsFeatureService)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){return[{id:"add-association-select-layer",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedLayer=null,t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-select-feature",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-create-association",async setUp(){},async tearDown(){}}]}};V._onCommitFactory=e=>async t=>{const{feature:i,utilityNetwork:a,associationInput:o}=t,{utilityNetworkAssociationAddAssociationViewModel:r}=t.viewModel,{association:n}=r;await a.networkSystemLayers.loadAssociationsTable();const l=a?.generateAddAssociations([n]);if(!l)throw new s.default("editor:failed-to-add-association","Could not create payload needed to add association");const d=i.sourceLayer,c=(0,g.Sv)(d)&&d.parent?d.parent:d,u=(0,m.createFeatureServices)([c]),p=u.values().next().value?.featureService;if(!p)throw new s.default("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");await(p?.load());const h=a?.gdbVersion??void 0;await e(p,[l],{gdbVersion:h}),await o.refresh()},(0,o._)([(0,y.MZ)()],V.prototype,"_utilityNetworkAssociationAddAssociationViewModel",void 0),(0,o._)([(0,y.MZ)()],V.prototype,"_featureFormViewModel",void 0),(0,o._)([(0,y.MZ)()],V.prototype,"editorItem",null),(0,o._)([(0,y.MZ)()],V.prototype,"featureFormViewModel",null),(0,o._)([(0,y.MZ)()],V.prototype,"utilityNetworkAssociationAddAssociationViewModel",null),(0,o._)([(0,y.MZ)()],V.prototype,"sourceFeatureItem",void 0),(0,o._)([(0,y.MZ)()],V.prototype,"hasPendingEdits",null),(0,o._)([(0,y.MZ)()],V.prototype,"layer",null),(0,o._)([(0,y.MZ)()],V.prototype,"parent",null),(0,o._)([(0,y.MZ)()],V.prototype,"parentLayer",null),(0,o._)([(0,y.MZ)()],V.prototype,"reliesOnOwnerAdminPrivileges",null),V=C=(0,o._)([(0,w.$)("esri.widgets.Editor.AddAssociationWorkflow")],V);var W,N=i(72787),P=i(70674),L=i(41317),q=i(19983),H=i(17508);let U=W=class extends M.default{constructor(e){super(e),this.association=null,this.editorItem=null,this.edits=null,this.parent=null,this.featureFormCallbacks=null,this.viewModel=null}get attachmentsCapabilities(){const e=this.editorItem.capabilities.update.attachments.enabled;return{editing:!0,operations:{add:e,update:e,delete:e}}}get formTemplate(){return this.editorItem.formTemplate}static async create(e){const t=W._makeConstructorProps(e);return new W(t)}static _makeConstructorProps(e){const{association:t,feature:i,parent:a,featureFormCallbacks:o,viewModel:r}=e,n=r.editorItems.find((e=>e.layer===i.layer));if(!n)throw new s.default("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return{association:t,editorItem:n,edits:new H.default({feature:i}),parent:a,featureFormCallbacks:o,viewModel:r}}};(0,o._)([(0,y.MZ)()],U.prototype,"association",void 0),(0,o._)([(0,y.MZ)()],U.prototype,"attachmentsCapabilities",null),(0,o._)([(0,y.MZ)({constructOnly:!0})],U.prototype,"editorItem",void 0),(0,o._)([(0,y.MZ)()],U.prototype,"edits",void 0),(0,o._)([(0,y.MZ)()],U.prototype,"formTemplate",null),(0,o._)([(0,y.MZ)()],U.prototype,"parent",void 0),(0,o._)([(0,y.MZ)()],U.prototype,"featureFormCallbacks",void 0),(0,o._)([(0,y.MZ)()],U.prototype,"viewModel",void 0),U=W=(0,o._)([(0,w.$)("esri.widgets.Editor.UpdateRecordWorkflowData")],U);const O=U;var D;let x=D=class extends O{constructor(e){super(e),this.sketchOptions=null,this.snappingManager=null}static async create(e){const{feature:t,snappingManager:i,viewModel:a}=e,o=e.sketchOptions??new k.A,{view:r}=a;if(!r)throw new s.default("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const n=await(0,S.QZ)(r,t.layer);return new D({...D._makeConstructorProps(e),layerView:n,sketchOptions:o,snappingManager:i})}};(0,o._)([(0,y.MZ)()],x.prototype,"layerView",void 0),(0,o._)([(0,y.MZ)({constructOnly:!0})],x.prototype,"sketchOptions",void 0),(0,o._)([(0,y.MZ)()],x.prototype,"snappingManager",void 0),x=D=(0,o._)([(0,w.$)("esri.widgets.Editor.UpdateFeatureWorkflowData")],x);const R=x;var j,G=i(94495);const Q={exit:Symbol()};let z=j=class extends I.default{constructor(e){super(e),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:e}=this,{edits:t}=e,{view:i}=e.viewModel,a=t.feature;i&&(this._highlightHelper=new _.A({view:i,highlightName:b.n4}),this.addHandles((0,n.hA)((()=>this._highlightHelper?.removeAll()))));const o=new AbortController;this.addHandles((0,n.rE)(o)),this._updatingHandles.addPromise((0,S.mU)(a,e.viewModel.view.spatialReference,o.signal).then((e=>{(0,c.isAborted)(o)||(this._onFullFeatureLoaded(e),this._initializeFeatureFormViewModel())}),(e=>this.cancel({force:!0,error:new s.default("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:e}})}))))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get shouldShowAttachments(){return this.editorItem.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return this.editorItem.capabilities.update.attachments.enabled}get reliesOnOwnerAdminPrivileges(){const e=this.editorItem.capabilities;return e.update.reliesOnOwnerAdminPrivileges||e.delete.reliesOnOwnerAdminPrivileges}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel()}exit(e){this.removeHandles(Q.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:e,fullFeature:t}=this,{attachmentsCapabilities:i,viewModel:a}=e,{attachmentsViewModel:o}=a;o.set({capabilities:i,graphic:t,filesEnabled:!1,mode:"view"}),this.addHandles([(0,n.hA)((()=>o.fileInfos.removeAll())),(0,p.watch)((()=>o.mode),(e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}))],Q.exit)}_initializeFeatureFormViewModel(){const{association:e,edits:t,formTemplate:i,viewModel:{view:a}}=this.data,o=this._featureFormViewModel=new G.default({activeAssociation:e,arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:i,highlightHelper:this._highlightHelper,map:a?.map,spatialReference:a.spatialReference,timeZone:a?.timeZone});o.callbacks={...this.data.featureFormCallbacks,showAllRelatedRecords:e=>o.relationshipId=e.relationshipId,viewAssociatedLayers:e=>o.associationId=e.associationId,viewAssociatedFeatures:e=>o.associatedLayer=e.associatedLayer};const{initialFeature:r}=t;r&&o.overrideInitialFeature(r),this.addHandles([o.on("value-change",(()=>{t.updateAttributes(o.getValues()),this.fullFeature.attributes=t.feature.attributes})),(0,p.watch)((()=>a?.timeZone),(e=>o.timeZone=e))])}_onFullFeatureLoaded(e){this.fullFeature=e;const{edits:t}=this.data;t.updateAttributes(e.attributes),t.trackChanges()}static async create(e){const t=new j({data:await O.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){const{attachmentsViewModel:t}=e.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){t.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){t.mode="view"}}]}};z._onCommitFactory=e=>async t=>{const{edits:i}=t,{feature:a}=i;if(!a)return;const o=a.sourceLayer,r=a.clone();if(!i.attributesModified||i.stagedForDelete){const e=o.objectIdField;if(r.attributes={[e]:a.getAttribute(e)},"scene"===o.type&&null!=o.infoFor3D){const e=o.associatedLayer?.globalIdField;null!=e&&r.setAttribute(e,a.getAttribute(e))}}i.geometryModified&&!i.stagedForDelete||(r.geometry=null);const s=i.stagedForDelete?"deleteFeatures":"updateFeatures";await e(o,{[s]:[r]})},(0,o._)([(0,y.MZ)()],z.prototype,"_featureFormViewModel",void 0),(0,o._)([(0,y.MZ)()],z.prototype,"editorItem",null),(0,o._)([(0,y.MZ)()],z.prototype,"featureFormViewModel",null),(0,o._)([(0,y.MZ)()],z.prototype,"fullFeature",void 0),(0,o._)([(0,y.MZ)()],z.prototype,"hasPendingEdits",null),(0,o._)([(0,y.MZ)()],z.prototype,"layer",null),(0,o._)([(0,y.MZ)()],z.prototype,"parent",null),(0,o._)([(0,y.MZ)()],z.prototype,"parentLayer",null),(0,o._)([(0,y.MZ)()],z.prototype,"shouldShowAttachments",null),(0,o._)([(0,y.MZ)()],z.prototype,"shouldAllowAttachmentEditing",null),(0,o._)([(0,y.MZ)()],z.prototype,"reliesOnOwnerAdminPrivileges",null),z=j=(0,o._)([(0,w.$)("esri.widgets.Editor.UpdateRecordWorkflow")],z);var $,B=i(17577);const J={...Q,highlights:Symbol(),sketchGraphics:Symbol(),sketchViewModel:Symbol(),waitingForTool:Symbol()};let K=$=class extends z{constructor(e){super(e),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._sketchViewModel=null,this._webStyleCache=new Map}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles(J.sketchGraphics);try{const e=this.data.edits.stagedForDelete;await super.commit();const t=this._layerViewEditSession;e?t?.rollback():t?.commit()}catch(e){throw await this._configureSketchViewModel(),new s.default("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:e})}}async start(){return await super.start(),await this._initializeSketchViewModel()}_initializeFeatureFormViewModel(){super._initializeFeatureFormViewModel(),this.addHandles([this._featureFormViewModel.on("value-change",(e=>{this._layerViewEditSession?.setAttribute(e.fieldName,e.value)})),(0,p.watch)((()=>this._featureFormViewModel.feature?.sourceLayer),(e=>this._sketchGraphicClone.sourceLayer=e))])}_configureHighlight(){const{edits:e,layerView:t}=this.data;(0,q.Of)(t)&&this.addHandles(t.highlight(e.feature),J.highlights)}async _configureSketchViewModel(){const e=this._sketchViewModel;if(!e)return;const{data:t,_featureFormViewModel:i,_sketchGraphicClone:a}=this,{edits:o,viewModel:r}=t,s=o.feature,{view:n}=r,l=(0,S.EO)(s),d=await(0,S.vM)({feature:s,featureClone:a,visualVariableAttributes:l,sketchViewModel:e,view:n,onUpdate:(e,t)=>{let{geometry:a,attributes:r}=e;if(o.updateAttributes(r),o.updateGeometry(a),i.feature&&(i.feature.geometry=a),null!=l.rotation){const{field:e}=l.rotation;i.setValue(e,r[e])}if(null!=l.size){const{field:e}=l.size;i.setValue(e,r[e])}("undo"===t.type||"redo"===t.type||"update"===t.type&&null!=t.toolEventInfo&&(0,S.Ks)(t.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()},addUpdatingPromise:e=>{this._updatingHandles.addPromise(e)},addHandle:e=>{this.addHandles(e,J.waitingForTool)},webStyleCache:this._webStyleCache});this.addHandles(d,J.sketchGraphics),e.addHandles(d)}async _initializeSketchViewModel(){const{data:e,_sketchGraphicClone:t}=this,i=e.edits.feature,{capabilities:a,layer:o}=e.editorItem,{view:r}=e.viewModel;if(this.removeHandles([J.highlights,J.sketchGraphics,J.sketchViewModel,J.waitingForTool]),!a.update.geometry||"3d"===r?.type&&(0,L.wz)(o.elevationInfo))return{enter:async()=>{this.hasHandles(J.highlights)||this._configureHighlight()},exit:()=>this.removeHandles([J.highlights])};const s=new P.default({elevationInfo:o.elevationInfo,internal:!0,listMode:"hide"}),l=new B.default({allowDeleteKey:!1,layer:s,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:r});return this._sketchViewModel=l,r?.map.add(s),this.addHandles((0,n.hA)((()=>{r?.destroyed||r?.map.remove(s),s.destroy(),this._sketchViewModel=(0,d.pR)(l)})),J.sketchViewModel),await(0,S.FC)(t,this._webStyleCache,"2d"===r?.type?r.scale:null),this.addHandles([await(0,S.z7)(l,i,t)]),{enter:async()=>{this.hasHandles(J.sketchGraphics)||await this._configureSketchViewModel()},exit:()=>this.removeHandles([J.sketchGraphics]),viewModel:l}}_onFullFeatureLoaded(e){super._onFullFeatureLoaded(e);const t=this._sketchGraphicClone=(0,S.ON)(e),{edits:i,layerView:a}=this.data;i.updateGeometry(e.geometry),i.trackChanges(),(0,S.nv)(a)&&(this._layerViewEditSession=a.createInteractiveEditSession(t))}static async create(e){const t=new $({data:await R.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}get test(){}};(0,o._)([(0,y.MZ)()],K.prototype,"_layerViewEditSession",void 0),(0,o._)([(0,y.MZ)()],K.prototype,"_sketchGraphicClone",void 0),(0,o._)([(0,y.MZ)()],K.prototype,"_sketchViewModel",void 0),K=$=(0,o._)([(0,w.$)("esri.widgets.Editor.UpdateFeatureWorkflow")],K);var X,Y=i(89501),ee=i(92471);const te="esri.widgets.Editor.UpdateWorkflow";let ie=X=class extends I.default{constructor(e){super(e),this._workflowStack=new u.A(h.HV),this._sketchStack=new u.A(h.HV),this.data=void 0,this.type="update"}destroy(){this._drainWorkflowStack((e=>e.cancel({force:!0})))}get activeEditorItem(){return this.activeWorkflow?.data.editorItem??void 0}get activeFeatureFormViewModel(){return this.activeWorkflow?.featureFormViewModel}get activeUtilityNetworkAssociationAddAssociationViewModel(){return"add-association"===this.activeWorkflow?.type?this.activeWorkflow.utilityNetworkAssociationAddAssociationViewModel:null}get activeSketchViewModel(){return this._sketchStack.peek()?.viewModel}get canDeleteAssociation(){const{activeFeatureFormViewModel:e}=this;if(!this.activeWorkflow||!this.data.viewModel.view?.map||!e)return!1;const{activeAssociation:t,feature:i}=e;return!(!t||!i?.sourceLayer||!(0,g.yZ)(i?.sourceLayer)&&!(0,g.Sv)(i?.sourceLayer))}get activeWorkflow(){return this._workflowStack.last()}get updating(){return this._updatingHandles.updating||!!this.activeWorkflow?.updating}get hasPreviousStep(){const e=this.activeWorkflow?.featureFormViewModel;return this._stepIndex>0||this.nestedWorkflowCount>1||null!=e?.relationshipId||"view"!==this.data.viewModel.attachmentsViewModel.mode||null!=e?.associationId||null!=e?.associatedLayer}get hasUpdatableCandidates(){const{candidates:e,viewModel:t}=this.data;return e.some((e=>{let{layer:i}=e;return t.findEditorItemForLayer(i)?.supportsUpdateWorkflow}))}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditorItem?.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return!!this.activeEditorItem?.capabilities.update.attachments.enabled}get hasPendingEdits(){return Array.from(this._workflowStack).some((e=>e.hasPendingEdits))}get helpMessage(){return this.activeWorkflow?.helpMessage?this.activeWorkflow.helpMessage:"awaiting-feature-to-update"===this.stepId?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditorItem?.hasInvalidFormTemplate}async back(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:()=>Promise.resolve(!0);const{activeWorkflow:t}=this,i=t?.featureFormViewModel;if(i?.activeRelationshipInput){const e=i.activeRelationshipInput;if(e.activeCategory)return void(e.activeCategory=null);if(null!=i.relationshipId)return void(i.relationshipId=null);if(e.showAllEnabled)return void(e.showAllEnabled=!1)}if("add-association"===t?.type){const{activeUtilityNetworkAssociationAddAssociationViewModel:e}=this;if(e?.filterOptionsVisible)return void(e.filterOptionsVisible=!1)}if(null==i?.associatedLayer)if(null==i?.associationId)if("create-features"===t?.type&&t.hasPreviousStep)await t.previous({cancelCurrentStep:!0});else if(t){if(t.hasPendingEdits&&!await e())return;t.hasPreviousStep?await t.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else i.associationId=null;else i.associatedLayer=null}async cancelActiveWorkflow(e){await(this.activeWorkflow?.cancel(e)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack((e=>e.commit())),await super.commit()}static create(e){const{viewModel:t,snappingManager:i,startAt:a,addAttachmentsCallback:o,applyEditsCallback:r,applyEditsFeatureServiceCallback:s}=e,n=e.sketchOptions??new k.A,l=new X({data:new Y.default({addAttachmentsCallback:o,applyEditsCallback:r,applyEditsFeatureServiceCallback:s,sketchOptions:n,snappingManager:i,viewModel:t}),onCommit:async()=>{}});return l._set("steps",this._createWorkflowSteps(l,a)),l}async save(){this.nestedWorkflowCount>1?(await(this.activeWorkflow?.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(e){try{const t=await this._createNestedCreateFeaturesWorkflow(e);await this._pushWorkflow(t)}catch(t){throw new s.default("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(e,t){try{const i=await this._createNestedUpdateWorkflow(e,t);await this._pushWorkflow(i)}catch(i){throw new s.default("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:i})}}async startAddAssociation(e,t,i){try{const a=await this._createNestedAddAssociationWorkflow(e,t,i);await this._pushWorkflow(a)}catch(a){throw new s.default("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:a})}}async deleteActiveFeature(){const{activeWorkflow:e}=this;if(!e)throw new s.default("editor:nothing-to-delete","There is no feature to delete");re(e)?await e.deleteAndCommit():await e.cancel(),1===this.nestedWorkflowCount?await this.reset():(await this._popWorkflow(),await this._returnToPageWithContent())}async deleteActiveAssociation(){if(!this.canDeleteAssociation)throw new s.default("editor:nothing-to-delete","There is no association to delete");await this._deleteActiveAssociation(),await this._popWorkflow(),await this._returnToPageWithContent()}async cancelAll(){await this._drainWorkflowStack((e=>e.cancel({force:!0})))}async _deleteActiveAssociation(){const{activeFeatureFormViewModel:e,data:t}=this,{activeAssociation:i,feature:a}=e,{applyEditsFeatureServiceCallback:o,viewModel:r}=t,{sourceLayer:n}=a,l=(0,g.Sv)(n)&&n.parent?n.parent:n,d=(0,m.createFeatureServices)([l]),c=d.values().next().value?.featureService;if(!c)throw new s.default("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");await(c?.load());const u=r.view.map,p=(0,ee.findUtilityNetwork)(u,l);await(p?.networkSystemLayers.loadAssociationsTable());const h=p?.generateDeleteAssociations([i]);if(!h)throw new s.default("editor:failed-to-delete-association","Could not create payload needed to delete association");const y=p?.gdbVersion??void 0;await o(c,[h],{gdbVersion:y,globalIdUsed:!0})}async _returnToPageWithContent(){const{activeFeatureFormViewModel:e}=this;if(!e?.activeAssociationInput)return;const{activeAssociationInput:t,associationId:i}=e;await t.refresh(),t.associatedLayer&&!t.associatedFeatures?.length&&(e.associatedLayer=null),null==i||t.associatedFeatureInfos.size||(e.associationId=null)}async _createNestedCreateFeaturesWorkflow(e){const{relatedLayer:t}=e,{addAttachmentsCallback:i,applyEditsCallback:a,applyEditsFeatureServiceCallback:o,sketchOptions:r,snappingManager:n,viewModel:l}=this.data;if(!(0,f.S)(t))throw new s.default("editor:unsupported-layer","Editing is not supported on the provided layer");const d=this._getCreationInfoForNestedCreateFeaturesWorkflow(e),c=d.template||d.initialFeature?"creating-features":"awaiting-feature-creation-info",u="create-features"!==this.activeWorkflow?.type&&"add-association"!==this.activeWorkflow?.type?this.activeWorkflow:void 0;return N.default.create({addAttachmentsCallback:i,applyEditsCallback:a,applyEditsFeatureServiceCallback:o,creationInfo:d,isNested:!0,parent:u,sketchOptions:r,snappingManager:n,startAt:c,viewModel:l})}_getCreationInfoForNestedCreateFeaturesWorkflow(e){const{relatedLayer:t}=e;if(!(0,f.S)(t)||(0,g.F2)(t))throw new s.default("editor:unsupported-layer","Editing is not supported on the provided layer");const{viewModel:i}=this.data,a={layer:t,maxFeatures:1},o=this._makeRelatedRecordAttributes(e),n=i.getTemplatesForLayer(t);return n?.length>0?(a.attributeOverrides=o,1===n.length&&(a.template=n[0])):a.initialFeature=new r.default({sourceLayer:t,attributes:o}),a}async _createNestedUpdateWorkflow(e,t){const i=(0,g.bI)(e.sourceLayer)?z:K,{applyEditsCallback:a,applyEditsFeatureServiceCallback:o,sketchOptions:r,snappingManager:s,viewModel:n}=this.data,l="create-features"!==this.activeWorkflow?.type&&"add-association"!==this.activeWorkflow?.type?this.activeWorkflow:void 0,d=await i.create({association:t,feature:e,parent:l,sketchOptions:r,snappingManager:s,viewModel:n,applyEdits:a,applyEditsFeatureService:o,featureFormCallbacks:{addRelatedRecord:async e=>await this.startCreatingRelatedRecord(e),editRelatedRecord:async e=>{let{relatedFeature:t}=e;return await this.startUpdating(t)},selectAssociatedFeature:async e=>{let{feature:t,association:i}=e;return await this.startUpdating(t,i)},addAssociation:async e=>await this.startAddAssociation(e.feature,e.utilityNetwork,e.associationType)}});return await(0,p.whenOnce)((()=>!d.updating)),d}async _createNestedAddAssociationWorkflow(e,t,i){const a=V,{applyEditsCallback:o,applyEditsFeatureServiceCallback:r,viewModel:s}=this.data,n="create-features"!==this.activeWorkflow?.type&&"add-association"!==this.activeWorkflow?.type?this.activeWorkflow:void 0,l=this.activeFeatureFormViewModel?.activeAssociationInput,d=await a.create({utilityNetwork:t,associationType:i,feature:e,parent:n,viewModel:s,associationInput:l,applyEdits:o,applyEditsFeatureService:r});return await(0,p.whenOnce)((()=>!d.updating)),d}async _drainWorkflowStack(e){const t=this._workflowStack,i=[];for(;t.length>0;){const a=t.pop();this._sketchStack.pop();const o=e(a).then((()=>a.destroy()));this._updatingHandles.addPromise(o),i.push(o)}await Promise.all(i)}_makeRelatedRecordAttributes(e){const{parentFeature:t,relatedLayer:i,relationshipId:a}=e;if(!(0,ee.isGraphicForRelatableFeatureSupportedLayer)(t))return;const o=i.relationships?.find((e=>e.id===a));if(!o)return void oe("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if("origin"===o.role)return void oe("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const r=t.sourceLayer;o.relatedTableId!==r.layerId&&oe("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const s=r.relationships?.find((e=>e.id===a));if(!s)return void oe("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const n=ae(r,s),l=t.getAttribute(n);l||oe("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field.");const d=ae(i,o);return{[d]:l}}async _popWorkflow(){this._workflowStack.pop()?.destroy(),this._sketchStack.pop();const e=await this._reconcileWorkflowStack();if(e.failureCount>0)throw new s.default("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",e)}async _pushWorkflow(e){const t=this._workflowRequiresSketchViewModel(e);this.activeWorkflow?.exit({removeSketchHandles:t});const i=this._sketchStack,a=await(e?.start()),o=i.peek();a?(o?.exit(),i.push(a)):i.push(this._cloneSketchController(o)),this._workflowStack.push(e);const r=await this._reconcileWorkflowStack();if(r.failureCount>0)throw new s.default("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",r)}async _reconcileWorkflowStack(){const e=this._workflowStack,t=this._sketchStack;try{const i=e.peek();return await(i?.enter()),await(t.peek()?.enter()),{activeWorkflow:i,failureCount:0}}catch(A){e.pop().destroy(),t.pop();const{activeWorkflow:a,failureCount:o}=await this._reconcileWorkflowStack();return{activeWorkflow:a,failureCount:o+1}}}_cloneSketchController(e){return{enter:e?.enter??(async()=>{}),exit:e?.exit??(async()=>{}),viewModel:e?.viewModel}}_workflowRequiresSketchViewModel(e){const{type:t}=e;return"update-feature"===t||"create-features"===t&&!(0,g.bI)(e.data.creationInfo?.layer)}static _createWorkflowSteps(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"awaiting-feature-to-update";const{data:i}=e;return(0,S.z4)(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],t,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:t}=i.viewModel,a=i.viewModel.view;a.activeTool=null;let o=null;e.addHandles((0,n.hA)((()=>{o=(0,d.DC)(o)})),this.id),i.rootFeature=null,i.candidates=[];const r=a.on("immediate-click",(async r=>{const s=(0,c.createResolver)();e._updatingHandles.addPromise(s.promise);try{t.location=r.mapPoint,t.visible=!0,o?.abort();const{editorItems:s}=i.viewModel;o=new AbortController;const n=await r.async((()=>new Promise(((e,t)=>{(0,c.onAbort)(o?.signal,(()=>t((0,c.createAbortError)()))),e((0,S.Zs)(s,a,r,o?.signal))}))));if((0,c.throwIfAborted)(o),i.candidates=n.filter((e=>"fulfilled"===e.status)).flatMap((e=>e.value)).filter((e=>!e.isAggregate)),t.visible=1===i.candidates.length,0===i.candidates.length)return;r.stopPropagation(),1===i.candidates.length?(i.rootFeature=i.candidates[0],e.go("editing-existing-feature").catch((()=>{})).then((()=>t.visible=!1))):e.next()}finally{s.resolve()}}),v.o.TOOL),s=(0,p.when)((()=>null!=a.activeTool),(()=>e.cancel({force:!0})),{once:!0});a.focus(),e.addHandles([r,s],this.id)},async tearDown(){0===i.candidates.length&&(i.viewModel.spinnerViewModel.visible=!1),e.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){i.rootFeature=null;const{view:t}=i.viewModel;if(!t)return;const a=new _.A({view:t,highlightName:b.n4});e.addHandles([(0,p.watch)((()=>i.rootFeature),((e,t)=>{a.remove(t),a.add(e)}),p.sync),(0,n.hA)((()=>a.removeAll()))],this.id)},async tearDown(){e.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:t,viewModel:i}=e.data;if(!t)throw new s.default("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await e.startUpdating(t),i.spinnerViewModel.visible=!1;const a=(0,c.debounce)((async()=>{await(0,p.whenOnce)((()=>!e.updating)),e.previous()}));e.addHandles([(0,p.watch)((()=>e.nestedWorkflowCount),((e,t)=>{0===e&&0!==t&&a()}),p.sync)],this.id)},async tearDown(){await e.cancelAll(),e.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}})})}};function ae(e,t){let{keyField:i}=t;return e.getField(i)?.name??i}(0,o._)([(0,y.MZ)()],ie.prototype,"activeEditorItem",null),(0,o._)([(0,y.MZ)()],ie.prototype,"activeFeatureFormViewModel",null),(0,o._)([(0,y.MZ)()],ie.prototype,"activeUtilityNetworkAssociationAddAssociationViewModel",null),(0,o._)([(0,y.MZ)()],ie.prototype,"activeSketchViewModel",null),(0,o._)([(0,y.MZ)()],ie.prototype,"canDeleteAssociation",null),(0,o._)([(0,y.MZ)()],ie.prototype,"activeWorkflow",null),(0,o._)([(0,y.MZ)()],ie.prototype,"updating",null),(0,o._)([(0,y.MZ)()],ie.prototype,"data",void 0),(0,o._)([(0,y.MZ)()],ie.prototype,"hasPreviousStep",null),(0,o._)([(0,y.MZ)()],ie.prototype,"hasUpdatableCandidates",null),(0,o._)([(0,y.MZ)()],ie.prototype,"nestedWorkflowCount",null),(0,o._)([(0,y.MZ)()],ie.prototype,"shouldShowAttachments",null),(0,o._)([(0,y.MZ)()],ie.prototype,"shouldAllowAttachmentEditing",null),(0,o._)([(0,y.MZ)()],ie.prototype,"hasPendingEdits",null),(0,o._)([(0,y.MZ)()],ie.prototype,"helpMessage",null),(0,o._)([(0,y.MZ)()],ie.prototype,"reliesOnOwnerAdminPrivileges",null),(0,o._)([(0,y.MZ)()],ie.prototype,"hasInvalidFormTemplate",null),ie=X=(0,o._)([(0,w.$)(te)],ie);const oe=(e,t)=>l.A.getLogger(te).warn(`editor:${e}`,t,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),re=e=>!!e&&/update-/.test(e.type),se=ie},88317:(e,t,i)=>{i.r(t),i.d(t,{default:()=>h});var a=i(93800),o=i(19455),r=i(48602),s=(i(21265),i(50925),i(14746),i(14800)),n=i(75269),l=i(15484),d=i(54824),c=i(79580),u=i(48362);let p=class extends o.A{constructor(e){super(e),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(e,t){return new u.default({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId})}writeFromNetworkElement(e,t){e&&(t.fromGlobalId=e.globalId,t.fromNetworkSourceId=e.networkSourceId,t.fromTerminalId=e.terminalId)}readToNetworkElement(e,t){return new u.default({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId})}writeToNetworkElement(e,t){e&&(t.toGlobalId=e.globalId,t.toNetworkSourceId=e.networkSourceId,t.toTerminalId=e.terminalId)}};(0,a._)([(0,r.MZ)({type:String,json:{write:!0}})],p.prototype,"globalId",void 0),(0,a._)([(0,r.MZ)({type:c.XZ.apiValues,json:{type:c.XZ.jsonValues,read:c.XZ.read,write:c.XZ.write}})],p.prototype,"associationType",void 0),(0,a._)([(0,r.MZ)({type:u.default,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId"]}}})],p.prototype,"fromNetworkElement",void 0),(0,a._)([(0,s.w)("fromNetworkElement")],p.prototype,"readFromNetworkElement",null),(0,a._)([(0,l.K)("fromNetworkElement")],p.prototype,"writeFromNetworkElement",null),(0,a._)([(0,r.MZ)({type:u.default,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId"]}}})],p.prototype,"toNetworkElement",void 0),(0,a._)([(0,s.w)("toNetworkElement")],p.prototype,"readToNetworkElement",null),(0,a._)([(0,l.K)("toNetworkElement")],p.prototype,"writeToNetworkElement",null),(0,a._)([(0,r.MZ)({type:d.default,json:{write:!0}})],p.prototype,"geometry",void 0),(0,a._)([(0,r.MZ)({type:String,json:{write:!0}})],p.prototype,"errorMessage",void 0),(0,a._)([(0,r.MZ)({type:Number,json:{write:!0}})],p.prototype,"percentAlong",void 0),(0,a._)([(0,r.MZ)({type:Number,json:{write:!0}})],p.prototype,"errorCode",void 0),(0,a._)([(0,r.MZ)({type:Boolean,json:{write:!0}})],p.prototype,"isContentVisible",void 0),(0,a._)([(0,r.MZ)({type:Number,json:{write:!0}})],p.prototype,"status",void 0),p=(0,a._)([(0,n.$)("esri.rest.networks.support.Association")],p);const h=p},89501:(e,t,i)=>{i.r(t),i.d(t,{default:()=>l});var a=i(93800),o=i(6946),r=i(48602),s=(i(21265),i(50925),i(14746),i(75269));let n=class extends o.default{constructor(e){super(e),this.addAttachmentsCallback=null,this.applyEditsCallback=null,this.applyEditsFeatureServiceCallback=null,this.candidates=null,this.rootFeature=null,this.sketchOptions=null,this.snappingManager=null,this.viewModel=null}};(0,a._)([(0,r.MZ)()],n.prototype,"addAttachmentsCallback",void 0),(0,a._)([(0,r.MZ)()],n.prototype,"applyEditsCallback",void 0),(0,a._)([(0,r.MZ)()],n.prototype,"applyEditsFeatureServiceCallback",void 0),(0,a._)([(0,r.MZ)()],n.prototype,"candidates",void 0),(0,a._)([(0,r.MZ)()],n.prototype,"rootFeature",void 0),(0,a._)([(0,r.MZ)({constructOnly:!0})],n.prototype,"sketchOptions",void 0),(0,a._)([(0,r.MZ)()],n.prototype,"snappingManager",void 0),(0,a._)([(0,r.MZ)()],n.prototype,"viewModel",void 0),n=(0,a._)([(0,s.$)("esri.widgets.Editor.UpdateWorkflowData")],n);const l=n},98461:(e,t,i)=>{i.d(t,{$m:()=>f,A5:()=>u,Dv:()=>g,Gx:()=>M,He:()=>d,Kc:()=>m,TV:()=>y,UI:()=>_,YX:()=>v,aq:()=>k,cS:()=>h,d0:()=>l,hg:()=>n,iH:()=>b,k$:()=>r,pJ:()=>p,sR:()=>w,xf:()=>c,zz:()=>s});var a=i(54057),o=i(49403);const r={action:"EsriFeatureTableActionColumn",attachments:"EsriFeatureTableAttachmentsColumn",relationship:"EsriFeatureTableRelationshipColumn"},s=()=>Promise.all([(0,o.W)({"action-bar":()=>Promise.all([i.e(86290),i.e(74597),i.e(36334)]).then(i.bind(i,36334))}),Promise.all([(0,o.W)({input:()=>i.e(46138).then(i.bind(i,46138)),option:()=>i.e(99163).then(i.bind(i,99163)),select:()=>i.e(34280).then(i.bind(i,34280)),"input-date-picker":()=>Promise.all([i.e(86290),i.e(42015),i.e(57020)]).then(i.bind(i,57020)),"input-time-picker":()=>Promise.all([i.e(86290),i.e(74597),i.e(42015),i.e(40435)]).then(i.bind(i,40435))}),(0,o.W)({action:()=>i.e(88342).then(i.bind(i,88342)),button:()=>Promise.resolve().then(i.bind(i,20423)),dropdown:()=>i.e(41631).then(i.bind(i,41631)),"dropdown-item":()=>i.e(54055).then(i.bind(i,54055)),"dropdown-group":()=>i.e(90553).then(i.bind(i,90553)),icon:()=>Promise.resolve().then(i.bind(i,92439))})])]);function n(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"id"in e&&"load"in e&&"objectIdField"in e&&"type"in e&&"when"in e}function l(e){return n(e)&&"queryAttachments"in e}function d(e){return l(e)&&"addAttachment"in e&&"deleteAttachments"in e&&"updateAttachment"in e}function c(e){return n(e)&&"editingEnabled"in e&&"applyEdits"in e}function u(e){return n(e)&&"relationships"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e}function p(e){return null!=e&&"object"==typeof e&&"type"in e&&"map-image"===e.type}function h(e,t,i){if(t?.map)return y(e,[...t.map.allLayers,...t.map.allTables],i)}function y(e,t,i){let{relatedTableId:a}=i;const o="scene"===e.type&&e.associatedLayer?e.associatedLayer.url:e.url,r=t=>!(!u(t)||t===e)&&("sublayer"===t.type&&t.layer?.url===e.url?t.id===a:o===t.url&&t.layerId===a);if("sublayer"===e.type&&p(e.parent)){const t=t=>u(t)&&t!==e&&t.id===a,i=e.parent,o=i.sublayers?.find(t)||i.subtables?.find(t);if(u(o))return o}let s=null;for(const n of t)if(p(n)){const e=n.sublayers?.find(r)||n.subtables?.find(r);if(e){s=e;break}}else if(r(n)){s=n;break}if(u(s))return s}function w(e,t){return null!=e&&Number.isInteger(e)&&e>-1&&e<t}function f(e){return null==e||0===e.trim().length}function g(e,t){return(e.relationships??[]).filter((e=>!(e.id===t&&"one-to-one"===e.cardinality))).map((e=>{let{id:t}=e;return{relationshipId:t}}))}function m(e,t){return e.relationships?.find((e=>{let{id:i}=e;return i===t}))}function _(e,t){return null==t?null:e?.fields?.find((e=>t.toLowerCase()===e.name?.toLowerCase()))}function v(e,t){return t.some((t=>!("group"!==t.type||!v(e,t.columnTemplates))||t.fieldName===e))}function k(e,t){return t?.some((t=>!(!(0,a.Ie)(t)||!k(e,t.columns))||t.fieldName===e))??!1}function b(e,t){return`${e.id}-${t}`}function M(e){return e.isTable?"table":"feature"===e.type?"feature-layer":"layer"}}}]);