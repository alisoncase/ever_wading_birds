"use strict";(self.webpackChunkever_wading_birds=self.webpackChunkever_wading_birds||[]).push([[474],{474:(e,t,r)=>{r.r(t),r.d(t,{default:()=>p});var l=r(93800),i=r(79953),a=r(48602),o=(r(21265),r(50925),r(14746),r(75269)),s=r(78076),n=r(27531),u=r(92471),d=r(23708),h=r(41327);let y=class extends d.A{constructor(e){super(e),this._relationshipVM=null,this.group=null,this.type="relationship",this.addHandles([(0,i.watch)((()=>({feature:this.feature,element:this.element,layer:this.layer})),(e=>this._createRelationshipVM(e)),i.initial),(0,i.on)((()=>this.relatedLayer),"edits",(()=>this._relationshipVM?.refresh()))])}destroy(){this._relationshipVM?.destroy()}get canAddRelatedFeature(){const{editable:e,featureCount:t,relationship:r}=this;if(!r||!this.loaded||!this.relatedLayerAllowsAdds)return!1;if(this.allCategories?.length&&!this.activeCategory)return!1;const{cardinality:l,role:i}=r;return!("one-to-one"===l&&t>0)&&"many-to-many"!==l&&!("one-to-many"===l&&"destination"===i&&t>0)&&e}get activeCategory(){return this._relationshipVM?.activeCategory}set activeCategory(e){const t=this._relationshipVM;t&&(t.activeCategory=e)}get allCategories(){const{relatedLayer:e}=this,t=this._relationshipVM?.categories;if(!(0,s.F2)(e))return;const r=(e.subtypes??[]).map((e=>{let{code:r,name:l}=e;const i=t?.find((e=>e.name===l));return{name:l,count:i?.count??0,value:i?.value??r}}));return r.length?r:null}get categories(){return this.showAllEnabled?this.allCategories:this.allCategories?.slice(0,this.displayCount)}get displayCount(){return this.element.displayCount??3}get displayType(){return this.element.displayType}get editable(){return!!this.relatedLayerAllowsEdits&&(this.evaluatedEditableExpression??!0)}get featureCount(){return this._relationshipVM?.featureCount??0}get label(){return this.activeCategory?.name?this.activeCategory.name:this.getFormattedLabel(this.element?.label)}get loaded(){return"loading"!==this._relationshipVM?.state}get map(){return this._get("map")}set map(e){e&&this._relationshipVM?.set("map",e),this._set("map",e)}get orderByFields(){return this.element.orderByFields}get originHasValidKey(){return!(!this.relationship||!this.feature.getAttribute(this.relationship.keyField))}get relationship(){return this._relationshipVM?.relationship}get relationshipId(){return this.element.relationshipId}get relatedFeatureInfos(){const{_relationshipVM:e,timeZone:t}=this;if(!e?.relatedFeatures?.length||!e?.relatedLayer)return[];const{itemDescriptionFieldName:r,relatedFeatures:l,relatedLayer:i}=e,a=i&&"formTemplate"in i&&i.formTemplate?i.formTemplate.title:void 0;return l.map((e=>{let l;if(r){const a=e.getAttribute(r),o=i.fieldsIndex.get(r);if(o){const e=(0,h.Ve)({values:[a],fields:[o],timeZone:t??void 0})[r];null!=e&&(l=e.toString())}}return{feature:e,description:l,title:a?(0,h.LZ)({label:a,attributes:e.attributes,fieldsIndex:i.fieldsIndex,timeZone:t}):void 0}})).toArray()}get relatedLayer(){return this._relationshipVM?.relatedLayer}get relatedLayerIsTable(){return!!this.relatedLayer?.isTable}get relatedLayerAllowsAdds(){const{relatedLayer:e}=this;if(!e||!this.relatedLayerAllowsEdits)return!1;const t=(0,s.BR)(e);return!!t?.operations?.supportsAdd}get relatedLayerAllowsEdits(){const{relatedLayer:e}=this;if(!e)return!1;const t=(0,s.BR)(e);return!!t?.operations?.supportsEditing}get showAllEnabled(){return this._get("showAllEnabled")}set showAllEnabled(e){this._relationshipVM?.set("showAllEnabled",e),this._set("showAllEnabled",e)}get showAllActionVisible(){return!this.showAllEnabled&&this.featureCount>0&&this.featureCount>this.displayCount}get showAllCategoriesVisible(){const e=this.allCategories?.length??0;return!this.showAllEnabled&&e>0&&e>this.displayCount}get visible(){const{relationship:e}=this;if(!e)return!1;const{cardinality:t}=e;return"many-to-many"!==t&&(null!=this.evaluatedVisibilityExpression?this.evaluatedVisibilityExpression:null!=this.element)}get updating(){return"loading"===this._relationshipVM?.state||"querying"===this._relationshipVM?.state}incrementPage(){this._relationshipVM&&this._relationshipVM.featurePage++}getRelatedFeatureByObjectId(e){return this._relationshipVM?.getRelatedFeatureByObjectId(e)}_createRelationshipVM(e){const{feature:t,element:r,layer:l}=e;if(this._relationshipVM?.destroy(),!t||!r||!l)return;const{displayCount:i,map:a,orderByFields:o,relationshipId:s,showAllEnabled:d}=this;(0,u.isRelatableFeatureSupportedLayer)(l)&&(this._relationshipVM=new n.A({graphic:t,displayCount:i,layer:l,map:a,orderByFields:o,relationshipId:s,showAllEnabled:d}))}};(0,l._)([(0,a.MZ)()],y.prototype,"_relationshipVM",void 0),(0,l._)([(0,a.MZ)()],y.prototype,"canAddRelatedFeature",null),(0,l._)([(0,a.MZ)()],y.prototype,"activeCategory",null),(0,l._)([(0,a.MZ)()],y.prototype,"allCategories",null),(0,l._)([(0,a.MZ)()],y.prototype,"categories",null),(0,l._)([(0,a.MZ)()],y.prototype,"displayCount",null),(0,l._)([(0,a.MZ)()],y.prototype,"displayType",null),(0,l._)([(0,a.MZ)()],y.prototype,"editable",null),(0,l._)([(0,a.MZ)()],y.prototype,"featureCount",null),(0,l._)([(0,a.MZ)()],y.prototype,"group",void 0),(0,l._)([(0,a.MZ)()],y.prototype,"label",null),(0,l._)([(0,a.MZ)()],y.prototype,"loaded",null),(0,l._)([(0,a.MZ)()],y.prototype,"map",null),(0,l._)([(0,a.MZ)()],y.prototype,"orderByFields",null),(0,l._)([(0,a.MZ)()],y.prototype,"originHasValidKey",null),(0,l._)([(0,a.MZ)()],y.prototype,"relationship",null),(0,l._)([(0,a.MZ)()],y.prototype,"relationshipId",null),(0,l._)([(0,a.MZ)()],y.prototype,"relatedFeatureInfos",null),(0,l._)([(0,a.MZ)()],y.prototype,"relatedLayer",null),(0,l._)([(0,a.MZ)()],y.prototype,"relatedLayerIsTable",null),(0,l._)([(0,a.MZ)()],y.prototype,"relatedLayerAllowsAdds",null),(0,l._)([(0,a.MZ)()],y.prototype,"relatedLayerAllowsEdits",null),(0,l._)([(0,a.MZ)()],y.prototype,"showAllEnabled",null),(0,l._)([(0,a.MZ)()],y.prototype,"showAllActionVisible",null),(0,l._)([(0,a.MZ)()],y.prototype,"showAllCategoriesVisible",null),(0,l._)([(0,a.MZ)({readOnly:!0})],y.prototype,"type",void 0),(0,l._)([(0,a.MZ)()],y.prototype,"visible",null),(0,l._)([(0,a.MZ)()],y.prototype,"updating",null),y=(0,l._)([(0,o.$)("esri.widgets.FeatureForm.RelationshipInput")],y);const p=y},27531:(e,t,r)=>{r.d(t,{A:()=>F});var l=r(93800),i=r(79625),a=r(6946),o=r(62631),s=r(85715),n=r(89129),u=r(93633),d=r(49959),h=r(79953),y=r(48602),p=(r(21265),r(50925),r(75269)),c=r(31482),g=r(92471),_=r(41327);let b=class extends(s.A.ClonableMixin(u.A.IdentifiableMixin(a.default))){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.activeCategory=null,this.allCategories=null,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await(0,d.ignoreAbortErrors)(this._query()),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const e=new AbortController;this._queryFeatureCountAbortController=e,await(0,d.ignoreAbortErrors)(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const e=new AbortController;this._queryPageAbortController=e,await(0,d.ignoreAbortErrors)(this._queryPage()),this._queryPageAbortController===e&&(this._queryPageAbortController=null)},this._queryDebounced=(0,d.debounce)(this._queryController,100),this._queryFeatureCountDebounced=(0,d.debounce)(this._queryFeatureCountController,100),this._queryPageDebounced=(0,d.debounce)(this._queryPageController,100),this._query=async()=>{const{_queryAbortController:e,relatedFeatures:t}=this;this.featureCount&&("subtype-group"!==this.relatedLayer?.type||this.activeCategory)&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,t.destroyAll(),this.destroyed||t.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:e?.signal}))))},this.addHandles([(0,h.watch)((()=>[this.displayCount,this.graphic,this.layer,this.layer?.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount,this.activeCategory]),(()=>this._queryDebounced()),h.initial),(0,h.watch)((()=>[this.featurePage,this.showAllEnabled]),(()=>this._queryPageDebounced())),(0,h.watch)((()=>[this.layer,this.relationshipId,this.objectId,this.canQuery,this.activeCategory]),(()=>this._queryFeatureCountDebounced()))])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.destroyAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:t,featureCount:r}=this,l=Math.ceil(r/t)||1;this._set("featurePage",Math.min(Math.max(e,1),l))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:t}=this;return e&&t?.loaded?e.map((e=>{const r=e.clone();return r.field=(0,g.getFixedFieldName)(e.field,t),r})):e??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canLoad(){return!!this.map&&null!=this.relationshipId&&"number"==typeof this.objectId}get canQuery(){const e=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&null!=this.relationshipId&&null!=this.objectId&&e?.supportsCount&&e?.supportsPagination)}get allCategoriesCount(){return this.allCategories?.length??0}get categories(){const{allCategories:e}=this;return this.showAllEnabled?e:e?.slice(0,this.displayCount)??null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e??3,0),10))}get displayCount(){return this._get("displayCount")}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new n.default}get relatedLayer(){const{layer:e,map:t,relationship:r}=this;if(!e?.loaded||!t||!r)return null;const l="subtype-sublayer"===e.type&&e.parent&&(0,g.isRelatableFeatureSupportedLayer)(e.parent)?e.parent:e;return(0,g.findRelatedLayer)(t,l,r)??null}get relatedLayerKeyField(){const{relatedLayer:e,relationshipId:t}=this;return e?.loaded&&null!=t?e.relationships?.find((e=>e.id===t))?.keyField:null}get relatedLayerKeyFields(){const{relatedLayer:e}=this;return e?.loaded?e.relationships?.map((e=>e.keyField)).filter(o.Ru)??[]:[]}get relationship(){const{relationshipId:e,layer:t}=this;return null!=e&&t?.loaded?t.relationships?.find((t=>{let{id:r}=t;return r===e}))??null:null}get relationshipKey(){const{relationshipKeyField:e}=this;return(e&&this.graphic?.attributes?.[e])??null}get relationshipKeyField(){return this.relationship?.keyField||null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new n.default}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:r,canQuery:l,_loaded:i,canLoad:a}=this;return t||a&&!i?"loading":e||r?"querying":l?"ready":"disabled"}getRelatedFeatureByObjectId(e){return this.relatedFeatures.find((t=>t.getObjectId()===e))}refresh(){this._queryFeatureCountDebounced()}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.destroyAll()}async _queryFeatureCount(){const{layer:e,relatedLayer:t}=this;await(e?.load()),await(t?.load());const{_queryFeatureCountAbortController:l,activeCategory:i,canQuery:a,objectId:s,relatedLayerKeyField:n,relationshipId:u,relationshipKey:d,supportsCacheHint:h}=this;if(!a||!e||!t||null==s)return this._set("featureCount",0),void this._set("allCategories",null);if("subtype-group"===t?.type&&!i){if(this._set("featureCount",0),this._destroyRelatedFeatureViewModels(),this.featurePage=1,this.relatedFeatures.destroyAll(),n&&null!=d){const{default:e}=await Promise.all([r.e(81765),r.e(29071),r.e(68584),r.e(47464),r.e(85793),r.e(66809),r.e(2938),r.e(46705)]).then(r.bind(r,69086)),{uniqueValueInfos:i}=await e({layer:t,sqlWhere:`${n} = '${d}'`,field:t.subtypeField,signal:l?.signal}),a=i.map((e=>{let{count:r,value:l}=e;const i=t.subtypes?.find((e=>e.code===l))?.name;return null!=l&&i?{count:r,value:l,name:i}:void 0})).filter(o.Ru);this._set("allCategories",a)}return}const{historicMoment:y,gdbVersion:p}=e,g=new c.default({cacheHint:h,gdbVersion:p,historicMoment:y,relationshipId:u,returnGeometry:!1,objectIds:[s],where:this._getRelationshipWhereClause(t)}),_=await e.queryRelatedFeaturesCount(g,{signal:l?.signal});this._set("allCategories",null),this._set("featureCount",_[s]||0)}_getRelationshipWhereClause(e){const{activeCategory:t}=this,r=e.createQuery(),l="subtypeField"in e?e.subtypeField:void 0,i=t&&l?`${l} = ${t.value}`:void 0,a=r.where;return a&&i?`(${a}) AND (${i})`:a??i}_sliceFeatures(e){const{showAllEnabled:t,displayCount:r}=this;return t?e:r?e.slice(0,r):[]}async _queryPage(){const{relatedFeatures:e,featurePage:t,showAllEnabled:r,_queryPageAbortController:l,featureCount:i}=this;!r||t<2||!i||"subtype-group"===this.relatedLayer?.type&&!this.activeCategory||e.addMany(await this._queryRelatedFeatures({signal:l?.signal}))}async _queryRelatedFeatures(e){const{displayCount:t,featureCount:r,featurePage:l,featuresPerPage:i,layer:a,orderByFieldsFixedCasing:o,relatedLayer:s,relatedLayerKeyFields:n,relationshipId:u,showAllEnabled:d,supportsCacheHint:h}=this,{canQuery:y,objectId:p}=this;if(!y||!a||!s||null==p)return[];const g=d?((l-1)*i+r)%r:0,b=d?i:t,F=s.objectIdField,M="subtypeField"in s?s.subtypeField:void 0,f=[...o.map((e=>e.field)),...(0,_.n4)(s),...n,F,M].filter(C),A=o.map((e=>`${e.field} ${e.order}`)),{historicMoment:m,gdbVersion:w}=a,Z=new c.default({orderByFields:A,start:g,num:b,outFields:f,cacheHint:h,historicMoment:m,gdbVersion:w,relationshipId:u,returnGeometry:!1,objectIds:[p],where:this._getRelationshipWhereClause(s)}),v=await a.queryRelatedFeatures(Z,{signal:e?.signal}),q=v[p]?.features||[];return"subtype-group"===s.type&&M?q.forEach((e=>{const t=e.attributes[M],r=s.findSublayerForSubtypeCode?.(t);e.sourceLayer=r,e.layer=r})):q.forEach((e=>{e.sourceLayer=s,e.layer=s})),q}};function C(e){return null!=e&&""!==e}(0,l._)([(0,y.MZ)()],b.prototype,"_loaded",void 0),(0,l._)([(0,y.MZ)()],b.prototype,"_queryAbortController",void 0),(0,l._)([(0,y.MZ)()],b.prototype,"_queryPageAbortController",void 0),(0,l._)([(0,y.MZ)()],b.prototype,"_queryFeatureCountAbortController",void 0),(0,l._)([(0,y.MZ)({value:1})],b.prototype,"featurePage",null),(0,l._)([(0,y.MZ)()],b.prototype,"featuresPerPage",void 0),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"orderByFieldsFixedCasing",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"supportsCacheHint",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"canLoad",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"canQuery",null),(0,l._)([(0,y.MZ)()],b.prototype,"activeCategory",void 0),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"allCategories",void 0),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"allCategoriesCount",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"categories",null),(0,l._)([(0,y.MZ)()],b.prototype,"description",void 0),(0,l._)([(0,y.MZ)({value:3})],b.prototype,"displayCount",null),(0,l._)([(0,y.MZ)({type:i.default})],b.prototype,"graphic",void 0),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"itemDescriptionFieldName",null),(0,l._)([(0,y.MZ)()],b.prototype,"layer",void 0),(0,l._)([(0,y.MZ)()],b.prototype,"map",void 0),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"objectId",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"objectIdField",null),(0,l._)([(0,y.MZ)()],b.prototype,"orderByFields",void 0),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"relatedFeatures",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"relatedLayer",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"relatedLayerKeyField",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"relatedLayerKeyFields",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"relationship",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"relationshipKey",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"relationshipKeyField",null),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"featureCount",void 0),(0,l._)([(0,y.MZ)({readOnly:!0})],b.prototype,"relatedFeatureViewModels",null),(0,l._)([(0,y.MZ)()],b.prototype,"relationshipId",void 0),(0,l._)([(0,y.MZ)()],b.prototype,"showAllEnabled",void 0),(0,l._)([(0,y.MZ)()],b.prototype,"state",null),(0,l._)([(0,y.MZ)()],b.prototype,"title",void 0),b=(0,l._)([(0,p.$)("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],b);const F=b}}]);