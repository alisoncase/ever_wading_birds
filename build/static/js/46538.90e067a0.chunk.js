"use strict";(self.webpackChunkever_wading_birds=self.webpackChunkever_wading_birds||[]).push([[46538,86349],{46538:(e,t,r)=>{r.r(t),r.d(t,{default:()=>V});var i=r(93800),s=r(23060),n=r(74719),o=r(19455),a=r(81933),l=r(43103),u=r(48602),d=(r(21265),r(50925),r(14746),r(14800)),c=r(75269),h=r(15484),m=r(62652),f=r(10193);class g{constructor(e){this.moments=[],this.forwardMoments=[],this.moments.push(e)}push(e){return this.forwardMoments.length,this.moments.push(e)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;const e=this.moments.pop();return this.forwardMoments.push(e),e}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;const e=this.forwardMoments.pop();return this.moments.push(e),e}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}}var p=r(29757),y=r(86349);let v=class extends(o.A.JSONSupportMixin(a.A)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=e=>!e||e===this.defaultVersionIdentifier.name,this._dateEquals=(e,t)=>!e&&!t||!(!e||!t)&&e.toISOString()===t.toISOString(),this._applyEditsHandler=e=>{const{serviceUrl:t,gdbVersion:r,result:i}=e;t===this._featureServiceUrl&&i.then((e=>{const t=e.historicMoment;t&&this._addMomentToVersionItem(r,t)}))}}initialize(){this.url=(0,l.removeTrailingSlash)(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),p.DC.has(this.url)||p.DC.set(this.url,new Map);const e=(p.CD.get(this.url)??0)+1;p.CD.set(this.url,e),this.when().then((()=>this.addHandles((0,m.Jz)(this._applyEditsHandler))),(()=>{}))}destroy(){const e=(p.CD.get(this.url)??1)-1;p.CD.set(this.url,e),0===e&&p.DC.delete(this.url),p.Z3.delete(this._featureServiceUrl)}read(e,t){this.sourceJSON=e,super.read(e,t)}readDefaultVersionIdentifier(e,t){return{name:t.defaultVersionName,guid:t.defaultVersionGuid}}writeDefaultVersionIdentifier(e,t){t.defaultVersionName=e.name,t.defaultVersionGuid=e.guid}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}async createVersion(e){const[{createVersion:t},{default:i}]=await Promise.all([r.e(47864).then(r.bind(r,47864)),r.e(51632).then(r.bind(r,51632))]),s=i.from(e);return t(this.url,s)}async deleteVersion(e){const[{deleteVersion:t},{default:i}]=await Promise.all([r.e(89645).then(r.bind(r,89645)),r.e(79645).then(r.bind(r,79645))]);let s;e.guid&&p.DC.get(this.url)?.has(e.guid)&&(s=p.TA??void 0);const n=new i({versionName:e.name,sessionId:s});return t(this.url,n)}async getVersionInfoExtended(e){const{getVersion:t}=await r.e(88094).then(r.bind(r,88094));return t(this.url,e.guid)}async getVersionInfos(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const[{getVersionInfos:t},{default:i}]=await Promise.all([r.e(49357).then(r.bind(r,49357)),r.e(56125).then(r.bind(r,56125))]),s=i.from(e);return t(this.url,s)}async reconcile(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const[{reconcile:i},{default:s}]=await Promise.all([r.e(17907).then(r.bind(r,17907)),r.e(76691).then(r.bind(r,76691))]),n=s.from(t);return n.sessionId=p.TA,i(this.url,e.guid,n)}async post(e){const[{post:t},{default:i}]=await Promise.all([r.e(82805).then(r.bind(r,82805)),r.e(37040).then(r.bind(r,37040))]),s=i.from({sessionId:p.TA});return t(this.url,e.guid,s)}async alterVersion(e,t){const[{alterVersion:i},{default:s}]=await Promise.all([r.e(85674).then(r.bind(r,85674)),r.e(35046).then(r.bind(r,35046))]),n=s.from(t);return i(this.url,e.guid,n)}async startReading(e){return(await this.startReadingWithResult(e)).success}async startReadingWithResult(e){const{startReading:t}=await r.e(22778).then(r.bind(r,22778)),i=await t(this.url,e.guid,p.TA);if(i.success){const t=await this.getVersionInfoExtended(e),r=new Date(t.modifiedDate),i={name:t.versionIdentifier.name,moment:r,lockType:"read"};this._addOrUpdateItem(e.guid,i),(0,m.$9)(this._featureServiceUrl,null,e.name,r)}return i}async stopReading(e){return(await this.stopReadingWithResult(e)).success}async stopReadingWithResult(e){const{stopReading:t}=await r.e(48948).then(r.bind(r,48948)),i=await t(this.url,e.guid,p.TA);return i.success&&(p.DC.get(this.url)?.delete(e.guid),(0,m.$9)(this._featureServiceUrl,null,e.name,null)),i}async startEditing(e){return(await this.startEditingWithResult(e)).success}async startEditingWithResult(e){const{startEditing:t}=await r.e(11770).then(r.bind(r,11770)),i=await t(this.url,e.guid,p.TA);if(i.success){const t=await this.getVersionInfoExtended(e),r=new Date(t.modifiedDate),i=new g(r),s={name:e.name,moment:r,lockType:"edit",stack:i};this._addOrUpdateItem(e.guid,s),(0,m.$9)(this._featureServiceUrl,null,e.name,r)}return i}async stopEditing(e,t){return(await this.stopEditingWithResult(e,t)).success}async stopEditingWithResult(e,t){if(t){const t=p.DC.get(this.url)?.get(e.guid);if(t?.stack?.canRedo()){const[{deleteForwardEdits:i},{default:s}]=await Promise.all([r.e(94379).then(r.bind(r,94379)),r.e(24567).then(r.bind(r,24567))]),n=await i(this.url,e.guid,new s({sessionId:p.TA,moment:t.moment}));if(!n.success)return n}}const{stopEditing:i}=await r.e(84192).then(r.bind(r,84192)),s=await i(this.url,e.guid,p.TA,t);if(s.success){const t=await this.getVersionInfoExtended(e),r=new Date(t.modifiedDate);this._addOrUpdateItem(e.guid,{name:e.name,moment:r,lockType:"read",editMomentStack:void 0}),(0,m.$9)(this._featureServiceUrl,null,e.name,r)}return s}getLockType(e){const t=p.DC.get(this.url)?.get(e.guid)?.lockType;return t??"none"}async changeVersion(e,t,r){if(r&&"name"in r&&!await this.getVersionInfoExtended(r))throw new n.default("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in e){if(this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase())return this._changeVersionInternal(e,t,r)}else{let i;"layers"in e?(i=e.allTables.concat(e.allLayers),e.utilityNetworks&&e.utilityNetworks.forEach((e=>{this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(e,t,r)}))):i=e;for(const e of i)if("feature"===e.type||"subtype-group"===e.type){const i=/^(.*\/FeatureServer)\/\d+$/,s=e.url.replace(i,"$1");if(this._featureServiceUrl.toLowerCase()===s.toLowerCase()&&!this._changeVersionInternal(e,t,r))return!1}else if("group"===e.type){const i=e.allTables.concat(e.allLayers);for(const e of i)if("feature"===e.type||"subtype-group"===e.type){const i=/^(.*\/FeatureServer)\/\d+$/,s=e.url.replace(i,"$1");if(this._featureServiceUrl.toLowerCase()===s.toLowerCase()&&!this._changeVersionInternal(e,t,r))return!1}}}return!0}async changeVersionWithResult(e,t,r){let i;if("layers"in e){const t=(0,y.createVersionAdapters)(e.allTables.concat(e.allLayers).filter((e=>"group"!==e.type)).toArray());e.utilityNetworks&&e.utilityNetworks.forEach((e=>{const r=(0,y.createVersionAdapters)([e]);t.push(...r)})),i=t}else i=e;if(r&&"name"in r&&!await this.getVersionInfoExtended(r)){const e=new Map;for(const t of i)e.set(t,{success:!1});return e}if(t&&"name"in t&&"none"!==this.getLockType(t)){const e=new Map;for(const t of i)e.set(t,{success:!1});return e}const s=new Map;for(const n of i)if(n)if(n.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){const e=this._changeVersionInternalWithResult(n,t,r);s.set(n,e)}else s.set(n,{success:!1});return s}async getVersionIdentifierFromName(e){try{const t=await this.getVersionInfos({includeHidden:!0});return t.find((t=>t.versionIdentifier.name.toUpperCase()===e.toUpperCase()))?.versionIdentifier||null}catch{return null}}async getVersionIdentifierFromGuid(e){const{getVersion:t}=await r.e(88094).then(r.bind(r,88094));try{return(await t(this.url,e)).versionIdentifier}catch{return null}}canUndo(e){const t=p.DC.get(this.url)?.get(e.guid);return!!t?.stack?.canUndo()}canRedo(e){const t=p.DC.get(this.url)?.get(e.guid);return!!t?.stack?.canRedo()}undo(e){const t=p.DC.get(this.url)?.get(e.guid),r=t?.stack?.undo()||void 0;if(t&&r){const r=t.stack.peek();(0,m.$9)(this._featureServiceUrl,null,e.name,r),p.DC.get(this.url)?.set(e.guid,{...t,moment:r})}}redo(e){const t=p.DC.get(this.url)?.get(e.guid),r=t?.stack?.redo()||void 0;t&&r&&((0,m.$9)(this._featureServiceUrl,null,e.name,r),p.DC.get(this.url)?.set(e.guid,{...t,moment:r}))}_setUpData(e,t){let r=null,i=null,s=null,o=null;const a=e=>{const t=p.DC?.get(this.url)?.get(e.guid);s=e.name,o=t?.moment??null};if(e&&"name"in e){if("none"!==this.getLockType(e))throw new n.default("version-management-service:version-locked","version is locked");r=e.name,i=null,t&&"name"in t?a(t):(s=this.defaultVersionIdentifier.name,o=t)}else r=this.defaultVersionIdentifier.name,i=e,t&&"name"in t?a(t):(s=this.defaultVersionIdentifier.name,o=t);return{fromVersionName:r,fromMoment:i,toVersionName:s,toMoment:o}}_changeVersionInternal(e,t,r){try{const{fromVersionName:i,fromMoment:s,toVersionName:n,toMoment:o}=this._setUpData(t,r);(this._isDefault(i)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,s)||i===e.gdbVersion&&this._dateEquals(e.historicMoment,s))&&(e.gdbVersion=n,e.historicMoment=o)}catch(i){return!1}return!0}_changeVersionInternalWithResult(e,t,r){try{const{fromVersionName:i,fromMoment:s,toVersionName:n,toMoment:o}=this._setUpData(t,r);return this._isDefault(i)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,s)||i===e.gdbVersion&&this._dateEquals(e.historicMoment,s)?(e.gdbVersion=n,e.historicMoment=o,{success:!0}):{success:!1}}catch(i){return{success:!1}}}_addMomentToVersionItem(e,t){const r=p.DC.get(this.url);if(r)for(const[i,s]of r)s.name===e&&this._addToStack(i,t)}_addToStack(e,t){const r=p.DC.get(this.url),i=r?.get(e);return!!i?.stack&&(function(e,t){if(e)return e.getTime()<t.getTime();return!0}(i.stack.peek(),t)&&i.stack.push(t),r.set(e,{...i,moment:t}),!0)}_addOrUpdateItem(e,t){const r=p.DC.get(this.url),i=r?.get(e);return i?(r.set(e,{...i,...t}),!0):!(!t.name||!t.lockType)&&(r?.set(e,{...t,lockType:t.lockType}),!0)}async _fetchService(e,t){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:(0,f.Dl)(e)});const t=new l.Url(this.url).host;return void p.Z3.set(t,this.defaultVersionIdentifier.name)}const r=await(0,s.default)(e,{responseType:"json",query:{f:"json"},...t});this.read(r.data)}};(0,i._)([(0,u.MZ)()],v.prototype,"url",void 0),(0,i._)([(0,u.MZ)()],v.prototype,"sourceJSON",void 0),(0,i._)([(0,u.MZ)({type:String,json:{write:!0}})],v.prototype,"name",void 0),(0,i._)([(0,u.MZ)({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],v.prototype,"defaultVersionIdentifier",void 0),(0,i._)([(0,d.w)("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],v.prototype,"readDefaultVersionIdentifier",null),(0,i._)([(0,h.K)("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],v.prototype,"writeDefaultVersionIdentifier",null),(0,i._)([(0,u.MZ)({json:{write:!0}})],v.prototype,"capabilities",void 0),v=(0,i._)([(0,c.$)("esri.versionManagement.VersionManagementService")],v);const V=v},86349:(e,t,r)=>{r.r(t),r.d(t,{createVersionAdapter:()=>u,createVersionAdapters:()=>d});var i=r(9674),s=r(93800),n=r(48602);r(21265),r(50925),r(14746),r(39466),r(77751),r(21965),r(74719);class o{constructor(e){this.versionableItem=e,this.type="feature-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.url.replace(/^(.*\/FeatureServer)\/\d+$/,"$1")}}(0,s._)([(0,n.MZ)({readOnly:!0})],o.prototype,"type",void 0),(0,s._)([(0,n.MZ)()],o.prototype,"gdbVersion",null),(0,s._)([(0,n.MZ)({type:Date})],o.prototype,"historicMoment",null),(0,s._)([(0,n.MZ)({readOnly:!0})],o.prototype,"featureServiceUrl",null);class a{constructor(e){this.versionableItem=e,this.type="network"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.featureServiceUrl}}(0,s._)([(0,n.MZ)({readOnly:!0})],a.prototype,"type",void 0),(0,s._)([(0,n.MZ)()],a.prototype,"gdbVersion",null),(0,s._)([(0,n.MZ)({type:Date})],a.prototype,"historicMoment",null),(0,s._)([(0,n.MZ)({readOnly:!0})],a.prototype,"featureServiceUrl",null);class l{constructor(e){this.versionableItem=e,this.type="subtype-group-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.url.replace(/^(.*\/FeatureServer)\/\d+$/,"$1")}}function u(e){return"networkServiceUrl"in e?new a(e):"feature"!==e.type||(0,i.isLayerFromCatalog)(e)?"subtype-group"!==e.type||(0,i.isLayerFromCatalog)(e)?null:new l(e):new o(e)}function d(e){const t=[];for(const r of e)if("group"===r.type){const e=r,i=e.allTables.concat(e.allLayers);for(const r of i)if("feature"===r.type||"subtype-group"===r.type){const e=u(r);e&&t.push(e)}}else{const e=u(r);e&&t.push(e)}return t}(0,s._)([(0,n.MZ)({readOnly:!0})],l.prototype,"type",void 0),(0,s._)([(0,n.MZ)()],l.prototype,"gdbVersion",null),(0,s._)([(0,n.MZ)({type:Date})],l.prototype,"historicMoment",null),(0,s._)([(0,n.MZ)({readOnly:!0})],l.prototype,"featureServiceUrl",null)}}]);