"use strict";(self.webpackChunkever_wading_birds=self.webpackChunkever_wading_birds||[]).push([[29656],{29656:(e,i,t)=>{t.r(i),t.d(i,{default:()=>b});var r=t(93800),s=(t(88677),t(6946)),a=t(89129),n=t(79953),l=t(48602),y=(t(21265),t(50925),t(14746),t(75269)),o=t(99940),d=t(57566),h=t(12285),c=t(12711);const L="state",u="view",f="all-layer-views",_="legend-properties",p=a.default.ofType(h.default),w=new Set(["esri.layers.BuildingSceneLayer","esri.layers.CatalogLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.OrientedImageryLayer","esri.layers.ParquetLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.catalog.CatalogFootprintLayer","esri.layers.catalog.CatalogDynamicGroupLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer","esri.layers.KnowledgeGraphLayer"]),v="view.basemapView.baseLayerViews",I="view.groundView.layerViews",g="view.basemapView.referenceLayerViews",V=[v,I,"view.layerViews",g];let m=class extends s.default{constructor(e){super(e),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new a.default,this.activeLayerInfos=new p,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles((0,n.watch)((()=>this.view),(()=>this._viewHandles()),n.initial),u),this.addHandles((0,c.oQ)((()=>this._refresh())))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get state(){return this.view?.ready?"ready":"disabled"}_viewHandles(){this.removeHandles(L),this.view&&this.addHandles((0,n.watch)((()=>this.state),(()=>this._stateHandles()),n.initial),L)}_stateHandles(){this._resetAll(),"ready"===this.state&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([f,_]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this.removeHandles(e);const i=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],i?.parent&&i.parent.children.remove(i)}_watchPropertiesAndAllLayerViews(){const{view:e}=this;if(!e)return;const{allLayerViews:i}=e;i.length&&this._refresh(),this.addHandles(i.on("change",(e=>this._allLayerViewsChangeHandle(e))),f),this.addHandles((0,n.watch)((()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible]),(()=>this._propertiesChangeHandle())),_)}_allLayerViewsChangeHandle(e){e.moved.length?this._propertiesChangeHandle():(e.removed.forEach((e=>this._destroyViewActiveLayerInfo(e.uid))),this._refresh())}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){const i=this.view;if(e.length<2||!i)return;const t=[];e.forEach((i=>{if(!i.parent){const r=i.layer.parent,s=r&&"uid"in r&&this._layerViewByLayerId[r.uid],a=s&&this._activeLayerInfosByLayerViewId[s.uid];a&&e.includes(a)&&(t.push(i),i.parent=a,a.children.add(i),this._sortActiveLayerInfos(a.children))}})),e.removeMany(t);const r={};i.allLayerViews.forEach(((e,i)=>r[e.layer.uid]=i)),e.sort(((e,i)=>{const t=r[e.layer.uid]||0;return(r[i.layer.uid]||0)-t}))}_generateLayerViews(){const e=[];return V.filter(this._filterLayerViews,this).map((e=>(0,o.Jt)(this,e))).filter((e=>null!=e)).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const i=!this.basemapLegendVisible&&(e===v||e===g),t=!this.groundLegendVisible&&e===I;return!i&&!t}_collectLayerViews(e,i){const t=r=>(r&&r.forEach((r=>{i.push(r),t(r[e])})),i);return t}_filterLayerViewsByLayerInfos(e){const i=this.layerInfos;return!i||!i.length||i.some((i=>this._hasLayerInfo(i,e)))}_hasLayerInfo(e,i){const t=this._isLayerUIDMatching(e.layer,i.layer.uid);return t&&(this._layerInfosByLayerViewId[i.uid]=e),t}_isLayerUIDMatching(e,i){return e&&(e.uid===i||this._hasLayerUID(e.layers,i))}_hasLayerUID(e,i){return e&&e.some((e=>this._isLayerUIDMatching(e,i)))}_isLayerViewSupported(e){return!!w.has(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this.removeHandles(e.uid),this.addHandles((0,n.watch)((()=>[e.legendEnabled,e.layer?.legendEnabled]),(()=>this._layerActiveHandle(e))),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this.removeHandles(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.layer?.legendEnabled}_buildActiveLayerInfo(e){const i=e.layer,t=e.uid,r=this._layerInfosByLayerViewId[t];let s=this._activeLayerInfosByLayerViewId[t];if(!s){const a=void 0!==r?.title&&r.layer.uid===i.uid;s=new h.default({layer:i,layerView:e,title:a?r.title:i.title,view:this.view??void 0,respectLayerDefinitionExpression:this.respectLayerDefinitionExpression,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:r?.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[t]=s}const a=i.parent&&"uid"in i.parent?this._layerViewByLayerId[i.parent?.uid]:null;if(s.parent=this._activeLayerInfosByLayerViewId[a?.uid],!this.hasHandles(t)){const r=[(0,n.watch)((()=>i.title),(e=>this._titleHandle(e,s))),(0,n.watch)((()=>[i.opacity,"renderer"in i&&i.renderer,"pointSymbol"in i&&i.pointSymbol,"lineSymbol"in i&&i.lineSymbol,"polygonSymbol"in i&&i.polygonSymbol]),(()=>this._constructLegendElements(s))),(0,n.when)((()=>!0===this.view?.stationary),(()=>this._scaleHandle(s)),n.initial),(0,n.watch)((()=>e.layer?(0,d.n)(e.layer,e.view):null),(()=>this._constructLegendElements(s))),(0,n.watch)((()=>e.updating),(()=>{null!=e.layer&&null!=(0,d.n)(e.layer,e.view)&&this._constructLegendElements(s)})),(0,n.watch)((()=>"effect"in i&&i.effect),(()=>this._constructLegendElements(s))),(0,n.when)((()=>this.view?.timeZone),(()=>this._constructLegendElements(s)),n.initial)];if(this.respectLayerVisibility){const t=(0,n.watch)((()=>e.legendEnabled),(e=>this._legendEnabledHandle(e,s))),a=(0,n.watch)((()=>i.legendEnabled),(e=>this._legendEnabledHandle(e,s)));r.push(t,a)}if(this.respectLayerDefinitionExpression&&"definitionExpression"in i){const e=(0,n.watch)((()=>[i.definitionExpression,this.respectLayerDefinitionExpression]),(()=>{s.respectLayerDefinitionExpression=this.respectLayerDefinitionExpression,this._constructLegendElements(s)}));r.push(e)}this.addHandles(r,t)}s.isScaleDriven||this._constructLegendElements(s),this._addActiveLayerInfo(s)}_titleHandle(e,i){i.title=e,this._constructLegendElements(i)}_legendEnabledHandle(e,i){e?this._addActiveLayerInfo(i):this._removeActiveLayerInfo(i)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){const{layerView:i,layer:t}=e;if(this._isLayerActive(i)&&!this.activeLayerInfos.includes(e)){const i=e.parent;if(i)i.children.includes(e)||i.children.push(e),this._sortActiveLayerInfos(i.children);else{const i=this.layerInfos?.some((e=>e.layer.uid===t.uid)),r=t.parent;r&&"uid"in r&&this._layerViewByLayerId[r.uid]&&!i?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const e=[];this._activeLayerInfosWithNoParent.forEach((i=>{const t=i.layer.parent,r=t&&"uid"in t?this._layerViewByLayerId[t?.uid]:null,s=this._activeLayerInfosByLayerViewId[r?.uid];s&&(e.push(i),i.parent=s)})),e.length&&(this._activeLayerInfosWithNoParent.removeMany(e),e.forEach((e=>this._addActiveLayerInfo(e))))}}}_removeActiveLayerInfo(e){const i=e.parent;i?i.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){const i=e.layer;"featureCollections"in i&&i.featureCollections?e.buildLegendElementsForFeatureCollections(i.featureCollections):"featureReduction"in i&&i.featureReduction&&"renderer"in i.featureReduction&&("binning"===i.featureReduction.type||"cluster"===i.featureReduction.type)&&(!this.view||i.featureReduction.maxScale<=this.view.scale)?e.buildLegendElementsForFeatureReduction(i.featureReduction):"renderer"in i&&i.renderer&&!("sublayers"in i)?e.buildLegendElementsForRenderer(i.renderer):"url"in i&&i.url&&"catalog"!==i.type&&"knowledge-graph"!==i.type?e.buildLegendElementsForTools():e.children.forEach((e=>this._constructLegendElements(e)))}};(0,r._)([(0,l.MZ)({type:p})],m.prototype,"activeLayerInfos",void 0),(0,r._)([(0,l.MZ)()],m.prototype,"basemapLegendVisible",void 0),(0,r._)([(0,l.MZ)()],m.prototype,"groundLegendVisible",void 0),(0,r._)([(0,l.MZ)()],m.prototype,"hideLayersNotInCurrentView",void 0),(0,r._)([(0,l.MZ)()],m.prototype,"keepCacheOnDestroy",void 0),(0,r._)([(0,l.MZ)()],m.prototype,"respectLayerDefinitionExpression",void 0),(0,r._)([(0,l.MZ)()],m.prototype,"respectLayerVisibility",void 0),(0,r._)([(0,l.MZ)()],m.prototype,"layerInfos",void 0),(0,r._)([(0,l.MZ)({readOnly:!0})],m.prototype,"state",null),(0,r._)([(0,l.MZ)()],m.prototype,"view",void 0),m=(0,r._)([(0,y.$)("esri.widgets.Legend.LegendViewModel")],m);const b=m},57566:(e,i,t)=>{function r(e,i){const t=e.featureReduction;return t&&"selection"!==t.type&&(!("maxScale"in t)||!t.maxScale||t.maxScale<i.scale)?t:null}t.d(i,{n:()=>r})}}]);